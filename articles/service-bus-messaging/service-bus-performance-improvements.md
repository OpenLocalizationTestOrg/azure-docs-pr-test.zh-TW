---
title: "使用 Azure 服務匯流排提升效能的最佳做法 |Microsoft Docs"
description: "描述如何使用服務匯流排來在交換代理訊息時將效能最佳化。"
services: service-bus-messaging
documentationcenter: na
author: sethmanheim
manager: timlt
editor: 
ms.assetid: e756c15d-31fc-45c0-8df4-0bca0da10bb2
ms.service: service-bus-messaging
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 05/10/2017
ms.author: sethm
ms.openlocfilehash: e6a0e480f7748f12f5e566cf4059b5b2c4242c09
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="best-practices-for-performance-improvements-using-service-bus-messaging"></a><span data-ttu-id="5ad85-103">使用服務匯流排傳訊的效能改進最佳作法</span><span class="sxs-lookup"><span data-stu-id="5ad85-103">Best Practices for performance improvements using Service Bus Messaging</span></span>

<span data-ttu-id="5ad85-104">本文描述如何使用 [Azure 服務匯流排傳訊](https://azure.microsoft.com/services/service-bus/)，以在交換代理訊息時將效能最佳化。</span><span class="sxs-lookup"><span data-stu-id="5ad85-104">This article describes how to use [Azure Service Bus messaging](https://azure.microsoft.com/services/service-bus/) to optimize performance when exchanging brokered messages.</span></span> <span data-ttu-id="5ad85-105">本主題的第一個部分說明提供協助提高效能的不同機制。</span><span class="sxs-lookup"><span data-stu-id="5ad85-105">The first part of this topic describes the different mechanisms that are offered to help increase performance.</span></span> <span data-ttu-id="5ad85-106">第二個部分針對如何在特定案例中利用可提供最佳效能的方式來使用服務匯流排提供指引。</span><span class="sxs-lookup"><span data-stu-id="5ad85-106">The second part provides guidance on how to use Service Bus in a way that can offer the best performance in a given scenario.</span></span>

<span data-ttu-id="5ad85-107">在本主題中，「用戶端」一詞是指任何存取服務匯流排的實體。</span><span class="sxs-lookup"><span data-stu-id="5ad85-107">Throughout this topic, the term "client" refers to any entity that accesses Service Bus.</span></span> <span data-ttu-id="5ad85-108">用戶端可以擔任傳送者或接收者的角色。</span><span class="sxs-lookup"><span data-stu-id="5ad85-108">A client can take the role of a sender or a receiver.</span></span> <span data-ttu-id="5ad85-109">「傳送者」一詞用於將訊息傳送至服務匯流排佇列或主題的服務匯流排佇列或主題用戶端。</span><span class="sxs-lookup"><span data-stu-id="5ad85-109">The term "sender" is used for a Service Bus queue or topic client that sends messages to a Service Bus queue or topic.</span></span> <span data-ttu-id="5ad85-110">「接收者」一詞指的是從服務匯流排佇列或訂用帳戶接收訊息的服務匯流排佇列或訂用帳戶用戶端。</span><span class="sxs-lookup"><span data-stu-id="5ad85-110">The term "receiver" refers to a Service Bus queue or subscription client that receives messages from a Service Bus queue or subscription.</span></span>

<span data-ttu-id="5ad85-111">這些章節介紹幾個服務匯流排用來協助提升效能的概念。</span><span class="sxs-lookup"><span data-stu-id="5ad85-111">These sections introduce several concepts that Service Bus uses to help boost performance.</span></span>

## <a name="protocols"></a><span data-ttu-id="5ad85-112">通訊協定</span><span class="sxs-lookup"><span data-stu-id="5ad85-112">Protocols</span></span>
<span data-ttu-id="5ad85-113">服務匯流排可讓用戶端透過三種通訊協定的其中一種傳送和接收訊息：</span><span class="sxs-lookup"><span data-stu-id="5ad85-113">Service Bus enables clients to send and receive messages via one of three protocols:</span></span>

1. <span data-ttu-id="5ad85-114">進階訊息佇列通訊協定 (AMQP)</span><span class="sxs-lookup"><span data-stu-id="5ad85-114">Advanced Message Queuing Protocol (AMQP)</span></span>
2. <span data-ttu-id="5ad85-115">服務匯流排傳訊通訊協定 (SBMP)</span><span class="sxs-lookup"><span data-stu-id="5ad85-115">Service Bus Messaging Protocol (SBMP)</span></span>
3. <span data-ttu-id="5ad85-116">http</span><span class="sxs-lookup"><span data-stu-id="5ad85-116">HTTP</span></span>

<span data-ttu-id="5ad85-117">AMQP 和 SBMP 會更有效率，因為只要傳訊處理站存在，它們就會維護服務匯流排連線。</span><span class="sxs-lookup"><span data-stu-id="5ad85-117">AMQP and SBMP are more efficient, because they maintain the connection to Service Bus as long as the messaging factory exists.</span></span> <span data-ttu-id="5ad85-118">它也會實作批次處理和預先擷取作業。</span><span class="sxs-lookup"><span data-stu-id="5ad85-118">It also implements batching and prefetching.</span></span> <span data-ttu-id="5ad85-119">除非明確提到，否則本主題中的所有內容都假設為使用 AMQP 和 SBMP。</span><span class="sxs-lookup"><span data-stu-id="5ad85-119">Unless explicitly mentioned, all content in this topic assumes the use of AMQP or SBMP.</span></span>

## <a name="reusing-factories-and-clients"></a><span data-ttu-id="5ad85-120">重複使用處理站和用戶端</span><span class="sxs-lookup"><span data-stu-id="5ad85-120">Reusing factories and clients</span></span>
<span data-ttu-id="5ad85-121">服務匯流排用戶端物件，例如 [QueueClient][QueueClient] 或 [MessageSender][MessageSender]，會透過也提供內部連接管理的 [MessagingFactory][MessagingFactory] 物件來建立。</span><span class="sxs-lookup"><span data-stu-id="5ad85-121">Service Bus client objects, such as [QueueClient][QueueClient] or [MessageSender][MessageSender], are created through a [MessagingFactory][MessagingFactory] object, which also provides internal management of connections.</span></span> <span data-ttu-id="5ad85-122">當您傳送一個訊息，並在傳送下一個訊息時重新建立傳訊處理站或佇列、主題及訂用帳戶用戶端之後，您不能將其關閉。</span><span class="sxs-lookup"><span data-stu-id="5ad85-122">You should not close messaging factories or queue, topic, and subscription clients after you send a message, and then re-create them when you send the next message.</span></span> <span data-ttu-id="5ad85-123">關閉傳訊處理站會刪除服務匯流排服務的連接，並在重新建立處理站時建立新的連接。</span><span class="sxs-lookup"><span data-stu-id="5ad85-123">Closing a messaging factory deletes the connection to the Service Bus service, and a new connection is established when recreating the factory.</span></span> <span data-ttu-id="5ad85-124">建立連接是成本高昂的作業，您可以藉由重新使用多項作業的相同處理站和用戶端物件來避免此作業。</span><span class="sxs-lookup"><span data-stu-id="5ad85-124">Establishing a connection is an expensive operation that you can avoid by re-using the same factory and client objects for multiple operations.</span></span> <span data-ttu-id="5ad85-125">您可以安全地使用 [QueueClient][QueueClient] 物件，從並行非同步作業和多個執行緒傳送訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-125">You can safely use the [QueueClient][QueueClient] object for sending messages from concurrent asynchronous operations and multiple threads.</span></span> 

## <a name="concurrent-operations"></a><span data-ttu-id="5ad85-126">並行作業</span><span class="sxs-lookup"><span data-stu-id="5ad85-126">Concurrent operations</span></span>
<span data-ttu-id="5ad85-127">執行作業 (傳送、接收、刪除等等) 需要一點時間。</span><span class="sxs-lookup"><span data-stu-id="5ad85-127">Performing an operation (send, receive, delete, etc.) takes some time.</span></span> <span data-ttu-id="5ad85-128">這個時間包括服務匯流排服務處理作業的時間加上要求和回覆的延遲時間。</span><span class="sxs-lookup"><span data-stu-id="5ad85-128">This time includes the processing of the operation by the Service Bus service in addition to the latency of the request and the reply.</span></span> <span data-ttu-id="5ad85-129">若要增加每次的作業數目，就必須並行執行作業。</span><span class="sxs-lookup"><span data-stu-id="5ad85-129">To increase the number of operations per time, operations must execute concurrently.</span></span> <span data-ttu-id="5ad85-130">您可以利用數個不同方式執行這項操作：</span><span class="sxs-lookup"><span data-stu-id="5ad85-130">You can do this in several different ways:</span></span>

* <span data-ttu-id="5ad85-131">**非同步作業**：用戶端會透過執行非同步作業來排程作業。</span><span class="sxs-lookup"><span data-stu-id="5ad85-131">**Asynchronous operations**: the client schedules operations by performing asynchronous operations.</span></span> <span data-ttu-id="5ad85-132">下一個要求會在前一個要求完成之前啟動。</span><span class="sxs-lookup"><span data-stu-id="5ad85-132">The next request is started before the previous request is completed.</span></span> <span data-ttu-id="5ad85-133">非同步傳送作業的範例如下：</span><span class="sxs-lookup"><span data-stu-id="5ad85-133">The following is an example of an asynchronous send operation:</span></span>
  
 ```csharp
  BrokeredMessage m1 = new BrokeredMessage(body);
  BrokeredMessage m2 = new BrokeredMessage(body);
  
  Task send1 = queueClient.SendAsync(m1).ContinueWith((t) => 
    {
      Console.WriteLine("Sent message #1");
    });
  Task send2 = queueClient.SendAsync(m2).ContinueWith((t) => 
    {
      Console.WriteLine("Sent message #2");
    });
  Task.WaitAll(send1, send2);
  Console.WriteLine("All messages sent");
  ```
  
  <span data-ttu-id="5ad85-134">非同步接收作業的範例如下：</span><span class="sxs-lookup"><span data-stu-id="5ad85-134">This is an example of an asynchronous receive operation:</span></span>
  
  ```csharp
  Task receive1 = queueClient.ReceiveAsync().ContinueWith(ProcessReceivedMessage);
  Task receive2 = queueClient.ReceiveAsync().ContinueWith(ProcessReceivedMessage);
  
  Task.WaitAll(receive1, receive2);
  Console.WriteLine("All messages received");
  
  async void ProcessReceivedMessage(Task<BrokeredMessage> t)
  {
    BrokeredMessage m = t.Result;
    Console.WriteLine("{0} received", m.Label);
    await m.CompleteAsync();
    Console.WriteLine("{0} complete", m.Label);
  }
  ```
* <span data-ttu-id="5ad85-135">**多個處理站**：由相同處理站建立的所有用戶端 (除了接收者之外還有傳送者) 共用一個 TCP 連線。</span><span class="sxs-lookup"><span data-stu-id="5ad85-135">**Multiple factories**: all clients (senders in addition to receivers) that are created by the same factory share one TCP connection.</span></span> <span data-ttu-id="5ad85-136">最大訊息輸送量受限於可通過此 TCP 連線的作業數目。</span><span class="sxs-lookup"><span data-stu-id="5ad85-136">The maximum message throughput is limited by the number of operations that can go through this TCP connection.</span></span> <span data-ttu-id="5ad85-137">透過單一處理站取得的輸送量與 TCP 來回時間和訊息大小有顯著的差異。</span><span class="sxs-lookup"><span data-stu-id="5ad85-137">The throughput that can be obtained with a single factory varies greatly with TCP round-trip times and message size.</span></span> <span data-ttu-id="5ad85-138">若要取得更高的輸送量速率，您應該使用多個傳訊處理站。</span><span class="sxs-lookup"><span data-stu-id="5ad85-138">To obtain higher throughput rates, you should use multiple messaging factories.</span></span>

## <a name="receive-mode"></a><span data-ttu-id="5ad85-139">接收模式</span><span class="sxs-lookup"><span data-stu-id="5ad85-139">Receive mode</span></span>
<span data-ttu-id="5ad85-140">建立佇列或訂用帳戶用戶端時，您可以指定接收模式：「查看鎖定」或「接收與刪除」。</span><span class="sxs-lookup"><span data-stu-id="5ad85-140">When creating a queue or subscription client, you can specify a receive mode: *Peek-lock* or *Receive and Delete*.</span></span> <span data-ttu-id="5ad85-141">預設接收模式是 [PeekLock][PeekLock]。</span><span class="sxs-lookup"><span data-stu-id="5ad85-141">The default receive mode is [PeekLock][PeekLock].</span></span> <span data-ttu-id="5ad85-142">以此模式操作時，用戶端會傳送要求，以接收來自服務匯流排的訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-142">When operating in this mode, the client sends a request to receive a message from Service Bus.</span></span> <span data-ttu-id="5ad85-143">用戶端收到訊息後，它會傳送要求以完成訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-143">After the client has received the message, it sends a request to complete the message.</span></span>

<span data-ttu-id="5ad85-144">將接收模式設為 [ReceiveAndDelete][ReceiveAndDelete] 時，兩個步驟會在單一要求中結合。</span><span class="sxs-lookup"><span data-stu-id="5ad85-144">When setting the receive mode to [ReceiveAndDelete][ReceiveAndDelete], both steps are combined in a single request.</span></span> <span data-ttu-id="5ad85-145">這可減少整體的作業數目並可改善整體訊息輸送量。</span><span class="sxs-lookup"><span data-stu-id="5ad85-145">This reduces the overall number of operations, and can improve the overall message throughput.</span></span> <span data-ttu-id="5ad85-146">此效能改善的風險為遺失訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-146">This performance gain comes at the risk of losing messages.</span></span>

<span data-ttu-id="5ad85-147">服務匯流排不支援接收和刪除作業的交易。</span><span class="sxs-lookup"><span data-stu-id="5ad85-147">Service Bus does not support transactions for receive-and-delete operations.</span></span> <span data-ttu-id="5ad85-148">此外，在用戶端想要延遲或讓訊息[寄不出去](service-bus-dead-letter-queues.md)的任何案例中都需要鎖定語意。</span><span class="sxs-lookup"><span data-stu-id="5ad85-148">In addition, peek-lock semantics are required for any scenarios in which the client wants to defer or [dead-letter](service-bus-dead-letter-queues.md) a message.</span></span>

## <a name="client-side-batching"></a><span data-ttu-id="5ad85-149">用戶端批次處理</span><span class="sxs-lookup"><span data-stu-id="5ad85-149">Client-side batching</span></span>
<span data-ttu-id="5ad85-150">用戶端批次處理可讓佇列或主題用戶端將訊息的傳送延遲一段時間。</span><span class="sxs-lookup"><span data-stu-id="5ad85-150">Client-side batching enables a queue or topic client to delay the sending of a message for a certain period of time.</span></span> <span data-ttu-id="5ad85-151">如果用戶端在此期間傳送其他訊息，它將以單一批次傳輸訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-151">If the client sends additional messages during this time period, it transmits the messages in a single batch.</span></span> <span data-ttu-id="5ad85-152">用戶端批次處理也會導致佇列或訂用帳戶用戶端將多個**完成**要求整批放入單一要求中處理。</span><span class="sxs-lookup"><span data-stu-id="5ad85-152">Client-side batching also causes a queue or subscription client to batch multiple **Complete** requests into a single request.</span></span> <span data-ttu-id="5ad85-153">批次處理僅適用於非同步**傳送**及**完成**作業。</span><span class="sxs-lookup"><span data-stu-id="5ad85-153">Batching is only available for asynchronous **Send** and **Complete** operations.</span></span> <span data-ttu-id="5ad85-154">同步作業會立即傳送至服務匯流排服務。</span><span class="sxs-lookup"><span data-stu-id="5ad85-154">Synchronous operations are immediately sent to the Service Bus service.</span></span> <span data-ttu-id="5ad85-155">查看或接收作業不會進行批次處理，也不會跨用戶端進行。</span><span class="sxs-lookup"><span data-stu-id="5ad85-155">Batching does not occur for peek or receive operations, nor does batching occur across clients.</span></span>

<span data-ttu-id="5ad85-156">根據預設，用戶端使用的批次間隔為 20 毫秒。</span><span class="sxs-lookup"><span data-stu-id="5ad85-156">By default, a client uses a batch interval of 20ms.</span></span> <span data-ttu-id="5ad85-157">您可以藉由在建立傳訊處理站之前設定 [BatchFlushInterval][BatchFlushInterval] 屬性來變更批次間隔。</span><span class="sxs-lookup"><span data-stu-id="5ad85-157">You can change the batch interval by setting the [BatchFlushInterval][BatchFlushInterval] property before creating the messaging factory.</span></span> <span data-ttu-id="5ad85-158">這個設定會影響此處理站所建立的所有用戶端。</span><span class="sxs-lookup"><span data-stu-id="5ad85-158">This setting affects all clients that are created by this factory.</span></span>

<span data-ttu-id="5ad85-159">若要停用批次處理，請將 [BatchFlushInterval][BatchFlushInterval] 屬性設為 **TimeSpan.Zero**。</span><span class="sxs-lookup"><span data-stu-id="5ad85-159">To disable batching, set the [BatchFlushInterval][BatchFlushInterval] property to **TimeSpan.Zero**.</span></span> <span data-ttu-id="5ad85-160">例如：</span><span class="sxs-lookup"><span data-stu-id="5ad85-160">For example:</span></span>

```csharp
MessagingFactorySettings mfs = new MessagingFactorySettings();
mfs.TokenProvider = tokenProvider;
mfs.NetMessagingTransportSettings.BatchFlushInterval = TimeSpan.FromSeconds(0.05);
MessagingFactory messagingFactory = MessagingFactory.Create(namespaceUri, mfs);
```

<span data-ttu-id="5ad85-161">批次處理並不會影響可計費的傳訊作業數目，而且僅適用於服務匯流排用戶端通訊協定。</span><span class="sxs-lookup"><span data-stu-id="5ad85-161">Batching does not affect the number of billable messaging operations, and is available only for the Service Bus client protocol.</span></span> <span data-ttu-id="5ad85-162">HTTP 通訊協定不支援批次處理。</span><span class="sxs-lookup"><span data-stu-id="5ad85-162">The HTTP protocol does not support batching.</span></span>

## <a name="batching-store-access"></a><span data-ttu-id="5ad85-163">批次處理存放區存取</span><span class="sxs-lookup"><span data-stu-id="5ad85-163">Batching store access</span></span>
<span data-ttu-id="5ad85-164">為了提高佇列、主題或訂用帳戶的輸送量，服務匯流排會在寫入至其內部存放區時批次處理多個訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-164">To increase the throughput of a queue, topic, or subscription, Service Bus batches multiple messages when it writes to its internal store.</span></span> <span data-ttu-id="5ad85-165">如果在佇列或主題上啟用，將會批次處理訊息寫入至存放區。</span><span class="sxs-lookup"><span data-stu-id="5ad85-165">If enabled on a queue or topic, writing messages into the store will be batched.</span></span> <span data-ttu-id="5ad85-166">如果在佇列或訂用帳戶上啟用，將會批次處理從存放區刪除訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-166">If enabled on a queue or subscription, deleting messages from the store will be batched.</span></span> <span data-ttu-id="5ad85-167">如果某個實體啟用批次處理的存放區存取，服務匯流排會延遲與該實體有關的存放區寫入作業，最多 20 毫秒。</span><span class="sxs-lookup"><span data-stu-id="5ad85-167">If batched store access is enabled for an entity, Service Bus delays a store write operation regarding that entity by up to 20ms.</span></span> <span data-ttu-id="5ad85-168">在此間隔期間進行的其他存放區作業都會加入至批次。</span><span class="sxs-lookup"><span data-stu-id="5ad85-168">Additional store operations that occur during this interval are added to the batch.</span></span> <span data-ttu-id="5ad85-169">批次處理的存放區存取只會影響**傳送**和**完成**作業；接收作業不會受到影響。</span><span class="sxs-lookup"><span data-stu-id="5ad85-169">Batched store access only affects **Send** and **Complete** operations; receive operations are not affected.</span></span> <span data-ttu-id="5ad85-170">批次處理的存放區存取是實體上的屬性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-170">Batched store access is a property on an entity.</span></span> <span data-ttu-id="5ad85-171">批次處理會在啟用批次處理存放區存取的所有實體進行。</span><span class="sxs-lookup"><span data-stu-id="5ad85-171">Batching occurs across all entities that enable batched store access.</span></span>

<span data-ttu-id="5ad85-172">建立新佇列、主題或訂用帳戶時，預設會啟用批次處理的存放區存取。</span><span class="sxs-lookup"><span data-stu-id="5ad85-172">When creating a new queue, topic or subscription, batched store access is enabled by default.</span></span> <span data-ttu-id="5ad85-173">若要停用批次處理的存放區存取，請在建立實體之前將 [EnableBatchedOperations][EnableBatchedOperations] 屬性設為 **false**。</span><span class="sxs-lookup"><span data-stu-id="5ad85-173">To disable batched store access, set the [EnableBatchedOperations][EnableBatchedOperations] property to **false** before creating the entity.</span></span> <span data-ttu-id="5ad85-174">例如：</span><span class="sxs-lookup"><span data-stu-id="5ad85-174">For example:</span></span>

```csharp
QueueDescription qd = new QueueDescription();
qd.EnableBatchedOperations = false;
Queue q = namespaceManager.CreateQueue(qd);
```

<span data-ttu-id="5ad85-175">批次處理的存放區存取並不會影響可計費的傳訊作業數目，並且是佇列、主題或訂用帳戶的屬性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-175">Batched store access does not affect the number of billable messaging operations, and is a property of a queue, topic, or subscription.</span></span> <span data-ttu-id="5ad85-176">它獨立於接收模式及用於用戶端和服務匯流排服務之間的通訊協定之外。</span><span class="sxs-lookup"><span data-stu-id="5ad85-176">It is independent of the receive mode and the protocol that is used between a client and the Service Bus service.</span></span>

## <a name="prefetching"></a><span data-ttu-id="5ad85-177">預先擷取</span><span class="sxs-lookup"><span data-stu-id="5ad85-177">Prefetching</span></span>
<span data-ttu-id="5ad85-178">預先擷取可讓佇列或訂用帳戶用戶端在執行接收作業時從服務載入額外的訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-178">Prefetching enables the queue or subscription client to load additional messages from the service when it performs a receive operation.</span></span> <span data-ttu-id="5ad85-179">用戶端會將這些訊息儲存在本機快取中。</span><span class="sxs-lookup"><span data-stu-id="5ad85-179">The client stores these messages in a local cache.</span></span> <span data-ttu-id="5ad85-180">快取的大小取決於 [QueueClient.PrefetchCount][QueueClient.PrefetchCount] 或 [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] 屬性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-180">The size of the cache is determined by the [QueueClient.PrefetchCount][QueueClient.PrefetchCount] or [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] properties.</span></span> <span data-ttu-id="5ad85-181">啟用預先擷取的每個用戶端會維護自己的快取。</span><span class="sxs-lookup"><span data-stu-id="5ad85-181">Each client that enables prefetching maintains its own cache.</span></span> <span data-ttu-id="5ad85-182">快取不會跨用戶端共用。</span><span class="sxs-lookup"><span data-stu-id="5ad85-182">A cache is not shared across clients.</span></span> <span data-ttu-id="5ad85-183">如果用戶端起始接收作業且其快取是空的，則服務會傳輸一批次的訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-183">If the client initiates a receive operation and its cache is empty, the service transmits a batch of messages.</span></span> <span data-ttu-id="5ad85-184">批次的大小等於快取的大小或 256 KB，以較小者為準。</span><span class="sxs-lookup"><span data-stu-id="5ad85-184">The size of the batch equals the size of the cache or 256 KB, whichever is smaller.</span></span> <span data-ttu-id="5ad85-185">如果用戶端起始接收作業且快取包含一則訊息，訊息會從快取中擷取。</span><span class="sxs-lookup"><span data-stu-id="5ad85-185">If the client initiates a receive operation and the cache contains a message, the message is taken from the cache.</span></span>

<span data-ttu-id="5ad85-186">預先擷取訊息時，服務會鎖定預先擷取的訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-186">When a message is prefetched, the service locks the prefetched message.</span></span> <span data-ttu-id="5ad85-187">藉由這麼做，其他接收者就無法接收預先擷取的訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-187">By doing this, the prefetched message cannot be received by a different receiver.</span></span> <span data-ttu-id="5ad85-188">如果接收者無法在鎖定到期之前完成訊息，訊息就會變成可供其他接收者接收。</span><span class="sxs-lookup"><span data-stu-id="5ad85-188">If the receiver cannot complete the message before the lock expires, the message becomes available to other receivers.</span></span> <span data-ttu-id="5ad85-189">訊息的預先擷取副本會保留在快取中。</span><span class="sxs-lookup"><span data-stu-id="5ad85-189">The prefetched copy of the message remains in the cache.</span></span> <span data-ttu-id="5ad85-190">當取用過其快取複本的接收者嘗試完成該訊息時，他會收到例外狀況。</span><span class="sxs-lookup"><span data-stu-id="5ad85-190">The receiver that consumes the expired cached copy will receive an exception when it tries to complete that message.</span></span> <span data-ttu-id="5ad85-191">根據預設，訊息鎖定會在 60 秒之後到期。</span><span class="sxs-lookup"><span data-stu-id="5ad85-191">By default, the message lock expires after 60 seconds.</span></span> <span data-ttu-id="5ad85-192">此值可延長為 5 分鐘。</span><span class="sxs-lookup"><span data-stu-id="5ad85-192">This value can be extended to 5 minutes.</span></span> <span data-ttu-id="5ad85-193">若要避免過期訊息遭到取用，快取大小應該一律小於用戶端在鎖定逾時間隔內可取用的訊息數目。</span><span class="sxs-lookup"><span data-stu-id="5ad85-193">To prevent the consumption of expired messages, the cache size should always be smaller than the number of messages that can be consumed by a client within the lock time-out interval.</span></span>

<span data-ttu-id="5ad85-194">使用 60 秒的預設鎖定到期時間時，[SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] 的良好值為處理站中所有接收者最高處理速率的 20 倍。</span><span class="sxs-lookup"><span data-stu-id="5ad85-194">When using the default lock expiration of 60 seconds, a good value for [SubscriptionClient.PrefetchCount][SubscriptionClient.PrefetchCount] is 20 times the maximum processing rates of all receivers of the factory.</span></span> <span data-ttu-id="5ad85-195">例如，處理站建立 3 個接收者，而每個接收者每秒可以處理最多 10 則訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-195">For example, a factory creates 3 receivers, and each receiver can process up to 10 messages per second.</span></span> <span data-ttu-id="5ad85-196">預先擷取計數不應該超過 20 X 3 X 10 = 600。</span><span class="sxs-lookup"><span data-stu-id="5ad85-196">The prefetch count should not exceed 20 X 3 X 10 = 600.</span></span> <span data-ttu-id="5ad85-197">根據預設，[QueueClient.PrefetchCount][QueueClient.PrefetchCount] 設為 0，表示沒有其他訊息從服務擷取。</span><span class="sxs-lookup"><span data-stu-id="5ad85-197">By default, [QueueClient.PrefetchCount][QueueClient.PrefetchCount] is set to 0, which means that no additional messages are fetched from the service.</span></span>

<span data-ttu-id="5ad85-198">預先擷取訊息會增加佇列或訂用帳戶的整體輸送量，因為此舉可減少訊息作業的整體數目或來回次數。</span><span class="sxs-lookup"><span data-stu-id="5ad85-198">Prefetching messages increases the overall throughput for a queue or subscription because it reduces the overall number of message operations, or round trips.</span></span> <span data-ttu-id="5ad85-199">然而，擷取第一個訊息需要較長的時間 (因為訊息大小增加)。</span><span class="sxs-lookup"><span data-stu-id="5ad85-199">Fetching the first message, however, will take longer (due to the increased message size).</span></span> <span data-ttu-id="5ad85-200">接收預先擷取的訊息比較快速，因為用戶端已經下載這些訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-200">Receiving prefetched messages will be faster because these messages have already been downloaded by the client.</span></span>

<span data-ttu-id="5ad85-201">伺服器會在它將訊息傳送至用戶端時，檢查訊息的存留時間 (TTL) 屬性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-201">The time-to-live (TTL) property of a message is checked by the server at the time the server sends the message to the client.</span></span> <span data-ttu-id="5ad85-202">用戶端不會在收到訊息時檢查訊息的 TTL 屬性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-202">The client does not check the message’s TTL property when the message is received.</span></span> <span data-ttu-id="5ad85-203">相反地，即使訊息由用戶端快取時已超過其 TTL，仍然可以收到訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-203">Instead, the message can be received even if the message’s TTL has passed while the message was cached by the client.</span></span>

<span data-ttu-id="5ad85-204">預先擷取並不會影響可計費的傳訊作業數目，而且僅適用於服務匯流排用戶端通訊協定。</span><span class="sxs-lookup"><span data-stu-id="5ad85-204">Prefetching does not affect the number of billable messaging operations, and is available only for the Service Bus client protocol.</span></span> <span data-ttu-id="5ad85-205">HTTP 通訊協定不支援預先擷取。</span><span class="sxs-lookup"><span data-stu-id="5ad85-205">The HTTP protocol does not support prefetching.</span></span> <span data-ttu-id="5ad85-206">同步和非同步接收作業皆可使用預先擷取。</span><span class="sxs-lookup"><span data-stu-id="5ad85-206">Prefetching is available for both synchronous and asynchronous receive operations.</span></span>

## <a name="express-queues-and-topics"></a><span data-ttu-id="5ad85-207">快速佇列和主題</span><span class="sxs-lookup"><span data-stu-id="5ad85-207">Express queues and topics</span></span>

<span data-ttu-id="5ad85-208">快速實體可提高輸送量並縮短延遲，而只有在「標準」傳訊層才支援這些實體。</span><span class="sxs-lookup"><span data-stu-id="5ad85-208">Express entities enable high throughput and reduced latency scenarios, and are supported only in the Standard messaging tier.</span></span> <span data-ttu-id="5ad85-209">在[進階命名空間](service-bus-premium-messaging.md)中建立的實體不支援快速選項。</span><span class="sxs-lookup"><span data-stu-id="5ad85-209">Entities created in [Premium namespaces](service-bus-premium-messaging.md) do not support the express option.</span></span> <span data-ttu-id="5ad85-210">使用快速實體時，如果訊息傳送至佇列或主題，訊息不會立即儲存在訊息存放區。</span><span class="sxs-lookup"><span data-stu-id="5ad85-210">With express entities, if a message is sent to a queue or topic, the message is not immediately stored in the messaging store.</span></span> <span data-ttu-id="5ad85-211">相反地，它會快取在記憶體中。</span><span class="sxs-lookup"><span data-stu-id="5ad85-211">Instead, it is cached in memory.</span></span> <span data-ttu-id="5ad85-212">如果訊息保留在佇列中超過幾秒鐘，它會自動寫入至穩定儲存體，藉此保護它免於因中斷而遺失。</span><span class="sxs-lookup"><span data-stu-id="5ad85-212">If a message remains in the queue for more than a few seconds, it is automatically written to stable storage, thus protecting it against loss due to an outage.</span></span> <span data-ttu-id="5ad85-213">將訊息寫入記憶體快取會增加輸送量並減少延遲，因為訊息傳送時沒有存取穩定儲存體。</span><span class="sxs-lookup"><span data-stu-id="5ad85-213">Writing the message into a memory cache increases throughput and reduces latency because there is no access to stable storage at the time the message is sent.</span></span> <span data-ttu-id="5ad85-214">在幾秒鐘內取用的訊息不會寫入至訊息存放區。</span><span class="sxs-lookup"><span data-stu-id="5ad85-214">Messages that are consumed within a few seconds are not written to the messaging store.</span></span> <span data-ttu-id="5ad85-215">下列範例會建立快速主題。</span><span class="sxs-lookup"><span data-stu-id="5ad85-215">The following example creates an express topic.</span></span>

```csharp
TopicDescription td = new TopicDescription(TopicName);
td.EnableExpress = true;
namespaceManager.CreateTopic(td);
```

<span data-ttu-id="5ad85-216">如果將包含不能遺失之重要資訊的訊息傳送至快速實體，傳送者可以強制服務匯流排立即藉由將 [ForcePersistence][ForcePersistence] 屬性設為 **true** 來將訊息儲存到穩定儲存體。</span><span class="sxs-lookup"><span data-stu-id="5ad85-216">If a message containing critical information that must not be lost is sent to an express entity, the sender can force Service Bus to immediately persist the message to stable storage by setting the [ForcePersistence][ForcePersistence] property to **true**.</span></span>

> [!NOTE]
> <span data-ttu-id="5ad85-217">快速實體並不支援交易。</span><span class="sxs-lookup"><span data-stu-id="5ad85-217">Express entities do not support transactions.</span></span>

## <a name="use-of-partitioned-queues-or-topics"></a><span data-ttu-id="5ad85-218">使用分割的佇列或主題</span><span class="sxs-lookup"><span data-stu-id="5ad85-218">Use of partitioned queues or topics</span></span>
<span data-ttu-id="5ad85-219">服務匯流排會在內部使用相同的節點和訊息存放區來處理和儲存傳訊實體 (佇列或主題) 的所有訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-219">Internally, Service Bus uses the same node and messaging store to process and store all messages for a messaging entity (queue or topic).</span></span> <span data-ttu-id="5ad85-220">另一方面，分割的佇列或主題會在多個節點和訊息存放區中散佈。</span><span class="sxs-lookup"><span data-stu-id="5ad85-220">A partitioned queue or topic, on the other hand, is distributed across multiple nodes and messaging stores.</span></span> <span data-ttu-id="5ad85-221">分割的佇列和主題不僅會產生比一般佇列和主題更高的輸送量，也會展現較優異的可用性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-221">Partitioned queues and topics not only yield a higher throughput than regular queues and topics, they also exhibit superior availability.</span></span> <span data-ttu-id="5ad85-222">若要建立分割的實體，請將 [EnablePartitioning][EnablePartitioning] 屬性設為 **true**，如下列範例所示。</span><span class="sxs-lookup"><span data-stu-id="5ad85-222">To create a partitioned entity, set the [EnablePartitioning][EnablePartitioning] property to **true**, as shown in the following example.</span></span> <span data-ttu-id="5ad85-223">如需分割實體的詳細資訊，請參閱[分割的傳訊實體][Partitioned messaging entities]。</span><span class="sxs-lookup"><span data-stu-id="5ad85-223">For more information about partitioned entities, see [Partitioned messaging entities][Partitioned messaging entities].</span></span>

```csharp
// Create partitioned queue.
QueueDescription qd = new QueueDescription(QueueName);
qd.EnablePartitioning = true;
namespaceManager.CreateQueue(qd);
```

## <a name="use-of-multiple-queues"></a><span data-ttu-id="5ad85-224">使用多個佇列</span><span class="sxs-lookup"><span data-stu-id="5ad85-224">Use of multiple queues</span></span>

<span data-ttu-id="5ad85-225">如果您不能使用分割的佇列或主題，或無法由單一分割佇列或主題處理預期的負載，您必須使用多個傳訊實體。</span><span class="sxs-lookup"><span data-stu-id="5ad85-225">If it is not possible to use a partitioned queue or topic, or the expected load cannot be handled by a single partitioned queue or topic, you must use multiple messaging entities.</span></span> <span data-ttu-id="5ad85-226">使用多個實體時，請針對每個實體建立專屬用戶端，而不是讓所有實體使用相同的用戶端。</span><span class="sxs-lookup"><span data-stu-id="5ad85-226">When using multiple entities, create a dedicated client for each entity, instead of using the same client for all entities.</span></span>

## <a name="development-and-testing-features"></a><span data-ttu-id="5ad85-227">開發與測試功能</span><span class="sxs-lookup"><span data-stu-id="5ad85-227">Development and testing features</span></span>

<span data-ttu-id="5ad85-228">服務匯流排有一項專門用於開發的功能，此功能**永遠不應該用在生產組態**：[TopicDescription.EnableFilteringMessagesBeforePublishing][]。</span><span class="sxs-lookup"><span data-stu-id="5ad85-228">Service Bus has one feature that is used specifically for development which **should never be used in production configurations**: [TopicDescription.EnableFilteringMessagesBeforePublishing][].</span></span>

<span data-ttu-id="5ad85-229">當新的規則或篩選器新增至主題時，您可以使用 [TopicDescription.EnableFilteringMessagesBeforePublishing][] 來確認新的篩選運算式如預期般運作。</span><span class="sxs-lookup"><span data-stu-id="5ad85-229">When new rules or filters are added to the topic, you can use [TopicDescription.EnableFilteringMessagesBeforePublishing][] to verify that the new filter expression is working as expected.</span></span>

## <a name="scenarios"></a><span data-ttu-id="5ad85-230">案例</span><span class="sxs-lookup"><span data-stu-id="5ad85-230">Scenarios</span></span>
<span data-ttu-id="5ad85-231">下列各節描述典型傳訊的案例，並簡述慣用的服務匯流排設定。</span><span class="sxs-lookup"><span data-stu-id="5ad85-231">The following sections describe typical messaging scenarios and outline the preferred Service Bus settings.</span></span> <span data-ttu-id="5ad85-232">輸送量速率會分類為小型 (小於 1 則訊息/秒)、中型 (1 則訊息/秒或更多但小於 100 則訊息/秒) 和高型 (100 則訊息/秒或更多)。</span><span class="sxs-lookup"><span data-stu-id="5ad85-232">Throughput rates are classified as small (less than 1 message/second), moderate (1 message/second or greater but less than 100 messages/second) and high (100 messages/second or greater).</span></span> <span data-ttu-id="5ad85-233">用戶端數目可分類為小型 (5 個或更少)、中型 (5 個以上但小於或等於 20 個) 和大型 (超過 20 個)。</span><span class="sxs-lookup"><span data-stu-id="5ad85-233">The number of clients are classified as small (5 or fewer), moderate (more than 5 but less than or equal to 20), and large (more than 20).</span></span>

### <a name="high-throughput-queue"></a><span data-ttu-id="5ad85-234">高輸送量佇列</span><span class="sxs-lookup"><span data-stu-id="5ad85-234">High-throughput queue</span></span>
<span data-ttu-id="5ad85-235">目標：最大化單一佇列的輸送量。</span><span class="sxs-lookup"><span data-stu-id="5ad85-235">Goal: Maximize the throughput of a single queue.</span></span> <span data-ttu-id="5ad85-236">傳送者和接收者的數目很少。</span><span class="sxs-lookup"><span data-stu-id="5ad85-236">The number of senders and receivers is small.</span></span>

* <span data-ttu-id="5ad85-237">使用分割的佇列以改善效能和可用性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-237">Use a partitioned queue for improved performance and availability.</span></span>
* <span data-ttu-id="5ad85-238">若要增加傳送到佇列的整體速率，請使用多個訊息處理站來建立傳送者。</span><span class="sxs-lookup"><span data-stu-id="5ad85-238">To increase the overall send rate into the queue, use multiple message factories to create senders.</span></span> <span data-ttu-id="5ad85-239">對每個傳送者使用非同步作業或多個執行緒。</span><span class="sxs-lookup"><span data-stu-id="5ad85-239">For each sender, use asynchronous operations or multiple threads.</span></span>
* <span data-ttu-id="5ad85-240">若要增加從佇列接收的整體速率，請使用多個訊息處理站來建立接收者。</span><span class="sxs-lookup"><span data-stu-id="5ad85-240">To increase the overall receive rate from the queue, use multiple message factories to create receivers.</span></span>
* <span data-ttu-id="5ad85-241">使用非同步作業來利用用戶端批次處理。</span><span class="sxs-lookup"><span data-stu-id="5ad85-241">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="5ad85-242">將批次處理間隔設為 50 毫秒，以減少服務匯流排用戶端通訊協定傳輸數目。</span><span class="sxs-lookup"><span data-stu-id="5ad85-242">Set the batching interval to 50ms to reduce the number of Service Bus client protocol transmissions.</span></span> <span data-ttu-id="5ad85-243">如果使用多個傳送者，批次處理間隔會增加到 100 毫秒。</span><span class="sxs-lookup"><span data-stu-id="5ad85-243">If multiple senders are used, increase the batching interval to 100ms.</span></span>
* <span data-ttu-id="5ad85-244">讓批次處理的存放區存取保持啟用。</span><span class="sxs-lookup"><span data-stu-id="5ad85-244">Leave batched store access enabled.</span></span> <span data-ttu-id="5ad85-245">這會增加訊息寫入至佇列的整體速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-245">This increases the overall rate at which messages can be written into the queue.</span></span>
* <span data-ttu-id="5ad85-246">將預先擷取計數設為 20 乘以處理站所有接收者的最高處理速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-246">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span></span> <span data-ttu-id="5ad85-247">這會減少服務匯流排用戶端通訊協定傳輸數目。</span><span class="sxs-lookup"><span data-stu-id="5ad85-247">This reduces the number of Service Bus client protocol transmissions.</span></span>

### <a name="multiple-high-throughput-queues"></a><span data-ttu-id="5ad85-248">多個高輸送量佇列</span><span class="sxs-lookup"><span data-stu-id="5ad85-248">Multiple high-throughput queues</span></span>
<span data-ttu-id="5ad85-249">目標：最大化多個佇列的整體輸送量。</span><span class="sxs-lookup"><span data-stu-id="5ad85-249">Goal: Maximize overall throughput of multiple queues.</span></span> <span data-ttu-id="5ad85-250">個別佇列的輸送量為中或高。</span><span class="sxs-lookup"><span data-stu-id="5ad85-250">The throughput of an individual queue is moderate or high.</span></span>

<span data-ttu-id="5ad85-251">若要取得跨多個佇列的最大輸送量，請使用簡述的設定以最大化單一佇列的輸送量。</span><span class="sxs-lookup"><span data-stu-id="5ad85-251">To obtain maximum throughput across multiple queues, use the settings outlined to maximize the throughput of a single queue.</span></span> <span data-ttu-id="5ad85-252">此外，使用不同的處理站來建立傳送至或接收自不同佇列的用戶端。</span><span class="sxs-lookup"><span data-stu-id="5ad85-252">In addition, use different factories to create clients that send or receive from different queues.</span></span>

### <a name="low-latency-queue"></a><span data-ttu-id="5ad85-253">低延遲性佇列</span><span class="sxs-lookup"><span data-stu-id="5ad85-253">Low latency queue</span></span>
<span data-ttu-id="5ad85-254">目標：最小化佇列或主題的端對端延遲。</span><span class="sxs-lookup"><span data-stu-id="5ad85-254">Goal: Minimize end-to-end latency of a queue or topic.</span></span> <span data-ttu-id="5ad85-255">傳送者和接收者的數目很少。</span><span class="sxs-lookup"><span data-stu-id="5ad85-255">The number of senders and receivers is small.</span></span> <span data-ttu-id="5ad85-256">佇列的輸送量為小或中。</span><span class="sxs-lookup"><span data-stu-id="5ad85-256">The throughput of the queue is small or moderate.</span></span>

* <span data-ttu-id="5ad85-257">使用分割的佇列以改善可用性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-257">Use a partitioned queue for improved availability.</span></span>
* <span data-ttu-id="5ad85-258">停用用戶端批次處理。</span><span class="sxs-lookup"><span data-stu-id="5ad85-258">Disable client-side batching.</span></span> <span data-ttu-id="5ad85-259">用戶端會立即傳送訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-259">The client immediately sends a message.</span></span>
* <span data-ttu-id="5ad85-260">停用批次處理的存放區存取。</span><span class="sxs-lookup"><span data-stu-id="5ad85-260">Disable batched store access.</span></span> <span data-ttu-id="5ad85-261">服務會立即將訊息寫入至存放區中。</span><span class="sxs-lookup"><span data-stu-id="5ad85-261">The service immediately writes the message to the store.</span></span>
* <span data-ttu-id="5ad85-262">如果使用單一用戶端，請將預先擷取計數設為 20 乘以接收者的處理速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-262">If using a single client, set the prefetch count to 20 times the processing rate of the receiver.</span></span> <span data-ttu-id="5ad85-263">如果多個訊息同時抵達佇列，服務匯流排用戶端通訊協定會同時將它們全部傳輸。</span><span class="sxs-lookup"><span data-stu-id="5ad85-263">If multiple messages arrive at the queue at the same time, the Service Bus client protocol transmits them all at the same time.</span></span> <span data-ttu-id="5ad85-264">當用戶端收到下一個訊息時，該訊息已經在本機快取中。</span><span class="sxs-lookup"><span data-stu-id="5ad85-264">When the client receives the next message, that message is already in the local cache.</span></span> <span data-ttu-id="5ad85-265">快取應該很小。</span><span class="sxs-lookup"><span data-stu-id="5ad85-265">The cache should be small.</span></span>
* <span data-ttu-id="5ad85-266">如果使用多個用戶端，請將預先擷取計數設為 0。</span><span class="sxs-lookup"><span data-stu-id="5ad85-266">If using multiple clients, set the prefetch count to 0.</span></span> <span data-ttu-id="5ad85-267">如此一來，第二個用戶端可以在第一個用戶端仍在處理第一個訊息時接收第二個訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-267">By doing this, the second client can receive the second message while the first client is still processing the first message.</span></span>

### <a name="queue-with-a-large-number-of-senders"></a><span data-ttu-id="5ad85-268">具有大量傳送者的佇列</span><span class="sxs-lookup"><span data-stu-id="5ad85-268">Queue with a large number of senders</span></span>
<span data-ttu-id="5ad85-269">目標：最大化具有大量傳送者之佇列或主題的輸送量。</span><span class="sxs-lookup"><span data-stu-id="5ad85-269">Goal: Maximize throughput of a queue or topic with a large number of senders.</span></span> <span data-ttu-id="5ad85-270">每個傳送者都會以中等速率傳送訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-270">Each sender sends messages with a moderate rate.</span></span> <span data-ttu-id="5ad85-271">接收者的數目很少。</span><span class="sxs-lookup"><span data-stu-id="5ad85-271">The number of receivers is small.</span></span>

<span data-ttu-id="5ad85-272">服務匯流排可啟用多達 1000 個並行連線至訊息實體 (或使用 AMQP 可達 5000 個)。</span><span class="sxs-lookup"><span data-stu-id="5ad85-272">Service Bus enables up to 1000 concurrent connections to a messaging entity (or 5000 using AMQP).</span></span> <span data-ttu-id="5ad85-273">在命名空間層級強制執行這項限制，且佇列/主題/訂用帳戶的上限為每個命名空間的並行連線限制。</span><span class="sxs-lookup"><span data-stu-id="5ad85-273">This limit is enforced at the namespace level, and queues/topics/subscriptions are capped by the limit of concurrent connections per namespace.</span></span> <span data-ttu-id="5ad85-274">對佇列而言，這個數目是在傳送者和接收者之間共用的。</span><span class="sxs-lookup"><span data-stu-id="5ad85-274">For queues, this number is shared between senders and receivers.</span></span> <span data-ttu-id="5ad85-275">如果 1000 個連線全都為傳送者所需，您必須以主題和單一訂用帳戶取代此佇列。</span><span class="sxs-lookup"><span data-stu-id="5ad85-275">If all 1000 connections are required for senders, you should replace the queue with a topic and a single subscription.</span></span> <span data-ttu-id="5ad85-276">主題會接受多達 1000 個來自傳送者的並行連線，而訂用帳戶可接受來自接收者的額外 1000 個並行連線。</span><span class="sxs-lookup"><span data-stu-id="5ad85-276">A topic accepts up to 1000 concurrent connections from senders, whereas the subscription accepts an additional 1000 concurrent connections from receivers.</span></span> <span data-ttu-id="5ad85-277">如果需要超過 1000 個並行傳送者，傳送者必須透過 HTTP 將訊息傳送至服務匯流排通訊協定。</span><span class="sxs-lookup"><span data-stu-id="5ad85-277">If more than 1000 concurrent senders are required, the senders should send messages to the Service Bus protocol via HTTP.</span></span>

<span data-ttu-id="5ad85-278">若要最大化輸送量，請執行下列作業：</span><span class="sxs-lookup"><span data-stu-id="5ad85-278">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="5ad85-279">使用分割的佇列以改善效能和可用性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-279">Use a partitioned queue for improved performance and availability.</span></span>
* <span data-ttu-id="5ad85-280">如果每個傳送者都位於不同的處理序中，每個處理序僅使用單一處理站。</span><span class="sxs-lookup"><span data-stu-id="5ad85-280">If each sender resides in a different process, use only a single factory per process.</span></span>
* <span data-ttu-id="5ad85-281">使用非同步作業來利用用戶端批次處理。</span><span class="sxs-lookup"><span data-stu-id="5ad85-281">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="5ad85-282">使用預設的批次處理間隔 20 毫秒來減少服務匯流排用戶端通訊協定傳輸數目。</span><span class="sxs-lookup"><span data-stu-id="5ad85-282">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span></span>
* <span data-ttu-id="5ad85-283">讓批次處理的存放區存取保持啟用。</span><span class="sxs-lookup"><span data-stu-id="5ad85-283">Leave batched store access enabled.</span></span> <span data-ttu-id="5ad85-284">這會增加訊息寫入至佇列或主題的整體速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-284">This increases the overall rate at which messages can be written into the queue or topic.</span></span>
* <span data-ttu-id="5ad85-285">將預先擷取計數設為 20 乘以處理站所有接收者的最高處理速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-285">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span></span> <span data-ttu-id="5ad85-286">這會減少服務匯流排用戶端通訊協定傳輸數目。</span><span class="sxs-lookup"><span data-stu-id="5ad85-286">This reduces the number of Service Bus client protocol transmissions.</span></span>

### <a name="queue-with-a-large-number-of-receivers"></a><span data-ttu-id="5ad85-287">具有大量接收者的佇列</span><span class="sxs-lookup"><span data-stu-id="5ad85-287">Queue with a large number of receivers</span></span>
<span data-ttu-id="5ad85-288">目標：最大化具有大量接收者之佇列或訂用帳戶的接收速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-288">Goal: Maximize the receive rate of a queue or subscription with a large number of receivers.</span></span> <span data-ttu-id="5ad85-289">每個接收者皆以中等速率接收訊息。</span><span class="sxs-lookup"><span data-stu-id="5ad85-289">Each receiver receives messages at a moderate rate.</span></span> <span data-ttu-id="5ad85-290">傳送者的數目很少。</span><span class="sxs-lookup"><span data-stu-id="5ad85-290">The number of senders is small.</span></span>

<span data-ttu-id="5ad85-291">服務匯流排可啟用多達 1000 個並行連線至實體。</span><span class="sxs-lookup"><span data-stu-id="5ad85-291">Service Bus enables up to 1000 concurrent connections to an entity.</span></span> <span data-ttu-id="5ad85-292">如果佇列需要超過 1000 個接收者，您必須以主題和多個訂用帳戶取代此佇列。</span><span class="sxs-lookup"><span data-stu-id="5ad85-292">If a queue requires more than 1000 receivers, you should replace the queue with a topic and multiple subscriptions.</span></span> <span data-ttu-id="5ad85-293">每個訂用帳戶可支援最多 1000 個並行連線。</span><span class="sxs-lookup"><span data-stu-id="5ad85-293">Each subscription can support up to 1000 concurrent connections.</span></span> <span data-ttu-id="5ad85-294">此外，接收者可以透過 HTTP 通訊協定存取佇列。</span><span class="sxs-lookup"><span data-stu-id="5ad85-294">Alternatively, receivers can access the queue via the HTTP protocol.</span></span>

<span data-ttu-id="5ad85-295">若要最大化輸送量，請執行下列作業：</span><span class="sxs-lookup"><span data-stu-id="5ad85-295">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="5ad85-296">使用分割的佇列以改善效能和可用性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-296">Use a partitioned queue for improved performance and availability.</span></span>
* <span data-ttu-id="5ad85-297">如果每個接收者都位於不同的處理序中，每個處理序僅使用單一處理站。</span><span class="sxs-lookup"><span data-stu-id="5ad85-297">If each receiver resides in a different process, use only a single factory per process.</span></span>
* <span data-ttu-id="5ad85-298">接收者可以使用同步或非同步作業。</span><span class="sxs-lookup"><span data-stu-id="5ad85-298">Receivers can use synchronous or asynchronous operations.</span></span> <span data-ttu-id="5ad85-299">若指定個別接收者的中等接收速率，完全要求的用戶端批次處理不會影響接收者輸送量。</span><span class="sxs-lookup"><span data-stu-id="5ad85-299">Given the moderate receive rate of an individual receiver, client-side batching of a Complete request does not affect receiver throughput.</span></span>
* <span data-ttu-id="5ad85-300">讓批次處理的存放區存取保持啟用。</span><span class="sxs-lookup"><span data-stu-id="5ad85-300">Leave batched store access enabled.</span></span> <span data-ttu-id="5ad85-301">這會減少實體的整體負載。</span><span class="sxs-lookup"><span data-stu-id="5ad85-301">This reduces the overall load of the entity.</span></span> <span data-ttu-id="5ad85-302">它也會減少訊息寫入至佇列或主題的整體速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-302">It also reduces the overall rate at which messages can be written into the queue or topic.</span></span>
* <span data-ttu-id="5ad85-303">將預先擷取計數設為較小的值 (例如，PrefetchCount = 10)。</span><span class="sxs-lookup"><span data-stu-id="5ad85-303">Set the prefetch count to a small value (for example, PrefetchCount = 10).</span></span> <span data-ttu-id="5ad85-304">這樣可以避免接收者在其他接收者具有大量快取的訊息時閒置。</span><span class="sxs-lookup"><span data-stu-id="5ad85-304">This prevents receivers from being idle while other receivers have large numbers of messages cached.</span></span>

### <a name="topic-with-a-small-number-of-subscriptions"></a><span data-ttu-id="5ad85-305">具有少量訂用帳戶的主題</span><span class="sxs-lookup"><span data-stu-id="5ad85-305">Topic with a small number of subscriptions</span></span>
<span data-ttu-id="5ad85-306">目標：最大化具有少量訂用帳戶之主題的輸送量。</span><span class="sxs-lookup"><span data-stu-id="5ad85-306">Goal: Maximize the throughput of a topic with a small number of subscriptions.</span></span> <span data-ttu-id="5ad85-307">許多訂用帳戶收到一則訊息，表示所有訂用帳戶的合併接收速率高於傳送速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-307">A message is received by many subscriptions, which means the combined receive rate over all subscriptions is larger than the send rate.</span></span> <span data-ttu-id="5ad85-308">傳送者的數目很少。</span><span class="sxs-lookup"><span data-stu-id="5ad85-308">The number of senders is small.</span></span> <span data-ttu-id="5ad85-309">每個訂用帳戶的接收者數目很少。</span><span class="sxs-lookup"><span data-stu-id="5ad85-309">The number of receivers per subscription is small.</span></span>

<span data-ttu-id="5ad85-310">若要最大化輸送量，請執行下列作業：</span><span class="sxs-lookup"><span data-stu-id="5ad85-310">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="5ad85-311">使用分割的主題以改善效能和可用性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-311">Use a partitioned topic for improved performance and availability.</span></span>
* <span data-ttu-id="5ad85-312">若要增加傳送到主題的整體速率，請使用多個訊息處理站來建立傳送者。</span><span class="sxs-lookup"><span data-stu-id="5ad85-312">To increase the overall send rate into the topic, use multiple message factories to create senders.</span></span> <span data-ttu-id="5ad85-313">對每個傳送者使用非同步作業或多個執行緒。</span><span class="sxs-lookup"><span data-stu-id="5ad85-313">For each sender, use asynchronous operations or multiple threads.</span></span>
* <span data-ttu-id="5ad85-314">若要增加從訂用帳戶接收的整體速率，請使用多個訊息處理站來建立接收者。</span><span class="sxs-lookup"><span data-stu-id="5ad85-314">To increase the overall receive rate from a subscription, use multiple message factories to create receivers.</span></span> <span data-ttu-id="5ad85-315">對每個接收者使用非同步作業或多個執行緒。</span><span class="sxs-lookup"><span data-stu-id="5ad85-315">For each receiver, use asynchronous operations or multiple threads.</span></span>
* <span data-ttu-id="5ad85-316">使用非同步作業來利用用戶端批次處理。</span><span class="sxs-lookup"><span data-stu-id="5ad85-316">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="5ad85-317">使用預設的批次處理間隔 20 毫秒來減少服務匯流排用戶端通訊協定傳輸數目。</span><span class="sxs-lookup"><span data-stu-id="5ad85-317">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span></span>
* <span data-ttu-id="5ad85-318">讓批次處理的存放區存取保持啟用。</span><span class="sxs-lookup"><span data-stu-id="5ad85-318">Leave batched store access enabled.</span></span> <span data-ttu-id="5ad85-319">這會增加訊息寫入至主題的整體速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-319">This increases the overall rate at which messages can be written into the topic.</span></span>
* <span data-ttu-id="5ad85-320">將預先擷取計數設為 20 乘以處理站所有接收者的最高處理速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-320">Set the prefetch count to 20 times the maximum processing rates of all receivers of a factory.</span></span> <span data-ttu-id="5ad85-321">這會減少服務匯流排用戶端通訊協定傳輸數目。</span><span class="sxs-lookup"><span data-stu-id="5ad85-321">This reduces the number of Service Bus client protocol transmissions.</span></span>

### <a name="topic-with-a-large-number-of-subscriptions"></a><span data-ttu-id="5ad85-322">具有大量訂用帳戶的主題</span><span class="sxs-lookup"><span data-stu-id="5ad85-322">Topic with a large number of subscriptions</span></span>
<span data-ttu-id="5ad85-323">目標：最大化具有大量訂用帳戶之主題的輸送量。</span><span class="sxs-lookup"><span data-stu-id="5ad85-323">Goal: Maximize the throughput of a topic with a large number of subscriptions.</span></span> <span data-ttu-id="5ad85-324">許多訂用帳戶收到一則訊息，表示所有訂用帳戶的合併接收速率遠高於傳送速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-324">A message is received by many subscriptions, which means the combined receive rate over all subscriptions is much larger than the send rate.</span></span> <span data-ttu-id="5ad85-325">傳送者的數目很少。</span><span class="sxs-lookup"><span data-stu-id="5ad85-325">The number of senders is small.</span></span> <span data-ttu-id="5ad85-326">每個訂用帳戶的接收者數目很少。</span><span class="sxs-lookup"><span data-stu-id="5ad85-326">The number of receivers per subscription is small.</span></span>

<span data-ttu-id="5ad85-327">如果所有訊息都路由傳送至所有訂用帳戶，具有大量訂用帳戶的主題通常會顯露較低的整體輸送量。</span><span class="sxs-lookup"><span data-stu-id="5ad85-327">Topics with a large number of subscriptions typically expose a low overall throughput if all messages are routed to all subscriptions.</span></span> <span data-ttu-id="5ad85-328">這是因為每個訊息都被接收了許多次，而且包含在主題與其所有訂用帳戶中的所有訊息都儲存在相同的存放區中。</span><span class="sxs-lookup"><span data-stu-id="5ad85-328">This is caused by the fact that each message is received many times, and all messages that are contained in a topic and all its subscriptions are stored in the same store.</span></span> <span data-ttu-id="5ad85-329">它會假設每個訂用帳戶的傳送者數目和接收者數目都很少。</span><span class="sxs-lookup"><span data-stu-id="5ad85-329">It is assumed that the number of senders and number of receivers per subscription is small.</span></span> <span data-ttu-id="5ad85-330">服務匯流排支援每個主題最多 2,000 個訂用帳戶。</span><span class="sxs-lookup"><span data-stu-id="5ad85-330">Service Bus supports up to 2,000 subscriptions per topic.</span></span>

<span data-ttu-id="5ad85-331">若要最大化輸送量，請執行下列作業：</span><span class="sxs-lookup"><span data-stu-id="5ad85-331">To maximize throughput, do the following:</span></span>

* <span data-ttu-id="5ad85-332">使用分割的主題以改善效能和可用性。</span><span class="sxs-lookup"><span data-stu-id="5ad85-332">Use a partitioned topic for improved performance and availability.</span></span>
* <span data-ttu-id="5ad85-333">使用非同步作業來利用用戶端批次處理。</span><span class="sxs-lookup"><span data-stu-id="5ad85-333">Use asynchronous operations to take advantage of client-side batching.</span></span>
* <span data-ttu-id="5ad85-334">使用預設的批次處理間隔 20 毫秒來減少服務匯流排用戶端通訊協定傳輸數目。</span><span class="sxs-lookup"><span data-stu-id="5ad85-334">Use the default batching interval of 20ms to reduce the number of Service Bus client protocol transmissions.</span></span>
* <span data-ttu-id="5ad85-335">讓批次處理的存放區存取保持啟用。</span><span class="sxs-lookup"><span data-stu-id="5ad85-335">Leave batched store access enabled.</span></span> <span data-ttu-id="5ad85-336">這會增加訊息寫入至主題的整體速率。</span><span class="sxs-lookup"><span data-stu-id="5ad85-336">This increases the overall rate at which messages can be written into the topic.</span></span>
* <span data-ttu-id="5ad85-337">將預先擷取設為 20 乘以預期的接收速率 (以秒為單位)。</span><span class="sxs-lookup"><span data-stu-id="5ad85-337">Set the prefetch count to 20 times the expected receive rate in seconds.</span></span> <span data-ttu-id="5ad85-338">這會減少服務匯流排用戶端通訊協定傳輸數目。</span><span class="sxs-lookup"><span data-stu-id="5ad85-338">This reduces the number of Service Bus client protocol transmissions.</span></span>

## <a name="next-steps"></a><span data-ttu-id="5ad85-339">後續步驟</span><span class="sxs-lookup"><span data-stu-id="5ad85-339">Next steps</span></span>
<span data-ttu-id="5ad85-340">若要深入了解如何最佳化服務匯流排效能，請參閱[分割的傳訊實體][Partitioned messaging entities]。</span><span class="sxs-lookup"><span data-stu-id="5ad85-340">To learn more about optimizing Service Bus performance, see [Partitioned messaging entities][Partitioned messaging entities].</span></span>

[QueueClient]: /dotnet/api/microsoft.servicebus.messaging.queueclient
[MessageSender]: /dotnet/api/microsoft.servicebus.messaging.messagesender
[MessagingFactory]: /dotnet/api/microsoft.servicebus.messaging.messagingfactory
[PeekLock]: /dotnet/api/microsoft.servicebus.messaging.receivemode
[ReceiveAndDelete]: /dotnet/api/microsoft.servicebus.messaging.receivemode
[BatchFlushInterval]: /dotnet/api/microsoft.servicebus.messaging.netmessagingtransportsettings.batchflushinterval#Microsoft_ServiceBus_Messaging_NetMessagingTransportSettings_BatchFlushInterval
[EnableBatchedOperations]: /dotnet/api/microsoft.servicebus.messaging.queuedescription.enablebatchedoperations#Microsoft_ServiceBus_Messaging_QueueDescription_EnableBatchedOperations
[QueueClient.PrefetchCount]: /dotnet/api/microsoft.servicebus.messaging.queueclient.prefetchcount#Microsoft_ServiceBus_Messaging_QueueClient_PrefetchCount
[SubscriptionClient.PrefetchCount]: /dotnet/api/microsoft.servicebus.messaging.subscriptionclient.prefetchcount#Microsoft_ServiceBus_Messaging_SubscriptionClient_PrefetchCount
[ForcePersistence]: /dotnet/api/microsoft.servicebus.messaging.brokeredmessage.forcepersistence#Microsoft_ServiceBus_Messaging_BrokeredMessage_ForcePersistence
[EnablePartitioning]: /dotnet/api/microsoft.servicebus.messaging.queuedescription.enablepartitioning#Microsoft_ServiceBus_Messaging_QueueDescription_EnablePartitioning
[Partitioned messaging entities]: service-bus-partitioning.md
<span data-ttu-id="5ad85-341">[TopicDescription.EnableFilteringMessagesBeforePublishing]: /dotnet/api/microsoft.servicebus.messaging.topicdescription.enablefilteringmessagesbeforepublishing#Microsoft_ServiceBus_Messaging_TopicDescription_EnableFilteringMessagesBeforePublishing</span><span class="sxs-lookup"><span data-stu-id="5ad85-341">[TopicDescription.EnableFilteringMessagesBeforePublishing]: /dotnet/api/microsoft.servicebus.messaging.topicdescription.enablefilteringmessagesbeforepublishing#Microsoft_ServiceBus_Messaging_TopicDescription_EnableFilteringMessagesBeforePublishing</span></span>
