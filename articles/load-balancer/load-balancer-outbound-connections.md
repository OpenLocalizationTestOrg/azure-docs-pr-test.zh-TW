---
title: "了解 Azure 中的輸出連線 | Microsoft Docs"
description: "本文說明如何讓 Azure VM 與公用網際網路服務進行通訊。"
services: load-balancer
documentationcenter: na
author: kumudd
manager: timlt
editor: 
ms.assetid: 5f666f2a-3a63-405a-abcd-b2e34d40e001
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 5/31/2017
ms.author: kumud
ms.openlocfilehash: 03cb14b5710b6dd17599a3c4eab21380c76c2b40
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/03/2017
---
# <a name="understanding-outbound-connections-in-azure"></a><span data-ttu-id="38707-103">了解 Azure 中的輸出連線</span><span class="sxs-lookup"><span data-stu-id="38707-103">Understanding outbound connections in Azure</span></span>

<span data-ttu-id="38707-104">Azure 中的虛擬機器 (VM) 可在公用 IP 位址空間中與 Azure 外部的端點進行通訊。</span><span class="sxs-lookup"><span data-stu-id="38707-104">A Virtual Machine (VM) in Azure can communicate with endpoints outside of Azure in public IP address space.</span></span> <span data-ttu-id="38707-105">當 VM 啟動輸出流程至公用 IP 位址空間中的目的地時，Azure 會將 VM 的私人 IP 位址對應到一個公用 IP 位址，並允許傳回到達 VM 的流量。</span><span class="sxs-lookup"><span data-stu-id="38707-105">When a VM initiates an outbound flow to a destination in public IP address space, Azure maps the VM's private IP address to a public IP address and allows return traffic to reach the VM.</span></span>

<span data-ttu-id="38707-106">Azure 提供三種不同的方法來達成輸出連線。</span><span class="sxs-lookup"><span data-stu-id="38707-106">Azure provides three different methods to achieve outbound connectivity.</span></span> <span data-ttu-id="38707-107">每個方法都有自己的功能和條件約束。</span><span class="sxs-lookup"><span data-stu-id="38707-107">Each method has its own capabilities and constraints.</span></span> <span data-ttu-id="38707-108">仔細檢閱每一種方法以選擇符合您需求的方法。</span><span class="sxs-lookup"><span data-stu-id="38707-108">Review each method carefully to choose which one meets your needs.</span></span>

| <span data-ttu-id="38707-109">案例</span><span class="sxs-lookup"><span data-stu-id="38707-109">Scenario</span></span> | <span data-ttu-id="38707-110">方法</span><span class="sxs-lookup"><span data-stu-id="38707-110">Method</span></span> | <span data-ttu-id="38707-111">注意</span><span class="sxs-lookup"><span data-stu-id="38707-111">Note</span></span> |
| --- | --- | --- |
| <span data-ttu-id="38707-112">獨立 VM (無負載平衡器，無執行個體層級公用 IP 位址)</span><span class="sxs-lookup"><span data-stu-id="38707-112">Standalone VM (no load balancer, no Instance Level Public IP address)</span></span> |<span data-ttu-id="38707-113">預設 SNAT</span><span class="sxs-lookup"><span data-stu-id="38707-113">Default SNAT</span></span> |<span data-ttu-id="38707-114">Azure 關聯 SNAT 的公用 IP 位址</span><span class="sxs-lookup"><span data-stu-id="38707-114">Azure associates a public IP address for SNAT</span></span> |
| <span data-ttu-id="38707-115">負載平衡的 VM (無 VM 上的執行個體層級公用 IP 位址)</span><span class="sxs-lookup"><span data-stu-id="38707-115">Load-balanced VM (no Instance Level Public IP address on VM)</span></span> |<span data-ttu-id="38707-116">使用負載平衡器 的 SNAT</span><span class="sxs-lookup"><span data-stu-id="38707-116">SNAT using the load balancer</span></span> |<span data-ttu-id="38707-117">Azure 會使用 SNAT 的負載平衡器公用 IP 位址</span><span class="sxs-lookup"><span data-stu-id="38707-117">Azure uses a public IP address of the Load Balancer for SNAT</span></span> |
| <span data-ttu-id="38707-118">具有執行個體層級公用 IP 位址的 VM (無論是否有負載平衡器)</span><span class="sxs-lookup"><span data-stu-id="38707-118">VM with Instance Level Public IP address (with or without load balancer)</span></span> |<span data-ttu-id="38707-119">未使用 SNAT</span><span class="sxs-lookup"><span data-stu-id="38707-119">SNAT is not used</span></span> |<span data-ttu-id="38707-120">Azure 會使用指派給 VM 的公用 IP</span><span class="sxs-lookup"><span data-stu-id="38707-120">Azure uses the public IP assigned to the VM</span></span> |

<span data-ttu-id="38707-121">如果您不想要 VM 與公用 IP 位址空間中的 Azure 外部端點進行通訊，您可以使用網路安全性群組 (NSG) 來封鎖存取。</span><span class="sxs-lookup"><span data-stu-id="38707-121">If you do not want a VM to communicate with endpoints outside of Azure in public IP address space, you can use Network Security Groups (NSG) to block access.</span></span> <span data-ttu-id="38707-122">[防止公用連線](#preventing-public-connectivity)中會更詳細地討論使用 NSG。</span><span class="sxs-lookup"><span data-stu-id="38707-122">Using NSGs is discussed in more detail in [Preventing Public Connectivity](#preventing-public-connectivity).</span></span>

## <a name="standalone-vm-with-no-instance-level-public-ip-address"></a><span data-ttu-id="38707-123">無執行個體層級公用 IP 位址的獨立 VM</span><span class="sxs-lookup"><span data-stu-id="38707-123">Standalone VM with no Instance Level Public IP address</span></span>

<span data-ttu-id="38707-124">在此案例中，VM 不是 Azure Load Balancer 集區的一部分，而且沒有指派給它的執行個體層級公用 IP (ILPIP) 位址。</span><span class="sxs-lookup"><span data-stu-id="38707-124">In this scenario, the VM is not part of an Azure Load Balancer pool and does not have an Instance Level Public IP (ILPIP) address assigned to it.</span></span> <span data-ttu-id="38707-125">當 VM 建立輸出流程時，Azure 會將輸出流量的公用來源 IP 位址轉譯為私用來源 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="38707-125">When the VM creates an outbound flow, Azure translates the private source IP address of the outbound flow to a public source IP address.</span></span> <span data-ttu-id="38707-126">此輸出流量所用的公用 IP 位址無法進行設定，而且不利於訂用帳戶的公用 IP 資源限制。</span><span class="sxs-lookup"><span data-stu-id="38707-126">The public IP address used for this outbound flow is not configurable and does not count against the subscription's public IP resource limit.</span></span> <span data-ttu-id="38707-127">Azure 會使用來源網路位址轉譯 (SNAT) 執行這項功能。</span><span class="sxs-lookup"><span data-stu-id="38707-127">Azure uses Source Network Address Translation (SNAT) to perform this function.</span></span> <span data-ttu-id="38707-128">公用 IP 位址的暫時連接埠用來區分源自 VM 的個別流程。</span><span class="sxs-lookup"><span data-stu-id="38707-128">Ephemeral ports of the public IP address are used to distinguish individual flows originated by the VM.</span></span> <span data-ttu-id="38707-129">建立流程時，SNAT 會動態配置暫時連接埠。</span><span class="sxs-lookup"><span data-stu-id="38707-129">SNAT dynamically allocates ephemeral ports when flows are created.</span></span> <span data-ttu-id="38707-130">在此情況下，用於 SNAT 的暫時連接埠稱為 SNAT 連接埠。</span><span class="sxs-lookup"><span data-stu-id="38707-130">In this context, the ephemeral ports used for SNAT are referred to as SNAT ports.</span></span>

<span data-ttu-id="38707-131">SNAT 連接埠是可能會耗盡的有限資源。</span><span class="sxs-lookup"><span data-stu-id="38707-131">SNAT ports are a finite resource that can be exhausted.</span></span> <span data-ttu-id="38707-132">請務必了解取用的方式。</span><span class="sxs-lookup"><span data-stu-id="38707-132">It is important to understand how they are consumed.</span></span> <span data-ttu-id="38707-133">每個流程會取用一個 SNAT 連接埠至單一目的地 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="38707-133">One SNAT port is consumed per flow to a single destination IP address.</span></span> <span data-ttu-id="38707-134">針對相同目的地 IP 位址的多個流程，每個流程取用單一 SNAT 連接埠。</span><span class="sxs-lookup"><span data-stu-id="38707-134">For multiple flows to the same destination IP address, each flow consumes a single SNAT port.</span></span> <span data-ttu-id="38707-135">這可確保自相同公用 IP 位址至相同目的地 IP 位址時，流程是唯一的。</span><span class="sxs-lookup"><span data-stu-id="38707-135">This ensures that the flows are unique when originated from the same public IP address to the same destination IP address.</span></span> <span data-ttu-id="38707-136">每個前往不同目的地 IP 位址的多個流程，每個目的地會取用單一 SNAT 連接埠。</span><span class="sxs-lookup"><span data-stu-id="38707-136">Multiple flows, each to a different destination IP address consume a single SNAT port per destination.</span></span> <span data-ttu-id="38707-137">目的地 IP 位址會使流程唯一。</span><span class="sxs-lookup"><span data-stu-id="38707-137">The destination IP address makes the flows unique.</span></span>

<span data-ttu-id="38707-138">您可以使用[負載平衡器的 Log Analytics](load-balancer-monitor-log.md) 和 [要監視之 SNAT 連接埠耗盡訊息的警示事件記錄檔](load-balancer-monitor-log.md#alert-event-log)。</span><span class="sxs-lookup"><span data-stu-id="38707-138">You can use [Log Analytics for Load Balancer](load-balancer-monitor-log.md) and [Alert event logs to monitor for SNAT port exhaustion messages](load-balancer-monitor-log.md#alert-event-log).</span></span> <span data-ttu-id="38707-139">當 SNAT 連接埠資源耗盡時，輸出流程失敗，直到現有流程釋放 SNAT 連接埠為止。</span><span class="sxs-lookup"><span data-stu-id="38707-139">When SNAT port resources are exhausted, outbound flows fail until SNAT ports are released by existing flows.</span></span> <span data-ttu-id="38707-140">負載平衡器會使用 4 分鐘閒置逾時以收回 SNAT 連接埠。</span><span class="sxs-lookup"><span data-stu-id="38707-140">Load Balancer uses a 4-minute idle timeout for reclaiming SNAT ports.</span></span>

## <a name="load-balanced-vm-with-no-instance-level-public-ip-address"></a><span data-ttu-id="38707-141">無執行個體層級公用 IP 位址的負載平衡 VM</span><span class="sxs-lookup"><span data-stu-id="38707-141">Load-balanced VM with no Instance Level Public IP address</span></span>

<span data-ttu-id="38707-142">在此案例中，VM 是 Azure Load Balancer 集區的一部分。</span><span class="sxs-lookup"><span data-stu-id="38707-142">In this scenario, the VM is part of an Azure Load Balancer pool.</span></span>  <span data-ttu-id="38707-143">VM 沒有指派給它的公用 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="38707-143">The VM does not have a public IP address assigned to it.</span></span> <span data-ttu-id="38707-144">必須使用連結公用 IP 前端與後端集區的規則來設定 Load Balancer 資源。</span><span class="sxs-lookup"><span data-stu-id="38707-144">The Load Balancer resource must be configured with a rule to link the public IP frontend with the backend pool.</span></span>  <span data-ttu-id="38707-145">如果您未完成此設定，行為就如前一節[不含執行個體層級公用 IP 的獨立 VM](load-balancer-outbound-connections.md#standalone-vm-with-no-instance-level-public-ip-address) 中所述。</span><span class="sxs-lookup"><span data-stu-id="38707-145">If you do not complete this configuration, the behavior is as described in the section above for [Standalone VM with no Instance Level Public IP](load-balancer-outbound-connections.md#standalone-vm-with-no-instance-level-public-ip-address).</span></span>

<span data-ttu-id="38707-146">當負載平衡的 VM 建立輸出流程時，Azure 會將輸出流量的私用來源 IP 位址轉譯為公用負載平衡器前端的公用 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="38707-146">When the load-balanced VM creates an outbound flow, Azure translates the private source IP address of the outbound flow to the public IP address of the public Load Balancer frontend.</span></span> <span data-ttu-id="38707-147">Azure 會使用來源網路位址轉譯 (SNAT) 執行這項功能。</span><span class="sxs-lookup"><span data-stu-id="38707-147">Azure uses Source Network Address Translation (SNAT) to perform this function.</span></span> <span data-ttu-id="38707-148">負載平衡器公用 IP 位址的暫時連接埠用來區分源自 VM 的個別流程。</span><span class="sxs-lookup"><span data-stu-id="38707-148">Ephemeral ports of the Load Balancer's public IP address are used to distinguish individual flows originated by the VM.</span></span> <span data-ttu-id="38707-149">建立輸出流程時，SNAT 會動態配置暫時連接埠。</span><span class="sxs-lookup"><span data-stu-id="38707-149">SNAT dynamically allocates ephemeral ports when outbound flows are created.</span></span> <span data-ttu-id="38707-150">在此情況下，用於 SNAT 的暫時連接埠稱為 SNAT 連接埠。</span><span class="sxs-lookup"><span data-stu-id="38707-150">In this context, the ephemeral ports used for SNAT are referred to as SNAT ports.</span></span>

<span data-ttu-id="38707-151">SNAT 連接埠是可能會耗盡的有限資源。</span><span class="sxs-lookup"><span data-stu-id="38707-151">SNAT ports are a finite resource that can be exhausted.</span></span> <span data-ttu-id="38707-152">請務必了解取用的方式。</span><span class="sxs-lookup"><span data-stu-id="38707-152">It is important to understand how they are consumed.</span></span> <span data-ttu-id="38707-153">每個流程會取用一個 SNAT 連接埠至單一目的地 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="38707-153">One SNAT port is consumed per flow to a single destination IP address.</span></span> <span data-ttu-id="38707-154">針對相同目的地 IP 位址的多個流程，每個流程取用單一 SNAT 連接埠。</span><span class="sxs-lookup"><span data-stu-id="38707-154">For multiple flows to the same destination IP address, each flow consumes a single SNAT port.</span></span> <span data-ttu-id="38707-155">這可確保自相同公用 IP 位址至相同目的地 IP 位址時，流程是唯一的。</span><span class="sxs-lookup"><span data-stu-id="38707-155">This ensures that the flows are unique when originated from the same public IP address to the same destination IP address.</span></span> <span data-ttu-id="38707-156">每個前往不同目的地 IP 位址的多個流程，每個目的地會取用單一 SNAT 連接埠。</span><span class="sxs-lookup"><span data-stu-id="38707-156">Multiple flows, each to a different destination IP address consume a single SNAT port per destination.</span></span> <span data-ttu-id="38707-157">目的地 IP 位址會使流程唯一。</span><span class="sxs-lookup"><span data-stu-id="38707-157">The destination IP address makes the flows unique.</span></span>

<span data-ttu-id="38707-158">您可以使用[負載平衡器的 Log Analytics](load-balancer-monitor-log.md) 和 [要監視之 SNAT 連接埠耗盡訊息的警示事件記錄檔](load-balancer-monitor-log.md#alert-event-log)。</span><span class="sxs-lookup"><span data-stu-id="38707-158">You can use [Log Analytics for Load Balancer](load-balancer-monitor-log.md) and [Alert event logs to monitor for SNAT port exhaustion messages](load-balancer-monitor-log.md#alert-event-log).</span></span> <span data-ttu-id="38707-159">當 SNAT 連接埠資源耗盡時，輸出流程失敗，直到現有流程釋放 SNAT 連接埠為止。</span><span class="sxs-lookup"><span data-stu-id="38707-159">When SNAT port resources are exhausted, outbound flows fail until SNAT ports are released by existing flows.</span></span> <span data-ttu-id="38707-160">負載平衡器會使用 4 分鐘閒置逾時以收回 SNAT 連接埠。</span><span class="sxs-lookup"><span data-stu-id="38707-160">Load Balancer uses a 4-minute idle timeout for reclaiming SNAT ports.</span></span>

## <a name="vm-with-an-instance-level-public-ip-address-with-or-without-load-balancer"></a><span data-ttu-id="38707-161">具有執行個體層級公用 IP 位址的 VM (無論是否有負載平衡器)</span><span class="sxs-lookup"><span data-stu-id="38707-161">VM with an Instance Level Public IP address (with or without Load Balancer)</span></span>

<span data-ttu-id="38707-162">在此案例中，VM 具有指派給它的執行個體層級公用 IP (ILPIP)。</span><span class="sxs-lookup"><span data-stu-id="38707-162">In this scenario, the VM has an Instance Level Public IP (ILPIP) assigned to it.</span></span> <span data-ttu-id="38707-163">VM 進行負載平衡與否並不重要。</span><span class="sxs-lookup"><span data-stu-id="38707-163">It does not matter whether the VM is load balanced or not.</span></span> <span data-ttu-id="38707-164">使用 ILPIP 時，不會使用來源網路位址轉譯 (SNAT)。</span><span class="sxs-lookup"><span data-stu-id="38707-164">When an ILPIP is used, Source Network Address Translation (SNAT) is not used.</span></span> <span data-ttu-id="38707-165">VM 會針對所有輸出流程使用 ILPIP。</span><span class="sxs-lookup"><span data-stu-id="38707-165">The VM uses the ILPIP for all outbound flows.</span></span> <span data-ttu-id="38707-166">如果您的應用程式起始許多輸出流程且遇到 SNAT 耗盡，您應該考慮指派 ILPIP 以避免 SNAT 限制。</span><span class="sxs-lookup"><span data-stu-id="38707-166">If your application initiates many outbound flows and you experience SNAT exhaustion, you should consider assigning an ILPIP to avoid SNAT constraints.</span></span>

## <a name="discovering-the-public-ip-used-by-a-given-vm"></a><span data-ttu-id="38707-167">探索指定 VM 使用的公用 IP</span><span class="sxs-lookup"><span data-stu-id="38707-167">Discovering the public IP used by a given VM</span></span>

<span data-ttu-id="38707-168">有許多方式可判斷輸出連線的公用來源 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="38707-168">There are many ways to determine the public source IP address of an outbound connection.</span></span> <span data-ttu-id="38707-169">OpenDNS 提供可顯示您 VM 公用 IP 位址的服務。</span><span class="sxs-lookup"><span data-stu-id="38707-169">OpenDNS provides a service that can show you the public IP address of your VM.</span></span> <span data-ttu-id="38707-170">使用 nslookup 命令，您可以將名稱 myip.opendns.com 的 DNS 查詢傳送至 OpenDNS 解析程式。</span><span class="sxs-lookup"><span data-stu-id="38707-170">Using the nslookup command, you can send a DNS query for the name myip.opendns.com to the OpenDNS resolver.</span></span> <span data-ttu-id="38707-171">服務會傳回用來傳送查詢的來源 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="38707-171">The service returns the source IP address that was used to send the query.</span></span> <span data-ttu-id="38707-172">當您從 VM 執行下列查詢時，回應會是用於該 VM 的公用 IP。</span><span class="sxs-lookup"><span data-stu-id="38707-172">When you execute the following query from your VM, the response is the public IP used for that VM.</span></span>

    nslookup myip.opendns.com resolver1.opendns.com

## <a name="preventing-public-connectivity"></a><span data-ttu-id="38707-173">防止公用連線</span><span class="sxs-lookup"><span data-stu-id="38707-173">Preventing Public Connectivity</span></span>

<span data-ttu-id="38707-174">有時並不想允許 VM 建立輸出流程，或可能需要管理可以使用輸出流程到達的目的地。</span><span class="sxs-lookup"><span data-stu-id="38707-174">Sometimes it is undesirable for a VM to be allowed to create an outbound flow or there may be a requirement to manage which destinations can be reached with outbound flows.</span></span> <span data-ttu-id="38707-175">在此情況下，您使用[網路安全性群組 (NSG)](../virtual-network/virtual-networks-nsg.md) 來管理 VM 可到達的目的地。</span><span class="sxs-lookup"><span data-stu-id="38707-175">In this case, you use [Network Security Groups (NSG)](../virtual-network/virtual-networks-nsg.md) to manage the destinations that the VM can reach.</span></span> <span data-ttu-id="38707-176">當您將 NSG 套用到負載平衡的 VM 時，需要注意[預設標籤](../virtual-network/virtual-networks-nsg.md#default-tags)和[預設規則](../virtual-network/virtual-networks-nsg.md#default-rules)。</span><span class="sxs-lookup"><span data-stu-id="38707-176">When you apply an NSG to a load-balanced VM, you need to pay attention to the [default tags](../virtual-network/virtual-networks-nsg.md#default-tags) and [default rules](../virtual-network/virtual-networks-nsg.md#default-rules).</span></span>

<span data-ttu-id="38707-177">您必須確定 VM 可以從 Azure Load Balancer 接收健康情況探查要求。</span><span class="sxs-lookup"><span data-stu-id="38707-177">You must ensure that the VM can receive health probe requests from Azure Load Balancer.</span></span> <span data-ttu-id="38707-178">如果 NSG 封鎖來自 AZURE_LOADBALANCER 預設標籤的健全狀況探查要求，您的 VM 健全狀況探查會失敗，且會將 VM 標示為離線。</span><span class="sxs-lookup"><span data-stu-id="38707-178">If an NSG blocks health probe requests from the AZURE_LOADBALANCER default tag, your VM health probe fails and the VM is marked down.</span></span> <span data-ttu-id="38707-179">負載平衡器會停止將新的流程傳送到該 VM。</span><span class="sxs-lookup"><span data-stu-id="38707-179">Load Balancer stops sending new flows to that VM.</span></span>

## <a name="limitations"></a><span data-ttu-id="38707-180">限制</span><span class="sxs-lookup"><span data-stu-id="38707-180">Limitations</span></span>

<span data-ttu-id="38707-181">若[多個 (公用) IP 位址與負載平衡器關聯](load-balancer-multivip-overview.md)這些公用 IP 位址中的任一位址都可以是輸出流程的候選項。</span><span class="sxs-lookup"><span data-stu-id="38707-181">If [multiple (public) IP addresses are associated with a load balancer](load-balancer-multivip-overview.md), any of these public IP addresses are a candidate for outbound flows.</span></span>

<span data-ttu-id="38707-182">Azure 會使用演算法，根據集區的大小決定可用的 SNAT 連接埠數目。</span><span class="sxs-lookup"><span data-stu-id="38707-182">Azure uses an algorithm to determine the number of SNAT ports available based on the size of the pool.</span></span>  <span data-ttu-id="38707-183">目前無法進行設定。</span><span class="sxs-lookup"><span data-stu-id="38707-183">This is not configurable at this time.</span></span>

<span data-ttu-id="38707-184">請務必記住，可用的 SNAT 連接埠號碼不會直接轉譯為連線數目。</span><span class="sxs-lookup"><span data-stu-id="38707-184">It is important to rememember that the number of SNAT ports available does not translate directly to number of connections.</span></span> <span data-ttu-id="38707-185">如需何時及如何配置 SNAT 連接埠以及如何管理這個可耗盡資源的詳細資料，請參閱上述內容。</span><span class="sxs-lookup"><span data-stu-id="38707-185">Please see above for specifics on when and how SNAT ports are allocated and how to manage this exhaustible resource.</span></span>
