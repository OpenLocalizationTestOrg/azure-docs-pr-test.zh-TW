---
title: "Azure Load Balancer 的多個 VIP | Microsoft Docs"
description: "Azure Load Balancer 上多個 VIP 概觀"
services: load-balancer
documentationcenter: na
author: chkuhtz
manager: narayan
editor: 
ms.assetid: 748e50cd-3087-4c2e-a9e1-ac0ecce4f869
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/11/2016
ms.author: chkuhtz
ms.openlocfilehash: d9e88b859020be2a96a57a01e5624052ed134b64
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="multiple-vips-for-azure-load-balancer"></a><span data-ttu-id="a1994-103">Azure Load Balancer 的多個 VIP</span><span class="sxs-lookup"><span data-stu-id="a1994-103">Multiple VIPs for Azure Load Balancer</span></span>

<span data-ttu-id="a1994-104">Azure Load Balancer 可讓您平衡在多個連接埠、多個 IP 位址或兩者上的服務負載。</span><span class="sxs-lookup"><span data-stu-id="a1994-104">Azure Load Balancer allows you to load balance services on multiple ports, multiple IP addresses, or both.</span></span> <span data-ttu-id="a1994-105">您可以使用公用和內部負載平衡器定義來負載平衡一組 VM 間的流量。</span><span class="sxs-lookup"><span data-stu-id="a1994-105">You can use public and internal load balancer definitions to load balance flows across a set of VMs.</span></span>

<span data-ttu-id="a1994-106">本文說明此功能的基本運用、重要概念和限制。</span><span class="sxs-lookup"><span data-stu-id="a1994-106">This article describes the fundamentals of this ability, important concepts, and constraints.</span></span> <span data-ttu-id="a1994-107">如果您只想要公開一個 IP 位址上的服務，可以找到[公用](load-balancer-get-started-internet-portal.md)或[內部](load-balancer-get-started-ilb-arm-portal.md)負載平衡器設定的簡易指示。</span><span class="sxs-lookup"><span data-stu-id="a1994-107">If you only intend to expose services on one IP address, you can find simplified instructions for [public](load-balancer-get-started-internet-portal.md) or [internal](load-balancer-get-started-ilb-arm-portal.md) load balancer configurations.</span></span> <span data-ttu-id="a1994-108">新增多個 VIP 是對單一 VIP 設定累加設定。</span><span class="sxs-lookup"><span data-stu-id="a1994-108">Adding Multiple VIPs is incremental to a single VIP configuration.</span></span> <span data-ttu-id="a1994-109">您隨時可以使用本文中的概念擴充簡化的設定。</span><span class="sxs-lookup"><span data-stu-id="a1994-109">Using the concepts in this article, you can expand a simplified configuration at any time.</span></span>

<span data-ttu-id="a1994-110">定義 Azure Load Balancer 時，前端和後端設定會與規則連線。</span><span class="sxs-lookup"><span data-stu-id="a1994-110">When you define an Azure Load Balancer, a frontend and a backend configuration are connected with rules.</span></span> <span data-ttu-id="a1994-111">規則所參考的健全狀況探查是用來判斷新的流程如何傳送至後端集區中的節點。</span><span class="sxs-lookup"><span data-stu-id="a1994-111">The health probe referenced by the rule is used to determine how new flows are sent to a node in the backend pool.</span></span> <span data-ttu-id="a1994-112">前端是由虛擬 IP (VIP) 定義，VIP 由 3 項元素組成：IP 位址 (公用或內部)、傳輸通訊協定 (UDP 或 TCP)、連接埠號碼。</span><span class="sxs-lookup"><span data-stu-id="a1994-112">The frontend is defined by a Virtual IP (VIP), which is a 3-tuple comprised of an IP address (public or internal), a transport protocol (UDP or TCP), and a port number.</span></span> <span data-ttu-id="a1994-113">DIP 是連接到後端集區中 VM 的 Azure 虛擬 NIC 上的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="a1994-113">A DIP is an IP address on an Azure virtual NIC attached to a VM in the backend pool.</span></span>

<span data-ttu-id="a1994-114">下表是一些範例前端設定：</span><span class="sxs-lookup"><span data-stu-id="a1994-114">The following table contains some example frontend configurations:</span></span>

| <span data-ttu-id="a1994-115">VIP</span><span class="sxs-lookup"><span data-stu-id="a1994-115">VIP</span></span> | <span data-ttu-id="a1994-116">IP 位址</span><span class="sxs-lookup"><span data-stu-id="a1994-116">IP address</span></span> | <span data-ttu-id="a1994-117">protocol</span><span class="sxs-lookup"><span data-stu-id="a1994-117">protocol</span></span> | <span data-ttu-id="a1994-118">連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-118">port</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="a1994-119">1</span><span class="sxs-lookup"><span data-stu-id="a1994-119">1</span></span> |<span data-ttu-id="a1994-120">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="a1994-120">65.52.0.1</span></span> |<span data-ttu-id="a1994-121">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-121">TCP</span></span> |<span data-ttu-id="a1994-122">80</span><span class="sxs-lookup"><span data-stu-id="a1994-122">80</span></span> |
| <span data-ttu-id="a1994-123">2</span><span class="sxs-lookup"><span data-stu-id="a1994-123">2</span></span> |<span data-ttu-id="a1994-124">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="a1994-124">65.52.0.1</span></span> |<span data-ttu-id="a1994-125">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-125">TCP</span></span> |<span data-ttu-id="a1994-126">*8080*</span><span class="sxs-lookup"><span data-stu-id="a1994-126">*8080*</span></span> |
| <span data-ttu-id="a1994-127">3</span><span class="sxs-lookup"><span data-stu-id="a1994-127">3</span></span> |<span data-ttu-id="a1994-128">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="a1994-128">65.52.0.1</span></span> |<span data-ttu-id="a1994-129">*UDP*</span><span class="sxs-lookup"><span data-stu-id="a1994-129">*UDP*</span></span> |<span data-ttu-id="a1994-130">80</span><span class="sxs-lookup"><span data-stu-id="a1994-130">80</span></span> |
| <span data-ttu-id="a1994-131">4</span><span class="sxs-lookup"><span data-stu-id="a1994-131">4</span></span> |<span data-ttu-id="a1994-132">*65.52.0.2*</span><span class="sxs-lookup"><span data-stu-id="a1994-132">*65.52.0.2*</span></span> |<span data-ttu-id="a1994-133">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-133">TCP</span></span> |<span data-ttu-id="a1994-134">80</span><span class="sxs-lookup"><span data-stu-id="a1994-134">80</span></span> |

<span data-ttu-id="a1994-135">表中有四個不同的前端。</span><span class="sxs-lookup"><span data-stu-id="a1994-135">The table shows four different frontends.</span></span> <span data-ttu-id="a1994-136">#1、#2、#3 前端是具有多個規則的單一 VIP。</span><span class="sxs-lookup"><span data-stu-id="a1994-136">Frontends #1, #2 and #3 are a single VIP with multiple rules.</span></span> <span data-ttu-id="a1994-137">使用相同的 IP 位址，但每個前端的連接埠或通訊協定不同。</span><span class="sxs-lookup"><span data-stu-id="a1994-137">The same IP address is used but the port or protocol is different for each frontend.</span></span> <span data-ttu-id="a1994-138">#1、#4 前端是多 VIP 的範例，在多個 VIP 上重複使用相同的前端通訊協定和連接埠。</span><span class="sxs-lookup"><span data-stu-id="a1994-138">Frontends #1 and #4 are an example of Multiple VIPs, where the same frontend protocol and port are reused across multiple VIPs.</span></span>

<span data-ttu-id="a1994-139">Azure Load Balancer 提供定義負載平衡規則的彈性。</span><span class="sxs-lookup"><span data-stu-id="a1994-139">Azure Load Balancer provides flexibility in defining the load balancing rules.</span></span> <span data-ttu-id="a1994-140">規則宣告如何將前端上的位址和連接埠對應至後端上的目的地位址和連接埠。</span><span class="sxs-lookup"><span data-stu-id="a1994-140">A rule declares how an address and port on the frontend is mapped to the destination address and port on the backend.</span></span> <span data-ttu-id="a1994-141">不同規則是否重複使用後端連接埠，視規則的類型而定。</span><span class="sxs-lookup"><span data-stu-id="a1994-141">Whether or not backend ports are reused across rules depends on the type of the rule.</span></span> <span data-ttu-id="a1994-142">每種規則類型有特定的需求，會影響主機設定和探查設計的方式。</span><span class="sxs-lookup"><span data-stu-id="a1994-142">Each type of rule has specific requirements that can affect host configuration and probe design.</span></span> <span data-ttu-id="a1994-143">規則分為兩種：</span><span class="sxs-lookup"><span data-stu-id="a1994-143">There are two types of rules:</span></span>

1. <span data-ttu-id="a1994-144">預設規則，不會重複使用後端連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-144">The default rule with no backend port reuse</span></span>
2. <span data-ttu-id="a1994-145">浮動 IP 規則，會重複使用後端連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-145">The Floating IP rule where backend ports are reused</span></span>

<span data-ttu-id="a1994-146">Azure Load Balancer 允許您在同一負載平衡器設定上混用兩種規則類型。</span><span class="sxs-lookup"><span data-stu-id="a1994-146">Azure Load Balancer allows you to mix both rule types on the same load balancer configuration.</span></span> <span data-ttu-id="a1994-147">負載平衡器可以對指定的 VM同時使用它們，或任何組合，只要您遵守規則的限制。</span><span class="sxs-lookup"><span data-stu-id="a1994-147">The load balancer can use them simultaneously for a given VM, or any combination, as long as you abide by the constraints of the rule.</span></span> <span data-ttu-id="a1994-148">選擇的規則類型取決於您的應用程式需求以及支援該設定的複雜性。</span><span class="sxs-lookup"><span data-stu-id="a1994-148">Which rule type you choose depends on the requirements of your application and the complexity of supporting that configuration.</span></span> <span data-ttu-id="a1994-149">您應該評估何種規則類型最適合您的案例。</span><span class="sxs-lookup"><span data-stu-id="a1994-149">You should evaluate which rule types are best for your scenario.</span></span>

<span data-ttu-id="a1994-150">我們將從預設行為開始進一步探討這些案例。</span><span class="sxs-lookup"><span data-stu-id="a1994-150">We explore these scenarios further by starting with the default behavior.</span></span>

## <a name="rule-type-1-no-backend-port-reuse"></a><span data-ttu-id="a1994-151">規則類型 #1︰不重複使用後端連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-151">Rule type #1: No backend port reuse</span></span>

![MultiVIP 圖解片](./media/load-balancer-multivip-overview/load-balancer-multivip.png)

<span data-ttu-id="a1994-153">在此案例中，前端 VIP 的設定如下︰</span><span class="sxs-lookup"><span data-stu-id="a1994-153">In this scenario, the frontend VIPs are configured as follows:</span></span>

| <span data-ttu-id="a1994-154">VIP</span><span class="sxs-lookup"><span data-stu-id="a1994-154">VIP</span></span> | <span data-ttu-id="a1994-155">IP 位址</span><span class="sxs-lookup"><span data-stu-id="a1994-155">IP address</span></span> | <span data-ttu-id="a1994-156">protocol</span><span class="sxs-lookup"><span data-stu-id="a1994-156">protocol</span></span> | <span data-ttu-id="a1994-157">連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-157">port</span></span> |
| --- | --- | --- | --- |
| ![VIP](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="a1994-159">1</span><span class="sxs-lookup"><span data-stu-id="a1994-159">1</span></span> |<span data-ttu-id="a1994-160">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="a1994-160">65.52.0.1</span></span> |<span data-ttu-id="a1994-161">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-161">TCP</span></span> |<span data-ttu-id="a1994-162">80</span><span class="sxs-lookup"><span data-stu-id="a1994-162">80</span></span> |
| ![VIP](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="a1994-164">2</span><span class="sxs-lookup"><span data-stu-id="a1994-164">2</span></span> |<span data-ttu-id="a1994-165">*65.52.0.2*</span><span class="sxs-lookup"><span data-stu-id="a1994-165">*65.52.0.2*</span></span> |<span data-ttu-id="a1994-166">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-166">TCP</span></span> |<span data-ttu-id="a1994-167">80</span><span class="sxs-lookup"><span data-stu-id="a1994-167">80</span></span> |

<span data-ttu-id="a1994-168">DIP 是輸入流量的目的地。</span><span class="sxs-lookup"><span data-stu-id="a1994-168">The DIP is the destination of the inbound flow.</span></span> <span data-ttu-id="a1994-169">在後端集區中，每個 VM 會公開 DIP 上唯一連接埠上的所需服務。</span><span class="sxs-lookup"><span data-stu-id="a1994-169">In the backend pool, each VM exposes the desired service on a unique port on a DIP.</span></span> <span data-ttu-id="a1994-170">這項服務是透過規則定義與前端相關聯。</span><span class="sxs-lookup"><span data-stu-id="a1994-170">This service is associated with the frontend through a rule definition.</span></span>

<span data-ttu-id="a1994-171">我們定義兩個規則︰</span><span class="sxs-lookup"><span data-stu-id="a1994-171">We define two rules:</span></span>

| <span data-ttu-id="a1994-172">規則</span><span class="sxs-lookup"><span data-stu-id="a1994-172">Rule</span></span> | <span data-ttu-id="a1994-173">對應前端</span><span class="sxs-lookup"><span data-stu-id="a1994-173">Map frontend</span></span> | <span data-ttu-id="a1994-174">至後端集區</span><span class="sxs-lookup"><span data-stu-id="a1994-174">To backend pool</span></span> |
| --- | --- | --- |
| <span data-ttu-id="a1994-175">1</span><span class="sxs-lookup"><span data-stu-id="a1994-175">1</span></span> |![VIP](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="a1994-177">VIP1:80</span><span class="sxs-lookup"><span data-stu-id="a1994-177">VIP1:80</span></span> |![後端](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="a1994-179">DIP1:80,</span><span class="sxs-lookup"><span data-stu-id="a1994-179">DIP1:80,</span></span> ![後端](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="a1994-181">DIP2:80</span><span class="sxs-lookup"><span data-stu-id="a1994-181">DIP2:80</span></span> |
| <span data-ttu-id="a1994-182">2</span><span class="sxs-lookup"><span data-stu-id="a1994-182">2</span></span> |![VIP](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="a1994-184">VIP2:80</span><span class="sxs-lookup"><span data-stu-id="a1994-184">VIP2:80</span></span> |![後端](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="a1994-186">DIP1:81,</span><span class="sxs-lookup"><span data-stu-id="a1994-186">DIP1:81,</span></span> ![後端](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="a1994-188">DIP2:81</span><span class="sxs-lookup"><span data-stu-id="a1994-188">DIP2:81</span></span> |

<span data-ttu-id="a1994-189">現在 Azure Load Balancer 的完整對應如下︰</span><span class="sxs-lookup"><span data-stu-id="a1994-189">The complete mapping in Azure Load Balancer is now as follows:</span></span>

| <span data-ttu-id="a1994-190">規則</span><span class="sxs-lookup"><span data-stu-id="a1994-190">Rule</span></span> | <span data-ttu-id="a1994-191">VIP IP 位址</span><span class="sxs-lookup"><span data-stu-id="a1994-191">VIP IP address</span></span> | <span data-ttu-id="a1994-192">protocol</span><span class="sxs-lookup"><span data-stu-id="a1994-192">protocol</span></span> | <span data-ttu-id="a1994-193">連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-193">port</span></span> | <span data-ttu-id="a1994-194">目的地</span><span class="sxs-lookup"><span data-stu-id="a1994-194">Destination</span></span> | <span data-ttu-id="a1994-195">連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-195">port</span></span> |
| --- | --- | --- | --- | --- | --- |
| ![規則](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="a1994-197">1</span><span class="sxs-lookup"><span data-stu-id="a1994-197">1</span></span> |<span data-ttu-id="a1994-198">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="a1994-198">65.52.0.1</span></span> |<span data-ttu-id="a1994-199">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-199">TCP</span></span> |<span data-ttu-id="a1994-200">80</span><span class="sxs-lookup"><span data-stu-id="a1994-200">80</span></span> |<span data-ttu-id="a1994-201">DIP IP 位址</span><span class="sxs-lookup"><span data-stu-id="a1994-201">DIP IP Address</span></span> |<span data-ttu-id="a1994-202">80</span><span class="sxs-lookup"><span data-stu-id="a1994-202">80</span></span> |
| ![規則](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="a1994-204">2</span><span class="sxs-lookup"><span data-stu-id="a1994-204">2</span></span> |<span data-ttu-id="a1994-205">65.52.0.2</span><span class="sxs-lookup"><span data-stu-id="a1994-205">65.52.0.2</span></span> |<span data-ttu-id="a1994-206">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-206">TCP</span></span> |<span data-ttu-id="a1994-207">80</span><span class="sxs-lookup"><span data-stu-id="a1994-207">80</span></span> |<span data-ttu-id="a1994-208">DIP IP 位址</span><span class="sxs-lookup"><span data-stu-id="a1994-208">DIP IP Address</span></span> |<span data-ttu-id="a1994-209">81</span><span class="sxs-lookup"><span data-stu-id="a1994-209">81</span></span> |

<span data-ttu-id="a1994-210">每個規則都必須產生具有唯一組合 (目的地 IP 位址和目的地連接埠組合) 的流程。</span><span class="sxs-lookup"><span data-stu-id="a1994-210">Each rule must produce a flow with a unique combination of destination IP address and destination port.</span></span> <span data-ttu-id="a1994-211">改變流量的目的地連接埠，多個規則就可以將流量傳送到不同連接埠上的相同 DIP。</span><span class="sxs-lookup"><span data-stu-id="a1994-211">By varying the destination port of the flow, multiple rules can deliver flows to the same DIP on different ports.</span></span>

<span data-ttu-id="a1994-212">健全狀況探查一律會被導向 VM 的 DIP。</span><span class="sxs-lookup"><span data-stu-id="a1994-212">Health probes are always directed to the DIP of a VM.</span></span> <span data-ttu-id="a1994-213">您必須確定您的探查會反映 VM 的健全狀況。</span><span class="sxs-lookup"><span data-stu-id="a1994-213">You must ensure you that your probe reflects the health of the VM.</span></span>

## <a name="rule-type-2-backend-port-reuse-by-using-floating-ip"></a><span data-ttu-id="a1994-214">規則類型 #2︰使用浮動 IP 來重複使用後端連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-214">Rule type #2: backend port reuse by using Floating IP</span></span>

<span data-ttu-id="a1994-215">Azure Load Balancer 提供在多個 VIP 重複使用前端連接埠的彈性，不論使用何種規則類型。</span><span class="sxs-lookup"><span data-stu-id="a1994-215">Azure Load Balancer provides the flexibility to reuse the frontend port across multiple VIPs regardless of the rule type used.</span></span> <span data-ttu-id="a1994-216">此外，在某些應用程式案例中，後端集區中單一 VM 上的多個應用程式執行個體偏好或必須使用相同連接埠。</span><span class="sxs-lookup"><span data-stu-id="a1994-216">Additionally, some application scenarios prefer or require the same port to be used by multiple application instances on a single VM in the backend pool.</span></span> <span data-ttu-id="a1994-217">連接埠重複使用的常見範例包括提供高可用性的叢集、網路虛擬裝置、公開多個不會重新加密的 TLS 端點。</span><span class="sxs-lookup"><span data-stu-id="a1994-217">Common examples of port reuse include clustering for high availability, network virtual appliances, and exposing multiple TLS endpoints without re-encryption.</span></span>

<span data-ttu-id="a1994-218">如果您想要在多個規則重複使用後端連接埠，必須啟用規則定義中的浮動 IP。</span><span class="sxs-lookup"><span data-stu-id="a1994-218">If you want to reuse the backend port across multiple rules, you must enable Floating IP in the rule definition.</span></span>

<span data-ttu-id="a1994-219">浮動 IP 是伺服器直接回傳 (DSR) 的一部分。</span><span class="sxs-lookup"><span data-stu-id="a1994-219">Floating IP is a portion of what is known as Direct Server Return (DSR).</span></span> <span data-ttu-id="a1994-220">DSR 包含兩個部分︰流程拓樸和 IP 位址對應配置。</span><span class="sxs-lookup"><span data-stu-id="a1994-220">DSR consists of two parts: a flow topology and an IP address mapping scheme.</span></span> <span data-ttu-id="a1994-221">在平台層級，Azure Load Balancer 一律在 DSR 流程拓撲中運作，無論是否已啟用浮動 IP。</span><span class="sxs-lookup"><span data-stu-id="a1994-221">At a platform level, Azure Load Balancer always operates in a DSR flow topology regardless of whether Floating IP is enabled or not.</span></span> <span data-ttu-id="a1994-222">這表示流程的輸出部分一律會正確重寫為直接流回原始來源。</span><span class="sxs-lookup"><span data-stu-id="a1994-222">This means that the outbound part of a flow is always correctly rewritten to flow directly back to the origin.</span></span>

<span data-ttu-id="a1994-223">使用預設規則類型時，Azure 會公開傳統負載平衡 IP 位址對應配置以利使用的方便性。</span><span class="sxs-lookup"><span data-stu-id="a1994-223">With the default rule type, Azure exposes a traditional load balancing IP address mapping scheme for ease of use.</span></span> <span data-ttu-id="a1994-224">啟用浮動 IP 會變更 IP 位址對應配置，以提供更大的彈性，解釋如下。</span><span class="sxs-lookup"><span data-stu-id="a1994-224">Enabling Floating IP changes the IP address mapping scheme to allow for additional flexibility as explained below.</span></span>

<span data-ttu-id="a1994-225">下圖說明此設定：</span><span class="sxs-lookup"><span data-stu-id="a1994-225">The following diagram illustrates this configuration:</span></span>

![MultiVIP 圖解片](./media/load-balancer-multivip-overview/load-balancer-multivip-dsr.png)

<span data-ttu-id="a1994-227">此案例中，後端集區中的每個 VM 有三個網路介面︰</span><span class="sxs-lookup"><span data-stu-id="a1994-227">For this scenario, every VM in the backend pool has three network interfaces:</span></span>

* <span data-ttu-id="a1994-228">DIP：與 VM 相關聯的虛擬 NIC (Azure NIC 資源的 IP 組態)</span><span class="sxs-lookup"><span data-stu-id="a1994-228">DIP: a Virtual NIC associated with the VM (IP configuration of Azure's NIC resource)</span></span>
* <span data-ttu-id="a1994-229">VIP1︰客體 OS 內的回送介面 (此 OS 已設定了 VIP1 的 IP 位址)</span><span class="sxs-lookup"><span data-stu-id="a1994-229">VIP1: a loopback interface within guest OS that is configured with IP address of VIP1</span></span>
* <span data-ttu-id="a1994-230">VIP2︰客體 OS 內的回送介面 (此 OS 已設定了 VIP2 的 IP 位址)</span><span class="sxs-lookup"><span data-stu-id="a1994-230">VIP2: a loopback interface within guest OS that is configured with IP address of VIP2</span></span>

> [!IMPORTANT]
> <span data-ttu-id="a1994-231">邏輯介面的設定是在客體 OS 內進行。</span><span class="sxs-lookup"><span data-stu-id="a1994-231">The configuration of the logical interfaces is performed within the guest OS.</span></span> <span data-ttu-id="a1994-232">這項設定不是由 Azure 執行或管理。</span><span class="sxs-lookup"><span data-stu-id="a1994-232">This configuration is not performed or managed by Azure.</span></span> <span data-ttu-id="a1994-233">沒有此設定，規則將無法運作。</span><span class="sxs-lookup"><span data-stu-id="a1994-233">Without this configuration, the rules will not function.</span></span> <span data-ttu-id="a1994-234">健全狀況探查定義使用 VM 的 DIP，而不是邏輯 VIP。</span><span class="sxs-lookup"><span data-stu-id="a1994-234">Health probe definitions use the DIP of the VM rather than the logical VIP.</span></span> <span data-ttu-id="a1994-235">因此，您的服務必須提供 DIP 連接埠的探查回應，以反映邏輯 VIP 上提供之服務的狀態。</span><span class="sxs-lookup"><span data-stu-id="a1994-235">Therefore, your service must provide probe responses on a DIP port that reflect the status of the service offered on the logical VIP.</span></span>

<span data-ttu-id="a1994-236">讓我們假設前一個案例的相同前端組態︰</span><span class="sxs-lookup"><span data-stu-id="a1994-236">Let's assume the same frontend configuration as in the previous scenario:</span></span>

| <span data-ttu-id="a1994-237">VIP</span><span class="sxs-lookup"><span data-stu-id="a1994-237">VIP</span></span> | <span data-ttu-id="a1994-238">IP 位址</span><span class="sxs-lookup"><span data-stu-id="a1994-238">IP address</span></span> | <span data-ttu-id="a1994-239">protocol</span><span class="sxs-lookup"><span data-stu-id="a1994-239">protocol</span></span> | <span data-ttu-id="a1994-240">連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-240">port</span></span> |
| --- | --- | --- | --- |
| ![VIP](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="a1994-242">1</span><span class="sxs-lookup"><span data-stu-id="a1994-242">1</span></span> |<span data-ttu-id="a1994-243">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="a1994-243">65.52.0.1</span></span> |<span data-ttu-id="a1994-244">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-244">TCP</span></span> |<span data-ttu-id="a1994-245">80</span><span class="sxs-lookup"><span data-stu-id="a1994-245">80</span></span> |
| ![VIP](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="a1994-247">2</span><span class="sxs-lookup"><span data-stu-id="a1994-247">2</span></span> |<span data-ttu-id="a1994-248">*65.52.0.2*</span><span class="sxs-lookup"><span data-stu-id="a1994-248">*65.52.0.2*</span></span> |<span data-ttu-id="a1994-249">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-249">TCP</span></span> |<span data-ttu-id="a1994-250">80</span><span class="sxs-lookup"><span data-stu-id="a1994-250">80</span></span> |

<span data-ttu-id="a1994-251">我們定義兩個規則︰</span><span class="sxs-lookup"><span data-stu-id="a1994-251">We define two rules:</span></span>

| <span data-ttu-id="a1994-252">規則</span><span class="sxs-lookup"><span data-stu-id="a1994-252">Rule</span></span> | <span data-ttu-id="a1994-253">對應前端</span><span class="sxs-lookup"><span data-stu-id="a1994-253">Map frontend</span></span> | <span data-ttu-id="a1994-254">至後端集區</span><span class="sxs-lookup"><span data-stu-id="a1994-254">To backend pool</span></span> |
| --- | --- | --- |
| <span data-ttu-id="a1994-255">1</span><span class="sxs-lookup"><span data-stu-id="a1994-255">1</span></span> |![規則](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="a1994-257">VIP1:80</span><span class="sxs-lookup"><span data-stu-id="a1994-257">VIP1:80</span></span> |![後端](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="a1994-259">VIP1:80 (在 VM1 和 VM2)</span><span class="sxs-lookup"><span data-stu-id="a1994-259">VIP1:80 (in VM1 and VM2)</span></span> |
| <span data-ttu-id="a1994-260">2</span><span class="sxs-lookup"><span data-stu-id="a1994-260">2</span></span> |![規則](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="a1994-262">VIP2:80</span><span class="sxs-lookup"><span data-stu-id="a1994-262">VIP2:80</span></span> |![後端](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="a1994-264">VIP2:80 (在 VM1 和 VM2)</span><span class="sxs-lookup"><span data-stu-id="a1994-264">VIP2:80 (in VM1 and VM2)</span></span> |

<span data-ttu-id="a1994-265">下表顯示負載平衡器的完整對應︰</span><span class="sxs-lookup"><span data-stu-id="a1994-265">The following table shows the complete mapping in the load balancer:</span></span>

| <span data-ttu-id="a1994-266">規則</span><span class="sxs-lookup"><span data-stu-id="a1994-266">Rule</span></span> | <span data-ttu-id="a1994-267">VIP IP 位址</span><span class="sxs-lookup"><span data-stu-id="a1994-267">VIP IP address</span></span> | <span data-ttu-id="a1994-268">protocol</span><span class="sxs-lookup"><span data-stu-id="a1994-268">protocol</span></span> | <span data-ttu-id="a1994-269">連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-269">port</span></span> | <span data-ttu-id="a1994-270">目的地</span><span class="sxs-lookup"><span data-stu-id="a1994-270">Destination</span></span> | <span data-ttu-id="a1994-271">連接埠</span><span class="sxs-lookup"><span data-stu-id="a1994-271">port</span></span> |
| --- | --- | --- | --- | --- | --- |
| ![VIP](./media/load-balancer-multivip-overview/load-balancer-rule-green.png) <span data-ttu-id="a1994-273">1</span><span class="sxs-lookup"><span data-stu-id="a1994-273">1</span></span> |<span data-ttu-id="a1994-274">65.52.0.1</span><span class="sxs-lookup"><span data-stu-id="a1994-274">65.52.0.1</span></span> |<span data-ttu-id="a1994-275">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-275">TCP</span></span> |<span data-ttu-id="a1994-276">80</span><span class="sxs-lookup"><span data-stu-id="a1994-276">80</span></span> |<span data-ttu-id="a1994-277">與 VIP 相同 (65.52.0.1)</span><span class="sxs-lookup"><span data-stu-id="a1994-277">same as VIP (65.52.0.1)</span></span> |<span data-ttu-id="a1994-278">與 VIP 相同 (80)</span><span class="sxs-lookup"><span data-stu-id="a1994-278">same as VIP (80)</span></span> |
| ![VIP](./media/load-balancer-multivip-overview/load-balancer-rule-purple.png) <span data-ttu-id="a1994-280">2</span><span class="sxs-lookup"><span data-stu-id="a1994-280">2</span></span> |<span data-ttu-id="a1994-281">65.52.0.2</span><span class="sxs-lookup"><span data-stu-id="a1994-281">65.52.0.2</span></span> |<span data-ttu-id="a1994-282">TCP</span><span class="sxs-lookup"><span data-stu-id="a1994-282">TCP</span></span> |<span data-ttu-id="a1994-283">80</span><span class="sxs-lookup"><span data-stu-id="a1994-283">80</span></span> |<span data-ttu-id="a1994-284">與 VIP 相同 (65.52.0.2)</span><span class="sxs-lookup"><span data-stu-id="a1994-284">same as VIP (65.52.0.2)</span></span> |<span data-ttu-id="a1994-285">與 VIP 相同 (80)</span><span class="sxs-lookup"><span data-stu-id="a1994-285">same as VIP (80)</span></span> |

<span data-ttu-id="a1994-286">輸入流量的目的地是在 VM 中回送介面上的 VIP 位址。</span><span class="sxs-lookup"><span data-stu-id="a1994-286">The destination of the inbound flow is the VIP address on the loopback interface in the VM.</span></span> <span data-ttu-id="a1994-287">每個規則都必須產生具有唯一組合 (目的地 IP 位址和目的地連接埠組合) 的流程。</span><span class="sxs-lookup"><span data-stu-id="a1994-287">Each rule must produce a flow with a unique combination of destination IP address and destination port.</span></span> <span data-ttu-id="a1994-288">改變流量的目的地 IP 位址，就有可能在相同 VM 上重複使用連接埠。</span><span class="sxs-lookup"><span data-stu-id="a1994-288">By varying the destination IP address of the flow, port reuse is possible on the same VM.</span></span> <span data-ttu-id="a1994-289">將您的服務繫結至 VIP 的 IP 位址和個別回送介面的連接埠，即可會向負載平衡器公開服務。</span><span class="sxs-lookup"><span data-stu-id="a1994-289">Your service is exposed to the load balancer by binding it to the VIP’s IP address and port of the respective loopback interface.</span></span>

<span data-ttu-id="a1994-290">請注意，此範例沒有變更目的地連接埠。</span><span class="sxs-lookup"><span data-stu-id="a1994-290">Notice that this example does not change the destination port.</span></span> <span data-ttu-id="a1994-291">雖然這是浮動 IP 案例，Azure Load Balancer 也支援定義規則來重寫後端的目的地連接埠，使其和前端的目的地連接埠不同。</span><span class="sxs-lookup"><span data-stu-id="a1994-291">Even though this is a Floating IP scenario, Azure Load Balancer also supports defining a rule to rewrite the backend destination port and to make it different from the frontend destination port.</span></span>

<span data-ttu-id="a1994-292">浮動 IP 規則類型是數種負載平衡器設定模式的基礎。</span><span class="sxs-lookup"><span data-stu-id="a1994-292">The Floating IP rule type is the foundation of several load balancer configuration patterns.</span></span> <span data-ttu-id="a1994-293">[具有多個接聽程式的 SQL AlwaysOn](../virtual-machines/windows/sql/virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md) 設定是目前可看到其運用的範例。</span><span class="sxs-lookup"><span data-stu-id="a1994-293">One example that is currently available is the [SQL AlwaysOn with Multiple Listeners](../virtual-machines/windows/sql/virtual-machines-windows-portal-sql-ps-alwayson-int-listener.md) configuration.</span></span> <span data-ttu-id="a1994-294">經過一段時間，我們會記載更多這類案例。</span><span class="sxs-lookup"><span data-stu-id="a1994-294">Over time, we will document more of these scenarios.</span></span>

## <a name="limitations"></a><span data-ttu-id="a1994-295">限制</span><span class="sxs-lookup"><span data-stu-id="a1994-295">Limitations</span></span>

* <span data-ttu-id="a1994-296">只有 IaaS VM 支援多個 VIP 設定。</span><span class="sxs-lookup"><span data-stu-id="a1994-296">Multiple VIP configurations are only supported with IaaS VMs.</span></span>
* <span data-ttu-id="a1994-297">若使用浮點 IP 規則，您的應用程式必須使用 DIP 輸出流量。</span><span class="sxs-lookup"><span data-stu-id="a1994-297">With the Floating IP rule, your application must use the DIP for outbound flows.</span></span> <span data-ttu-id="a1994-298">如果您的應用程式繫結至客體 OS 中回送介面上設定的 VIP 位址，就無法使用 SNAT 來重寫輸出流量，流程就會失敗。</span><span class="sxs-lookup"><span data-stu-id="a1994-298">If your application binds to the VIP address configured on the loopback interface in the guest OS, then SNAT is not available to rewrite the outbound flow and the flow fails.</span></span>
* <span data-ttu-id="a1994-299">公用 IP 位址需要費用。</span><span class="sxs-lookup"><span data-stu-id="a1994-299">Public IP addresses have an effect on billing.</span></span> <span data-ttu-id="a1994-300">如需詳細資訊，請參閱 [IP 位址定價](https://azure.microsoft.com/pricing/details/ip-addresses/)</span><span class="sxs-lookup"><span data-stu-id="a1994-300">For more information, see [IP Address pricing](https://azure.microsoft.com/pricing/details/ip-addresses/)</span></span>
* <span data-ttu-id="a1994-301">訂用帳戶有其限制。</span><span class="sxs-lookup"><span data-stu-id="a1994-301">Subscription limits apply.</span></span> <span data-ttu-id="a1994-302">如需詳細資訊，請參閱 [服務限制](../azure-subscription-service-limits.md#networking-limits) 的說明。</span><span class="sxs-lookup"><span data-stu-id="a1994-302">For more information, see [Service limits](../azure-subscription-service-limits.md#networking-limits) for details.</span></span>
