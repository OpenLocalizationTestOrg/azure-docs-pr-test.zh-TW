---
title: "最佳化 ExpressRoute 路由：Azure | Microsoft Docs"
description: "此頁面提供有關如何 toooptimize 路由，當您有多個 ExpressRoute 電路的連接 Microsoft 和您的公司網路。"
documentationcenter: na
services: expressroute
author: charwen
manager: carmonm
editor: 
ms.assetid: fca53249-d9c3-4cff-8916-f8749386a4dd
ms.service: expressroute
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 04/06/2017
ms.author: charwen
ms.openlocfilehash: ebcfb638f67a9ac78c3e476668bfd0bb0ffb9985
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="optimize-expressroute-routing"></a><span data-ttu-id="a8d8d-103">最佳化 ExpressRoute 路由</span><span class="sxs-lookup"><span data-stu-id="a8d8d-103">Optimize ExpressRoute Routing</span></span>
<span data-ttu-id="a8d8d-104">當您有多個 ExpressRoute 電路時，您會有一個以上的路徑 tooconnect tooMicrosoft。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-104">When you have multiple ExpressRoute circuits, you have more than one path tooconnect tooMicrosoft.</span></span> <span data-ttu-id="a8d8d-105">如此一來，次佳的路由可能會發生-也就是您的流量可能需要較長的路徑 tooreach Microsoft 和 Microsoft tooyour 網路。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-105">As a result, suboptimal routing may happen - that is, your traffic may take a longer path tooreach Microsoft, and Microsoft tooyour network.</span></span> <span data-ttu-id="a8d8d-106">hello 長 hello 網路路徑，hello 較高的 hello 延遲。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-106">hello longer hello network path, hello higher hello latency.</span></span> <span data-ttu-id="a8d8d-107">延遲對於應用程式效能和使用者體驗有直接的影響。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-107">Latency has direct impact on application performance and user experience.</span></span> <span data-ttu-id="a8d8d-108">這篇文章會說明這個問題，並說明如何使用路由 toooptimize hello 標準路由技術。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-108">This article will illustrate this problem and explain how toooptimize routing using hello standard routing technologies.</span></span>

## <a name="suboptimal-routing-from-customer-toomicrosoft"></a><span data-ttu-id="a8d8d-109">次佳的客戶 tooMicrosoft 從路由</span><span class="sxs-lookup"><span data-stu-id="a8d8d-109">Suboptimal routing from customer tooMicrosoft</span></span>
<span data-ttu-id="a8d8d-110">讓我們仔細查看 hello 路由問題所範例。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-110">Let's take a close look at hello routing problem by an example.</span></span> <span data-ttu-id="a8d8d-111">假設您有兩個 hello 美國，一部位於洛杉磯，另一個在紐約辦公室。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-111">Imagine you have two offices in hello US, one in Los Angeles and one in New York.</span></span> <span data-ttu-id="a8d8d-112">您的辦公室是在廣域網路 (WAN) 上連線，該網路可以是您自己的骨幹網路或服務提供者的 IP VPN。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-112">Your offices are connected on a Wide Area Network (WAN), which can be either your own backbone network or your service provider's IP VPN.</span></span> <span data-ttu-id="a8d8d-113">您有兩個 ExpressRoute 電路，分別位於美國西部和美國東部 hello WAN 上也連接。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-113">You have two ExpressRoute circuits, one in US West and one in US East, that are also connected on hello WAN.</span></span> <span data-ttu-id="a8d8d-114">很明顯地，您有兩個路徑 tooconnect toohello Microsoft 網路。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-114">Obviously, you have two paths tooconnect toohello Microsoft network.</span></span> <span data-ttu-id="a8d8d-115">現在假設您在美國西部和美國東部均有 Azure 部署 (例如 Azure App Service)。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-115">Now imagine you have Azure deployment (for example, Azure App Service) in both US West and US East.</span></span> <span data-ttu-id="a8d8d-116">您的意圖是 tooconnect Los Angeles tooAzure 美國西部使用者和使用者在紐約 tooAzure 美國東部中的因為您的服務系統管理員會通告每個 office access 中 hello 附近的最佳體驗的 Azure 服務。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-116">Your intention is tooconnect your users in Los Angeles tooAzure US West and your users in New York tooAzure US East because your service admin advertises that users in each office access hello nearby Azure services for optimal experiences.</span></span> <span data-ttu-id="a8d8d-117">不幸的是，hello 計劃適用於用於 hello 東部 coast 使用者，但不適用於 hello 西岸使用者。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-117">Unfortunately, hello plan works out well for hello east coast users but not for hello west coast users.</span></span> <span data-ttu-id="a8d8d-118">hello hello 問題原因是下列 hello。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-118">hello cause of hello problem is hello following.</span></span> <span data-ttu-id="a8d8d-119">在每個 ExpressRoute 電路，我們會通告 tooyou Azure 美國東部 (23.100.0.0/16) 中的 hello 前置詞和 Azure 美國西部 (13.100.0.0/16) 中的 hello 前置詞都。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-119">On each ExpressRoute circuit, we advertise tooyou both hello prefix in Azure US East (23.100.0.0/16) and hello prefix in Azure US West (13.100.0.0/16).</span></span> <span data-ttu-id="a8d8d-120">如果您不知道的前置詞是從哪一個區域，您不能 tootreat 它以不同的方式。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-120">If you don't know which prefix is from which region, you are not able tootreat it differently.</span></span> <span data-ttu-id="a8d8d-121">您的 WAN 網路可能會認為這兩個 hello 前置詞是美國西部比接近 tooUS 東部而且因此美國東部路由這兩種 office 使用者 toohello ExpressRoute 電路。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-121">Your WAN network may think both of hello prefixes are closer tooUS East than US West and therefore route both office users toohello ExpressRoute circuit in US East.</span></span> <span data-ttu-id="a8d8d-122">Hello 結束時，您必須在 hello 洛杉磯分公司中的許多不滿意使用者。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-122">In hello end, you will have many unhappy users in hello Los Angeles office.</span></span>

![ExpressRoute 案例 1 問題-次佳的客戶 tooMicrosoft 從路由](./media/expressroute-optimize-routing/expressroute-case1-problem.png)

### <a name="solution-use-bgp-communities"></a><span data-ttu-id="a8d8d-124">解決方法︰使用 BGP 社群</span><span class="sxs-lookup"><span data-stu-id="a8d8d-124">Solution: use BGP Communities</span></span>
<span data-ttu-id="a8d8d-125">toooptimize 路由傳送給這兩個辦公室的使用者，您需要的前置詞會從 Azure 美國西部和取自 Azure 美國東部 tooknow。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-125">toooptimize routing for both office users, you need tooknow which prefix is from Azure US West and which from Azure US East.</span></span> <span data-ttu-id="a8d8d-126">我們使用 [BGP 社群值](expressroute-routing.md)來編碼這項資訊。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-126">We encode this information by using [BGP Community values](expressroute-routing.md).</span></span> <span data-ttu-id="a8d8d-127">我們已指派唯一的 BGP 社群值 tooeach Azure 地區，例如："12076:51004" 適用於美國東部，"12076:51006" 適用於美國西部。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-127">We've assigned a unique BGP Community value tooeach Azure region, e.g. "12076:51004" for US East, "12076:51006" for US West.</span></span> <span data-ttu-id="a8d8d-128">您現在知道哪個前置詞來自哪個 Azure 區域，即可設定應優先使用哪個 ExpressRoute 線路。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-128">Now that you know which prefix is from which Azure region, you can configure which ExpressRoute circuit should be preferred.</span></span> <span data-ttu-id="a8d8d-129">因為我們使用 hello BGP tooexchange 路由資訊時，您可以使用 BGP 的本機喜好設定 tooinfluence 路由。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-129">Because we use hello BGP tooexchange routing info, you can use BGP's Local Preference tooinfluence routing.</span></span> <span data-ttu-id="a8d8d-130">在本例中，您可以指定本機喜好設定值 too13.100.0.0/16 中比在美國東部、 美國西部和同樣地，本機喜好設定值 too23.100.0.0/16 比位於美國西部的美國東部。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-130">In our example, you can assign a higher local preference value too13.100.0.0/16 in US West than in US East, and similarly, a higher local preference value too23.100.0.0/16 in US East than in US West.</span></span> <span data-ttu-id="a8d8d-131">此設定可確保，這兩個路徑 tooMicrosoft 可用時，您的使用者在洛杉磯會接受在美國西部 tooconnect tooAzure 美國西部 hello ExpressRoute 電路而紐約使用者接受 hello ExpressRoute 在美國東部 tooAzure 美國東部.</span><span class="sxs-lookup"><span data-stu-id="a8d8d-131">This configuration will make sure that, when both paths tooMicrosoft are available, your users in Los Angeles will take hello ExpressRoute circuit in US West tooconnect tooAzure US West whereas your users in New York take hello ExpressRoute in US East tooAzure US East.</span></span> <span data-ttu-id="a8d8d-132">這兩端的路由均已最佳化。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-132">Routing is optimized on both sides.</span></span> 

![ExpressRoute 案例 1 解決方案 - 使用 BGP 社群](./media/expressroute-optimize-routing/expressroute-case1-solution.png)

> [!NOTE]
> <span data-ttu-id="a8d8d-134">hello 相同的技巧，使用本機的喜好設定，可以套用的 toorouting 從客戶 tooAzure 虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-134">hello same technique, using Local Preference, can be applied toorouting from customer tooAzure Virtual Network.</span></span> <span data-ttu-id="a8d8d-135">我們不標記已從 Azure tooyour 網路公告的 BGP 社群值 toohello 前置詞。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-135">We don't tag BGP Community value toohello prefixes advertised from Azure tooyour network.</span></span> <span data-ttu-id="a8d8d-136">不過，因為您知道哪一個虛擬網路部署的關閉 toowhich 的辦公室，您可以設定您的路由器據以 tooprefer 一個 ExpressRoute 電路 tooanother。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-136">However, since you know which of your Virtual Network deployment is close toowhich of your office, you can configure your routers accordingly tooprefer one ExpressRoute circuit tooanother.</span></span>
>
>

## <a name="suboptimal-routing-from-microsoft-toocustomer"></a><span data-ttu-id="a8d8d-137">次佳路由從 Microsoft toocustomer</span><span class="sxs-lookup"><span data-stu-id="a8d8d-137">Suboptimal routing from Microsoft toocustomer</span></span>
<span data-ttu-id="a8d8d-138">以下是另一個範例中，從 Microsoft 的連線會使用較長的路徑 tooreach 您的網路。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-138">Here is another example where connections from Microsoft take a longer path tooreach your network.</span></span> <span data-ttu-id="a8d8d-139">在此情況下，您可在 [混合式環境](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx)中使用內部部署 Exchange 伺服器和 Exchange Online。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-139">In this case, you use on-premises Exchange servers and Exchange Online in a [hybrid environment](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span></span> <span data-ttu-id="a8d8d-140">您的辦公室可連接的 tooa WAN。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-140">Your offices are connected tooa WAN.</span></span> <span data-ttu-id="a8d8d-141">您會通告內部部署伺服器中的 hello 兩個 ExpressRoute 電路透過您的辦公室 tooMicrosoft hello 前置詞。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-141">You advertise hello prefixes of your on-premises servers in both of your offices tooMicrosoft through hello two ExpressRoute circuits.</span></span> <span data-ttu-id="a8d8d-142">Exchange Online 將會起始連線 toohello 在內部部署伺服器，例如信箱移轉的情況下。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-142">Exchange Online will initiate connections toohello on-premises servers in cases such as mailbox migration.</span></span> <span data-ttu-id="a8d8d-143">很遺憾，hello 連接 tooyour 洛杉磯分公司路由的 toohello 美國東部的 ExpressRoute 電路之前周遊整個 continent 後 toohello 西岸 hello。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-143">Unfortunately, hello connection tooyour Los Angeles office is routed toohello ExpressRoute circuit in US East before traversing hello entire continent back toohello west coast.</span></span> <span data-ttu-id="a8d8d-144">hello hello 問題的原因是類似 toohello 第一個。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-144">hello cause of hello problem is similar toohello first one.</span></span> <span data-ttu-id="a8d8d-145">沒有任何提示，hello Microsoft 網路無法分辨哪些客戶前置詞是關閉的 tooUS 東部和哪一種關閉 tooUS 西。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-145">Without any hint, hello Microsoft network can't tell which customer prefix is close tooUS East and which one is close tooUS West.</span></span> <span data-ttu-id="a8d8d-146">發生在洛杉磯 toopick hello 錯誤的路徑 tooyour office。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-146">It happens toopick hello wrong path tooyour office in Los Angeles.</span></span>

![ExpressRoute 案例 2 的次佳路由從 Microsoft toocustomer](./media/expressroute-optimize-routing/expressroute-case2-problem.png)

### <a name="solution-use-as-path-prepending"></a><span data-ttu-id="a8d8d-148">解決方案︰使用 AS PATH 前置</span><span class="sxs-lookup"><span data-stu-id="a8d8d-148">Solution: use AS PATH prepending</span></span>
<span data-ttu-id="a8d8d-149">有兩個方案 toohello 問題。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-149">There are two solutions toohello problem.</span></span> <span data-ttu-id="a8d8d-150">hello 第一次是只要通告內部首碼 Los Angeles 辦公室 177.2.0.0/31，hello ExpressRoute 電路位於美國西部上，並在內部紐約辦公室 177.2.0.2/31，在美國東部 hello ExpressRoute 電路的前置詞。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-150">hello first one is that you simply advertise your on-premises prefix for your Los Angeles office, 177.2.0.0/31, on hello ExpressRoute circuit in US West and your on-premises prefix for your New York office, 177.2.0.2/31, on hello ExpressRoute circuit in US East.</span></span> <span data-ttu-id="a8d8d-151">如此一來，是您分公司的 Microsoft tooconnect tooeach 只能有一個路徑。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-151">As a result, there is only one path for Microsoft tooconnect tooeach of your offices.</span></span> <span data-ttu-id="a8d8d-152">沒有模稜兩可的狀況，而且路由已最佳化。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-152">There is no ambiguity and routing is optimized.</span></span> <span data-ttu-id="a8d8d-153">與這個設計中，您會需要 toothink 有關容錯移轉策略。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-153">With this design, you need toothink about your failover strategy.</span></span> <span data-ttu-id="a8d8d-154">Hello hello 路徑 tooMicrosoft 透過 ExpressRoute 的事件已中斷，您需要 toomake 確定 Exchange Online 可以仍然連接 tooyour 在內部部署伺服器。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-154">In hello event that hello path tooMicrosoft via ExpressRoute is broken, you need toomake sure that Exchange Online can still connect tooyour on-premises servers.</span></span> 

<span data-ttu-id="a8d8d-155">hello 第二個方案是您繼續這兩個 ExpressRoute 電路的 hello 首碼 tooadvertise，除了您提供的前置詞是您分公司的關閉 toowhich 的提示。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-155">hello second solution is that you continue tooadvertise both of hello prefixes on both ExpressRoute circuits, and in addition you give us a hint of which prefix is close toowhich one of your offices.</span></span> <span data-ttu-id="a8d8d-156">因為我們支援 BGP AS 路徑前面加上，您可以設定 hello AS 路徑前置詞 tooinfluence 器路由工具。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-156">Because we support BGP AS Path prepending, you can configure hello AS Path for your prefix tooinfluence routing.</span></span> <span data-ttu-id="a8d8d-157">在此範例中，您可以延長為美國東部 172.2.0.0/31 hello AS 路徑，讓我們會偏好 hello ExpressRoute 電路位於美國西部的流量 （如網路會認為 hello 路徑 toothis 前置詞是短 hello 西） 針對此前置詞。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-157">In this example, you can lengthen hello AS PATH for 172.2.0.0/31 in US East so that we will prefer hello ExpressRoute circuit in US West for traffic destined for this prefix (as our network will think hello path toothis prefix is shorter in hello west).</span></span> <span data-ttu-id="a8d8d-158">同樣地您會增加 172.2.0.2/31 位於美國西部的 hello AS 路徑，讓我們將會偏好在美國東部 hello ExpressRoute 電路。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-158">Similarly you can lengthen hello AS PATH for 172.2.0.2/31 in US West so that we'll prefer hello ExpressRoute circuit in US East.</span></span> <span data-ttu-id="a8d8d-159">這兩個辦公室的路由均已最佳化。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-159">Routing is optimized for both offices.</span></span> <span data-ttu-id="a8d8d-160">採用這個設計，如果一個 ExpressRoute 路線已中斷，Exchange Online 仍可透過另一個 ExpressRoute 線路和您的 WAN 來觸達您。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-160">With this design, if one ExpressRoute circuit is broken, Exchange Online can still reach you via another ExpressRoute circuit and your WAN.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="a8d8d-161">我們移除私用，因為 Microsoft 對等互連收到 hello 前置詞的 hello AS 路徑中的數字。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-161">We remove private AS numbers in hello AS PATH for hello prefixes received on Microsoft Peering.</span></span> <span data-ttu-id="a8d8d-162">您需要 tooappend 公用 AS 號碼 hello AS 路徑 tooinfluence 路由傳送中的 Microsoft 對等互連。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-162">You need tooappend public AS numbers in hello AS PATH tooinfluence routing for Microsoft Peering.</span></span>
> 
> 

![ExpressRoute 案例 2 解決方案 - 使用 AS PATH 前置](./media/expressroute-optimize-routing/expressroute-case2-solution.png)

> [!NOTE]
> <span data-ttu-id="a8d8d-164">雖然此處指定的 hello 範例之 Microsoft 軟體和公用對等互連，我們支援 hello hello 私用對等互連的相同功能。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-164">While hello examples given here are for Microsoft and Public peerings, we do support hello same capabilities for hello Private peering.</span></span> <span data-ttu-id="a8d8d-165">此外，hello AS 路徑前面加上在中運作單一 ExpressRoute 電路，tooinfluence hello hello 主要和次要路徑的選取項目。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-165">Also, hello AS Path prepending works within one single ExpressRoute circuit, tooinfluence hello selection of hello primary and secondary paths.</span></span>
> 
> 

## <a name="suboptimal-routing-between-virtual-networks"></a><span data-ttu-id="a8d8d-166">虛擬網路之間的次佳化路由</span><span class="sxs-lookup"><span data-stu-id="a8d8d-166">Suboptimal routing between virtual networks</span></span>
<span data-ttu-id="a8d8d-167">透過 ExpressRoute，您可以啟用虛擬網路 tooVirtual 網路 （也稱為 「 VNet 」） 將它們連結 tooan ExpressRoute 電路的通訊。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-167">With ExpressRoute, you can enable Virtual Network tooVirtual Network (which is also known as "VNet") communication by linking them tooan ExpressRoute circuit.</span></span> <span data-ttu-id="a8d8d-168">當您連結它們 toomultiple ExpressRoute 電路時，次佳的路由可能會發生 hello Vnet 之間。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-168">When you link them toomultiple ExpressRoute circuits, suboptimal routing can happen between hello VNets.</span></span> <span data-ttu-id="a8d8d-169">我們來看一個範例。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-169">Let's consider an example.</span></span> <span data-ttu-id="a8d8d-170">您有兩個 ExpressRoute 線路，一個在美國西部，一個在美國東部。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-170">You have two ExpressRoute circuits, one in US West and one in US East.</span></span> <span data-ttu-id="a8d8d-171">而在這兩個區域中，您各有兩個 VNet。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-171">In each region, you have two VNets.</span></span> <span data-ttu-id="a8d8d-172">一個 VNet 中部署您的 web 伺服器，並在應用程式伺服器 hello 其他。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-172">Your web servers are deployed in one VNet and application servers in hello other.</span></span> <span data-ttu-id="a8d8d-173">如需備援，您連結 hello 的每個區域 tooboth hello 本機 ExpressRoute 電路的兩個 Vnet 和 hello 遠端的 ExpressRoute 電路。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-173">For redundancy, you link hello two VNets in each region tooboth hello local ExpressRoute circuit and hello remote ExpressRoute circuit.</span></span> <span data-ttu-id="a8d8d-174">可以是如下所示，從每個 VNet 有兩個路徑 toohello 另一個 VNet。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-174">As can be seen below, from each VNet there are two paths toohello other VNet.</span></span> <span data-ttu-id="a8d8d-175">hello Vnet 不知道哪一個 ExpressRoute 電路位於本機，以及哪一個是遠端。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-175">hello VNets don't know which ExpressRoute circuit is local and which one is remote.</span></span> <span data-ttu-id="a8d8d-176">因此一樣等成本-多重路徑 (ECMP) 路由 tooload 平衡間 VNet 流量，某些流量都有 hello 較長的路徑，因此會路由在 hello 遠端 ExpressRoute 循環。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-176">Consequently as they do Equal-Cost-Multi-Path (ECMP) routing tooload-balance inter-VNet traffic, some traffic flows will take hello longer path and get routed at hello remote ExpressRoute circuit.</span></span>

![ExpressRoute 案例 3 - 虛擬網路之間的次佳化路由](./media/expressroute-optimize-routing/expressroute-case3-problem.png)

### <a name="solution-assign-a-high-weight-toolocal-connection"></a><span data-ttu-id="a8d8d-178">解決方案： 指派加權高 toolocal 連接</span><span class="sxs-lookup"><span data-stu-id="a8d8d-178">Solution: assign a high weight toolocal connection</span></span>
<span data-ttu-id="a8d8d-179">hello 方案很簡單。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-179">hello solution is simple.</span></span> <span data-ttu-id="a8d8d-180">因為知道 hello Vnet 和 hello 電路位置，您可以告訴我們應該最好每個 VNet 的路徑。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-180">Since you know where hello VNets and hello circuits are, you can tell us which path each VNet should prefer.</span></span> <span data-ttu-id="a8d8d-181">特別針對此範例中，您指派較高權數 toohello 本機連接比 toohello 遠端連線 (請參閱 hello 組態範例[這裡](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection))。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-181">Specifically for this example, you assign a higher weight toohello local connection than toohello remote connection (see hello configuration example [here](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span></span> <span data-ttu-id="a8d8d-182">當 VNet 收到 hello hello 前置詞上多個連接，它會與 hello 最高權數 toosend 流量目的該前置詞偏好 hello 連線其他 VNet。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-182">When a VNet receives hello prefix of hello other VNet on multiple connections it will prefer hello connection with hello highest weight toosend traffic destined for that prefix.</span></span>

![ExpressRoute 案例 3 方案-指派加權高 toolocal 連線](./media/expressroute-optimize-routing/expressroute-case3-solution.png)

> [!NOTE]
> <span data-ttu-id="a8d8d-184">您也可以決定路由從 VNet tooyour 在內部部署網路，如果您有多個 ExpressRoute 電路，藉由設定 hello 權數的連接，而不是套用 AS 路徑前面加上 hello 上面的第二個案例中所述的技術。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-184">You can also influence routing from VNet tooyour on-premises network, if you have multiple ExpressRoute circuits, by configuring hello weight of a connection instead of applying AS PATH prepending, a technique described in hello second scenario above.</span></span> <span data-ttu-id="a8d8d-185">每個前置詞，我們將一律探討 hello 連接加權 hello AS 路徑長度之前決定時如何 toosend 流量。</span><span class="sxs-lookup"><span data-stu-id="a8d8d-185">For each prefix, we will always look at hello connection weight before hello AS Path length when deciding how toosend traffic.</span></span>
>
>
