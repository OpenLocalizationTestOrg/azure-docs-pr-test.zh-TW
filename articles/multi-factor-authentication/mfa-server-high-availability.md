---
title: "高可用性的 Azure MFA Server aaaConfigure |Microsoft 文件"
description: "在設定中部署多個 Azure Multi-Factor Authentication Server 執行個體以提供高可用性。"
services: multi-factor-authentication
keywords: Azure MFA,
documentationcenter: 
author: MicrosoftGuyJFlo
manager: femila
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/23/2017
ms.author: joflore
ms.reviewer: alexwe
ms.custom: it-pro
ms.openlocfilehash: 8c6b1921c734c7a7273e443b3591fbbb15cd5e6c
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="configure-azure-multi-factor-authentication-server-for-high-availability"></a><span data-ttu-id="dcf1c-104">針對高可用性設定 Azure Multi-Factor Authentication Server</span><span class="sxs-lookup"><span data-stu-id="dcf1c-104">Configure Azure Multi-Factor Authentication Server for high availability</span></span>

<span data-ttu-id="dcf1c-105">您需要 toodeploy tooachieve 高可用性與 Azure 伺服器 MFA 部署多部 MFA 伺服器。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-105">tooachieve high-availability with your Azure Server MFA deployment, you need toodeploy multiple MFA servers.</span></span> <span data-ttu-id="dcf1c-106">本節提供資訊的載入平衡設計 tooachieve 上您在您的 Azure MFS 伺服器部署的高可用性目標。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-106">This section provides information on a load-balanced design tooachieve your high availability targets in you Azure MFS Server deployment.</span></span>

## <a name="mfa-server-overview"></a><span data-ttu-id="dcf1c-107">MFA Server 概觀</span><span class="sxs-lookup"><span data-stu-id="dcf1c-107">MFA Server overview</span></span>

<span data-ttu-id="dcf1c-108">hello Azure MFA Server 服務架構是由數個元件組成 hello 下列圖表所示：</span><span class="sxs-lookup"><span data-stu-id="dcf1c-108">hello Azure MFA Server service architecture comprises several components as shown in hello following diagram:</span></span>

 ![MFA Server 架構](./media/mfa-server-high-availability/mfa-ha-architecture.png)

<span data-ttu-id="dcf1c-110">MFA 伺服器是 Windows 伺服器已安裝的 hello Azure Multi-factor Authentication Server 軟體。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-110">An MFA Server is a Windows Server that has hello Azure Multi-Factor Authentication software installed.</span></span> <span data-ttu-id="dcf1c-111">在 Azure toofunction hello MFA 服務必須先啟用 hello MFA Server 執行個體。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-111">hello MFA Server instance must be activated by hello MFA Service in Azure toofunction.</span></span> <span data-ttu-id="dcf1c-112">您可以在內部部署安裝多部 MFA Server。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-112">More than one MFA Server can be installed on-premises.</span></span>

<span data-ttu-id="dcf1c-113">是第一部已安裝的 MFA 伺服器 hello hello 主要的 MFA 伺服器啟動時由預設的 hello Azure MFA 服務。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-113">hello first MFA Server that is installed is hello master MFA Server upon activation by hello Azure MFA Service by default.</span></span> <span data-ttu-id="dcf1c-114">hello 主要 MFA server 具有可寫入的 hello PhoneFactor.pfdata 資料庫複本。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-114">hello master MFA server has a writeable copy of hello PhoneFactor.pfdata database.</span></span> <span data-ttu-id="dcf1c-115">MFA Server 執行個體的後續安裝稱為從屬。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-115">Subsequent installations of instances of MFA Server are known as slaves.</span></span> <span data-ttu-id="dcf1c-116">hello MFA 從屬有 hello PhoneFactor.pfdata 資料庫的複寫唯讀複本。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-116">hello MFA slaves have a replicated read-only copy of hello PhoneFactor.pfdata database.</span></span> <span data-ttu-id="dcf1c-117">MFA Server 使用遠端程序呼叫 (RPC) 複寫資訊。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-117">MFA servers replicate information using Remote Procedure Call (RPC).</span></span> <span data-ttu-id="dcf1c-118">所有的 MFA 伺服器共同必須加入網域或獨立 tooreplicate 資訊。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-118">All MFA Severs must collectively either be domain joined or standalone tooreplicate information.</span></span>

<span data-ttu-id="dcf1c-119">MFA 主要和備用 MFA 伺服器通訊以 hello MFA 服務需要雙因素驗證時。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-119">Both MFA master and slave MFA Servers communicate with hello MFA Service when two-factor authentication is required.</span></span> <span data-ttu-id="dcf1c-120">比方說，當使用者嘗試 toogain 存取 tooan 應用程式需要雙因素驗證，hello 會先驗證使用者身分識別提供者，例如 Active Directory (AD)。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-120">For example, when a user attempts toogain access tooan application that requires two-factor authentication, hello user will first be authenticated by an identity provider, such as Active Directory (AD).</span></span>

<span data-ttu-id="dcf1c-121">在使用 AD 成功驗證後 hello MFA Server 會以 hello MFA 服務進行通訊。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-121">After successful authentication with AD, hello MFA Server will communicate with hello MFA Service.</span></span> <span data-ttu-id="dcf1c-122">hello MFA Server 等候來自 hello MFA 服務 tooallow 通知，或拒絕 hello 使用者存取 toohello 應用程式。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-122">hello MFA Server waits for notification from hello MFA Service tooallow or deny hello user access toohello application.</span></span>

<span data-ttu-id="dcf1c-123">如果 hello MFA 主要伺服器離線，仍可處理驗證，但無法處理要求變更 toohello MFA 資料庫的作業。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-123">If hello MFA master server goes offline, authentications can still be processed, but operations that require changes toohello MFA database cannot be processed.</span></span> <span data-ttu-id="dcf1c-124">(範例包括： hello 加入的使用者、 自助 PIN 變更，以及變更使用者資訊)</span><span class="sxs-lookup"><span data-stu-id="dcf1c-124">(Examples include: hello addition of users, self-service PIN changes, and changing user information)</span></span>

## <a name="deployment"></a><span data-ttu-id="dcf1c-125">部署</span><span class="sxs-lookup"><span data-stu-id="dcf1c-125">Deployment</span></span>

<span data-ttu-id="dcf1c-126">請考慮下列重點負載平衡 Azure MFA Server 以及其相關的元件 hello。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-126">Consider hello following important points for load balancing Azure MFA Server and its related components.</span></span>

* <span data-ttu-id="dcf1c-127">**使用 RADIUS 標準 tooachieve 高可用性**。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-127">**Using RADIUS standard tooachieve high availability**.</span></span> <span data-ttu-id="dcf1c-128">如果您使用 Azure MFA Server 作為 RADIUS 伺服器，您可能會將一部 MFA Server 設定為主要 RADIUS 驗證目標，並將其他 Azure MFA Server 設定為次要驗證目標。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-128">If you are using Azure MFA Servers as RADIUS servers, you can potentially configure one MFA Server as a primary RADIUS authentication target and other Azure MFA Servers as secondary authentication targets.</span></span> <span data-ttu-id="dcf1c-129">不過，此方法 tooachieve 高可用性可能不實用，因為您必須等候逾時期間 toooccur hello 主要驗證目標上之前，您可以針對 hello 次要驗證進行驗證失敗的驗證目標。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-129">However, this method tooachieve high availability may not be practical because you must wait for a time-out period toooccur when authentication fails on hello primary authentication target before you can be authenticated against hello secondary authentication target.</span></span> <span data-ttu-id="dcf1c-130">它是更有效率 tooload 平衡 hello 之間的 RADIUS 流量 hello RADIUS 用戶端與 hello RADIUS 伺服器 （在此情況下，做為 RADIUS 伺服器 hello Azure MFA 伺服器），讓您可以使用單一的 URL 可以指向設定 hello RADIUS 用戶端。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-130">It is more efficient tooload balance hello RADIUS traffic between hello RADIUS client and hello RADIUS Servers (in this case, hello Azure MFA Servers acting as RADIUS servers) so that you can configure hello RADIUS clients with a single URL that they can point to.</span></span>
* <span data-ttu-id="dcf1c-131">**需要 toomanually 升級 MFA 從屬**。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-131">**Need toomanually promote MFA slaves**.</span></span> <span data-ttu-id="dcf1c-132">如果 hello 主要 Azure MFA 伺服器離線，hello 次要 Azure MFA 伺服器會繼續 tooprocess MFA 要求。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-132">If hello master Azure MFA server goes offline, hello secondary Azure MFA Servers continue tooprocess MFA requests.</span></span> <span data-ttu-id="dcf1c-133">不過，主要的 MFA 伺服器可用之前，系統管理員無法將使用者加入或修改 MFA 設定，而且使用者可以進行使用 hello 使用者入口網站的變更。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-133">However, until a master MFA server is available, admins can not add users or modify MFA settings, and users can not make changes using hello user portal.</span></span> <span data-ttu-id="dcf1c-134">永遠升級 MFA 從屬 toohello 主機角色是手動程序。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-134">Promoting an MFA slave toohello master role is always a manual process.</span></span>
* <span data-ttu-id="dcf1c-135">**元件的可分性**。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-135">**Separability of components**.</span></span> <span data-ttu-id="dcf1c-136">Azure MFA Server 是由數個可安裝於的元件組成的 hello hello 相同的 Windows 伺服器執行個體或不同的執行個體上。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-136">hello Azure MFA Server comprises several components that can be installed on hello same Windows Server instance or on different instances.</span></span> <span data-ttu-id="dcf1c-137">這些元件包括 hello 使用者入口網站、 行動裝置應用程式 Web 服務，與 hello ADFS 配接器 （代理程式）。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-137">These components include hello User Portal, Mobile App Web Service, and hello ADFS adapter (agent).</span></span> <span data-ttu-id="dcf1c-138">此 separability 使它可能 toouse hello Web 應用程式 Proxy toopublish hello 使用者入口網站和行動裝置應用程式的網頁伺服器從 hello 周邊網路。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-138">This separability makes it possible toouse hello Web Application Proxy toopublish hello User Portal and Mobile App Web Server from hello perimeter network.</span></span> <span data-ttu-id="dcf1c-139">這種組態中加入 toohello 整體安全性的設計，hello 下列圖表所示。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-139">Such a configuration adds toohello overall security of your design, as shown in hello following diagram.</span></span> <span data-ttu-id="dcf1c-140">hello MFA 使用者入口網站和行動裝置應用程式 Web 伺服器也可能在 HA 負載平衡設定中部署。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-140">hello MFA User Portal and Mobile App Web Server may also be deployed in HA load-balanced configurations.</span></span>

   ![具有周邊網路的 MFA Server](./media/mfa-server-high-availability/mfasecurity.png)

* <span data-ttu-id="dcf1c-142">**透過 SMS 也稱為單向簡訊的單次密碼 (OTP) 需要 hello 使用自黏工作階段，如果流量負載平衡**。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-142">**One-time password (OTP) over SMS (aka one-way SMS) requires hello use of sticky sessions if traffic is load-balanced**.</span></span> <span data-ttu-id="dcf1c-143">單向 SMS 是包含 OTP 的文字訊息功能會讓 hello MFA Server toosend hello 使用者的驗證選項。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-143">One-way SMS is an authentication option that causes hello MFA Server toosend hello users a text message containing an OTP.</span></span> <span data-ttu-id="dcf1c-144">hello 使用者輸入 hello OTP 在提示字元視窗 toocomplete hello MFA 挑戰。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-144">hello user enters hello OTP in a prompt window toocomplete hello MFA challenge.</span></span> <span data-ttu-id="dcf1c-145">如果您載入平衡 Azure MFA Server，hello 處理 hello 初始驗證要求的相同伺服器必須是 hello 伺服器 hello OTP 訊息接收 hello 使用者資訊。如果另一個的 MFA 伺服器收到 hello OTP 回覆，hello 驗證要求將會失敗。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-145">If you load balance Azure MFA Servers, hello same server that served hello initial authentication request must be hello server that receives hello OTP message from hello user; if another MFA Server receives hello OTP reply, hello authentication challenge fails.</span></span> <span data-ttu-id="dcf1c-146">如需詳細資訊，請參閱[SMS 加入 tooAzure MFA Server 上的一個時間密碼](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server)。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-146">For more information, see [One Time Password over SMS Added tooAzure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server).</span></span>
* <span data-ttu-id="dcf1c-147">**負載平衡的 hello 使用者入口網站和行動裝置應用程式 Web 服務的部署需要自黏工作階段**。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-147">**Load-Balanced deployments of hello User Portal and Mobile App Web Service require sticky sessions**.</span></span> <span data-ttu-id="dcf1c-148">如果您是負載平衡 hello MFA 使用者入口網站和 hello Mobile App Web Service，每個工作階段需要 toostay hello 上的相同的伺服器。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-148">If you are load-balancing hello MFA User Portal and hello Mobile App Web Service, each session needs toostay on hello same server.</span></span>

## <a name="high-availability-deployment"></a><span data-ttu-id="dcf1c-149">高可用性部署</span><span class="sxs-lookup"><span data-stu-id="dcf1c-149">High-availability deployment</span></span>

<span data-ttu-id="dcf1c-150">hello 下列圖表顯示 Azure MFA 和其元件，以及參考的 ADFS 的完整 HA 負載平衡 」 的實作。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-150">hello following diagram shows a complete HA load-balanced implementation of Azure MFA and its components, along with ADFS for reference.</span></span>

 ![Azure MFA Server HA 實作](./media/mfa-server-high-availability/mfa-ha-deployment.png)

<span data-ttu-id="dcf1c-152">請注意下列項目 hello 跟著編號區域的 hello 上述圖表中的 hello。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-152">Note hello following items for hello correspondingly numbered area of hello preceding diagram.</span></span>

1. <span data-ttu-id="dcf1c-153">hello 兩個 Azure MFA 伺服器 （MFA1 和 MFA2） 負載平衡 (mfaapp.contoso.com)，而設定的 toouse 靜態連接埠 (4443) tooreplicate hello PhoneFactor.pfdata 資料庫。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-153">hello two Azure MFA Servers (MFA1 and MFA2) are load balanced (mfaapp.contoso.com) and are configured toouse a static port (4443) tooreplicate hello PhoneFactor.pfdata database.</span></span> <span data-ttu-id="dcf1c-154">hello Web 服務 SDK 是每一部安裝 hello MFA Server tooenable 通訊與 hello ADFS 伺服器的 TCP 連接埠 443。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-154">hello Web Service SDK is installed on each of hello MFA Server tooenable communication over TCP port 443 with hello ADFS servers.</span></span> <span data-ttu-id="dcf1c-155">hello MFA 伺服器部署在無狀態負載平衡的組態。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-155">hello MFA servers are deployed in a stateless load-balanced configuration.</span></span> <span data-ttu-id="dcf1c-156">不過，如果您想 toouse OTP SMS 透過，您必須使用可設定狀態的負載平衡。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-156">However, if you wanted toouse OTP over SMS, you must use stateful load balancing.</span></span>
   <span data-ttu-id="dcf1c-157">![Azure MFA Server - 應用程式伺服器 HA](./media/mfa-server-high-availability/mfaapp.png)</span><span class="sxs-lookup"><span data-stu-id="dcf1c-157">![Azure MFA Server - App server HA](./media/mfa-server-high-availability/mfaapp.png)</span></span>

   > [!NOTE]
   > <span data-ttu-id="dcf1c-158">因為 RPC 使用動態通訊埠，所以不建議 tooopen toohello 各種可能使用 RPC 動態連接埠上的防火牆。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-158">Because RPC uses dynamic ports, it is not recommended tooopen firewalls up toohello range of dynamic ports that RPC can potentially use.</span></span> <span data-ttu-id="dcf1c-159">如果您有防火牆**之間**MFA 應用程式伺服器，您應該 hello MFA Server toocommunicate hello 複寫流量從屬與主要伺服器之間，並開啟連接埠的靜態連接埠上設定防火牆。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-159">If you have a firewall **between** your MFA application servers, you should configure hello MFA Server toocommunicate on a static port for hello replication traffic between slave and master servers and open that port on your firewall.</span></span> <span data-ttu-id="dcf1c-160">您可以藉由建立 DWORD 登錄值，在強制 hello 靜態連接埠```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor```呼叫```Pfsvc_ncan_ip_tcp_port```和設定 hello 值 tooan 可用的靜態連接埠。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-160">You can force hello static port by creating a DWORD registry value at ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` called ```Pfsvc_ncan_ip_tcp_port``` and setting hello value tooan available static port.</span></span> <span data-ttu-id="dcf1c-161">Hello 從屬 MFA Server toohello 主一律起始連線，hello 靜態連接埠時，才需要 hello 在主機上，但因為您可以在任何時間升級從屬 toobe hello master，您應該在所有的 MFA 伺服器上設定 hello 靜態連接埠。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-161">Connections are always initiated by hello slave MFA Servers toohello master, hello static port is only required on hello master, but since you can promote a slave toobe hello master at any time, you should set hello static port on all MFA Servers.</span></span>

2. <span data-ttu-id="dcf1c-162">hello 兩個使用者入口網站 MFA/行動裝置應用程式伺服器 （MAS1-向上 MFA-和 MFA-向上-MAS2） 進行負載平衡中**可設定狀態**組態 (mfa.contoso.com)。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-162">hello two User Portal/MFA Mobile App servers (MFA-UP-MAS1 and MFA-UP-MAS2) are load balanced in a **stateful** configuration (mfa.contoso.com).</span></span> <span data-ttu-id="dcf1c-163">前文提過黏性工作階段是負載平衡 hello MFA 使用者入口網站和行動應用程式服務的需求。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-163">Recall that sticky sessions are a requirement for load balancing hello MFA User Portal and Mobile App Service.</span></span>
   <span data-ttu-id="dcf1c-164">![Azure MFA Server - 使用者入口網站和行動裝置應用程式服務 HA](./media/mfa-server-high-availability/mfaportal.png)</span><span class="sxs-lookup"><span data-stu-id="dcf1c-164">![Azure MFA Server - User Portal and Mobile App Service HA](./media/mfa-server-high-availability/mfaportal.png)</span></span>
3. <span data-ttu-id="dcf1c-165">負載平衡，而在 hello 周邊網路中發行 toohello 網際網路透過負載平衡 ADFS proxy hello ADFS 伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-165">hello ADFS Server farm is load balanced and published toohello Internet through load-balanced ADFS proxies in hello perimeter network.</span></span> <span data-ttu-id="dcf1c-166">每個 ADFS 伺服器使用 hello ADFS 代理程式 toocommunicate 以 hello Azure MFA 伺服器透過 TCP 連接埠 443 使用單一負載平衡 URL (mfaapp.contoso.com)。</span><span class="sxs-lookup"><span data-stu-id="dcf1c-166">Each ADFS Server uses hello ADFS agent toocommunicate with hello Azure MFA Servers using a single load-balanced URL (mfaapp.contoso.com) over TCP port 443.</span></span>

## <a name="next-steps"></a><span data-ttu-id="dcf1c-167">後續步驟</span><span class="sxs-lookup"><span data-stu-id="dcf1c-167">Next steps</span></span>

* [<span data-ttu-id="dcf1c-168">安裝和設定 Azure MFA Server</span><span class="sxs-lookup"><span data-stu-id="dcf1c-168">Install and configure Azure MFA Server</span></span>](multi-factor-authentication-get-started-server.md)
