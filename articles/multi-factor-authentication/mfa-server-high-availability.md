---
title: "針對高可用性設定 Azure MFA Server | Microsoft Docs"
description: "在設定中部署多個 Azure Multi-Factor Authentication Server 執行個體以提供高可用性。"
services: multi-factor-authentication
keywords: Azure MFA,
documentationcenter: 
author: MicrosoftGuyJFlo
manager: femila
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/23/2017
ms.author: joflore
ms.reviewer: alexwe
ms.custom: it-pro
ms.openlocfilehash: 9f03e61e05383c309fb66b67e0641b17df5ab00f
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/29/2017
---
# <a name="configure-azure-multi-factor-authentication-server-for-high-availability"></a><span data-ttu-id="0e79f-104">針對高可用性設定 Azure Multi-Factor Authentication Server</span><span class="sxs-lookup"><span data-stu-id="0e79f-104">Configure Azure Multi-Factor Authentication Server for high availability</span></span>

<span data-ttu-id="0e79f-105">若要透過 Azure Server MFA 部署達到高可用性，您必須部署多部 MFA Server。</span><span class="sxs-lookup"><span data-stu-id="0e79f-105">To achieve high-availability with your Azure Server MFA deployment, you need to deploy multiple MFA servers.</span></span> <span data-ttu-id="0e79f-106">本節提供負載平衡設計的相關資訊，該設計可達到 Azure MFS Server 部署中的高可用性目標。</span><span class="sxs-lookup"><span data-stu-id="0e79f-106">This section provides information on a load-balanced design to achieve your high availability targets in you Azure MFS Server deployment.</span></span>

## <a name="mfa-server-overview"></a><span data-ttu-id="0e79f-107">MFA Server 概觀</span><span class="sxs-lookup"><span data-stu-id="0e79f-107">MFA Server overview</span></span>

<span data-ttu-id="0e79f-108">Azure MFA Server 服務架構包含數個元件，如下圖所示：</span><span class="sxs-lookup"><span data-stu-id="0e79f-108">The Azure MFA Server service architecture comprises several components as shown in the following diagram:</span></span>

 ![MFA Server 架構](./media/mfa-server-high-availability/mfa-ha-architecture.png)

<span data-ttu-id="0e79f-110">MFA Server 是已安裝 Azure Multi-Factor Authentication 軟體的 Windows Server。</span><span class="sxs-lookup"><span data-stu-id="0e79f-110">An MFA Server is a Windows Server that has the Azure Multi-Factor Authentication software installed.</span></span> <span data-ttu-id="0e79f-111">MFA Server 執行個體必須透過 Azure MFA 服務啟用才能運作。</span><span class="sxs-lookup"><span data-stu-id="0e79f-111">The MFA Server instance must be activated by the MFA Service in Azure to function.</span></span> <span data-ttu-id="0e79f-112">您可以在內部部署安裝多部 MFA Server。</span><span class="sxs-lookup"><span data-stu-id="0e79f-112">More than one MFA Server can be installed on-premises.</span></span>

<span data-ttu-id="0e79f-113">第一部安裝的 MFA Server 是主要 MFA Server，Azure MFA 服務預設會啟用此伺服器。</span><span class="sxs-lookup"><span data-stu-id="0e79f-113">The first MFA Server that is installed is the master MFA Server upon activation by the Azure MFA Service by default.</span></span> <span data-ttu-id="0e79f-114">主要 MFA Server 具有 PhoneFactor.pfdata 資料庫的可寫入複本。</span><span class="sxs-lookup"><span data-stu-id="0e79f-114">The master MFA server has a writeable copy of the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="0e79f-115">MFA Server 執行個體的後續安裝稱為從屬。</span><span class="sxs-lookup"><span data-stu-id="0e79f-115">Subsequent installations of instances of MFA Server are known as slaves.</span></span> <span data-ttu-id="0e79f-116">MFA 從屬具有 PhoneFactor.pfdata 資料庫的唯讀複寫複本。</span><span class="sxs-lookup"><span data-stu-id="0e79f-116">The MFA slaves have a replicated read-only copy of the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="0e79f-117">MFA Server 使用遠端程序呼叫 (RPC) 複寫資訊。</span><span class="sxs-lookup"><span data-stu-id="0e79f-117">MFA servers replicate information using Remote Procedure Call (RPC).</span></span> <span data-ttu-id="0e79f-118">所有 MFA Server 必須共同加入網域或必須是獨立，才能複寫資訊。</span><span class="sxs-lookup"><span data-stu-id="0e79f-118">All MFA Severs must collectively either be domain joined or standalone to replicate information.</span></span>

<span data-ttu-id="0e79f-119">需要雙因素驗證時，MFA 的主要和從屬 MFA Server 會與 MFA 服務通訊。</span><span class="sxs-lookup"><span data-stu-id="0e79f-119">Both MFA master and slave MFA Servers communicate with the MFA Service when two-factor authentication is required.</span></span> <span data-ttu-id="0e79f-120">例如，當使用者嘗試存取需要雙因素驗證的應用程式，使用者會先經過識別提供者驗證，例如 Active Directory (AD)。</span><span class="sxs-lookup"><span data-stu-id="0e79f-120">For example, when a user attempts to gain access to an application that requires two-factor authentication, the user will first be authenticated by an identity provider, such as Active Directory (AD).</span></span>

<span data-ttu-id="0e79f-121">向 AD 成功驗證之後，MFA Server 將會與 MFA 服務通訊。</span><span class="sxs-lookup"><span data-stu-id="0e79f-121">After successful authentication with AD, the MFA Server will communicate with the MFA Service.</span></span> <span data-ttu-id="0e79f-122">MFA Server 會等候來自 MFA 服務的通知，以允許或拒絕使用者存取應用程式。</span><span class="sxs-lookup"><span data-stu-id="0e79f-122">The MFA Server waits for notification from the MFA Service to allow or deny the user access to the application.</span></span>

<span data-ttu-id="0e79f-123">如果 MFA 主要伺服器離線，仍可處理驗證，但無法處理需要變更 MFA 資料庫的作業。</span><span class="sxs-lookup"><span data-stu-id="0e79f-123">If the MFA master server goes offline, authentications can still be processed, but operations that require changes to the MFA database cannot be processed.</span></span> <span data-ttu-id="0e79f-124">(範例包括：新增使用者、自助式 PIN 變更及變更使用者資訊)。</span><span class="sxs-lookup"><span data-stu-id="0e79f-124">(Examples include: the addition of users, self-service PIN changes, and changing user information)</span></span>

## <a name="deployment"></a><span data-ttu-id="0e79f-125">部署</span><span class="sxs-lookup"><span data-stu-id="0e79f-125">Deployment</span></span>

<span data-ttu-id="0e79f-126">請考慮對 Azure MFA Server 及其相關元件進行負載平衡的下列重點。</span><span class="sxs-lookup"><span data-stu-id="0e79f-126">Consider the following important points for load balancing Azure MFA Server and its related components.</span></span>

* <span data-ttu-id="0e79f-127">**使用 RADIUS 標準以達到高可用性**。</span><span class="sxs-lookup"><span data-stu-id="0e79f-127">**Using RADIUS standard to achieve high availability**.</span></span> <span data-ttu-id="0e79f-128">如果您使用 Azure MFA Server 作為 RADIUS 伺服器，您可能會將一部 MFA Server 設定為主要 RADIUS 驗證目標，並將其他 Azure MFA Server 設定為次要驗證目標。</span><span class="sxs-lookup"><span data-stu-id="0e79f-128">If you are using Azure MFA Servers as RADIUS servers, you can potentially configure one MFA Server as a primary RADIUS authentication target and other Azure MFA Servers as secondary authentication targets.</span></span> <span data-ttu-id="0e79f-129">不過，透過此方法可能無法達到高可用性，因為您必須等候主要驗證目標上的驗證失敗時所發生的逾時結束，才能對次要驗證目標進行驗證。</span><span class="sxs-lookup"><span data-stu-id="0e79f-129">However, this method to achieve high availability may not be practical because you must wait for a time-out period to occur when authentication fails on the primary authentication target before you can be authenticated against the secondary authentication target.</span></span> <span data-ttu-id="0e79f-130">對 RADIUS 用戶端與 RADIUS 伺服器 (在本例中是以 Azure MFA Server 作為 RADIUS 伺服器) 之間的 RADIUS 流量進行負載平衡會更有效率，因此您可以為 RADIUS 用戶端設定其可指向的單一 URL。</span><span class="sxs-lookup"><span data-stu-id="0e79f-130">It is more efficient to load balance the RADIUS traffic between the RADIUS client and the RADIUS Servers (in this case, the Azure MFA Servers acting as RADIUS servers) so that you can configure the RADIUS clients with a single URL that they can point to.</span></span>
* <span data-ttu-id="0e79f-131">**需要手動升階 MFA 從屬**。</span><span class="sxs-lookup"><span data-stu-id="0e79f-131">**Need to manually promote MFA slaves**.</span></span> <span data-ttu-id="0e79f-132">如果主要 Azure MFA Server 離線，次要 Azure MFA Server 會繼續處理 MFA 要求。</span><span class="sxs-lookup"><span data-stu-id="0e79f-132">If the master Azure MFA server goes offline, the secondary Azure MFA Servers continue to process MFA requests.</span></span> <span data-ttu-id="0e79f-133">不過，在主要 MFA Server 可供使用之前，系統管理員無法新增使用者或修改 MFA 設定，而且使用者無法透過使用者入口網站進行變更。</span><span class="sxs-lookup"><span data-stu-id="0e79f-133">However, until a master MFA server is available, admins can not add users or modify MFA settings, and users can not make changes using the user portal.</span></span> <span data-ttu-id="0e79f-134">將 MFA 從屬升階為主要角色一律是手動程序。</span><span class="sxs-lookup"><span data-stu-id="0e79f-134">Promoting an MFA slave to the master role is always a manual process.</span></span>
* <span data-ttu-id="0e79f-135">**元件的可分性**。</span><span class="sxs-lookup"><span data-stu-id="0e79f-135">**Separability of components**.</span></span> <span data-ttu-id="0e79f-136">Azure MFA Server 包含數個元件，可安裝在相同的 Windows Server 執行個體上或不同的執行個體上。</span><span class="sxs-lookup"><span data-stu-id="0e79f-136">The Azure MFA Server comprises several components that can be installed on the same Windows Server instance or on different instances.</span></span> <span data-ttu-id="0e79f-137">這些元件包含使用者入口網站、行動裝置應用程式 Web 服務和 ADFS 配接器 (代理程式)。</span><span class="sxs-lookup"><span data-stu-id="0e79f-137">These components include the User Portal, Mobile App Web Service, and the ADFS adapter (agent).</span></span> <span data-ttu-id="0e79f-138">此可分性讓您能夠使用 Web 應用程式 Proxy，從周邊網路發佈使用者入口網站和行動裝置應用程式網頁伺服器。</span><span class="sxs-lookup"><span data-stu-id="0e79f-138">This separability makes it possible to use the Web Application Proxy to publish the User Portal and Mobile App Web Server from the perimeter network.</span></span> <span data-ttu-id="0e79f-139">您可以將這類設定新增至設計的整體安全性，如下圖所示。</span><span class="sxs-lookup"><span data-stu-id="0e79f-139">Such a configuration adds to the overall security of your design, as shown in the following diagram.</span></span> <span data-ttu-id="0e79f-140">您也可以在 HA 負載平衡設定中部署 MFA 使用者入口網站和行動裝置應用程式網頁伺服器。</span><span class="sxs-lookup"><span data-stu-id="0e79f-140">The MFA User Portal and Mobile App Web Server may also be deployed in HA load-balanced configurations.</span></span>

   ![具有周邊網路的 MFA Server](./media/mfa-server-high-availability/mfasecurity.png)

* <span data-ttu-id="0e79f-142">**透過簡訊傳送單次密碼 (OTP) (又稱為單向簡訊) 需要在平衡流量負載時使用黏性工作階段**。</span><span class="sxs-lookup"><span data-stu-id="0e79f-142">**One-time password (OTP) over SMS (aka one-way SMS) requires the use of sticky sessions if traffic is load-balanced**.</span></span> <span data-ttu-id="0e79f-143">單向簡訊是一個驗證選項，可讓 MFA Server 傳送含有 OTP 的簡訊給使用者。</span><span class="sxs-lookup"><span data-stu-id="0e79f-143">One-way SMS is an authentication option that causes the MFA Server to send the users a text message containing an OTP.</span></span> <span data-ttu-id="0e79f-144">使用者會在提示字元視窗中輸入 OTP 以完成 MFA 挑戰。</span><span class="sxs-lookup"><span data-stu-id="0e79f-144">The user enters the OTP in a prompt window to complete the MFA challenge.</span></span> <span data-ttu-id="0e79f-145">如果您對 Azure MFA Server 進行負載平衡，從使用者收到 OTP 訊息的伺服器必須是服務初始驗證要求的相同伺服器；如果是另一部 MFA Server 收到 OTP 回覆，則驗證挑戰會失敗。</span><span class="sxs-lookup"><span data-stu-id="0e79f-145">If you load balance Azure MFA Servers, the same server that served the initial authentication request must be the server that receives the OTP message from the user; if another MFA Server receives the OTP reply, the authentication challenge fails.</span></span> <span data-ttu-id="0e79f-146">如需詳細資訊，請參閱 [One Time Password over SMS Added to Azure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server) (透過簡訊傳送單次密碼功能已新增至 Azure MFA Server)。</span><span class="sxs-lookup"><span data-stu-id="0e79f-146">For more information, see [One Time Password over SMS Added to Azure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server).</span></span>
* <span data-ttu-id="0e79f-147">**使用者入口網站和行動裝置應用程式 Web 服務的負載平衡部署需要黏性工作階段**。</span><span class="sxs-lookup"><span data-stu-id="0e79f-147">**Load-Balanced deployments of the User Portal and Mobile App Web Service require sticky sessions**.</span></span> <span data-ttu-id="0e79f-148">如果您想要對 MFA 使用者入口網站和行動裝置應用程式 Web 服務進行負載平衡，每個工作階段必須保留在相同的伺服器上。</span><span class="sxs-lookup"><span data-stu-id="0e79f-148">If you are load-balancing the MFA User Portal and the Mobile App Web Service, each session needs to stay on the same server.</span></span>

## <a name="high-availability-deployment"></a><span data-ttu-id="0e79f-149">高可用性部署</span><span class="sxs-lookup"><span data-stu-id="0e79f-149">High-availability deployment</span></span>

<span data-ttu-id="0e79f-150">下圖顯示 Azure MFA 及其元件的完整 HA 負載平衡實作，以及用於參考的 ADFS。</span><span class="sxs-lookup"><span data-stu-id="0e79f-150">The following diagram shows a complete HA load-balanced implementation of Azure MFA and its components, along with ADFS for reference.</span></span>

 ![Azure MFA Server HA 實作](./media/mfa-server-high-availability/mfa-ha-deployment.png)

<span data-ttu-id="0e79f-152">注意上圖中對應至編號區域的下列項目。</span><span class="sxs-lookup"><span data-stu-id="0e79f-152">Note the following items for the correspondingly numbered area of the preceding diagram.</span></span>

1. <span data-ttu-id="0e79f-153">這兩部 Azure MFA Server (MFA1 和 MFA2) 已經過負載平衡 (mfaapp.contoso.com)，並設定為使用靜態連接埠 (4443) 以複寫 PhoneFactor.pfdata 資料庫。</span><span class="sxs-lookup"><span data-stu-id="0e79f-153">The two Azure MFA Servers (MFA1 and MFA2) are load balanced (mfaapp.contoso.com) and are configured to use a static port (4443) to replicate the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="0e79f-154">Web 服務 SDK 會安裝在每部 MFA Server 上，以允許透過 TCP 連接埠 443 與 ADFS 伺服器通訊。</span><span class="sxs-lookup"><span data-stu-id="0e79f-154">The Web Service SDK is installed on each of the MFA Server to enable communication over TCP port 443 with the ADFS servers.</span></span> <span data-ttu-id="0e79f-155">MFA Server 會部署在無狀態負載平衡設定中。</span><span class="sxs-lookup"><span data-stu-id="0e79f-155">The MFA servers are deployed in a stateless load-balanced configuration.</span></span> <span data-ttu-id="0e79f-156">不過，如果您想要透過簡訊使用 OTP，您必須使用具狀態負載平衡。</span><span class="sxs-lookup"><span data-stu-id="0e79f-156">However, if you wanted to use OTP over SMS, you must use stateful load balancing.</span></span>
   <span data-ttu-id="0e79f-157">![Azure MFA Server - 應用程式伺服器 HA](./media/mfa-server-high-availability/mfaapp.png)</span><span class="sxs-lookup"><span data-stu-id="0e79f-157">![Azure MFA Server - App server HA](./media/mfa-server-high-availability/mfaapp.png)</span></span>

   > [!NOTE]
   > <span data-ttu-id="0e79f-158">因為 RPC 使用動態連接埠，所以不建議在 RPC 可能使用的動態連接埠範圍內開啟防火牆。</span><span class="sxs-lookup"><span data-stu-id="0e79f-158">Because RPC uses dynamic ports, it is not recommended to open firewalls up to the range of dynamic ports that RPC can potentially use.</span></span> <span data-ttu-id="0e79f-159">如果您在 MFA 應用程式伺服器**之間**有防火牆，您應該針對從屬與主要伺服器之間的複寫流量設定要在靜態連接埠上通訊的 MFA Server，並在防火牆上開啟該連接埠。</span><span class="sxs-lookup"><span data-stu-id="0e79f-159">If you have a firewall **between** your MFA application servers, you should configure the MFA Server to communicate on a static port for the replication traffic between slave and master servers and open that port on your firewall.</span></span> <span data-ttu-id="0e79f-160">您可以在 ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` 建立稱為 ```Pfsvc_ncan_ip_tcp_port``` 的 DWORD 登錄值，並將該值設定為可用的靜態連接埠，來強制使用靜態連接埠。</span><span class="sxs-lookup"><span data-stu-id="0e79f-160">You can force the static port by creating a DWORD registry value at ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` called ```Pfsvc_ncan_ip_tcp_port``` and setting the value to an available static port.</span></span> <span data-ttu-id="0e79f-161">一律會由從屬 MFA Server 起始對主要的連線，只有主要才需要靜態連接埠，但由於您可以隨時將從屬升階為主要，因此您應該在所有 MFA Server 上設定靜態連接埠。</span><span class="sxs-lookup"><span data-stu-id="0e79f-161">Connections are always initiated by the slave MFA Servers to the master, the static port is only required on the master, but since you can promote a slave to be the master at any time, you should set the static port on all MFA Servers.</span></span>

2. <span data-ttu-id="0e79f-162">這兩部使用者入口網站/MFA 行動裝置應用程式伺服器 (MFA-UP-MAS1 和 MFA-UP-MAS2) 會在**具狀態**設定 (mfa.contoso.com) 中進行負載平衡。</span><span class="sxs-lookup"><span data-stu-id="0e79f-162">The two User Portal/MFA Mobile App servers (MFA-UP-MAS1 and MFA-UP-MAS2) are load balanced in a **stateful** configuration (mfa.contoso.com).</span></span> <span data-ttu-id="0e79f-163">如前所述，對 MFA 使用者入口網站和行動裝置應用程式服務進行負載平衡需要黏性工作階段。</span><span class="sxs-lookup"><span data-stu-id="0e79f-163">Recall that sticky sessions are a requirement for load balancing the MFA User Portal and Mobile App Service.</span></span>
   <span data-ttu-id="0e79f-164">![Azure MFA Server - 使用者入口網站和行動裝置應用程式服務 HA](./media/mfa-server-high-availability/mfaportal.png)</span><span class="sxs-lookup"><span data-stu-id="0e79f-164">![Azure MFA Server - User Portal and Mobile App Service HA](./media/mfa-server-high-availability/mfaportal.png)</span></span>
3. <span data-ttu-id="0e79f-165">ADFS 伺服器陣列已經過負載平衡，並透過周邊網路中的負載平衡 ADFS Proxy 發佈至網際網路。</span><span class="sxs-lookup"><span data-stu-id="0e79f-165">The ADFS Server farm is load balanced and published to the Internet through load-balanced ADFS proxies in the perimeter network.</span></span> <span data-ttu-id="0e79f-166">每部 ADFS 伺服器使用 ADFS 代理程式，利用 TCP 連接埠 443 上的單一負載平衡 URL (mfaapp.contoso.com) 與 Azure MFA Server 通訊。</span><span class="sxs-lookup"><span data-stu-id="0e79f-166">Each ADFS Server uses the ADFS agent to communicate with the Azure MFA Servers using a single load-balanced URL (mfaapp.contoso.com) over TCP port 443.</span></span>

## <a name="next-steps"></a><span data-ttu-id="0e79f-167">後續步驟</span><span class="sxs-lookup"><span data-stu-id="0e79f-167">Next steps</span></span>

* [<span data-ttu-id="0e79f-168">安裝和設定 Azure MFA Server</span><span class="sxs-lookup"><span data-stu-id="0e79f-168">Install and configure Azure MFA Server</span></span>](multi-factor-authentication-get-started-server.md)
