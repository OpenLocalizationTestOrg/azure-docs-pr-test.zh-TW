---
title: "設定 Azure MFA NPS 延伸模組 | Microsoft Docs"
description: "安裝 NPS 延伸模組之後，請使用下列步驟進行進階設定，例如 IP 白名單和 UPN 取代。"
services: multi-factor-authentication
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/14/2017
ms.author: kgremban
ms.reviewer: yossib
ms.custom: it-pro
ms.openlocfilehash: ef922668f080b8f02f07c2f9724f5a98171fb754
ms.sourcegitcommit: 422efcbac5b6b68295064bd545132fcc98349d01
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/29/2017
---
# <a name="advanced-configuration-options-for-the-nps-extension-for-multi-factor-authentication"></a><span data-ttu-id="6e6d7-103">Multi-Factor Authentication 之 NPS 延伸模組的進階設定選項</span><span class="sxs-lookup"><span data-stu-id="6e6d7-103">Advanced configuration options for the NPS extension for Multi-Factor Authentication</span></span>

<span data-ttu-id="6e6d7-104">網路原則伺服器 (NPS) 延伸模組會將雲端式 Azure Multi-Factor Authentication 功能延伸到內部部署基礎結構。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-104">The Network Policy Server (NPS) extension extends your cloud-based Azure Multi-Factor Authentication features into your on-premises infrastructure.</span></span> <span data-ttu-id="6e6d7-105">本文假設您已經安裝延伸模組，而現在想要知道如何為您的需求自訂延伸模組。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-105">This article assumes that you already have the extension installed, and now want to know how to customize the extension for you needs.</span></span> 

## <a name="alternate-login-id"></a><span data-ttu-id="6e6d7-106">替代登入識別碼</span><span class="sxs-lookup"><span data-stu-id="6e6d7-106">Alternate login ID</span></span>

<span data-ttu-id="6e6d7-107">因為 NPS 延伸模組會連接到您的內部部署和雲端目錄，所以您可能會發生內部部署使用者主體名稱 (UPN) 不符合雲端中名稱的問題。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-107">Since the NPS extension connects to both your on-premises and cloud directories, you might encounter an issue where your on-premises user principal names (UPNs) don't match the names in the cloud.</span></span> <span data-ttu-id="6e6d7-108">若要解決此問題，請使用替代登入識別碼。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-108">To solve this problem, use alternate login IDs.</span></span> 

<span data-ttu-id="6e6d7-109">在 NPS 延伸模組內，您可以指定要用來取代 Azure Multi-Factor Authentication 之 UPN 的 Active Directory 屬性。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-109">Within the NPS extension, you can designate an Active Directory attribute to be used in place of the UPN for Azure Multi-Factor Authentication.</span></span> <span data-ttu-id="6e6d7-110">這可讓您保護具有雙步驟驗證的內部部署資源，而不需要修改內部部署 UPN。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-110">This enables you to protect your on-premises resources with two-step verification without modifying your on-premises UPNs.</span></span> 

<span data-ttu-id="6e6d7-111">若要設定替代登入識別碼，請移至 `HKLM\SOFTWARE\Microsoft\AzureMfa`，然後編輯下列登錄值：</span><span class="sxs-lookup"><span data-stu-id="6e6d7-111">To configure alternate login IDs, go to `HKLM\SOFTWARE\Microsoft\AzureMfa` and edit the following registry values:</span></span>

| <span data-ttu-id="6e6d7-112">名稱</span><span class="sxs-lookup"><span data-stu-id="6e6d7-112">Name</span></span> | <span data-ttu-id="6e6d7-113">類型</span><span class="sxs-lookup"><span data-stu-id="6e6d7-113">Type</span></span> | <span data-ttu-id="6e6d7-114">預設值</span><span class="sxs-lookup"><span data-stu-id="6e6d7-114">Default value</span></span> | <span data-ttu-id="6e6d7-115">說明</span><span class="sxs-lookup"><span data-stu-id="6e6d7-115">Description</span></span> |
| ---- | ---- | ------------- | ----------- |
| <span data-ttu-id="6e6d7-116">LDAP_ALTERNATE_LOGINID_ATTRIBUTE</span><span class="sxs-lookup"><span data-stu-id="6e6d7-116">LDAP_ALTERNATE_LOGINID_ATTRIBUTE</span></span> | <span data-ttu-id="6e6d7-117">字串</span><span class="sxs-lookup"><span data-stu-id="6e6d7-117">string</span></span> | <span data-ttu-id="6e6d7-118">空白</span><span class="sxs-lookup"><span data-stu-id="6e6d7-118">Empty</span></span> | <span data-ttu-id="6e6d7-119">指定您想要使用的 Active Directory 屬性名稱，而非 UPN。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-119">Designate the name of Active Directory attribute that you want to use instead of the UPN.</span></span> <span data-ttu-id="6e6d7-120">此屬性用作 AlternateLoginId 屬性。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-120">This attribute is used as the AlternateLoginId attribute.</span></span> <span data-ttu-id="6e6d7-121">如果此登錄值設定為[有效的 Active Directory 屬性](https://msdn.microsoft.com/library/ms675090.aspx) (例如，mail 或 displayName)，則會使用屬性的值來取代使用者的 UPN 以進行驗證。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-121">If this registry value is set to a [valid Active Directory attribute](https://msdn.microsoft.com/library/ms675090.aspx) (for example, mail or displayName), then the attribute's value is used in place of the user's UPN for authentication.</span></span> <span data-ttu-id="6e6d7-122">如果此登錄值是空的或未設定，則會停用 AlternateLoginId，並以使用者的 UPN 進行驗證。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-122">If this registry value is empty or not configured, then AlternateLoginId is disabled and the user's UPN is used for authentication.</span></span> |
| <span data-ttu-id="6e6d7-123">LDAP_FORCE_GLOBAL_CATALOG</span><span class="sxs-lookup"><span data-stu-id="6e6d7-123">LDAP_FORCE_GLOBAL_CATALOG</span></span> | <span data-ttu-id="6e6d7-124">布林值</span><span class="sxs-lookup"><span data-stu-id="6e6d7-124">boolean</span></span> | <span data-ttu-id="6e6d7-125">False</span><span class="sxs-lookup"><span data-stu-id="6e6d7-125">False</span></span> | <span data-ttu-id="6e6d7-126">使用此旗標，可在查閱 AlternateLoginId 時強制使用通用類別目錄進行 LDAP 搜尋。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-126">Use this flag to force the use of Global Catalog for LDAP searches when looking up AlternateLoginId.</span></span> <span data-ttu-id="6e6d7-127">將網域控制站設定為通用類別目錄，並將 AlternateLoginId 屬性新增至通用類別目錄，然後啟用此旗標。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-127">Configure a domain controller as a Global Catalog, add the AlternateLoginId attribute to the Global Catalog, and then enable this flag.</span></span> <br><br> <span data-ttu-id="6e6d7-128">如果設定 LDAP_LOOKUP_FORESTS (不是空的)，則**此旗標會強制執行為 true**，不論登錄設定的值為何。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-128">If LDAP_LOOKUP_FORESTS is configured (not empty), **this flag is enforced as true**, regardless of the value of the registry setting.</span></span> <span data-ttu-id="6e6d7-129">在此情況下，NPS 延伸模組需要使用每個樹系的 AlternateLoginId 屬性來設定通用類別目錄。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-129">In this case, the NPS extension requires the Global Catalog to be configured with the AlternateLoginId attribute for each forest.</span></span> |
| <span data-ttu-id="6e6d7-130">LDAP_LOOKUP_FORESTS</span><span class="sxs-lookup"><span data-stu-id="6e6d7-130">LDAP_LOOKUP_FORESTS</span></span> | <span data-ttu-id="6e6d7-131">字串</span><span class="sxs-lookup"><span data-stu-id="6e6d7-131">string</span></span> | <span data-ttu-id="6e6d7-132">空白</span><span class="sxs-lookup"><span data-stu-id="6e6d7-132">Empty</span></span> | <span data-ttu-id="6e6d7-133">提供要搜尋的樹系清單 (以分號分隔)。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-133">Provide a semi-colon separated list of forests to search.</span></span> <span data-ttu-id="6e6d7-134">例如，*contoso.com;foobar.com*。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-134">For example, *contoso.com;foobar.com*.</span></span> <span data-ttu-id="6e6d7-135">如果設定此登錄值，NPS 延伸模組會依列出順序反覆搜尋所有樹系，並傳回第一個成功的 AlternateLoginId 值。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-135">If this registry value is configured, the NPS extension iteratively searches all the forests in the order in which they were listed, and returns the first successful AlternateLoginId value.</span></span> <span data-ttu-id="6e6d7-136">如果未設定此登錄值，AlternateLoginId 查閱會侷限於目前網域。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-136">If this registry value is not configured, the AlternateLoginId lookup is confined to the current domain.</span></span>|

<span data-ttu-id="6e6d7-137">若要針對替代登入識別碼問題進行疑難排解，請使用[替代登入識別碼錯誤](multi-factor-authentication-nps-errors.md#alternate-login-id-errors)的建議步驟。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-137">To troubleshoot problems with alternate login IDs, use the recommended steps for [Alternate login ID errors](multi-factor-authentication-nps-errors.md#alternate-login-id-errors).</span></span>

## <a name="ip-exceptions"></a><span data-ttu-id="6e6d7-138">IP 例外狀況</span><span class="sxs-lookup"><span data-stu-id="6e6d7-138">IP exceptions</span></span>

<span data-ttu-id="6e6d7-139">如果您需要監視伺服器可用性 (例如，如果負載平衡器確認哪些伺服器在傳送工作負載之前執行)，則不會想要驗證要求封鎖這些檢查。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-139">If you need to monitor server availability, like if load balancers verify which servers are running before sending workloads, you don't want these checks to be blocked by verification requests.</span></span> <span data-ttu-id="6e6d7-140">相反地，建立一份您知道服務帳戶所使用的 IP 位址清單，並停用該清單的 Multi-Factor Authentication 需求。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-140">Instead, create a list of IP addresses that you know are used by service accounts, and disable Multi-Factor Authentication requirements for that list.</span></span> 

<span data-ttu-id="6e6d7-141">若要設定 IP 白名單，請移至 `HKLM\SOFTWARE\Microsoft\AzureMfa`，然後設定下列登錄值：</span><span class="sxs-lookup"><span data-stu-id="6e6d7-141">To configure an IP whitelist, go to `HKLM\SOFTWARE\Microsoft\AzureMfa` and configure the following registry value:</span></span> 

| <span data-ttu-id="6e6d7-142">名稱</span><span class="sxs-lookup"><span data-stu-id="6e6d7-142">Name</span></span> | <span data-ttu-id="6e6d7-143">類型</span><span class="sxs-lookup"><span data-stu-id="6e6d7-143">Type</span></span> | <span data-ttu-id="6e6d7-144">預設值</span><span class="sxs-lookup"><span data-stu-id="6e6d7-144">Default value</span></span> | <span data-ttu-id="6e6d7-145">說明</span><span class="sxs-lookup"><span data-stu-id="6e6d7-145">Description</span></span> |
| ---- | ---- | ------------- | ----------- |
| <span data-ttu-id="6e6d7-146">IP_WHITELIST</span><span class="sxs-lookup"><span data-stu-id="6e6d7-146">IP_WHITELIST</span></span> | <span data-ttu-id="6e6d7-147">字串</span><span class="sxs-lookup"><span data-stu-id="6e6d7-147">string</span></span> | <span data-ttu-id="6e6d7-148">空白</span><span class="sxs-lookup"><span data-stu-id="6e6d7-148">Empty</span></span> | <span data-ttu-id="6e6d7-149">提供 IP 位址清單 (以分號分隔)。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-149">Provide a semi-colon separated list of IP addresses.</span></span> <span data-ttu-id="6e6d7-150">包含產生服務要求之機器的 IP 位址，例如 NAS/VPN 伺服器。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-150">Include the IP addresses of machines where service requests originate, like the NAS/VPN server.</span></span> <span data-ttu-id="6e6d7-151">不支援 IP 範圍和子網路。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-151">IP ranges are subnets are not supported.</span></span> <br><br> <span data-ttu-id="6e6d7-152">例如，*10.0.0.1;10.0.0.2;10.0.0.3*。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-152">For example, *10.0.0.1;10.0.0.2;10.0.0.3*.</span></span>

<span data-ttu-id="6e6d7-153">從白名單中的 IP 位址傳入要求時，會跳過雙步驟驗證。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-153">When a request comes in from an IP address that exists in the whitelist, two-step verification is skipped.</span></span> <span data-ttu-id="6e6d7-154">IP 白名單會與 RADIUS 要求之 *ratNASIPAddress* 屬性中所提供的 IP 位址進行比較。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-154">The IP whitelist is compared to the IP address that is provided in the *ratNASIPAddress* attribute of the RADIUS request.</span></span> <span data-ttu-id="6e6d7-155">如果傳入沒有 ratNASIPAddress 屬性的 RADIUS 要求，則會記錄下列警告：「P_WHITE_LIST_WARNING::IP 白名單將會予以忽略，因為 RADIUS 要求的 NasIpAddress 屬性中遺漏來源 IP」。</span><span class="sxs-lookup"><span data-stu-id="6e6d7-155">If a RADIUS request comes in without the ratNASIPAddress attribute, the following warning is logged: "P_WHITE_LIST_WARNING::IP Whitelist is being ignored as source IP is missing in RADIUS request in NasIpAddress attribute."</span></span>

## <a name="next-steps"></a><span data-ttu-id="6e6d7-156">後續步驟</span><span class="sxs-lookup"><span data-stu-id="6e6d7-156">Next steps</span></span>

[<span data-ttu-id="6e6d7-157">解決 Azure Multi-Factor Authentication NPS 擴充功能的錯誤訊息</span><span class="sxs-lookup"><span data-stu-id="6e6d7-157">Resolve error messages from the NPS extension for Azure Multi-Factor Authentication</span></span>](multi-factor-authentication-nps-errors.md)