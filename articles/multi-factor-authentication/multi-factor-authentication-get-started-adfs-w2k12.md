---
title: "MFA Server 搭配 Windows Server 中的 AD FS | Microsoft Docs"
description: "本文說明如何開始使用 Azure Multi-Factor Authentication 和 Windows Server 2012 R2 和 2016 中的 AD FS。"
services: multi-factor-authentication
documentationcenter: 
author: kgremban
manager: femila
editor: yossib
ms.assetid: 57208068-1e55-45b6-840f-fdcd13723074
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 03/29/2017
ms.author: kgremban
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: f2481c18f12d74a90938ffb0353dd000fe73f440
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="configure-azure-multi-factor-authentication-server-to-work-with-ad-fs-in-windows-server"></a><span data-ttu-id="73265-103">設定 Azure Multi-Factor Authentication Server 以搭配 Windows Server 中的 AD FS 運作</span><span class="sxs-lookup"><span data-stu-id="73265-103">Configure Azure Multi-Factor Authentication Server to work with AD FS in Windows Server</span></span>
<span data-ttu-id="73265-104">如果您使用 Active Directory 同盟服務 (AD FS)，而且想要保護雲端或內部部署資源，您可以設定 Azure Multi-factor Authentication Server 以搭配 AD FS 運作。</span><span class="sxs-lookup"><span data-stu-id="73265-104">If you use Active Directory Federation Services (AD FS) and want to secure cloud or on-premises resources, you can configure Azure Multi-Factor Authentication Server to work with AD FS.</span></span> <span data-ttu-id="73265-105">此組態會觸發高價值端點的雙步驟驗證。</span><span class="sxs-lookup"><span data-stu-id="73265-105">This configuration triggers two-step verification for high-value endpoints.</span></span>

<span data-ttu-id="73265-106">在本文中，我們將討論如何搭配 Windows Server 2012 R2 或 Windows Server 2016 中的 AD FS 使用 Azure Multi-Factor Authentication Server。</span><span class="sxs-lookup"><span data-stu-id="73265-106">In this article, we discuss using Azure Multi-Factor Authentication Server with AD FS in Windows Server 2012 R2 or Windows Server 2016.</span></span> <span data-ttu-id="73265-107">如需詳細資訊，請參閱 [搭配 AD FS 2.0 使用 Azure Multi-Factor Authentication Server 來保護雲端和內部部署資源](multi-factor-authentication-get-started-adfs-adfs2.md)。</span><span class="sxs-lookup"><span data-stu-id="73265-107">For more information, read about how to [secure cloud and on-premises resources by using Azure Multi-Factor Authentication Server with AD FS 2.0](multi-factor-authentication-get-started-adfs-adfs2.md).</span></span>

## <a name="secure-windows-server-ad-fs-with-azure-multi-factor-authentication-server"></a><span data-ttu-id="73265-108">使用 Azure Multi-Factor Authentication Server 保護 Windows Server AD FS</span><span class="sxs-lookup"><span data-stu-id="73265-108">Secure Windows Server AD FS with Azure Multi-Factor Authentication Server</span></span>
<span data-ttu-id="73265-109">安裝 Azure Multi-Factor Authentication Server 時，您有下列選項：</span><span class="sxs-lookup"><span data-stu-id="73265-109">When you install Azure Multi-Factor Authentication Server, you have the following options:</span></span>

* <span data-ttu-id="73265-110">在與 AD FS 相同的伺服器本機上安裝 Azure Multi-Factor Authentication Server</span><span class="sxs-lookup"><span data-stu-id="73265-110">Install Azure Multi-Factor Authentication Server locally on the same server as AD FS</span></span>
* <span data-ttu-id="73265-111">在 AD FS 伺服器本機上安裝 Azure Multi-Factor Authentication 配接器，然後在另一部電腦上安裝 Multi-Factor Authentication Server</span><span class="sxs-lookup"><span data-stu-id="73265-111">Install the Azure Multi-Factor Authentication adapter locally on the AD FS server, and then install Multi-Factor Authentication Server on a different computer</span></span>

<span data-ttu-id="73265-112">開始之前，請留意下列項目：</span><span class="sxs-lookup"><span data-stu-id="73265-112">Before you begin, be aware of the following information:</span></span>

* <span data-ttu-id="73265-113">您不需在 AD FS 伺服器上安裝 Azure Multi-Factor Authentication Server。</span><span class="sxs-lookup"><span data-stu-id="73265-113">You are not required to install Azure Multi-Factor Authentication Server on your AD FS server.</span></span> <span data-ttu-id="73265-114">不過，您必須在執行 AD FS 的 Windows Server 2012 R2 或 Windows Server 2016 上安裝適用於 AD FS 的 Multi-Factor Authentication 配接器。</span><span class="sxs-lookup"><span data-stu-id="73265-114">However, you must install the Multi-Factor Authentication adapter for AD FS on a Windows Server 2012 R2 or Windows Server 2016 that is running AD FS.</span></span> <span data-ttu-id="73265-115">您可以在不同的電腦上安裝伺服器 (只要是支援的版本即可)，以及在 AD FS 同盟伺服器上個別安裝 AD FS 配接器。</span><span class="sxs-lookup"><span data-stu-id="73265-115">You can install the server on a different computer if it is a supported version and you install the AD FS adapter separately on your AD FS federation server.</span></span> <span data-ttu-id="73265-116">請參閱下列程序，以了解如何個別安裝配接器。</span><span class="sxs-lookup"><span data-stu-id="73265-116">See the following procedures to learn how to install the adapter separately.</span></span>
* <span data-ttu-id="73265-117">如果您的組織使用簡訊或行動應用程式驗證方法，則在 [公司設定] 中定義的字串會包含預留位置 <$*application_name*$>。</span><span class="sxs-lookup"><span data-stu-id="73265-117">If your organization is using text message or mobile app verification methods, the strings defined in Company Settings contain a placeholder, <$*application_name*$>.</span></span> <span data-ttu-id="73265-118">在 MFA Server v7.1 中，您可以提供要取代此預留位置的應用程式名稱。</span><span class="sxs-lookup"><span data-stu-id="73265-118">In MFA Server v7.1, you can provide an application name that replaces this placeholder.</span></span> <span data-ttu-id="73265-119">在 v7.0 或更舊版本中，使用 AD FS 配接器時並不會自動取代此預留位置。</span><span class="sxs-lookup"><span data-stu-id="73265-119">In v7.0 or older, this placeholder is not automatically replaced when you use the AD FS adapter.</span></span> <span data-ttu-id="73265-120">對於這些較舊的版本，請在保護 AD FS 時，從適當的字串中移除此預留位置。</span><span class="sxs-lookup"><span data-stu-id="73265-120">For those older versions, remove the placeholder from the appropriate strings when you secure AD FS.</span></span>
* <span data-ttu-id="73265-121">用來登入的帳戶必須具有在 Active Directory 服務中建立安全性群組的使用者權限。</span><span class="sxs-lookup"><span data-stu-id="73265-121">The account that you use to sign in must have user rights to create security groups in your Active Directory service.</span></span>
* <span data-ttu-id="73265-122">Multi-Factor Authentication AD FS 配接器安裝精靈會在 Active Directory 執行個體中建立名為 PhoneFactor Admins 的安全性群組。</span><span class="sxs-lookup"><span data-stu-id="73265-122">The Multi-Factor Authentication AD FS adapter installation wizard creates a security group called PhoneFactor Admins in your instance of Active Directory.</span></span> <span data-ttu-id="73265-123">然後將 Federation Service 的 AD FS 服務帳戶新增至這個群組。</span><span class="sxs-lookup"><span data-stu-id="73265-123">It then adds the AD FS service account of your federation service to this group.</span></span> <span data-ttu-id="73265-124">在網域控制站上確認確實已建立 PhoneFactor Admins 群組，而且 AD FS 服務帳戶是此群組的成員。</span><span class="sxs-lookup"><span data-stu-id="73265-124">Verify on your domain controller that the PhoneFactor Admins group is indeed created and that the AD FS service account is a member of this group.</span></span> <span data-ttu-id="73265-125">如有必要，請以手動方式將 AD FS 服務帳戶加入至網域控制站上的 PhoneFactor Admins 群組。</span><span class="sxs-lookup"><span data-stu-id="73265-125">If necessary, manually add the AD FS service account to the PhoneFactor Admins group on your domain controller.</span></span>
* <span data-ttu-id="73265-126">如需透過使用者入口網站安裝 Web 服務 SDK 的資訊，請參閱 [部署 Azure Multi-Factor Authentication Server 的使用者入口網站](multi-factor-authentication-get-started-portal.md)</span><span class="sxs-lookup"><span data-stu-id="73265-126">For information about installing the Web Service SDK with the user portal, read about [deploying the user portal for Azure Multi-Factor Authentication Server.](multi-factor-authentication-get-started-portal.md)</span></span>

### <a name="install-azure-multi-factor-authentication-server-locally-on-the-ad-fs-server"></a><span data-ttu-id="73265-127">在 AD FS 伺服器本機上安裝 Azure Multi-Factor Authentication Server</span><span class="sxs-lookup"><span data-stu-id="73265-127">Install Azure Multi-Factor Authentication Server locally on the AD FS server</span></span>
1. <span data-ttu-id="73265-128">在 AD FS 伺服器上下載並安裝 Azure Multi-Factor Authentication Server。</span><span class="sxs-lookup"><span data-stu-id="73265-128">Download and install Azure Multi-Factor Authentication Server on your AD FS server.</span></span> <span data-ttu-id="73265-129">如需安裝資訊，請參閱 [開始使用 Azure Multi-Factor Authentication Server](multi-factor-authentication-get-started-server.md)。</span><span class="sxs-lookup"><span data-stu-id="73265-129">For installation information, read about [getting started with Azure Multi-Factor Authentication Server](multi-factor-authentication-get-started-server.md).</span></span>
2. <span data-ttu-id="73265-130">在 Azure Multi-Factor Authentication Server 管理主控台中，按一下 [AD FS] 圖示。</span><span class="sxs-lookup"><span data-stu-id="73265-130">In the Azure Multi-Factor Authentication Server management console, click the **AD FS** icon.</span></span> <span data-ttu-id="73265-131">選取 [允許使用者註冊] 和 [允許使用者選取方法] 選項。</span><span class="sxs-lookup"><span data-stu-id="73265-131">Select the options **Allow user enrollment** and **Allow users to select method**.</span></span>
3. <span data-ttu-id="73265-132">選取您想要為您的組織指定的任何其他選項。</span><span class="sxs-lookup"><span data-stu-id="73265-132">Select any additional options you'd like to specify for your organization.</span></span>
4. <span data-ttu-id="73265-133">按一下 [安裝 AD FS 配接器] 。</span><span class="sxs-lookup"><span data-stu-id="73265-133">Click **Install AD FS Adapter**.</span></span>
   
   <span data-ttu-id="73265-134"><center>![雲端](./media/multi-factor-authentication-get-started-adfs-w2k12/server.png)</center></span><span class="sxs-lookup"><span data-stu-id="73265-134"><center>![Cloud](./media/multi-factor-authentication-get-started-adfs-w2k12/server.png)</center></span></span>

5. <span data-ttu-id="73265-135">如果顯示 [Active Directory] 視窗，這代表兩件事情。</span><span class="sxs-lookup"><span data-stu-id="73265-135">If the Active Directory window is displayed, that means two things.</span></span> <span data-ttu-id="73265-136">您的電腦已加入網域，而且用於保護 AD FS 配接器與 Multi-Factor Authentication 服務間通訊的 Active Directory 組態尚未完成。</span><span class="sxs-lookup"><span data-stu-id="73265-136">Your computer is joined to a domain, and the Active Directory configuration for securing communication between the AD FS adapter and the Multi-Factor Authentication service is incomplete.</span></span> <span data-ttu-id="73265-137">按 [下一步] 自動完成此設定，或選取 [略過自動 Active Directory 設定並手動進行設定] 核取方塊。</span><span class="sxs-lookup"><span data-stu-id="73265-137">Click **Next** to automatically complete this configuration, or select the **Skip automatic Active Directory configuration and configure settings manually** check box.</span></span> <span data-ttu-id="73265-138">按一下 [下一步] 。</span><span class="sxs-lookup"><span data-stu-id="73265-138">Click **Next**.</span></span>
6. <span data-ttu-id="73265-139">如果顯示 [本機群組] 視窗，這代表兩件事情。</span><span class="sxs-lookup"><span data-stu-id="73265-139">If the Local Group windows is displayed, that means two things.</span></span> <span data-ttu-id="73265-140">您的電腦未加入網域，而且用於保護 AD FS 配接器與 Multi-Factor Authentication 服務間通訊的本機群組組態尚未完成。</span><span class="sxs-lookup"><span data-stu-id="73265-140">Your computer is not joined to a domain, and the local group configuration for securing communication between the AD FS adapter and the Multi-Factor Authentication service is incomplete.</span></span> <span data-ttu-id="73265-141">按 [下一步] 自動完成此設定，或選取 [略過自動本機群組設定並手動進行設定] 核取方塊。</span><span class="sxs-lookup"><span data-stu-id="73265-141">Click **Next** to automatically complete this configuration, or select the **Skip automatic Local Group configuration and configure settings manually** check box.</span></span> <span data-ttu-id="73265-142">按一下 [下一步] 。</span><span class="sxs-lookup"><span data-stu-id="73265-142">Click **Next**.</span></span>
7. <span data-ttu-id="73265-143">在安裝精靈中按 [下一步] 。</span><span class="sxs-lookup"><span data-stu-id="73265-143">In the installation wizard, click **Next**.</span></span> <span data-ttu-id="73265-144">Azure Multi-Factor Authentication Server 會建立 PhoneFactor Admins 群組並將 AD FS 服務帳戶加入至 PhoneFactor Admins 群組。</span><span class="sxs-lookup"><span data-stu-id="73265-144">Azure Multi-Factor Authentication Server creates the PhoneFactor Admins group and adds the AD FS service account to the PhoneFactor Admins group.</span></span>
   <span data-ttu-id="73265-145"><center>![雲端](./media/multi-factor-authentication-get-started-adfs-w2k12/adapter.png)</center></span><span class="sxs-lookup"><span data-stu-id="73265-145"><center>![Cloud](./media/multi-factor-authentication-get-started-adfs-w2k12/adapter.png)</center></span></span>
8. <span data-ttu-id="73265-146">在 [啟動安裝程式] 頁面上，按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="73265-146">On the **Launch Installer** page, click **Next**.</span></span>
9. <span data-ttu-id="73265-147">在 Multi-Factor Authentication AD FS 配接器安裝程式中，按 [下一步] 。</span><span class="sxs-lookup"><span data-stu-id="73265-147">In the Multi-Factor Authentication AD FS adapter installer, click **Next**.</span></span>
10. <span data-ttu-id="73265-148">在安裝完成時按一下 [關閉]  。</span><span class="sxs-lookup"><span data-stu-id="73265-148">Click **Close** when the installation is finished.</span></span>
11. <span data-ttu-id="73265-149">現已安裝配接器，您必須向 AD FS 進行登錄。</span><span class="sxs-lookup"><span data-stu-id="73265-149">When the adapter has been installed, you must register it with AD FS.</span></span> <span data-ttu-id="73265-150">開啟 Windows PowerShell 並執行下列命令：</span><span class="sxs-lookup"><span data-stu-id="73265-150">Open Windows PowerShell and run the following command:</span></span><br><span data-ttu-id="73265-151">
    `C:\Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1`
    <center>![雲端](./media/multi-factor-authentication-get-started-adfs-w2k12/pshell.png)</center></span><span class="sxs-lookup"><span data-stu-id="73265-151">
`C:\Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1`
<center>![Cloud](./media/multi-factor-authentication-get-started-adfs-w2k12/pshell.png)</center></span></span>
12. <span data-ttu-id="73265-152">若要使用最近登錄的配接器，請編輯 AD FS 中的通用驗證原則。</span><span class="sxs-lookup"><span data-stu-id="73265-152">To use your newly registered adapter, edit the global authentication policy in AD FS.</span></span> <span data-ttu-id="73265-153">在 AD FS 管理主控台中，移至 [驗證原則]  節點。</span><span class="sxs-lookup"><span data-stu-id="73265-153">In the AD FS management console, go to the **Authentication Policies** node.</span></span> <span data-ttu-id="73265-154">在 [Multi-Factor Authentication] 區段中，按一下 [全域設定] 區段旁邊的 [編輯] 連結。</span><span class="sxs-lookup"><span data-stu-id="73265-154">In the **Multi-factor Authentication** section, click the **Edit** link next to the **Global Settings** section.</span></span> <span data-ttu-id="73265-155">在 [編輯通用驗證原則] 視窗中，選取 [Multi-Factor Authentication] 作為其他驗證方法，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="73265-155">In the **Edit Global Authentication Policy** window, select **Multi-Factor Authentication** as an additional authentication method, and then click **OK**.</span></span> <span data-ttu-id="73265-156">此配接器會登錄為 WindowsAzureMultiFactorAuthentication。</span><span class="sxs-lookup"><span data-stu-id="73265-156">The adapter is registered as WindowsAzureMultiFactorAuthentication.</span></span> <span data-ttu-id="73265-157">重新啟動 AD FS 服務，以讓登錄生效。</span><span class="sxs-lookup"><span data-stu-id="73265-157">Restart the AD FS service for the registration to take effect.</span></span>

<span data-ttu-id="73265-158"><center>![雲端](./media/multi-factor-authentication-get-started-adfs-w2k12/global.png)</center></span><span class="sxs-lookup"><span data-stu-id="73265-158"><center>![Cloud](./media/multi-factor-authentication-get-started-adfs-w2k12/global.png)</center></span></span>

<span data-ttu-id="73265-159">此時，Multi-Factor Authentication Server 已設定為要搭配 AD FS 使用的其他驗證提供者。</span><span class="sxs-lookup"><span data-stu-id="73265-159">At this point, Multi-Factor Authentication Server is set up to be an additional authentication provider to use with AD FS.</span></span>

## <a name="install-a-standalone-instance-of-the-ad-fs-adapter-by-using-the-web-service-sdk"></a><span data-ttu-id="73265-160">使用 Web 服務 SDK 安裝 AD FS 配接器的獨立執行個體</span><span class="sxs-lookup"><span data-stu-id="73265-160">Install a standalone instance of the AD FS adapter by using the Web Service SDK</span></span>
1. <span data-ttu-id="73265-161">在執行 Multi-Factor Authentication Server 的伺服器上安裝 Web 服務 SDK。</span><span class="sxs-lookup"><span data-stu-id="73265-161">Install the Web Service SDK on the server that is running Multi-Factor Authentication Server.</span></span>
2. <span data-ttu-id="73265-162">從 \Program Files\Multi-Authentication Server 目錄將下列檔案複製到您計劃安裝 AD FS 配接器的伺服器︰</span><span class="sxs-lookup"><span data-stu-id="73265-162">Copy the following files from the \Program Files\Multi-Factor Authentication Server directory to the server on which you plan to install the AD FS adapter:</span></span>
   * <span data-ttu-id="73265-163">MultiFactorAuthenticationAdfsAdapterSetup64.msi</span><span class="sxs-lookup"><span data-stu-id="73265-163">MultiFactorAuthenticationAdfsAdapterSetup64.msi</span></span>
   * <span data-ttu-id="73265-164">Register-MultiFactorAuthenticationAdfsAdapter.ps1</span><span class="sxs-lookup"><span data-stu-id="73265-164">Register-MultiFactorAuthenticationAdfsAdapter.ps1</span></span>
   * <span data-ttu-id="73265-165">Unregister-MultiFactorAuthenticationAdfsAdapter.ps1</span><span class="sxs-lookup"><span data-stu-id="73265-165">Unregister-MultiFactorAuthenticationAdfsAdapter.ps1</span></span>
   * <span data-ttu-id="73265-166">MultiFactorAuthenticationAdfsAdapter.config</span><span class="sxs-lookup"><span data-stu-id="73265-166">MultiFactorAuthenticationAdfsAdapter.config</span></span>
3. <span data-ttu-id="73265-167">執行 MultiFactorAuthenticationAdfsAdapterSetup64.msi 安裝檔案。</span><span class="sxs-lookup"><span data-stu-id="73265-167">Run the MultiFactorAuthenticationAdfsAdapterSetup64.msi installation file.</span></span>
4. <span data-ttu-id="73265-168">在 Multi-Factor Authentication AD FS 配接器安裝程式中，按 [下一步]  來啟動安裝。</span><span class="sxs-lookup"><span data-stu-id="73265-168">In the Multi-Factor Authentication AD FS adapter installer, click **Next** to start the installation.</span></span>
5. <span data-ttu-id="73265-169">在安裝完成時按一下 [關閉]  。</span><span class="sxs-lookup"><span data-stu-id="73265-169">Click **Close** when the installation is finished.</span></span>

## <a name="edit-the-multifactorauthenticationadfsadapterconfig-file"></a><span data-ttu-id="73265-170">編輯 MultiFactorAuthenticationAdfsAdapter.config 檔案</span><span class="sxs-lookup"><span data-stu-id="73265-170">Edit the MultiFactorAuthenticationAdfsAdapter.config file</span></span>
<span data-ttu-id="73265-171">請遵循下列步驟來編輯 MultiFactorAuthenticationAdfsAdapter.config 檔案：</span><span class="sxs-lookup"><span data-stu-id="73265-171">Follow these steps to edit the MultiFactorAuthenticationAdfsAdapter.config file:</span></span>

1. <span data-ttu-id="73265-172">將 **UseWebServiceSdk** 節點設定為 **true**。</span><span class="sxs-lookup"><span data-stu-id="73265-172">Set the **UseWebServiceSdk** node to **true**.</span></span>  
2. <span data-ttu-id="73265-173">將 **WebServiceSdkUrl** 的值設定為 Multi-Factor Authentication Web 服務 SDK 的 URL。</span><span class="sxs-lookup"><span data-stu-id="73265-173">Set the value for **WebServiceSdkUrl** to the URL of the Multi-Factor Authentication Web Service SDK.</span></span> <span data-ttu-id="73265-174">例如︰*https://contoso.com/&lt;certificatename&gt;/MultiFactorAuthWebServiceSdk/PfWsSdk.asmx*，其中 *certificatename* 是您的憑證名稱。</span><span class="sxs-lookup"><span data-stu-id="73265-174">For example:  *https://contoso.com/&lt;certificatename&gt;/MultiFactorAuthWebServiceSdk/PfWsSdk.asmx*, Where *certificatename* is the name of your certificate.</span></span>  
3. <span data-ttu-id="73265-175">編輯 Register-MultiFactorAuthenticationAdfsAdapter.ps1 指令碼，將 -ConfigurationFilePath &lt;path&gt; 新增至 `Register-AdfsAuthenticationProvider` 命令的結尾，其中 &lt;path&gt; 是 MultiFactorAuthenticationAdfsAdapter.config 檔案的完整路徑。</span><span class="sxs-lookup"><span data-stu-id="73265-175">Edit the Register-MultiFactorAuthenticationAdfsAdapter.ps1 script by adding *-ConfigurationFilePath &lt;path&gt;* to the end of the `Register-AdfsAuthenticationProvider` command, where *&lt;path&gt;* is the full path to the MultiFactorAuthenticationAdfsAdapter.config file.</span></span>

### <a name="configure-the-web-service-sdk-with-a-username-and-password"></a><span data-ttu-id="73265-176">以使用者名稱和密碼設定 Web 服務 SDK</span><span class="sxs-lookup"><span data-stu-id="73265-176">Configure the Web Service SDK with a username and password</span></span>
<span data-ttu-id="73265-177">有兩個選項可供設定 Web 服務 SDK。</span><span class="sxs-lookup"><span data-stu-id="73265-177">There are two options for configuring the Web Service SDK.</span></span> <span data-ttu-id="73265-178">第一個是利用使用者名稱和密碼，第二個是利用用戶端憑證。</span><span class="sxs-lookup"><span data-stu-id="73265-178">The first is with a username and password, the second is with a client certificate.</span></span> <span data-ttu-id="73265-179">若要使用第一個選項，請遵循下列步驟，或加以略過直接跳到第二個選項。</span><span class="sxs-lookup"><span data-stu-id="73265-179">Follow these steps for the first option, or skip ahead for the second.</span></span>  

1. <span data-ttu-id="73265-180">將 **WebServiceSdkUsername** 的值設定為屬於 PhoneFactor Admins 安全性群組的帳戶。</span><span class="sxs-lookup"><span data-stu-id="73265-180">Set the value for **WebServiceSdkUsername** to an account that is a member of the PhoneFactor Admins security group.</span></span> <span data-ttu-id="73265-181">使用 &lt;網域&gt;&#92;&lt;使用者名稱&gt; 格式。</span><span class="sxs-lookup"><span data-stu-id="73265-181">Use the &lt;domain&gt;&#92;&lt;user name&gt; format.</span></span>  
2. <span data-ttu-id="73265-182">將 **WebServiceSdkPassword** 的值設定為適當的帳戶密碼。</span><span class="sxs-lookup"><span data-stu-id="73265-182">Set the value for **WebServiceSdkPassword** to the appropriate account password.</span></span>

### <a name="configure-the-web-service-sdk-with-a-client-certificate"></a><span data-ttu-id="73265-183">以用戶端憑證設定 Web 服務 SDK</span><span class="sxs-lookup"><span data-stu-id="73265-183">Configure the Web Service SDK with a client certificate</span></span>
<span data-ttu-id="73265-184">如果您不想要使用使用者名稱和密碼，請遵循下列步驟來以用戶端憑證設定 Web 服務 SDK。</span><span class="sxs-lookup"><span data-stu-id="73265-184">If you don't want to use a username and password, follow these steps to configure the Web Service SDK with a client certificate.</span></span>

1. <span data-ttu-id="73265-185">從執行 Web 服務 SDK 之伺服器的憑證授權單位取得用戶端憑證。</span><span class="sxs-lookup"><span data-stu-id="73265-185">Obtain a client certificate from a certificate authority for the server that is running the Web Service SDK.</span></span> <span data-ttu-id="73265-186">了解如何 [取得用戶端憑證](https://technet.microsoft.com/library/cc770328.aspx)。</span><span class="sxs-lookup"><span data-stu-id="73265-186">Learn how to [obtain client certificates](https://technet.microsoft.com/library/cc770328.aspx).</span></span>  
2. <span data-ttu-id="73265-187">將用戶端憑證匯入執行 Web 服務 SDK 的伺服器上的本機電腦個人憑證存放區。</span><span class="sxs-lookup"><span data-stu-id="73265-187">Import the client certificate to the local computer personal certificate store on the server that is running the Web Service SDK.</span></span> <span data-ttu-id="73265-188">請確定憑證授權單位的公開憑證是在受信任的根憑證存放區中。</span><span class="sxs-lookup"><span data-stu-id="73265-188">Make sure that the certificate authority's public certificate is in Trusted Root Certificates certificate store.</span></span>  
3. <span data-ttu-id="73265-189">將用戶端憑證的公開和私密金鑰匯出至 .pfx 檔案。</span><span class="sxs-lookup"><span data-stu-id="73265-189">Export the public and private keys of the client certificate to a .pfx file.</span></span>  
4. <span data-ttu-id="73265-190">將 Base64 格式的公開金鑰匯出至 .cer 檔案。</span><span class="sxs-lookup"><span data-stu-id="73265-190">Export the public key in Base64 format to a .cer file.</span></span>  
5. <span data-ttu-id="73265-191">在 [伺服器管理員] 中，確認已安裝網頁伺服器 (IIS)\網頁伺服器\安全性\IIS 用戶端憑證對應驗證功能。</span><span class="sxs-lookup"><span data-stu-id="73265-191">In Server Manager, verify that the Web Server (IIS)\Web Server\Security\IIS Client Certificate Mapping Authentication feature is installed.</span></span> <span data-ttu-id="73265-192">如果未安裝，請選擇 [新增角色及功能]  來新增此功能。</span><span class="sxs-lookup"><span data-stu-id="73265-192">If it is not installed, select **Add Roles and Features** to add this feature.</span></span>  
6. <span data-ttu-id="73265-193">在 [IIS 管理員] 中，按兩下包含 Web 服務 SDK 虛擬目錄之網站中的 [設定編輯器]  。</span><span class="sxs-lookup"><span data-stu-id="73265-193">In IIS Manager, double-click **Configuration Editor** in the website that contains the Web Service SDK virtual directory.</span></span> <span data-ttu-id="73265-194">請務必選取網站，而非虛擬目錄。</span><span class="sxs-lookup"><span data-stu-id="73265-194">It is important to select the website, not the virtual directory.</span></span>  
7. <span data-ttu-id="73265-195">移至 **system.webServer/security/authentication/iisClientCertificateMappingAuthentication** 區段。</span><span class="sxs-lookup"><span data-stu-id="73265-195">Go to the **system.webServer/security/authentication/iisClientCertificateMappingAuthentication** section.</span></span>  
8. <span data-ttu-id="73265-196">將 enabled 設定為 **true**。</span><span class="sxs-lookup"><span data-stu-id="73265-196">Set enabled to **true**.</span></span>  
9. <span data-ttu-id="73265-197">將 oneToOneCertificateMappingsEnabled 設定為 **true**。</span><span class="sxs-lookup"><span data-stu-id="73265-197">Set oneToOneCertificateMappingsEnabled to **true**.</span></span>  
10. <span data-ttu-id="73265-198">按一下 oneToOneMappings 旁邊的 [...] 按鈕，然後按一下 [新增] 連結。</span><span class="sxs-lookup"><span data-stu-id="73265-198">Click the **...** button next to oneToOneMappings, and then click the **Add** link.</span></span>  
11. <span data-ttu-id="73265-199">開啟稍早匯出的 Base64 .cer 檔案。</span><span class="sxs-lookup"><span data-stu-id="73265-199">Open the Base64 .cer file you exported earlier.</span></span> <span data-ttu-id="73265-200">移除 *-----BEGIN CERTIFICATE-----*、*-----END CERTIFICATE-----*，以及任何分行符號。</span><span class="sxs-lookup"><span data-stu-id="73265-200">Remove *-----BEGIN CERTIFICATE-----*, *-----END CERTIFICATE-----*, and any line breaks.</span></span> <span data-ttu-id="73265-201">複製產生的字串。</span><span class="sxs-lookup"><span data-stu-id="73265-201">Copy the resulting string.</span></span>  
12. <span data-ttu-id="73265-202">將 certificate 設定為在上一個步驟中複製的字串。</span><span class="sxs-lookup"><span data-stu-id="73265-202">Set certificate to the string copied in the preceding step.</span></span>  
13. <span data-ttu-id="73265-203">將 enabled 設定為 **true**。</span><span class="sxs-lookup"><span data-stu-id="73265-203">Set enabled to **true**.</span></span>  
14. <span data-ttu-id="73265-204">將 userName 設定為屬於 PhoneFactor Admins 安全性群組成員的帳戶。</span><span class="sxs-lookup"><span data-stu-id="73265-204">Set userName to an account that is a member of the PhoneFactor Admins security group.</span></span> <span data-ttu-id="73265-205">使用 &lt;網域&gt;&#92;&lt;使用者名稱&gt; 格式。</span><span class="sxs-lookup"><span data-stu-id="73265-205">Use the &lt;domain&gt;&#92;&lt;user name&gt; format.</span></span>  
15. <span data-ttu-id="73265-206">將密碼設定為適當的帳戶密碼，然後關閉 [設定編輯器]。</span><span class="sxs-lookup"><span data-stu-id="73265-206">Set the password to the appropriate account password, and then close Configuration Editor.</span></span>  
16. <span data-ttu-id="73265-207">按一下 [套用]  連結。</span><span class="sxs-lookup"><span data-stu-id="73265-207">Click the **Apply** link.</span></span>  
17. <span data-ttu-id="73265-208">在 Web 服務 SDK 虛擬目錄中，按兩下 [驗證] 。</span><span class="sxs-lookup"><span data-stu-id="73265-208">In the Web Service SDK virtual directory, double-click **Authentication**.</span></span>  
18. <span data-ttu-id="73265-209">確認 [ASP.NET 模擬] 和 [基本驗證] 已設為 [已啟用]，而所有其他項目則已設為 [已停用]。</span><span class="sxs-lookup"><span data-stu-id="73265-209">Verify that ASP.NET Impersonation and Basic Authentication are set to **Enabled**, and that all other items are set to **Disabled**.</span></span>  
19. <span data-ttu-id="73265-210">在 Web 服務 SDK 虛擬目錄中，按兩下 [SSL 設定] 。</span><span class="sxs-lookup"><span data-stu-id="73265-210">In the Web Service SDK virtual directory, double-click **SSL Settings**.</span></span>  
20. <span data-ttu-id="73265-211">將 [用戶端憑證] 設定為 [接受]，然後按一下 [套用]。</span><span class="sxs-lookup"><span data-stu-id="73265-211">Set Client Certificates to **Accept**, and then click **Apply**.</span></span>  
21. <span data-ttu-id="73265-212">將稍早匯出的 .pfx 檔案複製到執行 AD FS 配接器的伺服器。</span><span class="sxs-lookup"><span data-stu-id="73265-212">Copy the .pfx file you exported earlier to the server that is running the AD FS adapter.</span></span>  
22. <span data-ttu-id="73265-213">將 .pfx 檔案匯入至本機電腦個人憑證存放區。</span><span class="sxs-lookup"><span data-stu-id="73265-213">Import the .pfx file to the local computer personal certificate store.</span></span>  
23. <span data-ttu-id="73265-214">按一下滑鼠右鍵並選取 [管理私密金鑰] ，然後將讀取權授與用來登入 AD FS 服務的帳戶。</span><span class="sxs-lookup"><span data-stu-id="73265-214">Right-click and select **Manage Private Keys**, and then grant read access to the account you used to sign in to the AD FS service.</span></span>  
24. <span data-ttu-id="73265-215">開啟用戶端憑證，並從 [詳細資料]  索引標籤複製憑證指紋。</span><span class="sxs-lookup"><span data-stu-id="73265-215">Open the client certificate and copy the thumbprint from the **Details** tab.</span></span>  
25. <span data-ttu-id="73265-216">在 MultiFactorAuthenticationAdfsAdapter.config 檔案中，將 **WebServiceSdkCertificateThumbprint** 設定為在上一個步驟中複製的字串。</span><span class="sxs-lookup"><span data-stu-id="73265-216">In the MultiFactorAuthenticationAdfsAdapter.config file, set **WebServiceSdkCertificateThumbprint** to the string copied in the previous step.</span></span>  

<span data-ttu-id="73265-217">最後，若要登錄配接器，請在 PowerShell 中執行 \Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1 指令碼。</span><span class="sxs-lookup"><span data-stu-id="73265-217">Finally, to register the adapter, run the \Program Files\Multi-Factor Authentication Server\Register-MultiFactorAuthenticationAdfsAdapter.ps1 script in PowerShell.</span></span> <span data-ttu-id="73265-218">此配接器會登錄為 WindowsAzureMultiFactorAuthentication。</span><span class="sxs-lookup"><span data-stu-id="73265-218">The adapter is registered as WindowsAzureMultiFactorAuthentication.</span></span> <span data-ttu-id="73265-219">重新啟動 AD FS 服務，以讓登錄生效。</span><span class="sxs-lookup"><span data-stu-id="73265-219">Restart the AD FS service for the registration to take effect.</span></span>

## <a name="secure-azure-ad-resources-using-ad-fs"></a><span data-ttu-id="73265-220">使用 AD FS 保護 Azure AD 資源</span><span class="sxs-lookup"><span data-stu-id="73265-220">Secure Azure AD resources using AD FS</span></span>
<span data-ttu-id="73265-221">若要保護雲端資源，請設定宣告規則，以便在使用者成功執行雙步驟驗證時，Active Directory Federation Services 會發出 multipleauthn 宣告。</span><span class="sxs-lookup"><span data-stu-id="73265-221">To secure your cloud resource, set up a claims rule so that Active Directory Federation Services emits the multipleauthn claim when a user performs two-step verification successfully.</span></span> <span data-ttu-id="73265-222">此宣告會傳遞至 Azure AD。</span><span class="sxs-lookup"><span data-stu-id="73265-222">This claim is passed on to Azure AD.</span></span> <span data-ttu-id="73265-223">遵循此程序來逐步執行各個步驟︰</span><span class="sxs-lookup"><span data-stu-id="73265-223">Follow this procedure to walk through the steps:</span></span>

1. <span data-ttu-id="73265-224">開啟 [AD FS 管理]。</span><span class="sxs-lookup"><span data-stu-id="73265-224">Open AD FS Management.</span></span>
2. <span data-ttu-id="73265-225">在左側選取 [信賴憑證者信任]。</span><span class="sxs-lookup"><span data-stu-id="73265-225">On the left, select **Relying Party Trusts**.</span></span>
3. <span data-ttu-id="73265-226">以滑鼠右鍵按一下 [Microsoft Office 365 身分識別平台]，然後選取 [編輯宣告規則...]</span><span class="sxs-lookup"><span data-stu-id="73265-226">Right-click on **Microsoft Office 365 Identity Platform** and select **Edit Claim Rules…**</span></span>

   ![雲端](./media/multi-factor-authentication-get-started-adfs-cloud/trustedip1.png)

4. <span data-ttu-id="73265-228">在 [發佈轉換規則] 上，按一下 [新增規則]</span><span class="sxs-lookup"><span data-stu-id="73265-228">On Issuance Transform Rules, click **Add Rule.**</span></span>

   ![雲端](./media/multi-factor-authentication-get-started-adfs-cloud/trustedip2.png)

5. <span data-ttu-id="73265-230">在 [新增轉換宣告規則精靈] 上，從下拉式清單選取 [通過或篩選傳入宣告]，然後按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="73265-230">On the Add Transform Claim Rule Wizard, select **Pass Through or Filter an Incoming Claim** from the drop-down and click **Next**.</span></span>

   ![雲端](./media/multi-factor-authentication-get-started-adfs-cloud/trustedip3.png)

6. <span data-ttu-id="73265-232">指定規則的名稱。</span><span class="sxs-lookup"><span data-stu-id="73265-232">Give your rule a name.</span></span>
7. <span data-ttu-id="73265-233">選取 [驗證方法參考] 做為傳入宣告類型。</span><span class="sxs-lookup"><span data-stu-id="73265-233">Select **Authentication Methods References** as the Incoming claim type.</span></span>
8. <span data-ttu-id="73265-234">選取 [傳遞所有宣告值]。</span><span class="sxs-lookup"><span data-stu-id="73265-234">Select **Pass through all claim values**.</span></span>
    <span data-ttu-id="73265-235">![新增轉換宣告規則精靈](./media/multi-factor-authentication-get-started-adfs-cloud/configurewizard.png)</span><span class="sxs-lookup"><span data-stu-id="73265-235">![Add Transform Claim Rule Wizard](./media/multi-factor-authentication-get-started-adfs-cloud/configurewizard.png)</span></span>
9. <span data-ttu-id="73265-236">按一下 [完成]。</span><span class="sxs-lookup"><span data-stu-id="73265-236">Click **Finish**.</span></span> <span data-ttu-id="73265-237">關閉 AD FS 管理主控台。</span><span class="sxs-lookup"><span data-stu-id="73265-237">Close the AD FS Management console.</span></span>

## <a name="related-topics"></a><span data-ttu-id="73265-238">相關主題</span><span class="sxs-lookup"><span data-stu-id="73265-238">Related topics</span></span>
<span data-ttu-id="73265-239">如需疑難排解說明，請參閱 [Azure Multi-Factor Authentication 常見問題集](multi-factor-authentication-faq.md)</span><span class="sxs-lookup"><span data-stu-id="73265-239">For troubleshooting help, see the [Azure Multi-Factor Authentication FAQs](multi-factor-authentication-faq.md)</span></span>
