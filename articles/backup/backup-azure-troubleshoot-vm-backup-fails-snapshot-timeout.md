---
title: "針對 Azure 備份失敗：無法使用客體代理程式狀態進行疑難排解 | Microsoft Docs"
description: "與「無法與 VM 代理程式通訊」錯誤相關之 Azure 備份失敗的徵狀、原因和解決方案"
services: backup
documentationcenter: 
author: genlin
manager: cshepard
editor: 
keywords: "Azure 備份; VM 代理程式; 網路連線;"
ms.assetid: 4b02ffa4-c48e-45f6-8363-73d536be4639
ms.service: backup
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/17/2017
ms.author: genli;markgal;
ms.openlocfilehash: 6ed651bb8caafd18cec93e68ac70e27f92133e5c
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/18/2017
---
# <a name="troubleshoot-azure-backup-failure-issues-with-agent-andor-extension"></a><span data-ttu-id="b1e6f-104">針對 Azure 備份失敗進行疑難排解：與代理程式和/或擴充功能相關的問題</span><span class="sxs-lookup"><span data-stu-id="b1e6f-104">Troubleshoot Azure Backup failure: Issues with agent and/or extension</span></span>

<span data-ttu-id="b1e6f-105">本文提供疑難排解步驟，協助您解決與 VM 代理程式和擴充功能通訊問題相關的備份失敗。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-105">This article provides troubleshooting steps to help you resolve Backup failures related to problems in communication with VM agent and extension.</span></span>

[!INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

## <a name="vm-agent-unable-to-communicate-with-azure-backup"></a><span data-ttu-id="b1e6f-106">VM 代理程式無法與 Azure 備份通訊</span><span class="sxs-lookup"><span data-stu-id="b1e6f-106">VM Agent unable to communicate with Azure Backup</span></span>
<span data-ttu-id="b1e6f-107">在註冊及排程 Azure 備份服務的 VM 之後，備份就會藉由與 VM 代理程式通訊以取得時間點快照，來起始作業。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-107">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM agent to take a point-in-time snapshot.</span></span> <span data-ttu-id="b1e6f-108">下列任一種狀況都可能會阻止觸發快照，接著導致備份失敗。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-108">Any of the following conditions might prevent the snapshot from being triggered, which in turn can lead to Backup failure.</span></span> <span data-ttu-id="b1e6f-109">請遵循下列疑難排解步驟中指定的順序，然後重試作業。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-109">Follow below troubleshooting steps in the given order and retry your operation.</span></span>
##### <a name="cause-1-the-vm-has-no-internet-accessthe-vm-has-no-internet-access"></a><span data-ttu-id="b1e6f-110">原因 1：[VM 沒有網際網路存取權](#the-vm-has-no-internet-access)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-110">Cause 1: [The VM has no Internet access](#the-vm-has-no-internet-access)</span></span>
##### <a name="cause-2-the-agent-is-installed-in-the-vm-but-is-unresponsive-for-windows-vmsthe-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="b1e6f-111">原因 2：[代理程式已安裝到 VM 中，但沒有回應 (適用於 Windows VM)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-111">Cause 2: [The agent is installed in the VM but is unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span></span>
##### <a name="cause-3-the-agent-installed-in-the-vm-is-out-of-date-for-linux-vmsthe-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="b1e6f-112">原因 3︰[VM 中安裝的代理程式已過時 (針對 Linux VM)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-112">Cause 3: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span></span>
##### <a name="cause-4-the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-takenthe-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="b1e6f-113">原因 4︰[無法擷取快照集狀態或無法取得快照集](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-113">Cause 4: [The snapshot status cannot be retrieved or a snapshot cannot be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span></span>
##### <a name="cause-5-the-backup-extension-fails-to-update-or-loadthe-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="b1e6f-114">原因 5︰[備份擴充功能無法更新或載入](#the-backup-extension-fails-to-update-or-load)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-114">Cause 5: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)</span></span>

## <a name="snapshot-operation-failed-due-to-no-network-connectivity-on-the-virtual-machine"></a><span data-ttu-id="b1e6f-115">因為虛擬機器沒有網路連線，所以快照集作業失敗</span><span class="sxs-lookup"><span data-stu-id="b1e6f-115">Snapshot operation failed due to no network connectivity on the virtual machine</span></span>
<span data-ttu-id="b1e6f-116">在註冊及排程 Azure 備份服務的 VM 之後，備份就會藉由與 VM 備份擴充功能通訊以取得時間點快照，來起始作業。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-116">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="b1e6f-117">下列任一種狀況都可能會阻止觸發快照，接著導致備份失敗。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-117">Any of the following conditions might prevent the snapshot from being triggered, which in turn can lead to Backup failure.</span></span> <span data-ttu-id="b1e6f-118">請遵循下列疑難排解步驟中指定的順序，然後重試作業。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-118">Follow below troubleshooting steps in the given order and retry your operation.</span></span>
##### <a name="cause-1-the-vm-has-no-internet-accessthe-vm-has-no-internet-access"></a><span data-ttu-id="b1e6f-119">原因 1：[VM 沒有網際網路存取權](#the-vm-has-no-internet-access)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-119">Cause 1: [The VM has no Internet access](#the-vm-has-no-internet-access)</span></span>
##### <a name="cause-2-the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-takenthe-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="b1e6f-120">原因 2︰[無法擷取快照集狀態或無法取得快照集](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-120">Cause 2: [The snapshot status cannot be retrieved or a snapshot cannot be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span></span>
##### <a name="cause-3-the-backup-extension-fails-to-update-or-loadthe-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="b1e6f-121">原因 3︰[備份擴充功能無法更新或載入](#the-backup-extension-fails-to-update-or-load)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-121">Cause 3: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)</span></span>

## <a name="vmsnapshot-extension-operation-failed"></a><span data-ttu-id="b1e6f-122">VMSnapshot 擴充作業失敗</span><span class="sxs-lookup"><span data-stu-id="b1e6f-122">VMSnapshot extension operation failed</span></span>

<span data-ttu-id="b1e6f-123">在註冊及排程 Azure 備份服務的 VM 之後，備份就會藉由與 VM 備份擴充功能通訊以取得時間點快照，來起始作業。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-123">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="b1e6f-124">下列任一種狀況都可能會阻止觸發快照，接著導致備份失敗。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-124">Any of the following conditions might prevent the snapshot from being triggered, which in turn can lead to Backup failure.</span></span> <span data-ttu-id="b1e6f-125">請遵循下列疑難排解步驟中指定的順序，然後重試作業。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-125">Follow below troubleshooting steps in the given order and retry your operation.</span></span>
##### <a name="cause-1-the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-takenthe-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="b1e6f-126">原因 1︰[無法擷取快照集狀態或無法取得快照集](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-126">Cause 1: [The snapshot status cannot be retrieved or a snapshot cannot be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span></span>
##### <a name="cause-2-the-backup-extension-fails-to-update-or-loadthe-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="b1e6f-127">原因 2︰[備份擴充功能無法更新或載入](#the-backup-extension-fails-to-update-or-load)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-127">Cause 2: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)</span></span>
##### <a name="cause-3-the-vm-has-no-internet-accessthe-vm-has-no-internet-access"></a><span data-ttu-id="b1e6f-128">原因 3：[VM 沒有網際網路存取權](#the-vm-has-no-internet-access)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-128">Cause 3: [The VM has no Internet access](#the-vm-has-no-internet-access)</span></span>
##### <a name="cause-4-the-agent-is-installed-in-the-vm-but-is-unresponsive-for-windows-vmsthe-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="b1e6f-129">原因 4：[代理程式已安裝到 VM 中，但沒有回應 (適用於 Windows VM)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-129">Cause 4: [The agent is installed in the VM but is unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span></span>
##### <a name="cause-5-the-agent-installed-in-the-vm-is-out-of-date-for-linux-vmsthe-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="b1e6f-130">原因 5︰[VM 中安裝的代理程式已過時 (針對 Linux VM)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-130">Cause 5: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span></span>

## <a name="unable-to-perform-the-operation-as-the-vm-agent-is-not-responsive"></a><span data-ttu-id="b1e6f-131">無法執行操作，因為 VM 代理程式沒有回應</span><span class="sxs-lookup"><span data-stu-id="b1e6f-131">Unable to perform the operation as the VM Agent is not responsive</span></span>

<span data-ttu-id="b1e6f-132">在註冊及排程 Azure 備份服務的 VM 之後，備份就會藉由與 VM 備份擴充功能通訊以取得時間點快照，來起始作業。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-132">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="b1e6f-133">下列任一種狀況都可能會阻止觸發快照，接著導致備份失敗。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-133">Any of the following conditions might prevent the snapshot from being triggered, which in turn can lead to Backup failure.</span></span> <span data-ttu-id="b1e6f-134">請遵循下列疑難排解步驟中指定的順序，然後重試作業。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-134">Follow below troubleshooting steps in the given order and retry your operation.</span></span>
##### <a name="cause-1-the-agent-is-installed-in-the-vm-but-is-unresponsive-for-windows-vmsthe-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="b1e6f-135">原因 1：[代理程式已安裝到 VM 中，但沒有回應 (適用於 Windows VM)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-135">Cause 1: [The agent is installed in the VM but is unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span></span>
##### <a name="cause-2-the-agent-installed-in-the-vm-is-out-of-date-for-linux-vmsthe-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="b1e6f-136">原因 2︰[VM 中安裝的代理程式已過時 (針對 Linux VM)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-136">Cause 2: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span></span>
##### <a name="cause-3-the-vm-has-no-internet-accessthe-vm-has-no-internet-access"></a><span data-ttu-id="b1e6f-137">原因 3：[VM 沒有網際網路存取權](#the-vm-has-no-internet-access)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-137">Cause 3: [The VM has no Internet access](#the-vm-has-no-internet-access)</span></span>

## <a name="backup-failed-with-an-internal-error---please-retry-the-operation-in-a-few-minutes"></a><span data-ttu-id="b1e6f-138">備份因為內部錯誤而失敗 - 請在幾分鐘內重試此作業</span><span class="sxs-lookup"><span data-stu-id="b1e6f-138">Backup failed with an internal error - Please retry the operation in a few minutes</span></span>

<span data-ttu-id="b1e6f-139">在註冊及排程 Azure 備份服務的 VM 之後，備份就會藉由與 VM 備份擴充功能通訊以取得時間點快照，來起始作業。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-139">After you register and schedule a VM for the Azure Backup service, Backup initiates the job by communicating with the VM backup extension to take a point-in-time snapshot.</span></span> <span data-ttu-id="b1e6f-140">下列任一種狀況都可能會阻止觸發快照，接著導致備份失敗。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-140">Any of the following conditions might prevent the snapshot from being triggered, which in turn can lead to Backup failure.</span></span> <span data-ttu-id="b1e6f-141">請遵循下列疑難排解步驟中指定的順序，然後重試作業。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-141">Follow below troubleshooting steps in the given order and retry your operation.</span></span>
##### <a name="cause-1-the-vm-has-no-internet-accessthe-vm-has-no-internet-access"></a><span data-ttu-id="b1e6f-142">原因 1：[VM 沒有網際網路存取權](#the-vm-has-no-internet-access)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-142">Cause 1: [The VM has no Internet access](#the-vm-has-no-internet-access)</span></span>
##### <a name="cause-2-the-agent-installed-in-the-vm-but-unresponsive-for-windows-vmsthe-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="b1e6f-143">原因 2：[代理程式已安裝到 VM 中，但沒有回應 (適用於 Windows VM)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-143">Cause 2: [The agent installed in the VM but unresponsive (for Windows VMs)](#the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms)</span></span>
##### <a name="cause-3-the-agent-installed-in-the-vm-is-out-of-date-for-linux-vmsthe-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="b1e6f-144">原因 3︰[VM 中安裝的代理程式已過時 (針對 Linux VM)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-144">Cause 3: [The agent installed in the VM is out of date (for Linux VMs)](#the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms)</span></span>
##### <a name="cause-4-the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-takenthe-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="b1e6f-145">原因 4︰[無法擷取快照集狀態或無法取得快照集](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-145">Cause 4: [The snapshot status cannot be retrieved or a snapshot cannot be taken](#the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken)</span></span>
##### <a name="cause-5-the-backup-extension-fails-to-update-or-loadthe-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="b1e6f-146">原因 5︰[備份擴充功能無法更新或載入](#the-backup-extension-fails-to-update-or-load)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-146">Cause 5: [The backup extension fails to update or load](#the-backup-extension-fails-to-update-or-load)</span></span>


## <a name="causes-and-solutions"></a><span data-ttu-id="b1e6f-147">原因和解決方案</span><span class="sxs-lookup"><span data-stu-id="b1e6f-147">Causes and Solutions</span></span>

### <a name="the-vm-has-no-internet-access"></a><span data-ttu-id="b1e6f-148">VM 沒有網際網路存取權</span><span class="sxs-lookup"><span data-stu-id="b1e6f-148">The VM has no Internet access</span></span>
<span data-ttu-id="b1e6f-149">根據部署需求，VM 沒有網際網路存取權，或是有既有限制，防止存取 Azure 基礎結構。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-149">Per the deployment requirement, the VM has no Internet access, or it has restrictions in place that prevent access to the Azure infrastructure.</span></span>

<span data-ttu-id="b1e6f-150">備份擴充功能需要連線到 Azure 公用 IP 位址，才能正確運作。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-150">To function correctly, the backup extension requires connectivity to the Azure public IP addresses.</span></span> <span data-ttu-id="b1e6f-151">擴充功能會將命令傳送至 Azure 儲存體端點 (HTTP URL) 來管理 VM 的快照。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-151">The extension sends commands to an Azure Storage endpoint (HTTP URL) to manage the snapshots of the VM.</span></span> <span data-ttu-id="b1e6f-152">如果擴充功能無法存取公用網際網路，備份最終會失敗。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-152">If the extension has no access to the public Internet, Backup eventually fails.</span></span>

####  <a name="solution"></a><span data-ttu-id="b1e6f-153">方案</span><span class="sxs-lookup"><span data-stu-id="b1e6f-153">Solution</span></span>
<span data-ttu-id="b1e6f-154">若要解決此問題，請嘗試下列其中一個方法。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-154">To resolve the issue, try one of the methods listed here.</span></span>
##### <a name="allow-access-to-the-azure-datacenter-ip-ranges"></a><span data-ttu-id="b1e6f-155">允許存取 Azure 資料中心的 IP 範圍</span><span class="sxs-lookup"><span data-stu-id="b1e6f-155">Allow access to the Azure datacenter IP ranges</span></span>

1. <span data-ttu-id="b1e6f-156">取得允許存取的 [Azure 資料中心 IP 清單](https://www.microsoft.com/download/details.aspx?id=41653)。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-156">Obtain the [list of Azure datacenter IPs](https://www.microsoft.com/download/details.aspx?id=41653) to allow access to.</span></span>
2. <span data-ttu-id="b1e6f-157">在提升權限的 PowerShell 視窗中，於 Azure VM 中執行 **New-NetRoute** Cmdlet 來解除封鎖 IP。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-157">Unblock the IPs by running the **New-NetRoute** cmdlet in the Azure VM in an elevated PowerShell window.</span></span> <span data-ttu-id="b1e6f-158">以系統管理員身分執行 Cmdlet。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-158">Run the cmdlet as an administrator.</span></span>
3. <span data-ttu-id="b1e6f-159">若要允許存取 IP，可將規則新增到網路安全性群組 (如果您有一個)。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-159">To allow access to the IPs, add rules to the network security group, if you have one.</span></span>

##### <a name="create-a-path-for-http-traffic-to-flow"></a><span data-ttu-id="b1e6f-160">建立 HTTP 流量的行經路徑</span><span class="sxs-lookup"><span data-stu-id="b1e6f-160">Create a path for HTTP traffic to flow</span></span>

1. <span data-ttu-id="b1e6f-161">如果您已有網路限制 (例如，網路安全性群組)，請部署 HTTP Proxy 伺服器來路由傳送流量。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-161">If you have network restrictions in place (for example, a network security group), deploy an HTTP proxy server to route the traffic.</span></span>
2. <span data-ttu-id="b1e6f-162">若要允許從 HTTP Proxy 存取網際網路，可將規則新增到網路安全性群組 (如果您有一個)。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-162">To allow access to the Internet from the HTTP proxy server, add rules to the network security group, if you have one.</span></span>

<span data-ttu-id="b1e6f-163">若要了解如何設定 VM 備份的 HTTP Proxy，請參閱[準備環境以備份 Azure 虛擬機器](backup-azure-vms-prepare.md#using-an-http-proxy-for-vm-backups)。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-163">To learn how to set up an HTTP proxy for VM backups, see [Prepare your environment to back up Azure virtual machines](backup-azure-vms-prepare.md#using-an-http-proxy-for-vm-backups).</span></span>

<span data-ttu-id="b1e6f-164">如果您要使用受控磁碟，您可能必須在防火牆上開啟其他連接埠 (8443)。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-164">In case you are using Managed Disks, you may need an additional port (8443) opening up on the firewalls.</span></span>

### <a name="the-agent-installed-in-the-vm-but-unresponsive-for-windows-vms"></a><span data-ttu-id="b1e6f-165">代理程式已安裝到 VM 中，但沒有回應 (適用於 Windows VM)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-165">The agent installed in the VM but unresponsive (for Windows VMs)</span></span>

#### <a name="solution"></a><span data-ttu-id="b1e6f-166">方案</span><span class="sxs-lookup"><span data-stu-id="b1e6f-166">Solution</span></span>
<span data-ttu-id="b1e6f-167">VM 代理程式可能已損毀，或服務可能已停止。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-167">The VM Agent might have been corrupted or the service might have been stopped.</span></span> <span data-ttu-id="b1e6f-168">重新安裝 VM 代理程式有助於取得最新版本並重新啟動通訊。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-168">Re-installing the VM agent would help get the latest version and restart the communication.</span></span>

1. <span data-ttu-id="b1e6f-169">確認 Windows 客體代理程式服務是否在虛擬機器的服務 (services.msc) 中執行。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-169">Verify whether Windows Guest Agent service running in services (services.msc) of the Virtual Machine.</span></span> <span data-ttu-id="b1e6f-170">請嘗試重新啟動 Windows 客體代理程式服務並啟動備份</span><span class="sxs-lookup"><span data-stu-id="b1e6f-170">Try restart the Windows Guest Agent service and initiate the Backup</span></span><br>
2. <span data-ttu-id="b1e6f-171">如果在服務中看不到，請在 [程式和功能] 中確認您是否已安裝 Windows 客體代理程式服務。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-171">if it is not visible in services, verify in Programs and Features whether Windows Guest agent service is installed.</span></span>
4. <span data-ttu-id="b1e6f-172">如果您可以在 [程式和功能] 中看到，請將 Windows 客體代理程式解除安裝。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-172">If you are able to view in programs and features uninstall the Windows Guest Agent.</span></span>
5. <span data-ttu-id="b1e6f-173">下載並安裝[最新版的代理程式 MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409)。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-173">Download and install the [latest version of agent MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409).</span></span> <span data-ttu-id="b1e6f-174">您需要有系統管理員權限，才能完成安裝。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-174">You need Administrator privileges to complete the installation.</span></span>
6. <span data-ttu-id="b1e6f-175">然後，您應該就能在服務中看到 Windows 客體代理程式服務</span><span class="sxs-lookup"><span data-stu-id="b1e6f-175">Then you should be able to view Windows Guest Agent services in services</span></span>
7. <span data-ttu-id="b1e6f-176">在入口網站中按一下 [立即備份]，以嘗試執行隨選備份或臨機操作備份。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-176">Try running an on-demand/adhoc backup by clicking "Backup Now" in the portal.</span></span>

<span data-ttu-id="b1e6f-177">另請確認您的虛擬機器已**[在系統中安裝 .NET 4.5](https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed)**。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-177">Also verify your Virtual Machine has **[.NET 4.5 installed in the system](https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed)**.</span></span> <span data-ttu-id="b1e6f-178">您必須安裝此程式，VM 代理程式才能與服務通訊</span><span class="sxs-lookup"><span data-stu-id="b1e6f-178">It is required for the VM agent to communicate with the service</span></span>

### <a name="the-agent-installed-in-the-vm-is-out-of-date-for-linux-vms"></a><span data-ttu-id="b1e6f-179">VM 中安裝的代理程式已過時 (適用於 Linux VM)</span><span class="sxs-lookup"><span data-stu-id="b1e6f-179">The agent installed in the VM is out of date (for Linux VMs)</span></span>

#### <a name="solution"></a><span data-ttu-id="b1e6f-180">方案</span><span class="sxs-lookup"><span data-stu-id="b1e6f-180">Solution</span></span>
<span data-ttu-id="b1e6f-181">針對 Linux VM，與代理程式或擴充功能相關的多數失敗是由於會影響過時 VM 代理程式的問題所造成。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-181">Most agent-related or extension-related failures for Linux VMs are caused by issues that affect an outdated VM agent.</span></span> <span data-ttu-id="b1e6f-182">若要對此問題進行疑難排解，請遵循下列一般方針：</span><span class="sxs-lookup"><span data-stu-id="b1e6f-182">To troubleshoot this issue, follow these general guidelines:</span></span>

1. <span data-ttu-id="b1e6f-183">請遵循[更新 Linux VM 代理程式](../virtual-machines/linux/update-agent.md)的指示。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-183">Follow the instructions for [updating the Linux VM agent](../virtual-machines/linux/update-agent.md).</span></span>

 >[!NOTE]
 ><span data-ttu-id="b1e6f-184">我們強烈建議您只透過散發套件存放庫更新代理程式。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-184">We *strongly recommend* that you update the agent only through a distribution repository.</span></span> <span data-ttu-id="b1e6f-185">我們不建議直接從 GitHub 下載代理程式程式碼，並加以更新。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-185">We do not recommend downloading the agent code directly from GitHub and updating it.</span></span> <span data-ttu-id="b1e6f-186">如果最新的代理程式不適用於您的散發套件，請連絡散發套件支援以取得如何進行安裝的指示。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-186">If the latest agent is unavailable for your distribution, contact distribution support for instructions on how to install it.</span></span> <span data-ttu-id="b1e6f-187">若要檢查最新的代理程式，請移至 GitHub 儲存機制中的 [Microsoft Azure Linux 代理程式 (英文)](https://github.com/Azure/WALinuxAgent/releases) 頁面。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-187">To check for the most recent agent, go to the [Windows Azure Linux agent](https://github.com/Azure/WALinuxAgent/releases) page in the GitHub repository.</span></span>

2. <span data-ttu-id="b1e6f-188">執行下列命令，以確定 Azure 代理程式正在 VM 上執行：`ps -e`</span><span class="sxs-lookup"><span data-stu-id="b1e6f-188">Make sure that the Azure agent is running on the VM by running the following command: `ps -e`</span></span>

 <span data-ttu-id="b1e6f-189">如果此程序並未執行，請使用下列命令來重新啟動它：</span><span class="sxs-lookup"><span data-stu-id="b1e6f-189">If the process is not running, restart it by using the following commands:</span></span>

 * <span data-ttu-id="b1e6f-190">針對 Ubuntu：`service walinuxagent start`</span><span class="sxs-lookup"><span data-stu-id="b1e6f-190">For Ubuntu: `service walinuxagent start`</span></span>
 * <span data-ttu-id="b1e6f-191">針對其他散發套件︰`service waagent start`</span><span class="sxs-lookup"><span data-stu-id="b1e6f-191">For other distributions: `service waagent start`</span></span>

3. <span data-ttu-id="b1e6f-192">[設定自動重新啟動代理程式](https://github.com/Azure/WALinuxAgent/wiki/Known-Issues#mitigate_agent_crash)。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-192">[Configure the auto restart agent](https://github.com/Azure/WALinuxAgent/wiki/Known-Issues#mitigate_agent_crash).</span></span>
4. <span data-ttu-id="b1e6f-193">執行新的測試備份。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-193">Run a new test backup.</span></span> <span data-ttu-id="b1e6f-194">如果失敗持續發生，請收集下列來自客戶 VM 的記錄：</span><span class="sxs-lookup"><span data-stu-id="b1e6f-194">If the failure persists, please collect the following logs from the customer’s VM:</span></span>

   * <span data-ttu-id="b1e6f-195">/var/lib/waagent/*.xml</span><span class="sxs-lookup"><span data-stu-id="b1e6f-195">/var/lib/waagent/*.xml</span></span>
   * <span data-ttu-id="b1e6f-196">/var/log/waagent.log</span><span class="sxs-lookup"><span data-stu-id="b1e6f-196">/var/log/waagent.log</span></span>
   * <span data-ttu-id="b1e6f-197">/var/log/azure/*</span><span class="sxs-lookup"><span data-stu-id="b1e6f-197">/var/log/azure/*</span></span>

<span data-ttu-id="b1e6f-198">如果我們需要 waagent 的詳細資訊記錄，請遵循下列步驟：</span><span class="sxs-lookup"><span data-stu-id="b1e6f-198">If we require verbose logging for waagent, follow these steps:</span></span>

1. <span data-ttu-id="b1e6f-199">在 /etc/waagent.conf 檔案中，找出下一行︰**Enable verbose logging (y|n)**</span><span class="sxs-lookup"><span data-stu-id="b1e6f-199">In the /etc/waagent.conf file, locate the following line: **Enable verbose logging (y|n)**</span></span>
2. <span data-ttu-id="b1e6f-200">將 **Logs.Verbose** 值從 n 變更為 y。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-200">Change the **Logs.Verbose** value from *n* to *y*.</span></span>
3. <span data-ttu-id="b1e6f-201">儲存變更，然後遵循本節前面的步驟，重新啟動 waagent。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-201">Save the change, and then restart waagent by following the previous steps in this section.</span></span>

### <a name="the-snapshot-status-cannot-be-retrieved-or-a-snapshot-cannot-be-taken"></a><span data-ttu-id="b1e6f-202">無法擷取快照集狀態或無法取得快照集</span><span class="sxs-lookup"><span data-stu-id="b1e6f-202">The snapshot status cannot be retrieved or a snapshot cannot be taken</span></span>
<span data-ttu-id="b1e6f-203">VM 備份仰賴發給底層儲存體帳戶的快照命令。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-203">The VM backup relies on issuing a snapshot command to the underlying storage account.</span></span> <span data-ttu-id="b1e6f-204">備份可能會失敗，因為它無權存取儲存體帳戶，或是因為快照工作延遲執行。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-204">Backup can fail either because it has no access to the storage account or because the execution of the snapshot task is delayed.</span></span>

#### <a name="solution"></a><span data-ttu-id="b1e6f-205">方案</span><span class="sxs-lookup"><span data-stu-id="b1e6f-205">Solution</span></span>
<span data-ttu-id="b1e6f-206">下列狀況可能導致快照集工作失敗：</span><span class="sxs-lookup"><span data-stu-id="b1e6f-206">The following conditions can cause snapshot task failure:</span></span>

| <span data-ttu-id="b1e6f-207">原因</span><span class="sxs-lookup"><span data-stu-id="b1e6f-207">Cause</span></span> | <span data-ttu-id="b1e6f-208">方案</span><span class="sxs-lookup"><span data-stu-id="b1e6f-208">Solution</span></span> |
| --- | --- |
| <span data-ttu-id="b1e6f-209">VM 已設定 SQL Server 備份。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-209">The VM has SQL Server backup configured.</span></span> | <span data-ttu-id="b1e6f-210">根據預設，VM 備份會在 Windows VM 上執行 VSS 完整備份。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-210">By default, the VM backup runs a VSS full backup on Windows VMs.</span></span> <span data-ttu-id="b1e6f-211">在執行以 SQL Server 為基礎的伺服器並設定了 SQL Server 備份的 VM 上，可能會發生快照延遲執行。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-211">On VMs that are running SQL Server-based servers and on which SQL Server backup is configured, snapshot execution delays may occur.</span></span><br><br><span data-ttu-id="b1e6f-212">如果您因為快照問題而遇到備份失敗，請設定下列登錄機碼：</span><span class="sxs-lookup"><span data-stu-id="b1e6f-212">If you are experiencing a Backup failure because of a snapshot issue, set the following registry key:</span></span><br><br><span data-ttu-id="b1e6f-213">**[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT] "USEVSSCOPYBACKUP"="TRUE"**</span><span class="sxs-lookup"><span data-stu-id="b1e6f-213">**[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT] "USEVSSCOPYBACKUP"="TRUE"**</span></span> |
| <span data-ttu-id="b1e6f-214">因為 RDP 中的 VM 關機，而導致報告的 VM 狀態不正確。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-214">The VM status is reported incorrectly because the VM is shut down in RDP.</span></span> | <span data-ttu-id="b1e6f-215">如果您關閉遠端桌面通訊協定 (RDP) 中的 VM，請檢查入口網站，以判斷 VM 狀態是否正確。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-215">If you shut down the VM in Remote Desktop Protocol (RDP), check the portal to determine whether the VM status is correct.</span></span> <span data-ttu-id="b1e6f-216">如果不正確，可使用 VM 儀表板上的 [關閉] 選項來關閉入口網站中的 VM。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-216">If it’s not correct, shut down the VM in the portal by using the **Shutdown** option on the VM dashboard.</span></span> |
| <span data-ttu-id="b1e6f-217">相同的雲端服務中的許多 VM 都設定為同時備份。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-217">Many VMs from the same cloud service are configured to back up at the same time.</span></span> | <span data-ttu-id="b1e6f-218">最佳做法是向外分配相同雲端服務中 VM 的備份排程。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-218">It’s a best practice to spread out the backup schedules for VMs from the same cloud service.</span></span> |
| <span data-ttu-id="b1e6f-219">VM 正在以高 CPU 或記憶體使用量執行。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-219">The VM is running at high CPU or memory usage.</span></span> | <span data-ttu-id="b1e6f-220">如果 VM 正在以高 CPU 使用量 (超過 90%) 或高記憶體使用量執行，即會將快照工作排入佇列並延遲，而其最終會逾時。在此情況下，請嘗試隨選備份。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-220">If the VM is running at high CPU usage (more than 90 percent) or high memory usage, the snapshot task is queued and delayed, and it eventually times out. In this situation, try an on-demand backup.</span></span> |
| <span data-ttu-id="b1e6f-221">VM 無法從 DHCP 取得主機/網狀架構位址。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-221">The VM cannot get the host/fabric address from DHCP.</span></span> | <span data-ttu-id="b1e6f-222">必須在來賓內啟用 DHCP，IaaS VM 備份才能運作。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-222">DHCP must be enabled inside the guest for the IaaS VM backup to work.</span></span>  <span data-ttu-id="b1e6f-223">如果 VM 無法從 DHCP 回應 245 取得主機/網狀架構位址，則無法下載或執行任何擴充功能。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-223">If the VM cannot get the host/fabric address from DHCP response 245, it cannot download or run any extensions.</span></span> <span data-ttu-id="b1e6f-224">如果您需要靜態私人 IP 位址，您應該透過平台來進行設定。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-224">If you need a static private IP, you should configure it through the platform.</span></span> <span data-ttu-id="b1e6f-225">VM 內的 DHCP 選項應保持啟用。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-225">The DHCP option inside the VM should be left enabled.</span></span> <span data-ttu-id="b1e6f-226">如需詳細資訊，請參閱[設定靜態內部私人 IP 位址](../virtual-network/virtual-networks-reserved-private-ip.md)。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-226">For more information, see [Setting a Static Internal Private IP](../virtual-network/virtual-networks-reserved-private-ip.md).</span></span> |

### <a name="the-backup-extension-fails-to-update-or-load"></a><span data-ttu-id="b1e6f-227">備份擴充功能無法更新或載入</span><span class="sxs-lookup"><span data-stu-id="b1e6f-227">The backup extension fails to update or load</span></span>
<span data-ttu-id="b1e6f-228">如果無法載入擴充功能，備份就會因為無法取得快照而失敗。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-228">If extensions cannot be loaded, Backup fails because a snapshot cannot be taken.</span></span>

#### <a name="solution"></a><span data-ttu-id="b1e6f-229">方案</span><span class="sxs-lookup"><span data-stu-id="b1e6f-229">Solution</span></span>

<span data-ttu-id="b1e6f-230"> **Windows 客體：**確認 iaasvmprovider 服務已啟用，而且啟動類型為「自動」。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-230">**For Windows guests:** Verify that the iaasvmprovider service is enabled and has a startup type of *automatic*.</span></span> <span data-ttu-id="b1e6f-231">如果服務不是使用此方式所設定，請啟用該服務以判斷下一次備份是否成功。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-231">If the service is not configured in this way, enable it to determine whether the next backup succeeds.</span></span>

<span data-ttu-id="b1e6f-232"> **Linux 客體：**VMSnapshot for Linux (備份所使用的擴充功能) 的最新版本是 1.0.91.0。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-232">**For Linux guests:** Verify the latest version of VMSnapshot for Linux (the extension used by Backup) is 1.0.91.0.</span></span><br>


<span data-ttu-id="b1e6f-233">如果還是無法更新或載入備份擴充功能，您可以透過解除安裝擴充功能來強制重新載入 VMSnapshot 擴充功能。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-233">If the backup extension still fails to update or load, you can force the VMSnapshot extension to be reloaded by uninstalling the extension.</span></span> <span data-ttu-id="b1e6f-234">下一次的備份嘗試將會重新載入擴充功能。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-234">The next backup attempt will reload the extension.</span></span>

<span data-ttu-id="b1e6f-235">若要解除安裝擴充功能，請執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="b1e6f-235">To uninstall the extension, do the following:</span></span>

1. <span data-ttu-id="b1e6f-236">移至 [Azure 入口網站](https://portal.azure.com/)。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-236">Go to the [Azure portal](https://portal.azure.com/).</span></span>
2. <span data-ttu-id="b1e6f-237">找出具有備份問題的 VM。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-237">Locate the VM that has backup problems.</span></span>
3. <span data-ttu-id="b1e6f-238">按一下 [設定] 。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-238">Click **Settings**.</span></span>
4. <span data-ttu-id="b1e6f-239">按一下 [擴充功能]。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-239">Click **Extensions**.</span></span>
5. <span data-ttu-id="b1e6f-240">按一下 [Vmsnapshot 擴充功能]。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-240">Click **Vmsnapshot Extension**.</span></span>
6. <span data-ttu-id="b1e6f-241">按一下 [解除安裝]。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-241">Click **Uninstall**.</span></span>

<span data-ttu-id="b1e6f-242">此程序會導致在下一次備份期間重新安裝擴充功能。</span><span class="sxs-lookup"><span data-stu-id="b1e6f-242">This procedure causes the extension to be reinstalled during the next backup.</span></span>

