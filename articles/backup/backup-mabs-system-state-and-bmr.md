---
title: "Azure 備份伺服器可保護系統狀態及還原為裸機 | Microsoft Docs"
description: "使用 Azure 備份伺服器來備份系統狀態及提供裸機復原 (BMR) 保護。"
services: backup
documentationcenter: 
author: markgalioto
manager: carmonm
keywords: 
ms.assetid: 
ms.service: backup
ms.workload: storage-backup-recovery
ms.targetplatform: na
ms.devlang: na
ms.topic: article
ms.date: 05/15/2017
ms.author: markgal,masaran
ms.openlocfilehash: 30f70a702d7d9a3e1196c04096708c035e406607
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/11/2017
---
# <a name="back-up-system-state-and-restore-to-bare-metal-with-azure-backup-server"></a>使用 Azure 備份伺服器來備份系統狀態及還原為裸機

Azure 備份伺服器可備份系統狀態及提供裸機復原 (BMR) 保護。

*   **系統狀態備份**：備份作業系統檔案，讓您可以在電腦雖啟動卻遺失系統檔案和登錄時進行復原。 系統狀態備份包含：
    * 網域成員：開機檔案、COM+ 類別註冊資料庫、登錄
    * 網域控制站：Windows Server Active Directory (NTDS)、開機檔案、 COM+ 類別註冊資料庫、登錄、系統磁碟區 (SYSVOL)
    * 執行叢集服務的電腦：叢集伺服器中繼資料
    * 執行憑證服務的電腦：憑證資料
* **裸機備份**：備份重要磁碟區上的作業系統檔案和所有資料 (使用者資料除外)。 根據定義，BMR 備份包括系統狀態備份。 當電腦無法啟動，而且您必須復原所有項目時，裸機備份便可提供保護。

下表摘要說明您可以備份及復原的項目。 如需可使用系統狀態和 BMR 來加以保護之應用程式版本的詳細資訊，請參閱 [Azure 備份伺服器會備份哪些項目？](backup-mabs-protection-matrix.md)。

|備份|問題|從 Azure 備份伺服器的備份進行復原|從系統狀態的備份進行復原|BMR|
|----------|---------|---------------------------|------------------------------------|-------|
|**檔案資料**<br /><br />一般資料備份<br /><br />BMR/系統狀態備份|遺失檔案資料|Y|N|N|
|**檔案資料**<br /><br />Azure 備份伺服器的檔案資料備份<br /><br />BMR/系統狀態備份|作業系統遺失或損毀|N|Y|Y|
|**檔案資料**<br /><br />Azure 備份伺服器的檔案資料備份<br /><br />BMR/系統狀態備份|遺失伺服器 (資料磁碟區未受損)|N|N|Y|
|**檔案資料**<br /><br />Azure 備份伺服器的檔案資料備份<br /><br />BMR/系統狀態備份|遺失伺服器 (資料磁碟區也遺失)|Y|否|是 (先進行 BMR，接著進行所備份之檔案資料的一般復原)|
|**SharePoint 資料**：<br /><br />Azure 備份伺服器的伺服器陣列資料備份<br /><br />BMR/系統狀態備份|遺失網站、清單、清單項目、文件|Y|N|N|
|**SharePoint 資料**：<br /><br />Azure 備份伺服器的伺服器陣列資料備份<br /><br />BMR/系統狀態備份|作業系統遺失或損毀|N|Y|Y|
|**SharePoint 資料**：<br /><br />Azure 備份伺服器的伺服器陣列資料備份<br /><br />BMR/系統狀態備份|災害復原|N|N|N|
|Windows Server 2012 R2 Hyper-V<br /><br />Azure 備份伺服器的 Hyper-V 主機或客體備份<br /><br />主機的 BMR/系統狀態備份|遺失 VM|Y|N|N|
|Hyper-V<br /><br />Azure 備份伺服器的 Hyper-V 主機或客體備份<br /><br />主機的 BMR/系統狀態備份|作業系統遺失或損毀|N|Y|Y|
|Hyper-V<br /><br />Azure 備份伺服器的 Hyper-V 主機或客體備份<br /><br />主機的 BMR/系統狀態備份|遺失 Hyper-V 主機 (VM 未受損)|N|N|Y|
|Hyper-V<br /><br />Azure 備份伺服器的 Hyper-V 主機或客體備份<br /><br />主機的 BMR/系統狀態備份|遺失 Hyper-V 主機 (VM 也遺失)|N|N|Y<br /><br />先進行 BMR，接著進行 Azure 備份伺服器一般復原|
|SQL Server/Exchange<br /><br />Azure 備份伺服器應用程式備份<br /><br />BMR/系統狀態備份|遺失應用程式資料|Y|N|N|
|SQL Server/Exchange<br /><br />Azure 備份伺服器應用程式備份<br /><br />BMR/系統狀態備份|作業系統遺失或損毀|N|y|Y|
|SQL Server/Exchange<br /><br />Azure 備份伺服器應用程式備份<br /><br />BMR/系統狀態備份|遺失伺服器 (資料庫/交易記錄未受損)|N|N|Y|
|SQL Server/Exchange<br /><br />Azure 備份伺服器應用程式備份<br /><br />BMR/系統狀態備份|遺失伺服器 (資料庫/交易記錄也遺失)|N|N|Y<br /><br />先進行 BMR 復原，接著進行 Azure 備份伺服器一般復原|

## <a name="how-system-state-backup-works"></a>系統狀態備份的運作方式

當系統狀態備份執行時，備份伺服器會與 Windows Server Backup 通訊以要求伺服器系統狀態的備份。 根據預設，備份伺服器和 Windows Server Backup 會使用擁有最多可用空間的磁碟機。 此磁碟機的相關資訊會儲存在 PSDataSourceConfig.xml 檔案中。 這是 Windows Server Backup 用來進行備份的磁碟機。

您可以自訂要供備份伺服器用來進行系統狀態備份的磁碟機。 在受保護的伺服器上，移至 C:\Program Files\Microsoft Data Protection Manager\MABS\Datasources。 開啟 PSDataSourceConfig.xml 檔案來進行編輯。 將 \<FilesToProtect\> 值變更為磁碟機代號。 儲存並關閉檔案。 如果您設定了保護群組來保護電腦的系統狀態，請執行一致性檢查。 如果系統產生警示，請選取警示中的 [修改保護群組]，然後完成精靈。 然後，再執行一次一致性檢查。

請注意，如果保護伺服器位於叢集中，系統可能會將叢集磁碟機選為具有最多可用空間的磁碟機。 如果該磁碟機的擁有權已轉給另一個節點，並且您執行了系統狀態備份，該磁碟機將無法供您使用，且備份會失敗。 在此案例中，請將 PSDataSourceConfig.xml 修改為指向本機磁碟機。

接下來，Windows Server Backup 會在還原資料夾的根目錄中建立名為 WindowsImageBackup 的資料夾。 當 Windows Server Backup 建立備份時，所有資料都會放在這個資料夾中。 備份完成時，系統會將檔案傳輸到備份伺服器電腦。 請注意下列資訊︰

* 當備份或傳輸完成時，系統不會清除此資料夾及其內容。 此情況的最佳解釋方式為，系統已將此空間保留供下一次備份完成時使用。
* 每次進行備份時，系統都會建立該資料夾。 其日期和時間戳記會反映最後一次進行系統狀態備份的時間。

## <a name="bmr-backup"></a>BMR 備份

在進行 BMR (包括系統狀態備份) 時，備份作業會直接儲存到備份伺服器電腦上的共用， 而不會儲存到受保護伺服器上的資料夾。

備份伺服器會呼叫 Windows Server Backup，並共用該 BMR 備份的複本磁碟區。 在此情況下，它不會指示 Windows Server Backup 使用具有最多可用空間的磁碟機。 相反地，它會使用針對該作業所建立的共用。

備份完成時，系統會將檔案傳輸到備份伺服器電腦。 記錄會儲存在 C:\Windows\Logs\WindowsServerBackup 中。

## <a name="prerequisites-and-limitations"></a>必要條件和限制

-   執行 Windows Server 2003 的電腦或執行用戶端作業系統的電腦皆不支援 BMR。

-   您無法針對位於不同保護群組的同一部電腦保護 BMR 和系統狀態。

-   備份伺服器電腦無法讓自己受到 BMR 保護。

-   BMR 不支援以磁帶作為目的地的短期保護 (磁碟到磁帶，簡稱 D2T)。 支援以磁帶作為目的地的長期保護 (磁碟到磁碟到磁帶，簡稱 D2D2T)。

-   若要獲得 BMR 保護，您必須在受保護的電腦上安裝 Windows Server Backup。

-   在進行 BMR 保護時，備份伺服器不需要使用受保護電腦上的空間，這一點和系統狀態保護不同。 Windows Server Backup 會將備份直接傳輸到備份伺服器電腦。 備份傳輸作業不會出現在備份伺服器的 [作業] 檢視中。

-   備份伺服器會在複本磁碟區上保留 30 GB 的空間，以供執行 BMR。 您可以在「修改保護群組」精靈的 [磁碟配置] 頁面上變更此空間值，也可以使用 Get-DatasourceDiskAllocation 和 Set-DatasourceDiskAllocation PowerShell Cmdlet 來加以變更。 在復原點磁碟區上，BMR 保護需要大約 6 GB 的空間來將資料保留五天。
    * 請注意，您無法將複本磁碟區大小縮減為不到 15 GB。
    * 備份伺服器不會計算 BMR 資料來源的大小。 它會假設所有伺服器都有 30 GB。 請根據您預期環境中所具有的 BMR 備份大小來變更此值。 BMR 備份大小的粗略計算方式為所有重要磁碟區上的使用空間總和。 重要磁碟區 = 開機磁碟區 + 系統磁碟區 + 裝載系統狀態資料的磁碟區，例如 Active Directory。

-   如果您從系統狀態保護變更為 BMR 保護，則 BMR 保護在「復原點磁碟區」上所需的空間會較少。 不過，系統不會回收磁碟區上的多餘空間。 您可以在「修改保護群組」精靈的 [修改磁碟配置] 頁面上手動縮減磁碟區大小，也可以使用 Get-DatasourceDiskAllocation 和 Set-DatasourceDiskAllocation PowerShell Cmdlet 來加以縮減。

    如果您從系統狀態保護變更為 BMR 保護，則 BMR 保護在「複本磁碟區」上會需要更多空間。 系統會自動擴充磁碟區。 如果您想要變更預設的空間配置，請使用 Modify-diskallocation PowerShell Cmdlet。

-   如果您從 BMR 保護變更為系統狀態保護，則您在「復原點磁碟區」上會需要更多空間。 備份伺服器可能會嘗試自動增加磁碟區。 如果儲存集區中的空間不夠，系統就會發生錯誤。

    如果您從 BMR 保護變更為系統狀態保護，則您需要受保護的電腦上的空間。 原因是系統狀態保護會先將複本寫入本機電腦，再將它傳輸至備份伺服器電腦。

## <a name="before-you-begin"></a>開始之前

1.  **部署 Azure 備份伺服器**。 請確認您是否已正確地部署備份伺服器。 如需詳細資訊，請參閱：
    * [Azure 備份伺服器的系統需求](http://docs.microsoft.com/system-center/dpm/install-dpm#setup-prerequisites)
    * [備份伺服器保護對照表](backup-mabs-protection-matrix.md)

2.  **設定儲存體**。 您可以將備份資料儲存在磁碟上、磁帶上以及 Azure 雲端中。 如需詳細資訊，請參閱[準備資料儲存體](https://docs.microsoft.com/system-center/dpm/plan-long-and-short-term-data-storage)。

3.  **設定保護代理程式**。 在您要備份的電腦上安裝保護代理程式。 如需詳細資訊，請參閱[部署 DPM 保護代理程式](http://docs.microsoft.com/system-center/dpm/deploy-dpm-protection-agent)。

## <a name="back-up-system-state-and-bare-metal"></a>備份系統狀態和裸機
設定保護群組，如[部署保護群組](http://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups)所述。 請注意，您無法針對位於不同群組的同一部電腦保護 BMR 和系統狀態。 此外，當您選取 BMR 時，系統會自動啟用系統狀態。


1.  若要在備份伺服器管理員主控台中開啟「建立新保護群組」精靈，請選取 [保護] > [動作] > [建立保護群組]。

2.  在 [選取保護群組類型] 頁面上，選取 [伺服器]，然後選取 [下一步]。

3.  在 [選取群組成員] 頁面上展開電腦，然後選取 [BMR] 或 [系統狀態]。

    請記住，您無法針對位於不同群組的同一部電腦同時保護 BMR 和系統狀態。 此外，當您選取 BMR 時，系統會自動啟用系統狀態。 如需詳細資訊，請參閱[部署保護群組](http://docs.microsoft.com/system-center/dpm/create-dpm-protection-groups)。

4.  在 [選取資料保護方式] 頁面上，選取您要如何處理短期和長期備份。 短期備份一律會先備份到磁碟，並可選擇使用 Azure 備份 (短期或長期) 從磁碟備份至 Azure 雲端。 若要以雲端作為目的地進行長期備份，替代方式為將長期備份的目的地設為獨立磁帶裝置或連線到備份伺服器的磁帶媒體櫃。

5.  在 [選取短期目標] 頁面上，選取您要如何備份到磁碟上的短期儲存體：
    1. 在 [保留範圍] 中，選取您要讓資料在磁碟上保留多久。 
    2. 在 [同步處理頻率] 中，選取您要對磁碟執行增量備份的頻率。 如果您不想設定備份間隔，您可以核取 [在復原點前一刻] 選項。 備份伺服器將會在每個復原點的排程時間前一刻執行快速而完整的備份。

6.  如果您想要將資料儲存在磁帶上以進行長期保存，請在 [指定長期目標] 頁面上選取您想要讓磁帶資料保留多久 (1 - 99 年)。 
    1. 在 [備份頻率] 中，選取磁帶備份應有的執行頻率。 此頻率會以您所選取的保留範圍為基礎：
        * 當保留範圍是 1 - 99 年時，您可以選取要在每天、每週、每兩週、每月、每季、每半年或每年進行備份。
        * 當保留範圍是 1 - 11 個月時，您可以選取要在每天、每週、每兩週或每月進行備份。
        * 當保留範圍是 1 - 4 週時，您可以選取要在每天或每週進行備份。

    2. 在 [選取磁帶和媒體櫃詳細資料] 頁面中，選取要使用的磁帶和媒體櫃，以及資料是否應該壓縮和加密。

7.  在 [檢閱磁碟配置] 頁面上，檢閱針對保護群組所配置的儲存集區磁碟空間。

    1. [資料大小總計] 是您要備份的資料大小。
    2. [要在 Azure 備份伺服器上佈建的磁碟空間] 是備份伺服器所建議的保護群組空間。 備份伺服器會根據這些設定選擇理想的備份磁碟區。 不過，您也可以在 [磁碟配置詳細資料] 中編輯備份磁碟區選項。 
    3. 針對工作負載，請在下拉式功能表中選取您偏好的儲存體。 您的編輯內容會變更 [可用磁碟儲存體] 窗格中 [儲存體總計] 和 [可用儲存體] 的值。 佈建不足的空間是備份伺服器為了確保備份順利，而建議您在磁碟區中新增的儲存體數量。

8.  在 [選擇複本建立方式] 頁面上，選取您要如何處理首次的完整資料複寫。 如果您選擇透過網路進行複寫，建議您選擇離峰時間。 如果資料量較大或網路狀況不理想，請考慮使用卸除式媒體來離線複寫資料。

9. 在 [選擇一致性檢查選項] 頁面上，選取要如何自動執行一致性檢查。 您可以在複本資料變得不一致時或按照排程的時間執行檢查。 如果您不想設定自動一致性檢查，您可以隨時執行手動檢查。 若要執行手動檢查，請在備份伺服器管理員主控台的 [保護] 區域，以滑鼠右鍵按一下保護群組，然後選取 [執行一致性檢查]。

10. 如果您已選擇要使用 Azure 備份來備份到雲端，請確定您已在 [指定線上保護資料] 頁面上選取要備份至 Azure 的工作負載。

11. 在 [指定線上備份排程] 頁面上，選取要進行 Azure 增量備份的頻率。 您可以將備份排程為每日、每週、每月和每年執行，並可選取備份的執行時間和日期。 一天最多可以備份兩次。 系統每次執行備份時，都會透過備份伺服器磁碟上儲存的備份資料複本，在 Azure 中建立復原點。

12. 在 [指定線上保留原則] 頁面上，選取要如何在 Azure 中保留透過每日、每週、每月和每年備份所建立的復原點。

13. 在 [選擇線上複寫] 頁面上，選取要如何進行首次的資料完整複寫。 您可以透過網路進行複寫，也可以執行離線備份 (離線植入)。 離線備份會使用 Azure 匯入功能。 如需詳細資訊，請參閱 [Azure Backup 中的離線備份工作流程](backup-azure-backup-import-export.md)。

14. 在 [摘要] 頁面上檢閱您的設定。 在選取 [建立群組] 後，系統就會開始進行首次的資料複寫。 當資料複寫完成時，[狀態] 頁面上的保護群組狀態會是 [正常]。 之後，系統會按照保護群組設定進行備份。

## <a name="recover-system-state-or-bmr"></a>復原系統狀態或 BMR
您可以將 BMR 或系統狀態復原到網路位置。 如果您已備份 BMR，請使用 Windows 修復環境 (WinRE) 來啟動您的系統，並將系統連線到網路。 然後，使用 Windows Server Backup 從網路位置進行復原。 如果您已備份系統狀態，請直接使用 Windows Server Backup 從網路位置進行復原。

### <a name="restore-bmr"></a>還原 BMR
在備份伺服器電腦上執行復原：

1.  在 [復原] 窗格中找到您要復原的電腦，然後選取 [裸機復原]。

2.  行事曆上會以粗體表示可用的復原點。 選取您要使用之復原點的日期和時間。

3.  在 [選取復原類型] 頁面上，選取 [複製到網路資料夾]。

4.  在 [指定目的地] 頁面上，選取資料的複製目的地。 請記住，所選取的目的地必須有足夠的空間。 我們建議您建立新的資料夾。

5.  在 [指定復原選項] 頁面上，選取要套用的安全性設定。 然後，選取是否要使用存放區域網路 (SAN) 型硬體快照集，以便進行更快速的復原。 (當您擁有可使用這項功能的 SAN，而且您能夠建立複製品並將其分割以便可供寫入時，系統才會提供這個選項。 此外，受保護的電腦和備份伺服器電腦必須連線到相同的網路。)

6.  設定通知選項。 在 [確認] 頁面上，選取 [復原]。

設定共用位置：

1.  在還原位置中移至該備份的所在資料夾。

2.  將比 WindowsImageBackup 高一層的資料夾設為共用，讓共用資料夾的根目錄成為 WindowsImageBackup 資料夾。 如果沒有這麼做，還原將找不到備份。 若要使用 Windows 修復環境 (WinRE) 來進行連線，您需要可在 WinRE 中使用正確的 IP 位址和認證來存取的共用。

還原系統：

1.  使用您要還原之系統的 Windows DVD，來啟動您要用來還原映像的電腦。

2.  在第一個頁面上，確認語言及地區設定。 在 [安裝] 頁面上，選取 [修復您的電腦]。

3.  在 [系統修復選項] 頁面上，選取 [使用您先前建立的系統映像還原電腦]。

4.  在 [選取系統映像備份] 頁面上，選取 [選取系統映像] > [進階] > [搜尋網路上的系統映像]。 如果出現警告，請選取 [是]。 移至共用路徑，輸入認證，然後選取復原點。 此動作會掃描出該復原點中可用的特定備份。 選取您要使用的復原點。

5.  在 [選擇還原備份的方式] 頁面上，選取 [格式化並重新分割磁碟]。 在下一頁上確認設定。 

6.  若要開始還原，請選取 [完成]。 系統需要重新啟動。

### <a name="restore-system-state"></a>還原系統狀態

在備份伺服器中執行復原：

1.  在 [復原] 窗格中找到您要復原的電腦，然後選取 [裸機復原]。

2.  行事曆上會以粗體表示可用的復原點。 選取您要使用之復原點的日期和時間。

3.  在 [選取復原類型] 頁面上，選取 [複製到網路資料夾]。

4.  在 [指定目的地] 頁面上，選取資料的複製目的地。 請記住，所選取的目的地需要足夠的空間。 我們建議您建立新的資料夾。

5.  在 [指定復原選項] 頁面上，選取要套用的安全性設定。 然後，選取是否要使用 SAN 型硬體快照集，以便進行更快速的復原。 (當您的 SAN 具有這項功能，而且您能夠建立複製品並將其分割以便可供寫入時，系統才會提供這個選項。 此外，受保護的電腦和備份伺服器伺服器必須連線到相同的網路。)

6.  設定通知選項。 在 [確認] 頁面上，選取 [復原]。

執行 Windows Server Backup：

1.  選取 [動作] > [復原] > [此伺服器] > [下一步]。

2.  選取 [其他伺服器]，選取 [指定位置類型] 頁面，然後選取 [遠端共用資料夾]。 輸入復原點所在資料夾的路徑。

3.  在 [選取復原類型] 頁面上，選取 [系統狀態]。 

4. 在 [選取系統狀態復原的位置] 頁面上，選取 [原始位置]。

5.  在 [確認] 頁面上，選取 [復原]。 在還原之後，請重新啟動伺服器。

6.  您也可以在命令提示字元執行系統狀態還原。 若要這樣做，請在您要復原的電腦上啟動 Windows Server Backup。 若要取得版本識別碼，請在命令提示字元輸入：```wbadmin get versions -backuptarget \<servername\sharename\>```

    使用版本識別碼來開始系統狀態還原。 在命令提示字元中，輸入：```wbadmin start systemstaterecovery -version:<versionidentified> -backuptarget:<servername\sharename>```

    確認您想要開始復原。 您可以在 [命令提示字元] 視窗中看到復原程序。 系統會建立還原記錄。 在還原之後，請重新啟動伺服器。

