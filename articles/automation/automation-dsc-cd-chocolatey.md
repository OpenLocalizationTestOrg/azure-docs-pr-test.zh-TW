---
title: "Azure 自動化 DSC 持續部署與 Chocolatey | Microsoft Docs"
description: "使用 Azure 自動化 DSC 和 Chocolatey 封裝管理員執行 DevOps 持續部署。  具有完整 JSON ARM 範本與 PowerShell 原始檔的範例。"
services: automation
documentationcenter: 
author: eslesar
manager: carmonm
editor: tysonn
ms.assetid: c0baa411-eb76-4f91-8d14-68f68b4805b6
ms.service: automation
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows
ms.workload: na
ms.date: 10/29/2016
ms.author: golive
ms.openlocfilehash: f23d7374a8954a0a95853fa9e00b54a8d9c468c4
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="usage-example-continuous-deployment-to-virtual-machines-using-automation-dsc-and-chocolatey"></a><span data-ttu-id="85fa2-104">使用範例：使用 Automation DSC 和 Chocolatey 持續部署至虛擬機器</span><span class="sxs-lookup"><span data-stu-id="85fa2-104">Usage Example: Continuous deployment to Virtual Machines using Automation DSC and Chocolatey</span></span>
<span data-ttu-id="85fa2-105">DevOps 領域中有許多工具可協助處理持續整合管線中的各個點。</span><span class="sxs-lookup"><span data-stu-id="85fa2-105">In a DevOps world there are many tools to assist with various points in the Continuous Integration pipeline.</span></span>  <span data-ttu-id="85fa2-106">Azure 自動化預期狀態設定 (DSC) 是 DevOps 團隊可以採用的新選項。</span><span class="sxs-lookup"><span data-stu-id="85fa2-106">Azure Automation Desired State Configuration (DSC) is a welcome new addition to the options that DevOps teams can employ.</span></span>  <span data-ttu-id="85fa2-107">本文示範如何為 Windows 電腦設定持續部署 (CD)。</span><span class="sxs-lookup"><span data-stu-id="85fa2-107">This article demonstrates setting up Continuous Deployment (CD) for a Windows computer.</span></span>  <span data-ttu-id="85fa2-108">您可以輕鬆地擴充技術，在角色 (例如網站) 中依需要加入更多 Windows 電腦，還能從該角色再延伸至其他角色。</span><span class="sxs-lookup"><span data-stu-id="85fa2-108">You can easily extend the technique to include as many Windows computers as necessary in the role (a web site, for example), and from there to additional roles as well.</span></span>

![IaaS VM 的持續部署](./media/automation-dsc-cd-chocolatey/cdforiaasvm.png)

## <a name="at-a-high-level"></a><span data-ttu-id="85fa2-110">概括而言</span><span class="sxs-lookup"><span data-stu-id="85fa2-110">At a high level</span></span>
<span data-ttu-id="85fa2-111">這裡要進行的事項很多，幸好，大致上可分成兩個主要程序：</span><span class="sxs-lookup"><span data-stu-id="85fa2-111">There is quite a bit going on here, but fortunately it can be broken into two main processes:</span></span> 

* <span data-ttu-id="85fa2-112">撰寫程式碼並測試，然後針對系統的主要和次要版本，建立並發佈安裝封裝。</span><span class="sxs-lookup"><span data-stu-id="85fa2-112">Writing code and testing it, then creating and publishing installation packages for major and minor versions of the system.</span></span> 
* <span data-ttu-id="85fa2-113">建立和管理 VM，以安裝和執行封裝中的程式碼。</span><span class="sxs-lookup"><span data-stu-id="85fa2-113">Creating and managing VMs that will install and execute the code in the packages.</span></span>  

<span data-ttu-id="85fa2-114">完成這兩個核心程序後，隨著建立和部署新版本，立即就能自動更新任何特定 VM 上執行的封裝。</span><span class="sxs-lookup"><span data-stu-id="85fa2-114">Once both of these core processes are in place, it’s a short step to automatically update the package running on any particular VM as new versions are created and deployed.</span></span>

## <a name="component-overview"></a><span data-ttu-id="85fa2-115">元件概觀</span><span class="sxs-lookup"><span data-stu-id="85fa2-115">Component overview</span></span>
<span data-ttu-id="85fa2-116">[apt get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) 這類封裝管理員在 Linux 領域中相當知名，但在 Windows 領域中沒有那麼出名。</span><span class="sxs-lookup"><span data-stu-id="85fa2-116">Package managers such as [apt-get](https://en.wikipedia.org/wiki/Advanced_Packaging_Tool) are pretty well known in the Linux world, but not so much in the Windows world.</span></span>  <span data-ttu-id="85fa2-117">[Chocolatey](https://chocolatey.org/) 就是如此，Scott Hanselman 的[部落格](http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx)對此主題有深入介紹。</span><span class="sxs-lookup"><span data-stu-id="85fa2-117">[Chocolatey](https://chocolatey.org/) is such a thing, and Scott Hanselman’s [blog](http://www.hanselman.com/blog/IsTheWindowsUserReadyForAptget.aspx) on the topic is a great intro.</span></span>  <span data-ttu-id="85fa2-118">簡單的說，Chocolatey 可讓您使用命令列，從封裝的中央儲存機制將封裝安裝到 Windows 系統。</span><span class="sxs-lookup"><span data-stu-id="85fa2-118">In a nutshell, Chocolatey allows you to install packages from a central repository of packages into a Windows system using the command line.</span></span>  <span data-ttu-id="85fa2-119">您可以建立和管理您自己的儲存機制，而 Chocolatey 可以從您指定的任何數量的儲存機制來安裝封裝。</span><span class="sxs-lookup"><span data-stu-id="85fa2-119">You can create and manage your own repository, and Chocolatey can install packages from any number of repositories that you designate.</span></span>

<span data-ttu-id="85fa2-120">預期狀態設定 (DSC) ([概觀](https://technet.microsoft.com/library/dn249912.aspx)) 是一個 PowerShell 工具，可讓您為電腦宣告您想要的組態。</span><span class="sxs-lookup"><span data-stu-id="85fa2-120">Desired State Configuration (DSC) ([overview](https://technet.microsoft.com/library/dn249912.aspx)) is a PowerShell tool that allows you to declare the configuration that you want for a machine.</span></span>  <span data-ttu-id="85fa2-121">例如，您可以說「我想要安裝 Chocolatey、我想要安裝 IIS、我想要開啟連接埠 80、我想要安裝網站 1.0.0 版」。</span><span class="sxs-lookup"><span data-stu-id="85fa2-121">For example, you can say, “I want Chocolatey installed, I want IIS installed, I want port 80 opened, I want version 1.0.0 of my website installed.”</span></span>  <span data-ttu-id="85fa2-122">DSC 本機組態管理員 (LCM) 會實作該組態。</span><span class="sxs-lookup"><span data-stu-id="85fa2-122">The DSC Local Configuration Manager (LCM) implements that configuration.</span></span> <span data-ttu-id="85fa2-123">DSC 提取伺服器有一個儲存機制保存您電腦的組態。</span><span class="sxs-lookup"><span data-stu-id="85fa2-123">A DSC Pull Server holds a repository of configurations for your machines.</span></span> <span data-ttu-id="85fa2-124">每台電腦上的 LCM 會定期檢查電腦的組態是否符合已儲存的組態。</span><span class="sxs-lookup"><span data-stu-id="85fa2-124">The LCM on each machine checks in periodically to see if its configuration matches the stored configuration.</span></span> <span data-ttu-id="85fa2-125">它可能報告狀態，也可能嘗試讓電腦回復到符合已儲存的組態。</span><span class="sxs-lookup"><span data-stu-id="85fa2-125">It can either report status or attempt to bring the machine back into alignment with the stored configuration.</span></span> <span data-ttu-id="85fa2-126">您可以編輯提取伺服器上儲存的組態，讓一台電腦或一群電腦符合已變更的組態。</span><span class="sxs-lookup"><span data-stu-id="85fa2-126">You can edit the stored configuration on the pull server to cause a machine or set of machines to come into alignment with the changed configuration.</span></span>

<span data-ttu-id="85fa2-127">Azure 自動化是 Microsoft Azure 中的受管理服務，可讓您使用 Runbook、節點、認證、資源以及排程和全域變數之類的資產，將各種工作自動化。</span><span class="sxs-lookup"><span data-stu-id="85fa2-127">Azure Automation is a managed service in Microsoft Azure that allows you to automate various tasks using runbooks, nodes, credentials, resources and assets such as schedules and global variables.</span></span> <span data-ttu-id="85fa2-128">Azure 自動化 DSC 將此自動化功能擴大包含 PowerShell DSC 工具。</span><span class="sxs-lookup"><span data-stu-id="85fa2-128">Azure Automation DSC extends this automation capability to include PowerShell DSC tools.</span></span>  <span data-ttu-id="85fa2-129">以下提供清楚的 [概觀](automation-dsc-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="85fa2-129">Here’s a great [overview](automation-dsc-overview.md).</span></span>

<span data-ttu-id="85fa2-130">DSC 資源是具有特定功能的程式碼模組，例如管理網路、Active Directory 或 SQL Server。</span><span class="sxs-lookup"><span data-stu-id="85fa2-130">A DSC Resource is a module of code that has specific capabilities, such as managing networking, Active Directory, or SQL Server.</span></span>  <span data-ttu-id="85fa2-131">Chocolatey DSC 資源知道如何存取 NuGet 伺服器 (還有其他)、下載封裝、安裝封裝...等等。</span><span class="sxs-lookup"><span data-stu-id="85fa2-131">The Chocolatey DSC Resource knows how to access a NuGet Server (among others), download packages, install packages, and so on.</span></span>  <span data-ttu-id="85fa2-132">[PowerShell 資源庫](http://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title)中有許多其他 DSC 資源。</span><span class="sxs-lookup"><span data-stu-id="85fa2-132">There are many other DSC Resources in the [PowerShell Gallery](http://www.powershellgallery.com/packages?q=dsc+resources&prerelease=&sortOrder=package-title).</span></span>  <span data-ttu-id="85fa2-133">這些模組安裝到您的 Azure 自動化 DSC 提取伺服器 (由您安裝)，供您的組態使用。</span><span class="sxs-lookup"><span data-stu-id="85fa2-133">These modules are installed into your Azure Automation DSC Pull Server (by you) so they can be used by your configurations.</span></span>

<span data-ttu-id="85fa2-134">Resource Manager 範本以宣告方式產生基礎結構，例如網路、子網路、網路安全性和路由、負載平衡器、NIC、VM...等等。</span><span class="sxs-lookup"><span data-stu-id="85fa2-134">Resource Manager templates provide a declarative way of generating your infrastructure - things like networks, subnets, network security and routing, load balancers, NICs, VMs, and so on.</span></span>  <span data-ttu-id="85fa2-135">這篇[文章](../azure-resource-manager/resource-manager-deployment-model.md)比較 Resource Manager 部署模型 (宣告) 與 Azure 服務管理 (ASM 或傳統) 部署模型 (必要)，以及討論核心資源提供者、計算、儲存體和網路。</span><span class="sxs-lookup"><span data-stu-id="85fa2-135">Here’s an [article](../azure-resource-manager/resource-manager-deployment-model.md) that compares the Resource Manager deployment model (declarative) with the Azure Service Management (ASM, or classic) deployment model (imperative), and discusses the core resource providers, compute, storage and network.</span></span>

<span data-ttu-id="85fa2-136">Resource Manager 範本的主要功能之一是能夠在佈建時將 VM 延伸模組安裝至 VM 中。</span><span class="sxs-lookup"><span data-stu-id="85fa2-136">One key feature of an Resource Manager template is its ability to install a VM extension into the VM as it’s provisioned.</span></span>  <span data-ttu-id="85fa2-137">VM 延伸模組具有特定功能，例如執行自訂指令碼、安裝防毒軟體或執行 DSC 組態指令碼。</span><span class="sxs-lookup"><span data-stu-id="85fa2-137">A VM extension has specific capabilities such as running a custom script, installing anti-virus software, or running a DSC configuration script.</span></span>  <span data-ttu-id="85fa2-138">有許多其他類型的 VM 延伸模組。</span><span class="sxs-lookup"><span data-stu-id="85fa2-138">There are many other types of VM extensions.</span></span>

## <a name="quick-trip-around-the-diagram"></a><span data-ttu-id="85fa2-139">圖表速覽</span><span class="sxs-lookup"><span data-stu-id="85fa2-139">Quick trip around the diagram</span></span>
<span data-ttu-id="85fa2-140">從頂端開始，您撰寫程式碼、建置和測試，然後建立安裝封裝。</span><span class="sxs-lookup"><span data-stu-id="85fa2-140">Starting at the top, you write your code, build and test, then create an installation package.</span></span>  <span data-ttu-id="85fa2-141">Chocolatey 可以處理各種類型的安裝封裝，例如 MSI、MSU、ZIP 等。</span><span class="sxs-lookup"><span data-stu-id="85fa2-141">Chocolatey can handle various types of installation packages, such as MSI, MSU, ZIP.</span></span>  <span data-ttu-id="85fa2-142">如果 Chocolatey 的原生功能不是很足夠，您還有 PowerShell 的完整功能可執行實際安裝。</span><span class="sxs-lookup"><span data-stu-id="85fa2-142">And you have the full power of PowerShell to do the actual installation if Chocolatey’s native capabilities aren’t quite up to it.</span></span>  <span data-ttu-id="85fa2-143">將封裝放入隨手可得之處 – 封裝儲存機制。</span><span class="sxs-lookup"><span data-stu-id="85fa2-143">Put the package into someplace reachable – a package repository.</span></span>  <span data-ttu-id="85fa2-144">這個使用範例使用 Azure blob 儲存體帳戶中的公用資料夾，但可以是任何位置。</span><span class="sxs-lookup"><span data-stu-id="85fa2-144">This usage example uses a public folder in an Azure blob storage account, but it can be anywhere.</span></span>  <span data-ttu-id="85fa2-145">Chocolatey 可自然搭配 NuGet 伺服器和其他一些工具，一起管理封裝中繼資料。</span><span class="sxs-lookup"><span data-stu-id="85fa2-145">Chocolatey works natively with NuGet servers and a few others for management of package metadata.</span></span>  <span data-ttu-id="85fa2-146">[這篇文章](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed) 說明選項。</span><span class="sxs-lookup"><span data-stu-id="85fa2-146">[This article](https://github.com/chocolatey/choco/wiki/How-To-Host-Feed) describes the options.</span></span>  <span data-ttu-id="85fa2-147">這個使用範例使用 NuGet。</span><span class="sxs-lookup"><span data-stu-id="85fa2-147">This usage example uses NuGet.</span></span>  <span data-ttu-id="85fa2-148">Nuspec 是封裝的中繼資料。</span><span class="sxs-lookup"><span data-stu-id="85fa2-148">A Nuspec is metadata about your packages.</span></span>  <span data-ttu-id="85fa2-149">Nuspec 會「編譯」成 NuPkg，然後儲存在 NuGet 伺服器中。</span><span class="sxs-lookup"><span data-stu-id="85fa2-149">The Nuspec’s are “compiled” into NuPkg’s and stored in a NuGet server.</span></span>  <span data-ttu-id="85fa2-150">當您的組態依名稱要求某個封裝，而且參考 NuGet 伺服器時，Chocolatey DSC 資源 (現在位於 VM) 會為您抓取封裝並安裝。</span><span class="sxs-lookup"><span data-stu-id="85fa2-150">When your configuration requests a package by name, and references a NuGet server, the Chocolatey DSC Resource (now on the VM) grabs the package and installs it for you.</span></span>  <span data-ttu-id="85fa2-151">您也可以要求特定版本的封裝。</span><span class="sxs-lookup"><span data-stu-id="85fa2-151">You can also request a specific version of a package.</span></span>

<span data-ttu-id="85fa2-152">圖表左下方有一個 Azure 資源管理員 (ARM) 範本。</span><span class="sxs-lookup"><span data-stu-id="85fa2-152">In the bottom left portion of the picture, there is an Azure Resource Manager (ARM) template.</span></span>  <span data-ttu-id="85fa2-153">在這個使用範例中，VM 延伸模組將 VM 註冊到 Azure 自動化 DSC 提取伺服器 (也就是提取伺服器) 成為「節點」。</span><span class="sxs-lookup"><span data-stu-id="85fa2-153">In this usage example, the VM extension registers the VM with the Azure Automation DSC Pull Server (that is, a pull server) as a Node.</span></span>  <span data-ttu-id="85fa2-154">組態儲存在提取伺服器中。</span><span class="sxs-lookup"><span data-stu-id="85fa2-154">The configuration is stored in the pull server.</span></span>  <span data-ttu-id="85fa2-155">實際上儲存兩次：一次儲存為純文字，另一次編譯成 MOF 檔案 (適用於對此有所瞭解的人。)在入口網站，MOF 是「節點組態」(而非只是「組態」)。</span><span class="sxs-lookup"><span data-stu-id="85fa2-155">Actually, it’s stored twice: once as plain text and once compiled as an MOF file (for those that know about such things.)  In the portal, the MOF is a “node configuration” (as opposed to simply “configuration”).</span></span>  <span data-ttu-id="85fa2-156">它是與「節點」相關聯的構件，節點會知道它的組態。</span><span class="sxs-lookup"><span data-stu-id="85fa2-156">It’s the artifact that’s associated with a Node so the node will know its configuration.</span></span>  <span data-ttu-id="85fa2-157">下列詳細資料示範如何將節點組態指派給節點。</span><span class="sxs-lookup"><span data-stu-id="85fa2-157">Details below show how to assign the node configuration to the node.</span></span>

<span data-ttu-id="85fa2-158">想必您已在進行頂端的一些或大部分工作。</span><span class="sxs-lookup"><span data-stu-id="85fa2-158">Presumably you’re already doing the bit at the top, or most of it.</span></span>  <span data-ttu-id="85fa2-159">建立 nuspec、編譯和儲存在 NuGet 伺服器中很簡單。</span><span class="sxs-lookup"><span data-stu-id="85fa2-159">Creating the nuspec, compiling and storing it in a NuGet server is a small thing.</span></span>  <span data-ttu-id="85fa2-160">您已經在管理 VM。</span><span class="sxs-lookup"><span data-stu-id="85fa2-160">And you’re already managing VMs.</span></span>  <span data-ttu-id="85fa2-161">持續部署的下一步需要設定提取伺服器 (一次)、向它註冊節點 (一次)，然後建立組態並儲存到那裡 (初步)。</span><span class="sxs-lookup"><span data-stu-id="85fa2-161">Taking the next step to continuous deployment requires setting up the pull server (once), registering your nodes with it (once), and creating and storing the configuration there (initially).</span></span>  <span data-ttu-id="85fa2-162">接著，當封裝升級並部署至儲存機制時，請重新整理提取伺服器中的 [組態] 和 [節點組態] \(視需要重複)。</span><span class="sxs-lookup"><span data-stu-id="85fa2-162">Then as packages are upgraded and deployed to the repository, refresh the Configuration and Node Configuration in the pull server (repeat as needed).</span></span>

<span data-ttu-id="85fa2-163">如果不是從 ARM 範本開始，也沒關係。</span><span class="sxs-lookup"><span data-stu-id="85fa2-163">If you’re not starting with an ARM template, that’s also OK.</span></span>  <span data-ttu-id="85fa2-164">有一些 PowerShell Cmdlet 可協助您向提取伺服器註冊 VM，以及完成其餘所有工作。</span><span class="sxs-lookup"><span data-stu-id="85fa2-164">There are PowerShell cmdlets designed to help you register your VMs with the pull server and all of the rest.</span></span> <span data-ttu-id="85fa2-165">如需祥氣資訊，請參閱下列文章： [上架由 Azure 自動化 DSC 管理的機器](automation-dsc-onboarding.md)</span><span class="sxs-lookup"><span data-stu-id="85fa2-165">For more details, see this article: [Onboarding machines for management by Azure Automation DSC](automation-dsc-onboarding.md)</span></span>

## <a name="step-1-setting-up-the-pull-server-and-automation-account"></a><span data-ttu-id="85fa2-166">步驟 1：設定提取伺服器和自動化帳戶</span><span class="sxs-lookup"><span data-stu-id="85fa2-166">Step 1: Setting up the pull server and automation account</span></span>
<span data-ttu-id="85fa2-167">在已驗證的 (Add-AzureRmAccount) PowerShell 命令列：(設定提取伺服器可能需要幾分鐘時間)</span><span class="sxs-lookup"><span data-stu-id="85fa2-167">At an authenticated (Add-AzureRmAccount) PowerShell command line:  (can take a few minutes while the pull server is set up)</span></span>

    New-AzureRmResourceGroup –Name MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES
    New-AzureRmAutomationAccount –ResourceGroupName MY-AUTOMATION-RG –Location MY-RG-LOCATION-IN-QUOTES –Name MY-AUTOMATION-ACCOUNT 

<span data-ttu-id="85fa2-168">您可以將自動化帳戶放入下列任何區域 (也就是位置)︰美國東部 2、美國中南部、美國維吉尼亞州政府、西歐、東南亞、日本東部、印度中部和澳大利亞東南部、加拿大中部、北歐。</span><span class="sxs-lookup"><span data-stu-id="85fa2-168">You can put your automation account into any of the following regions (aka location):  East US 2, South Central US, US Gov Virginia, West Europe, Southeast Asia, Japan East, Central India and Australia Southeast, Canada Central, North Europe.</span></span>

## <a name="step-2-vm-extension-tweaks-to-the-arm-template"></a><span data-ttu-id="85fa2-169">步驟 2：VM 延伸模組根據 ARM 範本而調整</span><span class="sxs-lookup"><span data-stu-id="85fa2-169">Step 2: VM extension tweaks to the ARM template</span></span>
<span data-ttu-id="85fa2-170">此 [Azure 快速入門範本](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver)提供 VM 註冊的詳細資料 (使用 PowerShell DSC VM 延伸模組)。</span><span class="sxs-lookup"><span data-stu-id="85fa2-170">Details for VM registration (using the PowerShell DSC VM extension) provided in this [Azure Quickstart Template](https://github.com/Azure/azure-quickstart-templates/tree/master/dsc-extension-azure-automation-pullserver).</span></span>  <span data-ttu-id="85fa2-171">此步驟將新的 VM 註冊到提取伺服器的 DSC 節點清單中。</span><span class="sxs-lookup"><span data-stu-id="85fa2-171">This step registers your new VM with the pull server in the list of DSC Nodes.</span></span>  <span data-ttu-id="85fa2-172">這項註冊的一部分會指定要套用至節點的節點組態。</span><span class="sxs-lookup"><span data-stu-id="85fa2-172">Part of this registration is specifying the node configuration to be applied to the node.</span></span>  <span data-ttu-id="85fa2-173">此節點組態尚無須存在於提取伺服器中，因此這個動作可以在步驟 4 中首次執行。</span><span class="sxs-lookup"><span data-stu-id="85fa2-173">This node configuration doesn't have to exist yet in the pull server, so it's OK that Step 4 is where this is done for the first time.</span></span>  <span data-ttu-id="85fa2-174">但在步驟 2 中，您必須決定節點名稱和組態名稱。</span><span class="sxs-lookup"><span data-stu-id="85fa2-174">But here in Step 2 you do need to have decided the name of the node and the name of the configuration.</span></span>  <span data-ttu-id="85fa2-175">在此使用範例中，節點名稱是 'isvbox'，組態名稱是 'ISVBoxConfig'。</span><span class="sxs-lookup"><span data-stu-id="85fa2-175">In this usage example, the node is 'isvbox' and the configuration is 'ISVBoxConfig'.</span></span>  <span data-ttu-id="85fa2-176">因此，節點組態名稱 (將在 DeploymentTemplate.json 中指定) 是 'ISVBoxConfig.isvbox'。</span><span class="sxs-lookup"><span data-stu-id="85fa2-176">So the node configuration name (to be specified in DeploymentTemplate.json) is 'ISVBoxConfig.isvbox'.</span></span>  

## <a name="step-3-adding-required-dsc-resources-to-the-pull-server"></a><span data-ttu-id="85fa2-177">步驟 3：將所需的 DSC 資源加入到提取伺服器</span><span class="sxs-lookup"><span data-stu-id="85fa2-177">Step 3: Adding required DSC resources to the pull server</span></span>
<span data-ttu-id="85fa2-178">PowerShell 資源庫會自動將 DSC 資源安裝到您的 Azure 自動化帳戶。</span><span class="sxs-lookup"><span data-stu-id="85fa2-178">The PowerShell Gallery is instrumented to install DSC resources into your Azure Automation account.</span></span>  <span data-ttu-id="85fa2-179">瀏覽至您要的資源，按一下 [部署到 Azure 自動化] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="85fa2-179">Navigate to the resource you want and click the “Deploy to Azure Automation” button.</span></span>

![PowerShell 資源庫範例](./media/automation-dsc-cd-chocolatey/xNetworking.PNG)

<span data-ttu-id="85fa2-181">最近新增至 Azure 入口網站的另一種技術可讓您提取新模組或更新現有模組。</span><span class="sxs-lookup"><span data-stu-id="85fa2-181">Another technique recently added to the Azure Portal allows you to pull in new modules or update existing modules.</span></span> <span data-ttu-id="85fa2-182">按一下 [自動化帳戶資源]、[資產] 圖格和 [模組] 圖格。</span><span class="sxs-lookup"><span data-stu-id="85fa2-182">Click through the Automation Account resource, the Assets tile, and finally the Modules tile.</span></span>  <span data-ttu-id="85fa2-183">[瀏覽資源庫] 圖示可讓您查看資源庫的模組清單，深入了解詳細資料，並最終匯入您的自動化帳戶。</span><span class="sxs-lookup"><span data-stu-id="85fa2-183">The Browse Gallery icon allows you to see the list of modules in the gallery, drill down into details and ultimately import into your Automation Account.</span></span> <span data-ttu-id="85fa2-184">這是讓您的模組隨時保持最新狀態的絕佳方法。</span><span class="sxs-lookup"><span data-stu-id="85fa2-184">This is a great way to keep your modules up to date from time to time.</span></span> <span data-ttu-id="85fa2-185">而且，匯入功能會檢查與其他模組的相依性以確保所有模組都保持同步。</span><span class="sxs-lookup"><span data-stu-id="85fa2-185">And, the import feature checks dependencies with other modules to ensure nothing gets out of sync.</span></span>

<span data-ttu-id="85fa2-186">還有手動方法。</span><span class="sxs-lookup"><span data-stu-id="85fa2-186">Or, there’s the manual approach.</span></span>  <span data-ttu-id="85fa2-187">適用於 Windows 電腦的 PowerShell 整合模組的資料夾結構，與 Azure 自動化所需的資料夾結構稍有不同。</span><span class="sxs-lookup"><span data-stu-id="85fa2-187">The folder structure of a PowerShell Integration Module for a Windows computer is a little different from the folder structure expected by the Azure Automation.</span></span>  <span data-ttu-id="85fa2-188">您需要稍微調整一下。</span><span class="sxs-lookup"><span data-stu-id="85fa2-188">This requires a little tweaking on your part.</span></span>  <span data-ttu-id="85fa2-189">但並不難，每個資源只需要進行一次 (除非您將來想要升級。)如需關於撰寫 PowerShell 整合模組的詳細資訊，請參閱下列文章：[撰寫 Azure 自動化的整合模組](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/)</span><span class="sxs-lookup"><span data-stu-id="85fa2-189">But it’s not hard, and it’s done only once per resource (unless you want to upgrade it in future.)  For more information on authoring PowerShell Integration Modules, see this article: [Authoring Integration Modules for Azure Automation](https://azure.microsoft.com/blog/authoring-integration-modules-for-azure-automation/)</span></span>

* <span data-ttu-id="85fa2-190">將您需要的模組安裝在工作站，如下所示：</span><span class="sxs-lookup"><span data-stu-id="85fa2-190">Install the module that you need on your workstation, as follows:</span></span>
  * <span data-ttu-id="85fa2-191">安裝 [Windows Management Framework v5](http://aka.ms/wmf5latest) (Windows 10 不需安裝)</span><span class="sxs-lookup"><span data-stu-id="85fa2-191">Install [Windows Management Framework, v5](http://aka.ms/wmf5latest) (not needed for Windows 10)</span></span>
  * <span data-ttu-id="85fa2-192">`Install-Module –Name MODULE-NAME`    <—從 PowerShell 資源庫抓取模組</span><span class="sxs-lookup"><span data-stu-id="85fa2-192">`Install-Module –Name MODULE-NAME`    <—grabs the module from the PowerShell Gallery</span></span> 
* <span data-ttu-id="85fa2-193">從 `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` 模組資料夾複製到暫存資料夾</span><span class="sxs-lookup"><span data-stu-id="85fa2-193">Copy the module folder from `c:\Program Files\WindowsPowerShell\Modules\MODULE-NAME` to a temp folder</span></span> 
* <span data-ttu-id="85fa2-194">刪除主要資料夾中的範例和文件</span><span class="sxs-lookup"><span data-stu-id="85fa2-194">Delete samples and documentation from the main folder</span></span> 
* <span data-ttu-id="85fa2-195">壓縮主要資料夾，ZIP 檔案的命名與資料夾完全相同</span><span class="sxs-lookup"><span data-stu-id="85fa2-195">Zip the main folder, naming the ZIP file exactly the same as the folder</span></span> 
* <span data-ttu-id="85fa2-196">將 ZIP 檔案放到可存取的 HTTP 位置，例如 Azure 儲存體帳戶中的 Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="85fa2-196">Put the ZIP file into a reachable HTTP location, such as blob storage in an Azure Storage Account.</span></span>
* <span data-ttu-id="85fa2-197">執行此 PowerShell：</span><span class="sxs-lookup"><span data-stu-id="85fa2-197">Run this PowerShell:</span></span>
  
      New-AzureRmAutomationModule `
          -ResourceGroupName MY-AUTOMATION-RG -AutomationAccountName MY-AUTOMATION-ACCOUNT `
          -Name MODULE-NAME –ContentLink "https://STORAGE-URI/CONTAINERNAME/MODULE-NAME.zip"

<span data-ttu-id="85fa2-198">隨附的範例針對 cChoco 和 xNetworking 執行這些步驟。</span><span class="sxs-lookup"><span data-stu-id="85fa2-198">The included example performs these steps for cChoco and xNetworking.</span></span> <span data-ttu-id="85fa2-199">請參閱 [注意事項](#notes) ，了解 cChoco 的特殊處理方式。</span><span class="sxs-lookup"><span data-stu-id="85fa2-199">See the [Notes](#notes) for special handling for cChoco.</span></span>

## <a name="step-4-adding-the-node-configuration-to-the-pull-server"></a><span data-ttu-id="85fa2-200">步驟 4：將節點組態加入到提取伺服器</span><span class="sxs-lookup"><span data-stu-id="85fa2-200">Step 4: Adding the node configuration to the pull server</span></span>
<span data-ttu-id="85fa2-201">第一次將組態匯入到提取伺服器並編譯，並沒有什麼特殊之處。</span><span class="sxs-lookup"><span data-stu-id="85fa2-201">There’s nothing special about the first time you import your configuration into the pull server and compile.</span></span>  <span data-ttu-id="85fa2-202">後續匯入/編譯相同的組態時，過程完全相同。</span><span class="sxs-lookup"><span data-stu-id="85fa2-202">All subsequent import/compiles of the same configuration look exactly the same.</span></span>  <span data-ttu-id="85fa2-203">每次更新封裝且需要向外推送到生產環境時，在確定組態檔正確之後 (包括封裝的新版本)，就會執行此步驟。</span><span class="sxs-lookup"><span data-stu-id="85fa2-203">Each time you update your package and need to push it out to production you do this step after ensuring the configuration file is correct – including the new version of your package.</span></span>  <span data-ttu-id="85fa2-204">以下是組態檔和 PowerShell：</span><span class="sxs-lookup"><span data-stu-id="85fa2-204">Here’s the configuration file and PowerShell:</span></span>

<span data-ttu-id="85fa2-205">ISVBoxConfig.ps1：</span><span class="sxs-lookup"><span data-stu-id="85fa2-205">ISVBoxConfig.ps1:</span></span>

    Configuration ISVBoxConfig 
    { 
        Import-DscResource -ModuleName cChoco 
        Import-DscResource -ModuleName xNetworking

        Node "isvbox" {   

            cChocoInstaller installChoco 
            { 
                InstallDir = "C:\choco" 
            }

            WindowsFeature installIIS 
            { 
                Ensure="Present" 
                Name="Web-Server" 
            }

            xFirewall WebFirewallRule 
            { 
                Direction = "Inbound" 
                Name = "Web-Server-TCP-In" 
                DisplayName = "Web Server (TCP-In)" 
                Description = "IIS allow incoming web site traffic." 
                DisplayGroup = "IIS Incoming Traffic" 
                State = "Enabled" 
                Access = "Allow" 
                Protocol = "TCP" 
                LocalPort = "80" 
                Ensure = "Present" 
            }

            cChocoPackageInstaller trivialWeb 
            {            
                Name = "trivialweb" 
                Version = "1.0.0" 
                Source = “MY-NUGET-V2-SERVER-ADDRESS” 
                DependsOn = "[cChocoInstaller]installChoco", 
                "[WindowsFeature]installIIS" 
            } 
        }    
    }

<span data-ttu-id="85fa2-206">New-ConfigurationScript.ps1：</span><span class="sxs-lookup"><span data-stu-id="85fa2-206">New-ConfigurationScript.ps1:</span></span>

    Import-AzureRmAutomationDscConfiguration ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -SourcePath C:\temp\AzureAutomationDsc\ISVBoxConfig.ps1 ` 
        -Published –Force

    $jobData = Start-AzureRmAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -ConfigurationName ISVBoxConfig 

    $compilationJobId = $jobData.Id

    Get-AzureRmAutomationDscCompilationJob ` 
        -ResourceGroupName MY-AUTOMATION-RG –AutomationAccountName MY-AUTOMATION-ACCOUNT ` 
        -Id $compilationJobId

<span data-ttu-id="85fa2-207">這些步驟會產生要放在提取伺服器上的新節點組態，名為 "ISVBoxConfig.isvbox"。</span><span class="sxs-lookup"><span data-stu-id="85fa2-207">These steps result in a new node configuration named “ISVBoxConfig.isvbox” being placed on the pull server.</span></span>  <span data-ttu-id="85fa2-208">節點組態名稱的格式為 "configurationName.nodeName"。</span><span class="sxs-lookup"><span data-stu-id="85fa2-208">The node configuration name is built as “configurationName.nodeName”.</span></span>

## <a name="step-5-creating-and-maintaining-package-metadata"></a><span data-ttu-id="85fa2-209">步驟 5：建立和維護封裝中繼資料</span><span class="sxs-lookup"><span data-stu-id="85fa2-209">Step 5: Creating and maintaining package metadata</span></span>
<span data-ttu-id="85fa2-210">對於放入封裝儲存機制中的每一個封裝，您需要 nuspec 來描述它。</span><span class="sxs-lookup"><span data-stu-id="85fa2-210">For each package that you put into the package repository, you need a nuspec that describes it.</span></span>  <span data-ttu-id="85fa2-211">該 nuspec 必須編譯並儲存在 NuGet 伺服器中。</span><span class="sxs-lookup"><span data-stu-id="85fa2-211">That nuspec must be compiled and stored in your NuGet server.</span></span> <span data-ttu-id="85fa2-212">此程序的說明請參閱 [這裡](http://docs.nuget.org/create/creating-and-publishing-a-package)。</span><span class="sxs-lookup"><span data-stu-id="85fa2-212">This process is described [here](http://docs.nuget.org/create/creating-and-publishing-a-package).</span></span>  <span data-ttu-id="85fa2-213">您可以使用 MyGet.org 做為 NuGet 伺服器。</span><span class="sxs-lookup"><span data-stu-id="85fa2-213">You can use MyGet.org as a NuGet server.</span></span>  <span data-ttu-id="85fa2-214">他們銷售這項服務，但有免費的入門 SKU。</span><span class="sxs-lookup"><span data-stu-id="85fa2-214">They sell this service, but have a starter SKU that’s free.</span></span>  <span data-ttu-id="85fa2-215">在 NuGet.org，您可以找到為私人封裝來安裝 NuGet 伺服器的指示。</span><span class="sxs-lookup"><span data-stu-id="85fa2-215">At NuGet.org you’ll find instructions on installing your own NuGet server for your private packages.</span></span>

## <a name="step-6-tying-it-all-together"></a><span data-ttu-id="85fa2-216">步驟 6：整合一切</span><span class="sxs-lookup"><span data-stu-id="85fa2-216">Step 6: Tying it all together</span></span>
<span data-ttu-id="85fa2-217">每當有某個版本通過 QA 並核准可部署時，即會建立封裝，且 nuspec 及 nupkg 會更新並部署至 NuGet 伺服器。</span><span class="sxs-lookup"><span data-stu-id="85fa2-217">Each time a version passes QA and is approved for deployment, the package is created, nuspec and nupkg updated and deployed to the NuGet server.</span></span>  <span data-ttu-id="85fa2-218">此外也必須更新組態 (上述的步驟 4)，以符合新的版本號碼。</span><span class="sxs-lookup"><span data-stu-id="85fa2-218">In addition, the configuration (Step 4 above) must be updated to agree with the new version number.</span></span>  <span data-ttu-id="85fa2-219">它必須傳送至提取伺服器並進行編譯。</span><span class="sxs-lookup"><span data-stu-id="85fa2-219">It must be sent to the pull server and compiled.</span></span>  <span data-ttu-id="85fa2-220">從這裡開始，則須由依存於該組態的 VM 提取更新並加以安裝。</span><span class="sxs-lookup"><span data-stu-id="85fa2-220">From that point on, it's up to the VMs that depend on that configuration to pull the update and install it.</span></span>  <span data-ttu-id="85fa2-221">這些更新內容很簡單 - 只有一兩行 PowerShell。</span><span class="sxs-lookup"><span data-stu-id="85fa2-221">Each of these updates are simple - just a line or two of PowerShell.</span></span>  <span data-ttu-id="85fa2-222">以 Visual Studio Team Services 為例，有些更新會封裝在可一起鏈結在組建內的建置工作中。</span><span class="sxs-lookup"><span data-stu-id="85fa2-222">In the case of Visual Studio Team Services, some of them are encapsulated in build tasks that can be chained together in a build.</span></span>  <span data-ttu-id="85fa2-223">[本文](https://www.visualstudio.com/en-us/docs/alm-devops-feature-index#continuous-delivery)將詳加說明。</span><span class="sxs-lookup"><span data-stu-id="85fa2-223">This [article](https://www.visualstudio.com/en-us/docs/alm-devops-feature-index#continuous-delivery) provides more details.</span></span>  <span data-ttu-id="85fa2-224">此 [GitHub 儲存機制](https://github.com/Microsoft/vso-agent-tasks) 會詳細說明各種可用的建置工作。</span><span class="sxs-lookup"><span data-stu-id="85fa2-224">This [GitHub repo](https://github.com/Microsoft/vso-agent-tasks) details the various available build tasks.</span></span>

## <a name="notes"></a><span data-ttu-id="85fa2-225">注意事項</span><span class="sxs-lookup"><span data-stu-id="85fa2-225">Notes</span></span>
<span data-ttu-id="85fa2-226">此使用範例開頭的 VM 來自於 Azure 資源庫的一般 Windows Server 2012 R2 映像。</span><span class="sxs-lookup"><span data-stu-id="85fa2-226">This usage example starts with a VM from a generic Windows Server 2012 R2 image from the Azure gallery.</span></span>  <span data-ttu-id="85fa2-227">您可以從任何預存的映像開始，再從那裡使用 DSC 組態進行調整。</span><span class="sxs-lookup"><span data-stu-id="85fa2-227">You can start from any stored image and then tweak from there with the DSC configuration.</span></span>  <span data-ttu-id="85fa2-228">不過，變更已併入影像的組態，要比使用 DSC 動態更新組態難得多。</span><span class="sxs-lookup"><span data-stu-id="85fa2-228">However, changing configuration that is baked into an image is much harder than dynamically updating the configuration using DSC.</span></span>

<span data-ttu-id="85fa2-229">將這項技巧運用在 VM 時，不需要使用 ARM 範本和 VM 延伸模組。</span><span class="sxs-lookup"><span data-stu-id="85fa2-229">You don’t have to use an ARM template and the VM extension to use this technique with your VMs.</span></span>  <span data-ttu-id="85fa2-230">VM 不在 Azure 上也能由 CD 管理。</span><span class="sxs-lookup"><span data-stu-id="85fa2-230">And your VMs don’t have to be on Azure to be under CD management.</span></span>  <span data-ttu-id="85fa2-231">只需要在 VM 上安裝 Chocolatey 並設定 LCM 以得知提取伺服器所在位置即可。</span><span class="sxs-lookup"><span data-stu-id="85fa2-231">All that’s necessary is that Chocolatey be installed and the LCM configured on the VM so it knows where the pull server is.</span></span>  

<span data-ttu-id="85fa2-232">當然，在正式運作的 VM 上更新封裝時，VM 在安裝更新時必須脫離輪替。</span><span class="sxs-lookup"><span data-stu-id="85fa2-232">Of course, when you update a package on a VM that’s in production, you need to take that VM out of rotation while the update is installed.</span></span>  <span data-ttu-id="85fa2-233">視情況而定，作法會有很大的差異。</span><span class="sxs-lookup"><span data-stu-id="85fa2-233">How you do this varies widely.</span></span>  <span data-ttu-id="85fa2-234">例如，如果 VM 在 Azure 負載平衡器後方，您可以加入自訂探查。</span><span class="sxs-lookup"><span data-stu-id="85fa2-234">For example, with a VM behind an Azure Load Balancer, you can add a Custom Probe.</span></span>  <span data-ttu-id="85fa2-235">更新 VM 時，讓探查端點傳回 400。</span><span class="sxs-lookup"><span data-stu-id="85fa2-235">While updating the VM, have the probe endpoint return a 400.</span></span>  <span data-ttu-id="85fa2-236">可在組態中進行必要調整來引起此變更，但更新完成時，此調整會恢復成傳回 200。</span><span class="sxs-lookup"><span data-stu-id="85fa2-236">The tweak necessary to cause this change can be inside your configuration, as can the tweak to switch it back to returning a 200 once the update is complete.</span></span>

<span data-ttu-id="85fa2-237">此使用範例的完整原始檔位於 GitHub 上的 [Visual Studio 專案](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) 。</span><span class="sxs-lookup"><span data-stu-id="85fa2-237">Full source for this usage example is in [this Visual Studio project](https://github.com/sebastus/ARM/tree/master/CDIaaSVM) on GitHub.</span></span>

## <a name="related-articles"></a><span data-ttu-id="85fa2-238">相關文章</span><span class="sxs-lookup"><span data-stu-id="85fa2-238">Related Articles</span></span>
* [<span data-ttu-id="85fa2-239">Azure 自動化 DSC 概觀</span><span class="sxs-lookup"><span data-stu-id="85fa2-239">Azure Automation DSC Overview</span></span>](automation-dsc-overview.md)
* [<span data-ttu-id="85fa2-240">Azure 自動化 DSC Cmdlet</span><span class="sxs-lookup"><span data-stu-id="85fa2-240">Azure Automation DSC cmdlets</span></span>](https://msdn.microsoft.com/library/mt244122.aspx)
* [<span data-ttu-id="85fa2-241">上架由 Azure 自動化 DSC 管理的機器</span><span class="sxs-lookup"><span data-stu-id="85fa2-241">Onboarding machines for management by Azure Automation DSC</span></span>](automation-dsc-onboarding.md)

