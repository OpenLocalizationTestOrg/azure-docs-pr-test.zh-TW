---
title: "自動調整的最佳做法 | Microsoft Docs"
description: "在 Azure 中自動調整 Web 應用程式、虛擬機器擴展集和雲端服務的規模模式。"
author: anirudhcavale
manager: orenr
editor: 
services: monitoring-and-diagnostics
documentationcenter: monitoring-and-diagnostics
ms.assetid: 9fa2b94b-dfa5-4106-96ff-74fd1fba4657
ms.service: monitoring-and-diagnostics
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/07/2017
ms.author: ancav
ms.openlocfilehash: 54dad831287376db7fb2dc46e4591be1499dc072
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/03/2017
---
# <a name="best-practices-for-autoscale"></a><span data-ttu-id="45e60-103">自動調整規模的最佳做法</span><span class="sxs-lookup"><span data-stu-id="45e60-103">Best practices for Autoscale</span></span>
<span data-ttu-id="45e60-104">本文會說明在 Azure 中自動調整的最佳做法。</span><span class="sxs-lookup"><span data-stu-id="45e60-104">This article teaches best practices to autoscale in Azure.</span></span> <span data-ttu-id="45e60-105">Azure 監視器自動調整僅適用於[虛擬機器擴展集](https://azure.microsoft.com/services/virtual-machine-scale-sets/)、[雲端服務](https://azure.microsoft.com/services/cloud-services/)和 [App Service - Web Apps](https://azure.microsoft.com/services/app-service/web/)。</span><span class="sxs-lookup"><span data-stu-id="45e60-105">Azure Monitor autoscale applies only to [Virtual Machine Scale Sets](https://azure.microsoft.com/services/virtual-machine-scale-sets/), [Cloud Services](https://azure.microsoft.com/services/cloud-services/), and [App Service - Web Apps](https://azure.microsoft.com/services/app-service/web/).</span></span> <span data-ttu-id="45e60-106">其他 Azure 服務使用不同的調整方法。</span><span class="sxs-lookup"><span data-stu-id="45e60-106">Other Azure services use different scaling methods.</span></span>

## <a name="autoscale-concepts"></a><span data-ttu-id="45e60-107">自動調整的概念</span><span class="sxs-lookup"><span data-stu-id="45e60-107">Autoscale concepts</span></span>
* <span data-ttu-id="45e60-108">資源可以只有「一項」  自動調整設定。</span><span class="sxs-lookup"><span data-stu-id="45e60-108">A resource can have only *one* autoscale setting</span></span>
* <span data-ttu-id="45e60-109">自動調整設定可有一或多個設定檔，而且每個設定檔都能有一或多項自動調整規則。</span><span class="sxs-lookup"><span data-stu-id="45e60-109">An autoscale setting can have one or more profiles and each profile can have one or more autoscale rules.</span></span>
* <span data-ttu-id="45e60-110">自動調整設定會水平調整執行個體，其中「相應放大」為增加執行個體數量，而「相應縮小」則是減少執行個體數量。</span><span class="sxs-lookup"><span data-stu-id="45e60-110">An autoscale setting scales instances horizontally, which is *out* by increasing the instances and *in* by decreasing the number of instances.</span></span>
  <span data-ttu-id="45e60-111">自動調整設定可設定執行個體數的最大值、最小值及預設值。</span><span class="sxs-lookup"><span data-stu-id="45e60-111">An autoscale setting has a maximum, minimum, and default value of instances.</span></span>
* <span data-ttu-id="45e60-112">自動調整作業一律會讀取相關聯的度量作為調整依據，據此檢查其是否超過設定的臨界值，以執行相應放大或相應縮小。</span><span class="sxs-lookup"><span data-stu-id="45e60-112">An autoscale job always reads the associated metric to scale by, checking if it has crossed the configured threshold for scale-out or scale-in.</span></span> <span data-ttu-id="45e60-113">您可以在 [Azure 監視器自動調整的常見度量](insights-autoscale-common-metrics.md)中，檢視自動調整據以調整的度量清單。</span><span class="sxs-lookup"><span data-stu-id="45e60-113">You can view a list of metrics that autoscale can scale by at [Azure Monitor autoscaling common metrics](insights-autoscale-common-metrics.md).</span></span>
* <span data-ttu-id="45e60-114">所有臨界值都是在執行個體層級計算。</span><span class="sxs-lookup"><span data-stu-id="45e60-114">All thresholds are calculated at an instance level.</span></span> <span data-ttu-id="45e60-115">例如，「當執行個體計數為 2 時，若平均 CPU > 80% ，即相應放大 1 個執行個體」表示當所有執行個體的平均 CPU 大於 80% 時即相應放大。</span><span class="sxs-lookup"><span data-stu-id="45e60-115">For example, "scale out by 1 instance when average CPU > 80% when instance count is 2", means scale-out when the average CPU across all instances is greater than 80%.</span></span>
* <span data-ttu-id="45e60-116">您一律會從電子郵件收到失敗通知。</span><span class="sxs-lookup"><span data-stu-id="45e60-116">You always receive failure notifications via email.</span></span> <span data-ttu-id="45e60-117">具體而言，目標資源的擁有者、參與者與讀者都會收到電子郵件。</span><span class="sxs-lookup"><span data-stu-id="45e60-117">Specifically, the owner, contributor, and readers of the target resource receive email.</span></span> <span data-ttu-id="45e60-118">當自動調整從失敗復原並開始正常運作時，您也一律會收到「復原」電子郵件。</span><span class="sxs-lookup"><span data-stu-id="45e60-118">You also always receive a *recovery* email when autoscale recovers from a failure and starts functioning normally.</span></span>
* <span data-ttu-id="45e60-119">您可以選擇從電子郵件及 Webhook 接收調整動作成功的通知。</span><span class="sxs-lookup"><span data-stu-id="45e60-119">You can opt-in to receive a successful scale action notification via email and webhooks.</span></span>

## <a name="autoscale-best-practices"></a><span data-ttu-id="45e60-120">自動調整最佳做法</span><span class="sxs-lookup"><span data-stu-id="45e60-120">Autoscale best practices</span></span>
<span data-ttu-id="45e60-121">使用自動調整時，請使用下列最佳做法。</span><span class="sxs-lookup"><span data-stu-id="45e60-121">Use the following best practices as you use autoscale.</span></span>

### <a name="ensure-the-maximum-and-minimum-values-are-different-and-have-an-adequate-margin-between-them"></a><span data-ttu-id="45e60-122">確定最大值與最小值不同，而且兩者之間有差距適當。</span><span class="sxs-lookup"><span data-stu-id="45e60-122">Ensure the maximum and minimum values are different and have an adequate margin between them</span></span>
<span data-ttu-id="45e60-123">若設定的最小值等於 2，而最大值也等於 2，且目前執行個體計數為 2，將不會有任何調整動作。</span><span class="sxs-lookup"><span data-stu-id="45e60-123">If you have a setting that has minimum=2, maximum=2 and the current instance count is 2, no scale action can occur.</span></span> <span data-ttu-id="45e60-124">在執行個體計數的最大值與最小值之間 (含這兩個值)，需保留適當的差距。</span><span class="sxs-lookup"><span data-stu-id="45e60-124">Keep an adequate margin between the maximum and minimum instance counts, which are inclusive.</span></span> <span data-ttu-id="45e60-125">在這些限制之間，一定律會自動調整。</span><span class="sxs-lookup"><span data-stu-id="45e60-125">Autoscale always scales between these limits.</span></span>

### <a name="manual-scaling-is-reset-by-autoscale-min-and-max"></a><span data-ttu-id="45e60-126">自動調整的最小值與最大值會重設手動調整</span><span class="sxs-lookup"><span data-stu-id="45e60-126">Manual scaling is reset by autoscale min and max</span></span>
<span data-ttu-id="45e60-127">如果您手動將執行個體計數的值更新為高於最大值或低於最小值，自動調整引擎會自動調整回最小值 (如果低於) 或最大值 (如果高於)。</span><span class="sxs-lookup"><span data-stu-id="45e60-127">If you manually update the instance count to a value above or below the maximum, the autoscale engine automatically scales back to the minimum (if below) or the maximum (if above).</span></span> <span data-ttu-id="45e60-128">例如，您設定的範圍是 3 到 6。</span><span class="sxs-lookup"><span data-stu-id="45e60-128">For example, you set the range between 3 and 6.</span></span> <span data-ttu-id="45e60-129">如果您有一個執行執行個體正在執行，自動調整引擎會在它下次執行時調整為 3 個執行個體。</span><span class="sxs-lookup"><span data-stu-id="45e60-129">If you have one running instance, the autoscale engine scales to 3 instances on its next run.</span></span> <span data-ttu-id="45e60-130">同樣地，它會將 8 個執行個體，在下次執行時相應縮小至 6 個。</span><span class="sxs-lookup"><span data-stu-id="45e60-130">Likewise, it would scale-in 8 instances back to 6 on its next run.</span></span>  <span data-ttu-id="45e60-131">手動調整是暫時的，除非您也同時重設自動調整規則。</span><span class="sxs-lookup"><span data-stu-id="45e60-131">Manual scaling is very temporary unless you reset the autoscale rules as well.</span></span>

### <a name="always-use-a-scale-out-and-scale-in-rule-combination-that-performs-an-increase-and-decrease"></a><span data-ttu-id="45e60-132">請一律使用相應放大和相應縮小規則的組合來執行增加與減少。</span><span class="sxs-lookup"><span data-stu-id="45e60-132">Always use a scale-out and scale-in rule combination that performs an increase and decrease</span></span>
<span data-ttu-id="45e60-133">若您只使用組合中的其中一部分，則自動調整只會相應放大或縮小該單邊，直到達到最大值或最小值為止。</span><span class="sxs-lookup"><span data-stu-id="45e60-133">If you use only one part of the combination, autoscale scale-in that single out, or in, until the maximum, or minimum, is reached.</span></span>

### <a name="do-not-switch-between-the-azure-portal-and-the-azure-classic-portal-when-managing-autoscale"></a><span data-ttu-id="45e60-134">管理自動調整時，請勿切換使用 Azure 入口網站與 Azure 傳統入口網站。</span><span class="sxs-lookup"><span data-stu-id="45e60-134">Do not switch between the Azure portal and the Azure classic portal when managing Autoscale</span></span>
<span data-ttu-id="45e60-135">若是雲端服務及應用程式服務 (Web Apps)，請使用 Azure 入口網站 (portal.azure.com) 建立及管理自動調整設定。</span><span class="sxs-lookup"><span data-stu-id="45e60-135">For Cloud Services and App Services (Web Apps), use the Azure portal (portal.azure.com) to create and manage autoscale settings.</span></span> <span data-ttu-id="45e60-136">若是虛擬機器擴展集，請使用 PowerShell、CLI 或 REST API 建立及管理自動調整設定。</span><span class="sxs-lookup"><span data-stu-id="45e60-136">For Virtual Machine Scale Sets use PowerShell, CLI or REST API to create and manage autoscale setting.</span></span> <span data-ttu-id="45e60-137">管理自動調整設定時，請勿切換使用 Azure 傳統入口網站 (manage.windowsazure.com) 與 Azure 入口網站 (portal.azure.com)。</span><span class="sxs-lookup"><span data-stu-id="45e60-137">Do not switch between the Azure classic portal (manage.windowsazure.com) and the Azure portal (portal.azure.com) when managing autoscale configurations.</span></span> <span data-ttu-id="45e60-138">Azure 傳統入口網站及其基礎後端有其限制。</span><span class="sxs-lookup"><span data-stu-id="45e60-138">The Azure classic portal and its underlying backend has limitations.</span></span> <span data-ttu-id="45e60-139">請使用 Azure 入口網站的圖形化使用者介面來管理自動調整。</span><span class="sxs-lookup"><span data-stu-id="45e60-139">Move to the Azure portal to manage autoscale using a graphical user interface.</span></span> <span data-ttu-id="45e60-140">此外也可選擇使用自動調整 PowerShell、CLI 或 REST API (透過 Azure 資源總管)。</span><span class="sxs-lookup"><span data-stu-id="45e60-140">The options are to use the autoscale PowerShell, CLI or REST API (via Azure Resource Explorer).</span></span>

### <a name="choose-the-appropriate-statistic-for-your-diagnostics-metric"></a><span data-ttu-id="45e60-141">為您的診斷度量選擇適當的統計資料</span><span class="sxs-lookup"><span data-stu-id="45e60-141">Choose the appropriate statistic for your diagnostics metric</span></span>
<span data-ttu-id="45e60-142">針對診斷度量，您可以選擇 [平均值]、[最小值]、[最大值] 和 [總計] 作為據以調整的度量。</span><span class="sxs-lookup"><span data-stu-id="45e60-142">For diagnostics metrics, you can choose among *Average*, *Minimum*, *Maximum* and *Total* as a metric to scale by.</span></span> <span data-ttu-id="45e60-143">最常用的統計資料是 [平均值] 。</span><span class="sxs-lookup"><span data-stu-id="45e60-143">The most common statistic is *Average*.</span></span>

### <a name="choose-the-thresholds-carefully-for-all-metric-types"></a><span data-ttu-id="45e60-144">請小心選擇所有度量類型的臨界值</span><span class="sxs-lookup"><span data-stu-id="45e60-144">Choose the thresholds carefully for all metric types</span></span>
<span data-ttu-id="45e60-145">建議您根據實際情況，小心選擇不同的相應放大與相應縮小臨界值。</span><span class="sxs-lookup"><span data-stu-id="45e60-145">We recommend carefully choosing different thresholds for scale-out and scale-in based on practical situations.</span></span>

<span data-ttu-id="45e60-146">「不建議使用」  自動調整設定，例如下列範例中，將放大及縮小的臨界值設為相同的值或極類似的值：</span><span class="sxs-lookup"><span data-stu-id="45e60-146">We *do not recommend* autoscale settings like the examples below with the same or very similar threshold values for out and in conditions:</span></span>

* <span data-ttu-id="45e60-147">當執行緒計數 <= 600 時，增加 1 個執行個體</span><span class="sxs-lookup"><span data-stu-id="45e60-147">Increase instances by 1 count when Thread Count <= 600</span></span>
* <span data-ttu-id="45e60-148">當執行緒計數 >= 600 時，減少 1 個執行個體</span><span class="sxs-lookup"><span data-stu-id="45e60-148">Decrease instances by 1 count when Thread Count >= 600</span></span>

<span data-ttu-id="45e60-149">下列範例顯示可能會導致行為混淆的設定。</span><span class="sxs-lookup"><span data-stu-id="45e60-149">Let's look at an example of what can lead to a behavior that may seem confusing.</span></span> <span data-ttu-id="45e60-150">考量以下發生順序。</span><span class="sxs-lookup"><span data-stu-id="45e60-150">Consider the following sequence.</span></span>

1. <span data-ttu-id="45e60-151">假設一開始只有 2 個執行個體，之後每個執行個體的平均執行緒數成長為 625。</span><span class="sxs-lookup"><span data-stu-id="45e60-151">Assume there are 2 instances to begin with and then the average number of threads per instance grows to 625.</span></span>
2. <span data-ttu-id="45e60-152">自動調整會隨之相應放大，加入第 3 個執行個體。</span><span class="sxs-lookup"><span data-stu-id="45e60-152">Autoscale scales out adding a 3rd instance.</span></span>
3. <span data-ttu-id="45e60-153">假設接下來執行個體的平均執行緒計數降至 575，</span><span class="sxs-lookup"><span data-stu-id="45e60-153">Next, assume that the average thread count across instance falls to 575.</span></span>
4. <span data-ttu-id="45e60-154">則在相應減少之前，自動調整會嘗試評估相應縮小後的最終狀態。</span><span class="sxs-lookup"><span data-stu-id="45e60-154">Before scaling down, autoscale tries to estimate what the final state will be if it scaled in.</span></span> <span data-ttu-id="45e60-155">例如，575 x 3 (目前的執行個體計數) = 1,725 / 2 (相應減少後的最終執行個體數) = 862.5 個執行緒。</span><span class="sxs-lookup"><span data-stu-id="45e60-155">For example, 575 x  3 (current instance count) = 1,725 / 2 (final number of instances when scaled down) = 862.5 threads.</span></span> <span data-ttu-id="45e60-156">這表示即便平均執行緒計數維持不變，或甚至降至極少量，自動調整仍須在相應縮小之後立即再相應放大。</span><span class="sxs-lookup"><span data-stu-id="45e60-156">This means autoscale would have to immediately scale-out again even after it scaled in, if the average thread count remains the same or even falls only a small amount.</span></span> <span data-ttu-id="45e60-157">但自動調整若再相應增加，整個程序將會重複執行，進行產生無限迴圈。</span><span class="sxs-lookup"><span data-stu-id="45e60-157">However, if it scaled up again, the whole process would repeat, leading to an infinite loop.</span></span>
5. <span data-ttu-id="45e60-158">為了避免這種「不穩定」的狀況，自動調整根本不會相應減少，</span><span class="sxs-lookup"><span data-stu-id="45e60-158">To avoid this situation (termed "flapping"), autoscale does not scale down at all.</span></span> <span data-ttu-id="45e60-159">而會在下次執行服務的工作時略過並重新評估條件。</span><span class="sxs-lookup"><span data-stu-id="45e60-159">Instead, it skips and reevaluates the condition again the next time the service's job executes.</span></span> <span data-ttu-id="45e60-160">這可能會讓許多人困惑不已，因為當平均執行緒計數達到 575 時，自動調整完全不運作。</span><span class="sxs-lookup"><span data-stu-id="45e60-160">This could confuse many people because autoscale wouldn't appear to work when the average thread count was 575.</span></span>

<span data-ttu-id="45e60-161">相應縮小期間的估計是為了避免「不穩定」情況 (持續地反覆相應縮小和相應放大動作)。</span><span class="sxs-lookup"><span data-stu-id="45e60-161">Estimation during a scale-in is intended to avoid "flapping" situations, where scale-in and scale-out actions continually go back and forth.</span></span> <span data-ttu-id="45e60-162">當您為相應放大及相應縮小選擇相同的臨界值時，請注意這項行為。</span><span class="sxs-lookup"><span data-stu-id="45e60-162">Keep this behavior in mind when you choose the same thresholds for scale-out and in.</span></span>

<span data-ttu-id="45e60-163">建議您在選擇相應放大及相應縮小的臨界值時，為兩者之間保留適當的差距。</span><span class="sxs-lookup"><span data-stu-id="45e60-163">We recommend choosing an adequate margin between the scale-out and in thresholds.</span></span> <span data-ttu-id="45e60-164">例如您可以考慮下列比較適當的規則組合。</span><span class="sxs-lookup"><span data-stu-id="45e60-164">As an example, consider the following better rule combination.</span></span>

* <span data-ttu-id="45e60-165">當 CPU% >= 80 時，增加 1 個執行個體</span><span class="sxs-lookup"><span data-stu-id="45e60-165">Increase instances by 1 count when CPU%  >= 80</span></span>
* <span data-ttu-id="45e60-166">當 CPU% <= 60 時，減少 1 個執行個體</span><span class="sxs-lookup"><span data-stu-id="45e60-166">Decrease instances by 1 count when CPU% <= 60</span></span>

<span data-ttu-id="45e60-167">在此案例中</span><span class="sxs-lookup"><span data-stu-id="45e60-167">In this case</span></span>  

1. <span data-ttu-id="45e60-168">假設一開始只有 2 個執行個體，</span><span class="sxs-lookup"><span data-stu-id="45e60-168">Assume there are 2 instances to start with.</span></span>
2. <span data-ttu-id="45e60-169">當執行個體的平均 CPU% 達到 80 時，自動調整會隨之相應放大，加入第 3 個執行個體。</span><span class="sxs-lookup"><span data-stu-id="45e60-169">If the average CPU% across instances goes to 80, autoscale scales out adding a third instance.</span></span>
3. <span data-ttu-id="45e60-170">假設 CPU% 在經過一段時間後降至 60。</span><span class="sxs-lookup"><span data-stu-id="45e60-170">Now assume that over time the CPU% falls to 60.</span></span>
4. <span data-ttu-id="45e60-171">自動調整的相應縮小規會先評估相應縮小之後的最終狀態。</span><span class="sxs-lookup"><span data-stu-id="45e60-171">Autoscale's scale-in rule estimates the final state if it were to scale-in.</span></span> <span data-ttu-id="45e60-172">例如 60x3 (目前的執行個體計數) = 180/2 (相應減少時的最終執行個體數) = 90。</span><span class="sxs-lookup"><span data-stu-id="45e60-172">For example, 60 x 3 (current instance count) = 180 / 2 (final number of instances when scaled down) = 90.</span></span> <span data-ttu-id="45e60-173">因為自動調整必須再於相應減少之後隨即相應放大，所以其不會相應縮小，</span><span class="sxs-lookup"><span data-stu-id="45e60-173">So autoscale does not scale-in because it would have to scale-out again immediately.</span></span> <span data-ttu-id="45e60-174">而會略過相應減少。</span><span class="sxs-lookup"><span data-stu-id="45e60-174">Instead, it skips scaling down.</span></span>
5. <span data-ttu-id="45e60-175">下一次自動調整檢查，CPU 會繼續歸類為 50。</span><span class="sxs-lookup"><span data-stu-id="45e60-175">The next time autoscale checks, the CPU continues to fall to 50.</span></span> <span data-ttu-id="45e60-176">再次進行評估：50 x 3 個執行個體 = 150/2 個執行個體 = 75 (低於相應放大臨界值 80)，所以會依設定相應放大到 2 個執行個體。</span><span class="sxs-lookup"><span data-stu-id="45e60-176">It estimates again -  50 x 3 instance = 150 / 2 instances = 75, which is below the scale-out threshold of 80, so it scales in successfully to 2 instances.</span></span>

### <a name="considerations-for-scaling-threshold-values-for-special-metrics"></a><span data-ttu-id="45e60-177">調整特殊度量之臨界值時的注意事項</span><span class="sxs-lookup"><span data-stu-id="45e60-177">Considerations for scaling threshold values for special metrics</span></span>
 <span data-ttu-id="45e60-178">對於特殊度量 (例如儲存體或服務匯流排佇列長度度量)，臨界值目前執行個體數所能使用的平均訊息數。</span><span class="sxs-lookup"><span data-stu-id="45e60-178">For special metrics such as Storage or Service Bus Queue length metric, the threshold is the average number of messages available per current number of instances.</span></span> <span data-ttu-id="45e60-179">請謹慎選擇此度量的臨界值。</span><span class="sxs-lookup"><span data-stu-id="45e60-179">Carefully choose the choose the threshold value for this metric.</span></span>

<span data-ttu-id="45e60-180">現在讓我們利用下列範例為您說明，讓您對此行為有更深入的了解。</span><span class="sxs-lookup"><span data-stu-id="45e60-180">Let's illustrate it with an example to ensure you understand the behavior better.</span></span>

* <span data-ttu-id="45e60-181">當儲存體佇列訊息計數 >= 50 時，增加 1 個執行個體</span><span class="sxs-lookup"><span data-stu-id="45e60-181">Increase instances by 1 count when Storage Queue message count >= 50</span></span>
* <span data-ttu-id="45e60-182">當儲存體佇列訊息計數 <= 10 時，減少 1 個執行個體</span><span class="sxs-lookup"><span data-stu-id="45e60-182">Decrease instances by 1 count when Storage Queue message count <= 10</span></span>

<span data-ttu-id="45e60-183">考量以下發生順序：</span><span class="sxs-lookup"><span data-stu-id="45e60-183">Consider the following sequence:</span></span>

1. <span data-ttu-id="45e60-184">有 2 個儲存體佇列執行個體。</span><span class="sxs-lookup"><span data-stu-id="45e60-184">There are 2 storage queue instances.</span></span>
2. <span data-ttu-id="45e60-185">隨著訊息不斷傳入，當您檢閱儲存體佇列時，訊息計數達到 50。</span><span class="sxs-lookup"><span data-stu-id="45e60-185">Messages keep coming and when you review the storage queue, the total count reads 50.</span></span> <span data-ttu-id="45e60-186">您可能認為自動調整應執行相應放大動作。</span><span class="sxs-lookup"><span data-stu-id="45e60-186">You might assume that autoscale should start a scale-out action.</span></span> <span data-ttu-id="45e60-187">但請注意，自動調整仍然是每個執行個體 50/2 =  25 則訊息，</span><span class="sxs-lookup"><span data-stu-id="45e60-187">However, note that it is still 50/2 = 25 messages per instance.</span></span> <span data-ttu-id="45e60-188">因此不會進行相應放大。</span><span class="sxs-lookup"><span data-stu-id="45e60-188">So, scale-out does not occur.</span></span> <span data-ttu-id="45e60-189">若要執行第一次相應放大，儲存體佇列中的總訊息計數應達到 100。</span><span class="sxs-lookup"><span data-stu-id="45e60-189">For the first scale-out to happen, the total message count in the storage queue should be 100.</span></span>
3. <span data-ttu-id="45e60-190">當總訊息計數達到 100 時，</span><span class="sxs-lookup"><span data-stu-id="45e60-190">Next, assume that the total message count reaches 100.</span></span>
4. <span data-ttu-id="45e60-191">就會執行相應放大動作而加入第 3 個儲存體執行個體。</span><span class="sxs-lookup"><span data-stu-id="45e60-191">A 3rd storage queue instance is added due to a scale-out action.</span></span>  <span data-ttu-id="45e60-192">除非佇列中的總訊息計數達到 150 (因為 150/3=50)，否則不會執行下一個相應放大動作。</span><span class="sxs-lookup"><span data-stu-id="45e60-192">The next scale-out action will not happen until the total message count in the queue reaches 150 because 150/3 = 50.</span></span>
5. <span data-ttu-id="45e60-193">現在，佇列中的估計訊息數目便會變小。</span><span class="sxs-lookup"><span data-stu-id="45e60-193">Now the number of messages in the queue gets smaller.</span></span> <span data-ttu-id="45e60-194">若有 3 個執行個體，當所有佇列中的總訊息數相加達到 30 時，會執行第一次相應縮小動作，意即臨界值是每個執行個體的規模為 30/3 = 10 則訊息。</span><span class="sxs-lookup"><span data-stu-id="45e60-194">With 3 instances, the first scale-in action happens when the total messages in all queues add up to 30 because 30/3 = 10 messages per instance, which is the scale-in threshold.</span></span>

### <a name="considerations-for-scaling-when-multiple-profiles-are-configured-in-an-autoscale-setting"></a><span data-ttu-id="45e60-195">當自動調整設定中設有多個設定檔時的調整注意事項</span><span class="sxs-lookup"><span data-stu-id="45e60-195">Considerations for scaling when multiple profiles are configured in an autoscale setting</span></span>
<span data-ttu-id="45e60-196">您可以在自動調整設定中選擇預設設定檔 (當沒有任何項目取決於排程或時間時套用)，也可以選擇週期性設定檔或期間固定的設定檔 (設有日期與時間範圍)。</span><span class="sxs-lookup"><span data-stu-id="45e60-196">In an autoscale setting, you can choose a default profile, which is always applied without any dependency on schedule or time, or you can choose a recurring profile or a profile for a fixed period with a date and time range.</span></span>

<span data-ttu-id="45e60-197">當自動調整服務在處理這些設定時，一律會依下列順序進行檢查︰</span><span class="sxs-lookup"><span data-stu-id="45e60-197">When autoscale service processes them, it always checks in the following order:</span></span>

1. <span data-ttu-id="45e60-198">固定日期設定檔</span><span class="sxs-lookup"><span data-stu-id="45e60-198">Fixed Date profile</span></span>
2. <span data-ttu-id="45e60-199">週期性設定檔</span><span class="sxs-lookup"><span data-stu-id="45e60-199">Recurring profile</span></span>
3. <span data-ttu-id="45e60-200">預設 (一律) 設定檔</span><span class="sxs-lookup"><span data-stu-id="45e60-200">Default ("Always") profile</span></span>

<span data-ttu-id="45e60-201">若符合設定檔條件，自動調整將不再檢查接下來的下一項設定檔條件。</span><span class="sxs-lookup"><span data-stu-id="45e60-201">If a profile condition is met, autoscale does not check the next profile condition below it.</span></span> <span data-ttu-id="45e60-202">自動調整一次只會處理一個設定檔。</span><span class="sxs-lookup"><span data-stu-id="45e60-202">Autoscale only processes one profile at a time.</span></span> <span data-ttu-id="45e60-203">這表示若您想要加入低層設定檔中的處理條件，也必須同時將這些規則加入目前的設定檔中。</span><span class="sxs-lookup"><span data-stu-id="45e60-203">This means if you want to also include a processing condition from a lower-tier profile, you must include those rules as well in the current profile.</span></span>

<span data-ttu-id="45e60-204">請參考下列示範範例︰</span><span class="sxs-lookup"><span data-stu-id="45e60-204">Let's review this using an example:</span></span>

<span data-ttu-id="45e60-205">下圖顯示的自動調整設定中，其預設設定檔的最小執行個體數 = 2，最大執行個體數 = 10。</span><span class="sxs-lookup"><span data-stu-id="45e60-205">The image below shows an autoscale setting with a default profile of minimum instances = 2 and maximum instances = 10.</span></span> <span data-ttu-id="45e60-206">此範例將規則設定成當佇列中的訊息計數大於 10 時執行相應放大，當佇列中的訊息計數小於 3 時執行相應縮小。</span><span class="sxs-lookup"><span data-stu-id="45e60-206">In this example, rules are configured to scale-out when the message count in the queue is greater than 10 and scale-in when the message count in the queue is less than 3.</span></span> <span data-ttu-id="45e60-207">因此我們現在可以將資源調整為 2 到 10 個執行個體。</span><span class="sxs-lookup"><span data-stu-id="45e60-207">So now the resource can scale between 2 and 10 instances.</span></span>

<span data-ttu-id="45e60-208">此外，星期一設定成使用週期性設定檔，</span><span class="sxs-lookup"><span data-stu-id="45e60-208">In addition, there is a recurring profile set for Monday.</span></span> <span data-ttu-id="45e60-209">其中最小執行個體數 = 2，最大執行個體數 = 12。</span><span class="sxs-lookup"><span data-stu-id="45e60-209">It is set for minimum instances = 2 and maximum instances = 12.</span></span> <span data-ttu-id="45e60-210">這表示在星期一時，自動調整會在第一次檢查此條件；當執行個體計數為 2 時，會將其調整為新的最小值 3。</span><span class="sxs-lookup"><span data-stu-id="45e60-210">This means on Monday, the first time autoscale checks for this condition, if the instance count is 2, it scales to the new minimum of 3.</span></span> <span data-ttu-id="45e60-211">只要自動調整持續比對此設定檔條件 (星期一)，其便只會按照此設定檔中設定的規則，依據 CPU 執行相應放大/縮小。</span><span class="sxs-lookup"><span data-stu-id="45e60-211">As long as autoscale continues to find this profile condition matched (Monday), it only processes the CPU-based scale-out/in rules configured for this profile.</span></span> <span data-ttu-id="45e60-212">此時不會檢查佇列長度。</span><span class="sxs-lookup"><span data-stu-id="45e60-212">At this time, it does not check for the queue length.</span></span> <span data-ttu-id="45e60-213">若您也想要檢查佇列長度條件，應一併將預設設定檔中的這些規則加入星期一設定檔中。</span><span class="sxs-lookup"><span data-stu-id="45e60-213">However, if you also want the queue length condition to be checked, you should include those rules from the default profile as well in your Monday profile.</span></span>

<span data-ttu-id="45e60-214">當自動調整切換回預設設定檔時，同樣也會先檢是否符合最大值與最小值條件。</span><span class="sxs-lookup"><span data-stu-id="45e60-214">Similarly, when autoscale switches back to the default profile, it first checks if the minimum and maximum conditions are met.</span></span> <span data-ttu-id="45e60-215">若當時的執行個體數為 12，將會相應縮小為 10 (預設設定檔允許的最大值)。</span><span class="sxs-lookup"><span data-stu-id="45e60-215">If the number of instances at the time is 12, it scales in to 10, the maximum allowed for the default profile.</span></span>

![自動調整設定](./media/insights-autoscale-best-practices/insights-autoscale-best-practices-2.png)

### <a name="considerations-for-scaling-when-multiple-rules-are-configured-in-a-profile"></a><span data-ttu-id="45e60-217">當設定檔中設有多項規則時的調整注意事項</span><span class="sxs-lookup"><span data-stu-id="45e60-217">Considerations for scaling when multiple rules are configured in a profile</span></span>
<span data-ttu-id="45e60-218">有些情況可能需要您在設定檔中設定多項規則。</span><span class="sxs-lookup"><span data-stu-id="45e60-218">There are cases where you may have to set multiple rules in a profile.</span></span> <span data-ttu-id="45e60-219">當設定多項規則時，服務會使用下列自動調整規則集。</span><span class="sxs-lookup"><span data-stu-id="45e60-219">The following set of autoscale rules are used by services use when multiple rules are set.</span></span>

<span data-ttu-id="45e60-220">對於「相應放大」，自動調整會在符合任何規則時執行。</span><span class="sxs-lookup"><span data-stu-id="45e60-220">On *scale out*, autoscale runs if any rule is met.</span></span>
<span data-ttu-id="45e60-221">對於「相應縮小」，自動調整會要求必須符合所有規則。</span><span class="sxs-lookup"><span data-stu-id="45e60-221">On *scale-in*, autoscale require all rules to be met.</span></span>

<span data-ttu-id="45e60-222">現在我們以您有下列 4 項自動調整規則加以示範說明︰</span><span class="sxs-lookup"><span data-stu-id="45e60-222">To illustrate, assume that you have the following 4 autoscale rules:</span></span>

* <span data-ttu-id="45e60-223">當 CPU < 30% 時相應縮小 1</span><span class="sxs-lookup"><span data-stu-id="45e60-223">If CPU < 30 %, scale-in by 1</span></span>
* <span data-ttu-id="45e60-224">當記憶體 < 50% 時相應縮小 1​</span><span class="sxs-lookup"><span data-stu-id="45e60-224">If Memory < 50%, scale-in by 1</span></span>
* <span data-ttu-id="45e60-225">當 CPU > 75% 時相應放大 1</span><span class="sxs-lookup"><span data-stu-id="45e60-225">If CPU > 75%, scale-out by 1</span></span>
* <span data-ttu-id="45e60-226">當記憶體 > 75% 時相應放大 1​</span><span class="sxs-lookup"><span data-stu-id="45e60-226">If Memory > 75%, scale-out by 1</span></span>

<span data-ttu-id="45e60-227">接著會發生下列狀況：</span><span class="sxs-lookup"><span data-stu-id="45e60-227">Then the follow occurs:</span></span>

* <span data-ttu-id="45e60-228">當 CPU 為 76%，記憶體為 50% 時，會相應放大。</span><span class="sxs-lookup"><span data-stu-id="45e60-228">If CPU is 76% and Memory is 50%, we scale-out.</span></span>
* <span data-ttu-id="45e60-229">當 CPU 為 50%，記憶體為 76% 時，會相應放大。</span><span class="sxs-lookup"><span data-stu-id="45e60-229">If CPU is 50% and Memory is 76% we scale-out.</span></span>

<span data-ttu-id="45e60-230">反之，當 CPU 為 25%，記憶體為 51% 時，自動調整「不會」相應縮小。</span><span class="sxs-lookup"><span data-stu-id="45e60-230">On the other hand, if CPU is 25% and memory is 51% autoscale does **not** scale-in.</span></span> <span data-ttu-id="45e60-231">若要相應縮小，CPU 必須達到 29%，而記憶體必須達到 49%。</span><span class="sxs-lookup"><span data-stu-id="45e60-231">In order to scale-in, CPU must be 29% and Memory 49%.</span></span>

### <a name="always-select-a-safe-default-instance-count"></a><span data-ttu-id="45e60-232">請一律選取安全的預設執行個體計數</span><span class="sxs-lookup"><span data-stu-id="45e60-232">Always select a safe default instance count</span></span>
<span data-ttu-id="45e60-233">預設執行個體計數十分重要，在沒有度量可用時，自動調整會依據其計數調整服務。</span><span class="sxs-lookup"><span data-stu-id="45e60-233">The default instance count is important autoscale scales your service to that count when metrics are not available.</span></span> <span data-ttu-id="45e60-234">因此，請選取對您工作負載而言最安全的預設執行個體計數。</span><span class="sxs-lookup"><span data-stu-id="45e60-234">Therefore, select a default instance count that's safe for your workloads.</span></span>

### <a name="configure-autoscale-notifications"></a><span data-ttu-id="45e60-235">設定自動調整通知</span><span class="sxs-lookup"><span data-stu-id="45e60-235">Configure autoscale notifications</span></span>
<span data-ttu-id="45e60-236">當發生下列情況時，自動調整傳送電子郵件，通知資源的系統管理員與參與者︰</span><span class="sxs-lookup"><span data-stu-id="45e60-236">Autoscale notifies the administrators and contributors of the resource by email if any of the following conditions occur:</span></span>

* <span data-ttu-id="45e60-237">自動調整服務無法採取動作。</span><span class="sxs-lookup"><span data-stu-id="45e60-237">autoscale service fails to take an action.</span></span>
* <span data-ttu-id="45e60-238">自動調整服務無法使用度量決定規模。</span><span class="sxs-lookup"><span data-stu-id="45e60-238">Metrics are not available for autoscale service to make a scale decision.</span></span>
* <span data-ttu-id="45e60-239">度量恢復使用 (復原)，可用以決定規模。</span><span class="sxs-lookup"><span data-stu-id="45e60-239">Metrics are available (recovery) again to make a scale decision.</span></span>
  <span data-ttu-id="45e60-240">除了上述條件之外，您也可以設定電子郵件或 Webhook 通知，在調整動作成功時收到通知。</span><span class="sxs-lookup"><span data-stu-id="45e60-240">In addition to the conditions above, you can configure email or webhook notifications to get notified for successful scale actions.</span></span>
  
<span data-ttu-id="45e60-241">您也可以使用活動記錄警示來監視自動調整引擎的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="45e60-241">You can also use an Activity Log alert to monitor the health of the autoscale engine.</span></span> <span data-ttu-id="45e60-242">以下範例為[建立活動記錄警示以監視訂用帳戶的所有自動調整引擎作業](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert)，或[建立活動記錄警示以監視訂用帳戶中所有失敗的相應縮小/相應放大自動調整作業](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert)。</span><span class="sxs-lookup"><span data-stu-id="45e60-242">Here are examples to [create an Activity Log Alert to monitor all autoscale engine operations on your subscription](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert) or to [create an Activity Log Alert to monitor all failed autoscale scale in/scale out operations on your subscription](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert).</span></span>

## <a name="next-steps"></a><span data-ttu-id="45e60-243">後續步驟</span><span class="sxs-lookup"><span data-stu-id="45e60-243">Next Steps</span></span>
- [<span data-ttu-id="45e60-244">建立活動記錄警示以監視訂用帳戶的所有自動調整引擎作業。</span><span class="sxs-lookup"><span data-stu-id="45e60-244">Create an Activity Log Alert to monitor all autoscale engine operations on your subscription.</span></span>](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-alert)
- [<span data-ttu-id="45e60-245">建立活動記錄警示以監視訂用帳戶中所有失敗的相應縮小/相應放大自動調整作業</span><span class="sxs-lookup"><span data-stu-id="45e60-245">Create an Activity Log Alert to monitor all failed autoscale scale in/scale out operations on your subscription</span></span>](https://github.com/Azure/azure-quickstart-templates/tree/master/monitor-autoscale-failed-alert)
