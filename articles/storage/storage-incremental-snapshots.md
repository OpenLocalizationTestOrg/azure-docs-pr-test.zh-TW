---
title: "使用增量快照集備份和復原非受控 Azure VM 磁碟 | Microsoft Docs"
description: "使用增量快照，建立備份和復原 Azure 虛擬機器磁碟的自訂解決方案。"
services: storage
documentationcenter: na
author: aungoo-msft
manager: tadb
editor: tysonn
ms.assetid: 3524b987-bd65-4e35-83e7-fbc2136643e5
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 01/23/2017
ms.author: aungoo
ms.openlocfilehash: 7b08ce207b2a3cc2dd3d3559765def6af42a844a
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="back-up-azure-unmanaged-vm-disks-with-incremental-snapshots"></a><span data-ttu-id="e9a00-103">以遞增快照集備份 Azure 非受控 VM 磁碟</span><span class="sxs-lookup"><span data-stu-id="e9a00-103">Back up Azure unmanaged VM disks with incremental snapshots</span></span>
## <a name="overview"></a><span data-ttu-id="e9a00-104">概觀</span><span class="sxs-lookup"><span data-stu-id="e9a00-104">Overview</span></span>
<span data-ttu-id="e9a00-105">Azure 儲存體提供拍攝 Blob 快照的功能。</span><span class="sxs-lookup"><span data-stu-id="e9a00-105">Azure Storage provides the capability to take snapshots of blobs.</span></span> <span data-ttu-id="e9a00-106">快照會擷取該時間點的 Blob 狀態。</span><span class="sxs-lookup"><span data-stu-id="e9a00-106">Snapshots capture the blob state at that point in time.</span></span> <span data-ttu-id="e9a00-107">在本文中，我們將說明如何使用快照維護虛擬機器磁碟備份的案例。</span><span class="sxs-lookup"><span data-stu-id="e9a00-107">In this article, we will describe a scenario of how you can maintain backups of virtual machine disks using snapshots.</span></span> <span data-ttu-id="e9a00-108">當您選擇不使用 Azure 的備份和復原服務，但是想要為虛擬機器磁碟建立自訂的備份策略時，您可以使用這個方法。</span><span class="sxs-lookup"><span data-stu-id="e9a00-108">You can use this methodology when you choose not to use Azure Backup and Recovery Service, and wish to create a custom backup strategy for your virtual machine disks.</span></span>

<span data-ttu-id="e9a00-109">Azure 虛擬機器磁碟在 Azure 儲存體中會儲存為分頁 Blob。</span><span class="sxs-lookup"><span data-stu-id="e9a00-109">Azure virtual machine disks are stored as page blobs in Azure Storage.</span></span> <span data-ttu-id="e9a00-110">本文中我們所討論的是虛擬機器磁碟的備份策略，因此，我們指的是分頁 Blob 內容中的快照。</span><span class="sxs-lookup"><span data-stu-id="e9a00-110">Since we are talking about backup strategy for virtual machine disks in this article, we will be referring to snapshots in the context of page blobs.</span></span> <span data-ttu-id="e9a00-111">若要深入了解快照，請參閱 [建立 Blob 的快照](https://msdn.microsoft.com/library/azure/hh488361.aspx)。</span><span class="sxs-lookup"><span data-stu-id="e9a00-111">To learn more about snapshots, refer to [Creating a Snapshot of a Blob](https://msdn.microsoft.com/library/azure/hh488361.aspx).</span></span>

## <a name="what-is-a-snapshot"></a><span data-ttu-id="e9a00-112">什麼是快照？</span><span class="sxs-lookup"><span data-stu-id="e9a00-112">What is a snapshot?</span></span>
<span data-ttu-id="e9a00-113">Blob 快照是在某個時間點擷取的 Blob 唯讀版本。</span><span class="sxs-lookup"><span data-stu-id="e9a00-113">A blob snapshot is a read-only version of a blob that is captured at a point in time.</span></span> <span data-ttu-id="e9a00-114">一旦建立快照集後，即可加以讀取、複製或刪除，但不能修改。</span><span class="sxs-lookup"><span data-stu-id="e9a00-114">Once a snapshot has been created, it can be read, copied, or deleted, but not modified.</span></span> <span data-ttu-id="e9a00-115">快照集提供在某個時間點備份 Blob 的方法。</span><span class="sxs-lookup"><span data-stu-id="e9a00-115">Snapshots provide a way to back up a blob as it appears at a moment in time.</span></span> <span data-ttu-id="e9a00-116">在 REST 2015-04-05 版之前，您可以複製完整快照集。</span><span class="sxs-lookup"><span data-stu-id="e9a00-116">Until REST version 2015-04-05 you had the ability to copy full snapshots.</span></span> <span data-ttu-id="e9a00-117">使用 REST 2015-07-08 版或更新版本時，您也可以複製增量快照集。</span><span class="sxs-lookup"><span data-stu-id="e9a00-117">With the REST version 2015-07-08 and above, you can also copy incremental snapshots.</span></span>

## <a name="full-snapshot-copy"></a><span data-ttu-id="e9a00-118">完整快照複製</span><span class="sxs-lookup"><span data-stu-id="e9a00-118">Full snapshot copy</span></span>
<span data-ttu-id="e9a00-119">快照可以當做 Blob，複製到另一個儲存體帳戶，以保留基底 Blob 的備份。</span><span class="sxs-lookup"><span data-stu-id="e9a00-119">Snapshots can be copied to another storage account as a blob to keep backups of the base blob.</span></span> <span data-ttu-id="e9a00-120">您也可以透過其基底 Blob 複製快照，就像將 Blob 還原至舊版一樣。</span><span class="sxs-lookup"><span data-stu-id="e9a00-120">You can also copy a snapshot over its base blob, which is like restoring the blob to an earlier version.</span></span> <span data-ttu-id="e9a00-121">將快照集從某個儲存體帳戶複製到另一個儲存體帳戶時，它將會佔用與基底分頁 Blob 相同的空間。</span><span class="sxs-lookup"><span data-stu-id="e9a00-121">When a snapshot is copied from one storage account to another, it will occupy the same space as the base page blob.</span></span> <span data-ttu-id="e9a00-122">因此，將整個快照從某個儲存體帳戶複製到另一個儲存體帳戶時很慢，而且也會耗用目標儲存體帳戶中的大量空間。</span><span class="sxs-lookup"><span data-stu-id="e9a00-122">Therefore, copying whole snapshots from one storage account to another will be slow and will also consume lot of space in the target storage account.</span></span>

> [!NOTE]
> <span data-ttu-id="e9a00-123">如果您將基底 Blob 複製到另一個目的地，則不會一起複製 Blob 的快照。</span><span class="sxs-lookup"><span data-stu-id="e9a00-123">If you copy the base blob to another destination, the snapshots of the blob are not copied along with it.</span></span> <span data-ttu-id="e9a00-124">同樣地，如果您以複本覆寫基底 Blob，與基底 Blob 相關聯的快照則不會受到影響，而且會讓基底 Blob 名稱保持不變。</span><span class="sxs-lookup"><span data-stu-id="e9a00-124">Similarly, if you overwrite a base blob with a copy, snapshots associated with the base blob are not affected and stay intact under base blob name.</span></span>
> 
> 

### <a name="back-up-disks-using-snapshots"></a><span data-ttu-id="e9a00-125">使用快照集備份磁碟</span><span class="sxs-lookup"><span data-stu-id="e9a00-125">Back up disks using snapshots</span></span>
<span data-ttu-id="e9a00-126">您可以拍攝磁碟或分頁 Blob 的定期快照，並使用[複製 Blob](https://msdn.microsoft.com/library/azure/dd894037.aspx) 作業或 [AzCopy](storage-use-azcopy.md) 之類的工具，將其複製到另一個儲存體帳戶，做為虛擬機器磁碟的備份策略。</span><span class="sxs-lookup"><span data-stu-id="e9a00-126">As a backup strategy for your virtual machine disks, you can take periodic snapshots of the disk or page blob, and copy them to another storage account using tools like [Copy Blob](https://msdn.microsoft.com/library/azure/dd894037.aspx) operation or [AzCopy](storage-use-azcopy.md).</span></span> <span data-ttu-id="e9a00-127">您可以將快照複製到不同名稱的目的地分頁 Blob。</span><span class="sxs-lookup"><span data-stu-id="e9a00-127">You can copy a snapshot to a destination page blob with a different name.</span></span> <span data-ttu-id="e9a00-128">所產生的目的地分頁 Blob 是一個可寫入的分頁 Blob，而不是快照。</span><span class="sxs-lookup"><span data-stu-id="e9a00-128">The resulting destination page blob is a writeable page blob and not a snapshot.</span></span> <span data-ttu-id="e9a00-129">在本文稍後，我們將說明使用快照建立虛擬機器磁碟備份的步驟。</span><span class="sxs-lookup"><span data-stu-id="e9a00-129">Later in this article we will describe steps to take backups of virtual machine disks using snapshots.</span></span>

### <a name="restore-disks-using-snapshots"></a><span data-ttu-id="e9a00-130">使用快照還原磁碟</span><span class="sxs-lookup"><span data-stu-id="e9a00-130">Restore disks using snapshots</span></span>
<span data-ttu-id="e9a00-131">到了將磁碟還原至之前在其中一個備份快照中擷取的穩定版本時，您可以將快照複製到基底分頁 Blob 之上。</span><span class="sxs-lookup"><span data-stu-id="e9a00-131">When it is time to restore your disk to a previous stable version captured in one of the backup snapshots, you can copy a snapshot over the base page blob.</span></span> <span data-ttu-id="e9a00-132">在快照升級至基底分頁 Blob 之後，快照會保留，但您能使用可同時讀取和寫入的複本來覆寫其來源。</span><span class="sxs-lookup"><span data-stu-id="e9a00-132">After the snapshot is promoted to the base page blob, the snapshot remains, but its source is overwritten with a copy that can be both read and written.</span></span> <span data-ttu-id="e9a00-133">在本文稍後，我們將說明從快照還原先前磁碟版本的步驟。</span><span class="sxs-lookup"><span data-stu-id="e9a00-133">Later in this article we will describe steps to restore a previous version of your disk from its snapshot.</span></span>

### <a name="implementing-full-snapshot-copy"></a><span data-ttu-id="e9a00-134">實作完整快照複製</span><span class="sxs-lookup"><span data-stu-id="e9a00-134">Implementing full snapshot copy</span></span>
<span data-ttu-id="e9a00-135">您可以執行下列命令，以實作完整快照複製：</span><span class="sxs-lookup"><span data-stu-id="e9a00-135">You can implement a full snapshot copy by doing the following,</span></span>

* <span data-ttu-id="e9a00-136">首先，使用 [快照 Blob](https://msdn.microsoft.com/library/azure/ee691971.aspx) 作業建立基底 Blob 的快照。</span><span class="sxs-lookup"><span data-stu-id="e9a00-136">First, take a snapshot of the base blob using the [Snapshot Blob](https://msdn.microsoft.com/library/azure/ee691971.aspx) operation.</span></span>
* <span data-ttu-id="e9a00-137">接著，使用 [複製 Blob](https://msdn.microsoft.com/library/azure/dd894037.aspx)，將快照複製到目標儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="e9a00-137">Then, copy the snapshot to a target storage account using [Copy Blob](https://msdn.microsoft.com/library/azure/dd894037.aspx).</span></span>
* <span data-ttu-id="e9a00-138">重複此程序來維護您基底 Blob 的備份複本。</span><span class="sxs-lookup"><span data-stu-id="e9a00-138">Repeat this process to maintain backup copies of your base blob.</span></span>

## <a name="incremental-snapshot-copy"></a><span data-ttu-id="e9a00-139">增量快照複製</span><span class="sxs-lookup"><span data-stu-id="e9a00-139">Incremental snapshot copy</span></span>
<span data-ttu-id="e9a00-140">[GetPageRanges](https://msdn.microsoft.com/library/azure/ee691973.aspx) API 中的新功能提供更好的方式來備份分頁 Blob 或磁碟的快照集。</span><span class="sxs-lookup"><span data-stu-id="e9a00-140">The new feature in [GetPageRanges](https://msdn.microsoft.com/library/azure/ee691973.aspx) API provides a much better way to back up the snapshots of your page blobs or disks.</span></span> <span data-ttu-id="e9a00-141">此 API 會傳回基底 Blob 和快照之間變更的清單。</span><span class="sxs-lookup"><span data-stu-id="e9a00-141">The API returns the list of changes between the base blob and the snapshots.</span></span> <span data-ttu-id="e9a00-142">這可減少備份帳戶上使用的儲存空間量。</span><span class="sxs-lookup"><span data-stu-id="e9a00-142">This reduces the amount of storage space used on the backup account.</span></span> <span data-ttu-id="e9a00-143">此 API 支援進階儲存體以及標準儲存體的分頁 Blob。</span><span class="sxs-lookup"><span data-stu-id="e9a00-143">The API supports page blobs on Premium Storage as well as Standard Storage.</span></span> <span data-ttu-id="e9a00-144">您現在可以使用此 API，為 Azure VM 建置更快速且有效率的備份解決方案。</span><span class="sxs-lookup"><span data-stu-id="e9a00-144">Using this API, you can now build faster and efficient backup solutions for Azure VMs.</span></span> <span data-ttu-id="e9a00-145">這將適用於 REST 2015-07-08 版和更新版本。</span><span class="sxs-lookup"><span data-stu-id="e9a00-145">This will be available with the REST version 2015-07-08 and higher.</span></span>

<span data-ttu-id="e9a00-146">「增量快照複製」可讓您將以下兩者之間的差異，從一個儲存體帳戶複製到另一個儲存體帳戶：</span><span class="sxs-lookup"><span data-stu-id="e9a00-146">Incremental Snapshot Copy allows you to copy from one storage account to another the difference between,</span></span>

* <span data-ttu-id="e9a00-147">基底 Blob 及其快照，或</span><span class="sxs-lookup"><span data-stu-id="e9a00-147">Base blob and its Snapshot OR</span></span>
* <span data-ttu-id="e9a00-148">基底 Blob 的任何兩個快照</span><span class="sxs-lookup"><span data-stu-id="e9a00-148">Any two snapshots of the base blob</span></span>

<span data-ttu-id="e9a00-149">前提是符合下列條件，</span><span class="sxs-lookup"><span data-stu-id="e9a00-149">Provided the following conditions are met,</span></span>

* <span data-ttu-id="e9a00-150">Blob 是在 2016 年 1 月 1 日或之後建立。</span><span class="sxs-lookup"><span data-stu-id="e9a00-150">The blob was created on Jan-1-2016 or later.</span></span>
* <span data-ttu-id="e9a00-151">在兩個快照集之間，Blob 不會覆寫為 [PutPage](https://msdn.microsoft.com/library/azure/ee691975.aspx) 或[複製 Blob](https://msdn.microsoft.com/library/azure/dd894037.aspx)。</span><span class="sxs-lookup"><span data-stu-id="e9a00-151">The blob was not overwritten with [PutPage](https://msdn.microsoft.com/library/azure/ee691975.aspx) or [Copy Blob](https://msdn.microsoft.com/library/azure/dd894037.aspx) between two snapshots.</span></span>

<span data-ttu-id="e9a00-152">**注意**︰此功能適用於進階和標準 Azure 分頁 Blob。</span><span class="sxs-lookup"><span data-stu-id="e9a00-152">**Note**: This feature is available for Premium and Standard Azure Page Blobs.</span></span>

<span data-ttu-id="e9a00-153">當您有使用快照的自訂備份策略時，將快照從一個儲存體帳戶複製到另一個儲存體帳戶可能會非常慢，而且會耗用大量的儲存空間。</span><span class="sxs-lookup"><span data-stu-id="e9a00-153">When you have a custom backup strategy that uses snapshots, copying the snapshots from one storage account to another can be very slow and consumes a lot of storage space.</span></span> <span data-ttu-id="e9a00-154">您可以將連續快照集之間的差異寫入備份分頁 Blob，而不是將整個快照集複製到備份儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="e9a00-154">Instead of copying the entire snapshot to a backup storage account, you can write the difference between consecutive snapshots to a backup page blob.</span></span> <span data-ttu-id="e9a00-155">如此一來，將大量減少複製的時間和儲存備份的空間。</span><span class="sxs-lookup"><span data-stu-id="e9a00-155">This way, the time to copy and space to store backups is substantially reduced.</span></span>

### <a name="implementing-incremental-snapshot-copy"></a><span data-ttu-id="e9a00-156">實作增量快照複製</span><span class="sxs-lookup"><span data-stu-id="e9a00-156">Implementing Incremental Snapshot Copy</span></span>
<span data-ttu-id="e9a00-157">您可以執行下列命令，以實作增量快照複製：</span><span class="sxs-lookup"><span data-stu-id="e9a00-157">You can implement incremental snapshot copy by doing the following,</span></span>

* <span data-ttu-id="e9a00-158">使用 [快照集 Blob](https://msdn.microsoft.com/library/azure/ee691971.aspx)建立基底 Blob 的快照集。</span><span class="sxs-lookup"><span data-stu-id="e9a00-158">Take a snapshot of the base blob using [Snapshot Blob](https://msdn.microsoft.com/library/azure/ee691971.aspx).</span></span>
* <span data-ttu-id="e9a00-159">使用 [複製 Blob](https://msdn.microsoft.com/library/azure/dd894037.aspx)，將快照複製到目標備份儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="e9a00-159">Copy the snapshot to the target backup storage account using [Copy Blob](https://msdn.microsoft.com/library/azure/dd894037.aspx).</span></span> <span data-ttu-id="e9a00-160">這會是備份分頁 Blob。</span><span class="sxs-lookup"><span data-stu-id="e9a00-160">This will be the backup page blob.</span></span> <span data-ttu-id="e9a00-161">建立此備份分頁 Blob 的快照集，並將其儲存在備份帳戶中。</span><span class="sxs-lookup"><span data-stu-id="e9a00-161">Take a snapshot of this backup page blob and store in backup account.</span></span>
* <span data-ttu-id="e9a00-162">使用快照集 Blob 建立基底 Blob 的另一個快照集。</span><span class="sxs-lookup"><span data-stu-id="e9a00-162">Take another snapshot of the base blob using Snapshot Blob.</span></span>
* <span data-ttu-id="e9a00-163">使用 [GetPageRanges](https://msdn.microsoft.com/library/azure/ee691973.aspx)，取得基底 Blob 的第一個與第二個快照集之間的差異。</span><span class="sxs-lookup"><span data-stu-id="e9a00-163">Get the difference between first and second snapshots of base blob using  [GetPageRanges](https://msdn.microsoft.com/library/azure/ee691973.aspx).</span></span> <span data-ttu-id="e9a00-164">使用新的參數 **prevsnapshot** 指定您要用來取得差異的快照集的 DateTime 值。</span><span class="sxs-lookup"><span data-stu-id="e9a00-164">Use the new parameter **prevsnapshot** to specify the DateTime value of the snapshot you want to get the difference with.</span></span> <span data-ttu-id="e9a00-165">當此參數存在時，REST 回應將只包含在目標快照集與先前快照集之間變更的分頁 (包括清除分頁)。</span><span class="sxs-lookup"><span data-stu-id="e9a00-165">When this parameter is present, the REST response will include only the pages that were changed between target snapshot and previous snapshot including clear pages.</span></span>
* <span data-ttu-id="e9a00-166">使用 [PutPage](https://msdn.microsoft.com/library/azure/ee691975.aspx) 將這些變更套用至備份分頁 Blob。</span><span class="sxs-lookup"><span data-stu-id="e9a00-166">Use [PutPage](https://msdn.microsoft.com/library/azure/ee691975.aspx) to apply these changes to the backup page blob.</span></span>
* <span data-ttu-id="e9a00-167">最後，建立備份分頁 Blob 的快照集，並將其儲存在備份儲存體帳戶中。</span><span class="sxs-lookup"><span data-stu-id="e9a00-167">Finally, take a snapshot of the backup page blob and store it in the backup storage account.</span></span>

<span data-ttu-id="e9a00-168">在下一節中，我們將詳細說明如何使用增量快照複製維護磁碟的備份</span><span class="sxs-lookup"><span data-stu-id="e9a00-168">In the next section, we will describe in more detail how you can maintain backups of disks using Incremental Snapshot Copy</span></span>

## <a name="scenario"></a><span data-ttu-id="e9a00-169">案例</span><span class="sxs-lookup"><span data-stu-id="e9a00-169">Scenario</span></span>
<span data-ttu-id="e9a00-170">在本節中，我們將使用快照說明涉及虛擬機器磁碟的自訂備份策略的案例。</span><span class="sxs-lookup"><span data-stu-id="e9a00-170">In this section we will describe a scenario that involves a custom backup strategy for virtual machine disks using snapshots.</span></span>

<span data-ttu-id="e9a00-171">請考慮使用連接進階儲存體 P30 磁碟的 DS 系列 Azure VM。</span><span class="sxs-lookup"><span data-stu-id="e9a00-171">Consider a DS-series Azure VM with a premium storage P30 disk attached.</span></span> <span data-ttu-id="e9a00-172">稱為 *mypremiumdisk* 的 P30 磁碟會儲存在稱為 *mypremiumaccount* 的進階儲存體帳戶中。</span><span class="sxs-lookup"><span data-stu-id="e9a00-172">The P30 disk called *mypremiumdisk* is stored in a premium storage account called *mypremiumaccount*.</span></span> <span data-ttu-id="e9a00-173">稱為 *mybackupstdaccount* 的標準儲存體帳戶將用於儲存 *mypremiumdisk* 的備份。</span><span class="sxs-lookup"><span data-stu-id="e9a00-173">A standard storage account called *mybackupstdaccount* will be used for storing the backup of *mypremiumdisk*.</span></span> <span data-ttu-id="e9a00-174">我們想要每 12 小時保留一個 *mypremiumdisk* 的快照集。</span><span class="sxs-lookup"><span data-stu-id="e9a00-174">We would like to keep a snapshot of *mypremiumdisk* every 12 hours.</span></span>

<span data-ttu-id="e9a00-175">若要了解如何建立儲存體帳戶和磁碟，請參閱 [關於 Azure 儲存體帳戶](storage-create-storage-account.md)。</span><span class="sxs-lookup"><span data-stu-id="e9a00-175">To learn about creating storage account and disks, refer to [About Azure storage accounts](storage-create-storage-account.md).</span></span>

<span data-ttu-id="e9a00-176">若要了解如何備份 Azure VM，請參閱 [規劃 Azure VM 備份](../backup/backup-azure-vms-introduction.md)。</span><span class="sxs-lookup"><span data-stu-id="e9a00-176">To learn about backing up Azure VMs, refer to [Plan Azure VM backups](../backup/backup-azure-vms-introduction.md).</span></span>

## <a name="steps-to-maintain-backups-of-a-disk-using-incremental-snapshots"></a><span data-ttu-id="e9a00-177">使用增量快照維護磁碟備份的步驟</span><span class="sxs-lookup"><span data-stu-id="e9a00-177">Steps to maintain backups of a disk using incremental snapshots</span></span>
<span data-ttu-id="e9a00-178">以下所述的步驟將建立 *mypremiumdisk* 的快照集，並維護 *mybackupstdaccount* 中的備份。</span><span class="sxs-lookup"><span data-stu-id="e9a00-178">The steps described below will take snapshots of *mypremiumdisk* and maintain the backups in *mybackupstdaccount*.</span></span> <span data-ttu-id="e9a00-179">備份將會是稱為 *mybackupstdpageblob*的標準分頁 Blob。</span><span class="sxs-lookup"><span data-stu-id="e9a00-179">The backup will be a standard page blob called *mybackupstdpageblob*.</span></span> <span data-ttu-id="e9a00-180">備份分頁 Blob 一律會反映與 *mypremiumdisk*的最新快照集相同的狀態。</span><span class="sxs-lookup"><span data-stu-id="e9a00-180">The backup page blob will always reflect the same state as the last snapshot of *mypremiumdisk*.</span></span>

1. <span data-ttu-id="e9a00-181">首先，建立進階儲存體磁碟的備份分頁 Blob。</span><span class="sxs-lookup"><span data-stu-id="e9a00-181">First, create the backup page blob for your premium storage disk.</span></span> <span data-ttu-id="e9a00-182">若要這樣做，請建立稱為 *mypremiumdisk_ss1* 的 *mypremiumdisk* 快照集。</span><span class="sxs-lookup"><span data-stu-id="e9a00-182">To do this, take a snapshot of *mypremiumdisk* called *mypremiumdisk_ss1*.</span></span>
2. <span data-ttu-id="e9a00-183">將此快照集複製到 mybackupstdaccount，以作為稱為 *mybackupstdpageblob*的分頁 Blob。</span><span class="sxs-lookup"><span data-stu-id="e9a00-183">Copy this snapshot to mybackupstdaccount as a page blob called *mybackupstdpageblob*.</span></span>
3. <span data-ttu-id="e9a00-184">使用[快照集 Blob](https://msdn.microsoft.com/library/azure/ee691971.aspx) 建立稱為 *mybackupstdpageblob_ss1* 的 *mybackupstdpageblob* 快照集，並將其儲存在 *mybackupstdaccount* 中。</span><span class="sxs-lookup"><span data-stu-id="e9a00-184">Take a snapshot of *mybackupstdpageblob* called *mybackupstdpageblob_ss1*, using [Snapshot Blob](https://msdn.microsoft.com/library/azure/ee691971.aspx) and store it in *mybackupstdaccount*.</span></span>
4. <span data-ttu-id="e9a00-185">在備份時間範圍期間，建立 *mypremiumdisk* 的快照集 (即 *mypremiumdisk_ss2*)，並將其儲存在 *mypremiumaccount* 中。</span><span class="sxs-lookup"><span data-stu-id="e9a00-185">During the backup window, create another snapshot of *mypremiumdisk*, say *mypremiumdisk_ss2*, and store it in *mypremiumaccount*.</span></span>
5. <span data-ttu-id="e9a00-186">搭配使用 *mypremiumdisk_ss2* 上的 [GetPageRanges](https://msdn.microsoft.com/library/azure/ee691973.aspx) 與設為 *mypremiumdisk_ss1* 時間戳記的 **prevsnapshot** 參數，以取得兩個快照集 (*mypremiumdisk_ss2* 與 *mypremiumdisk_ss1*) 之間的增量變更。</span><span class="sxs-lookup"><span data-stu-id="e9a00-186">Get the incremental changes between the two snapshots, *mypremiumdisk_ss2* and *mypremiumdisk_ss1*, using [GetPageRanges](https://msdn.microsoft.com/library/azure/ee691973.aspx) on *mypremiumdisk_ss2* with **prevsnapshot** parameter set to the timestamp of *mypremiumdisk_ss1*.</span></span> <span data-ttu-id="e9a00-187">將這些增量變更寫入 *mybackupstdaccount* 中的備份分頁 Blob *mybackupstdpageblob*。</span><span class="sxs-lookup"><span data-stu-id="e9a00-187">Write these incremental changes to the backup page blob *mybackupstdpageblob* in *mybackupstdaccount*.</span></span> <span data-ttu-id="e9a00-188">如果增量變更中有已刪除的範圍，則必須從備份分頁 Blob 中清除這些範圍。</span><span class="sxs-lookup"><span data-stu-id="e9a00-188">If there are deleted ranges in the incremental changes, they must be cleared from the backup page blob.</span></span> <span data-ttu-id="e9a00-189">使用 [PutPage](https://msdn.microsoft.com/library/azure/ee691975.aspx) 將增量變更寫入備份分頁 Blob。</span><span class="sxs-lookup"><span data-stu-id="e9a00-189">Use [PutPage](https://msdn.microsoft.com/library/azure/ee691975.aspx) to write incremental changes to the backup page blob.</span></span>
6. <span data-ttu-id="e9a00-190">建立稱為 *mybackupstdpageblob_ss2* 的備份分頁 Blob *mybackupstdpageblob* 的快照集。</span><span class="sxs-lookup"><span data-stu-id="e9a00-190">Take a snapshot of the backup page blob *mybackupstdpageblob*, called *mybackupstdpageblob_ss2*.</span></span> <span data-ttu-id="e9a00-191">從進階儲存體帳戶刪除先前的快照集 *mypremiumdisk_ss1*。</span><span class="sxs-lookup"><span data-stu-id="e9a00-191">Delete the previous snapshot *mypremiumdisk_ss1* from premium storage account.</span></span>
7. <span data-ttu-id="e9a00-192">在每個備份時間範圍期間重複步驟 4-6。</span><span class="sxs-lookup"><span data-stu-id="e9a00-192">Repeat steps 4-6 every backup window.</span></span> <span data-ttu-id="e9a00-193">如此一來，您可以維護標準儲存體帳戶中的 *mypremiumdisk* 備份。</span><span class="sxs-lookup"><span data-stu-id="e9a00-193">In this way, you can maintain backups of *mypremiumdisk* in a standard storage account.</span></span>

![使用增量快照集備份磁碟](./media/storage-incremental-snapshots/storage-incremental-snapshots-1.png)

## <a name="steps-to-restore-a-disk-from-snapshots"></a><span data-ttu-id="e9a00-195">從快照還原磁碟的步驟</span><span class="sxs-lookup"><span data-stu-id="e9a00-195">Steps to restore a disk from snapshots</span></span>
<span data-ttu-id="e9a00-196">以下所述的步驟會將進階磁碟 *mypremiumdisk* 從備份儲存體帳戶 *mybackupstdaccount* 還原至先前的快照集。</span><span class="sxs-lookup"><span data-stu-id="e9a00-196">The steps described below will restore premium disk, *mypremiumdisk* to an earlier snapshot from the backup storage account *mybackupstdaccount*.</span></span>

1. <span data-ttu-id="e9a00-197">識別您要將進階磁碟還原到哪個時間點。</span><span class="sxs-lookup"><span data-stu-id="e9a00-197">Identify the point in time you wish to restore the premium disk to.</span></span> <span data-ttu-id="e9a00-198">我們假設是儲存在備份儲存體帳戶 *mybackupstdaccount* 中的快照集 *mybackupstdpageblob_ss2*。</span><span class="sxs-lookup"><span data-stu-id="e9a00-198">Let's say that is snapshot *mybackupstdpageblob_ss2*, which is stored in the backup storage account *mybackupstdaccount*.</span></span>
2. <span data-ttu-id="e9a00-199">在 mybackupstdaccount 中，將快照集 *mybackupstdpageblob_ss2* 升級為新的備份基底分頁 Blob *mybackupstdpageblobrestored*。</span><span class="sxs-lookup"><span data-stu-id="e9a00-199">In mybackupstdaccount, promote the snapshot *mybackupstdpageblob_ss2* as the new backup base page blob *mybackupstdpageblobrestored*.</span></span>
3. <span data-ttu-id="e9a00-200">建立稱為 *mybackupstdpageblobrestored_ss1* 的這個已還原備份分頁 Blob 的快照集。</span><span class="sxs-lookup"><span data-stu-id="e9a00-200">Take a snapshot of this restored backup page blob, called *mybackupstdpageblobrestored_ss1*.</span></span>
4. <span data-ttu-id="e9a00-201">將已還原分頁 Blob *mybackupstdpageblobrestored* 從 *mybackupstdaccount* 複製到 *mypremiumaccount*，作為新的進階磁碟 *mypremiumdiskrestored*。</span><span class="sxs-lookup"><span data-stu-id="e9a00-201">Copy the restored page blob *mybackupstdpageblobrestored* from *mybackupstdaccount* to *mypremiumaccount* as the new premium disk *mypremiumdiskrestored*.</span></span>
5. <span data-ttu-id="e9a00-202">建立稱為 *mypremiumdiskrestored_ss1* 的 *mypremiumdiskrestored* 快照集，以進行未來的增量備份。</span><span class="sxs-lookup"><span data-stu-id="e9a00-202">Take a snapshot of *mypremiumdiskrestored*, called *mypremiumdiskrestored_ss1* for making future incremental backups.</span></span>
6. <span data-ttu-id="e9a00-203">將 DS 系列 VM 指向已還原的磁碟 *mypremiumdiskrestored*，並從 VM 卸離舊的 *mypremiumdisk*。</span><span class="sxs-lookup"><span data-stu-id="e9a00-203">Point the DS series VM to the restored disk *mypremiumdiskrestored* and detach the old *mypremiumdisk* from the VM.</span></span>
7. <span data-ttu-id="e9a00-204">使用 *mybackupstdpageblobrestored* 作為備份分頁 Blob，為已還原的磁碟 *mypremiumdiskrestored* 開始上一節中所述的備份程序。</span><span class="sxs-lookup"><span data-stu-id="e9a00-204">Begin the Backup process described in previous section for the restored disk *mypremiumdiskrestored*, using the *mybackupstdpageblobrestored* as the backup page blob.</span></span>

![從快照還原磁碟](./media/storage-incremental-snapshots/storage-incremental-snapshots-2.png)

## <a name="next-steps"></a><span data-ttu-id="e9a00-206">後續步驟</span><span class="sxs-lookup"><span data-stu-id="e9a00-206">Next Steps</span></span>
<span data-ttu-id="e9a00-207">深入了解建立 Blob 的快照集以及使用下列連結來規劃 VM 備份基礎結構。</span><span class="sxs-lookup"><span data-stu-id="e9a00-207">Learn more about creating snapshots of a blob and planning your VM backup infrastructure using the links below.</span></span>

* [<span data-ttu-id="e9a00-208">建立 Blob 的快照集</span><span class="sxs-lookup"><span data-stu-id="e9a00-208">Creating a Snapshot of a Blob</span></span>](https://msdn.microsoft.com/library/azure/hh488361.aspx)
* [<span data-ttu-id="e9a00-209">規劃 VM 備份基礎結構</span><span class="sxs-lookup"><span data-stu-id="e9a00-209">Plan your VM Backup Infrastructure</span></span>](../backup/backup-azure-vms-introduction.md)

