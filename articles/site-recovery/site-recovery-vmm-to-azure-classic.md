---
title: "將 Hyper-V 虛擬機器 (位於 VMM 雲端中) 複寫至 Azure | Microsoft Docs"
description: "本文說明如何將位於 System Center VMM 雲端中 Hyper-V 主機上的 Hyper-V 虛擬機器複寫至 Azure。"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: 9d526a1f-0d8e-46ec-83eb-7ea762271db5
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: hero-article
ms.date: 06/23/2017
ms.author: raynew
ms.openlocfilehash: ac0931a71a2814723380256fc5326fc431c82f2c
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/29/2017
---
# <a name="replicate-hyper-v-virtual-machines-in-vmm-clouds-to-azure"></a><span data-ttu-id="3e4c9-103">將 Hyper-V 虛擬機器 (位於 VMM 雲端中) 複寫至 Azure</span><span class="sxs-lookup"><span data-stu-id="3e4c9-103">Replicate Hyper-V virtual machines in VMM clouds to Azure</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="3e4c9-104">Azure 入口網站</span><span class="sxs-lookup"><span data-stu-id="3e4c9-104">Azure ortal</span></span>](site-recovery-vmm-to-azure.md)
> * [<span data-ttu-id="3e4c9-105">PowerShell - 資源管理員</span><span class="sxs-lookup"><span data-stu-id="3e4c9-105">PowerShell - Resource Manager</span></span>](site-recovery-vmm-to-azure-powershell-resource-manager.md)
> * [<span data-ttu-id="3e4c9-106">傳統入口網站</span><span class="sxs-lookup"><span data-stu-id="3e4c9-106">Classic portal</span></span>](site-recovery-vmm-to-azure-classic.md)
> * [<span data-ttu-id="3e4c9-107">PowerShell - 傳統</span><span class="sxs-lookup"><span data-stu-id="3e4c9-107">PowerShell - Classic</span></span>](site-recovery-deploy-with-powershell.md)
>
>

<span data-ttu-id="3e4c9-108">Azure Site Recovery 服務可藉由協調虛擬機器與實體伺服器的複寫、容錯移轉及復原 (BCDR) 策略，為您的商務持續性與災害復原做出貢獻。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-108">The Azure Site Recovery service contributes to your business continuity and disaster recovery (BCDR) strategy by orchestrating replication, failover and recovery of virtual machines and physical servers.</span></span> <span data-ttu-id="3e4c9-109">機器可以複寫至 Azure，或次要的內部部署資料中心。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-109">Machines can be replicated to Azure, or to a secondary on-premises data center.</span></span> <span data-ttu-id="3e4c9-110">如需快速概觀，請參閱 [什麼是 Azure Site Recovery？](site-recovery-overview.md)</span><span class="sxs-lookup"><span data-stu-id="3e4c9-110">For a quick overview read [What is Azure Site Recovery?](site-recovery-overview.md)</span></span>

## <a name="overview"></a><span data-ttu-id="3e4c9-111">概觀</span><span class="sxs-lookup"><span data-stu-id="3e4c9-111">Overview</span></span>
<span data-ttu-id="3e4c9-112">本文說明如何部署 Site Recovery，將位於 VMM 私人雲端中的 Hyper-V 主機伺服器上的 Hyper-V 虛擬機器複寫至 Azure。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-112">This article describes how to deploy Site Recovery to replicate Hyper-V virtual machines on Hyper-V host servers that are located in VMM private clouds to Azure.</span></span>

<span data-ttu-id="3e4c9-113">本文包含案例的必要條件，並示範如何設定 Site Recovery 保存庫、取得安裝於來源 VMM 伺服器上的「Azure Site Recovery 提供者」、在保存庫註冊伺服器、加入 Azure 儲存體帳戶、在 Hyper-V 主機伺服器上安裝 Azure Site Recovery 代理程式、設定將套用到所有受保護虛擬機器之 VMM 雲端的保護設定、然後啟用那些虛擬機器的保護。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-113">The article includes prerequisites for the scenario and shows you how to set up a Site Recovery vault, get the Azure Site Recovery Provider installed on the source VMM server, register the server in the vault, add an Azure storage account, install the Azure Recovery Services agent on Hyper-V host servers, configure protection settings for VMM clouds that will be applied to all protected virtual machines, and then enable protection for those virtual machines.</span></span> <span data-ttu-id="3e4c9-114">測試容錯移轉，確認一切如預期般運作以完成動作。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-114">Finish up by testing the failover to make sure everything's working as expected.</span></span>

<span data-ttu-id="3e4c9-115">在這篇文章下方或 [Azure Recovery Services Forum (Azure 復原服務論壇)](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)中張貼意見或問題。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-115">Post any comments or questions at the bottom of this article, or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>

## <a name="architecture"></a><span data-ttu-id="3e4c9-116">架構</span><span class="sxs-lookup"><span data-stu-id="3e4c9-116">Architecture</span></span>
![架構](./media/site-recovery-vmm-to-azure-classic/topology.png)

* <span data-ttu-id="3e4c9-118">Azure Site Recovery 提供者是於 Site Recovery 部署期間安裝在 VMM，且在 Site Recovery 保存庫中註冊 VMM 伺服器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-118">The Azure Site Recovery Provider is installed on the VMM during Site Recovery deployment and the VMM server is registered in the Site Recovery vault.</span></span> <span data-ttu-id="3e4c9-119">提供者會與 Site Recovery 通訊以處理複寫協調流程。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-119">The Provider communicates with Site Recovery to handle replication orchestration.</span></span>
* <span data-ttu-id="3e4c9-120">Azure Recovery Services 代理程式是於 Site Recovery 部署期間安裝在 Hyper-V 主機伺服器上。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-120">The Azure Recovery Services agent is installed on Hyper-V host servers during Site Recovery deployment.</span></span> <span data-ttu-id="3e4c9-121">它會將資料複寫處理至 Azure 儲存體。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-121">It handles data replication to Azure storage.</span></span>

## <a name="azure-prerequisites"></a><span data-ttu-id="3e4c9-122">Azure 必要條件</span><span class="sxs-lookup"><span data-stu-id="3e4c9-122">Azure prerequisites</span></span>
<span data-ttu-id="3e4c9-123">以下是您在 Azure 中需要的內容。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-123">Here's what you'll need in Azure.</span></span>

| <span data-ttu-id="3e4c9-124">**必要條件**</span><span class="sxs-lookup"><span data-stu-id="3e4c9-124">**Prerequisite**</span></span> | <span data-ttu-id="3e4c9-125">**詳細資料**</span><span class="sxs-lookup"><span data-stu-id="3e4c9-125">**Details**</span></span> |
| --- | --- |
| <span data-ttu-id="3e4c9-126">**Azure 帳戶**</span><span class="sxs-lookup"><span data-stu-id="3e4c9-126">**Azure account**</span></span> |<span data-ttu-id="3e4c9-127">您將需要 [Microsoft Azure](https://azure.microsoft.com/) 帳戶。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-127">You'll need a [Microsoft Azure](https://azure.microsoft.com/) account.</span></span> <span data-ttu-id="3e4c9-128">您可以從 [免費試用](https://azure.microsoft.com/pricing/free-trial/)開始。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-128">You can start with a [free trial](https://azure.microsoft.com/pricing/free-trial/).</span></span> <span data-ttu-id="3e4c9-129">[深入了解](https://azure.microsoft.com/pricing/details/site-recovery/) Site Recovery 價格。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-129">[Learn more](https://azure.microsoft.com/pricing/details/site-recovery/) about Site Recovery pricing.</span></span> |
| <span data-ttu-id="3e4c9-130">**Azure 儲存體**</span><span class="sxs-lookup"><span data-stu-id="3e4c9-130">**Azure storage**</span></span> |<span data-ttu-id="3e4c9-131">您需要 Azure 儲存體帳戶來儲存複寫的資料。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-131">You'll need an Azure storage account to store replicated data.</span></span> <span data-ttu-id="3e4c9-132">複寫的資料會儲存在 Azure 儲存體，容錯移轉時會啟動 Azure VM。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-132">Replicated data is stored in Azure storage and Azure VMs are spun up when failover occurs.</span></span> <br/><br/><span data-ttu-id="3e4c9-133">您需要一個[標準異地備援儲存體帳戶](../storage/common/storage-redundancy.md#geo-redundant-storage)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-133">You need a [standard geo-redundant storage account](../storage/common/storage-redundancy.md#geo-redundant-storage).</span></span> <span data-ttu-id="3e4c9-134">此帳戶應與 Site Recovery 服務位於相同的區域，且與相同的訂用帳戶相關聯。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-134">The account must be in the same region as the Site Recovery service, and be associated with the same subscription.</span></span> <span data-ttu-id="3e4c9-135">請注意，複寫到進階儲存體帳戶目前不受支援，因此請勿使用。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-135">Note that replication to premium storage accounts isn't currently supported and shouldn't be used.</span></span><br/><br/><span data-ttu-id="3e4c9-136">[深入了解](../storage/common/storage-introduction.md) Azure 儲存體。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-136">[Read about](../storage/common/storage-introduction.md) Azure storage.</span></span> |
| <span data-ttu-id="3e4c9-137">**Azure 網路**</span><span class="sxs-lookup"><span data-stu-id="3e4c9-137">**Azure network**</span></span> |<span data-ttu-id="3e4c9-138">容錯移轉發生時，您需要 Azure VM 會連接的 Azure 虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-138">You'll need an Azure virtual network that Azure VMs will connect to when failover occurs.</span></span> <span data-ttu-id="3e4c9-139">Azure 虛擬網路必須位於與 Site Recovery 保存庫相同的區域中。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-139">The Azure virtual network must be in the same region as the Site Recovery vault.</span></span> |

## <a name="on-premises-prerequisites"></a><span data-ttu-id="3e4c9-140">內部部署必要條件</span><span class="sxs-lookup"><span data-stu-id="3e4c9-140">On-premises prerequisites</span></span>
<span data-ttu-id="3e4c9-141">以下是您在內部部署中需要的內容。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-141">Here's what you'll need on-premises.</span></span>

| <span data-ttu-id="3e4c9-142">**必要條件**</span><span class="sxs-lookup"><span data-stu-id="3e4c9-142">**Prerequisite**</span></span> | <span data-ttu-id="3e4c9-143">**詳細資料**</span><span class="sxs-lookup"><span data-stu-id="3e4c9-143">**Details**</span></span> |
| --- | --- |
| <span data-ttu-id="3e4c9-144">**VMM**</span><span class="sxs-lookup"><span data-stu-id="3e4c9-144">**VMM**</span></span> |<span data-ttu-id="3e4c9-145">您需要至少一部部署為實體或虛擬獨立伺服器，或是部署為虛擬叢集的 VMM 伺服器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-145">You'll need at least one VMM server deployed as a physical or virtual standalone server, or as a virtual cluster.</span></span> <br/><br/><span data-ttu-id="3e4c9-146">VMM 伺服器應執行附帶最新累計更新的 System Center 2012 R2。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-146">The VMM server should be running System Center 2012 R2 with the latest cumulative updates.</span></span><br/><br/><span data-ttu-id="3e4c9-147">您至少必須在 VMM 伺服器上設定一個雲端。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-147">You'll need at least one cloud configured on the VMM server.</span></span><br/><br/><span data-ttu-id="3e4c9-148">您想要保護的來源雲端必須包含一或多個 VMM 主機群組。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-148">The source cloud that you want to protect must contain one or more VMM host groups.</span></span><br/><br/><span data-ttu-id="3e4c9-149">若要深入了解如何設定 VMM 雲端，請參閱 Keith Mayer 部落格上的[逐步解說：使用 System Center 2012 SP1 VMM 建立私人雲端](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-149">Learn more about setting up VMM clouds in [Walkthrough: Creating private clouds with System Center 2012 SP1 VMM](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx) on Keith Mayer's blog.</span></span> |
| <span data-ttu-id="3e4c9-150">**Hyper-V**</span><span class="sxs-lookup"><span data-stu-id="3e4c9-150">**Hyper-V**</span></span> |<span data-ttu-id="3e4c9-151">您在 VMM 雲端中需要一或多個 Hyper-V 主機伺服器或叢集。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-151">You'll need one or more Hyper-V host servers or clusters in the VMM cloud.</span></span> <span data-ttu-id="3e4c9-152">主機伺服器應該有一或多個 VM。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-152">The host server should have and one or more VMs.</span></span> <br/><br/><span data-ttu-id="3e4c9-153">Hyper-V 伺服器必須執行於至少 **Windows Server 2012 R2** (具有 Hyper-V 角色) 或 **Microsoft Hyper-V Server 2012 R2** 且已安裝最新的更新。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-153">The Hyper-V server must be running on at least **Windows Server 2012 R2** with the Hyper-V role or **Microsoft Hyper-V Server 2012 R2** and have the latest updates installed.</span></span><br/><br/><span data-ttu-id="3e4c9-154">任何包含您想要保護之 VM 的 Hyper-V 伺服器必須位於 VMM 雲端。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-154">Any Hyper-V server containing VMs you want to protect must be located in a VMM cloud.</span></span><br/><br/><span data-ttu-id="3e4c9-155">如果您在叢集中執行 Hyper-V，請注意，如果您具有靜態 IP 位址叢集，並不會自動建立叢集代理。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-155">If you're running Hyper-V in a cluster note that cluster broker isn't created automatically if you have a static IP address-based cluster.</span></span> <span data-ttu-id="3e4c9-156">您必須手動設定叢集代理。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-156">You'll need to configure the cluster broker manually.</span></span> <span data-ttu-id="3e4c9-157">在 Aidan Finn 的部落格項目中[深入了解](https://www.petri.com/use-hyper-v-replica-broker-prepare-host-clusters)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-157">[Learn more](https://www.petri.com/use-hyper-v-replica-broker-prepare-host-clusters) in Aidan Finn's blog entry.</span></span> |
| <span data-ttu-id="3e4c9-158">**受保護的機器**</span><span class="sxs-lookup"><span data-stu-id="3e4c9-158">**Protected machines**</span></span> | <span data-ttu-id="3e4c9-159">您想要保護的 VM 應該符合 [Azure 需求](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-159">VMs you want to protect should comply with [Azure requirements](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span></span> |

## <a name="network-mapping-prerequisites"></a><span data-ttu-id="3e4c9-160">網路對應的必要條件</span><span class="sxs-lookup"><span data-stu-id="3e4c9-160">Network mapping prerequisites</span></span>
<span data-ttu-id="3e4c9-161">當您在 Azure 網路對應中保護虛擬機器，請對應來源 VMM 伺服器上的 VM 網路和目標 Azure 網路，以啟用下列項目：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-161">When you protect virtual machines in Azure network mapping maps between VM networks on the source VMM server and target Azure networks to enable the following:</span></span>

* <span data-ttu-id="3e4c9-162">在相同網路上容錯移轉的所有機器都可以彼此連接，無論它們隸屬於哪個復原計畫都一樣。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-162">All machines that fail over on the same network can connect to each other, irrespective of which recovery plan they are in.</span></span>
* <span data-ttu-id="3e4c9-163">如果目標 Azure 網路上已設定網路閘道，則虛擬機器可以連接到其他內部部署虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-163">If a network gateway is set up on the target Azure network, virtual machines can connect to other on-premises virtual machines.</span></span>
* <span data-ttu-id="3e4c9-164">如果您未設定網路對應，則只有在相同復原計畫中容錯移轉的虛擬機器才能在容錯移轉到 Azure 之後彼此連接。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-164">If you don’t configure network mapping only virtual machines that fail over in the same recovery plan will be able to connect to each other after failover to Azure.</span></span>

<span data-ttu-id="3e4c9-165">如果您想要部署網路對應，您需要下列項目：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-165">If you want to deploy network mapping you'll need the following:</span></span>

* <span data-ttu-id="3e4c9-166">您想要在來源 VMM 伺服器上保護的虛擬機器應該連線到 VM 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-166">The virtual machines you want to protect on the source VMM server should be connected to a VM network.</span></span> <span data-ttu-id="3e4c9-167">該網路應該連結到與雲端相關聯的邏輯網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-167">That network should be linked to a logical network that is associated with the cloud.</span></span>
* <span data-ttu-id="3e4c9-168">複寫的虛擬機器可在容錯移轉之後連線的 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-168">An Azure network to which replicated virtual machines can connect after failover.</span></span> <span data-ttu-id="3e4c9-169">您將在容錯移轉時選取此網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-169">You'll select this network at the time of failover.</span></span> <span data-ttu-id="3e4c9-170">此網路應該和您的 Azure Site Recovery 訂用帳戶在相同的區域中。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-170">The network should be in the same region as your Azure Site Recovery subscription.</span></span>


<span data-ttu-id="3e4c9-171">在 VMM 中準備網路：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-171">Prepare networks in VMM:</span></span>

   * <span data-ttu-id="3e4c9-172">[設定邏輯網路](https://technet.microsoft.com/library/jj721568.aspx)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-172">[Set up logical networks](https://technet.microsoft.com/library/jj721568.aspx).</span></span>
   * <span data-ttu-id="3e4c9-173">[設定 VM 網路](https://technet.microsoft.com/library/jj721575.aspx)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-173">[Set up VM networks](https://technet.microsoft.com/library/jj721575.aspx).</span></span>


## <a name="step-1-create-a-site-recovery-vault"></a><span data-ttu-id="3e4c9-174">步驟 1：建立 Site Recovery 保存庫</span><span class="sxs-lookup"><span data-stu-id="3e4c9-174">Step 1: Create a Site Recovery vault</span></span>
1. <span data-ttu-id="3e4c9-175">從您想要註冊的 VMM 伺服器登入 [管理入口網站](https://portal.azure.com) 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-175">Sign in to the [Management Portal](https://portal.azure.com) from the VMM server you want to register.</span></span>
2. <span data-ttu-id="3e4c9-176">按一下 [資料服務] > [復原服務] > [Site Recovery 保存庫]。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-176">Click **Data Services** > **Recovery Services** > **Site Recovery Vault**.</span></span>
3. <span data-ttu-id="3e4c9-177">按一下 [新建]  >  [快速建立]。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-177">Click **Create New** > **Quick Create**.</span></span>
4. <span data-ttu-id="3e4c9-178">在 [ **名稱**] 中，輸入保存庫的易記識別名稱。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-178">In **Name**, enter a friendly name to identify the vault.</span></span>
5. <span data-ttu-id="3e4c9-179">在 [地區] 中，選取保存庫的地理區域。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-179">In **Region**, select the geographic region for the vault.</span></span> <span data-ttu-id="3e4c9-180">若要查看支援的區域，請參閱 [Azure Site Recovery 定價詳細資料](https://azure.microsoft.com/pricing/details/site-recovery/)中的＜各地區上市情況＞。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-180">To check supported regions see Geographic Availability in [Azure Site Recovery Pricing Details](https://azure.microsoft.com/pricing/details/site-recovery/).</span></span>
6. <span data-ttu-id="3e4c9-181">按一下 [建立保存庫] 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-181">Click **Create vault**.</span></span>

    ![新增保存庫](./media/site-recovery-vmm-to-azure-classic/create-vault.png)

<span data-ttu-id="3e4c9-183">檢查狀態列，以確認是否順利建立保存庫。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-183">Check the status bar to confirm that the vault was successfully created.</span></span> <span data-ttu-id="3e4c9-184">保存庫在主要復原服務頁面上會列為 [使用中]  。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-184">The vault will be listed as **Active** on the main Recovery Services page.</span></span>

## <a name="step-2-generate-a-vault-registration-key"></a><span data-ttu-id="3e4c9-185">步驟 2：產生保存庫註冊金鑰</span><span class="sxs-lookup"><span data-stu-id="3e4c9-185">Step 2: Generate a vault registration key</span></span>
<span data-ttu-id="3e4c9-186">在保存庫中產生註冊金鑰。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-186">Generate a registration key in the vault.</span></span> <span data-ttu-id="3e4c9-187">下載 Azure Site Recovery 提供者並將其安裝在 VMM 伺服器之後，您將使用此金鑰在保存庫中註冊 VMM 伺服器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-187">After you download the Azure Site Recovery Provider and install it on the VMM server, you'll use this key to register the VMM server in the vault.</span></span>

1. <span data-ttu-id="3e4c9-188">在 [復原服務]  頁面中，按一下保存庫以開啟 [快速啟動] 頁面。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-188">In the **Recovery Services** page, click the vault to open the Quick Start page.</span></span> <span data-ttu-id="3e4c9-189">您也可以使用圖示隨時開啟 [快速入門]。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-189">Quick Start can also be opened at any time using the icon.</span></span>

    ![快速啟動圖示](./media/site-recovery-vmm-to-azure-classic/qs-icon.png)
2. <span data-ttu-id="3e4c9-191">在下拉式清單中，選取 [在內部部署 Hyper-V 站台與 Microsoft Azure 之間] 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-191">In the dropdown list, select **Between an on-premises VMM site and Microsoft Azure**.</span></span>
3. <span data-ttu-id="3e4c9-192">在 [準備 VMM 伺服器] 中，按一下 [產生註冊金鑰檔案]。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-192">In **Prepare VMM Servers**, click **Generate registration key** file.</span></span> <span data-ttu-id="3e4c9-193">該金鑰檔案會自動產生，並在產生後會維持 5 天有效。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-193">The key file is generated automatically and is valid for 5 days after it's generated.</span></span> <span data-ttu-id="3e4c9-194">如果您沒有從 VMM 伺服器存取 Azure 入口網站，您必須將這個檔案複製到伺服器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-194">If you're not accessing the Azure portal from the VMM server you'll need to copy this file to the server.</span></span>

    ![註冊金鑰](./media/site-recovery-vmm-to-azure-classic/register-key.png)

## <a name="step-3-install-the-azure-site-recovery-provider"></a><span data-ttu-id="3e4c9-196">步驟 3：安裝 Azure Site Recovery 提供者</span><span class="sxs-lookup"><span data-stu-id="3e4c9-196">Step 3: Install the Azure Site Recovery Provider</span></span>
1. <span data-ttu-id="3e4c9-197">在 [快速啟動] > [準備 VMM 伺服器] 中，按一下 [下載要在 VMM 伺服器上安裝的 Microsoft Azure Site Recovery 提供者]，以取得最新版的提供者安裝檔案。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-197">In **Quick Start** > **Prepare VMM servers**, click **Download Microsoft Azure Site Recovery Provider for installation on VMM servers** to obtain the latest version of the Provider installation file.</span></span>
2. <span data-ttu-id="3e4c9-198">在來源 VMM 伺服器上執行此檔案。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-198">Run this file on the source VMM server.</span></span>

   > [!NOTE]
   > <span data-ttu-id="3e4c9-199">如果 VMM 部署在叢集中，且您是第一次安裝提供者，請將其安裝在作用中節點上，並完成安裝以在保存庫中註冊 VMM 伺服器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-199">If VMM is deployed in a cluster and you're installing the Provider for the first time install it on an active node and finish the installation to register the VMM server in the vault.</span></span> <span data-ttu-id="3e4c9-200">然後在其他節點上安裝提供者。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-200">Then install the Provider on the other nodes.</span></span> <span data-ttu-id="3e4c9-201">請注意，如果您要升級提供者，您必須在所有節點上升級，因為它們都應該執行相同的提供者版本。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-201">Note that if you're upgrading the Provider you'll need to upgrade on all nodes because they should all be running the same Provider version.</span></span>
   >
   >
3. <span data-ttu-id="3e4c9-202">安裝程式會執行一些先決條件檢查，並要求停止 VMM 服務的權限，以便開始安裝提供者。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-202">The Installer does a prerequirements check and requests permission to stop the VMM service to begin Provider setup.</span></span> <span data-ttu-id="3e4c9-203">當安裝完成之後，VMM 服務將會自動重新啟動。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-203">The VMM Service will be restarted automatically when setup finishes.</span></span> <span data-ttu-id="3e4c9-204">如果您安裝在 VMM 叢集上，您會收到停止叢集角色的提示。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-204">If you're installing on a VMM cluster you'll be prompted to stop the Cluster role.</span></span>
4. <span data-ttu-id="3e4c9-205">在 [Microsoft Update]  中，您可以選擇加入以取得更新。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-205">In **Microsoft Update** you can opt in for updates.</span></span> <span data-ttu-id="3e4c9-206">啟用這項設定時，會根據您的 Microsoft Update 原則來安裝提供者更新。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-206">With this setting enabled Provider updates will be installed according to your Microsoft Update policy.</span></span>

    ![Microsoft Update](./media/site-recovery-vmm-to-azure-classic/updates.png)
5. <span data-ttu-id="3e4c9-208">提供者的安裝位置已設為 **<SystemDrive>\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin**。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-208">The install location for the Provider is set to **<SystemDrive>\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin**.</span></span> <span data-ttu-id="3e4c9-209">按一下 [Install] 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-209">Click **Install**.</span></span>

   ![InstallLocation](./media/site-recovery-vmm-to-azure-classic/install-location.png)
6. <span data-ttu-id="3e4c9-211">安裝提供者之後，請按一下 [註冊]  ，在保存庫中註冊伺服器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-211">After the Provider is installed click **Register** to register the server in the vault.</span></span>

    ![InstallComplete](./media/site-recovery-vmm-to-azure-classic/install-complete.png)
7. <span data-ttu-id="3e4c9-213">在 [保存庫名稱] 中，確認要註冊伺服器的保存庫名稱。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-213">In **Vault name**, verify the name of the vault in which the server will be registered.</span></span> <span data-ttu-id="3e4c9-214">按 [下一步] 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-214">Click *Next*.</span></span>

    ![伺服器註冊](./media/site-recovery-vmm-to-azure-classic/vaultcred.PNG)
8. <span data-ttu-id="3e4c9-216">在 [網際網路連線]  中，指定 VMM 伺服器上執行的提供者連接到網際網路的方式。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-216">In **Internet Connection** specify how the Provider running on the VMM server connects to the Internet.</span></span> <span data-ttu-id="3e4c9-217">選取 [使用現有的 Proxy 設定連線]  ，以使用在伺服器上設定的預設網際網路連線設定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-217">Select **Connect with existing proxy settings** to use the default Internet connection settings configured on the server.</span></span>

    ![網際網路設定](./media/site-recovery-vmm-to-azure-classic/proxydetails.PNG)

   * <span data-ttu-id="3e4c9-219">如果您想要使用自訂 proxy，您應該在安裝提供者之前進行設定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-219">If you want to use a custom proxy you should set it up before you install the Provider.</span></span> <span data-ttu-id="3e4c9-220">當您進行自訂 proxy 設定時，會執行一項測試以檢查 proxy 連線。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-220">When you configure custom proxy settings a test will run to check the proxy connection.</span></span>
   * <span data-ttu-id="3e4c9-221">如果您使用自訂 proxy，或者您的預設 proxy 需要驗證，您必須輸入 proxy 詳細資料，包含 proxy 位址和連接埠。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-221">If you do use a custom proxy, or your default proxy requires authentication you'll need to enter the proxy details, including the proxy address and port.</span></span>
   * <span data-ttu-id="3e4c9-222">下列 URL 應可從 VMM 伺服器和 Hyper-V 主機存取</span><span class="sxs-lookup"><span data-stu-id="3e4c9-222">Following urls should be accessible from the VMM Server and the Hyper-v hosts</span></span>
     * <span data-ttu-id="3e4c9-223">*.hypervrecoverymanager.windowsazure.com</span><span class="sxs-lookup"><span data-stu-id="3e4c9-223">*.hypervrecoverymanager.windowsazure.com</span></span>
     * <span data-ttu-id="3e4c9-224">*.accesscontrol.windows.net</span><span class="sxs-lookup"><span data-stu-id="3e4c9-224">*.accesscontrol.windows.net</span></span>
     * <span data-ttu-id="3e4c9-225">*.backup.windowsazure.com</span><span class="sxs-lookup"><span data-stu-id="3e4c9-225">*.backup.windowsazure.com</span></span>
     * <span data-ttu-id="3e4c9-226">*.blob.core.windows.net</span><span class="sxs-lookup"><span data-stu-id="3e4c9-226">*.blob.core.windows.net</span></span>
     * <span data-ttu-id="3e4c9-227">*.store.core.windows.net</span><span class="sxs-lookup"><span data-stu-id="3e4c9-227">*.store.core.windows.net</span></span>
   * <span data-ttu-id="3e4c9-228">允許 [Azure 資料中心 IP 範圍](https://www.microsoft.com/download/confirmation.aspx?id=41653) 中所述的 IP 位址和 HTTPS (443) 通訊協定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-228">Allow the IP addresses described in [Azure Datacenter IP Ranges](https://www.microsoft.com/download/confirmation.aspx?id=41653) and HTTPS (443) protocol.</span></span> <span data-ttu-id="3e4c9-229">您必須具有打算使用以及美國西部之 Azure 區域的允許清單 IP 範圍</span><span class="sxs-lookup"><span data-stu-id="3e4c9-229">You would have to white-list IP ranges of the Azure region that you plan to use and that of West US.</span></span>
   * <span data-ttu-id="3e4c9-230">如果您使用的是自訂 proxy，則會使用指定的 proxy 認證自動建立 VMM RunAs 帳戶 (DRAProxyAccount)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-230">If you use a custom proxy a VMM RunAs account (DRAProxyAccount) will be created automatically using the specified proxy credentials.</span></span> <span data-ttu-id="3e4c9-231">設定 proxy 伺服器，讓此帳戶可以成功進行驗證。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-231">Configure the proxy server so that this account can authenticate successfully.</span></span> <span data-ttu-id="3e4c9-232">在 VMM 主控台中，可以修改 VMM RunAs 帳戶設定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-232">The VMM RunAs account settings can be modified in the VMM console.</span></span> <span data-ttu-id="3e4c9-233">若要這樣做，請開啟 [設定] 工作區、展開 [安全性]、按一下 [執行身分帳戶]，然後修改 DRAProxyAccount 的密碼。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-233">To do this, open the **Settings** workspace, expand **Security**, click **Run As Accounts**, and then modify the password for DRAProxyAccount.</span></span> <span data-ttu-id="3e4c9-234">您必須重新啟動 VMM 服務，這項設定才會生效。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-234">You’ll need to restart the VMM service so that this setting takes effect.</span></span>
9. <span data-ttu-id="3e4c9-235">在 [註冊金鑰] 中，選取您從 Azure Site Recovery 下載並複製到 VMM 伺服器的金鑰。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-235">In **Registration Key**, select the key that you downloaded from Azure Site Recovery and copied to the VMM server.</span></span>
10. <span data-ttu-id="3e4c9-236">只有在您正在將 VMM 雲端中的 Hyper-V VM 複寫至 Azure 時，才會使用這項加密設定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-236">The encryption setting is only used when you're replicating Hyper-V VMs in VMM clouds to Azure.</span></span> <span data-ttu-id="3e4c9-237">如果您是在複寫至次要站台，則不會使用它。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-237">If you're replicating to a secondary site it's not used.</span></span>
11. <span data-ttu-id="3e4c9-238">在 [伺服器名稱] 中，指定保存庫中 VMM 伺服器的易記識別名稱。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-238">In **Server name**, specify a friendly name to identify the VMM server in the vault.</span></span> <span data-ttu-id="3e4c9-239">在叢集設定中，指定 VMM 叢集角色名稱。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-239">In a cluster configuration specify the VMM cluster role name.</span></span>
12. <span data-ttu-id="3e4c9-240">在 [同步處理雲端中繼資料]  中，選取您是否要將 VMM 伺服器上所有雲端的中繼資料與保存庫同步。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-240">In **Synchronize cloud metadata** select whether you want to synchronize metadata for all clouds on the VMM server with the vault.</span></span> <span data-ttu-id="3e4c9-241">這個動作只需要在每個伺服器上進行一次。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-241">This action only needs to happen once on each server.</span></span> <span data-ttu-id="3e4c9-242">如果不要同步所有雲端，您可以取消核取這項設定，再於 VMM 主控台的雲端屬性中個別同步每個雲端。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-242">If you don't want to synchronize all clouds, you can leave this setting unchecked and synchronize each cloud individually in the cloud properties in the VMM console.</span></span>
13. <span data-ttu-id="3e4c9-243">按 [下一步]  ，完成此程序。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-243">Click **Next** to complete the process.</span></span> <span data-ttu-id="3e4c9-244">註冊後，Azure Site Recovery 即可從 VMM 伺服器擷取中繼資料。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-244">After registration, metadata from the VMM server is retrieved by Azure Site Recovery.</span></span> <span data-ttu-id="3e4c9-245">此伺服器會顯示於保存庫中 [伺服器] 頁面的 [VMM 伺服器] 索引標籤上。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-245">The server is displayed on the  **VMM Servers** tab on the **Servers** page in the vault.</span></span>

    ![最後一頁](./media/site-recovery-vmm-to-azure-classic/provider13.PNG)

<span data-ttu-id="3e4c9-247">註冊後，Azure Site Recovery 即可從 VMM 伺服器擷取中繼資料。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-247">After registration, metadata from the VMM server is retrieved by Azure Site Recovery.</span></span> <span data-ttu-id="3e4c9-248">此伺服器會顯示於保存庫中 [伺服器] 頁面的 [VMM 伺服器] 索引標籤上。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-248">The server is displayed on the **VMM Servers** tab, on the **Servers** page in the vault.</span></span>

### <a name="command-line-installation"></a><span data-ttu-id="3e4c9-249">命令列安裝</span><span class="sxs-lookup"><span data-stu-id="3e4c9-249">Command line installation</span></span>
<span data-ttu-id="3e4c9-250">您也可以使用下列命令列來安裝 Azure Site Recovery 提供者。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-250">The Azure Site Recovery Provider can also be installed using the following command line.</span></span> <span data-ttu-id="3e4c9-251">這個方法可以用來在適用於 Windows Server 2012 R2 的伺服器核心上安裝提供者。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-251">This method can be used to install the provider on a Server Core for Windows Server 2012 R2.</span></span>

1. <span data-ttu-id="3e4c9-252">將提供者安裝檔案和註冊金鑰下載至資料夾。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-252">Download the Provider installation file and registration key to a folder.</span></span> <span data-ttu-id="3e4c9-253">例如：C:\ASR。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-253">For example: C:\ASR.</span></span>
2. <span data-ttu-id="3e4c9-254">停止 System Center Virtual Machine Manager 服務</span><span class="sxs-lookup"><span data-stu-id="3e4c9-254">Stop the System Center Virtual Machine Manager service</span></span>
3. <span data-ttu-id="3e4c9-255">從提高權限的命令提示字元中，使用下列命令擷取提供者安裝程式：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-255">From an elevated command prompt, extract the Provider installer with these commands:</span></span>

        C:\Windows\System32> CD C:\ASR
        C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q
4. <span data-ttu-id="3e4c9-256">安裝提供者，如下所示：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-256">Install the provider as follows:</span></span>

        C:\ASR> setupdr.exe /i
5. <span data-ttu-id="3e4c9-257">註冊提供者，如下所示：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-257">Register the Provider as follows:</span></span>

        CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
        C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin\> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>       

<span data-ttu-id="3e4c9-258">參數如下所示：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-258">Where parameters are as follows:</span></span>

* <span data-ttu-id="3e4c9-259">**/Credentials** ：必要參數，用來指定註冊金鑰檔案所在的位置</span><span class="sxs-lookup"><span data-stu-id="3e4c9-259">**/Credentials** : Mandatory parameter that specifies the location in which the registration key file is located</span></span>  
* <span data-ttu-id="3e4c9-260">**/FriendlyName** ：對於 Hyper-V 主機伺服器名稱的必要參數，該伺服器會出現在 Azure Site Recovery 入口網站中。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-260">**/FriendlyName** : Mandatory parameter for the name of the Hyper-V host server that appears in the Azure Site Recovery portal.</span></span>
* <span data-ttu-id="3e4c9-261">**/EncryptionEnabled** ：選擇性參數，指定您是否要在 Azure 中加密您的虛擬機器 (靜態加密)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-261">**/EncryptionEnabled** : Optional parameter to specify if you want to encryption your virtual machines in Azure (at rest encryption).</span></span> <span data-ttu-id="3e4c9-262">檔名應該有 **.pfx** 副檔名。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-262">The file name should have a **.pfx** extension.</span></span>
* <span data-ttu-id="3e4c9-263">**/proxyAddress** ：指定 Proxy 伺服器位址的選用參數。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-263">**/proxyAddress** : Optional parameter that specifies the address of the proxy server.</span></span>
* <span data-ttu-id="3e4c9-264">**/proxyport** ：指定 Proxy 伺服器連接埠的選用參數。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-264">**/proxyport** : Optional parameter that specifies the port of the proxy server.</span></span>
* <span data-ttu-id="3e4c9-265">**/proxyUsername** ：選擇性參數，指定 Proxy 使用者名稱。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-265">**/proxyUsername** : Optional parameter that specifies the proxy user name.</span></span>
* <span data-ttu-id="3e4c9-266">**/proxyPassword** ：選擇性參數，指定 Proxy 密碼。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-266">**/proxyPassword** :Optional parameter that specifies the proxy password.</span></span>  

## <a name="step-4-create-an-azure-storage-account"></a><span data-ttu-id="3e4c9-267">步驟 4：建立 Azure 儲存體帳戶</span><span class="sxs-lookup"><span data-stu-id="3e4c9-267">Step 4: Create an Azure storage account</span></span>
1. <span data-ttu-id="3e4c9-268">如果您沒有 Azure 儲存體帳戶，請按一下 [新增 Azure 儲存體帳戶]  以建立帳戶。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-268">If you don't have an Azure storage account click **Add an Azure Storage Account** to create an account.</span></span>
2. <span data-ttu-id="3e4c9-269">建立帳戶並啟用異地複寫。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-269">Create an account with geo-replication enabled.</span></span> <span data-ttu-id="3e4c9-270">此帳戶應與 Azure 站台復原服務位於相同的區域，且與相同的訂閱相關聯。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-270">It must in the same region as the Azure Site Recovery service, and be associated with the same subscription.</span></span>

    ![儲存體帳戶](./media/site-recovery-vmm-to-azure-classic/storage.png)

> [!NOTE]
> <span data-ttu-id="3e4c9-272">對於用於部署 Site Recovery 的儲存體帳戶，不支援跨相同訂用帳戶內的資源群組或跨訂用帳戶[移轉儲存體帳戶](../azure-resource-manager/resource-group-move-resources.md)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-272">[Migration of storage accounts](../azure-resource-manager/resource-group-move-resources.md) across resource groups within the same subscription or across subscriptions is not supported for storage accounts used for deploying Site Recovery.</span></span>
>
>

## <a name="step-5-install-the-azure-recovery-services-agent"></a><span data-ttu-id="3e4c9-273">步驟 5：安裝 Azure 復原服務代理程式</span><span class="sxs-lookup"><span data-stu-id="3e4c9-273">Step 5: Install the Azure Recovery Services Agent</span></span>
<span data-ttu-id="3e4c9-274">在 VMM 雲端中的每一個 Hyper-V 主機伺服器上，安裝 Azure 復原服務代理程式。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-274">Install the Azure Recovery Services agent on each Hyper-V host server in the VMM cloud.</span></span>

1. <span data-ttu-id="3e4c9-275">按一下 [快速啟動] > [下載 Azure Site Recovery 服務代理程式並安裝在主機上]，以取得最新版的代理程式安裝檔案。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-275">Click **Quick Start** > **Download Azure Site Recovery Services Agent and install on hosts** to obtain the latest version of the agent installation file.</span></span>

    ![Install Recovery Services Agent](./media/site-recovery-vmm-to-azure-classic/install-agent.png)
2. <span data-ttu-id="3e4c9-277">在每一個 Hyper-V 主機伺服器上執行安裝檔案。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-277">Run the installation file on each Hyper-V host server.</span></span>
3. <span data-ttu-id="3e4c9-278">在 [檢查先決條件] 頁面上，按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-278">On the **Prerequisites Check** page click **Next**.</span></span> <span data-ttu-id="3e4c9-279">將自動安裝任何缺少的必要元件。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-279">Any missing prerequisites will be automatically installed.</span></span>

    ![Prerequisites Recovery Services Agent](./media/site-recovery-vmm-to-azure-classic/agent-prereqs.png)
4. <span data-ttu-id="3e4c9-281">在 [安裝設定]  頁面上，指定您要安裝代理程式的位置，並選取將在其中安裝備份中繼資料的快取位置。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-281">On the **Installation Settings** page, specify where you want to install the agent and select the cache location in which backup metadata will be installed.</span></span> <span data-ttu-id="3e4c9-282">然後按一下 [安裝] 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-282">Then click **Install**.</span></span>
5. <span data-ttu-id="3e4c9-283">安裝完成之後，按一下 [關閉]  來完成精靈。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-283">After installation finishes click **Close** to complete the wizard.</span></span>

    ![註冊 MARS 代理程式](./media/site-recovery-vmm-to-azure-classic/agent-register.png)

### <a name="command-line-installation"></a><span data-ttu-id="3e4c9-285">命令列安裝</span><span class="sxs-lookup"><span data-stu-id="3e4c9-285">Command line installation</span></span>
<span data-ttu-id="3e4c9-286">您也可以使用下列命令，從命令列安裝 Microsoft Azure 復原服務代理程式：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-286">You can also install the Microsoft Azure Recovery Services Agent from the command line using this command:</span></span>

    marsagentinstaller.exe /q /nu

## <a name="step-6-configure-cloud-protection-settings"></a><span data-ttu-id="3e4c9-287">步驟 6：設定雲端保護設定</span><span class="sxs-lookup"><span data-stu-id="3e4c9-287">Step 6: Configure cloud protection settings</span></span>
<span data-ttu-id="3e4c9-288">註冊 VMM 伺服器之後，您就可以設定雲端保護設定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-288">After the VMM server is registered, you can configure cloud protection settings.</span></span> <span data-ttu-id="3e4c9-289">當您安裝提供者之後，即可啟用 [將雲端資料與保存庫同步] 選項，如此一來，VMM 伺服器上的所有雲端將會出現在保存庫的 [受保護的項目]<b></b> 索引標籤中。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-289">You enabled the option **Synchronize cloud data with the vault** when you installed the Provider so all clouds on the VMM server will appear in the <b>Protected Items</b> tab in the vault.</span></span>

![發佈的雲端](./media/site-recovery-vmm-to-azure-classic/clouds-list.png)

1. <span data-ttu-id="3e4c9-291">在 [快速啟動] 頁面上，按一下 [設定 VMM 雲端的保護] 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-291">On the Quick Start page, click **Set up protection for VMM clouds**.</span></span>
2. <span data-ttu-id="3e4c9-292">在 [受保護項目] 索引標籤上，按一下要設定的雲端，並移至 [設定] 索引標籤。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-292">On the **Protected Items** tab, click on the cloud you want to configure and go to the **Configuration** tab.</span></span>
3. <span data-ttu-id="3e4c9-293">在   select 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-293">In **Target** select **Azure**.</span></span>
4. <span data-ttu-id="3e4c9-294">在 [儲存體帳戶]  中，選取您想要用來複寫的 Azure 儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-294">In **Storage Account** select the Azure storage account you use for replication.</span></span>
5. <span data-ttu-id="3e4c9-295">將 [加密儲存的資料] 設為 [關閉]。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-295">Set **Encrypt stored data** to **Off**.</span></span> <span data-ttu-id="3e4c9-296">這個設定指定在內部部署站台與 Azure 之間進行複寫期間，應該將資料加密。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-296">This setting specifies that data should be encrypted during replication between the on-premises site and Azure.</span></span>
6. <span data-ttu-id="3e4c9-297">在 [複製頻率]  中保留預設設定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-297">In **Copy frequency** leave the default setting.</span></span> <span data-ttu-id="3e4c9-298">這個值指定應在來源與目標位置之間同步處理資料的頻率。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-298">This value specifies how frequently data should be synchronized, between source and target locations.</span></span>
7. <span data-ttu-id="3e4c9-299">在 [Retain recovery points for] 中保留預設設定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-299">In **Retain recovery points for**, leave the default setting.</span></span> <span data-ttu-id="3e4c9-300">使用預設值 0 時，只會在複本主機伺服器上儲存主要虛擬機器的最新復原點。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-300">With a default value of zero, only the latest recovery point for a primary virtual machine is stored on a replica host server.</span></span>
8. <span data-ttu-id="3e4c9-301">在 [應用程式一致快照的頻率] 中保留預設設定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-301">In **Frequency of application-consistent snapshots**, leave the default setting.</span></span> <span data-ttu-id="3e4c9-302">這個值指定建立快照的頻率。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-302">This value specifies how often to create snapshots.</span></span> <span data-ttu-id="3e4c9-303">快照會使用「磁碟區陰影複製服務」(VSS) 來確保建立快照時，應用程式是處於一致狀態。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-303">Snapshots use Volume Shadow Copy Service (VSS) to ensure that applications are in a consistent state when the snapshot is taken.</span></span>  <span data-ttu-id="3e4c9-304">如果您設定一個值，請確定此值小於您設定的其他復原點數目。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-304">If you do set a value, make sure it's less than the number of additional recovery points you configure.</span></span>
9. <span data-ttu-id="3e4c9-305">在 [Replication start time] 中，指定初次將資料複寫至 Azure 的開始時間。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-305">In **Replication start time**, specify when initial replication of data to Azure should start.</span></span> <span data-ttu-id="3e4c9-306">將會使用 Hyper-V 主機伺服器的時區。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-306">The timezone on the Hyper-V host server will be used.</span></span> <span data-ttu-id="3e4c9-307">建議您將初次複寫排定在離峰時段進行。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-307">We recommend that you schedule the initial replication during off-peak hours.</span></span>

    ![Cloud replication settings](./media/site-recovery-vmm-to-azure-classic/cloud-settings.png)

<span data-ttu-id="3e4c9-309">儲存設定之後，會建立一個工作，並可在 [工作]  索引標籤上進行監視。將會對 VMM 雲端中的所有 Hyper-V 主機伺服器設定複寫。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-309">After you save the settings a job will be created and can be monitored on the **Jobs** tab. All Hyper-V host servers in the VMM source cloud will be configured for replication.</span></span>

<span data-ttu-id="3e4c9-310">儲存之後，可在 [設定]  索引標籤上修改雲端設定。若要修改目標位置或目標儲存體帳戶，您需要移除雲端組態，然後重新設定雲端。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-310">After saving, cloud settings can be modified on the **Configure** tab. To modify the target location or target storage account you'll need to remove the cloud configuration, and then reconfigure the cloud.</span></span> <span data-ttu-id="3e4c9-311">請注意，如果您變更儲存體帳戶，則只會對修改儲存體帳戶之後才啟用保護的虛擬機器套用變更。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-311">Note that if you change the storage account the change is only applied for virtual machines that are enabled for protection after the storage account has been modified.</span></span> <span data-ttu-id="3e4c9-312">現有的虛擬機器不會移轉至新的儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-312">Existing virtual machines are not migrated to the new storage account.</span></span>

## <a name="step-7-configure-network-mapping"></a><span data-ttu-id="3e4c9-313">步驟 7：設定網路對應</span><span class="sxs-lookup"><span data-stu-id="3e4c9-313">Step 7: Configure network mapping</span></span>
<span data-ttu-id="3e4c9-314">開始網路對應之前，請確認來源 VMM 伺服器上的虛擬機器已連線到 VM 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-314">Before you begin network mapping verify that virtual machines on the source VMM server are connected to a VM network.</span></span> <span data-ttu-id="3e4c9-315">此外，請建立一或多個 Azure 虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-315">In addition create one or more Azure virtual networks.</span></span> <span data-ttu-id="3e4c9-316">請注意，多個 VM 網路可對應至單一 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-316">Note that multiple VM networks can be mapped to a single Azure network.</span></span>

1. <span data-ttu-id="3e4c9-317">在 [快速入門] 頁面上，按一下 [對應網路] 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-317">On the Quick Start page, click **Map networks**.</span></span>
2. <span data-ttu-id="3e4c9-318">在 [網路] 索引標籤的 [來源位置] 中，選取來源 VMM 伺服器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-318">On the **Networks** tab, in **Source location**, select the source VMM server.</span></span> <span data-ttu-id="3e4c9-319">在 [目標位置]  中選取 [Azure]。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-319">In **Target location** select Azure.</span></span>
3. <span data-ttu-id="3e4c9-320">在 [來源]  網路中，會顯示與 VMM 伺服器相關聯的 VM 網路清單。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-320">In **Source** networks a list of VM networks associated with the VMM server are displayed.</span></span> <span data-ttu-id="3e4c9-321">在 [目標]  網路中，會顯示與訂用帳戶相關聯的 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-321">In **Target** networks the Azure networks associated with the subscription are displayed.</span></span>
4. <span data-ttu-id="3e4c9-322">選取來源 VM 網路，然後按一下 [對應] 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-322">Select the source VM network and click **Map**.</span></span>
5. <span data-ttu-id="3e4c9-323">在 [選取目標網路]  頁面上，選取您要使用的目標 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-323">On the **Select a Target Network** page, select the target Azure network you want to use.</span></span>
6. <span data-ttu-id="3e4c9-324">按一下打勾記號完成對應程序。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-324">Click the check mark to complete the mapping process.</span></span>

    ![Cloud replication settings](./media/site-recovery-vmm-to-azure-classic/map-networks.png)

<span data-ttu-id="3e4c9-326">儲存設定之後，工作會開始追蹤對應進度，可在 [工作] 索引標籤上進行監視。對應來源 VM 網路的任何現有複本虛擬機器都會連線到目標 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-326">After you save the settings a job starts to track the mapping progress and it can be monitored on the Jobs tab. Any existing replica virtual machines that correspond to the source VM network will be connected to the target Azure networks.</span></span> <span data-ttu-id="3e4c9-327">連線到來源 VM 網路的新虛擬機器都會在複寫之後連線到對應的 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-327">New virtual machines that are connected to the source VM network will be connected to the mapped Azure network after replication.</span></span> <span data-ttu-id="3e4c9-328">如果您修改與新網路的現有對應，複本虛擬機器將使用新設定進行連線。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-328">If you modify an existing mapping with a new network, replica virtual machines will be connected using the new settings.</span></span>

<span data-ttu-id="3e4c9-329">請注意，如果目標網路具有多個子網路，且其中一個子網路的名稱和來源虛擬機器所在之子網路名稱相同，複本虛擬機器將會在容錯移轉之後連線到該目標子網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-329">Note that if the target network has multiple subnets and one of those subnets has the same name as subnet on which the source virtual machine is located, then the replica virtual machine will be connected to that target subnet after failover.</span></span> <span data-ttu-id="3e4c9-330">如果沒有目標子網路具有相符的名稱，虛擬機器將會連線到網路中的第一個子網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-330">If there’s no target subnet with a matching name, the virtual machine will be connected to the first subnet in the network.</span></span>

> [!NOTE]
> <span data-ttu-id="3e4c9-331">對於用於部署 Site Recovery 的網路，不支援跨相同訂用帳戶內的資源群組或跨訂用帳戶[移轉網路](../azure-resource-manager/resource-group-move-resources.md)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-331">[Migration of networks](../azure-resource-manager/resource-group-move-resources.md) across resource groups within the same subscription or across subscriptions is not supported for networks used for deploying Site Recovery.</span></span>
>
>

## <a name="step-8-enable-protection-for-virtual-machines"></a><span data-ttu-id="3e4c9-332">步驟 8：對虛擬機器啟用保護</span><span class="sxs-lookup"><span data-stu-id="3e4c9-332">Step 8: Enable protection for virtual machines</span></span>
<span data-ttu-id="3e4c9-333">正確設定伺服器、雲端和網路後，您就可以對雲端中的虛擬機器啟用保護。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-333">After servers, clouds, and networks are configured correctly, you can enable protection for virtual machines in the cloud.</span></span> <span data-ttu-id="3e4c9-334">請注意：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-334">Note the following:</span></span>

* <span data-ttu-id="3e4c9-335">虛擬機器必須符合 [Azure 需求](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-335">Virtual machines must meet [Azure requirements](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span></span>
* <span data-ttu-id="3e4c9-336">若要啟用保護功能，您必須為虛擬機器設定作業系統和作業系統磁碟屬性。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-336">To enable protection the operating system and operating system disk properties must be set for the virtual machine.</span></span> <span data-ttu-id="3e4c9-337">當您使用虛擬機器範本在 VMM 中建立虛擬機器時，您可以設定屬性。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-337">When you create a virtual machine in VMM using a virtual machine template you can set the property.</span></span> <span data-ttu-id="3e4c9-338">您也可以在虛擬機器屬性的 [一般] 及 [硬體設定] 索引標籤上，為現有的虛擬機器設定這些屬性。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-338">You can also set these properties for existing virtual machines on the **General** and **Hardware Configuration** tabs of the virtual machine properties.</span></span> <span data-ttu-id="3e4c9-339">若未在 VMM 中設定這些屬性，您將可在 Azure 站台復原入口網站中加以設定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-339">If you don't set these properties in VMM you'll be able to configure them in the Azure Site Recovery portal.</span></span>

    ![Create virtual machine](./media/site-recovery-vmm-to-azure-classic/enable-new.png)

    ![Modify virtual machine properties](./media/site-recovery-vmm-to-azure-classic/enable-existing.png)

1. <span data-ttu-id="3e4c9-342">若要啟用保護，請在虛擬機器所在雲端中的 [虛擬機器] 索引標籤上，按一下 [啟用保護] > [加入虛擬機器]。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-342">To enable protection, on the **Virtual Machines** tab in the cloud in which the virtual machine is located, click **Enable protection** > **Add virtual machines**.</span></span>
2. <span data-ttu-id="3e4c9-343">從雲端中所有虛擬機器的清單，選取您要保護的虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-343">From the list of virtual machines in the cloud, select the one you want to protect.</span></span>

    ![啟用虛擬機器保護](./media/site-recovery-vmm-to-azure-classic/select-vm.png)

    <span data-ttu-id="3e4c9-345">您可以在 [工作] 索引標籤中追蹤**啟用保護動**作的進度，包括初始複寫。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-345">Track progress of the **Enable Protection** action in the **Jobs** tab, including the initial replication.</span></span> <span data-ttu-id="3e4c9-346">執行 [完成保護]  作業之後，虛擬機器即準備好進行容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-346">After the **Finalize Protection** job runs the virtual machine is ready for failover.</span></span> <span data-ttu-id="3e4c9-347">啟用保護並複寫虛擬機器之後，您將能夠在 Azure 中檢視這些虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-347">After protection is enabled and virtual machines are replicated, you’ll be able to view them in Azure.</span></span>

    ![虛擬機器保護工作](./media/site-recovery-vmm-to-azure-classic/vm-jobs.png)

1. <span data-ttu-id="3e4c9-349">驗證虛擬機器屬性，並視需要加以修改。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-349">Verify the virtual machine properties and modify as required.</span></span>

    ![Verify virtual machines](./media/site-recovery-vmm-to-azure-classic/vm-properties.png)
2. <span data-ttu-id="3e4c9-351">在虛擬機器屬性的 [設定]  索引標籤上可以修改下列網路屬性。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-351">On the **Configure** tab of the virtual machine properties following network properties can be modified.</span></span>

* <span data-ttu-id="3e4c9-352">**目標虛擬機器的網路介面卡數目** - 網路介面卡的數目取決於您針對目標虛擬機器所指定的大小。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-352">**Number of network adapters on the target virtual machine** - The number of network adapters is dictated by the size you specify for the target virtual machine.</span></span> <span data-ttu-id="3e4c9-353">查看 [虛擬機器大小規格](../virtual-machines/linux/sizes.md) ，了解虛擬機器大小所支援的介面卡數目。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-353">Check [virtual machine size specs](../virtual-machines/linux/sizes.md) for the number of adapters supported by the virtual machine size.</span></span> <span data-ttu-id="3e4c9-354">在修改虛擬機器的大小並儲存設定之後，當您下次開啟 [設定] 頁面時，網路介面卡的數量將會改變。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-354">When you modify the size for a virtual machine and save the settings, the number of network adapters will change the next time you open the **Configure** page.</span></span> <span data-ttu-id="3e4c9-355">目標虛擬機器的網路介面卡數目，是來源虛擬機器上的網路介面卡數目下限，以及所選虛擬機器大小支援的網路介面卡數目上限，如下所示：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-355">The number of network adapters of target virtual machines is the minimum number of network adapters on source virtual machine and the maximum number of network adapters supported by the size of the virtual machine chosen, as follows:</span></span>

  * <span data-ttu-id="3e4c9-356">如果來源電腦上的網路介面卡數目小於或等於針對目標機器大小所允許的介面卡數目，則目標將具備與來源相同的介面卡數目。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-356">If the number of network adapters on the source machine is less than or equal to the number of adapters allowed for the target machine size, then the target will have the same number of adapters as the source.</span></span>
  * <span data-ttu-id="3e4c9-357">如果來源虛擬機器的介面卡數目超過針對目標大小所允許的數目，則將使用目標大小的最大值。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-357">If the number of adapters for the source virtual machine exceeds the number allowed for the target size then the target size maximum will be used.</span></span>
  * <span data-ttu-id="3e4c9-358">例如，如果來源機器具有兩張網路介面卡，而目標機器大小支援四張，則目標機器將會有兩張介面卡。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-358">For example, if a source machine has two network adapters and the target machine size supports four, the target machine will have two adapters.</span></span> <span data-ttu-id="3e4c9-359">如果來源機器具有兩張介面卡，但支援的目標大小僅支援一張，則目標機器將只會有一張介面卡。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-359">If the source machine has two adapters but the supported target size only supports one then the target machine will have only one adapter.</span></span>     
* <span data-ttu-id="3e4c9-360">**目標虛擬機器的網路** - 虛擬機器連接的網路取決於來源虛擬機器網路的網路對應。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-360">**Network of the target virtual machine** - The network to which the virtual machine connects to is determined by network mapping of the network of source virtual machine.</span></span> <span data-ttu-id="3e4c9-361">如果來源虛擬機器有一個以上的網路介面卡，且來源網路對應至目標上的不同網路，則您必須選擇其中一個目標網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-361">If the source virtual machine has more than one network adapter and source networks are mapped to different networks on target, then you'll need to choose between one of the target networks.</span></span>
* <span data-ttu-id="3e4c9-362">**每個網路介面卡的子網路** - 針對每個網路介面卡，您可以選取容錯移轉的虛擬機器會連接的子網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-362">**Subnet of each network adapter** - For each network adapter you can select the subnet to which the failed over virtual machine would connect to.</span></span>
* <span data-ttu-id="3e4c9-363">**目標 IP 位址** - 如果來源虛擬機器的網路介面卡是設定為使用靜態 IP 位址，則您可以提供目標虛擬機器的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-363">**Target IP address** - If the network adapter of source virtual machine is configured to use a static IP address then you can provide the IP address for the target virtual machine.</span></span> <span data-ttu-id="3e4c9-364">使用此功能，在容錯移轉之後保留來源虛擬機器的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-364">Use this feature retain the IP address of a source virtual machine after a failover.</span></span> <span data-ttu-id="3e4c9-365">如果未提供任何 IP 位址，在容錯移轉時會將任何可用的 IP 位址提供給網路介面卡。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-365">If no IP address is provided then any available IP address is given to the network adapter at the time of failover.</span></span> <span data-ttu-id="3e4c9-366">如果已指定目標 IP 位址，但是已由在 Azure 中執行的另一個虛擬機器使用，則容錯移轉將會失敗。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-366">If the target IP address is specified but is already used by another virtual machine running in Azure then failover will fail.</span></span>  

    ![修改網路屬性](./media/site-recovery-vmm-to-azure-classic/multi-nic.png)

> [!NOTE]
> <span data-ttu-id="3e4c9-368">不支援具有靜態 IP 位址的 Linux 虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-368">Linux virtual machines with static IP address aren't supported.</span></span>
>
>

## <a name="test-the-deployment"></a><span data-ttu-id="3e4c9-369">測試部署</span><span class="sxs-lookup"><span data-stu-id="3e4c9-369">Test the deployment</span></span>
<span data-ttu-id="3e4c9-370">若要測試部署，您可以對單一虛擬機器執行測試容錯移轉，或者建立包含多部虛擬機器的復原方案，再對這個方案執行測試容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-370">To test your deployment you can run a test failover for a single virtual machine, or create a recovery plan consisting of multiple virtual machines, and run a test failover for the plan.</span></span>  

<span data-ttu-id="3e4c9-371">測試容錯移轉會在隔離的網路中模擬您的容錯移轉與復原機制。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-371">Test failover simulates your failover and recovery mechanism in an isolated network.</span></span> <span data-ttu-id="3e4c9-372">請注意：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-372">Note that:</span></span>

* <span data-ttu-id="3e4c9-373">如果您在容錯移轉之後要使用遠端桌面連接到 Azure 中的虛擬機器，請先在虛擬機器上啟用遠端桌面連線，再執行測試容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-373">If you want to connect to the virtual machine in Azure using Remote Desktop after the failover, enable Remote Desktop Connection on the virtual machine before you run the test failover.</span></span>
* <span data-ttu-id="3e4c9-374">容錯移轉之後，您會透過遠端桌面，使用公用 IP 位址連接到 Azure VM。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-374">After failover, you use a public IP address to connect to the Azure VM using Remote Desktop.</span></span> <span data-ttu-id="3e4c9-375">如果想要這樣做，請確定沒有任何網域原則禁止您使用公用位址連接到虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-375">If you want to do this, ensure you don't have any domain policies that prevent you from connecting to a virtual machine using a public address.</span></span>

> [!NOTE]
> <span data-ttu-id="3e4c9-376">若要在容錯移轉至 Azure 時獲得最佳效能，請確定您已在 VM 上安裝 Azure 代理程式。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-376">To get the best performance when you fail over to Azure, ensure you've installed the Azure agent on the VM.</span></span> <span data-ttu-id="3e4c9-377">這會提供更快速的開機，並協助進行疑難排解。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-377">This provides faster boot, and helps with troubleshooting.</span></span> <span data-ttu-id="3e4c9-378">下載 [Linux 代理程式](https://github.com/Azure/WALinuxAgent)或 [Windows 代理程式](http://go.microsoft.com/fwlink/?LinkID=394789)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-378">Download the [Linux agent](https://github.com/Azure/WALinuxAgent), or the [Windows agent](http://go.microsoft.com/fwlink/?LinkID=394789).</span></span>
>
>

### <a name="create-a-recovery-plan"></a><span data-ttu-id="3e4c9-379">建立復原計畫</span><span class="sxs-lookup"><span data-stu-id="3e4c9-379">Create a recovery plan</span></span>
1. <span data-ttu-id="3e4c9-380">在 [復原方案]  索引標籤上，增加一個新方案。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-380">On the **Recovery Plans** tab, add a new plan.</span></span> <span data-ttu-id="3e4c9-381">指定名稱、在 [來源類型] 中指定 [VMM]，以及在 [來源] 中指定來源 VMM 伺服器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-381">Specify a name, **VMM** in **Source type**, and the source VMM server in **Source**.</span></span> <span data-ttu-id="3e4c9-382">目標將會是 Azure。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-382">The target will be Azure.</span></span>

    ![建立復原計畫](./media/site-recovery-vmm-to-azure-classic/recovery-plan1.png)
2. <span data-ttu-id="3e4c9-384">在 [選取虛擬機器]  頁面上，選取要新增到復原方案的虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-384">In the **Select Virtual Machines** page, select virtual machines to add to the recovery plan.</span></span> <span data-ttu-id="3e4c9-385">這些虛擬機器將新增到復原計畫的預設群組—群組 1。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-385">These virtual machines are added to the recovery plan default group—Group 1.</span></span> <span data-ttu-id="3e4c9-386">最多 100 部虛擬機器已在單一復原計畫中經過測試。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-386">A maximum of 100 virtual machines in a single recovery plan have been tested.</span></span>

* <span data-ttu-id="3e4c9-387">如果您將虛擬機器屬性加入計畫之前，想要確認這些屬性，請按一下屬性所在之雲端的屬性頁面上的虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-387">If you want to verify the virtual machine properties before adding them to the plan, click the virtual machine on the properties page of the cloud in which it’s located.</span></span> <span data-ttu-id="3e4c9-388">您也可以在 VMM 主控台中設定虛擬機器屬性。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-388">You can also configure the virtual machine properties in the VMM console.</span></span>
* <span data-ttu-id="3e4c9-389">顯示的所有虛擬機器已啟用保護。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-389">All of the virtual machines that are displayed have been enabled for protection.</span></span> <span data-ttu-id="3e4c9-390">此清單包含啟用保護並已完成初始複寫的虛擬機器，以及利用初始複寫擱置啟用保護的虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-390">The list includes both virtual machines that are enabled for protection and initial replication has completed, and those that are enabled for protection with initial replication pending.</span></span> <span data-ttu-id="3e4c9-391">只有已完成初始複寫的虛擬機器可做為復原計畫的一部分進行容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-391">Only virtual machines with initial replication completed can fail over as part of a recovery plan.</span></span>

    ![建立復原計畫](./media/site-recovery-vmm-to-azure-classic/select-rp.png)

<span data-ttu-id="3e4c9-393">建立復原方案之後，它會出現在 [復原方案]  索引標籤中。您也可以將 [Azure 自動化 Runbook](site-recovery-runbook-automation.md) 加入至復原方案，以自動化容錯移轉期間的動作。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-393">After a recovery plan has been created it appears in the **Recovery Plans** tab. You can also add [Azure automation runbooks](site-recovery-runbook-automation.md) to the recovery plan to automate actions during failover.</span></span>

### <a name="run-a-test-failover"></a><span data-ttu-id="3e4c9-394">執行測試容錯移轉</span><span class="sxs-lookup"><span data-stu-id="3e4c9-394">Run a test failover</span></span>
<span data-ttu-id="3e4c9-395">有兩種方式可以測試容錯移轉至 Azure。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-395">There are two ways to run a test failover to Azure.</span></span>

* <span data-ttu-id="3e4c9-396">**在沒有 Azure 網路的情況下測試容錯移轉**—這種測試容錯移轉可以檢查虛擬機器是否正確地出現在 Azure 中。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-396">**Test failover without an Azure network**—This type of test failover checks that the virtual machine comes up correctly in Azure.</span></span> <span data-ttu-id="3e4c9-397">在容錯移轉之後，虛擬機器不會連線到任何 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-397">The virtual machine won’t be connected to any Azure network after failover.</span></span>
* <span data-ttu-id="3e4c9-398">**利用 Azure 網路測試容錯移轉**- 這種測試容錯移轉可以檢查整個復寫環境是否如預期般出現並進行容錯移轉，虛擬機器會連線到只訂的目標 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-398">**Test failover with an Azure network**—This type of failover checks that the entire replication environment comes up as expected and that failed over the virtual machines will be connected to the specified target Azure network.</span></span> <span data-ttu-id="3e4c9-399">針對子網路處理的測試容錯移轉，可根據複本虛擬機器的子網路得知測試虛擬機器的子網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-399">For subnet handling, for test failover the subnet of the test virtual machine will be figured out based on the subnet of the replica virtual machine.</span></span> <span data-ttu-id="3e4c9-400">這和一般的複寫不同，一般複寫的複本虛擬機器子網路是根據來源虛擬機器的子網路得知。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-400">This is different to regular replication when the subnet of a replica virtual machine is based on the subnet of the source virtual machine.</span></span>

<span data-ttu-id="3e4c9-401">如果您想要針對啟用保護的虛擬機器執行測試容錯轉移至 Azure ，卻不想指定 Azure 目標網路，您不需要作任何準備。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-401">If you want to run a test failover for a virtual machine enabled for protection to Azure without specifying an Azure target network you don’t need to prepare anything.</span></span> <span data-ttu-id="3e4c9-402">若要以目標 Azure 網路執行測試容錯移轉，您必須建立與您的 Azure 正式作業網路 (當您在 Azure 中建立新網路時的預設行為) 分隔的新的 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-402">To run a test failover with a target Azure network you’ll need to create a new Azure network that’s isolated from your Azure production network (default behavior when you create a new network in Azure).</span></span> <span data-ttu-id="3e4c9-403">如需詳細資訊，請參考如何 [執行測試容錯移轉](site-recovery-failover.md) 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-403">Look at how to [run a test failover](site-recovery-failover.md) for more details.</span></span>

<span data-ttu-id="3e4c9-404">您也必須針對複寫虛擬機器設定基礎結構，以如預期般運作。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-404">You'll also need to set up the infrastructure for the replicated virtual machine to work as expected.</span></span> <span data-ttu-id="3e4c9-405">例如，具有網域控制站和 DNS 的虛擬機器可以使用 Azure Site Recovery 複寫到 Azure，而且可以使用測試容錯移轉，在測試網路中加以建立。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-405">For example, a virtual machine with Domain Controller and DNS can be replicated to Azure using Azure Site Recovery and can be created in the test network using Test Failover.</span></span> <span data-ttu-id="3e4c9-406">如需詳細資訊，請參閱 [Active Directory 測試容錯移轉考量](site-recovery-active-directory.md#test-failover-considerations) 一節。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-406">Look at [test failover considerations for active directory](site-recovery-active-directory.md#test-failover-considerations) section for more details.</span></span>

<span data-ttu-id="3e4c9-407">如果要執行測試容錯移轉，請執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-407">To run a test failover do the following:</span></span>

1. <span data-ttu-id="3e4c9-408">在 [復原計畫] 索引標籤上，選取計畫，然後按一下 [測試容錯移轉]。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-408">On the **Recovery Plans** tab, select the plan and click **Test Failover**.</span></span>
2. <span data-ttu-id="3e4c9-409">在 [確認測試容錯移轉] 頁面上，選取 [無] 或特定的 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-409">On the **Confirm Test Failover** page select **None** or a specific Azure network.</span></span>  <span data-ttu-id="3e4c9-410">請注意，如果您選取 [無]，測試容錯移轉將會檢查虛擬機器是否正確地複寫至 Azure，但並不會檢查您的複寫網路設定。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-410">Note that if you select None the test failover will check that the virtual machine replicated correctly to Azure but doesn't check your replication network configuration.</span></span>

    ![沒有網路](./media/site-recovery-vmm-to-azure-classic/test-no-network.png)
3. <span data-ttu-id="3e4c9-412">如果已啟用雲端的資料加密，當您開啟選項以啟用雲端的資料加密時，請在 [ **加密金鑰** ] 中選取在 VMM 伺服器上安裝提供者時發出的憑證。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-412">If data encryption is enabled for the cloud, in **Encryption Key** select the certificate that was issued during installation of the Provider on the VMM server, when you turned on the option to enable data encryption for a cloud.</span></span>
4. <span data-ttu-id="3e4c9-413">在 [工作]  索引標籤上，您可以追蹤容錯移轉進度。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-413">On the **Jobs** tab you can track failover progress.</span></span> <span data-ttu-id="3e4c9-414">您應該可以在 Azure 入口網站中看到該虛擬機器測試複本。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-414">You should also be able to see the virtual machine test replica in the Azure portal.</span></span> <span data-ttu-id="3e4c9-415">如果您設定從內部部署網路存取虛擬機器，您可以初始化虛擬機器的「遠端桌面」連線。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-415">If you’re set up to access virtual machines from your on-premises network you can initiate a Remote Desktop connection to the virtual machine.</span></span>
5. <span data-ttu-id="3e4c9-416">當容錯移轉到達 [完成測試] 階段時，按一下 [完成測試] 來完成它。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-416">When the failover reaches the **Complete testing** phase, click **Complete Test** to finish it.</span></span> <span data-ttu-id="3e4c9-417">您可以向下切入到 [工作]  索引標籤，來追蹤容錯移轉進度和狀態，並執行任何所需的動作。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-417">You can drill down to the **Job** tab to track failover progress and status, and to perform any actions that are needed.</span></span>
6. <span data-ttu-id="3e4c9-418">容錯移轉之後，您就能在 Azure 入口網站中看到虛擬機器測試複本。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-418">After failover, you can see the virtual machine test replica in the Azure portal.</span></span> <span data-ttu-id="3e4c9-419">如果您設定從內部部署網路存取虛擬機器，您可以初始化虛擬機器的「遠端桌面」連線。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-419">If you’re set up to access virtual machines from your on-premises network you can initiate a Remote Desktop connection to the virtual machine.</span></span> <span data-ttu-id="3e4c9-420">執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-420">Do the following:</span></span>

   1. <span data-ttu-id="3e4c9-421">確認虛擬機器成功啟動。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-421">Verify that the virtual machines start successfully.</span></span>
   2. <span data-ttu-id="3e4c9-422">如果您在容錯移轉之後要使用遠端桌面連接到 Azure 中的虛擬機器，請先在虛擬機器上啟用遠端桌面連線，再執行測試容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-422">If you want to connect to the virtual machine in Azure using Remote Desktop after the failover, enable Remote Desktop Connection on the virtual machine before you run the test failover.</span></span> <span data-ttu-id="3e4c9-423">您也必須在虛擬機器上新增 RDP 端點。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-423">You also need to add an RDP endpoint on the virtual machine.</span></span> <span data-ttu-id="3e4c9-424">您可以利用 [Azure 自動化 Runbook](site-recovery-runbook-automation.md) 來執行這個動作。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-424">You can leverage an [Azure Automation Runbooks](site-recovery-runbook-automation.md) to do that.</span></span>
   3. <span data-ttu-id="3e4c9-425">容錯移轉之後，如果您使用公用 IP 位址，請利用 [遠端桌面] 連接到 Azure 中的虛擬機器，以確定您沒有任何網域原則會阻止您使用公用位址連接到虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-425">After failover, if you use a public IP address to connect to the virtual machine in Azure using Remote Desktop, ensure you don't have any domain policies that prevent you from connecting to a virtual machine using a public address.</span></span>
7. <span data-ttu-id="3e4c9-426">測試完成之後，請執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="3e4c9-426">After the testing is complete do the following:</span></span>

   * <span data-ttu-id="3e4c9-427">按一下 [測試容錯移轉完成] 。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-427">Click **The test failover is complete**.</span></span> <span data-ttu-id="3e4c9-428">清除測試環境，以自動關閉電源及刪除測試虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-428">Clean up the test environment to automatically power off and delete the test virtual machines.</span></span>
   * <span data-ttu-id="3e4c9-429">按一下 [記事]  記錄並儲存關於測試容錯移轉的任何觀察。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-429">Click **Notes** to record and save any observations associated with the test failover.</span></span>


## <a name="next-steps"></a><span data-ttu-id="3e4c9-430">後續步驟</span><span class="sxs-lookup"><span data-stu-id="3e4c9-430">Next steps</span></span>
<span data-ttu-id="3e4c9-431">深入了解[設定復原方案](site-recovery-create-recovery-plans.md)和[容錯移轉](site-recovery-failover.md)。</span><span class="sxs-lookup"><span data-stu-id="3e4c9-431">Learn about [setting up recovery plans](site-recovery-create-recovery-plans.md) and [failover](site-recovery-failover.md).</span></span>
