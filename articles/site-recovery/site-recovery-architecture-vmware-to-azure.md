---
title: "Azure Site Recovery 中的 VMware 複寫 tooAzure 運作 aaaHow？ | Microsoft Docs"
description: "本文提供元件和複寫在內部部署 VMware Vm 和實體伺服器 tooAzure 以 hello Azure Site Recovery 服務時使用的架構的概觀"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: c413efcd-d750-4b22-b34b-15bcaa03934a
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: get-started-article
ms.date: 05/29/2017
ms.author: raynew
ROBOTS: NOINDEX, NOFOLLOW
redirect_url: vmware-walkthrough-architecture
ms.openlocfilehash: f0fb834f8b251640f97e4d0163b2b9e54de691e1
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="how-does-vmware-replication-tooazure-work-in-site-recovery"></a><span data-ttu-id="6f2c1-104">VMware 複寫 tooAzure 的運作方式在站台復原中？</span><span class="sxs-lookup"><span data-stu-id="6f2c1-104">How does VMware replication tooAzure work in Site Recovery?</span></span>

<span data-ttu-id="6f2c1-105">本文說明 hello 元件和複寫時所涉及程序內部使用 hello VMware 虛擬機器和實體 Windows/Linux 的伺服器，tooAzure [Azure Site Recovery](site-recovery-overview.md)服務。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-105">This article describes hello components and processes involved when replicating on-premises VMware virtual machines, and Windows/Linux physical servers, tooAzure using hello [Azure Site Recovery](site-recovery-overview.md) service.</span></span>

<span data-ttu-id="6f2c1-106">當您複製實體在內部部署伺服器 tooAzure 時，複寫會使用也 hello 相同元件和處理程序作為 VMware VM 複寫，但這些差異：</span><span class="sxs-lookup"><span data-stu-id="6f2c1-106">When you replicate physical on-premises servers tooAzure, replication uses also hello same components and processes as VMware VM replication, with these differences:</span></span>

- <span data-ttu-id="6f2c1-107">您可以使用實體伺服器 hello 組態伺服器，而不是 VMware VM。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-107">You can use a physical server for hello configuration server, instead of a VMware VM.</span></span>
- <span data-ttu-id="6f2c1-108">您需要內部部署的 VMware 基礎結構以供進行容錯回復。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-108">You will need an on-premises VMware infrastructure for failback.</span></span> <span data-ttu-id="6f2c1-109">您不能容錯回復 tooa 實體機器。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-109">You can't fail back tooa physical machine.</span></span>

<span data-ttu-id="6f2c1-110">張貼於 hello 下方的本文中，任何註解或詢問問題中 hello [Azure 復原服務論壇](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-110">Post any comments at hello bottom of this article, or ask questions in hello [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>


## <a name="architectural-components"></a><span data-ttu-id="6f2c1-111">架構元件</span><span class="sxs-lookup"><span data-stu-id="6f2c1-111">Architectural components</span></span>

<span data-ttu-id="6f2c1-112">有多個元件所涉及複寫 VMware Vm 和實體伺服器 tooAzure 時。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-112">There are a number of components involved when replicating VMware VMs and physical servers tooAzure.</span></span>

<span data-ttu-id="6f2c1-113">**元件**</span><span class="sxs-lookup"><span data-stu-id="6f2c1-113">**Component**</span></span> | <bpt id="p1">**</bpt>Location<ept id="p1">**</ept> | <span data-ttu-id="6f2c1-115">**詳細資料**</span><span class="sxs-lookup"><span data-stu-id="6f2c1-115">**Details**</span></span>
--- | --- | ---
<span data-ttu-id="6f2c1-116">**Azure**</span><span class="sxs-lookup"><span data-stu-id="6f2c1-116">**Azure**</span></span> | <span data-ttu-id="6f2c1-117">在 Azure 中，您需要 Azure 帳戶、Azure 儲存體帳戶和 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-117">In Azure you need an Azure account, an Azure storage account, and an Azure network.</span></span> | <span data-ttu-id="6f2c1-118">複寫的資料會儲存在 hello 儲存體帳戶，並從您的內部部署站台容錯移轉發生時，將會建立與 hello 複寫資料的 Azure Vm。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-118">Replicated data is stored in hello storage account, and Azure VMs are created with hello replicated data when failover from your on-premises site occurs.</span></span> <span data-ttu-id="6f2c1-119">在建立時即 hello Azure Vm 會連線 toohello Azure 虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-119">hello Azure VMs connect toohello Azure virtual network when they're created.</span></span>
<span data-ttu-id="6f2c1-120">**組態伺服器**</span><span class="sxs-lookup"><span data-stu-id="6f2c1-120">**Configuration server**</span></span> | <span data-ttu-id="6f2c1-121">單一內部部署 (VMWare VM) 執行的管理伺服器所需的 hello 部署，包括 hello 組態伺服器、 處理序伺服器、 主要目標伺服器的所有 hello 在內部部署元件</span><span class="sxs-lookup"><span data-stu-id="6f2c1-121">A single on-premises management server (VMWare VM) that runs all hello on-premises components that are needed for hello deployment, including hello configuration server, process server, master target server</span></span> | <span data-ttu-id="6f2c1-122">hello 組態伺服器元件會協調在內部部署與 Azure 之間的通訊並管理資料複寫。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-122">hello configuration server component coordinates communications between on-premises and Azure, and manages data replication.</span></span>
 <span data-ttu-id="6f2c1-123">**處理序伺服器**：</span><span class="sxs-lookup"><span data-stu-id="6f2c1-123">**Process server**:</span></span>  | <span data-ttu-id="6f2c1-124">Hello 組態伺服器上的預設安裝。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-124">Installed by default on hello configuration server.</span></span> | <span data-ttu-id="6f2c1-125">會做為複寫閘道器。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-125">Acts as a replication gateway.</span></span> <span data-ttu-id="6f2c1-126">接收複寫資料、 最佳化與快取、 壓縮和加密，並將它傳送 tooAzure 儲存體。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-126">Receives replication data, optimizes it with caching, compression, and encryption, and sends it tooAzure storage.</span></span><br/><br/> <span data-ttu-id="6f2c1-127">hello 處理序伺服器也會處理推入安裝的 hello 行動服務 tooprotected 機器，並執行的 VMware Vm 的自動探索。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-127">hello process server also handles push installation of hello Mobility service tooprotected machines, and performs automatic discovery of VMware VMs.</span></span><br/><br/> <span data-ttu-id="6f2c1-128">隨著您的部署，您可以加入其他個別的專用處理序伺服器 toohandle 增加磁碟區的複寫流量。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-128">As your deployment grows you can add additional separate dedicated process servers toohandle increasing volumes of replication traffic.</span></span>
 <span data-ttu-id="6f2c1-129">**主要目標伺服器**</span><span class="sxs-lookup"><span data-stu-id="6f2c1-129">**Master target server**</span></span> | <span data-ttu-id="6f2c1-130">Hello 在內部部署組態伺服器上的預設安裝。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-130">Installed by default on hello on-premises configuration server.</span></span> | <span data-ttu-id="6f2c1-131">在從 Azure 容錯回復期間，處理複寫資料。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-131">Handles replication data during failback from Azure.</span></span><br/><br/> <span data-ttu-id="6f2c1-132">如果容錯回復的流量很高，您可以部署個別的主要目標伺服器來供容錯回復使用。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-132">If volumes of failback traffic are high, you can deploy a separate master target server for failback.</span></span>
<span data-ttu-id="6f2c1-133">**VMware 伺服器**</span><span class="sxs-lookup"><span data-stu-id="6f2c1-133">**VMware servers**</span></span> | <span data-ttu-id="6f2c1-134">VMware Vm 上 vSphere ESXi 伺服器，以及建議的 vCenter server toomanage hello 主機。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-134">VMware VMs are hosted on vSphere ESXi servers, and we recommend a vCenter server toomanage hello hosts.</span></span> | <span data-ttu-id="6f2c1-135">您新增 VMware 伺服器 tooyour 復原服務保存庫。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-135">You add VMware servers tooyour Recovery Services vault.</span></span>
<span data-ttu-id="6f2c1-136">**複寫的機器**</span><span class="sxs-lookup"><span data-stu-id="6f2c1-136">**Replicated machines**</span></span> | <span data-ttu-id="6f2c1-137">hello 行動服務將會安裝在每個 VMware 想 tooreplicate VM 上。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-137">hello Mobility service will be installed on each VMware VM you want tooreplicate.</span></span> <span data-ttu-id="6f2c1-138">它可以手動安裝在每部電腦上，或從 hello 處理序伺服器推入安裝。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-138">It can be installed manually on each machine, or with a push installation from hello process server.</span></span>

<span data-ttu-id="6f2c1-139">深入了解 hello 部署先決條件和需求的每個元件在 hello[支援矩陣](site-recovery-support-matrix-to-azure.md)。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-139">Learn about hello deployment prerequisites and requirements for each of these components in hello [support matrix](site-recovery-support-matrix-to-azure.md).</span></span>

<span data-ttu-id="6f2c1-140">**圖 1: VMware tooAzure 元件**</span><span class="sxs-lookup"><span data-stu-id="6f2c1-140">**Figure 1: VMware tooAzure components**</span></span>

![元件](./media/site-recovery-components/arch-enhanced.png)

## <a name="replication-process"></a><span data-ttu-id="6f2c1-142">複寫程序</span><span class="sxs-lookup"><span data-stu-id="6f2c1-142">Replication process</span></span>

1. <span data-ttu-id="6f2c1-143">您設定 hello 部署，包含 Azure 的元件，與復原服務保存庫。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-143">You set up hello deployment, including Azure components, and a Recovery Services vault.</span></span> <span data-ttu-id="6f2c1-144">Hello 保存庫中指定 hello 複寫來源和目標，設定 hello 組態伺服器，新增 VMware 伺服器、 建立複寫原則，部署 hello 行動服務、 啟用複寫，以及執行測試容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-144">In hello vault you specify hello replication source and target, set up hello configuration server, add VMware servers, create a replication policy, deploy hello Mobility service, enable replication, and run a test failover.</span></span>
2.  <span data-ttu-id="6f2c1-145">機器會開始複寫 hello 複寫原則，根據與 hello 資料的初始複本會複寫的 tooAzure 儲存體。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-145">Machines start replicating in accordance with hello replication policy, and an initial copy of hello data is replicated tooAzure storage.</span></span>
4. <span data-ttu-id="6f2c1-146">在 hello 初始複寫完成後，就會開始複寫差異變更 tooAzure。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-146">Replication of delta changes tooAzure begins after hello initial replication finishes.</span></span> <span data-ttu-id="6f2c1-147">機器的追蹤變更會保存在 .hrl 檔案中。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-147">Tracked changes for a machine are held in a .hrl file.</span></span>
    - <span data-ttu-id="6f2c1-148">複寫機器 hello 組態與伺服器通訊連接埠 HTTPS 443 輸入複寫管理的。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-148">Replicating machines communicate with hello configuration server on port HTTPS 443 inbound, for replication management.</span></span>
    - <span data-ttu-id="6f2c1-149">複寫機器複寫資料 toohello 處理序伺服器連接埠上傳送 HTTPS 9443 輸入 （可以在設定）。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-149">Replicating machines send replication data toohello process server on port HTTPS 9443 inbound (can be configured).</span></span>
    - <span data-ttu-id="6f2c1-150">hello 組態伺服器協調使用 Azure 的複寫管理透過 HTTPS 443 輸出連接埠。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-150">hello configuration server orchestrates replication management with Azure over port HTTPS 443 outbound.</span></span>
    - <span data-ttu-id="6f2c1-151">hello 處理序伺服器接收資料從來源機器、 最佳化及加密，並將它 tooAzure 儲存體傳送連接埠 443 輸出。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-151">hello process server receives data from source machines, optimizes and encrypts it, and sends it tooAzure storage over port 443 outbound.</span></span>
    - <span data-ttu-id="6f2c1-152">如果您啟用多重 VM 一致性，然後 hello 複寫群組中的電腦與對方進行通訊透過連接埠 20004。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-152">If you enable multi-VM consistency, then machines in hello replication group communicate with each other over port 20004.</span></span> <span data-ttu-id="6f2c1-153">如果您將多部機器群組為幾個共用當機時保持一致復原點和應用程式一致復原點的複寫群組，當這些群組在進行容錯移轉時，便會使用多部 VM。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-153">Multi-VM is used if you group multiple machines into replication groups that share crash-consistent and app-consistent recovery points when they fail over.</span></span> <span data-ttu-id="6f2c1-154">這非常有用，如果電腦執行 hello 相同的工作負載，而且需要 toobe 一致。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-154">This is useful if machines are running hello same workload and need toobe consistent.</span></span>
5. <span data-ttu-id="6f2c1-155">流量會複寫的 tooAzure 儲存體公用端點，超過 hello 網際網路。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-155">Traffic is replicated tooAzure storage public endpoints, over hello internet.</span></span> <span data-ttu-id="6f2c1-156">或者，您可以使用 Azure ExpressRoute [公用對等](../expressroute/expressroute-circuit-peerings.md#public-peering)。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-156">Alternately, you can use Azure ExpressRoute [public peering](../expressroute/expressroute-circuit-peerings.md#public-peering).</span></span> <span data-ttu-id="6f2c1-157">不支援透過站對站 VPN 從內部部署站台 tooAzure 複寫流量。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-157">Replicating traffic over a site-to-site VPN from an on-premises site tooAzure isn't supported.</span></span>

<span data-ttu-id="6f2c1-158">**圖 2: VMware tooAzure 複寫**</span><span class="sxs-lookup"><span data-stu-id="6f2c1-158">**Figure 2: VMware tooAzure replication**</span></span>

![增強](./media/site-recovery-components/v2a-architecture-henry.png)

## <a name="failover-and-failback-process"></a><span data-ttu-id="6f2c1-160">容錯移轉和容錯回復程序</span><span class="sxs-lookup"><span data-stu-id="6f2c1-160">Failover and failback process</span></span>

1. <span data-ttu-id="6f2c1-161">在您確認測試容錯移轉正常運作之後，您可以視需要執行未規劃的容錯移轉 tooAzure。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-161">After you verify that test failover is working as expected, you can run unplanned failovers tooAzure as required.</span></span> <span data-ttu-id="6f2c1-162">不支援有計劃的容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-162">Planned failover isn't supported.</span></span>
2. <span data-ttu-id="6f2c1-163">您可以容錯移轉單一電腦，或建立[復原計劃](site-recovery-create-recovery-plans.md)，toofail 於多個 Vm。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-163">You can fail over a single machine, or create [recovery plans](site-recovery-create-recovery-plans.md), toofail over multiple VMs.</span></span>
3. <span data-ttu-id="6f2c1-164">當您執行容錯移轉時，會在 Azure 中建立複本 VM。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-164">When you run a failover, replica VMs are created in Azure.</span></span> <span data-ttu-id="6f2c1-165">您從 Azure VM 的 hello 複本認可容錯移轉 toostart 存取 hello 工作負載。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-165">You commit a failover toostart accessing hello workload from hello replica Azure VM.</span></span>
4. <span data-ttu-id="6f2c1-166">當主要的內部部署網站恢復可用狀態時，您就可以容錯回復。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-166">When your primary on-premises site is available again, you can fail back.</span></span> <span data-ttu-id="6f2c1-167">您設定容錯回復基礎結構，開始從主要的 hello 次要站台 toohello 複寫 hello 機器，並從 hello 次要站台執行未規劃的容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-167">You set up a failback infrastructure, start replicating hello machine from hello secondary site toohello primary, and run an unplanned failover from hello secondary site.</span></span> <span data-ttu-id="6f2c1-168">確認此容錯移轉之後，資料將會回復在內部，並再次需要 tooenable 複寫 tooAzure。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-168">After you commit this failover, data will be back on-premises, and you need tooenable replication tooAzure again.</span></span> [<span data-ttu-id="6f2c1-169">深入了解</span><span class="sxs-lookup"><span data-stu-id="6f2c1-169">Learn more</span></span>](site-recovery-failback-azure-to-vmware.md)

<span data-ttu-id="6f2c1-170">容錯回復有以下幾項需求︰</span><span class="sxs-lookup"><span data-stu-id="6f2c1-170">There are a few failback requirements:</span></span>


- <span data-ttu-id="6f2c1-171">**在 Azure 中的暫存處理序伺服器**： 如果您想 toofail 從 Azure 容錯移轉之後您將需要 tooset 設定處理序伺服器，從 Azure toohandle 複寫為 Azure vm。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-171">**Temporary process server in Azure**: If you want toofail back from Azure after failover you'll need tooset up an Azure VM configured as a process server, toohandle replication from Azure.</span></span> <span data-ttu-id="6f2c1-172">容錯回復完成後，您可以刪除此 VM。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-172">You can delete this VM after failback finishes.</span></span>
- <span data-ttu-id="6f2c1-173">**VPN 連線**： 您必須容錯回復的 VPN 連線 （或 Azure ExpressRoute） 設定從 hello Azure 網路 toohello 在內部部署站台。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-173">**VPN connection**: For failback you'll need a VPN connection (or Azure ExpressRoute) set up from hello Azure network toohello on-premises site.</span></span>
- <span data-ttu-id="6f2c1-174">**另一個在內部部署主要目標伺服器**: hello 在內部部署主要目標伺服器可處理容錯回復。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-174">**Separate on-premises master target server**: hello on-premises master target server handles failback.</span></span> <span data-ttu-id="6f2c1-175">hello 管理伺服器上，預設會安裝 hello 主要目標伺服器，但如果您在容錯回較大量的流量您應該設定不同內部部署主要目標伺服器針對此目的。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-175">hello master target server is installed by default on hello management server, but if you're failing back larger volumes of traffic you should set up a separate on-premises master target server for this purpose.</span></span>
- <span data-ttu-id="6f2c1-176">**容錯回復原則**: tooreplicate 後 tooyour 內部網站，您需要容錯回復原則。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-176">**Failback policy**: tooreplicate back tooyour on-premises site, you need a failback policy.</span></span> <span data-ttu-id="6f2c1-177">此原則會在您建立複寫原則時自動建立。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-177">This is automatically created when you created your replication policy.</span></span>
- <span data-ttu-id="6f2c1-178">**VMware 基礎結構**： 您必須容錯回復 tooan 內部部署 VMware VM。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-178">**VMware infrastructure**: You must fail back tooan on-premises VMware VM.</span></span> <span data-ttu-id="6f2c1-179">這表示您需要在內部部署 VMware 基礎結構中，即使您要複寫在內部部署實體伺服器 tooAzure。</span><span class="sxs-lookup"><span data-stu-id="6f2c1-179">This means you need an on-premises VMware infrastructure, even if you're replicating on-premises physical servers tooAzure.</span></span>

<span data-ttu-id="6f2c1-180">**圖 3：VMware/實體容錯回復**</span><span class="sxs-lookup"><span data-stu-id="6f2c1-180">**Figure 3: VMware/physical failback**</span></span>

![容錯回復](./media/site-recovery-components/enhanced-failback.png)


## <a name="next-steps"></a><span data-ttu-id="6f2c1-182">後續步驟</span><span class="sxs-lookup"><span data-stu-id="6f2c1-182">Next steps</span></span>

<span data-ttu-id="6f2c1-183">檢閱 hello[支援矩陣](site-recovery-support-matrix-to-azure.md)</span><span class="sxs-lookup"><span data-stu-id="6f2c1-183">Review hello [support matrix](site-recovery-support-matrix-to-azure.md)</span></span>
