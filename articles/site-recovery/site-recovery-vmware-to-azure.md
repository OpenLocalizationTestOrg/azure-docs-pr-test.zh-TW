---
title: "將 VMware VM 複寫至 Azure | Microsoft Docs"
description: "摘要說明將 VMware VM 上執行的工作負載複寫至 Azure 儲存體所需的步驟"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: jwhit
editor: 
ms.assetid: dab98aa5-9c41-4475-b7dc-2e07ab1cfd18
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/14/2017
ms.author: raynew
ROBOTS: NOINDEX, NOFOLLOW
redirect_url: vmware-walkthrough-overview
ms.openlocfilehash: 8a312f3c1a65b2a9bb91abbfd8b18fb0ec0279b7
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="replicate-vmware-virtual-machines-to-azure-with-site-recovery"></a><span data-ttu-id="f8e9e-103">使用 Site Recovery 將 VMWare 虛擬機器複寫至 Azure</span><span class="sxs-lookup"><span data-stu-id="f8e9e-103">Replicate VMware virtual machines to Azure with Site Recovery</span></span>

> [!div class="op_single_selector"]
> * [<span data-ttu-id="f8e9e-104">Azure 入口網站</span><span class="sxs-lookup"><span data-stu-id="f8e9e-104">Azure portal</span></span>](site-recovery-vmware-to-azure.md)
> * [<span data-ttu-id="f8e9e-105">Azure 傳統型</span><span class="sxs-lookup"><span data-stu-id="f8e9e-105">Azure classic</span></span>](site-recovery-vmware-to-azure-classic.md)


<span data-ttu-id="f8e9e-106">本文說明如何在 Azure 入口網站中使用 [Azure Site Recovery](site-recovery-overview.md) 服務，將內部部署 VMware 虛擬機器複寫至 Azure。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-106">This article describes how to replicate on-premises VMware virtual machines to Azure, using the [Azure Site Recovery](site-recovery-overview.md) service in the Azure portal.</span></span>

<span data-ttu-id="f8e9e-107">如果您要將 VMware VM 移轉至 Azure (僅容錯移轉)，請參閱[這篇文章](site-recovery-migrate-to-azure.md)以便深入了解。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-107">If you want to migrate VMware VMs to Azure (failover only), read [this article](site-recovery-migrate-to-azure.md) to learn more.</span></span>

<span data-ttu-id="f8e9e-108">請在本文下方或 [Azure 復原服務論壇](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)上張貼意見或問題。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-108">Post comments and questions at the bottom of this article, or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>

## <a name="deployment-steps"></a><span data-ttu-id="f8e9e-109">部署步驟</span><span class="sxs-lookup"><span data-stu-id="f8e9e-109">Deployment steps</span></span>

<span data-ttu-id="f8e9e-110">以下是您需要採取的動作：</span><span class="sxs-lookup"><span data-stu-id="f8e9e-110">Here's what you need to do:</span></span>

1. <span data-ttu-id="f8e9e-111">確認必要條件和限制。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-111">Verify prerequisites and limitations.</span></span>
2. <span data-ttu-id="f8e9e-112">設定 Azure 網路和儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-112">Set up Azure network and storage accounts.</span></span>
3. <span data-ttu-id="f8e9e-113">準備您要部署為設定伺服器的內部部署電腦。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-113">Prepare the on-premises machine that you want to deploy as the configuration server.</span></span>
4. <span data-ttu-id="f8e9e-114">準備要用於自動探索 VM 和選擇性地用於推入安裝行動服務的 VMware 帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-114">Prepare VMware accounts to be used for automatic discovery of VMs, and optionally for push installation of the Mobility service.</span></span>
4. <span data-ttu-id="f8e9e-115">建立復原服務保存庫。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-115">Create a Recovery Services vault.</span></span> <span data-ttu-id="f8e9e-116">保存庫包含組態設定，並協調複寫。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-116">The vault contains configuration settings, and orchestrates replication.</span></span>
5. <span data-ttu-id="f8e9e-117">指定來源、目標和複寫設定。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-117">Specify source, target, and replication settings.</span></span>
6. <span data-ttu-id="f8e9e-118">將行動服務部署在您想要複寫的 VM 上。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-118">Deploy the Mobility service on VMs you want to replicate.</span></span>
7. <span data-ttu-id="f8e9e-119">啟用 VM 複寫。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-119">Enable replication for the VMs.</span></span>
7. <span data-ttu-id="f8e9e-120">執行測試容錯移轉，確定一切都沒問題。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-120">Run a test failover to make sure everything's working as expected.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="f8e9e-121">必要條件</span><span class="sxs-lookup"><span data-stu-id="f8e9e-121">Prerequisites</span></span>

<span data-ttu-id="f8e9e-122">**支援需求**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-122">**Support requirement**</span></span> | <span data-ttu-id="f8e9e-123">**詳細資料**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-123">**Details**</span></span>
--- | ---
<span data-ttu-id="f8e9e-124">**Azure**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-124">**Azure**</span></span> | <span data-ttu-id="f8e9e-125">了解 [Azure 需求](site-recovery-prereq.md#azure-requirements)</span><span class="sxs-lookup"><span data-stu-id="f8e9e-125">Learn about [Azure requirements](site-recovery-prereq.md#azure-requirements)</span></span>
<span data-ttu-id="f8e9e-126">**內部部署組態伺服器**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-126">**On-premises configuration server**</span></span> | <span data-ttu-id="f8e9e-127">您需要有執行 Windows Server 2012 R2 或更新版本的 VMware VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-127">You need a VMware VM running Windows Server 2012 R2 or later.</span></span> <span data-ttu-id="f8e9e-128">您在 Site Recovery 部署期間設定此伺服器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-128">You set up this server during Site Recovery deployment.</span></span><br/><br/> <span data-ttu-id="f8e9e-129">根據預設，處理序伺服器與主要目標伺服器也會安裝在此 VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-129">By default the process server and master target server are also installed on this VM.</span></span> <span data-ttu-id="f8e9e-130">當您相應增加時，可能需要不同的處理序伺服器，它的需求與組態伺服器相同。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-130">When you scale up, you might need a separate process server, and it has the same requirements as the configuration server.</span></span><br/><br/> <span data-ttu-id="f8e9e-131">在[這裡](site-recovery-set-up-vmware-to-azure.md#configuration-server-minimum-requirements)深入了解這些元件</span><span class="sxs-lookup"><span data-stu-id="f8e9e-131">Learn more about these components [here](site-recovery-set-up-vmware-to-azure.md#configuration-server-minimum-requirements)</span></span>
<span data-ttu-id="f8e9e-132">**內部部署 VMware 伺服器**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-132">**On-premises VMware servers**</span></span> | <span data-ttu-id="f8e9e-133">一個或多個 VMware vSphere 伺服器 (執行具有最新更新的 6.0、5.5 或 5.1)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-133">One or more VMware vSphere servers, running 6.0, 5.5, 5.1 with latest updates.</span></span> <span data-ttu-id="f8e9e-134">這些伺服器應該位在與設定伺服器 (或另一台處理序伺服器) 相同的網路。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-134">Servers should be located in the same network as the configuration server (or separate process server).</span></span><br/><br/> <span data-ttu-id="f8e9e-135">建議您使用 vCenter 伺服器 (執行具有最新更新的 6.0 或 5.5) 來管理主機。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-135">We recommend a vCenter server to manage hosts, running 6.0 or 5.5 with the latest updates.</span></span> <span data-ttu-id="f8e9e-136">當您部署 6.0 版時，僅支援 5.5 中可用的功能。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-136">Only features that are available in 5.5 are supported when you deploy version 6.0.</span></span>
<span data-ttu-id="f8e9e-137">**內部部署 VM**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-137">**On-premises VMs**</span></span> | <span data-ttu-id="f8e9e-138">您想要複寫的 VM 應該執行[支援的作業系統](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions)，也要符合 [Azure 必要條件](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-138">VMs you want to replicate should be running a [supported operating system](site-recovery-support-matrix-to-azure.md#support-for-replicated-machine-os-versions), and conform with [Azure prerequisites](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements).</span></span> <span data-ttu-id="f8e9e-139">VM 應該執行 VMware 工具。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-139">VM should have VMware tools running.</span></span>
<span data-ttu-id="f8e9e-140">**URL**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-140">**URLs**</span></span> | <span data-ttu-id="f8e9e-141">設定伺服器需要存取這些 URL：</span><span class="sxs-lookup"><span data-stu-id="f8e9e-141">The configuration server needs access to these URLs:</span></span><br/><br/> [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]<br/><br/> <span data-ttu-id="f8e9e-142">如果您有以 IP 位址為基礎的防火牆規則，請確定這些規則允許對 Azure 的通訊。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-142">If you have IP address-based firewall rules, ensure they allow communication to Azure.</span></span><br/></br> <span data-ttu-id="f8e9e-143">允許 [Azure 資料中心 IP 範圍](https://www.microsoft.com/download/confirmation.aspx?id=41653)和 HTTPS (443) 連接埠。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-143">Allow the [Azure Datacenter IP Ranges](https://www.microsoft.com/download/confirmation.aspx?id=41653), and the HTTPS (443) port.</span></span><br/></br> <span data-ttu-id="f8e9e-144">允許訂用帳戶的 Azure 區域和美國西部使用 IP 位址範圍 (用於存取控制和身分識別管理)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-144">Allow IP address ranges for the Azure region of your subscription, and for West US (used for Access Control and Identity Management).</span></span><br/><br/> <span data-ttu-id="f8e9e-145">允許使用此 URL 下載 MySQL：http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.37-win32.msi</span><span class="sxs-lookup"><span data-stu-id="f8e9e-145">Allow this URL for the MySQL download: http://cdn.mysql.com/archives/mysql-5.5/mysql-5.5.37-win32.msi.</span></span>
<span data-ttu-id="f8e9e-146">**行動服務**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-146">**Mobility service**</span></span> | <span data-ttu-id="f8e9e-147">安裝在每個複寫的 VM 上。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-147">Installed on every replicated VM.</span></span>




## <a name="limitations"></a><span data-ttu-id="f8e9e-148">限制</span><span class="sxs-lookup"><span data-stu-id="f8e9e-148">Limitations</span></span>

<span data-ttu-id="f8e9e-149">**限制**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-149">**Limitation**</span></span> | <span data-ttu-id="f8e9e-150">**詳細資料**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-150">**Details**</span></span>
--- | ---
<span data-ttu-id="f8e9e-151">**Azure**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-151">**Azure**</span></span> | <span data-ttu-id="f8e9e-152">儲存體和網路帳戶必須位於與保存庫相同的區域。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-152">Storage and network accounts must be in the same region as the vault</span></span><br/><br/> <span data-ttu-id="f8e9e-153">如果您使用進階儲存體帳戶，則也需要有標準儲存體帳戶來儲存複寫記錄檔</span><span class="sxs-lookup"><span data-stu-id="f8e9e-153">If you use a premium storage account, you also need a standard store account to store replication logs</span></span><br/><br/> <span data-ttu-id="f8e9e-154">您無法複寫到印度中部和南部的進階帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-154">You can't replicate to premium accounts in Central and South India.</span></span>
<span data-ttu-id="f8e9e-155">**內部部署組態伺服器**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-155">**On-premises configuration server**</span></span> | <span data-ttu-id="f8e9e-156">VMware VM 配接器類型應該是 VMXNET3。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-156">VMware VM adapter type should be VMXNET3.</span></span> <span data-ttu-id="f8e9e-157">如果不是，請[安裝此更新](https://kb.vmware.com/selfservice/microsites/search.do?cmd=displayKC&docType=kc&externalId=2110245&sliceId=1&docTypeID=DT_KB_1_1&dialogID=26228401&stateId=1)</span><span class="sxs-lookup"><span data-stu-id="f8e9e-157">If it isn't, [install this update](https://kb.vmware.com/selfservice/microsites/search.do?cmd=displayKC&docType=kc&externalId=2110245&sliceId=1&docTypeID=DT_KB_1_1&dialogID=26228401&stateId=1)</span></span><br/><br/> <span data-ttu-id="f8e9e-158">應該安裝 vSphere PowerCLI 6.0。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-158">vSphere PowerCLI 6.0 should be installed.</span></span><br/><br> <span data-ttu-id="f8e9e-159">電腦不應該是網域控制站。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-159">The machine shouldn't be a domain controller.</span></span> <span data-ttu-id="f8e9e-160">電腦應有靜態 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-160">The machine should have a static IP address.</span></span><br/><br/> <span data-ttu-id="f8e9e-161">主機名稱應該是 15 個字元或更少，而且作業系統應該是英文版。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-161">The host name should be 15 characters or less, and operating system should be in English.</span></span>
<span data-ttu-id="f8e9e-162">**VMware**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-162">**VMware**</span></span> | <span data-ttu-id="f8e9e-163">vCenter 6.0 僅支援 5.5 功能。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-163">Only 5.5 features are supported in vCenter 6.0.</span></span> <span data-ttu-id="f8e9e-164">Site Recovery 不支援新的 vCenter 和 vSphere 6.0 功能，例如跨 vCenter vMotion、虛擬磁碟區和儲存體 DRS。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-164">Site Recovery doesn't support new vCenter and vSphere 6.0 features such as cross vCenter vMotion, virtual volumes, and storage DRS.</span></span>
<span data-ttu-id="f8e9e-165">**VM**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-165">**VMs**</span></span> | <span data-ttu-id="f8e9e-166">確認 [Azure VM 限制](site-recovery-prereq.md#azure-requirements)</span><span class="sxs-lookup"><span data-stu-id="f8e9e-166">Verify [Azure VM limitations](site-recovery-prereq.md#azure-requirements)</span></span><br/><br/> <span data-ttu-id="f8e9e-167">您無法複寫具有加密磁碟的 VM 或具有 UEFI/EFI 開機的 VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-167">You can't replicate VMs with encrypted disks, or VMs with UEFI/EFI boot.</span></span><br/><br> <span data-ttu-id="f8e9e-168">不支援共用磁碟叢集。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-168">Shared disk clusters aren't supported.</span></span> <span data-ttu-id="f8e9e-169">如果來源 VM 有 NIC Teaming，則在容錯移轉之後會轉換成單一 NIC。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-169">If the source VM has NIC teaming, it's converted to a single NIC after failover.</span></span><br/><br/> <span data-ttu-id="f8e9e-170">如果 VM 有 iSCSI 磁碟，Site Recovery 會在容錯移轉之後將它轉換成 VHD 檔案。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-170">If VMs have an iSCSI disk, Site Recovery converts it to a VHD file after failover.</span></span> <span data-ttu-id="f8e9e-171">如果 Azure VM 可觸達 iSCSI 目標，則會連接它，然後同時看見它和 VHD。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-171">If the iSCSI target can be reached by the Azure VM, it connects to it, and sees both it and the VHD.</span></span> <span data-ttu-id="f8e9e-172">如果發生這種情況，請中斷連接 iSCSI 目標。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-172">If this happens, disconnect the iSCSI target.</span></span><br/><br/> <span data-ttu-id="f8e9e-173">如果您想要啟用多 VM 一致性 (這可讓執行相同工作負載的 VM 一起復原到一致的資料點)，請開啟 VM 上的連接埠 20004。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-173">If you want to enable multi-VM consistency, which enables VMs running the same workload to be recovered together to a consistent data point, open port 20004 on the VM.</span></span><br/><br/> <span data-ttu-id="f8e9e-174">Windows 必須安裝在 C 磁碟機。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-174">Windows must be installed on the C drive.</span></span> <span data-ttu-id="f8e9e-175">OS 磁碟應該是基本磁碟，而非動態磁碟。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-175">The OS disk should be basic, and not dynamic.</span></span> <span data-ttu-id="f8e9e-176">資料磁碟可以為動態。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-176">The data disk can be dynamic.</span></span><br/><br/> <span data-ttu-id="f8e9e-177">VM 上的 Linux /etc/hosts 檔案中應該有項目，將本機主機名稱對應至所有網路介面卡相關聯的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-177">Linux /etc/hosts files on VMs should contain entries that map the local host name to IP addresses associated with all network adapters.</span></span> <span data-ttu-id="f8e9e-178">主機名稱、掛接點、裝置名稱、系統路徑和檔案名稱 (/etc; /usr) 只能是英文。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-178">The host name, mount points, device name, system paths, and file names (/etc; /usr) should be in English only.</span></span><br/><br/> <span data-ttu-id="f8e9e-179">支援特定類型的 [Linux 儲存體](site-recovery-support-matrix-to-azure.md#support-for-storage)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-179">Specific types of [Linux storage](site-recovery-support-matrix-to-azure.md#support-for-storage) are supported.</span></span><br/><br/><span data-ttu-id="f8e9e-180">在 VM 設定中建立或設定 **disk.enableUUID=true**。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-180">Create or set **disk.enableUUID=true** in the VM settings.</span></span> <span data-ttu-id="f8e9e-181">這樣可提供一致的 UUID 給 VMDK，以便裝載正確，還可確保在容錯回復期間，只有差異變更會傳輸回到內部部署，而不需要完整複寫。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-181">This provides a consistent UUID to the VMDK, so that it mounts correctly, and ensures that only delta changes are transferred back to on-premises during failback, without full replication.</span></span>

## <a name="set-up-azure"></a><span data-ttu-id="f8e9e-182">設定 Azure</span><span class="sxs-lookup"><span data-stu-id="f8e9e-182">Set up Azure</span></span>

1. <span data-ttu-id="f8e9e-183">[設定 Azure 網路](../virtual-network/virtual-networks-create-vnet-arm-pportal.md)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-183">[Set up an Azure network](../virtual-network/virtual-networks-create-vnet-arm-pportal.md).</span></span>
    - <span data-ttu-id="f8e9e-184">在容錯移轉之後建立的 Azure VM 會置於這個網路。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-184">Azure VMs will be placed in this network when they're created after failover.</span></span>
    - <span data-ttu-id="f8e9e-185">您可以在 [Resource Manager](../resource-manager-deployment-model.md) 或傳統模式中設定網路。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-185">You can set up a network in [Resource Manager](../resource-manager-deployment-model.md), or in classic mode.</span></span>

2. <span data-ttu-id="f8e9e-186">為複寫的資料設定 [Azure 儲存體帳戶](../storage/storage-create-storage-account.md#create-a-storage-account)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-186">Set up an [Azure storage account](../storage/storage-create-storage-account.md#create-a-storage-account) for replicated data.</span></span>
    - <span data-ttu-id="f8e9e-187">此帳戶可以是標準或[進階](../storage/storage-premium-storage.md)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-187">The account can be standard or [premium](../storage/storage-premium-storage.md).</span></span>
    - <span data-ttu-id="f8e9e-188">您可以在 Resource Manager 或傳統模式中設定帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-188">You can set up an account in Resource Manager, or in classic mode.</span></span>

3. <span data-ttu-id="f8e9e-189">在 vCenter 伺服器或 vSphwer 主機上[準備帳戶](#prepare-for-automatic-discovery-and-push-installation)，以便 Site Recovery 可以自動偵測 VMware VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-189">[Prepare an account](#prepare-for-automatic-discovery-and-push-installation) on the vCenter server or vSphere hosts, so that Site Recovery can automatically detect VMware VMs.</span></span>

## <a name="prepare-the-configuration-server"></a><span data-ttu-id="f8e9e-190">準備組態伺服器</span><span class="sxs-lookup"><span data-stu-id="f8e9e-190">Prepare the configuration server</span></span>

1. <span data-ttu-id="f8e9e-191">在 VMware VM 上安裝 Windows Server 2012 R2 或更新版本。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-191">Install Windows Server 2012 R2 or later, on a VMware VM.</span></span>
2. <span data-ttu-id="f8e9e-192">確定 VM 可存取[必要條件](#prerequisites)中列出的 URL。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-192">Make sure the VM has access to the URLs listed in [prerequisites](#prerequisites).</span></span>
3. <span data-ttu-id="f8e9e-193">安裝 [VMware vSphere PowerCLI 6.0](https://my.vmware.com/web/vmware/details?productId=491&downloadGroup=PCLI600R1)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-193">Install [VMware vSphere PowerCLI 6.0](https://my.vmware.com/web/vmware/details?productId=491&downloadGroup=PCLI600R1).</span></span>


## <a name="prepare-for-automatic-discovery-and-push-installation"></a><span data-ttu-id="f8e9e-194">為自動探索和推入安裝做準備</span><span class="sxs-lookup"><span data-stu-id="f8e9e-194">Prepare for automatic discovery and push installation</span></span>

- <span data-ttu-id="f8e9e-195">**準備自動搜索的帳戶**：Site Recovery 處理序伺服器會自動探索 VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-195">**Prepare an account for auto-discovery**: The Site Recovery process server automatically discovers VMs.</span></span> <span data-ttu-id="f8e9e-196">若要這樣做，Site Recovery 需要有可存取 vCenter 伺服器和 vSphere ESXi 主機的認證。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-196">To do this, Site Recovery needs credentials that can access vCenter servers and vSphere ESXi hosts.</span></span>

    1. <span data-ttu-id="f8e9e-197">若要使用專用帳戶，請在 vCenter 層級建立具有這些[權限](#vmware-account-permissions)的角色。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-197">To use a dedicated account, create a role (at the vCenter level, with these [permissions](#vmware-account-permissions).</span></span> <span data-ttu-id="f8e9e-198">指定名稱，例如 **Azure_Site_Recovery**。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-198">Give it a name such as **Azure_Site_Recovery**.</span></span>
    2. <span data-ttu-id="f8e9e-199">然後，在 vSphere 主機/vCenter 伺服器上建立使用者，並將角色指派給該使用者。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-199">Then, create a user on the vSphere host/vCenter server, and assign the role to the user.</span></span> <span data-ttu-id="f8e9e-200">您在 Site Recovery 部署期間指定此使用者帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-200">You specify this user account during Site Recovery deployment.</span></span>

- <span data-ttu-id="f8e9e-201">**準備帳戶來推入行動服務**︰如果您要將行動服務推入 VM，則需要有一個可讓處理序伺服器存取 VM 的帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-201">**Prepare an account to push the Mobility service**: If you want to push the Mobility service to VMs, you need an account that can be used by the process server to access the VM.</span></span> <span data-ttu-id="f8e9e-202">此帳戶僅用於推入安裝。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-202">The account is only used for the push installation.</span></span> <span data-ttu-id="f8e9e-203">您可以使用網域或本機帳戶：</span><span class="sxs-lookup"><span data-stu-id="f8e9e-203">You can use a domain or local account:</span></span>

    - <span data-ttu-id="f8e9e-204">在 Windows 上，如果您不使用網域帳戶，則必須停用本機電腦上的遠端使用者存取控制。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-204">For Windows, if you're not using a domain account, you need to disable Remote User Access control on the local machine.</span></span> <span data-ttu-id="f8e9e-205">若要這樣做，請在登錄的 **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System** 下，新增 DWORD 項目 **LocalAccountTokenFilterPolicy**，值為 1。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-205">To do this, in the register under **HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System**, add the DWORD entry **LocalAccountTokenFilterPolicy**, with a value of 1.</span></span>
    - <span data-ttu-id="f8e9e-206">如果您想要從 CLI 新增適用於 Windows 的登錄項目中，輸入：``REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1.``</span><span class="sxs-lookup"><span data-stu-id="f8e9e-206">If you want to add the registry entry for Windows from a CLI, type:   ``REG ADD HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1.``</span></span>
    - <span data-ttu-id="f8e9e-207">在 Linux 上，帳戶應該是來源 Linux 伺服器上的根使用者。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-207">For Linux, the account should be root on the source Linux server.</span></span>

## <a name="create-a-recovery-services-vault"></a><span data-ttu-id="f8e9e-208">建立復原服務保存庫</span><span class="sxs-lookup"><span data-stu-id="f8e9e-208">Create a Recovery Services vault</span></span>

[!INCLUDE [site-recovery-create-vault](../../includes/site-recovery-create-vault.md)]

## <a name="select-the-protection-goal"></a><span data-ttu-id="f8e9e-209">選取保護目標</span><span class="sxs-lookup"><span data-stu-id="f8e9e-209">Select the protection goal</span></span>

<span data-ttu-id="f8e9e-210">選取您要複寫的項目以及您要複寫到的位置。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-210">Select what you want to replicate, and where you want to replicate to.</span></span>

1. <span data-ttu-id="f8e9e-211">按一下 [復原服務保存庫] > 保存庫。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-211">Click **Recovery Services vaults** > vault.</span></span>
2. <span data-ttu-id="f8e9e-212">在 [資源功能表] 中，按一下 [Site Recovery] > [步驟 1: 準備基礎結構] > [保護目標]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-212">In the Resource Menu, click **Site Recovery** > **Step 1: Prepare Infrastructure** > **Protection goal**.</span></span>

    ![選擇目標](./media/site-recovery-vmware-to-azure/choose-goals.png)
3. <span data-ttu-id="f8e9e-214">在 [保護目標] 中選取 [至 Azure] > [是，使用 VMware vSphere Hypervisor]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-214">In **Protection goal**, select **To Azure** > **Yes, with VMware vSphere Hypervisor**.</span></span>

    ![選擇目標](./media/site-recovery-vmware-to-azure/choose-goals2.png)

## <a name="set-up-the-source-environment"></a><span data-ttu-id="f8e9e-216">設定來源環境</span><span class="sxs-lookup"><span data-stu-id="f8e9e-216">Set up the source environment</span></span>

<span data-ttu-id="f8e9e-217">安裝設定伺服器、註冊在保存庫及探索 VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-217">Set up the configuration server, register it in the vault, and discover VMs.</span></span>

1. <span data-ttu-id="f8e9e-218">按一下 [Site Recovery] > [步驟 1: 準備基礎結構] > [來源]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-218">Click **Site Recovery** > **Step 1: Prepare Infrastructure** > **Source**.</span></span>
2. <span data-ttu-id="f8e9e-219">如果您沒有設定伺服器，請按一下 [+設定伺服器]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-219">If you don’t have a configuration server, click **+Configuration server**.</span></span>

    ![設定來源](./media/site-recovery-vmware-to-azure/set-source1.png)
3. <span data-ttu-id="f8e9e-221">在 [新增伺服器] 中，檢查 [設定伺服器] 是否出現在 [伺服器類型] 中。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-221">In **Add Server**, check that **Configuration Server** appears in **Server type**.</span></span>
4. <span data-ttu-id="f8e9e-222">下載 Site Recovery 統一安裝的安裝檔案。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-222">Download the Site Recovery Unified Setup installation file.</span></span>
5. <span data-ttu-id="f8e9e-223">下載保存庫註冊金鑰。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-223">Download the vault registration key.</span></span> <span data-ttu-id="f8e9e-224">您會在執行統一安裝時用到此金鑰。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-224">You need this when you run Unified Setup.</span></span> <span data-ttu-id="f8e9e-225">該金鑰在產生後會維持 5 天有效。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-225">The key is valid for five days after you generate it.</span></span>

   ![設定來源](./media/site-recovery-vmware-to-azure/set-source2.png)


## <a name="run-site-recovery-unified-setup"></a><span data-ttu-id="f8e9e-227">執行 Site Recovery 統一安裝</span><span class="sxs-lookup"><span data-stu-id="f8e9e-227">Run Site Recovery Unified Setup</span></span>

<span data-ttu-id="f8e9e-228">開始之前請先執行下列作業，然後執行統一安裝以安裝組態伺服器、處理序伺服器與主要目標伺服器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-228">Do the following before you start, then run Unified Setup to install the configuration server, the process server, and the master target server.</span></span>
    - <span data-ttu-id="f8e9e-229">透過影片快速建立概念</span><span class="sxs-lookup"><span data-stu-id="f8e9e-229">Get a quick video overview</span></span>

        > [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video1-Source-Infrastructure-Setup/player]

    - <span data-ttu-id="f8e9e-230">在組態伺服器 VM 上，確定系統時鐘與[時間伺服器](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/get-started/windows-time-service/windows-time-service)同步。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-230">On the configuration server VM, make sure that the system clock is synchronized with a [Time Server](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/get-started/windows-time-service/windows-time-service).</span></span> <span data-ttu-id="f8e9e-231">應該相符。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-231">It should match.</span></span> <span data-ttu-id="f8e9e-232">如果快慢誤差 15 分鐘，安裝可能會失敗。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-232">If it's 15 minutes in front or behind, setup might fail.</span></span>
    - <span data-ttu-id="f8e9e-233">在設定伺服器 VM 上以本機系統管理員身分執行安裝程式。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-233">Run setup as a Local Administrator on the configuration server VM.</span></span>
    - <span data-ttu-id="f8e9e-234">確定 VM 上已啟用 TLS 1.0</span><span class="sxs-lookup"><span data-stu-id="f8e9e-234">Make sure TLS 1.0 is enabled on the VM.</span></span>


[!INCLUDE [site-recovery-add-configuration-server](../../includes/site-recovery-add-configuration-server.md)]

> [!NOTE]
> <span data-ttu-id="f8e9e-235">您也可以[從命令列](http://aka.ms/installconfigsrv)安裝組態伺服器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-235">The configuration server can also be installed [from the command line](http://aka.ms/installconfigsrv).</span></span>



### <a name="add-the-account-for-automatic-discovery"></a><span data-ttu-id="f8e9e-236">新增用於自動探索的帳戶</span><span class="sxs-lookup"><span data-stu-id="f8e9e-236">Add the account for automatic discovery</span></span>

[!INCLUDE [site-recovery-add-vcenter-account](../../includes/site-recovery-add-vcenter-account.md)]

### <a name="connect-to-vmware-servers"></a><span data-ttu-id="f8e9e-237">連接至 VMware 伺服器</span><span class="sxs-lookup"><span data-stu-id="f8e9e-237">Connect to VMware servers</span></span>

<span data-ttu-id="f8e9e-238">連接至 vSphere ESXi 主機或 vCenter 伺服器以探索 VMware VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-238">Connect to vSphere ESXi hosts or vCenter servers, to discover VMware VMs.</span></span>

- <span data-ttu-id="f8e9e-239">如果您在伺服器上使用沒有管理員權限的帳戶來新增 vCenter 伺服器或 vSphere 主機，該帳戶必須啟用這些權限︰</span><span class="sxs-lookup"><span data-stu-id="f8e9e-239">If you add the vCenter server or vSphere hosts with an account without administrator privileges on the server, the account needs these privileges enabled:</span></span>
    - <span data-ttu-id="f8e9e-240">資料中心、資料存放區、資料夾、主機、網路、資源、虛擬機器、vSphere 分散式交換器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-240">Datacenter, Datastore, Folder, Host, Network, Resource, Virtual machine, vSphere Distributed Switch.</span></span>
    - <span data-ttu-id="f8e9e-241">vCenter 伺服器需要儲存體檢視權限。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-241">The vCenter server needs Storage views permissions.</span></span>
- <span data-ttu-id="f8e9e-242">新增 VMware 伺服器時，可能需要 15 分鐘以上，它們才會出現在入口網站中。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-242">When you add VMware servers, it can take 15 minutes or longer for them to appear in the portal.</span></span>
<span data-ttu-id="f8e9e-243">若要允許 Azure Site Recovery 探索在您內部部署環境中執行的虛擬機器，您必須將 VMware vCenter Server 或 vSphere ESXi 主機與 Site Recovery 連接。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-243">To allow Azure Site Recovery to discover virtual machines running in your on-premises environment, you need to connect your VMware vCenter Server or vSphere ESXi hosts with Site Recovery.</span></span>

<span data-ttu-id="f8e9e-244">選取 [+vCenter] 來開始連接 VMware vCenter Server 或 VMware vSphere ESXi 主機。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-244">Select **+vCenter** to start connecting a VMware vCenter server or a VMware vSphere ESXi host.</span></span>

[!INCLUDE [site-recovery-add-vcenter](../../includes/site-recovery-add-vcenter.md)]

<span data-ttu-id="f8e9e-245">Site Recovery 會使用指定的設定連接至 VMware 伺服器並探索 VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-245">Site Recovery connects to VMware servers using the specified settings, and discovers VMs.</span></span>

## <a name="set-up-the-target"></a><span data-ttu-id="f8e9e-246">設定目標</span><span class="sxs-lookup"><span data-stu-id="f8e9e-246">Set up the target</span></span>

<span data-ttu-id="f8e9e-247">設定目標環境之前，請檢查您有 [Azure 儲存體帳戶和網路](#set-up-azure)</span><span class="sxs-lookup"><span data-stu-id="f8e9e-247">Before you set up the target environment, check you have an [Azure storage account and network](#set-up-azure)</span></span>

1. <span data-ttu-id="f8e9e-248">按一下 [準備基礎結構] > [目標]，然後選取您要使用的 Azure 訂用帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-248">Click **Prepare infrastructure** > **Target**, and select the Azure subscription you want to use.</span></span>
2. <span data-ttu-id="f8e9e-249">指定目標部署模型是以 Resource Manager 為基礎或傳統。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-249">Specify whether your target deployment model is Resource Manager-based, or classic.</span></span>
3. <span data-ttu-id="f8e9e-250">Site Recovery 會檢查您是否有一或多個相容的 Azure 儲存體帳戶和網路。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-250">Site Recovery checks that you have one or more compatible Azure storage accounts and networks.</span></span>

   ![目標](./media/site-recovery-vmware-to-azure/gs-target.png)
4. <span data-ttu-id="f8e9e-252">如果您尚未建立儲存體帳戶或網路，請按一下 [+儲存體帳戶] 或[+網路]，以建立 Resource Manager 帳戶或網路內嵌。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-252">If you haven't created a storage account or network, click **+Storage account** or **+Network**, to create a Resource Manager account or network inline.</span></span>

## <a name="set-up-replication-settings"></a><span data-ttu-id="f8e9e-253">設定複寫設定</span><span class="sxs-lookup"><span data-stu-id="f8e9e-253">Set up replication settings</span></span>

<span data-ttu-id="f8e9e-254">在開始之前，請透過影片快速建立概念︰</span><span class="sxs-lookup"><span data-stu-id="f8e9e-254">Get a quick video overview before you start:</span></span>
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video2-vCenter-Server-Discovery-and-Replication-Policy/player]

1. <span data-ttu-id="f8e9e-255">若要建立新的複寫原則，請按一下 [Site Recovery 基礎結構] > [複寫原則] > [+複寫原則]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-255">To create a new replication policy, click **Site Recovery infrastructure** > **Replication Policies** > **+Replication Policy**.</span></span>
2. <span data-ttu-id="f8e9e-256">在 [建立複寫原則]中，指定原則名稱。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-256">In **Create replication policy**, specify a policy name.</span></span>
3. <span data-ttu-id="f8e9e-257">在 [RPO 臨界值] 中，指定 RPO 限制。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-257">In **RPO threshold**, specify the RPO limit.</span></span> <span data-ttu-id="f8e9e-258">這個值指定資料復原點的建立頻率。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-258">This value specifies how often data recovery points are created.</span></span> <span data-ttu-id="f8e9e-259">連續複寫超過此限制時會產生警示。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-259">An alert is generated if continuous replication exceeds this limit.</span></span>
4. <span data-ttu-id="f8e9e-260">在 [復原點保留] 中，指定每個復原點的保留週期長度 (以小時為單位)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-260">In **Recovery point retention**, specify (in hours) how long the retention window is for each recovery point.</span></span> <span data-ttu-id="f8e9e-261">複寫的 VM 可以還原至一個週期內的任何時間點。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-261">Replicated VMs can be recovered to any point in a window.</span></span> <span data-ttu-id="f8e9e-262">複寫至進階儲存體的電腦支援最長保留 24 小時，標準儲存體則是 72 小時。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-262">Up to 24 hours retention is supported for machines replicated to premium storage, and 72 hours for standard storage.</span></span>
5. <span data-ttu-id="f8e9e-263">在 [應用程式一致快照頻率] 中，指定建立包含應用程式一致快照之復原點的頻率 (以分鐘為單位)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-263">In **App-consistent snapshot frequency**, specify how often (in minutes) recovery points containing application-consistent snapshots will be created.</span></span> <span data-ttu-id="f8e9e-264">按一下 [確定]  以建立原則。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-264">Click **OK** to create the policy.</span></span>

    ![複寫原則](./media/site-recovery-vmware-to-azure/gs-replication2.png)
8. <span data-ttu-id="f8e9e-266">當您建立新的原則時，該原則會自動與組態伺服器產生關聯。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-266">When you create a new policy it's automatically associated with the configuration server.</span></span> <span data-ttu-id="f8e9e-267">依預設會自動建立容錯回復的比對原則。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-267">By default, a matching policy is automatically created for failback.</span></span> <span data-ttu-id="f8e9e-268">例如，如果複寫原則是 **rep-policy**，容錯回復原則便會是 **rep-policy-failback**。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-268">For example, if the replication policy is **rep-policy** then the failback policy will be **rep-policy-failback**.</span></span> <span data-ttu-id="f8e9e-269">從 Azure 起始容錯回復時才會使用此原則。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-269">This policy isn't used until you initiate a failback from Azure.</span></span>  



## <a name="plan-capacity"></a><span data-ttu-id="f8e9e-270">規劃容量</span><span class="sxs-lookup"><span data-stu-id="f8e9e-270">Plan capacity</span></span>

1. <span data-ttu-id="f8e9e-271">您現已設定您的基本基礎結構，您可以思考容量規劃並找出您是否需要額外的資源。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-271">Now that you have your basic infrastructure set up you can think about capacity planning, and figure out whether you need additional resources.</span></span> <span data-ttu-id="f8e9e-272">[深入了解](site-recovery-plan-capacity-vmware.md)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-272">[Learn more](site-recovery-plan-capacity-vmware.md).</span></span>
2. <span data-ttu-id="f8e9e-273">當您完成容量規劃時，請在 [已完成容量計劃了嗎?] 中選取 [是]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-273">When you’re done with capacity planning, select **Yes** in **Have you completed capacity planning?**</span></span>

   ![容量規劃](./media/site-recovery-vmware-to-azure/gs-capacity-planning.png)


## <a name="prepare-vms-for-replication"></a><span data-ttu-id="f8e9e-275">準備 VM 進行複寫</span><span class="sxs-lookup"><span data-stu-id="f8e9e-275">Prepare VMs for replication</span></span>

<span data-ttu-id="f8e9e-276">行動服務必須安裝在您要複寫的所有 VMware VM 上。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-276">The Mobility service must be installed on all VMware VMs that you want to replicate.</span></span> <span data-ttu-id="f8e9e-277">安裝行動服務有許多方式︰</span><span class="sxs-lookup"><span data-stu-id="f8e9e-277">You can install the Mobility service in a number of ways:</span></span>

1. <span data-ttu-id="f8e9e-278">從處理伺服器使用推入安裝來安裝。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-278">Install with a push installation from the process server.</span></span> <span data-ttu-id="f8e9e-279">您需要準備 VM 才能使用這個方法。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-279">You need to prepare VMs to use this method.</span></span>
2. <span data-ttu-id="f8e9e-280">使用 System Center Configuration Manager 或 Azure 自動化 DSC 之類的部署工具來安裝。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-280">Install using deployment tools such as System Center Configuration Manager, or Azure automation DSC.</span></span>
3.  <span data-ttu-id="f8e9e-281">手動安裝。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-281">Install manually.</span></span>

[<span data-ttu-id="f8e9e-282">深入了解</span><span class="sxs-lookup"><span data-stu-id="f8e9e-282">Learn more</span></span>](site-recovery-vmware-to-azure-install-mob-svc.md)


## <a name="enable-replication"></a><span data-ttu-id="f8e9e-283">啟用複寫</span><span class="sxs-lookup"><span data-stu-id="f8e9e-283">Enable replication</span></span>

<span data-ttu-id="f8e9e-284">開始之前：</span><span class="sxs-lookup"><span data-stu-id="f8e9e-284">Before you start:</span></span>

- <span data-ttu-id="f8e9e-285">您的 Azure 使用者帳戶必須具有特定[權限](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines)，才能將新的虛擬機器複寫至 Azure。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-285">Your Azure user account needs to have certain [permissions](site-recovery-role-based-linked-access-control.md#permissions-required-to-enable-replication-for-new-virtual-machines) to enable replication of a new virtual machine to Azure.</span></span>
- <span data-ttu-id="f8e9e-286">當您新增或修改 VM 時，可能需要 15 分鐘或更久，變更才會生效，也才會出現在入口網站中。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-286">When you add or modify VMs, it can take up to 15 minutes or longer for changes to take effect, and for them to appear in the portal.</span></span>
- <span data-ttu-id="f8e9e-287">您可以在 [設定伺服器] > [上次連絡時間] 中，查看上次探索 VM 的時間。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-287">You can check the last discovered time for VMs in **Configuration Servers** > **Last Contact At**.</span></span>
- <span data-ttu-id="f8e9e-288">若要新增 VM 而不等候已排定的探索，請醒目提示設定伺服器 (不要按一下)，然後按一下 [重新整理]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-288">To add VMs without waiting for the scheduled discovery, highlight the configuration server (don’t click it), and click **Refresh**.</span></span>
- <span data-ttu-id="f8e9e-289">如果已準備好 VM 進行推入安裝，當您啟用複寫時，處理序伺服器會自動安裝行動服務。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-289">If a VM is prepared for push installation, the process server automatically installs the Mobility service when you enable replication.</span></span>


### <a name="exclude-disks-from-replication"></a><span data-ttu-id="f8e9e-290">從複寫排除磁碟</span><span class="sxs-lookup"><span data-stu-id="f8e9e-290">Exclude disks from replication</span></span>

<span data-ttu-id="f8e9e-291">依預設會複寫電腦上的所有磁碟。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-291">By default all disks on a machine are replicated.</span></span> <span data-ttu-id="f8e9e-292">您可以從複寫排除磁碟。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-292">You can exclude disks from replication.</span></span> <span data-ttu-id="f8e9e-293">例如，您可能不想要複寫具有暫存資料的磁碟，或是每次機器或應用程式重新啟動時便重新整理的資料 (例如 pagefile.sys 或 SQL Server tempdb)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-293">For example you might not want to replicate disks with temporary data, or data that's refreshed each time a machine or application restarts (for example pagefile.sys or SQL Server tempdb).</span></span>

### <a name="replicate-vms"></a><span data-ttu-id="f8e9e-294">複寫 VM</span><span class="sxs-lookup"><span data-stu-id="f8e9e-294">Replicate VMs</span></span>

<span data-ttu-id="f8e9e-295">在開始之前，請觀看快速的影片概觀</span><span class="sxs-lookup"><span data-stu-id="f8e9e-295">Before you start, watch a quick video overview</span></span>

>[!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video3-Protect-VMware-Virtual-Machines/player]

1. <span data-ttu-id="f8e9e-296">按一下 [步驟 2: 複寫應用程式]  >  [來源]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-296">Click **Step 2: Replicate application** > **Source**.</span></span>
2. <span data-ttu-id="f8e9e-297">在 [來源] 中，選取設定伺服器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-297">In **Source**, select the configuration server.</span></span>
3. <span data-ttu-id="f8e9e-298">在 [機器類型] 中，選取 [虛擬機器]</span><span class="sxs-lookup"><span data-stu-id="f8e9e-298">In **Machine type**, select **Virtual Machines**.</span></span>
4. <span data-ttu-id="f8e9e-299">在 [vCenter/vSphere Hypervisor] 中，選取管理 vSphere 主機的 vCenter 伺服器，或選取主機。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-299">In **vCenter/vSphere Hypervisor**, select the vCenter server that manages the vSphere host, or select the host.</span></span>
5. <span data-ttu-id="f8e9e-300">選取處理序伺服器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-300">Select the process server.</span></span> <span data-ttu-id="f8e9e-301">如果您尚未建立任何額外的處理序伺服器，則這會成為設定伺服器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-301">If you haven't created any additional process servers this will be the configuration server.</span></span> <span data-ttu-id="f8e9e-302">然後按一下 [確定] 。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-302">Then click **OK**.</span></span>

    ![啟用複寫](./media/site-recovery-vmware-to-azure/enable-replication2.png)

6. <span data-ttu-id="f8e9e-304">在 [目標] 中，選取您想要在其中建立容錯移轉 VM 的訂用帳戶和資源群組。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-304">In **Target**, select the subscription and the resource group in which you want to create the failed over VMs.</span></span> <span data-ttu-id="f8e9e-305">選擇您想要在 Azure (傳統或資源管理) 中，針對容錯移轉 VM 使用的部署模型。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-305">Choose the deployment model that you want to use in Azure (classic or resource management), for the failed over VMs.</span></span>


7. <span data-ttu-id="f8e9e-306">選取您要用來複寫資料的 Azure 儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-306">Select the Azure storage account you want to use for replicating data.</span></span> <span data-ttu-id="f8e9e-307">如果您不想要使用已設定的帳戶，您可以建立新的帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-307">If you don't want to use an account you've already set up, you can create a new one.</span></span>

8. <span data-ttu-id="f8e9e-308">選取 Azure VM 在容錯移轉後啟動時所要建立的 Azure 網路和子網路。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-308">Select the Azure network and subnet to which Azure VMs will connect, when they're created after failover.</span></span> <span data-ttu-id="f8e9e-309">選取 [立即設定選取的機器]，將網路設定套用至您選取要進行保護的所有機器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-309">Select **Configure now for selected machines**, to apply the network setting to all machines you select for protection.</span></span> <span data-ttu-id="f8e9e-310">選取 [稍後設定] 以選取每部機器的 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-310">Select **Configure later** to select the Azure network per machine.</span></span> <span data-ttu-id="f8e9e-311">如果您不想使用現有的網路，您可以建立網路。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-311">If you don't want to use an existing network, you can create one.</span></span>

    ![啟用複寫](./media/site-recovery-vmware-to-azure/enable-rep3.png)
9. <span data-ttu-id="f8e9e-313">在 [虛擬機器] > [選取虛擬機器] 中，按一下並選取您要複寫的每部機器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-313">In **Virtual Machines** > **Select virtual machines**, click and select each machine you want to replicate.</span></span> <span data-ttu-id="f8e9e-314">您只能選取可以啟用複寫的機器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-314">You can only select machines for which replication can be enabled.</span></span> <span data-ttu-id="f8e9e-315">然後按一下 [確定] 。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-315">Then click **OK**.</span></span>

    ![啟用複寫](./media/site-recovery-vmware-to-azure/enable-replication5.png)
10. <span data-ttu-id="f8e9e-317">在 [名稱]  > 中，選取處理序伺服器將用來在機器上自動安裝行動服務的帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-317">In **Properties** > **Configure properties**, select the account that will be used by the process server to automatically install the Mobility service on the machine.</span></span>
11. <span data-ttu-id="f8e9e-318">依預設會複寫所有磁碟。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-318">By default all disks are replicated.</span></span> <span data-ttu-id="f8e9e-319">按一下 [所有磁碟]  ，然後將任何您不想要複寫的磁碟取消選取。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-319">Click **All Disks** and clear any disks you don't want to replicate.</span></span> <span data-ttu-id="f8e9e-320">然後按一下 [確定] 。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-320">Then click **OK**.</span></span> <span data-ttu-id="f8e9e-321">您可以稍後再設定其他 VM 屬性。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-321">You can set additional VM properties later.</span></span>

    ![啟用複寫](./media/site-recovery-vmware-to-azure/enable-replication6.png)
11. <span data-ttu-id="f8e9e-323">在 [複寫設定] > [設定複寫設定] 中，確認已選取正確的複寫原則。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-323">In **Replication settings** > **Configure replication settings**, verify that the correct replication policy is selected.</span></span> <span data-ttu-id="f8e9e-324">如果您修改原則，變更會套用至複寫電腦及新的電腦。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-324">If you modify a policy, changes will be applied to replicating machine, and to new machines.</span></span>
12. <span data-ttu-id="f8e9e-325">如果您想要將機器聚集成一個複寫群組，請啟用 [多部 VM 一致性]  ，並指定群組的名稱。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-325">Enable **Multi-VM consistency** if you want to gather machines into a replication group, and specify a name for the group.</span></span> <span data-ttu-id="f8e9e-326">然後按一下 [確定] 。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-326">Then click **OK**.</span></span> <span data-ttu-id="f8e9e-327">請注意：</span><span class="sxs-lookup"><span data-stu-id="f8e9e-327">Note that:</span></span>

    * <span data-ttu-id="f8e9e-328">複寫群組中的電腦會一起複寫，並且在容錯移轉時會有共用的損毀一致和應用程式一致的復原點。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-328">Machines in replication groups replicate together, and have shared crash-consistent and app-consistent recovery points when they fail over.</span></span>
    * <span data-ttu-id="f8e9e-329">我們建議您將 VM 與實體伺服器一起收集，讓它們鏡像您的工作負載。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-329">We recommend that you gather VMs and physical servers together so that they mirror your workloads.</span></span> <span data-ttu-id="f8e9e-330">啟用多部 VM 一致性可能會影響工作負載的效能，應該只用於機器正在執行相同工作負載，且您需要一致性的情況。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-330">Enabling multi-VM consistency can impact workload performance, and should only be used if machines are running the same workload and you need consistency.</span></span>

    ![啟用複寫](./media/site-recovery-vmware-to-azure/enable-replication7.png)
13. <span data-ttu-id="f8e9e-332">按一下 [啟用複寫] 。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-332">Click **Enable Replication**.</span></span> <span data-ttu-id="f8e9e-333">您可以在 [設定]  >  [作業]  >  [Site Recovery 作業] 中，追蹤 [啟用保護] 作業的進度。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-333">You can track progress of the **Enable Protection** job in **Settings** > **Jobs** > **Site Recovery Jobs**.</span></span> <span data-ttu-id="f8e9e-334">執行 [完成保護]  作業之後，機器即準備好進行容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-334">After the **Finalize Protection** job runs the machine is ready for failover.</span></span>

### <a name="view-and-manage-vm-properties"></a><span data-ttu-id="f8e9e-335">檢視及管理 VM 屬性</span><span class="sxs-lookup"><span data-stu-id="f8e9e-335">View and manage VM properties</span></span>

<span data-ttu-id="f8e9e-336">我們建議您確認 VM 屬性，並進行任何需要的變更。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-336">We recommend that you verify the VM properties, and make any changes you need to.</span></span>

1. <span data-ttu-id="f8e9e-337">按一下 [複寫的項目]，然後選取電腦。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-337">Click **Replicated items** >, and select the machine.</span></span> <span data-ttu-id="f8e9e-338">[程式集]  刀鋒視窗會顯示機器設定與狀態的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-338">The **Essentials** blade shows information about machines settings and status.</span></span>
2. <span data-ttu-id="f8e9e-339">在 [屬性] 中，您可以檢視 VM 的複寫和容錯移轉資訊。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-339">In **Properties**, you can view replication and failover information for the VM.</span></span>
3. <span data-ttu-id="f8e9e-340">在 [計算和網路] > [計算屬性] 中，您可以指定 Azure VM 名稱和目標大小。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-340">In **Compute and Network** > **Compute properties**, you can specify the Azure VM name and target size.</span></span> <span data-ttu-id="f8e9e-341">視需要修改名稱以符合 [Azure 需求](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements) 。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-341">Modify the name to comply with [Azure requirements](site-recovery-support-matrix-to-azure.md#failed-over-azure-vm-requirements) if you need to.</span></span>
4. <span data-ttu-id="f8e9e-342">修改目標網路、子網路以及將指派給 Azure VM 的 IP 位址等設定：</span><span class="sxs-lookup"><span data-stu-id="f8e9e-342">Modify settings for the target network, subnet, and IP address that will be assigned to the Azure VM:</span></span>

   - <span data-ttu-id="f8e9e-343">您可以設定目標 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-343">You can set the target IP address.</span></span>

    - <span data-ttu-id="f8e9e-344">如果您未提供地址，則容錯移轉的機器會使用 DHCP。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-344">If you don't provide an address, the failed over machine will use DHCP.</span></span>
    - <span data-ttu-id="f8e9e-345">如果您設定的位址在容錯移轉時無法使用，則容錯移轉會失敗。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-345">If you set an address that isn't available at failover, failover won't work.</span></span>
    - <span data-ttu-id="f8e9e-346">如果相同的目標 IP 位址在測試容錯移轉網路中可用，則此位址可用於測試容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-346">The same target IP address can be used for test failover, if the address is available in the test failover network.</span></span>

   - <span data-ttu-id="f8e9e-347">網路介面卡的數目會視您指定給目標虛擬機器的大小而有所不同：</span><span class="sxs-lookup"><span data-stu-id="f8e9e-347">The number of network adapters is dictated by the size you specify for the target virtual machine:</span></span>

     - <span data-ttu-id="f8e9e-348">如果來源電腦上的網路介面卡數目等於或小於針對目標電腦大小所允許的介面卡數目，則目標將具備與來源相同的介面卡數目。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-348">If the number of network adapters on the source machine is the same as, or less than, the number of adapters allowed for the target machine size, then the target will have the same number of adapters as the source.</span></span>
     - <span data-ttu-id="f8e9e-349">如果來源虛擬機器的介面卡數目超過針對目標大小所允許的數目，則將使用目標大小的最大值。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-349">If the number of adapters for the source virtual machine exceeds the number allowed for the target size, then the target size maximum will be used.</span></span>
     - <span data-ttu-id="f8e9e-350">例如，如果來源機器具有兩張網路介面卡，而目標機器大小支援四張，則目標機器將會有兩張介面卡。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-350">For example, if a source machine has two network adapters and the target machine size supports four, the target machine will have two adapters.</span></span> <span data-ttu-id="f8e9e-351">如果來源機器具有兩張介面卡，但支援的目標大小僅支援一張，則目標機器將只會有一張介面卡。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-351">If the source machine has two adapters but the supported target size only supports one then the target machine will have only one adapter.</span></span>     
   - <span data-ttu-id="f8e9e-352">如果虛擬機器有多張網路介面卡，則全部會連接至相同的網路。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-352">If the virtual machine has multiple network adapters they will all connect to the same network.</span></span>
   - <span data-ttu-id="f8e9e-353">如果虛擬機器具有多個網路介面卡，則清單中顯示的第一個會變成 Azure 虛擬機器中的*預設*網路介面卡。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-353">If the virtual machine has multiple network adapters then the first one shown in the list becomes the *Default* network adapter in the Azure virtual machine.</span></span>
4. <span data-ttu-id="f8e9e-354">在 [磁碟] 中，您可以看見 VM 作業系統和將要複寫的資料磁碟。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-354">In **Disks**, you can see the VM operating system, and the data disks that will be replicated.</span></span>

#### <a name="managed-disks"></a><span data-ttu-id="f8e9e-355">受控磁碟</span><span class="sxs-lookup"><span data-stu-id="f8e9e-355">Managed disks</span></span>

<span data-ttu-id="f8e9e-356">在 [計算和網路] > [計算屬性] 中，如果您想要將受控磁碟連結至您要容錯移轉至 Azure 的電腦上，可以將 VM 的 [使用受控磁碟] 設定為 [是]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-356">In **Compute and Network** > **Compute properties**, you can set "Use managed disks" setting to "Yes" for the VM if you want to attach managed disks to your machine on failover to Azure.</span></span> <span data-ttu-id="f8e9e-357">受控磁碟會管理與 VM 磁碟相關的儲存體帳戶，從而簡化 Azure IaaS VM 的磁碟管理。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-357">Managed disks simplifies disk management for Azure IaaS VMs by managing the storage accounts associated with the VM disks.</span></span> <span data-ttu-id="f8e9e-358">深入了解[受控磁碟。](https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview)</span><span class="sxs-lookup"><span data-stu-id="f8e9e-358">[Learn More about managed disks.](https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview)</span></span>

   - <span data-ttu-id="f8e9e-359">只有容錯移轉至 Azure 的受控磁碟會加以建立並連結至虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-359">Managed disks are created and attached to the virtual machine only on a failover to Azure.</span></span> <span data-ttu-id="f8e9e-360">啟用保護時，內部部署電腦的資料會繼續複寫至儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-360">On enabling protection, data from on-premises machines will continue to replicate to storage accounts.</span></span>  <span data-ttu-id="f8e9e-361">只有使用 Resource Manager 部署模型部署的虛擬機器才能建立受控磁碟。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-361">Managed disks can be created only for virtual machines deployed using the Resource manager deployment model.</span></span>  

   - <span data-ttu-id="f8e9e-362">當您將 [使用受控磁碟] 設定為 [是] 時，只能選取資源群組中 [使用受控磁碟] 設定為 [是] 的可用性設定組。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-362">When you set "Use managed disks" to "Yes", only availability sets in the resource group with "Use managed disks" set to "Yes" would be available for selection.</span></span> <span data-ttu-id="f8e9e-363">這是因為只有當 [使用受控磁碟] 屬性設定為 [是] 時，具有受控磁碟的虛擬機器才能成為可用性設定組的一部分。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-363">This is because virtual machines with managed disks can only be part of availability sets with "Use managed disks" property set to "Yes".</span></span> <span data-ttu-id="f8e9e-364">請確定您建立的可用性設定組，是以容錯移轉時使用受控磁碟的意圖作為基礎設定 [使用受控磁碟] 屬性。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-364">Make sure that you create availability sets with "Use managed disks" property set based on your intent to use managed disks on failover.</span></span>  <span data-ttu-id="f8e9e-365">同樣地，當您將 [使用受控磁碟] 設定為 [否] 時，只能選取資源群組中 [使用受控磁碟] 屬性設定為 [否] 的可用性設定組。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-365">Likewise, when you set "Use managed disks" to "No", only availability sets in the resource group with "Use managed disks" property set to "No" would be available for selection.</span></span> <span data-ttu-id="f8e9e-366">[深入了解受控磁碟和可用性設定組](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability#use-managed-disks-for-vms-in-an-availability-set)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-366">[Learn more about managed disks and availability sets](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/manage-availability#use-managed-disks-for-vms-in-an-availability-set).</span></span>

  > [!NOTE]
  > <span data-ttu-id="f8e9e-367">如果用於複寫的儲存體帳戶在任何時間點透過儲存體服務加密進行加密，在容錯移轉期間建立受控磁碟就會失敗。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-367">If the storage account used for replication was encrypted with Storage Service Encryption at any point in time, creation of managed disks during failover will fail.</span></span> <span data-ttu-id="f8e9e-368">您可以將 [使用受控磁碟] 設定為 [否] 並重試容錯移轉，或將虛擬機器保護停用，並在未於任何時間點啟用儲存體服務加密的儲存體帳戶中加以保護。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-368">You can either set "Use managed disks" to "No" and retry failover or disable protection for the virtual machine and protect it to a storage account which did not have Storage service encryption enabled at any point in time.</span></span>
  > <span data-ttu-id="f8e9e-369">[深入了解儲存體服務加密及受控磁碟](https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview#managed-disks-and-encryption)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-369">[Learn more about Storage service encryption and managed disks](https://docs.microsoft.com/en-us/azure/storage/storage-managed-disks-overview#managed-disks-and-encryption).</span></span>


## <a name="run-a-test-failover"></a><span data-ttu-id="f8e9e-370">執行測試容錯移轉</span><span class="sxs-lookup"><span data-stu-id="f8e9e-370">Run a test failover</span></span>


<span data-ttu-id="f8e9e-371">一切就緒後，執行測試容錯移轉，確定一切如預期般運作。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-371">After you've set everything up, run a test failover to make sure everything's working as expected.</span></span> <span data-ttu-id="f8e9e-372">在開始之前，請透過影片快速建立概念</span><span class="sxs-lookup"><span data-stu-id="f8e9e-372">Get a quick video overview before you start</span></span>
>[!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video4-Recovery-Plan-DR-Drill-and-Failover/player]


1. <span data-ttu-id="f8e9e-373">若要容錯移轉單一機器，請在 [設定]  >  [複寫的項目] 中，按一下 VM > [+測試容錯移轉] 圖示。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-373">To fail over a single machine, in **Settings** > **Replicated Items**, click the VM > **+Test Failover** icon.</span></span>

    ![測試容錯移轉](./media/site-recovery-vmware-to-azure/TestFailover.png)

1. <span data-ttu-id="f8e9e-375">若要容錯移轉復原方案，請在 [設定]  >  [復原方案] 中，以滑鼠右鍵按一下方案 > [測試容錯移轉]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-375">To fail over a recovery plan, in **Settings** > **Recovery Plans**, right-click the plan > **Test Failover**.</span></span> <span data-ttu-id="f8e9e-376">若要建立復原方案，請[遵循這些指示](site-recovery-create-recovery-plans.md)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-376">To create a recovery plan, [follow these instructions](site-recovery-create-recovery-plans.md).</span></span>  

1. <span data-ttu-id="f8e9e-377">在 [測試容錯移轉] 中，選取 Azure VM 在容錯移轉之後要連接的 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-377">In **Test Failover**, select the Azure network to which Azure VMs will be connected after failover occurs.</span></span>

1. <span data-ttu-id="f8e9e-378">按一下 [確定]  即可開始容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-378">Click **OK** to begin the failover.</span></span> <span data-ttu-id="f8e9e-379">您可以按一下 VM 以開啟其屬性，或在保存庫名稱 > [設定]  >  [作業]  >  [Site Recovery 作業] 中的 [測試容錯移轉] 作業上按一下，來追蹤進度。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-379">You can track progress by clicking on the VM to open its properties, or on the **Test Failover** job in vault name > **Settings** > **Jobs** > **Site Recovery jobs**.</span></span>

1. <span data-ttu-id="f8e9e-380">容錯移轉完成之後，您應該也會看到複本 Azure 機器出現在 Azure 入口網站 > [虛擬機器]中。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-380">After the failover completes, you should also be able to see the replica Azure machine appear in the Azure portal > **Virtual Machines**.</span></span> <span data-ttu-id="f8e9e-381">您應該確定 VM 為適當的大小、已連接到適當的網路，而且正在執行中。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-381">You should make sure that the VM is the appropriate size, that it's connected to the appropriate network, and that it's running.</span></span>

1. <span data-ttu-id="f8e9e-382">如果您[已準備好容錯移轉後的連線](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover)，您應該能夠連接到 Azure VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-382">If you [prepared for connections after failover](site-recovery-test-failover-to-azure.md#prepare-to-connect-to-azure-vms-after-failover), you should be able to connect to the Azure VM.</span></span>

1. <span data-ttu-id="f8e9e-383">完成後，在復原方案上按一下 [清除測試容錯移轉]。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-383">Once you're done, click on **Cleanup test failover** on the recovery plan.</span></span> <span data-ttu-id="f8e9e-384">在 [記事] 中，記錄並儲存關於測試容錯移轉的任何觀察。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-384">In **Notes**, record and save any observations associated with the test failover.</span></span> <span data-ttu-id="f8e9e-385">這將刪除在測試容錯移轉期間所建立的 VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-385">This will delete the VMs that were created during test failover.</span></span>

<span data-ttu-id="f8e9e-386">[深入了解](site-recovery-test-failover-to-azure.md)測試容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-386">[Learn more](site-recovery-test-failover-to-azure.md) about test failovers.</span></span>


## <a name="vmware-account-permissions"></a><span data-ttu-id="f8e9e-387">VMware 帳戶權限</span><span class="sxs-lookup"><span data-stu-id="f8e9e-387">VMware account permissions</span></span>

<span data-ttu-id="f8e9e-388">Site Recovery 需要存取 VMware，才能讓處理序伺服器自動探索 VM，以及容錯移轉和容錯回復 VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-388">Site Recovery needs access to VMware for the process server to automatically discover VMs, and for failover and failback of VMs.</span></span>

- <span data-ttu-id="f8e9e-389">**移轉**︰如果您只想將 VMware VM 移轉至 Azure，而且絕不會容錯回復，您可以使用具有唯讀角色的 VMware 帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-389">**Migrate**: If you only want to migrate VMware VMs to Azure, without ever failing them back, you can use a VMware account with a read-only role.</span></span> <span data-ttu-id="f8e9e-390">這種角色可以執行容錯移轉，但不能關閉受保護的來源電腦。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-390">Such a role can run failover, but can't shut down protected source machines.</span></span> <span data-ttu-id="f8e9e-391">移轉時不需要這樣。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-391">This isn't necessary for migration.</span></span>
- <span data-ttu-id="f8e9e-392">**複寫/復原**︰如果您想要部署完整複寫 (複寫、容錯移轉、容錯回復)，則帳戶必須能夠執行建立和移除磁碟、啟動 VM 等作業。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-392">**Replicate/Recover**: If you want to deploy full replication (replicate, failover, failback) the account must be able to run operations such as creating and removing disks, powering on VMs etc.</span></span>
- <span data-ttu-id="f8e9e-393">**自動探索**︰需要至少一個唯讀帳戶。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-393">**Automatic discovery**: At least a read-only account is required.</span></span>


<span data-ttu-id="f8e9e-394">**Task**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-394">**Task**</span></span> | <span data-ttu-id="f8e9e-395">**必要的帳戶/角色**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-395">**Required account/role**</span></span> | <span data-ttu-id="f8e9e-396">**權限**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-396">**Permissions**</span></span> | <span data-ttu-id="f8e9e-397">**詳細資料**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-397">**Details**</span></span>
--- | --- | --- | ---
<span data-ttu-id="f8e9e-398">**處理序伺服器自動探索 VMware VM**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-398">**Process server automatically discovers VMware VMs**</span></span> | <span data-ttu-id="f8e9e-399">您需要至少一個唯讀使用者</span><span class="sxs-lookup"><span data-stu-id="f8e9e-399">You need at least a read-only user</span></span> | <span data-ttu-id="f8e9e-400">資料中心物件 –> 傳播至子物件、role=Read-only</span><span class="sxs-lookup"><span data-stu-id="f8e9e-400">Data Center object –> Propagate to Child Object, role=Read-only</span></span> | <span data-ttu-id="f8e9e-401">在資料中心層級指派的使用者，且能夠存取資料中心內的所有物件。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-401">User assigned at datacenter level, and has access to all the objects in the datacenter.</span></span><br/><br/> <span data-ttu-id="f8e9e-402">如果要限制存取權，請將具備 [傳播至子物件] 權限的 [沒有存取權] 角色指派給子物件 (vSphere 主機、資料存放區、VM 及網路)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-402">To restrict access, assign the **No access** role with the **Propagate to child** object, to the child objects (vSphere hosts, datastores, VMs and networks).</span></span>
<span data-ttu-id="f8e9e-403">**容錯移轉**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-403">**Failover**</span></span> | <span data-ttu-id="f8e9e-404">您需要至少一個唯讀使用者</span><span class="sxs-lookup"><span data-stu-id="f8e9e-404">You need at least a read-only user</span></span> | <span data-ttu-id="f8e9e-405">資料中心物件 –> 傳播至子物件、role=Read-only</span><span class="sxs-lookup"><span data-stu-id="f8e9e-405">Data Center object –> Propagate to Child Object, role=Read-only</span></span> | <span data-ttu-id="f8e9e-406">在資料中心層級指派的使用者，且能夠存取資料中心內的所有物件。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-406">User assigned at datacenter level, and has access to all the objects in the datacenter.</span></span><br/><br/> <span data-ttu-id="f8e9e-407">如果要限制存取權，請將具備 [傳播至子物件] 權限的 [沒有存取權] 角色指派給子物件 (vSphere 主機、資料存放區、VM 及網路)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-407">To restrict access, assign the **No access** role with the **Propagate to child** object to the child objects (vSphere hosts, datastores, VMs and networks).</span></span><br/><br/> <span data-ttu-id="f8e9e-408">適用於移轉用途，而不是完整複寫、容錯移轉、容錯回復。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-408">Useful for migration purposes, but not full replication, failover, failback.</span></span>
<span data-ttu-id="f8e9e-409">**容錯移轉和容錯回復**</span><span class="sxs-lookup"><span data-stu-id="f8e9e-409">**Failover and failback**</span></span> | <span data-ttu-id="f8e9e-410">建議您建立具有必要權限的角色 (Azure_Site_Recovery)，然後將角色指派給 VMware 使用者或群組</span><span class="sxs-lookup"><span data-stu-id="f8e9e-410">We suggest you create a role (Azure_Site_Recovery) with the required permissions, and then assign the role to a VMware user or group</span></span> | <span data-ttu-id="f8e9e-411">資料中心物件 –> 傳播至子物件、role=Azure_Site_Recovery</span><span class="sxs-lookup"><span data-stu-id="f8e9e-411">Data Center object –> Propagate to Child Object, role=Azure_Site_Recovery</span></span><br/><br/> <span data-ttu-id="f8e9e-412">資料存放區 -> 配置空間、瀏覽資料存放區、底層檔案作業、移除檔案、更新虛擬機器檔案</span><span class="sxs-lookup"><span data-stu-id="f8e9e-412">Datastore -> Allocate space, browse datastore, low-level file operations, remove file, update virtual machine files</span></span><br/><br/> <span data-ttu-id="f8e9e-413">網路 -> 網路指派</span><span class="sxs-lookup"><span data-stu-id="f8e9e-413">Network -> Network assign</span></span><br/><br/> <span data-ttu-id="f8e9e-414">資源 -> 指派 VM 至資源集區、移轉已關閉電源的 VM、移轉已開啟電源的 VM</span><span class="sxs-lookup"><span data-stu-id="f8e9e-414">Resource -> Assign VM to resource pool, migrate powered off VM, migrate powered on VM</span></span><br/><br/> <span data-ttu-id="f8e9e-415">工作 -> 建立工作、更新工作</span><span class="sxs-lookup"><span data-stu-id="f8e9e-415">Tasks -> Create task, update task</span></span><br/><br/> <span data-ttu-id="f8e9e-416">虛擬機器 -> 組態</span><span class="sxs-lookup"><span data-stu-id="f8e9e-416">Virtual machine -> Configuration</span></span><br/><br/> <span data-ttu-id="f8e9e-417">虛擬機器 -> 互動 -> 回答問題、裝置連線、設定 CD 媒體、設定磁碟片媒體、電源關閉、電源開啟、VMware 工具安裝</span><span class="sxs-lookup"><span data-stu-id="f8e9e-417">Virtual machine -> Interact -> answer question, device connection, configure CD media, configure floppy media, power off, power on, VMware tools install</span></span><br/><br/> <span data-ttu-id="f8e9e-418">虛擬機器 -> 清查 -> 建立、註冊、取消註冊</span><span class="sxs-lookup"><span data-stu-id="f8e9e-418">Virtual machine -> Inventory -> Create, register, unregister</span></span><br/><br/> <span data-ttu-id="f8e9e-419">虛擬機器 -> 佈建 -> 允許虛擬機器下載、允許虛擬機器檔案上傳</span><span class="sxs-lookup"><span data-stu-id="f8e9e-419">Virtual machine -> Provisioning -> Allow virtual machine download, allow virtual machine files upload</span></span><br/><br/> <span data-ttu-id="f8e9e-420">虛擬機器 -> 快照 -> 移除快照</span><span class="sxs-lookup"><span data-stu-id="f8e9e-420">Virtual machine -> Snapshots -> Remove snapshots</span></span> | <span data-ttu-id="f8e9e-421">在資料中心層級指派的使用者，且能夠存取資料中心內的所有物件。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-421">User assigned at datacenter level, and has access to all the objects in the datacenter.</span></span><br/><br/> <span data-ttu-id="f8e9e-422">如果要限制存取權，請將具備 [傳播至子物件] 權限的 [沒有存取權] 角色指派給子物件 (vSphere 主機、資料存放區、VM 及網路)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-422">To restrict access, assign the **No access** role with the **Propagate to child** object, to the child objects (vSphere hosts, datastores, VMs and networks).</span></span>


## <a name="next-steps"></a><span data-ttu-id="f8e9e-423">後續步驟</span><span class="sxs-lookup"><span data-stu-id="f8e9e-423">Next steps</span></span>

<span data-ttu-id="f8e9e-424">複寫開始正常執行之後，運作中斷時就會容錯移轉至 Azure，而且會從複寫的資料建立 Azure VM。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-424">After you get replication up and running, when an outage occurs you fail over to Azure, and Azure VMs are created from the replicated data.</span></span> <span data-ttu-id="f8e9e-425">然後，您可以在 Azure 中存取工作負載和應用程式，直到恢復正常運作時容錯回復至主要位置。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-425">You can then access workloads and apps in Azure, until you fail back to your primary location when it returns to normal operations.</span></span>

- <span data-ttu-id="f8e9e-426">[深入了解](site-recovery-failover.md)不同類型的容錯移轉及如何執行。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-426">[Learn more](site-recovery-failover.md) about different types of failovers, and how to run them.</span></span>
- <span data-ttu-id="f8e9e-427">如果您要移轉電腦而不是複寫和容錯回復，請[深入了解](site-recovery-migrate-to-azure.md#migrate-on-premises-vms-and-physical-servers)。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-427">If you're migrating machines rather than replicating and failing back, [read more](site-recovery-migrate-to-azure.md#migrate-on-premises-vms-and-physical-servers).</span></span>
- <span data-ttu-id="f8e9e-428">[深入了解容錯回復](site-recovery-failback-azure-to-vmware.md)，以便將 Azure VM 容錯回復和複寫回到主要內部部署網站。</span><span class="sxs-lookup"><span data-stu-id="f8e9e-428">[Read about failback](site-recovery-failback-azure-to-vmware.md), to fail back and replicate Azure VMs back to the primary on-premises site.</span></span>

## <a name="third-party-software-notices-and-information"></a><span data-ttu-id="f8e9e-429">第三方廠商軟體注意事項和資訊</span><span class="sxs-lookup"><span data-stu-id="f8e9e-429">Third-party software notices and information</span></span>
<span data-ttu-id="f8e9e-430">Do Not Translate or Localize</span><span class="sxs-lookup"><span data-stu-id="f8e9e-430">Do Not Translate or Localize</span></span>

<span data-ttu-id="f8e9e-431">The software and firmware running in the Microsoft product or service is based on or incorporates material from the projects listed below (collectively, “Third Party Code”).</span><span class="sxs-lookup"><span data-stu-id="f8e9e-431">The software and firmware running in the Microsoft product or service is based on or incorporates material from the projects listed below (collectively, “Third Party Code”).</span></span>  <span data-ttu-id="f8e9e-432">Microsoft is the not original author of the Third Party Code.</span><span class="sxs-lookup"><span data-stu-id="f8e9e-432">Microsoft is the not original author of the Third Party Code.</span></span>  <span data-ttu-id="f8e9e-433">The original copyright notice and license, under which Microsoft received such Third Party Code, are set forth below.</span><span class="sxs-lookup"><span data-stu-id="f8e9e-433">The original copyright notice and license, under which Microsoft received such Third Party Code, are set forth below.</span></span>

<span data-ttu-id="f8e9e-434">The information in Section A is regarding Third Party Code components from the projects listed below.</span><span class="sxs-lookup"><span data-stu-id="f8e9e-434">The information in Section A is regarding Third Party Code components from the projects listed below.</span></span> <span data-ttu-id="f8e9e-435">Such licenses and information are provided for informational purposes only.</span><span class="sxs-lookup"><span data-stu-id="f8e9e-435">Such licenses and information are provided for informational purposes only.</span></span>  <span data-ttu-id="f8e9e-436">This Third Party Code is being relicensed to you by Microsoft under Microsoft's software licensing terms for the Microsoft product or service.</span><span class="sxs-lookup"><span data-stu-id="f8e9e-436">This Third Party Code is being relicensed to you by Microsoft under Microsoft's software licensing terms for the Microsoft product or service.</span></span>  

<span data-ttu-id="f8e9e-437">The information in Section B is regarding Third Party Code components that are being made available to you by Microsoft under the original licensing terms.</span><span class="sxs-lookup"><span data-stu-id="f8e9e-437">The information in Section B is regarding Third Party Code components that are being made available to you by Microsoft under the original licensing terms.</span></span>

<span data-ttu-id="f8e9e-438">The complete file may be found on the [Microsoft Download Center](http://go.microsoft.com/fwlink/?LinkId=529428).</span><span class="sxs-lookup"><span data-stu-id="f8e9e-438">The complete file may be found on the [Microsoft Download Center](http://go.microsoft.com/fwlink/?LinkId=529428).</span></span> <span data-ttu-id="f8e9e-439">Microsoft reserves all rights not expressly granted herein, whether by implication, estoppel or otherwise.</span><span class="sxs-lookup"><span data-stu-id="f8e9e-439">Microsoft reserves all rights not expressly granted herein, whether by implication, estoppel or otherwise.</span></span>
