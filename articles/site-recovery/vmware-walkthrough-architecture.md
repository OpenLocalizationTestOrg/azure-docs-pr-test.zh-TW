---
title: "檢閱將 VMware 複寫至 Azure 的架構 | Microsoft Docs"
description: "本文概述使用 Azure Site Recovery 服務將內部部署 VMware VM 複寫至 Azure 時，所使用的元件和架構"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: c413efcd-d750-4b22-b34b-15bcaa03934a
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/27.017
ms.author: raynew
ms.openlocfilehash: 4aae04a793bab11562c20ceec0e1ae8f1a035a0f
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="step-1-review-the-architecture-for-vmware-replication-to-azure"></a><span data-ttu-id="f1975-103">步驟 1：檢閱將 VMware 複寫至 Azure 的架構</span><span class="sxs-lookup"><span data-stu-id="f1975-103">Step 1: Review the architecture for VMware replication to Azure</span></span>

<span data-ttu-id="f1975-104">本文說明使用 [Azure Site Recovery](site-recovery-overview.md) 服務將內部部署 VMware 虛擬機器複寫至 Azure 時，所使用的元件和程序。</span><span class="sxs-lookup"><span data-stu-id="f1975-104">This article describes the components and processes used when replicating on-premises VMware virtual machines to Azure using the [Azure Site Recovery](site-recovery-overview.md) service.</span></span>

<span data-ttu-id="f1975-105">請在本文下方張貼意見，或在 [Azure 復原服務論壇](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)中提出問題。</span><span class="sxs-lookup"><span data-stu-id="f1975-105">Post any comments at the bottom of this article, or ask questions in the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>


## <a name="architectural-components"></a><span data-ttu-id="f1975-106">架構元件</span><span class="sxs-lookup"><span data-stu-id="f1975-106">Architectural components</span></span>

<span data-ttu-id="f1975-107">下表摘要說明您所需的元件。</span><span class="sxs-lookup"><span data-stu-id="f1975-107">The table summarizes the components you need.</span></span>

<span data-ttu-id="f1975-108">**元件**</span><span class="sxs-lookup"><span data-stu-id="f1975-108">**Component**</span></span> | <span data-ttu-id="f1975-109">**需求**</span><span class="sxs-lookup"><span data-stu-id="f1975-109">**Requirement**</span></span> | <span data-ttu-id="f1975-110">**詳細資料**</span><span class="sxs-lookup"><span data-stu-id="f1975-110">**Details**</span></span>
--- | --- | ---
<span data-ttu-id="f1975-111">**Azure**</span><span class="sxs-lookup"><span data-stu-id="f1975-111">**Azure**</span></span> | <span data-ttu-id="f1975-112">您需要 Azure 訂用帳戶、Azure 儲存體帳戶及 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="f1975-112">You need an Azure subscription, an Azure storage account, and an Azure network.</span></span> | <span data-ttu-id="f1975-113">複寫的資料會儲存在儲存體帳戶中。</span><span class="sxs-lookup"><span data-stu-id="f1975-113">Replicated data is stored in the storage account.</span></span> <span data-ttu-id="f1975-114">從內部部署站台進行容錯移轉時，便會以複寫的資料建立 Azure VM。</span><span class="sxs-lookup"><span data-stu-id="f1975-114">Azure VMs are created with the replicated data when failover from your on-premises site occurs.</span></span> <span data-ttu-id="f1975-115">Azure VM 在建立後會連線到 Azure 虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="f1975-115">The Azure VMs connect to the Azure virtual network when they're created.</span></span>
<span data-ttu-id="f1975-116">**組態伺服器**</span><span class="sxs-lookup"><span data-stu-id="f1975-116">**Configuration server**</span></span> | <span data-ttu-id="f1975-117">執行用於部署之所有內部部署 Site Recovery 元件的單一內部部署管理伺服器 (VMware VM)。</span><span class="sxs-lookup"><span data-stu-id="f1975-117">A single on-premises management server (VMware VM) that runs all the on-premises Site Recovery components for the deployment.</span></span> <span data-ttu-id="f1975-118">這些包括組態伺服器、處理伺服器、主要目標伺服器。</span><span class="sxs-lookup"><span data-stu-id="f1975-118">These include a configuration server, process server, master target server.</span></span> | <span data-ttu-id="f1975-119">組態伺服器元件會協調內部部署與 Azure 之間的通訊，以及管理資料複寫。</span><span class="sxs-lookup"><span data-stu-id="f1975-119">The configuration server component coordinates communications between on-premises and Azure, and manages data replication.</span></span>
 <span data-ttu-id="f1975-120">**處理序伺服器**：</span><span class="sxs-lookup"><span data-stu-id="f1975-120">**Process server**:</span></span>  | <span data-ttu-id="f1975-121">預設會安裝在組態伺服器上。</span><span class="sxs-lookup"><span data-stu-id="f1975-121">Installed by default on the configuration server.</span></span> | <span data-ttu-id="f1975-122">會做為複寫閘道器。</span><span class="sxs-lookup"><span data-stu-id="f1975-122">Acts as a replication gateway.</span></span> <span data-ttu-id="f1975-123">接收複寫資料，以快取、壓縮和加密進行最佳化，然後將複寫資料傳送至 Azure 儲存體。</span><span class="sxs-lookup"><span data-stu-id="f1975-123">Receives replication data, optimizes it with caching, compression, and encryption, and sends it to Azure storage.</span></span><br/><br/> <span data-ttu-id="f1975-124">處理序伺服器還會處理用來保護機器的行動服務的推入安裝，並執行 VMWare VM 的自動探索。</span><span class="sxs-lookup"><span data-stu-id="f1975-124">The process server also handles push installation of the Mobility service to protected machines, and performs automatic discovery of VMware VMs.</span></span><br/><br/> <span data-ttu-id="f1975-125">隨著部署規模擴大，您可以新增更多個別的專用處理序伺服器，以處理日益增加的複寫流量。</span><span class="sxs-lookup"><span data-stu-id="f1975-125">As your deployment grows you can add additional separate dedicated process servers to handle increasing volumes of replication traffic.</span></span>
 <span data-ttu-id="f1975-126">**主要目標伺服器**</span><span class="sxs-lookup"><span data-stu-id="f1975-126">**Master target server**</span></span> | <span data-ttu-id="f1975-127">預設會安裝在內部部署組態伺服器上。</span><span class="sxs-lookup"><span data-stu-id="f1975-127">Installed by default on the on-premises configuration server.</span></span> | <span data-ttu-id="f1975-128">在從 Azure 容錯回復期間，處理複寫資料。</span><span class="sxs-lookup"><span data-stu-id="f1975-128">Handles replication data during failback from Azure.</span></span><br/><br/> <span data-ttu-id="f1975-129">如果容錯回復的流量很高，您可以部署個別的主要目標伺服器來供容錯回復使用。</span><span class="sxs-lookup"><span data-stu-id="f1975-129">If volumes of failback traffic are high, you can deploy a separate master target server for failback.</span></span>
<span data-ttu-id="f1975-130">**VMware 伺服器**</span><span class="sxs-lookup"><span data-stu-id="f1975-130">**VMware servers**</span></span> | <span data-ttu-id="f1975-131">VMware VM 裝載在 vSphere ESXi 伺服器上，我們建議使用 vCenter 伺服器來管理主機。</span><span class="sxs-lookup"><span data-stu-id="f1975-131">VMware VMs are hosted on vSphere ESXi servers, and we recommend a vCenter server to manage the hosts.</span></span> | <span data-ttu-id="f1975-132">您可以將 VMware 伺服器新增至您的復原服務保存庫。</span><span class="sxs-lookup"><span data-stu-id="f1975-132">You add VMware servers to your Recovery Services vault.</span></span>
<span data-ttu-id="f1975-133">**複寫的機器**</span><span class="sxs-lookup"><span data-stu-id="f1975-133">**Replicated machines**</span></span> | <span data-ttu-id="f1975-134">行動服務將會安裝在您複寫的每部 VMware VM 上。</span><span class="sxs-lookup"><span data-stu-id="f1975-134">The Mobility service will be installed on each VMware VM you replicate.</span></span> <span data-ttu-id="f1975-135">您可以手動將它安裝在每部電腦上，或是從處理序伺服器進行推入安裝。</span><span class="sxs-lookup"><span data-stu-id="f1975-135">It can be installed manually on each machine, or with a push installation from the process server.</span></span>

<span data-ttu-id="f1975-136">**圖 1：VMware 到 Azure 的元件**</span><span class="sxs-lookup"><span data-stu-id="f1975-136">**Figure 1: VMware to Azure components**</span></span>

![元件](./media/vmware-walkthrough-architecture/arch-enhanced.png)

## <a name="replication-process"></a><span data-ttu-id="f1975-138">複寫程序</span><span class="sxs-lookup"><span data-stu-id="f1975-138">Replication process</span></span>

1. <span data-ttu-id="f1975-139">您需設定部署，包括內部部署和 Azure 元件。</span><span class="sxs-lookup"><span data-stu-id="f1975-139">You set up the deployment, including on-premises and Azure components.</span></span> <span data-ttu-id="f1975-140">在 Recovery Services 保存庫中，您需指定複寫來源和目標、設定組態伺服器、建立複寫原則、部署行動服務、啟用複寫，以及執行測試容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="f1975-140">In the Recovery Services vault, you specify the replication source and target, set up the configuration server, create a replication policy, deploy the Mobility service, enable replication, and run a test failover.</span></span>
2. <span data-ttu-id="f1975-141">機器會根據複寫原則進行複寫，並將資料的初始複本複寫到 Azure 儲存體。</span><span class="sxs-lookup"><span data-stu-id="f1975-141">Machines replicate in accordance with the replication policy, and an initial copy of the data is replicated to Azure storage.</span></span>
3. <span data-ttu-id="f1975-142">初始複寫完成之後，就會開始將差異變更複寫到 Azure。</span><span class="sxs-lookup"><span data-stu-id="f1975-142">After initial replication finishes, replication of delta changes to Azure begins.</span></span> <span data-ttu-id="f1975-143">機器的追蹤變更會保存在 .hrl 檔案中。</span><span class="sxs-lookup"><span data-stu-id="f1975-143">Tracked changes for a machine are held in a .hrl file.</span></span>
    - <span data-ttu-id="f1975-144">複寫機器會在輸入連接埠 HTTPS 443 上與組態伺服器進行通訊，以管理複寫。</span><span class="sxs-lookup"><span data-stu-id="f1975-144">Replicating machines communicate with the configuration server on port HTTPS 443 inbound, for replication management.</span></span>
    - <span data-ttu-id="f1975-145">複寫機器會透過輸入連接埠 HTTPS 9443 (可修改) 將複寫資料傳送到處理伺服器。</span><span class="sxs-lookup"><span data-stu-id="f1975-145">Replicating machines send replication data to the process server on port HTTPS 9443 inbound (can be modified).</span></span>
    - <span data-ttu-id="f1975-146">組態伺服器會透過輸出連接埠 HTTPS 443 與 Azure 協調複寫管理。</span><span class="sxs-lookup"><span data-stu-id="f1975-146">The configuration server orchestrates replication management with Azure over port HTTPS 443 outbound.</span></span>
    - <span data-ttu-id="f1975-147">處理序伺服器會透過輸出連接埠 443，接收來源機器所傳來的資料、將其最佳化並加密，再將它傳送至 Azure 儲存體。</span><span class="sxs-lookup"><span data-stu-id="f1975-147">The process server receives data from source machines, optimizes and encrypts it, and sends it to Azure storage over port 443 outbound.</span></span>
    - <span data-ttu-id="f1975-148">如果您啟用多部 VM 一致性，則複寫群組中的機器會透過連接埠 20004 彼此通訊。</span><span class="sxs-lookup"><span data-stu-id="f1975-148">If you enable multi-VM consistency, then machines in the replication group communicate with each other over port 20004.</span></span> <span data-ttu-id="f1975-149">如果您將多部機器群組為幾個共用當機時保持一致復原點和應用程式一致復原點的複寫群組，當這些群組在進行容錯移轉時，便會使用多部 VM。</span><span class="sxs-lookup"><span data-stu-id="f1975-149">Multi-VM is used if you group multiple machines into replication groups that share crash-consistent and app-consistent recovery points when they fail over.</span></span> <span data-ttu-id="f1975-150">如果機器執行的是相同的工作負載，且需要保持一致，此功能就很實用。</span><span class="sxs-lookup"><span data-stu-id="f1975-150">This is useful if machines are running the same workload and need to be consistent.</span></span>
4. <span data-ttu-id="f1975-151">流量透過網際網路複寫到 Azure 儲存體的公用端點。</span><span class="sxs-lookup"><span data-stu-id="f1975-151">Traffic is replicated to Azure storage public endpoints, over the internet.</span></span> <span data-ttu-id="f1975-152">或者，您可以使用 Azure ExpressRoute [公用對等](../expressroute/expressroute-circuit-peerings.md#public-peering)。</span><span class="sxs-lookup"><span data-stu-id="f1975-152">Alternately, you can use Azure ExpressRoute [public peering](../expressroute/expressroute-circuit-peerings.md#public-peering).</span></span> <span data-ttu-id="f1975-153">不支援從內部部署網站透過站台對站台 VPN 將流量複寫至 Azure。</span><span class="sxs-lookup"><span data-stu-id="f1975-153">Replicating traffic over a site-to-site VPN from an on-premises site to Azure isn't supported.</span></span>


<span data-ttu-id="f1975-154">**圖 2：VMware 到 Azure 的複寫**</span><span class="sxs-lookup"><span data-stu-id="f1975-154">**Figure 2: VMware to Azure replication**</span></span>

![增強](./media/vmware-walkthrough-architecture/v2a-architecture-henry.png)

## <a name="failover-and-failback-process"></a><span data-ttu-id="f1975-156">容錯移轉和容錯回復程序</span><span class="sxs-lookup"><span data-stu-id="f1975-156">Failover and failback process</span></span>

1. <span data-ttu-id="f1975-157">確認測試容錯移轉如預期般運作之後，您可以視需要執行至 Azure 的未計劃容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="f1975-157">After you verify that test failover is working as expected, you can run unplanned failovers to Azure as required.</span></span> <span data-ttu-id="f1975-158">不支援有計劃的容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="f1975-158">Planned failover isn't supported.</span></span>
2. <span data-ttu-id="f1975-159">您可以容錯移轉單一機器，或建立[復原計劃](site-recovery-create-recovery-plans.md)，來容錯移轉多部 VM。</span><span class="sxs-lookup"><span data-stu-id="f1975-159">You can fail over a single machine, or create [recovery plans](site-recovery-create-recovery-plans.md), to fail over multiple VMs.</span></span>
3. <span data-ttu-id="f1975-160">當您執行容錯移轉時，會在 Azure 中建立複本 VM。</span><span class="sxs-lookup"><span data-stu-id="f1975-160">When you run a failover, replica VMs are created in Azure.</span></span> <span data-ttu-id="f1975-161">您要認可讓容錯移轉開始存取來自複本 Azure VM 的工作負載。</span><span class="sxs-lookup"><span data-stu-id="f1975-161">You commit a failover to start accessing the workload from the replica Azure VM.</span></span>
4. <span data-ttu-id="f1975-162">當主要的內部部署網站恢復可用狀態時，您就可以容錯回復。</span><span class="sxs-lookup"><span data-stu-id="f1975-162">When your primary on-premises site is available again, you can fail back.</span></span> <span data-ttu-id="f1975-163">您要設定容錯回復基礎結構、開始將機器從次要網站複寫到主要網站，以及從次要網站執行非計劃性容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="f1975-163">You set up a failback infrastructure, start replicating the machine from the secondary site to the primary, and run an unplanned failover from the secondary site.</span></span> <span data-ttu-id="f1975-164">在認可此容錯移轉後，資料會回到內部部署網站，而您必須再次啟用複寫至 Azure 的功能。</span><span class="sxs-lookup"><span data-stu-id="f1975-164">After you commit this failover, data will be back on-premises, and you need to enable replication to Azure again.</span></span> [<span data-ttu-id="f1975-165">深入了解</span><span class="sxs-lookup"><span data-stu-id="f1975-165">Learn more</span></span>](site-recovery-failback-azure-to-vmware.md)

<span data-ttu-id="f1975-166">容錯回復有以下幾項需求︰</span><span class="sxs-lookup"><span data-stu-id="f1975-166">There are a few failback requirements:</span></span>


- <span data-ttu-id="f1975-167">**Azure 中的暫存處理序伺服器**︰如果您想要在容錯移轉後從 Azure 容錯回復，您必須將 Azure VM 設定為處理序伺服器，以處理來自 Azure 的複寫。</span><span class="sxs-lookup"><span data-stu-id="f1975-167">**Temporary process server in Azure**: If you want to fail back from Azure after failover you'll need to set up an Azure VM configured as a process server, to handle replication from Azure.</span></span> <span data-ttu-id="f1975-168">容錯回復完成後，您可以刪除此 VM。</span><span class="sxs-lookup"><span data-stu-id="f1975-168">You can delete this VM after failback finishes.</span></span>
- <span data-ttu-id="f1975-169">**VPN 連線**：如需容錯回復，您需要設定從 Azure 網路到內部部署網站的 VPN 連線 (或 Azure ExpressRoute)。</span><span class="sxs-lookup"><span data-stu-id="f1975-169">**VPN connection**: For failback you'll need a VPN connection (or Azure ExpressRoute) set up from the Azure network to the on-premises site.</span></span>
- <span data-ttu-id="f1975-170">**個別內部部署主要目標伺服器**︰內部部署主要目標伺服器會處理容錯回復。</span><span class="sxs-lookup"><span data-stu-id="f1975-170">**Separate on-premises master target server**: The on-premises master target server handles failback.</span></span> <span data-ttu-id="f1975-171">主要目標伺服器預設會安裝在管理伺服器上，但如果要容錯回復大量資料，您應該就此目的設定個別的內部部署主要目標伺服器。</span><span class="sxs-lookup"><span data-stu-id="f1975-171">The master target server is installed by default on the management server, but if you're failing back larger volumes of traffic you should set up a separate on-premises master target server for this purpose.</span></span>
- <span data-ttu-id="f1975-172">**容錯回復原則**︰若要複寫回到內部部署網站，您需要容錯回復原則。</span><span class="sxs-lookup"><span data-stu-id="f1975-172">**Failback policy**: To replicate back to your on-premises site, you need a failback policy.</span></span> <span data-ttu-id="f1975-173">此原則會在您建立複寫原則時自動建立。</span><span class="sxs-lookup"><span data-stu-id="f1975-173">This is automatically created when you created your replication policy.</span></span>
- <span data-ttu-id="f1975-174">**VMware 基礎結構**：您必須容錯回復到內部部署 VMware VM。</span><span class="sxs-lookup"><span data-stu-id="f1975-174">**VMware infrastructure**: You must fail back to an on-premises VMware VM.</span></span> <span data-ttu-id="f1975-175">這表示您需要內部部署 VMware 基礎結構，即使是將內部部署實體伺服器複寫到 Azure。</span><span class="sxs-lookup"><span data-stu-id="f1975-175">This means you need an on-premises VMware infrastructure, even if you're replicating on-premises physical servers to Azure.</span></span>

<span data-ttu-id="f1975-176">**圖 3：VMware/實體容錯回復**</span><span class="sxs-lookup"><span data-stu-id="f1975-176">**Figure 3: VMware/physical failback**</span></span>

![容錯回復](./media/vmware-walkthrough-architecture/enhanced-failback.png)


## <a name="next-steps"></a><span data-ttu-id="f1975-178">後續步驟</span><span class="sxs-lookup"><span data-stu-id="f1975-178">Next steps</span></span>

<span data-ttu-id="f1975-179">移至[步驟 2：確認必要條件和限制](vmware-walkthrough-prerequisites.md)</span><span class="sxs-lookup"><span data-stu-id="f1975-179">Go to [Step 2: Verify prerequisites and limitations](vmware-walkthrough-prerequisites.md)</span></span>
