---
title: "在 Azure Site Recovery 中容錯回復 Hyper-v 虛擬機器 | Microsoft Docs"
description: "Azure Site Recovery 可協調虛擬機器和實體伺服器的複寫、容錯移轉及復原作業。 了解從 Azure 容錯回復至內部部署資料中心。"
services: site-recovery
documentationcenter: 
author: rajani-janaki-ram
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 11/22/2017
ms.author: rajanaki
ms.openlocfilehash: fafaf3f55f07741d438a06e58713d57d465b1137
ms.sourcegitcommit: 310748b6d66dc0445e682c8c904ae4c71352fef2
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/28/2017
---
# <a name="failback-in-site-recovery-for-hyper-v-virtual-machines"></a>在 Site Recovery 中容錯回復 Hyper-V 虛擬機器

本文說明如何容錯回復 Site Recovery 所保護的虛擬機器。

## <a name="prerequisites"></a>必要條件
1. 請確定已連線主要網站 VMM 伺服器/Hyper-V 伺服器。
2. 您應該已在虛擬機器上執行**認可**。

## <a name="why-is-there-no-button-called-failback"></a>為什麼沒有一個叫做容錯回復的按鈕？
在入口網站上，沒有一個明確叫做容錯回復的動作。 容錯回復是讓您回到主要網站的一個步驟。 根據定義，容錯移轉是指您將虛擬機器從主要 (內部部署) 網站容錯移轉至復原網站 (Azure)，容錯回復是指您將虛擬機器從復原網站容錯移轉回到主要網站。

當您起始容錯移轉時，刀鋒視窗會讓您知道作業的方向。 如果方向是從 Azure 至內部部署，則為容錯回復。

## <a name="why-is-there-only-a-planned-failover-gesture-to-failback"></a>為什麼容錯回復只有計劃性容錯移轉動作？
Azure 是高可用性環境，您的虛擬機器永遠可用。 錯誤回復是計劃性活動，可讓您決定只要短暫停機，以便工作負載可以在內部部署再次開始執行。 這樣不會遺失資料。 因此，只有計劃性容錯移轉動作可用，它會關閉 Azure 中的 VM、下載最新的變更，並確保不會遺失任何資料。

## <a name="do-i-need-a-process-server-in-azure-to-failback-to-hyper-v"></a>Azure 中是否需要流程伺服器才能容錯回復至 Hyper-v？
否，只有在您要保護 VMware 虛擬機器時，才需要流程伺服器。 保護/容錯回復 Hyper-v 虛擬機器時，不需要部署其他元件。

## <a name="initiate-failback"></a>起始容錯回復
從主要位置容錯移轉至次要位置之後，複寫的虛擬機器就不會受到 Site Recovery 所保護，而次要位置現在會成為使用中位置。 請遵循這些程序，以容錯回復到原始的主要站台。 此程序說明如何針對復原方案執行計劃性容錯移轉。 或者，您可以在 [虛擬機器]  索引標籤上針對單一虛擬機器執行容錯移轉。

1. 選取 [復原方案]  >  *recoveryplan_name*。 按一下 [容錯移轉] **容錯移轉** > **Planned 容錯移轉**中張貼意見或問題。
2. 在 [確認計劃性容錯移轉]**** 頁面上，選擇來源與目標位置。 記下容錯移轉方向。 如果來自主要位置的容錯移轉會如預期般運作，且所有虛擬機器均位於次要位置，則這僅供參考。
3. 如果您正從 Azure 進行容錯回復，請選取 [資料同步處理] 中的設定：

   * **在容錯移轉前同步處理資料 (僅同步處理差異變更)** - 這個選項可將虛擬機器的停機時間縮到最短，因為不需關閉虛擬機器即可進行同步處理。 它具有下列步驟：
     * 階段 1：在 Azure 中取得虛擬機器的快照，並將其複製到內部部署的 HYPER-V 主機。 機器會繼續在 Azure 中執行。
     * 階段 2：關閉 Azure 中的虛擬機器，如此一來，虛擬機器上就不會有任何新的變更。 最後一組差異變更會傳送到內部部署伺服器，並啟動內部部署虛擬機器。

    - **僅在容錯移轉期間同步處理資料 (完整下載)**—如果您已經在 Azure 上長時間執行，請使用這個選項。 這個選項速度比較快，因為我們預期大部分的磁碟已經變更，而且我們不想花時間計算總和檢查碼。 它會下載磁碟。 當內部部署虛擬機器已遭刪除時，它也很有用。

    >[!NOTE]
    >如果您已經執行 Azure 一段時間 (一個月以上) 或已刪除內部部署虛擬機器，則建議您使用這個選項。 這個選項不會執行任何總和檢查碼計算。


4. 如果已針對雲端啟用資料加密，請在 [加密金鑰] 中，選取當您在 VMM 伺服器上安裝提供者期間啟用資料加密時所發出的憑證。
5. 起始容錯移轉。 您可以在 [工作]  索引標籤上追蹤容錯移轉進度。
6. 如果您選取要在容錯移轉前同步處理資料的選項，則在完成初始資料同步處理且您已經準備好關閉 Azure 中的虛擬機器之後，按一下 [作業] > <計劃性容錯移轉作業名稱> > [完成容錯移轉]。 這會將 Azure 機器關機、將最新變更轉送至內部部署虛擬機器，然後啟動內部部署的 VM。
7. 您現在可以登入虛擬機器，來驗證它是否會如預期般出現。
8. 虛擬機器目前處於認可擱置中的狀態。 按一下 [認可]  以認可容錯移轉。
9. 現在為了完成容錯回復，請按一下 [反向複寫]  ，開始保護主要站台中的虛擬機器。

## <a name="failback-to-an-alternate-location"></a>容錯回復到其他位置
如果您已經在 [HYPER-V 站台和 Azure](site-recovery-hyper-v-site-to-azure.md) 之間部署保護，就能夠從 Azure 容錯回復到替代的內部部署位置。 如果您需要設定新的內部部署硬體，這相當實用。 以下是執行此動作的方式。

1. 如果您正在設定新硬體，請在伺服器上安裝 Windows Server 2012 R2 和 Hyper-V 角色。
2. 使用您在原始伺服器上所擁有的相同名稱來建立虛擬網路交換器。
3. 選取 [受保護的項目]  ->  [保護群組]  ->  <ProtectionGroupName>  ->  您想要進行容錯回復的 <VirtualMachineName>，然後選取 [計畫性容錯移轉]。
4. 在 [記事]  select 中張貼意見或問題。
5. 在 [主機名稱] 中，**選取要放置虛擬機器的新 Hyper-V 主機伺服器。
6. 在 [資料同步處理] 中，建議您選取 [容錯移轉之前同步處理資料] 的選項。 這個選項可以將虛擬機器的停機時間降至最低，因為不需關閉虛擬機器即可進行同步處理。 它具有下列功能：

   * 階段 1：在 Azure 中取得虛擬機器的快照，並將其複製到內部部署的 HYPER-V 主機。 機器會繼續在 Azure 中執行。
   * 階段 2：關閉 Azure 中的虛擬機器，如此一來，虛擬機器上就不會有任何新的變更。 最後一組變更會傳送到內部部署伺服器，並啟動內部部署虛擬機器。
7. 按一下勾號以開始容錯移轉 (容錯回復)。
8. 在完成初始同步處理且您已經準備好關閉 Azure 中的虛擬機器之後，按一下 [作業]  > <planned failover job> > 中張貼意見或問題。 這會將 Azure 機器關機、將最新變更傳送到內部部署虛擬機器，然後啟動它。
9. 您可以登入內部部署虛擬機器，確認一切均可正常運作。 然後按一下 [認可]  以完成容錯移轉。
10. 按一下 [反向複寫]  ，開始保護內部部署虛擬機器。

    > [!NOTE]
    > 如果您取消正在「資料同步處理」步驟中的容錯回復作業，內部部署 VM 會變成損毀狀態。 這是因為資料同步處理會將 Azure VM 磁碟中最新的資料複製到內部部署資料磁碟，而在同步處理完成之前，資料可能會處於不一致狀態。 如果內部部署 VM 在取消資料同步處理後開機，則可能無法開機。 重新觸發容錯移轉以完成資料同步處理。

## <a name="time-taken-to-failback"></a>容錯回復花費時間
完成資料同步並啟動虛擬機器所花的時間取決於各種因素。 為了了解所花費的時間，我們會說明資料同步期間發生什麼事。

資料同步會取得虛擬機器磁碟的快照集，並開始逐區塊進行檢查，以及計算其總和檢查碼。 此計算總和檢查碼會傳送至內部部署環境，以與相同區塊的內部部署總和檢查碼進行比較。 如果符合總和檢查碼，則不會轉送資料區塊。 如果不相符，則會將資料區塊轉送至內部部署環境。 此轉送時間取決於可用的頻寬。 總和檢查碼的速度是一分鐘數個 GB。 

若要加速資料下載，您可以設定 MARS 代理程式使用更多執行緒來平行化下載。 請參閱[這裡的文件](https://support.microsoft.com/en-us/help/3056159/how-to-manage-on-premises-to-azure-protection-network-bandwidth-usage)，了解如何在代理程式中變更下載執行緒。


## <a name="next-steps"></a>後續步驟

當您完成容錯回復作業後，**認可**虛擬機器。 認可會刪除 Azure 虛擬機器和其磁碟，並準備要再次保護的 VM。

**認可**之後，您可以起始「反向複寫」。 這樣會將虛擬機器從內部部署移回 Azure 來開始保護。 這只會複寫變更，因為 Azure 中已關閉 VM，因此只會傳送差異變更。
