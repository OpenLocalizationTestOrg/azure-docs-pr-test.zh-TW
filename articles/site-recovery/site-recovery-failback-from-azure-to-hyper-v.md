---
title: "在 Azure Site Recovery 中容錯回復 Hyper-v 虛擬機器 | Microsoft Docs"
description: "Azure Site Recovery 可協調虛擬機器和實體伺服器的複寫、容錯移轉及復原作業。 了解從 Azure 容錯回復至內部部署資料中心。"
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 08/11/2017
ms.author: ruturajd
ms.openlocfilehash: 719fe167c1298d8a48f5906c4e29e5f5825e5aef
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/18/2017
---
# <a name="failback-in-site-recovery-for-hyper-v-virtual-machines"></a><span data-ttu-id="2446d-104">在 Site Recovery 中容錯回復 Hyper-V 虛擬機器</span><span class="sxs-lookup"><span data-stu-id="2446d-104">Failback in Site Recovery for Hyper-V virtual machines</span></span>

<span data-ttu-id="2446d-105">本文說明如何容錯回復 Site Recovery 所保護的虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="2446d-105">This article describes how to failback virtual machines protected by Site Recovery.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="2446d-106">必要條件</span><span class="sxs-lookup"><span data-stu-id="2446d-106">Prerequisites</span></span>
1. <span data-ttu-id="2446d-107">請確定已連線主要網站 VMM 伺服器/Hyper-V 伺服器。</span><span class="sxs-lookup"><span data-stu-id="2446d-107">Ensure that the primary site VMM server/Hyper-V server is connected.</span></span>
2. <span data-ttu-id="2446d-108">您應該已在虛擬機器上執行**認可**。</span><span class="sxs-lookup"><span data-stu-id="2446d-108">You should have performed **Commit** on the virtual machine.</span></span>

## <a name="why-is-there-no-button-called-failback"></a><span data-ttu-id="2446d-109">為什麼沒有一個叫做容錯回復的按鈕？</span><span class="sxs-lookup"><span data-stu-id="2446d-109">Why is there no button called failback?</span></span>
<span data-ttu-id="2446d-110">在入口網站上，沒有一個明確叫做容錯回復的動作。</span><span class="sxs-lookup"><span data-stu-id="2446d-110">On the portal, there is no explicit gesture called failback.</span></span> <span data-ttu-id="2446d-111">容錯回復是讓您回到主要網站的一個步驟。</span><span class="sxs-lookup"><span data-stu-id="2446d-111">Failback is a step where you come back to the primary site.</span></span> <span data-ttu-id="2446d-112">根據定義，容錯移轉是指您將虛擬機器從主要 (內部部署) 網站容錯移轉至復原網站 (Azure)，容錯回復是指您將虛擬機器從復原網站容錯移轉回到主要網站。</span><span class="sxs-lookup"><span data-stu-id="2446d-112">By definition, failover is when you failover the virtual machines from primary(on-premises) site to recovery (Azure), and failback is when you failover the virtual machines from recovery back to primary.</span></span>

<span data-ttu-id="2446d-113">當您起始容錯移轉時，刀鋒視窗會讓您知道作業的方向。</span><span class="sxs-lookup"><span data-stu-id="2446d-113">When you initiate a failover, the blade informs you about the direction of the job.</span></span> <span data-ttu-id="2446d-114">如果方向是從 Azure 至內部部署，則為容錯回復。</span><span class="sxs-lookup"><span data-stu-id="2446d-114">If the direction is from Azure to On-premises, it is a failback.</span></span>

## <a name="why-is-there-only-a-planned-failover-gesture-to-failback"></a><span data-ttu-id="2446d-115">為什麼容錯回復只有計劃性容錯移轉動作？</span><span class="sxs-lookup"><span data-stu-id="2446d-115">Why is there only a planned failover gesture to failback?</span></span>
<span data-ttu-id="2446d-116">Azure 是高可用性環境，虛擬機器永遠可用。</span><span class="sxs-lookup"><span data-stu-id="2446d-116">Azure is a highly available environment and your virtual machines will be always available.</span></span> <span data-ttu-id="2446d-117">錯誤回復是計劃性活動，可讓您決定只要短暫停機，以便工作負載可以在內部部署再次開始執行。</span><span class="sxs-lookup"><span data-stu-id="2446d-117">Failback is a planned activity where you decide to take a small downtime so that the workloads can start running on-premises again.</span></span> <span data-ttu-id="2446d-118">這樣不會遺失資料。</span><span class="sxs-lookup"><span data-stu-id="2446d-118">This expects no data loss.</span></span> <span data-ttu-id="2446d-119">因此，只有計劃性容錯移轉動作可用，它會關閉 Azure 中的 VM、下載最新的變更，並確保不會遺失任何資料。</span><span class="sxs-lookup"><span data-stu-id="2446d-119">Hence only a planned failover gesture is available, that will turn off the VMs in Azure, download the latest changes and ensure there is no data loss.</span></span>

## <a name="initiate-failback"></a><span data-ttu-id="2446d-120">起始容錯回復</span><span class="sxs-lookup"><span data-stu-id="2446d-120">Initiate failback</span></span>
<span data-ttu-id="2446d-121">從主要位置容錯移轉至次要位置之後，複寫的虛擬機器就不會受到 Site Recovery 所保護，而次要位置現在會成為使用中位置。</span><span class="sxs-lookup"><span data-stu-id="2446d-121">After failover from the primary to secondary location, replicated virtual machines aren't protected by Site Recovery, and the secondary location is now acting as the active location.</span></span> <span data-ttu-id="2446d-122">請遵循這些程序，以容錯回復到原始的主要站台。</span><span class="sxs-lookup"><span data-stu-id="2446d-122">Follow these procedures to fail back to the original primary site.</span></span> <span data-ttu-id="2446d-123">此程序說明如何針對復原方案執行計劃性容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2446d-123">This procedure describes how to run a planned failover for a recovery plan.</span></span> <span data-ttu-id="2446d-124">或者，您可以在 [虛擬機器]  索引標籤上針對單一虛擬機器執行容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2446d-124">Alternatively you can run the failover for a single virtual machine on the **Virtual Machines** tab.</span></span>

1. <span data-ttu-id="2446d-125">選取 [復原方案]  >  *recoveryplan_name*。</span><span class="sxs-lookup"><span data-stu-id="2446d-125">Select **Recovery Plans** > *recoveryplan_name*.</span></span> <span data-ttu-id="2446d-126">按一下 [容錯移轉] **容錯移轉** > **Planned 容錯移轉**中張貼意見或問題。</span><span class="sxs-lookup"><span data-stu-id="2446d-126">Click **Failover** > **Planned Failover**.</span></span>
2. <span data-ttu-id="2446d-127">在 [確認計劃性容錯移轉]**** 頁面上，選擇來源與目標位置。</span><span class="sxs-lookup"><span data-stu-id="2446d-127">On the **Confirm Planned Failover **page, choose the source and target locations.</span></span> <span data-ttu-id="2446d-128">記下容錯移轉方向。</span><span class="sxs-lookup"><span data-stu-id="2446d-128">Note the failover direction.</span></span> <span data-ttu-id="2446d-129">如果來自主要位置的容錯移轉會如預期般運作，且所有虛擬機器均位於次要位置，則這僅供參考。</span><span class="sxs-lookup"><span data-stu-id="2446d-129">If the failover from primary worked as expect and all virtual machines are in the secondary location this is for information only.</span></span>
3. <span data-ttu-id="2446d-130">如果您正從 Azure 進行容錯回復，請選取 [資料同步處理] 中的設定：</span><span class="sxs-lookup"><span data-stu-id="2446d-130">If you're failing back from Azure select settings in **Data Synchronization**:</span></span>

   * <span data-ttu-id="2446d-131">**在容錯移轉前同步處理資料 (僅同步處理差異變更)** - 這個選項可將虛擬機器的停機時間縮到最短，因為不需關閉虛擬機器即可進行同步處理。</span><span class="sxs-lookup"><span data-stu-id="2446d-131">**Synchronize data before failover(Synchronize delta changes only)**—This option minimizes downtime for virtual machines as it synchronizes without shutting them down.</span></span> <span data-ttu-id="2446d-132">它具有下列功能：</span><span class="sxs-lookup"><span data-stu-id="2446d-132">It does the following:</span></span>
     * <span data-ttu-id="2446d-133">階段 1：在 Azure 中取得虛擬機器的快照，並將其複製到內部部署的 HYPER-V 主機。</span><span class="sxs-lookup"><span data-stu-id="2446d-133">Phase 1: Takes snapshot of the virtual machine in Azure and copies it to the on-premises Hyper-V host.</span></span> <span data-ttu-id="2446d-134">機器會繼續在 Azure 中執行。</span><span class="sxs-lookup"><span data-stu-id="2446d-134">The machine continues running in Azure.</span></span>
     * <span data-ttu-id="2446d-135">階段 2：關閉 Azure 中的虛擬機器，如此一來，虛擬機器上就不會有任何新的變更。</span><span class="sxs-lookup"><span data-stu-id="2446d-135">Phase 2: Shuts down the virtual machine in Azure so that no new changes occur there.</span></span> <span data-ttu-id="2446d-136">最後一組差異變更會傳送到內部部署伺服器，並啟動內部部署虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="2446d-136">The final set of delta changes are transferred to the on-premises server and the on-premises virtual machine is started up.</span></span>

    - <span data-ttu-id="2446d-137">**僅在容錯移轉期間同步處理資料 (完整下載)**—如果您已經在 Azure 上長時間執行，請使用這個選項。</span><span class="sxs-lookup"><span data-stu-id="2446d-137">**Synchronize data during failover only(full download)**—Use this option if you've been running on Azure for a long time.</span></span> <span data-ttu-id="2446d-138">這個選項速度比較快，因為我們預期大部分的磁碟已經變更，而且我們不想花時間計算總和檢查碼。</span><span class="sxs-lookup"><span data-stu-id="2446d-138">This option is faster because we expect that most of the disk has changed and we don't want to spend time in checksum calculation.</span></span> <span data-ttu-id="2446d-139">它會下載磁碟。</span><span class="sxs-lookup"><span data-stu-id="2446d-139">It performs a download of the disk.</span></span> <span data-ttu-id="2446d-140">當內部部署虛擬機器已遭刪除時，它也很有用。</span><span class="sxs-lookup"><span data-stu-id="2446d-140">It is also useful when the on-prem virtual machine has been deleted.</span></span>

    >[!NOTE]
    ><span data-ttu-id="2446d-141">如果您已經執行 Azure 一段時間 (一個月以上) 或已刪除內部部署虛擬機器，則建議您使用這個選項。這個選項不會執行任何總和檢查碼計算。</span><span class="sxs-lookup"><span data-stu-id="2446d-141">We recommend you use this option if you've been running Azure for a while (a month or more) or the on-prem virtual machine has been deleted.This option doesn't perform any checksum calculations.</span></span>
    >
    >




4. <span data-ttu-id="2446d-142">如果已針對雲端啟用資料加密，請在 [加密金鑰] 中，選取當您在 VMM 伺服器上安裝提供者期間啟用資料加密時所發出的憑證。</span><span class="sxs-lookup"><span data-stu-id="2446d-142">If data encryption is enabled for the cloud, in **Encryption Key** select the certificate that was issued when you enabled data encryption during Provider installation on the VMM server.</span></span>
5. <span data-ttu-id="2446d-143">起始容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2446d-143">Initiate the failover.</span></span> <span data-ttu-id="2446d-144">您可以在 [工作]  索引標籤上追蹤容錯移轉進度。</span><span class="sxs-lookup"><span data-stu-id="2446d-144">You can follow the failover progress on the **Jobs** tab.</span></span>
6. <span data-ttu-id="2446d-145">如果您選取要在容錯移轉前同步處理資料的選項，則在完成初始資料同步處理且您已經準備好關閉 Azure 中的虛擬機器之後，按一下 [作業] > <計劃性容錯移轉作業名稱> > [完成容錯移轉]。</span><span class="sxs-lookup"><span data-stu-id="2446d-145">If you selected the option to synchronize the data before the failover, once the initial data synchronization is complete and you're ready to shut down the virtual machines in Azure, click **Jobs** planned failover job name **Complete Failover**.</span></span> <span data-ttu-id="2446d-146">這會將 Azure 機器關機、將最新變更轉送至內部部署虛擬機器，然後啟動內部部署的 VM。</span><span class="sxs-lookup"><span data-stu-id="2446d-146">This shuts down the Azure machine, transfers the latest changes to the on-premises virtual machine, and starts the VM on-premises.</span></span>
7. <span data-ttu-id="2446d-147">您現在可以登入虛擬機器，來驗證它是否會如預期般出現。</span><span class="sxs-lookup"><span data-stu-id="2446d-147">You can now log onto the virtual machine to validate it's available as expected.</span></span>
8. <span data-ttu-id="2446d-148">虛擬機器目前處於認可擱置中的狀態。</span><span class="sxs-lookup"><span data-stu-id="2446d-148">The virtual machine is in a commit pending state.</span></span> <span data-ttu-id="2446d-149">按一下 [認可]  以認可容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2446d-149">Click **Commit** to commit the failover.</span></span>
9. <span data-ttu-id="2446d-150">現在為了完成容錯回復，請按一下 [反向複寫]  ，開始保護主要站台中的虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="2446d-150">Now in order to complete the failback click **Reverse Replicate** to start protecting the virtual machine in the primary site.</span></span>

## <a name="failback-to-an-alternate-location"></a><span data-ttu-id="2446d-151">容錯回復到其他位置</span><span class="sxs-lookup"><span data-stu-id="2446d-151">Failback to an alternate location</span></span>
<span data-ttu-id="2446d-152">如果您已經在 [HYPER-V 站台和 Azure](site-recovery-hyper-v-site-to-azure.md) 之間部署保護，就能夠從 Azure 容錯回復到替代的內部部署位置。</span><span class="sxs-lookup"><span data-stu-id="2446d-152">If you've deployed protection between a [Hyper-V site and Azure](site-recovery-hyper-v-site-to-azure.md) you have to ability to failback from Azure to an alternate on-premises location.</span></span> <span data-ttu-id="2446d-153">如果您需要設定新的內部部署硬體，這相當實用。</span><span class="sxs-lookup"><span data-stu-id="2446d-153">This is useful if you need to set up new on-premises hardware.</span></span> <span data-ttu-id="2446d-154">以下是執行此動作的方式。</span><span class="sxs-lookup"><span data-stu-id="2446d-154">Here's how you do it.</span></span>

1. <span data-ttu-id="2446d-155">如果您正在設定新硬體，請在伺服器上安裝 Windows Server 2012 R2 和 Hyper-V 角色。</span><span class="sxs-lookup"><span data-stu-id="2446d-155">If you're setting up new hardware install Windows Server 2012 R2 and the Hyper-V role on the server.</span></span>
2. <span data-ttu-id="2446d-156">使用您在原始伺服器上所擁有的相同名稱來建立虛擬網路交換器。</span><span class="sxs-lookup"><span data-stu-id="2446d-156">Create a virtual network switch with the same name that you had on the original server.</span></span>
3. <span data-ttu-id="2446d-157">選取 [受保護的項目]  ->  [保護群組]  ->  <ProtectionGroupName>  ->  您想要進行容錯回復的 <VirtualMachineName>，然後選取 [計畫性容錯移轉]。</span><span class="sxs-lookup"><span data-stu-id="2446d-157">Select **Protected Items** -> **Protection Group** -> <ProtectionGroupName> -> <VirtualMachineName> you want to fail back, and select **Planned Failover**.</span></span>
4. <span data-ttu-id="2446d-158">在 [記事]  select 中張貼意見或問題。</span><span class="sxs-lookup"><span data-stu-id="2446d-158">In **Confirm Planned Failover** select **Create on-premises virtual machine if it does not exist**.</span></span>
5. <span data-ttu-id="2446d-159">在 [主機名稱]  中，選取要放置虛擬機器的新 Hyper-V 主機伺服器。</span><span class="sxs-lookup"><span data-stu-id="2446d-159">In **Host Name** select the new Hyper-V host server on which you want to place the virtual machine.</span></span>
6. <span data-ttu-id="2446d-160">在 [資料同步處理] 中，建議您選取 [容錯移轉之前同步處理資料] 的選項。</span><span class="sxs-lookup"><span data-stu-id="2446d-160">In Data Synchronization we recommend you select  the option **Synchronize the data before the failover**.</span></span> <span data-ttu-id="2446d-161">這個選項可以將虛擬機器的停機時間降至最低，因為不需關閉虛擬機器即可進行同步處理。</span><span class="sxs-lookup"><span data-stu-id="2446d-161">This minimizes downtime for virtual machines as it synchronizes without shutting them down.</span></span> <span data-ttu-id="2446d-162">它具有下列功能：</span><span class="sxs-lookup"><span data-stu-id="2446d-162">It does the following:</span></span>

   * <span data-ttu-id="2446d-163">階段 1：在 Azure 中取得虛擬機器的快照，並將其複製到內部部署的 HYPER-V 主機。</span><span class="sxs-lookup"><span data-stu-id="2446d-163">Phase 1: Takes snapshot of the virtual machine in Azure and copies it to the on-premises Hyper-V host.</span></span> <span data-ttu-id="2446d-164">機器會繼續在 Azure 中執行。</span><span class="sxs-lookup"><span data-stu-id="2446d-164">The machine continues running in Azure.</span></span>
   * <span data-ttu-id="2446d-165">階段 2：關閉 Azure 中的虛擬機器，如此一來，虛擬機器上就不會有任何新的變更。</span><span class="sxs-lookup"><span data-stu-id="2446d-165">Phase 2: Shuts down the virtual machine in Azure so that no new changes occur there.</span></span> <span data-ttu-id="2446d-166">最後一組變更會傳送到內部部署伺服器，並啟動內部部署虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="2446d-166">The final set of changes are transferred to the on-premises server and the on-premises virtual machine is started up.</span></span>
7. <span data-ttu-id="2446d-167">按一下勾號以開始容錯移轉 (容錯回復)。</span><span class="sxs-lookup"><span data-stu-id="2446d-167">Click the checkmark to begin the failover (failback).</span></span>
8. <span data-ttu-id="2446d-168">在完成初始同步處理且您已經準備好關閉 Azure 中的虛擬機器之後，按一下 [作業]  > <planned failover job> > 中張貼意見或問題。</span><span class="sxs-lookup"><span data-stu-id="2446d-168">After the initial synchronization finishes and you're ready to shut down the virtual machine in Azure, click **Jobs** > <planned failover job> > **Complete Failover**.</span></span> <span data-ttu-id="2446d-169">這會將 Azure 機器關機、將最新變更傳送到內部部署虛擬機器，然後啟動它。</span><span class="sxs-lookup"><span data-stu-id="2446d-169">This shuts down the Azure machine, transfers the latest changes to the on-premises virtual machine and starts it.</span></span>
9. <span data-ttu-id="2446d-170">您可以登入內部部署虛擬機器，確認一切均可正常運作。</span><span class="sxs-lookup"><span data-stu-id="2446d-170">You can log onto the on-premises virtual machine to verify everything is working as expected.</span></span> <span data-ttu-id="2446d-171">然後按一下 [認可]  以完成容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="2446d-171">Then click **Commit** to finish the failover.</span></span>
10. <span data-ttu-id="2446d-172">按一下 [反向複寫]  ，開始保護內部部署虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="2446d-172">Click **Reverse Replicate** to start protecting the on-premises virtual machine.</span></span>

    > [!NOTE]
    > <span data-ttu-id="2446d-173">如果您取消正在「資料同步處理」步驟中的容錯回復作業，內部部署 VM 會變成損毀狀態。</span><span class="sxs-lookup"><span data-stu-id="2446d-173">If you cancel the failback job while it is in Data Synchronization step, the on-premises VM will be in a corrupted state.</span></span> <span data-ttu-id="2446d-174">這是因為資料同步處理會將 Azure VM 磁碟中最新的資料複製到內部部署資料磁碟，而在同步處理完成之前，資料可能會處於不一致狀態。</span><span class="sxs-lookup"><span data-stu-id="2446d-174">This is because Data Synchronization copies the latest data from Azure VM disks to the on-prem data disks, and until the synchronization completes, the disk data may not be in a consistent state.</span></span> <span data-ttu-id="2446d-175">如果內部部署 VM 在取消資料同步處理後開機，則可能無法開機。</span><span class="sxs-lookup"><span data-stu-id="2446d-175">If the On-prem VM is booted after Data Synchronization is canceled, it may not boot.</span></span> <span data-ttu-id="2446d-176">重新觸發容錯移轉以完成資料同步處理。</span><span class="sxs-lookup"><span data-stu-id="2446d-176">Re-trigger failover to complete the Data Synchronization.</span></span>
    >
    >



## <a name="next-steps"></a><span data-ttu-id="2446d-177">後續步驟</span><span class="sxs-lookup"><span data-stu-id="2446d-177">Next Steps</span></span>

<span data-ttu-id="2446d-178">當您完成容錯回復作業後，**認可**虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="2446d-178">Once you have completed the failback job, **Commit** the virtual machine.</span></span> <span data-ttu-id="2446d-179">認可會刪除 Azure 虛擬機器和其磁碟，並準備要再次保護的 VM。</span><span class="sxs-lookup"><span data-stu-id="2446d-179">Commit deletes the Azure virtual machine and its disks and prepares the VM to be protected again.</span></span>

<span data-ttu-id="2446d-180">**認可**之後，您可以起始「反向複寫」。</span><span class="sxs-lookup"><span data-stu-id="2446d-180">After **Commit**, you can initiate the *Reverse Replicate*.</span></span> <span data-ttu-id="2446d-181">這樣會將虛擬機器從內部部署移回 Azure 來開始保護。</span><span class="sxs-lookup"><span data-stu-id="2446d-181">This will start protecting the virtual machine from on-premises back to Azure.</span></span> <span data-ttu-id="2446d-182">請注意，這只會複寫變更，因為 Azure 中已關閉 VM，因此只會傳送差異變更。</span><span class="sxs-lookup"><span data-stu-id="2446d-182">Note that this will only replicate the changes since the VM has been turned off in Azure and hence sends differential changes only.</span></span>
