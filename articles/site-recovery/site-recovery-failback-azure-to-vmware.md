---
title: "將 VMware VM 從 Azure 容錯回復到內部部署 | Microsoft Docs"
description: "了解在將 VMware VM 和實體伺服器容錯移轉至 Azure 後，如何將其容錯回復到內部部署網站。"
services: site-recovery
documentationcenter: 
author: ruturaj
manager: mkjain
editor: 
ms.assetid: 5a47337f-89a9-43e8-8fdc-7da373c0fb0f
ms.service: site-recovery
ms.devlang: na
ms.tgt_pltfrm: na
ms.topic: article
ms.workload: storage-backup-recovery
ms.date: 03/27/2017
ms.author: ruturajd
ms.openlocfilehash: dde0bb6b4f6bc10afdd7d40adc6689d42b37de81
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/03/2017
---
# <a name="fail-back-vmware-virtual-machines-and-physical-servers-to-the-on-premises-site"></a><span data-ttu-id="71f6b-103">將 VMWare 虛擬機器和實體伺服器容錯回復至內部部署網站</span><span class="sxs-lookup"><span data-stu-id="71f6b-103">Fail back VMware virtual machines and physical servers to the on-premises site</span></span>


<span data-ttu-id="71f6b-104">本文說明如何將 Azure 虛擬機器從 Azure 容錯回復到內部部署網站。</span><span class="sxs-lookup"><span data-stu-id="71f6b-104">This article describes how to failback Azure virtual machines from Azure to the on-premises site.</span></span> <span data-ttu-id="71f6b-105">當您準備好在使用此[參考](site-recovery-how-to-reprotect.md)重新保護機器後，將 VMware 虛擬機器或 Windows/Linux 實體伺服器容錯回復時，請依照這裡的指示執行。</span><span class="sxs-lookup"><span data-stu-id="71f6b-105">Follow the instructions here when you're ready to fail back your VMware virtual machines or Windows or Linux physical servers after you have re-protected your machines using this [reference](site-recovery-how-to-reprotect.md).</span></span>

>[!NOTE]
><span data-ttu-id="71f6b-106">如果您使用傳統 Azure 入口網站，請參閱[這裡](site-recovery-failback-azure-to-vmware-classic.md)所說的指示來增強 VMware 到 Azure 的架構，若為舊版架構，則請參閱[這裡](site-recovery-failback-azure-to-vmware-classic-legacy.md)</span><span class="sxs-lookup"><span data-stu-id="71f6b-106">If you are using the classic Azure portal, please refer to instructions mentioned [here](site-recovery-failback-azure-to-vmware-classic.md) for enhanced VMware to Azure architecture and [here](site-recovery-failback-azure-to-vmware-classic-legacy.md) for the legacy architecture</span></span>

## <a name="overview"></a><span data-ttu-id="71f6b-107">概觀</span><span class="sxs-lookup"><span data-stu-id="71f6b-107">Overview</span></span>
<span data-ttu-id="71f6b-108">本節中的圖表說明此案例的容錯回復架構。</span><span class="sxs-lookup"><span data-stu-id="71f6b-108">The diagrams in this section show the failback architecture for this scenario.</span></span>

<span data-ttu-id="71f6b-109">當處理伺服器為內部部署，而且您要使用 Azure ExpressRoute 連接時，請使用此架構：</span><span class="sxs-lookup"><span data-stu-id="71f6b-109">When the Process Server is on-premises and you are using an Azure ExpressRoute connection, use this architecture:</span></span>

![Expressroute 的架構圖](./media/site-recovery-failback-azure-to-vmware-classic/architecture.png)

<span data-ttu-id="71f6b-111">當處理伺服器在 Azure 上，而且您有 VPN 或 ExpressRoute 連接時，請使用此架構：</span><span class="sxs-lookup"><span data-stu-id="71f6b-111">When the Process Server is on Azure and you have either a VPN or an ExpressRoute connection, use this architecture:</span></span>

![VPN 的架構圖](./media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)

<span data-ttu-id="71f6b-113">若要查看完整的連接埠清單及容錯回復架構圖，請參閱下面的影像：</span><span class="sxs-lookup"><span data-stu-id="71f6b-113">For a complete list of ports and the failback architecture diagram, refer to the following image:</span></span>

![所有連接埠的容錯移轉-容錯回復清單](./media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

<span data-ttu-id="71f6b-115">在容錯移轉至 Azure 之後，您可以透過三個階段來容錯回復至內部部署網站：</span><span class="sxs-lookup"><span data-stu-id="71f6b-115">After you’ve failed over to Azure, you fail back to your on-premises site in three stages:</span></span>

* <span data-ttu-id="71f6b-116">**階段 1**：重新保護 Azure VM，使其開始複寫回在內部部署網站中執行的 VMware VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-116">**Stage 1**: You reprotect the Azure VMs so that they start replicating back to the VMware VMs that are running on your on-premises site.</span></span>
* <span data-ttu-id="71f6b-117">**階段 2**：Azure VM 複寫到內部部署網站後，就要執行容錯移轉以從 Azure 容錯回復。</span><span class="sxs-lookup"><span data-stu-id="71f6b-117">**Stage 2**: After your Azure VMs are replicated to your on-premises site, you run a failover to fail back from Azure.</span></span>
* <span data-ttu-id="71f6b-118">**階段 3**：容錯回復資料之後，您必須重新保護已容錯回復到的內部部署 VM，使其開始複寫至 Azure。</span><span class="sxs-lookup"><span data-stu-id="71f6b-118">**Stage 3**: After your data has failed back, you reprotect the on-premises VMs that you failed back to, so that they start replicating to Azure.</span></span>

### <a name="fail-back-to-the-original-location-or-an-alternate-location"></a><span data-ttu-id="71f6b-119">容錯回復到原始位置或替代位置</span><span class="sxs-lookup"><span data-stu-id="71f6b-119">Fail back to the original location or an alternate location</span></span>
<span data-ttu-id="71f6b-120">容錯移轉 VMware VM 之後，在它仍存在於內部部署環境的前提下，您可以將它容錯回復到相同的來源 VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-120">After you fail over a VMware VM, you can fail back to the same source VM if it still exists on-premises.</span></span> <span data-ttu-id="71f6b-121">在此案例中，只會容錯回復差異部分。</span><span class="sxs-lookup"><span data-stu-id="71f6b-121">In this scenario, only the deltas are failed back.</span></span>

<span data-ttu-id="71f6b-122">如果您容錯移轉實體伺服器，則一律會容錯回復至新的 VMware VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-122">If you failed over physical servers, failback is always to a new VMware VM.</span></span> <span data-ttu-id="71f6b-123">在容錯回復實體機器之前，請注意：</span><span class="sxs-lookup"><span data-stu-id="71f6b-123">Before failing back a physical machine, note that:</span></span>
* <span data-ttu-id="71f6b-124">當從 Azure 容錯移轉回 VMware 時，受保護的實體機器會回復成虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-124">A protected physical machine will come back as a virtual machine when it is failed over back from Azure to VMware.</span></span> <span data-ttu-id="71f6b-125">Windows Server 2008 R2 SP1 實體機器如果受保護且容錯移轉至 Azure，則無法容錯回復。</span><span class="sxs-lookup"><span data-stu-id="71f6b-125">A Windows Server 2008 R2 SP1 physical machine, if it is protected and failed over to Azure, cannot be failed back.</span></span> <span data-ttu-id="71f6b-126">已啟動為內部部署虛擬機器的 Windows Server 2008 R2 SP1 機器將能夠容錯回復。</span><span class="sxs-lookup"><span data-stu-id="71f6b-126">A Windows Server 2008 R2 SP1 machine that started as a virtual machine on-premises will be able to fail back.</span></span>
* <span data-ttu-id="71f6b-127">請確認您連同需要容錯回復的必要 ESX/ESXi 主機，已探索至少一部主要目標伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-127">Ensure that you discover at least one master target server along with the necessary ESX/ESXi hosts that you need to fail back to.</span></span>

<span data-ttu-id="71f6b-128">如果您要容錯回復到原始 VM，則必須符合下列條件：</span><span class="sxs-lookup"><span data-stu-id="71f6b-128">If you fail back to the original VM, the following are required:</span></span>

* <span data-ttu-id="71f6b-129">如果 VM 是由 vCenter 伺服器管理，主要目標的 ESX 主機應該可以存取 VM 資料存放區。</span><span class="sxs-lookup"><span data-stu-id="71f6b-129">If the VM is managed by a vCenter server, the master target's ESX host should have access to the VMs datastore.</span></span>
* <span data-ttu-id="71f6b-130">如果 VM 位於 ESX 主機上，但不受 vCenter 管理，則 VM 的硬碟必須位於可由主要目標主機存取的資料存放區中。</span><span class="sxs-lookup"><span data-stu-id="71f6b-130">If the VM is on an ESX host but isn’t managed by vCenter, the hard disk of the VM must be in a datastore that's accessible by the MT's host.</span></span>
* <span data-ttu-id="71f6b-131">如果 VM 位於 ESX 主機上，但未使用 vCenter，則應該先完成主要目標 ESX 主機的探索後，才能重新保護。</span><span class="sxs-lookup"><span data-stu-id="71f6b-131">If your VM is on an ESX host and doesn't use vCenter, you should complete discovery of the ESX host of the MT before you reprotect.</span></span> <span data-ttu-id="71f6b-132">如果您要容錯回復實體伺服器，則也適用這一條件。</span><span class="sxs-lookup"><span data-stu-id="71f6b-132">This applies if you're failing back physical servers too.</span></span>
* <span data-ttu-id="71f6b-133">另一個選項 (如果內部部署 VM 存在) 是先將它刪除，然後才執行容錯回復。</span><span class="sxs-lookup"><span data-stu-id="71f6b-133">Another option (if the on-premises VM exists) is to delete it before you do a failback.</span></span> <span data-ttu-id="71f6b-134">接著，容錯回復會在與主要目標 ESX 主機相同的主機上建立新的 VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-134">Failback then creates a new VM on the same host as the master target ESX host.</span></span>

<span data-ttu-id="71f6b-135">當您容錯回復至替代位置時，資料將會復原到內部部署主要目標伺服器所使用的相同資料存放區和相同 ESX 主機上。</span><span class="sxs-lookup"><span data-stu-id="71f6b-135">When you fail back to an alternate location, the data is recovered to the same datastore and the same ESX host as that used by the on-premises master target server.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="71f6b-136">必要條件</span><span class="sxs-lookup"><span data-stu-id="71f6b-136">Prerequisites</span></span>
* <span data-ttu-id="71f6b-137">若要容錯回復 VMware VM 和實體伺服器，您需要 VMware 環境。</span><span class="sxs-lookup"><span data-stu-id="71f6b-137">To fail back VMware VMs and physical servers, you need a VMware environment.</span></span> <span data-ttu-id="71f6b-138">不支援容錯回復至實體伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-138">Failing back to a physical server isn’t supported.</span></span>
* <span data-ttu-id="71f6b-139">若要容錯回復，您必須在最初設定保護時建立 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="71f6b-139">To fail back, you must have created an Azure network when you initially set up protection.</span></span> <span data-ttu-id="71f6b-140">要進行容錯回復，就需要有從 Azure 網路 (Azure VM 所在網路) 連往內部部署網站的 VPN 或 ExpressRoute 連線。</span><span class="sxs-lookup"><span data-stu-id="71f6b-140">Failback needs a VPN or ExpressRoute connection from the Azure network in which the Azure VMs are located to the on-premises site.</span></span>
* <span data-ttu-id="71f6b-141">如果您想要容錯回復到的目標 VM 是由 vCenter 伺服器所管理，您必須確定已擁有在 vCenter 伺服器上探索 VM 的必要權限。</span><span class="sxs-lookup"><span data-stu-id="71f6b-141">If the VMs that you want to fail back to are managed by a vCenter server, make sure that you have the required permissions for discovery of VMs on vCenter servers.</span></span> <span data-ttu-id="71f6b-142">如需詳細資訊，請參閱[使用 Azure Site Recovery 將 VMWare 虛擬機器和實體伺服器複寫至 Azure](site-recovery-vmware-to-azure-classic.md)。</span><span class="sxs-lookup"><span data-stu-id="71f6b-142">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span>
* <span data-ttu-id="71f6b-143">如果 VM 上有快照，重新保護程序將會失敗。</span><span class="sxs-lookup"><span data-stu-id="71f6b-143">If snapshots are present on a VM, reprotection fails.</span></span> <span data-ttu-id="71f6b-144">您可以刪除快照或磁碟。</span><span class="sxs-lookup"><span data-stu-id="71f6b-144">You can delete the snapshots or the disks.</span></span>
* <span data-ttu-id="71f6b-145">進行容錯回復之前，請建立這些元件：</span><span class="sxs-lookup"><span data-stu-id="71f6b-145">Before you fail back, create these components:</span></span>
  * <span data-ttu-id="71f6b-146">**在 Azure 中建立處理伺服器**。</span><span class="sxs-lookup"><span data-stu-id="71f6b-146">**Create a Process Server in Azure**.</span></span> <span data-ttu-id="71f6b-147">此元件是您在容錯回復期間建立並保持運作的 Azure VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-147">This component is an Azure VM that you create and keep running during failback.</span></span> <span data-ttu-id="71f6b-148">容錯回復完成後，便可以刪除該 VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-148">You can delete the VM after failback is complete.</span></span>
  * <span data-ttu-id="71f6b-149">**建立主要目標伺服器**：主要目標伺服器會傳送及接收容錯回復資料。</span><span class="sxs-lookup"><span data-stu-id="71f6b-149">**Create a master target server**: The master target server sends and receives failback data.</span></span> <span data-ttu-id="71f6b-150">您在內部部署環境中建立的管理伺服器預設會安裝主要目標伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-150">The management server that you created on-premises has a master target server that's installed by default.</span></span> <span data-ttu-id="71f6b-151">不過，您可能必須根據容錯回復流量的大小，另外建立一部用來容錯回復的主要目標伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-151">However, depending on the volume of failed-back traffic, you might need to create a separate master target server for failback.</span></span>
  * <span data-ttu-id="71f6b-152">若要另外建立一部在 Linux 上執行的主要目標伺服器，您必須先設定 Linux VM，然後才安裝主要目標伺服器，稍後將說明作法。</span><span class="sxs-lookup"><span data-stu-id="71f6b-152">To create an additional master target server that runs on Linux, set up the Linux VM before you install the master target server, as described later.</span></span>
* <span data-ttu-id="71f6b-153">執行容錯回復時，組態伺服器必須為內部部署。</span><span class="sxs-lookup"><span data-stu-id="71f6b-153">A configuration server is required on-premises when you do a failback.</span></span> <span data-ttu-id="71f6b-154">在容錯回復期間，虛擬機器必須存在於組態伺服器資料庫中。</span><span class="sxs-lookup"><span data-stu-id="71f6b-154">During failback, the virtual machine must exist in the configuration server database.</span></span> <span data-ttu-id="71f6b-155">若組態伺服器資料庫未包含任何 VM，則容錯回復無法成功。</span><span class="sxs-lookup"><span data-stu-id="71f6b-155">If the configuration server database contains no VM, failback cannot succeed.</span></span> <span data-ttu-id="71f6b-156">因此，請確定您定期備份伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-156">Therefore, ensure that you make regular scheduled backups of your server.</span></span> <span data-ttu-id="71f6b-157">發生災害時，您需要使用相同的 IP 位址進行還原，讓容錯回復運作。</span><span class="sxs-lookup"><span data-stu-id="71f6b-157">In a disaster, you need to restore it with the same IP address so that failback works.</span></span>
* <span data-ttu-id="71f6b-158">在 VMware 中設定主要目標 VM 之**組態參數**中的 disk.enableUUID=true 設定。</span><span class="sxs-lookup"><span data-stu-id="71f6b-158">Set the disk.enableUUID=true setting in **Configuration Parameters** of the master target VM in VMware.</span></span> <span data-ttu-id="71f6b-159">如果此列不存在，請新增它。</span><span class="sxs-lookup"><span data-stu-id="71f6b-159">If this row does not exist, add it.</span></span> <span data-ttu-id="71f6b-160">需要此設定才能提供一致的通用唯一識別碼 (UUID) 給虛擬機器磁碟 (VMDK) 檔案以便正確地掛載它。</span><span class="sxs-lookup"><span data-stu-id="71f6b-160">This setting is required to provide a consistent universally unique identifier (UUID) to the virtual machine disk (VMDK) file so that it is mounted correctly.</span></span>
* <span data-ttu-id="71f6b-161">請注意「主要目標伺服器不能是 vMotioned 儲存體」條件，因為這會導致容錯回復失敗。</span><span class="sxs-lookup"><span data-stu-id="71f6b-161">Be aware of a "Master target server cannot be storage vMotioned" condition, which can cause the failback to fail.</span></span> <span data-ttu-id="71f6b-162">該 VM 無法開機，因為尚未將磁碟提供給 VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-162">The VM cannot come up because the disks aren't made available to it.</span></span>
* <span data-ttu-id="71f6b-163">在主要目標伺服器上新增名為保留磁碟機的磁碟機。</span><span class="sxs-lookup"><span data-stu-id="71f6b-163">Add a drive, called a retention drive, onto the master target server.</span></span> <span data-ttu-id="71f6b-164">新增磁碟並格式化磁碟機。</span><span class="sxs-lookup"><span data-stu-id="71f6b-164">Add a disk, and format the drive.</span></span>

## <a name="failback-policy"></a><span data-ttu-id="71f6b-165">容錯回復原則</span><span class="sxs-lookup"><span data-stu-id="71f6b-165">Failback policy</span></span>
<span data-ttu-id="71f6b-166">若要複寫回內部部署，您需要容錯回復原則。</span><span class="sxs-lookup"><span data-stu-id="71f6b-166">To replicate back to on-premises, you need a failback policy.</span></span> <span data-ttu-id="71f6b-167">當您建立轉送方向原則時，會自動建立該原則，而且它會自動與組態伺服器關聯。</span><span class="sxs-lookup"><span data-stu-id="71f6b-167">The policy is automatically created when you create a forward direction policy, and it is automatically associated with the configuration server.</span></span> <span data-ttu-id="71f6b-168">您無法編輯它。</span><span class="sxs-lookup"><span data-stu-id="71f6b-168">It is not editable.</span></span> <span data-ttu-id="71f6b-169">該原則具有下列複寫設定：</span><span class="sxs-lookup"><span data-stu-id="71f6b-169">The policy has the following replication settings:</span></span>

* <span data-ttu-id="71f6b-170">RPO 臨界值 = 15 分鐘</span><span class="sxs-lookup"><span data-stu-id="71f6b-170">RPO threshold = 15 minutes</span></span>
* <span data-ttu-id="71f6b-171">復原點保留 = 24 小時</span><span class="sxs-lookup"><span data-stu-id="71f6b-171">Recovery point retention = 24 hours</span></span>
* <span data-ttu-id="71f6b-172">應用程式一致快照頻率 = 60 分鐘</span><span class="sxs-lookup"><span data-stu-id="71f6b-172">App consistent snapshot frequency = 60 minutes</span></span>

 ![容錯回復原則的複寫設定](./media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

## <a name="set-up-a-process-server-in-azure"></a><span data-ttu-id="71f6b-174">在 Azure 中設定處理伺服器</span><span class="sxs-lookup"><span data-stu-id="71f6b-174">Set up a Process Server in Azure</span></span>
<span data-ttu-id="71f6b-175">在 Azure 中安裝處理伺服器，讓 Azure VM 可以將資料傳送回內部部署主要目標伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-175">Install a Process Server in Azure so that the Azure VMs can send the data back to the on-premises master target server.</span></span>

<span data-ttu-id="71f6b-176">如果您已經將您的虛擬機器做為傳統資源保護 (也就是在 Azure 中復原的 VM 是傳統部署模型建立的 VM)，那麼您需要 Azure 中的處理伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-176">If you have protected your virtual machines as classic resources (that is, the VM recovered in Azure is a VM that was created by using the classic deployment model), you need a Process Server in Azure.</span></span> <span data-ttu-id="71f6b-177">若您已經在使用 Azure Resource Manager 做為部署類型的情況下復原 VM，Process Server 必須使用 Resource Manager 做為部署類型。</span><span class="sxs-lookup"><span data-stu-id="71f6b-177">If you have recovered the VMs with Azure Resource Manager as the deployment type, the Process Server must have Resource Manager as the deployment type.</span></span> <span data-ttu-id="71f6b-178">部署類型是由您在其中部署處理伺服器的 Azure 虛擬網路所選取。</span><span class="sxs-lookup"><span data-stu-id="71f6b-178">The deployment type is selected by the Azure virtual network that you deploy the Process Server to.</span></span>

1. <span data-ttu-id="71f6b-179">在 [保存庫] > [設定] > [Site Recovery 基礎結構] \(在 [管理] 下) > [組態伺服器] \(在 [適用於 VMware 與虛擬機器] 下)，選取組態伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-179">In **Vault** > **Settings** > **Site Recovery Infrastructure** (under **Manage**) > **Configuration Servers** (under **For VMware and Physical Machines**), select the configuration server.</span></span>
2. <span data-ttu-id="71f6b-180">按一下 [處理伺服器]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-180">Click **Process Server**.</span></span>

  ![[處理伺服器] 按鈕](./media/site-recovery-failback-azure-to-vmware-classic/add-processserver.png)
3. <span data-ttu-id="71f6b-182">選擇將處理伺服器部署為「在 Azure 中部署容錯回復處理伺服器」。</span><span class="sxs-lookup"><span data-stu-id="71f6b-182">Choose to deploy the Process Server as **Deploy a failback Process Server in Azure**.</span></span>
4. <span data-ttu-id="71f6b-183">選取您已在其中復原 VM 的訂用帳戶。</span><span class="sxs-lookup"><span data-stu-id="71f6b-183">Select the subscription that you have recovered the VMs to.</span></span>
5. <span data-ttu-id="71f6b-184">選取您已在其中復原 VM 的 Azure 網路。</span><span class="sxs-lookup"><span data-stu-id="71f6b-184">Select the Azure network that you have recovered the VMs to.</span></span> <span data-ttu-id="71f6b-185">處理伺服器必須位於相同的網路中，復原的 VM 與處理伺服器才能夠通訊。</span><span class="sxs-lookup"><span data-stu-id="71f6b-185">The Process Server needs to be in the same network so that the recovered VMs and the Process Server can communicate.</span></span>
6. <span data-ttu-id="71f6b-186">若已選取「傳統部署模型」網路，請透過 Azure Marketplace 建立 VM，然後在其中安裝處理伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-186">If you selected a *classic deployment model* network, create a VM via the Azure Marketplace, and then install the Process Server in it.</span></span>

 ![[新增處理伺服器] 視窗](./media/site-recovery-failback-azure-to-vmware-classic/add-classic.png)

 <span data-ttu-id="71f6b-188">當您建立處理伺服器時，請注意下列事項：</span><span class="sxs-lookup"><span data-stu-id="71f6b-188">As you're creating the Process Server, pay attention to the following:</span></span>
 * <span data-ttu-id="71f6b-189">映像的名稱是 *Microsoft Azure Site Recovery Process Server V2*。</span><span class="sxs-lookup"><span data-stu-id="71f6b-189">The name of the image is *Microsoft Azure Site Recovery Process Server V2*.</span></span> <span data-ttu-id="71f6b-190">選取 [傳統] 做為部署模型。</span><span class="sxs-lookup"><span data-stu-id="71f6b-190">Select **Classic** as the deployment model.</span></span>

       ![Select "Classic" as the Process Server deployment model](./media/site-recovery-failback-azure-to-vmware-classic/templatename.png)
 * <span data-ttu-id="71f6b-191">根據[使用 Azure Site Recovery 將 VMWare 虛擬機器和實體伺服器複寫至 Azure](site-recovery-vmware-to-azure-classic.md)中的指示安裝處理伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-191">Install the Process Server according to the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span>
7. <span data-ttu-id="71f6b-192">如果您選取 [Resource Manager] Azure 網路，請提供下列資訊來部署處理伺服器：</span><span class="sxs-lookup"><span data-stu-id="71f6b-192">If you select the *Resource Manager* Azure network, deploy the Process Server by providing the following information:</span></span>

  * <span data-ttu-id="71f6b-193">您想要在其中部署伺服器的資源群組名稱</span><span class="sxs-lookup"><span data-stu-id="71f6b-193">The name of the resource group that you want to deploy the server to</span></span>
  * <span data-ttu-id="71f6b-194">伺服器的名稱</span><span class="sxs-lookup"><span data-stu-id="71f6b-194">The name of the server</span></span>
  * <span data-ttu-id="71f6b-195">用於登入伺服器的使用者名稱與密碼</span><span class="sxs-lookup"><span data-stu-id="71f6b-195">A username and password for signing in to the server</span></span>
  * <span data-ttu-id="71f6b-196">要將伺服器部署到其中的儲存體帳戶</span><span class="sxs-lookup"><span data-stu-id="71f6b-196">The storage account that you want to deploy the server to</span></span>
  * <span data-ttu-id="71f6b-197">要連接的目標子網路與網路介面</span><span class="sxs-lookup"><span data-stu-id="71f6b-197">The subnet and the network interface that you want to connect to it</span></span>
   >[!NOTE]
   ><span data-ttu-id="71f6b-198">當您部署處理伺服器時，您必須建立自己的[網路介面](../virtual-network/virtual-networks-multiple-nics.md) (NIC) 並選取它。</span><span class="sxs-lookup"><span data-stu-id="71f6b-198">You must create your own [network interface](../virtual-network/virtual-networks-multiple-nics.md) (NIC) and select it while you are deploying the Process Server.</span></span>

    ![在 [新增處理伺服器] 對話方塊中輸入資訊](./media/site-recovery-failback-azure-to-vmware-classic/psinputsadd.png)

8. <span data-ttu-id="71f6b-200">按一下 [確定] 。</span><span class="sxs-lookup"><span data-stu-id="71f6b-200">Click **OK**.</span></span> <span data-ttu-id="71f6b-201">此動作會觸發在處理伺服器安裝期間建立 Resource Manager 部署類型虛擬機器的作業。</span><span class="sxs-lookup"><span data-stu-id="71f6b-201">This action triggers a job that creates a Resource Manager deployment type virtual machine during the Process Server setup.</span></span> <span data-ttu-id="71f6b-202">若要將該伺服器登錄到組態伺服器，請依照[使用 Azure Site Recovery 將 VMWare 虛擬機器和實體伺服器複寫至 Azure](site-recovery-vmware-to-azure-classic.md) 中的指示在 VM 內執行安裝程式。</span><span class="sxs-lookup"><span data-stu-id="71f6b-202">To register the server to the configuration server, run the setup inside the VM by following the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span> <span data-ttu-id="71f6b-203">將會一併觸發部署處理伺服器的作業。</span><span class="sxs-lookup"><span data-stu-id="71f6b-203">A job to deploy the Process Server is also triggered.</span></span>

  <span data-ttu-id="71f6b-204">處理伺服器會列在 [組態伺服器] >  [關聯的伺服器] >  [處理伺服器] 索引標籤上。</span><span class="sxs-lookup"><span data-stu-id="71f6b-204">The Process Server is listed on the **Configuration servers** > **Associated servers** > **Process Servers** tab.</span></span>

    ![](./media/site-recovery-failback-azure-to-vmware-new/pslistingincs.png)

    > [!NOTE]
    > <span data-ttu-id="71f6b-205">處理伺服器不會顯示在 [VM 內容] 下。</span><span class="sxs-lookup"><span data-stu-id="71f6b-205">The Process Server isn't visible under **VM properties**.</span></span> <span data-ttu-id="71f6b-206">它只會顯示在所登錄之管理伺服器的 [伺服器] 索引標籤上。</span><span class="sxs-lookup"><span data-stu-id="71f6b-206">It's visible only on the **Servers** tab in the management server that it's registered to.</span></span> <span data-ttu-id="71f6b-207">處理伺服器需要 10 到 15 分鐘才會出現。</span><span class="sxs-lookup"><span data-stu-id="71f6b-207">It can take 10 to 15 minutes for the Process Server to appear.</span></span>


## <a name="set-up-the-master-target-server-on-premises"></a><span data-ttu-id="71f6b-208">在內部部署環境中設定主要目標伺服器</span><span class="sxs-lookup"><span data-stu-id="71f6b-208">Set up the master target server on-premises</span></span>
<span data-ttu-id="71f6b-209">主要目標伺服器會接收容錯回復資料。</span><span class="sxs-lookup"><span data-stu-id="71f6b-209">The master target server receives the failback data.</span></span> <span data-ttu-id="71f6b-210">伺服器會自動安裝在內部部署管理伺服器，但如果要容錯回復大量資料，則可能需要另外設定一部主要目標伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-210">The server is automatically installed on the on-premises management server, but if you're failing back too much data, you might need to set up an additional master target server.</span></span> <span data-ttu-id="71f6b-211">若要在內部部署環境中設定主要目標伺服器，請執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="71f6b-211">To set up a master target server on-premises, do the following:</span></span>

> [!NOTE]
> <span data-ttu-id="71f6b-212">若要在 Linux 上設定主要目標伺服器，請跳到下一個程序。</span><span class="sxs-lookup"><span data-stu-id="71f6b-212">To set up a master target server on Linux, skip to the next procedure.</span></span> <span data-ttu-id="71f6b-213">只使用 CentOS 6.6 基本作業系統做為主要目標 OS。</span><span class="sxs-lookup"><span data-stu-id="71f6b-213">Use only CentOS 6.6 minimal operating system as the master target OS.</span></span>

1. <span data-ttu-id="71f6b-214">若要在 Windows 上設定主要目標伺服器，請從要在其上安裝主要目標伺服器的 VM 開啟快速入門頁面。</span><span class="sxs-lookup"><span data-stu-id="71f6b-214">If you're setting up the master target server on Windows, open the quick-start page from the VM that you're installing the master target server on.</span></span>
2. <span data-ttu-id="71f6b-215">下載「Azure Site Recovery 統一安裝程式」精靈的安裝檔案。</span><span class="sxs-lookup"><span data-stu-id="71f6b-215">Download the installation file for the Azure Site Recovery Unified Setup wizard.</span></span>
3. <span data-ttu-id="71f6b-216">執行安裝程式，並在 [開始之前] 中選取 [新增額外處理伺服器以相應放大部署]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-216">Run the setup and, in **Before you begin**, select **Add additional Process Servers to scale out deployment**.</span></span>
4. <span data-ttu-id="71f6b-217">以您 [設定管理伺服器](site-recovery-vmware-to-azure-classic.md)時的相同方式完成精靈。</span><span class="sxs-lookup"><span data-stu-id="71f6b-217">Complete the wizard in the same way you did when you [set up the management server](site-recovery-vmware-to-azure-classic.md).</span></span> <span data-ttu-id="71f6b-218">在 [組態伺服器詳細資料] 頁面上，指定主要目標伺服器的 IP 位址並輸入複雜密碼來存取 VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-218">On the **Configuration Server Details** page, specify the IP address of the master target server, and enter a passphrase to access the VM.</span></span>

### <a name="set-up-a-linux-vm-as-the-master-target-server"></a><span data-ttu-id="71f6b-219">將 Linux VM 設定為主要目標伺服器</span><span class="sxs-lookup"><span data-stu-id="71f6b-219">Set up a Linux VM as the master target server</span></span>
<span data-ttu-id="71f6b-220">若要設定管理伺服器並以 Linux VM 執行主要目標伺服器，請安裝 CentOS 6.6 基本作業系統。</span><span class="sxs-lookup"><span data-stu-id="71f6b-220">To set up the management server running the master target server as a Linux VM, install the CentOS 6.6 minimal operating system.</span></span> <span data-ttu-id="71f6b-221">接著，擷取每個 SCSI 硬碟的 SCSI 識別碼，安裝一些其他套件，並套用一些自訂變更。</span><span class="sxs-lookup"><span data-stu-id="71f6b-221">Next, retrieve the SCSI IDs for each SCSI hard disk, install some additional packages, and apply some custom changes.</span></span>

#### <a name="install-centos-66"></a><span data-ttu-id="71f6b-222">安裝 CentOS 6.6</span><span class="sxs-lookup"><span data-stu-id="71f6b-222">Install CentOS 6.6</span></span>

1. <span data-ttu-id="71f6b-223">在管理伺服器 VM 上安裝 CentOS 6.6 最小作業系統。</span><span class="sxs-lookup"><span data-stu-id="71f6b-223">Install the CentOS 6.6 minimal operating system on the management server VM.</span></span> <span data-ttu-id="71f6b-224">在 DVD 光碟機中放入 ISO，並將系統開機。</span><span class="sxs-lookup"><span data-stu-id="71f6b-224">Keep the ISO on a DVD drive, and boot the system.</span></span> <span data-ttu-id="71f6b-225">跳過媒體測試。</span><span class="sxs-lookup"><span data-stu-id="71f6b-225">Skip the media testing.</span></span> <span data-ttu-id="71f6b-226">選取 [美式英文] 做為語言，選取 [基本存放裝置]，確認硬碟上沒有任何重要資料，然後按一下 [是] 以捨棄所有資料。</span><span class="sxs-lookup"><span data-stu-id="71f6b-226">Select **US English** as the language, select **Basic Storage Devices**, check that the hard drive doesn’t have any important data, click **Yes**, and discard any data.</span></span> <span data-ttu-id="71f6b-227">輸入管理伺服器的主機名稱，然後選取伺服器網路介面卡。</span><span class="sxs-lookup"><span data-stu-id="71f6b-227">Enter the host name of the management server, and select the server network adapter.</span></span>  <span data-ttu-id="71f6b-228">在 [編輯系統] 對話方塊中，選取 [自動連線]，然後新增靜態 IP 位址、網路和 DNS 設定。</span><span class="sxs-lookup"><span data-stu-id="71f6b-228">In the **Editing System** dialog box, select **Connect automatically**, and then add a static IP address, network, and DNS settings.</span></span> <span data-ttu-id="71f6b-229">指定時區。</span><span class="sxs-lookup"><span data-stu-id="71f6b-229">Specify a time zone.</span></span> <span data-ttu-id="71f6b-230">若要存取管理伺服器，請輸入 root 密碼。</span><span class="sxs-lookup"><span data-stu-id="71f6b-230">To access the management server, enter the root password.</span></span>
2. <span data-ttu-id="71f6b-231">當系統要求您指定安裝類型時，請選取 [建立自訂配置] 做為磁碟分割。</span><span class="sxs-lookup"><span data-stu-id="71f6b-231">When you're asked what type of installation you want, select **Create Custom Layout** as the partition.</span></span> <span data-ttu-id="71f6b-232">按一下 [下一步] 。</span><span class="sxs-lookup"><span data-stu-id="71f6b-232">Click **Next**.</span></span> <span data-ttu-id="71f6b-233">選取 [可用]，然後按一下 [建立]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-233">Select **Free**, and then click **Create**.</span></span> <span data-ttu-id="71f6b-234">使用 [FS 類型：ext4] 來建立 **/**、**/var/crash** 和 **/home** 磁碟分割。</span><span class="sxs-lookup"><span data-stu-id="71f6b-234">Create **/**,  **/var/crash**, and **/home partitions** with **FS Type:** **ext4**.</span></span> <span data-ttu-id="71f6b-235">將交換磁碟分割建立為 [FS 類型：swap]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-235">Create the swap partition as **FS Type: swap**.</span></span>
3. <span data-ttu-id="71f6b-236">如果找到現存裝置，將會出現警告訊息。</span><span class="sxs-lookup"><span data-stu-id="71f6b-236">If pre-existing devices are found, a warning message appears.</span></span> <span data-ttu-id="71f6b-237">按一下 [格式化]  以使用磁碟分割設定將該磁碟機格式化。</span><span class="sxs-lookup"><span data-stu-id="71f6b-237">Click **Format** to format the drive with the partition settings.</span></span> <span data-ttu-id="71f6b-238">按一下 [將變更寫入磁碟]  以套用磁碟分割變更。</span><span class="sxs-lookup"><span data-stu-id="71f6b-238">Click **Write change to disk** to apply the partition changes.</span></span>
4. <span data-ttu-id="71f6b-239">選取 [安裝開機載入器]  >  [下一步] 以在根磁碟分割上安裝開機載入器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-239">Select **Install boot loader** > **Next** to install the boot loader on the root partition.</span></span>
5. <span data-ttu-id="71f6b-240">安裝完成時，按一下 [重新開機]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-240">When the installation is complete, click **Reboot**.</span></span>

#### <a name="retrieve-the-scsi-ids"></a><span data-ttu-id="71f6b-241">擷取 SCSI 識別碼</span><span class="sxs-lookup"><span data-stu-id="71f6b-241">Retrieve the SCSI IDs</span></span>

1. <span data-ttu-id="71f6b-242">在安裝後，擷取 VM 中每個 SCSI 硬碟的 SCSI 識別碼。</span><span class="sxs-lookup"><span data-stu-id="71f6b-242">After the installation, retrieve the SCSI IDs for each SCSI hard disk in the VM.</span></span> <span data-ttu-id="71f6b-243">若要這樣做，請將管理伺服器 VM 關機。</span><span class="sxs-lookup"><span data-stu-id="71f6b-243">To do so, shut down the management server VM.</span></span> <span data-ttu-id="71f6b-244">在 VMware 的 VM 屬性中，以滑鼠右鍵按一下 VM 項目 > [編輯設定]  > [選項]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-244">In the VM properties in VMware, right-click the VM entry > **Edit Settings** > **Options**.</span></span>
2. <span data-ttu-id="71f6b-245">選取 [進階] > [一般項目]，然後按一下 [組態參數]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-245">Select **Advanced** > **General item**, and then click **Configuration Parameters**.</span></span> <span data-ttu-id="71f6b-246">當機器正在執行時，此選項無法使用。</span><span class="sxs-lookup"><span data-stu-id="71f6b-246">This option is unavailable when the machine is running.</span></span> <span data-ttu-id="71f6b-247">若要讓此選項可用，必須將機器關機。</span><span class="sxs-lookup"><span data-stu-id="71f6b-247">For the option to be available, the machine must be shut down.</span></span>
3. <span data-ttu-id="71f6b-248">執行下列其中一個動作：</span><span class="sxs-lookup"><span data-stu-id="71f6b-248">Do either of the following:</span></span>
 * <span data-ttu-id="71f6b-249">如果 **disk.EnableUUID** 列存在，請確定其值已設定為 [True] \(區分大小寫)。</span><span class="sxs-lookup"><span data-stu-id="71f6b-249">If the row **disk.EnableUUID** exists, make sure that the value is set to **True** (case sensitive).</span></span> <span data-ttu-id="71f6b-250">如果值已設定為 [True]，您可以取消，然後在機器開機之後，於客體作業系統內部測試 SCSI 命令。</span><span class="sxs-lookup"><span data-stu-id="71f6b-250">If the value is already set to True, you can cancel and test the SCSI command inside a guest operating system after it’s booted.</span></span>
 * <span data-ttu-id="71f6b-251">如果 **disk.EnableUUID** 列不存在，請按一下 [新增列]，並以 [True] 值新增它。</span><span class="sxs-lookup"><span data-stu-id="71f6b-251">If the row **disk.EnableUUID** doesn’t exist, click **Add Row**, and then add it with the **True** value.</span></span> <span data-ttu-id="71f6b-252">請勿使用雙引號。</span><span class="sxs-lookup"><span data-stu-id="71f6b-252">Don’t use double quotation marks.</span></span>

#### <a name="install-additional-packages"></a><span data-ttu-id="71f6b-253">安裝其他套件</span><span class="sxs-lookup"><span data-stu-id="71f6b-253">Install additional packages</span></span>
<span data-ttu-id="71f6b-254">下載並安裝其他套件。</span><span class="sxs-lookup"><span data-stu-id="71f6b-254">Download and install additional packages.</span></span>

1. <span data-ttu-id="71f6b-255">確定主要目標伺服器已連線到網際網路。</span><span class="sxs-lookup"><span data-stu-id="71f6b-255">Make sure the master target server is connected to the Internet.</span></span>
2. <span data-ttu-id="71f6b-256">若要從 CentOS 存放庫下載並安裝 15 個套件，請執行此命令：`# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools`。</span><span class="sxs-lookup"><span data-stu-id="71f6b-256">To download and install 15 packages from the CentOS repository, run this command: `# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools`.</span></span>
3. <span data-ttu-id="71f6b-257">如果所要保護的來源機器是執行 Linux 並針對根目錄或開機裝置使用 Reiser 或 XFS 檔案系統，請下載並安裝下列額外套件：</span><span class="sxs-lookup"><span data-stu-id="71f6b-257">If the source machines you’re protecting are running Linux with a Reiser or XFS file system for the root or boot device, download and install additional packages as follows:</span></span>

   * <span data-ttu-id="71f6b-258">\# cd /usr/local</span><span class="sxs-lookup"><span data-stu-id="71f6b-258">\# cd /usr/local</span></span>
   * <span data-ttu-id="71f6b-259">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)</span><span class="sxs-lookup"><span data-stu-id="71f6b-259">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)</span></span>
   * <span data-ttu-id="71f6b-260">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)</span><span class="sxs-lookup"><span data-stu-id="71f6b-260">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)</span></span>
   * <span data-ttu-id="71f6b-261">\# rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm</span><span class="sxs-lookup"><span data-stu-id="71f6b-261">\# rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm</span></span>
   * <span data-ttu-id="71f6b-262">\# wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)</span><span class="sxs-lookup"><span data-stu-id="71f6b-262">\# wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)</span></span>
   * <span data-ttu-id="71f6b-263">\# rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm</span><span class="sxs-lookup"><span data-stu-id="71f6b-263">\# rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm</span></span>
   * <span data-ttu-id="71f6b-264">\# yum install device-mapper-multipath (這是在主要目標伺服器上啟用多重路徑套件的必要做法)</span><span class="sxs-lookup"><span data-stu-id="71f6b-264">\# yum install device-mapper-multipath (required to enable multipath packages on the master target server)</span></span>

#### <a name="apply-custom-changes"></a><span data-ttu-id="71f6b-265">套用自訂變更</span><span class="sxs-lookup"><span data-stu-id="71f6b-265">Apply custom changes</span></span>
<span data-ttu-id="71f6b-266">完成安裝後步驟並安裝套件之後，請執行下列動作以套用自訂變更：</span><span class="sxs-lookup"><span data-stu-id="71f6b-266">After you’ve completed the post-installation steps and installed the packages, apply custom changes by doing the following:</span></span>

1. <span data-ttu-id="71f6b-267">將 RHEL 6-64 整合代理程式二進位檔複製到 VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-267">Copy the RHEL 6-64 Unified Agent binary to the VM.</span></span> <span data-ttu-id="71f6b-268">若要將二進位檔解壓縮，請執行此命令：`tar –zxvf <file name>`。</span><span class="sxs-lookup"><span data-stu-id="71f6b-268">To untar the binary, run this command: `tar –zxvf <file name>`.</span></span>
2. <span data-ttu-id="71f6b-269">若要授與權限，請執行此命令：`# chmod 755 ./ApplyCustomChanges.sh`。</span><span class="sxs-lookup"><span data-stu-id="71f6b-269">To give permissions, run this command: `# chmod 755 ./ApplyCustomChanges.sh`.</span></span>
3. <span data-ttu-id="71f6b-270">執行下列指令碼：`# ./ApplyCustomChanges.sh`。</span><span class="sxs-lookup"><span data-stu-id="71f6b-270">Run the following script: `# ./ApplyCustomChanges.sh`.</span></span> <span data-ttu-id="71f6b-271">只要執行一次。</span><span class="sxs-lookup"><span data-stu-id="71f6b-271">Run it only once.</span></span> <span data-ttu-id="71f6b-272">在指令碼順利執行後，請將伺服器重新開機。</span><span class="sxs-lookup"><span data-stu-id="71f6b-272">After it runs successfully, reboot the server.</span></span>

## <a name="run-the-failback"></a><span data-ttu-id="71f6b-273">執行容錯回復</span><span class="sxs-lookup"><span data-stu-id="71f6b-273">Run the failback</span></span>
### <a name="reprotect-the-azure-vms"></a><span data-ttu-id="71f6b-274">重新保護 Azure VM</span><span class="sxs-lookup"><span data-stu-id="71f6b-274">Reprotect the Azure VMs</span></span>
1. <span data-ttu-id="71f6b-275">在 [保存庫] 的 [已複寫的項目] 中，以滑鼠右鍵按一下已容錯移轉的 VM，然後選取 [重新保護]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-275">In **Vault**, in **Replicated items**, right-click the VM that has been failed over, and then select **Re-Protect**.</span></span>
2. <span data-ttu-id="71f6b-276">在刀鋒視窗上，您可以看到已選取保護方向 [Azure 至內部部署]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-276">On the blade, you can see that the direction of protection **Azure to On-premises** is already selected.</span></span>
3. <span data-ttu-id="71f6b-277">在 [主要目標伺服器] 和 [處理伺服器] 中，選取內部部署主要目標伺服器和 Azure VM 處理伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-277">In **Master Target Server** and **Process Server**, select the on-premises master target server and the Azure VM Process Server.</span></span>
4. <span data-ttu-id="71f6b-278">選取您想要將內部部署磁碟復原至該位置的資料存放區。</span><span class="sxs-lookup"><span data-stu-id="71f6b-278">Select the datastore that you want to recover the disks on-premises to.</span></span> <span data-ttu-id="71f6b-279">當內部部署 VM 已被刪除且您需要建立新的磁碟時，請使用此選項。</span><span class="sxs-lookup"><span data-stu-id="71f6b-279">Use this option when the on-premises VM is deleted and you need to create new disks.</span></span> <span data-ttu-id="71f6b-280">如果磁碟已存在，但您仍然需要指定值的話，請忽略此選項。</span><span class="sxs-lookup"><span data-stu-id="71f6b-280">Ignore the option if the disks already exist, but you still need to specify a value.</span></span>
5. <span data-ttu-id="71f6b-281">當 VM 複寫回內部部署時，可以使用保留磁碟機來停止時間點。</span><span class="sxs-lookup"><span data-stu-id="71f6b-281">Use a retention drive to stop the points in time when the VM is replicated back to on-premises.</span></span> <span data-ttu-id="71f6b-282">這裡列出保留磁碟機的一些條件。</span><span class="sxs-lookup"><span data-stu-id="71f6b-282">Some criteria of a retention drive are listed here.</span></span> <span data-ttu-id="71f6b-283">若沒有這些條件，將不會針對主要目標伺服器列出磁碟機。</span><span class="sxs-lookup"><span data-stu-id="71f6b-283">Without these criteria, the drive is not listed for the master target server.</span></span>

  * <span data-ttu-id="71f6b-284">磁碟區不能使用於其他用途 (做為複寫目標等)。</span><span class="sxs-lookup"><span data-stu-id="71f6b-284">Volume shouldn't be in use for any other purpose (target of replication, and so forth).</span></span>
  * <span data-ttu-id="71f6b-285">磁碟區不能處於鎖定模式。</span><span class="sxs-lookup"><span data-stu-id="71f6b-285">Volume shouldn't be in lock mode.</span></span>
  * <span data-ttu-id="71f6b-286">磁碟區不能是快取磁碟區。</span><span class="sxs-lookup"><span data-stu-id="71f6b-286">Volume shouldn't be cache volume.</span></span> <span data-ttu-id="71f6b-287">(該磁碟區上不能有主要目標安裝。</span><span class="sxs-lookup"><span data-stu-id="71f6b-287">(The master target installation shouldn't exist on that volume.</span></span> <span data-ttu-id="71f6b-288">處理伺服器加上主要目標自訂安裝磁碟區不符合做為保留磁碟區的資格。</span><span class="sxs-lookup"><span data-stu-id="71f6b-288">The Process Server plus master target custom installation volume is not eligible for retention volume.</span></span> <span data-ttu-id="71f6b-289">在這裡，已安裝的處理伺服器加上主要目標磁碟區是主要目標的快取磁碟區。)</span><span class="sxs-lookup"><span data-stu-id="71f6b-289">Here, the installed Process Server plus master target volume is the cache volume of the master target.)</span></span>
  * <span data-ttu-id="71f6b-290">磁碟區檔案系統類型不能是 FAT 和 FAT32。</span><span class="sxs-lookup"><span data-stu-id="71f6b-290">The volume file system type shouldn't be FAT and FAT32.</span></span>
  * <span data-ttu-id="71f6b-291">磁碟區容量不能為零。</span><span class="sxs-lookup"><span data-stu-id="71f6b-291">The volume capacity should be non-zero.</span></span>
  * <span data-ttu-id="71f6b-292">Windows 的預設保留磁碟區為 R 磁碟區。</span><span class="sxs-lookup"><span data-stu-id="71f6b-292">The default retention volume for Windows is R volume.</span></span>
  * <span data-ttu-id="71f6b-293">Linux 的預設保留磁碟區為 /mnt/retention。</span><span class="sxs-lookup"><span data-stu-id="71f6b-293">The default retention volume for Linux is /mnt/retention.</span></span>

6. <span data-ttu-id="71f6b-294">系統會自動選取容錯回復原則。</span><span class="sxs-lookup"><span data-stu-id="71f6b-294">The failback policy is automatically selected.</span></span>
7. <span data-ttu-id="71f6b-295">在您按一下 [確定] 以開始重新保護之後，就會開始執行將 VM 從 Azure 複寫到內部部署網站的作業。</span><span class="sxs-lookup"><span data-stu-id="71f6b-295">After you click **OK** to begin reprotection, a job begins to replicate the VM from Azure to the on-premises site.</span></span> <span data-ttu-id="71f6b-296">您可以在 [作業]  索引標籤上追蹤進度。</span><span class="sxs-lookup"><span data-stu-id="71f6b-296">You can track the progress on the **Jobs** tab.</span></span>

<span data-ttu-id="71f6b-297">如果您想要復原到替代位置，請選取為主要目標伺服器設定的保留磁碟機和資料存放區。</span><span class="sxs-lookup"><span data-stu-id="71f6b-297">If you want to recover to an alternate location, select the retention drive and datastore that are configured for the master target server.</span></span> <span data-ttu-id="71f6b-298">當您容錯回復到內部部署網站時，容錯回復保護計劃中的 VMware VM 會使用與主要目標伺服器相同的資料存放區。</span><span class="sxs-lookup"><span data-stu-id="71f6b-298">When you fail back to the on-premises site, the VMware VMs in the failback protection plan use the same datastore as the master target server.</span></span> <span data-ttu-id="71f6b-299">如果您想要將複本 Azure VM 復原到相同的內部部署 VM，則內部部署 VM 必須已位於與主要目標伺服器相同的資料存放區內。</span><span class="sxs-lookup"><span data-stu-id="71f6b-299">If you want to recover the replica Azure VM to the same on-premises VM, the on-premises VM should already be in the same datastore as the master target server.</span></span> <span data-ttu-id="71f6b-300">如果內部部署環境中沒有任何 VM，則會在重新保護期間建立一個新的 VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-300">If there's no VM on-premises, a new one is created during reprotection.</span></span>

![在下拉式功能表中選取 [Azure 到內部部署]](./media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)

<span data-ttu-id="71f6b-302">您也可以在復原計劃層級重新保護。</span><span class="sxs-lookup"><span data-stu-id="71f6b-302">You can also reprotect at a recovery plan level.</span></span> <span data-ttu-id="71f6b-303">如果您有一個複寫群組，則只能使用復原方案來重新保護它。</span><span class="sxs-lookup"><span data-stu-id="71f6b-303">If you have a replication group, you can reprotect it only by using a recovery plan.</span></span> <span data-ttu-id="71f6b-304">當您使用復原方案來重新保護時，請為每部受保護的機器使用先前的值。</span><span class="sxs-lookup"><span data-stu-id="71f6b-304">When you reprotect by using a recovery plan, use the previous values for every protected machine.</span></span>

> [!NOTE]
> <span data-ttu-id="71f6b-305">複寫群組應該使用相同的主要目標重新保護。</span><span class="sxs-lookup"><span data-stu-id="71f6b-305">Replication groups should be protected back with the same master target.</span></span> <span data-ttu-id="71f6b-306">如果使用不同的主要目標伺服器重新保護，則無法針對它們判斷一般時間點。</span><span class="sxs-lookup"><span data-stu-id="71f6b-306">If they are protected back with different master target servers, a common point in time cannot be determined for them.</span></span>

### <a name="run-a-failover-to-the-on-premises-site"></a><span data-ttu-id="71f6b-307">執行容錯移轉至內部部署網站</span><span class="sxs-lookup"><span data-stu-id="71f6b-307">Run a failover to the on-premises site</span></span>
<span data-ttu-id="71f6b-308">重新保護 VM 後，您可以起始從 Azure 至內部部署的容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="71f6b-308">After you reprotect the VM, you can initiate a failover from Azure to on-premises.</span></span>

1. <span data-ttu-id="71f6b-309">在 [已複寫的項目] 頁面上，以滑鼠右鍵按一下虛擬機器，然後選取 [非計劃性容錯移轉]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-309">On the replicated items page, right-click the virtual machine, and then select **Unplanned Failover**.</span></span>
2. <span data-ttu-id="71f6b-310">在 [確認容錯移轉] 中，確認容錯移轉方向 (以 Azure 為來源)，並選取您想要用來進行容錯移轉的復原點 (最近的復原點或最近的應用程式一致復原點)。</span><span class="sxs-lookup"><span data-stu-id="71f6b-310">In **Confirm Failover**, verify the failover direction (from Azure), and then select the recovery point that you want to use for the failover (the latest, or the latest app-consistent recovery point).</span></span> <span data-ttu-id="71f6b-311">應用程式一致復原點發生在最近的時間點之前，而且它將會導致一些資料遺失。</span><span class="sxs-lookup"><span data-stu-id="71f6b-311">An app-consistent recovery point occurs before the most recent point in time, and it will cause some data loss.</span></span>
3. <span data-ttu-id="71f6b-312">在容錯移轉期間，Site Recovery 會將 Azure VM 關機。</span><span class="sxs-lookup"><span data-stu-id="71f6b-312">During failover, Site Recovery shuts down the Azure VMs.</span></span> <span data-ttu-id="71f6b-313">在確認容錯回復已如預期完成後，您可以確認 Azure VM 是否已如預期般關閉。</span><span class="sxs-lookup"><span data-stu-id="71f6b-313">After you check that failback has been completed as expected, you can check to ensure that the Azure VMs have been shut down as expected.</span></span>

### <a name="reprotect-the-on-premises-site"></a><span data-ttu-id="71f6b-314">重新保護內部部署網站</span><span class="sxs-lookup"><span data-stu-id="71f6b-314">Reprotect the on-premises site</span></span>
<span data-ttu-id="71f6b-315">容錯回復完成之後，請認可虛擬機器，以確保會刪除在 Azure 中復原的 VM。</span><span class="sxs-lookup"><span data-stu-id="71f6b-315">After failback has been completed, commit the virtual machine to ensure that the VMs recovered in Azure are deleted.</span></span> <span data-ttu-id="71f6b-316">若要這樣做，請以滑鼠右鍵按一下受保護的項目，然後按一下 [認可]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-316">To do so, right-click the protected item, and then click **Commit**.</span></span> <span data-ttu-id="71f6b-317">此動作將會觸發在 Azure 中移除先前復原之虛擬機器的作業。</span><span class="sxs-lookup"><span data-stu-id="71f6b-317">This action triggers a job that removes the former recovered virtual machines in Azure.</span></span>

<span data-ttu-id="71f6b-318">在認可完成後，內部部署網站上的資料會恢復，但不會受到保護。</span><span class="sxs-lookup"><span data-stu-id="71f6b-318">After the commit is completed, your data should be back on the on-premises site, but it won’t be protected.</span></span> <span data-ttu-id="71f6b-319">若要再次開始複寫至 Azure，請執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="71f6b-319">To start replicating to Azure again, do the following:</span></span>

1. <span data-ttu-id="71f6b-320">在 [保存庫] 的 [設定] >  [已複寫的項目] 中，選取已容錯回復的 VM，然後按一下 [重新保護]。</span><span class="sxs-lookup"><span data-stu-id="71f6b-320">In **Vault**, in **Setting** > **Replicated items**, select the VMs that have failed back, and then click **Re-Protect**.</span></span>
2. <span data-ttu-id="71f6b-321">提供必須用來將資料傳送回 Azure 之處理伺服器的值。</span><span class="sxs-lookup"><span data-stu-id="71f6b-321">Give the value of the Process Server that needs to be used to send data back to Azure.</span></span>
3. <span data-ttu-id="71f6b-322">按一下 [確定] 。</span><span class="sxs-lookup"><span data-stu-id="71f6b-322">Click **OK**.</span></span>

<span data-ttu-id="71f6b-323">重新保護完成之後，VM 會複寫回 Azure，而且您可以執行容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="71f6b-323">After the reprotection is complete, the VM replicates back to Azure and you can do a failover.</span></span>

### <a name="resolve-common-failback-issues"></a><span data-ttu-id="71f6b-324">解決常見容錯回復問題</span><span class="sxs-lookup"><span data-stu-id="71f6b-324">Resolve common failback issues</span></span>
* <span data-ttu-id="71f6b-325">如果您執行唯讀的使用者 vCenter 探索並保護虛擬機器，這樣會成功且容錯回復可作用。</span><span class="sxs-lookup"><span data-stu-id="71f6b-325">If you perform a read-only user vCenter discovery and protect virtual machines, it succeeds and failover works.</span></span> <span data-ttu-id="71f6b-326">在重新保護期間，容錯回復會失敗，因為無法探索資料存放區。</span><span class="sxs-lookup"><span data-stu-id="71f6b-326">During reprotection, failover fails because the datastores cannot be discovered.</span></span> <span data-ttu-id="71f6b-327">徵兆是重新保護期間不會列出資料存放區。</span><span class="sxs-lookup"><span data-stu-id="71f6b-327">As a symptom, you will not see the datastores listed during reprotection.</span></span> <span data-ttu-id="71f6b-328">若要解決此問題，您可以使用有適當權限的帳戶更新 vCenter 認證並重試作業。</span><span class="sxs-lookup"><span data-stu-id="71f6b-328">To resolve this issue, you can update the vCenter credential with an appropriate account that has permissions and retry the job.</span></span> <span data-ttu-id="71f6b-329">如需詳細資訊，請參閱[使用 Azure Site Recovery 將 VMWare 虛擬機器和實體伺服器複寫至 Azure](site-recovery-vmware-to-azure-classic.md)</span><span class="sxs-lookup"><span data-stu-id="71f6b-329">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md)</span></span>
* <span data-ttu-id="71f6b-330">當您將 Linux VM 容錯回復並在內部部署執行它時，您會看到 Network Manager 套件已從該機器解除安裝。</span><span class="sxs-lookup"><span data-stu-id="71f6b-330">When you fail back a Linux VM and run it on-premises, you can see that the Network Manager package has been uninstalled from the machine.</span></span> <span data-ttu-id="71f6b-331">發生此解除安裝的原因是，當在 Azure 中復原 VM 時，Network Manager 套件已被移除。</span><span class="sxs-lookup"><span data-stu-id="71f6b-331">This uninstallation happens because the Network Manager package is removed when the VM is recovered in Azure.</span></span>
* <span data-ttu-id="71f6b-332">當 VM 是以靜態 IP 位址設定且容錯移轉至 Azure 時，IP 位址是透過 DHCP 取得。</span><span class="sxs-lookup"><span data-stu-id="71f6b-332">When a VM is configured with a static IP address and is failed over to Azure, the IP address is acquired via DHCP.</span></span> <span data-ttu-id="71f6b-333">當您容錯移轉回內部部署時，該 VM 會繼續使用 DHCP 取得 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="71f6b-333">When you fail over back to on-premises, the VM continues to use DHCP to acquire the IP address.</span></span> <span data-ttu-id="71f6b-334">視需要手動登入機器，並將 IP 位址設定回靜態位址。</span><span class="sxs-lookup"><span data-stu-id="71f6b-334">Manually sign in to the machine and set the IP address back to a static address if necessary.</span></span>
* <span data-ttu-id="71f6b-335">如果您是使用 ESXi 5.5 免費版或 vSphere 6 Hypervisor 免費版，則容錯移轉會成功，但容錯回復不會成功。</span><span class="sxs-lookup"><span data-stu-id="71f6b-335">If you are using either ESXi 5.5 free edition or vSphere 6 Hypervisor free edition, failover would succeed, but failback would not succeed.</span></span> <span data-ttu-id="71f6b-336">若要啟用容錯回復，請升級到上述程式的評估授權。</span><span class="sxs-lookup"><span data-stu-id="71f6b-336">To enable failback, upgrade to either program's evaluation license.</span></span>
* <span data-ttu-id="71f6b-337">若無法從處理伺服器連線到組態伺服器，請嘗試使用 Telnet 連線到組態伺服器的連接埠 443，以檢查與組態伺服器之間的連線。</span><span class="sxs-lookup"><span data-stu-id="71f6b-337">If you cannot reach the configuration server from the Process Server, check connectivity to the configuration server by Telnet to the configuration server machine on port 443.</span></span> <span data-ttu-id="71f6b-338">您也可以嘗試從處理伺服器機器 Ping 組態伺服器。</span><span class="sxs-lookup"><span data-stu-id="71f6b-338">You can also try to ping the configuration server from the Process Server machine.</span></span> <span data-ttu-id="71f6b-339">當處理伺服器已連線到組態伺服器時，應該會有活動訊號。</span><span class="sxs-lookup"><span data-stu-id="71f6b-339">A Process Server should also have a heartbeat when it is connected to the configuration server.</span></span>
* <span data-ttu-id="71f6b-340">如果您要嘗試容錯回復至替代的 vCenter，請確定您的新 vCenter 已被探索到，而且主要目標伺服器也已被探索到。</span><span class="sxs-lookup"><span data-stu-id="71f6b-340">If you are trying to fail back to an alternate vCenter, make sure that your new vCenter is discovered and that the master target server is also discovered.</span></span> <span data-ttu-id="71f6b-341">一般的徵兆是，您會發現在 [重新保護] 對話方塊中無法存取/看到資料存放區。</span><span class="sxs-lookup"><span data-stu-id="71f6b-341">A typical symptom is that the datastores are not accessible or visible in the **Reprotect** dialog box.</span></span>
* <span data-ttu-id="71f6b-342">做為實體內部部署電腦保護的 WS2008R2SP1 電腦無法從 Azure 容錯回復到內部部署。</span><span class="sxs-lookup"><span data-stu-id="71f6b-342">A WS2008R2SP1 machine that is protected as a physical on-premises machine cannot be failed back from Azure to on-premises.</span></span>

## <a name="fail-back-with-expressroute"></a><span data-ttu-id="71f6b-343">透過 ExpressRoute 進行容錯回復</span><span class="sxs-lookup"><span data-stu-id="71f6b-343">Fail back with ExpressRoute</span></span>
<span data-ttu-id="71f6b-344">您可以透過 VPN 連線或 ExpressRoute 連線進行容錯回復。</span><span class="sxs-lookup"><span data-stu-id="71f6b-344">You can fail back over a VPN connection or by using an ExpressRoute connection.</span></span> <span data-ttu-id="71f6b-345">如果您想要使用 ExpressRoute 連線，請注意下列事項：</span><span class="sxs-lookup"><span data-stu-id="71f6b-345">If you want to use an ExpressRoute connection, note the following:</span></span>

* <span data-ttu-id="71f6b-346">ExpressRoute 連線應該設定在來源機器所要容錯移轉到的 Azure 虛擬網路上，以及容錯移轉發生時 Azure VM 所位於的 Azure 虛擬網路上。</span><span class="sxs-lookup"><span data-stu-id="71f6b-346">The ExpressRoute connection should be set up on the Azure virtual network that the source machines fail over to and where the Azure VMs are located after the failover occurs.</span></span>
* <span data-ttu-id="71f6b-347">資料會複寫至公用端點上的 Azure 儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="71f6b-347">Data is replicated to an Azure storage account on a public endpoint.</span></span> <span data-ttu-id="71f6b-348">若要使用 ExpressRoute 連線，請在 ExpressRoute 中設定與目標資料中心的公用對等互連以進行 Site Recovery 複寫才。</span><span class="sxs-lookup"><span data-stu-id="71f6b-348">To use an ExpressRoute connection, set up public peering in ExpressRoute with the target data center for Site Recovery replication.</span></span>
