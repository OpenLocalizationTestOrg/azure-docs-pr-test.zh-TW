---
title: "使用 SQL Server 和 Azure Site Recovery 複寫應用程式 | Microsoft Docs"
description: "本文說明如何使用適用於 SQL Server 災害復原功能的 Azure Site Recovery 來複寫 SQL Server。"
services: site-recovery
documentationcenter: 
author: prateek9us
manager: gauravd
editor: 
ms.assetid: 9126f5e8-e9ed-4c31-b6b4-bf969c12c184
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/11/2017
ms.author: pratshar
ms.openlocfilehash: e53f60979e01a0eabe118d3ae6457a61bd4b0ded
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/18/2017
---
# <a name="protect-sql-server-using-sql-server-disaster-recovery-and-azure-site-recovery"></a><span data-ttu-id="e9266-103">使用 SQL Server 災害復原和 Azure Site Recovery 保護 SQL Server</span><span class="sxs-lookup"><span data-stu-id="e9266-103">Protect SQL Server using SQL Server disaster recovery and Azure Site Recovery</span></span>

<span data-ttu-id="e9266-104">本文說明如何使用一套 SQL Server 商務持續性和災害復原 (BCDR) 技術，加上 [Azure Site Recovery](site-recovery-overview.md)，以保護應用程式的 SQL Server 後端。</span><span class="sxs-lookup"><span data-stu-id="e9266-104">This article describes how to protect the SQL Server back end of an application using a combination of SQL Server business continuity and disaster recovery (BCDR) technologies, and [Azure Site Recovery](site-recovery-overview.md).</span></span>

<span data-ttu-id="e9266-105">開始之前，請確定您了解 SQL Server 災害復原功能，包括容錯移轉叢集、Always On 可用性群組、資料庫鏡像和記錄傳送。</span><span class="sxs-lookup"><span data-stu-id="e9266-105">Before you start, make sure you understand SQL Server disaster recovery capabilities, including failover clustering, Always On availability groups, database mirroring, and log shipping.</span></span>


## <a name="sql-server-deployments"></a><span data-ttu-id="e9266-106">SQL Server 部署</span><span class="sxs-lookup"><span data-stu-id="e9266-106">SQL Server deployments</span></span>

<span data-ttu-id="e9266-107">許多工作負載都使用 SQL Server 做為基礎，還可以與 SharePoint、Dynamics 和 SAP 等應用程式整合，以實作資料服務。</span><span class="sxs-lookup"><span data-stu-id="e9266-107">Many workloads use SQL Server as a foundation, and it can be integrated with apps such as SharePoint, Dynamics, and SAP, to implement data services.</span></span>  <span data-ttu-id="e9266-108">有許多方法可以部署 SQL Server：</span><span class="sxs-lookup"><span data-stu-id="e9266-108">SQL Server can be deployed in a number of ways:</span></span>

* <span data-ttu-id="e9266-109">**獨立 SQL Server**：SQL Server 和所有資料庫都裝載在單一電腦 (實體或虛擬) 上。</span><span class="sxs-lookup"><span data-stu-id="e9266-109">**Standalone SQL Server**: SQL Server and all databases are hosted on a single machine (physical or a virtual).</span></span> <span data-ttu-id="e9266-110">如果是虛擬，則主機叢集用於高可用性。</span><span class="sxs-lookup"><span data-stu-id="e9266-110">When virtualized, host clustering is used for local high availability.</span></span> <span data-ttu-id="e9266-111">不實作來賓層級的高可用性。</span><span class="sxs-lookup"><span data-stu-id="e9266-111">Guest-level high availability isn't implemented.</span></span>
* <span data-ttu-id="e9266-112">**SQL Server 容錯移轉叢集執行個體 (Always ON FCI)**：在「Windows 容錯移轉」叢集中設定 2 個或更多個具有共用磁碟的 SQL Server 執行個體節點。</span><span class="sxs-lookup"><span data-stu-id="e9266-112">**SQL Server Failover Clustering Instances (Always On FCI)**: Two or more nodes running SQL Server instanced with shared disks are configured in a Windows Failover cluster.</span></span> <span data-ttu-id="e9266-113">如果有一個節點關閉，叢集可以將 SQL Server 容錯移轉至另一個執行個體。</span><span class="sxs-lookup"><span data-stu-id="e9266-113">If a node is down, the cluster can fail SQL Server over to another instance.</span></span> <span data-ttu-id="e9266-114">這項設定通常用在主要網站實作高可用性。</span><span class="sxs-lookup"><span data-stu-id="e9266-114">This setup is typically used to implement high availability at a primary site.</span></span> <span data-ttu-id="e9266-115">這種部署無法防止共用儲存體層中發生失敗或中斷。</span><span class="sxs-lookup"><span data-stu-id="e9266-115">This deployment doesn't protect against failure or outage in the shared storage layer.</span></span> <span data-ttu-id="e9266-116">共用磁碟可以使用 iSCSI、光纖通道或共用 vhdx 來實作。</span><span class="sxs-lookup"><span data-stu-id="e9266-116">A shared disk can be implemented using iSCSI, fiber channel or shared vhdx.</span></span>
* <span data-ttu-id="e9266-117">**SQL Always On 可用性群組**：在不共用任何內容的叢集中設定兩個節點，其中此叢集的 SQL Server 資料庫是設定在具有同步複寫和自動容錯移轉功能的可用性群組中。</span><span class="sxs-lookup"><span data-stu-id="e9266-117">**SQL Always On Availability Groups**: Two or more nodes are set up in a shared nothing cluster, with SQL Server databases configured in an availability group, with synchronous replication and automatic failover.</span></span>

 <span data-ttu-id="e9266-118">本文利用下列原生 SQL 災害復原技術，將資料庫復原至遠端網站︰</span><span class="sxs-lookup"><span data-stu-id="e9266-118">This article leverages the following native SQL disaster recovery technologies for recovering databases to a remote site:</span></span>

* <span data-ttu-id="e9266-119">支援 SQL Server 2012 或 2014 Enterprise 版本之災害復原的「SQL AlwaysOn 可用性群組」。</span><span class="sxs-lookup"><span data-stu-id="e9266-119">SQL Always On Availability Groups, to provide for disaster recovery for SQL Server 2012 or 2014 Enterprise editions.</span></span>
* <span data-ttu-id="e9266-120">SQL Server Standard 版本 (任何版本) 或 SQL Server 2008 R2 的高安全性模式「SQL 資料庫鏡像」。</span><span class="sxs-lookup"><span data-stu-id="e9266-120">SQL database mirroring in high safety mode, for SQL Server Standard edition (any version), or for SQL Server 2008 R2.</span></span>

## <a name="site-recovery-support"></a><span data-ttu-id="e9266-121">Site Recovery 支援</span><span class="sxs-lookup"><span data-stu-id="e9266-121">Site Recovery support</span></span>

### <a name="supported-scenarios"></a><span data-ttu-id="e9266-122">支援的案例</span><span class="sxs-lookup"><span data-stu-id="e9266-122">Supported scenarios</span></span>
<span data-ttu-id="e9266-123">資料表中摘要說明 Site Recovery 可以保護 SQL Server。</span><span class="sxs-lookup"><span data-stu-id="e9266-123">Site Recovery can protect SQL Server as summarized in the table.</span></span>

<span data-ttu-id="e9266-124">**案例**</span><span class="sxs-lookup"><span data-stu-id="e9266-124">**Scenario**</span></span> | <span data-ttu-id="e9266-125">**至次要網站**</span><span class="sxs-lookup"><span data-stu-id="e9266-125">**To a secondary site**</span></span> | <span data-ttu-id="e9266-126">**至 Azure**</span><span class="sxs-lookup"><span data-stu-id="e9266-126">**To Azure**</span></span>
--- | --- | ---
<span data-ttu-id="e9266-127">**Hyper-V**</span><span class="sxs-lookup"><span data-stu-id="e9266-127">**Hyper-V**</span></span> | <span data-ttu-id="e9266-128">是</span><span class="sxs-lookup"><span data-stu-id="e9266-128">Yes</span></span> | <span data-ttu-id="e9266-129">是</span><span class="sxs-lookup"><span data-stu-id="e9266-129">Yes</span></span>
<span data-ttu-id="e9266-130">**VMware**</span><span class="sxs-lookup"><span data-stu-id="e9266-130">**VMware**</span></span> | <span data-ttu-id="e9266-131">是</span><span class="sxs-lookup"><span data-stu-id="e9266-131">Yes</span></span> | <span data-ttu-id="e9266-132">是</span><span class="sxs-lookup"><span data-stu-id="e9266-132">Yes</span></span>
<span data-ttu-id="e9266-133">**實體伺服器**</span><span class="sxs-lookup"><span data-stu-id="e9266-133">**Physical server**</span></span> | <span data-ttu-id="e9266-134">是</span><span class="sxs-lookup"><span data-stu-id="e9266-134">Yes</span></span> | <span data-ttu-id="e9266-135">是</span><span class="sxs-lookup"><span data-stu-id="e9266-135">Yes</span></span>

### <a name="supported-sql-server-versions"></a><span data-ttu-id="e9266-136">支援的 SQL Server 版本</span><span class="sxs-lookup"><span data-stu-id="e9266-136">Supported SQL Server versions</span></span>
<span data-ttu-id="e9266-137">在支援的案例中，支援這些 SQL Server 版本：</span><span class="sxs-lookup"><span data-stu-id="e9266-137">These SQL Server versions are supported, for the supported scenarios:</span></span>

* <span data-ttu-id="e9266-138">SQL Server 2016 Enterprise 和 Standard</span><span class="sxs-lookup"><span data-stu-id="e9266-138">SQL Server 2016 Enterprise and Standard</span></span>
* <span data-ttu-id="e9266-139">SQL Server 2014 Enterprise 和 Standard</span><span class="sxs-lookup"><span data-stu-id="e9266-139">SQL Server 2014 Enterprise and Standard</span></span>
* <span data-ttu-id="e9266-140">SQL Server 2012 Enterprise 和 Standard</span><span class="sxs-lookup"><span data-stu-id="e9266-140">SQL Server 2012 Enterprise and Standard</span></span>
* <span data-ttu-id="e9266-141">SQL Server 2008 R2 Enterprise 和 Standard</span><span class="sxs-lookup"><span data-stu-id="e9266-141">SQL Server 2008 R2 Enterprise and Standard</span></span>

### <a name="supported-sql-server-integration"></a><span data-ttu-id="e9266-142">支援的 SQL Server 整合</span><span class="sxs-lookup"><span data-stu-id="e9266-142">Supported SQL Server integration</span></span>

<span data-ttu-id="e9266-143">Site Recovery 可以與資料表中摘要說明的原生 SQL Server BCDR 技術整合，以提供災害復原解決方案。</span><span class="sxs-lookup"><span data-stu-id="e9266-143">Site Recovery can be integrated with native SQL Server BCDR technologies summarized in the table, to provide a disaster recovery solution.</span></span>

<span data-ttu-id="e9266-144">**功能**</span><span class="sxs-lookup"><span data-stu-id="e9266-144">**Feature**</span></span> | <span data-ttu-id="e9266-145">**詳細資料**</span><span class="sxs-lookup"><span data-stu-id="e9266-145">**Details**</span></span> | <span data-ttu-id="e9266-146">**SQL Server**</span><span class="sxs-lookup"><span data-stu-id="e9266-146">**SQL Server**</span></span> |
--- | --- | ---
<span data-ttu-id="e9266-147">**Always On 可用性群組**</span><span class="sxs-lookup"><span data-stu-id="e9266-147">**Always On availability group**</span></span> | <span data-ttu-id="e9266-148">多個 SQL Server 獨立執行個體中，每個都在含有多個節點的容錯移轉叢集中執行。</span><span class="sxs-lookup"><span data-stu-id="e9266-148">Multiple standalone instances of SQL Server each run in a failover cluster that has multiple nodes.</span></span><br/><br/><span data-ttu-id="e9266-149">資料庫可以分組到可以在 SQL Server 執行個體上複製 (鏡像) 的容錯移轉群組，因此不需要任何共用儲存體。</span><span class="sxs-lookup"><span data-stu-id="e9266-149">Databases can be grouped into failover groups that can be copied (mirrored) on SQL Server instances so that no shared storage is needed.</span></span><br/><br/><span data-ttu-id="e9266-150">在主要站台與一或多個次要站台之間提供災害復原功能。</span><span class="sxs-lookup"><span data-stu-id="e9266-150">Provides disaster recovery between a primary site and one or more secondary sites.</span></span> <span data-ttu-id="e9266-151">使用同步複寫與自動容錯移轉在可用性群組中設定 SQL Server 資料庫時，可以在不共用任何內容的叢集中設定兩個節點。</span><span class="sxs-lookup"><span data-stu-id="e9266-151">Two nodes can be set up in a shared nothing cluster with SQL Server databases configured in an availability group with synchronous replication and automatic failover.</span></span> | <span data-ttu-id="e9266-152">SQL Server 2014 和 2012 Enterprise 版本</span><span class="sxs-lookup"><span data-stu-id="e9266-152">SQL Server 2014 & 2012 Enterprise edition</span></span>
<span data-ttu-id="e9266-153">**容錯移轉叢集 (Always On FCI)**</span><span class="sxs-lookup"><span data-stu-id="e9266-153">**Failover clustering (Always On FCI)**</span></span> | <span data-ttu-id="e9266-154">SQL Server 會針對內部部署 SQL Server 工作負載的高可用性，運用 Windows 容錯移轉叢集。</span><span class="sxs-lookup"><span data-stu-id="e9266-154">SQL Server leverages Windows failover clustering for high availability of on-premises SQL Server workloads.</span></span><br/><br/><span data-ttu-id="e9266-155">使用共用磁碟執行 SQL Server 執行個體的節點是在容錯移轉叢集中設定。</span><span class="sxs-lookup"><span data-stu-id="e9266-155">Nodes running instances of SQL Server with shared disks are configured in a failover cluster.</span></span> <span data-ttu-id="e9266-156">如果執行個體關閉，叢集會容錯移轉至另一個節點。</span><span class="sxs-lookup"><span data-stu-id="e9266-156">If an instance is down the cluster fails over to different one.</span></span><br/><br/><span data-ttu-id="e9266-157">叢集無法防止共用儲存體失敗或中斷。</span><span class="sxs-lookup"><span data-stu-id="e9266-157">The cluster doesn't protect against failure or outages in shared storage.</span></span> <span data-ttu-id="e9266-158">共用磁碟可以使用 iSCSI、光纖通道或共用 VHDX 實作。</span><span class="sxs-lookup"><span data-stu-id="e9266-158">The shared disk can be implemented with iSCSI, fiber channel, or shared VHDXs.</span></span> | <span data-ttu-id="e9266-159">SQL Server Enterprise Edition</span><span class="sxs-lookup"><span data-stu-id="e9266-159">SQL Server Enterprise editions</span></span><br/><br/><span data-ttu-id="e9266-160">SQL Server Standard 版本 (僅限兩個節點)</span><span class="sxs-lookup"><span data-stu-id="e9266-160">SQL Server Standard edition (limited to two nodes only)</span></span>
<span data-ttu-id="e9266-161">**資料庫鏡像 (高安全性模式)**</span><span class="sxs-lookup"><span data-stu-id="e9266-161">**Database mirroring (high safety mode)**</span></span> | <span data-ttu-id="e9266-162">將單一資料庫保護為單一次要複本。</span><span class="sxs-lookup"><span data-stu-id="e9266-162">Protects a single database to a single secondary copy.</span></span> <span data-ttu-id="e9266-163">提供高安全性 (同步) 和高效能 (非同步) 複寫模式。</span><span class="sxs-lookup"><span data-stu-id="e9266-163">Available in both high safety (synchronous) and high performance (asynchronous) replication modes.</span></span> <span data-ttu-id="e9266-164">不需要容錯移轉叢集。</span><span class="sxs-lookup"><span data-stu-id="e9266-164">Doesn’t require a failover cluster.</span></span> | <span data-ttu-id="e9266-165">SQL Server 2008 R2</span><span class="sxs-lookup"><span data-stu-id="e9266-165">SQL Server 2008 R2</span></span><br/><br/><span data-ttu-id="e9266-166">SQL Server Enterprise 所有版本</span><span class="sxs-lookup"><span data-stu-id="e9266-166">SQL Server Enterprise all editions</span></span>
<span data-ttu-id="e9266-167">**獨立式 SQL Server**</span><span class="sxs-lookup"><span data-stu-id="e9266-167">**Standalone SQL Server**</span></span> | <span data-ttu-id="e9266-168">SQL Server 和資料庫裝載在單一伺服器 (實體或虛擬) 上。</span><span class="sxs-lookup"><span data-stu-id="e9266-168">The SQL Server and database are hosted on a single server (physical or virtual).</span></span> <span data-ttu-id="e9266-169">如果是虛擬伺服器，則主機叢集用於高可用性。</span><span class="sxs-lookup"><span data-stu-id="e9266-169">Host clustering is used for high availability if the server is virtual.</span></span> <span data-ttu-id="e9266-170">沒有來賓層級的高可用性。</span><span class="sxs-lookup"><span data-stu-id="e9266-170">No guest-level high availability.</span></span> | <span data-ttu-id="e9266-171">Enterprise 或 Standard Edition</span><span class="sxs-lookup"><span data-stu-id="e9266-171">Enterprise or Standard edition</span></span>

## <a name="deployment-recommendations"></a><span data-ttu-id="e9266-172">部署建議</span><span class="sxs-lookup"><span data-stu-id="e9266-172">Deployment recommendations</span></span>

<span data-ttu-id="e9266-173">下表摘要說明我們將 SQL Server BCDR 技術與 Site Recovery 整合的建議。</span><span class="sxs-lookup"><span data-stu-id="e9266-173">This table summarizes our recommendations for integrating SQL Server BCDR technologies with Site Recovery.</span></span>

| <span data-ttu-id="e9266-174">**版本**</span><span class="sxs-lookup"><span data-stu-id="e9266-174">**Version**</span></span> | <span data-ttu-id="e9266-175">**版本**</span><span class="sxs-lookup"><span data-stu-id="e9266-175">**Edition**</span></span> | <span data-ttu-id="e9266-176">**部署**</span><span class="sxs-lookup"><span data-stu-id="e9266-176">**Deployment**</span></span> | <span data-ttu-id="e9266-177">**內部部署到內部部置**</span><span class="sxs-lookup"><span data-stu-id="e9266-177">**On-prem to on-prem**</span></span> | <span data-ttu-id="e9266-178">**內部部署到 Azure**</span><span class="sxs-lookup"><span data-stu-id="e9266-178">**On-prem to Azure**</span></span> |
| --- | --- | --- | --- | --- |
| <span data-ttu-id="e9266-179">SQL Server 2014 或 2012</span><span class="sxs-lookup"><span data-stu-id="e9266-179">SQL Server 2014 or 2012</span></span> |<span data-ttu-id="e9266-180">Enterprise</span><span class="sxs-lookup"><span data-stu-id="e9266-180">Enterprise</span></span> |<span data-ttu-id="e9266-181">容錯移轉叢集執行個體</span><span class="sxs-lookup"><span data-stu-id="e9266-181">Failover cluster instance</span></span> |<span data-ttu-id="e9266-182">Always On 可用性群組</span><span class="sxs-lookup"><span data-stu-id="e9266-182">Always On availability groups</span></span> |<span data-ttu-id="e9266-183">Always On 可用性群組</span><span class="sxs-lookup"><span data-stu-id="e9266-183">Always On availability groups</span></span> |
|| <span data-ttu-id="e9266-184">Enterprise</span><span class="sxs-lookup"><span data-stu-id="e9266-184">Enterprise</span></span> |<span data-ttu-id="e9266-185">高可用性的 Always On 可用性群組</span><span class="sxs-lookup"><span data-stu-id="e9266-185">Always On availability groups for high availability</span></span> |<span data-ttu-id="e9266-186">Always On 可用性群組</span><span class="sxs-lookup"><span data-stu-id="e9266-186">Always On availability groups</span></span> |<span data-ttu-id="e9266-187">Always On 可用性群組</span><span class="sxs-lookup"><span data-stu-id="e9266-187">Always On availability groups</span></span> | |
|| <span data-ttu-id="e9266-188">標準</span><span class="sxs-lookup"><span data-stu-id="e9266-188">Standard</span></span> |<span data-ttu-id="e9266-189">容錯移轉叢集執行個體 (FCI)</span><span class="sxs-lookup"><span data-stu-id="e9266-189">Failover cluster instance (FCI)</span></span> |<span data-ttu-id="e9266-190">包含本機鏡像的 Site Recovery 複寫</span><span class="sxs-lookup"><span data-stu-id="e9266-190">Site Recovery replication with local mirror</span></span> |<span data-ttu-id="e9266-191">包含本機鏡像的 Site Recovery 複寫</span><span class="sxs-lookup"><span data-stu-id="e9266-191">Site Recovery replication with local mirror</span></span> | |
|| <span data-ttu-id="e9266-192">Enterprise 或 Standard</span><span class="sxs-lookup"><span data-stu-id="e9266-192">Enterprise or Standard</span></span> |<span data-ttu-id="e9266-193">獨立</span><span class="sxs-lookup"><span data-stu-id="e9266-193">Standalone</span></span> |<span data-ttu-id="e9266-194">Site Recovery 複寫</span><span class="sxs-lookup"><span data-stu-id="e9266-194">Site Recovery replication</span></span> |<span data-ttu-id="e9266-195">Site Recovery 複寫</span><span class="sxs-lookup"><span data-stu-id="e9266-195">Site Recovery replication</span></span> | |
| <span data-ttu-id="e9266-196">SQL Server 2008 R2 或 2008</span><span class="sxs-lookup"><span data-stu-id="e9266-196">SQL Server 2008 R2 or 2008</span></span> |<span data-ttu-id="e9266-197">Enterprise 或 Standard</span><span class="sxs-lookup"><span data-stu-id="e9266-197">Enterprise or Standard</span></span> |<span data-ttu-id="e9266-198">容錯移轉叢集執行個體 (FCI)</span><span class="sxs-lookup"><span data-stu-id="e9266-198">Failover cluster instance (FCI)</span></span> |<span data-ttu-id="e9266-199">包含本機鏡像的 Site Recovery 複寫</span><span class="sxs-lookup"><span data-stu-id="e9266-199">Site Recovery replication with local mirror</span></span> |<span data-ttu-id="e9266-200">包含本機鏡像的 Site Recovery 複寫</span><span class="sxs-lookup"><span data-stu-id="e9266-200">Site Recovery replication with local mirror</span></span> |
|| <span data-ttu-id="e9266-201">Enterprise 或 Standard</span><span class="sxs-lookup"><span data-stu-id="e9266-201">Enterprise or Standard</span></span> |<span data-ttu-id="e9266-202">獨立</span><span class="sxs-lookup"><span data-stu-id="e9266-202">Standalone</span></span> |<span data-ttu-id="e9266-203">Site Recovery 複寫</span><span class="sxs-lookup"><span data-stu-id="e9266-203">Site Recovery replication</span></span> |<span data-ttu-id="e9266-204">Site Recovery 複寫</span><span class="sxs-lookup"><span data-stu-id="e9266-204">Site Recovery replication</span></span> | |
| <span data-ttu-id="e9266-205">SQL Server (任何版本)</span><span class="sxs-lookup"><span data-stu-id="e9266-205">SQL Server (Any version)</span></span> |<span data-ttu-id="e9266-206">Enterprise 或 Standard</span><span class="sxs-lookup"><span data-stu-id="e9266-206">Enterprise or Standard</span></span> |<span data-ttu-id="e9266-207">容錯移轉叢集執行個體 - DTC 應用程式</span><span class="sxs-lookup"><span data-stu-id="e9266-207">Failover cluster instance - DTC application</span></span> |<span data-ttu-id="e9266-208">Site Recovery 複寫</span><span class="sxs-lookup"><span data-stu-id="e9266-208">Site Recovery replication</span></span> |<span data-ttu-id="e9266-209">不支援</span><span class="sxs-lookup"><span data-stu-id="e9266-209">Not Supported</span></span> |

## <a name="deployment-prerequisites"></a><span data-ttu-id="e9266-210">部署必要條件</span><span class="sxs-lookup"><span data-stu-id="e9266-210">Deployment prerequisites</span></span>

* <span data-ttu-id="e9266-211">執行支援的 SQL Server 版本的內部部署 SQL Server 部署。</span><span class="sxs-lookup"><span data-stu-id="e9266-211">An on-premises SQL Server deployment, running a supported SQL Server version.</span></span> <span data-ttu-id="e9266-212">通常，您的 SQL Server 也需要 Active Directory。</span><span class="sxs-lookup"><span data-stu-id="e9266-212">Typically, you also need Active Directory for your SQL server.</span></span>
* <span data-ttu-id="e9266-213">您要部署之案例的需求。</span><span class="sxs-lookup"><span data-stu-id="e9266-213">The requirements for the scenario you want to deploy.</span></span> <span data-ttu-id="e9266-214">深入了解[複寫至 Azure](site-recovery-support-matrix-to-azure.md) 和[內部部署](site-recovery-support-matrix.md)的支援需求，以及[部署必要條件](site-recovery-prereq.md)。</span><span class="sxs-lookup"><span data-stu-id="e9266-214">Learn more about support requirements for [replication to Azure](site-recovery-support-matrix-to-azure.md) and [on-premises](site-recovery-support-matrix.md), and [deployment prerequisites](site-recovery-prereq.md).</span></span>
* <span data-ttu-id="e9266-215">如果要在 Azure 中設定復原，請在您的 SQL Server 虛擬機器上執行 [Azure 虛擬機器整備評估](http://www.microsoft.com/download/details.aspx?id=40898)工具，以確定它們與 Azure 和 Site Recovery 相容。</span><span class="sxs-lookup"><span data-stu-id="e9266-215">To set up recovery in Azure, run the [Azure Virtual Machine Readiness Assessment](http://www.microsoft.com/download/details.aspx?id=40898) tool on your SQL Server virtual machines, to make sure they're compatible with Azure and Site Recovery.</span></span>

## <a name="set-up-active-directory"></a><span data-ttu-id="e9266-216">設定 Active Directory</span><span class="sxs-lookup"><span data-stu-id="e9266-216">Set up Active Directory</span></span>

<span data-ttu-id="e9266-217">在次要復原網站上設定 Active Directory，讓 SQL Server 正常運作。</span><span class="sxs-lookup"><span data-stu-id="e9266-217">Set up Active Directory, in the secondary recovery site, for SQL Server to run properly.</span></span>

* <span data-ttu-id="e9266-218">**小型企業** — 如果只有少數應用程式，且內部部署網站只有一個網域控制站，當您想要容錯移轉整個網站時，建議您使用 Site Recovery 複寫，將網域控制站複寫至次要資料中心或 Azure。</span><span class="sxs-lookup"><span data-stu-id="e9266-218">**Small enterprise**—With a small number of applications, and single domain controller for the on-premises site, if you want to fail over the entire site, we recommend you use Site Recovery replication to replicate the domain controller to the secondary datacenter, or to Azure.</span></span>
* <span data-ttu-id="e9266-219">**中大型企業** — 如果您有大量的應用程式和一個 Active Directory 樹系，而您想要依應用程式或工作負載容錯移轉，建議您在次要資料中心或 Azure 中設定其他網域控制站。</span><span class="sxs-lookup"><span data-stu-id="e9266-219">**Medium to large enterprise**—If you have a large number of applications, an Active Directory forest, and you want to fail over by application or workload, we recommend you set up an additional domain controller in the secondary datacenter, or in Azure.</span></span> <span data-ttu-id="e9266-220">如果您使用 Always On 可用性群組復原至遠端網站，建議您在次要網站或 Azure 上設定其他不同的網域控制站，供已復原的 SQL Server 執行個體使用。</span><span class="sxs-lookup"><span data-stu-id="e9266-220">If you're using Always On availability groups to recover to a remote site, we recommend you set up another additional domain controller on the secondary site or in Azure, to use for the recovered SQL Server instance.</span></span>

<span data-ttu-id="e9266-221">本文中的指示假設在次要位置中有網域控制站。</span><span class="sxs-lookup"><span data-stu-id="e9266-221">The instructions in this article presume that a domain controller is available in the secondary location.</span></span> <span data-ttu-id="e9266-222">[閱讀更多](site-recovery-active-directory.md) 有關使用 Site Recovery 保護 Active Directory。</span><span class="sxs-lookup"><span data-stu-id="e9266-222">[Read more](site-recovery-active-directory.md) about protecting Active Directory with Site Recovery.</span></span>


## <a name="integrate-with-sql-server-always-on-for-replication-to-azure"></a><span data-ttu-id="e9266-223">與 SQL Server Always On 整合以複寫至 Azure</span><span class="sxs-lookup"><span data-stu-id="e9266-223">Integrate with SQL Server Always On for replication to Azure</span></span>

<span data-ttu-id="e9266-224">以下是您需要採取的動作：</span><span class="sxs-lookup"><span data-stu-id="e9266-224">Here's what you need to do:</span></span>

1. <span data-ttu-id="e9266-225">將指令碼匯入您的 Azure 自動化帳戶。</span><span class="sxs-lookup"><span data-stu-id="e9266-225">Import scripts into your Azure Automation account.</span></span> <span data-ttu-id="e9266-226">這包括用於將 [Resource Manager 虛擬機器](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAG.ps1)和[傳統虛擬機器](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAGClassic.ps1)中的 SQL 可用性群組容錯移轉的指令碼。</span><span class="sxs-lookup"><span data-stu-id="e9266-226">This contains the scripts to failover SQL Availability Group in a [Resource Manager virtual machine](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAG.ps1) and a [Classic virtual machine](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/asr-automation-recovery/scripts/ASR-SQL-FailoverAGClassic.ps1).</span></span>

    <span data-ttu-id="e9266-227">[![部署至 Azure](https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c4803408-340e-49e3-9a1f-0ed3f689813d.png)](https://aka.ms/asr-automationrunbooks-deploy)</span><span class="sxs-lookup"><span data-stu-id="e9266-227">[![Deploy to Azure](https://azurecomcdn.azureedge.net/mediahandler/acomblog/media/Default/blog/c4803408-340e-49e3-9a1f-0ed3f689813d.png)](https://aka.ms/asr-automationrunbooks-deploy)</span></span>


1. <span data-ttu-id="e9266-228">新增 ASR-SQL-FailoverAG 作為復原方案第一個群組的前置動作。</span><span class="sxs-lookup"><span data-stu-id="e9266-228">Add ASR-SQL-FailoverAG as a pre action of the first group of the recovery plan.</span></span>

1. <span data-ttu-id="e9266-229">依照指令碼中的指示建立自動化變數，以提供可用性群組的名稱。</span><span class="sxs-lookup"><span data-stu-id="e9266-229">Follow the instructions available in the script to create an automation variable to provide the name of the availability groups.</span></span>

### <a name="steps-to-do-a-test-failover"></a><span data-ttu-id="e9266-230">測試容錯移轉的步驟</span><span class="sxs-lookup"><span data-stu-id="e9266-230">Steps to do a test failover</span></span>

<span data-ttu-id="e9266-231">SQL Always On 原本就不支援測試容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="e9266-231">SQL Always On doesn’t natively support test failover.</span></span> <span data-ttu-id="e9266-232">因此，我們建議您採取下列動作︰</span><span class="sxs-lookup"><span data-stu-id="e9266-232">Therefore, we recommend the following:</span></span>

1. <span data-ttu-id="e9266-233">在 Azure 中裝載可用性群組複本的虛擬機器上，設定 [Azure 備份](../backup/backup-azure-vms.md)。</span><span class="sxs-lookup"><span data-stu-id="e9266-233">Set up [Azure Backup](../backup/backup-azure-vms.md) on the virtual machine that hosts the availability group replica in Azure.</span></span>

1. <span data-ttu-id="e9266-234">觸發復原計劃的測試容錯移轉之前，從上一步所使用的備份來復原虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="e9266-234">Before triggering test failover of the recovery plan, recover the virtual machine from the backup taken in the previous step.</span></span>

    ![<span data-ttu-id="e9266-235">從 Azure 備份還原</span><span class="sxs-lookup"><span data-stu-id="e9266-235">Restore from Azure Backup</span></span> ](./media/site-recovery-sql/restore-from-backup.png)

1. <span data-ttu-id="e9266-236">在從備份還原的虛擬機器中[強制仲裁](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum#PowerShellProcedure)。</span><span class="sxs-lookup"><span data-stu-id="e9266-236">[Force a quorum](https://docs.microsoft.com/sql/sql-server/failover-clusters/windows/force-a-wsfc-cluster-to-start-without-a-quorum#PowerShellProcedure) in the virtual machine restored from backup.</span></span>

1. <span data-ttu-id="e9266-237">將接聽程式的 IP 更新為測試容錯移轉網路中可用的 IP 的。</span><span class="sxs-lookup"><span data-stu-id="e9266-237">Update IP of the listener to an IP available in the test failover network.</span></span>

    ![更新接聽程式 IP](./media/site-recovery-sql/update-listener-ip.png)

1. <span data-ttu-id="e9266-239">使接聽程式上線。</span><span class="sxs-lookup"><span data-stu-id="e9266-239">Bring listener online.</span></span>

    ![使接聽程式上線](./media/site-recovery-sql/bring-listener-online.png)

1. <span data-ttu-id="e9266-241">使用一個 IP 和 SQL 虛擬機器建立負載平衡器；此 IP 是對應至每個可用性群組接聽程式的前端 IP 集區下的 IP，而是虛擬機器是在後端集區中新增的 SQL 虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="e9266-241">Create a load balancer with one IP created under frontend IP pool corresponding to each availability group listener and with the SQL virtual machine added in the backend pool.</span></span>

     ![<span data-ttu-id="e9266-242">建立負載平衡器 - 前端 IP 集區</span><span class="sxs-lookup"><span data-stu-id="e9266-242">Create Load Balancer - Frontend IP pool</span></span> ](./media/site-recovery-sql/create-load-balancer1.png)

    ![<span data-ttu-id="e9266-243">建立負載平衡器 - 後端集區</span><span class="sxs-lookup"><span data-stu-id="e9266-243">Create Load Balancer - Backend pool</span></span> ](./media/site-recovery-sql/create-load-balancer2.png)

1. <span data-ttu-id="e9266-244">執行復原計劃的測試容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="e9266-244">Do a test failover of the recovery plan.</span></span>

### <a name="steps-to-do-a-failover"></a><span data-ttu-id="e9266-245">進行容錯移轉的步驟</span><span class="sxs-lookup"><span data-stu-id="e9266-245">Steps to do a failover</span></span>

<span data-ttu-id="e9266-246">一旦您已在復原方案中新增指令碼，並已執行測試容錯移轉驗證過復原計劃執行，便可以進行復原計劃的容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="e9266-246">Once you have added the script in the recovery plan and validated the recovery plan by doing a test failover, you can do failover of the recovery plan.</span></span>


## <a name="integrate-with-sql-server-always-on-for-replication-to-a-secondary-on-premises-site"></a><span data-ttu-id="e9266-247">與 SQL Server Always On 整合以複寫至次要內部部署網站</span><span class="sxs-lookup"><span data-stu-id="e9266-247">Integrate with SQL Server Always On for replication to a secondary on-premises site</span></span>

<span data-ttu-id="e9266-248">如果 SQL Server 為了高可用性而使用可用性群組 (或 FCI)，建議您也在復原網站上使用可用性群組。</span><span class="sxs-lookup"><span data-stu-id="e9266-248">If the SQL Server is using availability groups for high availability (or an FCI), we recommend using availability groups on the recovery site as well.</span></span> <span data-ttu-id="e9266-249">請注意，這適用於不使用分散式交易的應用程式。</span><span class="sxs-lookup"><span data-stu-id="e9266-249">Note that this applies to apps that don't use distributed transactions.</span></span>

1. <span data-ttu-id="e9266-250">[設定資料庫](https://msdn.microsoft.com/library/hh213078.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="e9266-250">[Configure databases](https://msdn.microsoft.com/library/hh213078.aspx) into availability groups.</span></span>
1. <span data-ttu-id="e9266-251">在次要網站上建立虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="e9266-251">Create a virtual network on the secondary site.</span></span>
1. <span data-ttu-id="e9266-252">在虛擬網路和主要網站之間設定網站間 VPN 連線。</span><span class="sxs-lookup"><span data-stu-id="e9266-252">Set up a site-to-site VPN connection between the virtual network, and the primary site.</span></span>
1. <span data-ttu-id="e9266-253">在復原網站上建立虛擬機器，並在此虛擬機器上安裝 SQL Server。</span><span class="sxs-lookup"><span data-stu-id="e9266-253">Create a virtual machine on the recovery site, and install SQL Server on it.</span></span>
1. <span data-ttu-id="e9266-254">將現有的 Always On 可用性群組擴充至新的 SQL Server VM。</span><span class="sxs-lookup"><span data-stu-id="e9266-254">Extend the existing Always On availability groups to the new SQL Server VM.</span></span> <span data-ttu-id="e9266-255">將此 SQL Server 執行個體設定為非同步複本。</span><span class="sxs-lookup"><span data-stu-id="e9266-255">Configure this SQL Server instance as an asynchronous replica copy.</span></span>
1. <span data-ttu-id="e9266-256">建立可用性群組接聽程式，或更新現有的接聽程式，以包含非同步複本虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="e9266-256">Create an availability group listener, or update the existing listener to include the asynchronous replica virtual machine.</span></span>
1. <span data-ttu-id="e9266-257">請確定應用程式伺服器陣列是使用接聽程式來設定。</span><span class="sxs-lookup"><span data-stu-id="e9266-257">Make sure that the application farm is set up using the listener.</span></span> <span data-ttu-id="e9266-258">如果是使用資料庫伺服器名稱來設定，請更新為使用接聽程式，如此您就不需要在容錯移轉後重新設定。</span><span class="sxs-lookup"><span data-stu-id="e9266-258">If it's setup up using the database server name, update it to use the listener, so you don't need to reconfigure it after the failover.</span></span>

<span data-ttu-id="e9266-259">對於使用分散式交易的應用程式，建議您使用 [VMware/實體伺服器站對站複寫](site-recovery-vmware-to-vmware.md)來部署 Site Recovery。</span><span class="sxs-lookup"><span data-stu-id="e9266-259">For applications that use distributed transactions, we recommend you deploy Site Recovery with [VMware/physical server site-to-site replication](site-recovery-vmware-to-vmware.md).</span></span>

### <a name="recovery-plan-considerations"></a><span data-ttu-id="e9266-260">復原計畫考量</span><span class="sxs-lookup"><span data-stu-id="e9266-260">Recovery plan considerations</span></span>
1. <span data-ttu-id="e9266-261">將此範例指令碼新增至主要和次要網站上的 VMM 程式庫。</span><span class="sxs-lookup"><span data-stu-id="e9266-261">Add this sample script to the VMM library, on the primary and secondary sites.</span></span>

        Param(
        [string]$SQLAvailabilityGroupPath
        )
        import-module sqlps
        Switch-SqlAvailabilityGroup -Path $SQLAvailabilityGroupPath -AllowDataLoss -force

1. <span data-ttu-id="e9266-262">當您建立應用程式的復原計畫時，將前置動作加入 Group-1 的指令碼步驟，以叫用指令碼來容錯移轉可用性群組。</span><span class="sxs-lookup"><span data-stu-id="e9266-262">When you create a recovery plan for the application, add a pre action to Group-1 scripted step, that invokes the script to fail over availability groups.</span></span>

## <a name="protect-a-standalone-sql-server"></a><span data-ttu-id="e9266-263">保護獨立式 SQL Server</span><span class="sxs-lookup"><span data-stu-id="e9266-263">Protect a standalone SQL Server</span></span>

<span data-ttu-id="e9266-264">在此案例中，建議您使用 Site Recovery 複寫保護 SQL Server 電腦。</span><span class="sxs-lookup"><span data-stu-id="e9266-264">In this scenario, we recommend that you use Site Recovery replication to protect the SQL Server machine.</span></span> <span data-ttu-id="e9266-265">確切步驟將取決於 SQL Server 是 VM 還是實體伺服器，以及您想要複寫至 Azure 還是次要內部部署網站。</span><span class="sxs-lookup"><span data-stu-id="e9266-265">The exact steps will depend whether SQL Server is a VM or a physical server, and whether you want to replicate to Azure or a secondary on-premises site.</span></span> <span data-ttu-id="e9266-266">了解 [Site Recovery 案例](site-recovery-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="e9266-266">Learn about [Site Recovery scenarios](site-recovery-overview.md).</span></span>

## <a name="protect-a-sql-server-cluster-standard-editionwindows-server-2008-r2"></a><span data-ttu-id="e9266-267">保護 SQL Server 叢集 (標準版/Windows Server 2008 R2)</span><span class="sxs-lookup"><span data-stu-id="e9266-267">Protect a SQL Server cluster (standard edition/Windows Server 2008 R2)</span></span>

<span data-ttu-id="e9266-268">對於執行 SQL Server Standard Edition 或 SQL Server 2008 R2 的叢集，建議您使用 Site Recovery 複寫保護 SQL Server。</span><span class="sxs-lookup"><span data-stu-id="e9266-268">For a cluster running SQL Server Standard edition, or SQL Server 2008 R2, we recommend you use Site Recovery replication to protect SQL Server.</span></span>

### <a name="on-premises-to-on-premises"></a><span data-ttu-id="e9266-269">內部部署至內部部署</span><span class="sxs-lookup"><span data-stu-id="e9266-269">On-premises to on-premises</span></span>

* <span data-ttu-id="e9266-270">如果應用程式使用分散式交易，建議您針對 Hyper-V 環境部署 [Site Recovery 搭配 SAN 複寫](site-recovery-vmm-san.md)，或者，針對 VMware 環境，則部署 [VMware/實體伺服器至 VMware](site-recovery-vmware-to-vmware.md)。</span><span class="sxs-lookup"><span data-stu-id="e9266-270">If the app uses distributed transactions we recommend you deploy [Site Recovery with SAN replication](site-recovery-vmm-san.md) for a Hyper-V environment, or [VMware/physical server to VMware](site-recovery-vmware-to-vmware.md) for a VMware environment.</span></span>
* <span data-ttu-id="e9266-271">針對非 DTC 應用程式，請利用本機高安全性資料庫鏡像，依上述方式將叢集復原成獨立伺服器。</span><span class="sxs-lookup"><span data-stu-id="e9266-271">For non-DTC applications, use the above approach to recover the cluster as a standalone server, by leveraging a local high safety DB mirror.</span></span>

### <a name="on-premises-to-azure"></a><span data-ttu-id="e9266-272">內部部署至 Azure</span><span class="sxs-lookup"><span data-stu-id="e9266-272">On-premises to Azure</span></span>

<span data-ttu-id="e9266-273">複寫至 Azure 時，Site Recovery 不提供來賓叢集支援。</span><span class="sxs-lookup"><span data-stu-id="e9266-273">Site Recovery doesn't provide guest cluster support when replicating to Azure.</span></span> <span data-ttu-id="e9266-274">SQL Server 也不會為 Standard Edition 提供低成本的災害復原解決方案。</span><span class="sxs-lookup"><span data-stu-id="e9266-274">SQL Server also doesn't provide a low-cost disaster recovery solution for Standard edition.</span></span> <span data-ttu-id="e9266-275">在此案例中，建議您將內部部署 SQL Server 叢集保護至獨立式 SQL Server，並在 Azure 中復原。</span><span class="sxs-lookup"><span data-stu-id="e9266-275">In this scenario, we recommend you protect the on-premises SQL Server cluster to a standalone SQL Server, and recover it in Azure.</span></span>

1. <span data-ttu-id="e9266-276">在內部部署站台上設定一個額外的獨立 SQL Server 執行個體。</span><span class="sxs-lookup"><span data-stu-id="e9266-276">Configure an additional standalone SQL Server instance on the on-premises site.</span></span>
1. <span data-ttu-id="e9266-277">設定此執行個體做為您要保護之資料庫的鏡像。</span><span class="sxs-lookup"><span data-stu-id="e9266-277">Configure the instance to serve as a mirror for the databases you want to protect.</span></span> <span data-ttu-id="e9266-278">在高安全性模式下設定鏡像。</span><span class="sxs-lookup"><span data-stu-id="e9266-278">Configure mirroring in high safety mode.</span></span>
1. <span data-ttu-id="e9266-279">針對 [Hyper-V](site-recovery-hyper-v-site-to-azure.md) 或 [VMware WM/實體伺服器](site-recovery-vmware-to-azure-classic.md)，在內部部署網站上設定 Site Recovery。</span><span class="sxs-lookup"><span data-stu-id="e9266-279">Configure Site Recovery on the on-premises site, for ([Hyper-V](site-recovery-hyper-v-site-to-azure.md) or [VMware VMs/physical servers)](site-recovery-vmware-to-azure-classic.md).</span></span>
1. <span data-ttu-id="e9266-280">使用 Site Recovery 複寫將新的 SQL Server 執行個體複寫至 Azure。</span><span class="sxs-lookup"><span data-stu-id="e9266-280">Use Site Recovery replication to replicate the new SQL Server instance to Azure.</span></span> <span data-ttu-id="e9266-281">因為它是高安全性鏡像副本，它會與主要叢集同步處理，但是會使用 Site Recovery 複寫將它複寫至 Azure。</span><span class="sxs-lookup"><span data-stu-id="e9266-281">Since it's a high safety mirror copy, it will be synchronized with the primary cluster, but it will be replicated to Azure using Site Recovery replication.</span></span>


![標準叢集](./media/site-recovery-sql/standalone-cluster-local.png)

### <a name="failback-considerations"></a><span data-ttu-id="e9266-283">容錯回復考量</span><span class="sxs-lookup"><span data-stu-id="e9266-283">Failback considerations</span></span>

<span data-ttu-id="e9266-284">就 SQL Server 標準叢集而言，若要在未規劃的容錯移轉之後進行容錯回復，必須從鏡像執行個體進行 SQL 備份並還原至原始叢集，並重新建立鏡像。</span><span class="sxs-lookup"><span data-stu-id="e9266-284">For SQL Server Standard clusters, failback after an unplanned failover requires a SQL server backup and restore, from the mirror instance to the original cluster, with reestablishment of the mirror.</span></span>

## <a name="next-steps"></a><span data-ttu-id="e9266-285">後續步驟</span><span class="sxs-lookup"><span data-stu-id="e9266-285">Next steps</span></span>
<span data-ttu-id="e9266-286">[深入了解](site-recovery-components.md) Site Recovery 架構。</span><span class="sxs-lookup"><span data-stu-id="e9266-286">[Learn more](site-recovery-components.md) about Site Recovery architecture.</span></span>
