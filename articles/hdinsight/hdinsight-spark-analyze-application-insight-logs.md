---
title: "aaaAnalyze Application Insight 記錄與 Spark-Azure HDInsight |Microsoft 文件"
description: "了解如何 tooexport Application Insight 記錄 tooblob 存放裝置，，然後使用 HDInsight 上的 Spark 中分析 hello 記錄檔。"
services: hdinsight
documentationcenter: 
author: Blackmist
manager: jhubbard
editor: cgronlun
ms.assetid: 883beae6-9839-45b5-94f7-7eb0f4534ad5
ms.service: hdinsight
ms.custom: hdinsightactive
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: big-data
ms.date: 08/15/2017
ms.author: larryfr
ms.openlocfilehash: 11ed8cf68dba8d5f9d6e4a65eba0d2b5a950cd00
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="analyze-application-insights-telemetry-logs-with-spark-on-hdinsight"></a><span data-ttu-id="c50e7-103">使用 HDInsight 上的 Spark 分析 Application Insights 遙測記錄檔</span><span class="sxs-lookup"><span data-stu-id="c50e7-103">Analyze Application Insights telemetry logs with Spark on HDInsight</span></span>

<span data-ttu-id="c50e7-104">深入了解如何 toouse 二手上 HDInsight tooanalyze Application Insight 遙測資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-104">Learn how toouse Spark on HDInsight tooanalyze Application Insight telemetry data.</span></span>

<span data-ttu-id="c50e7-105">[Visual Studio Application Insights](../application-insights/app-insights-overview.md) 是一項分析服務，可監視您的 Web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="c50e7-105">[Visual Studio Application Insights](../application-insights/app-insights-overview.md) is an analytics service that monitors your web applications.</span></span> <span data-ttu-id="c50e7-106">Application Insights 所產生的遙測資料可以是匯出的 tooAzure 儲存體。</span><span class="sxs-lookup"><span data-stu-id="c50e7-106">Telemetry data generated by Application Insights can be exported tooAzure Storage.</span></span> <span data-ttu-id="c50e7-107">HDInsight 一旦 hello 資料是在 Azure 儲存體之後, 才能使用的 tooanalyze 它。</span><span class="sxs-lookup"><span data-stu-id="c50e7-107">Once hello data is in Azure Storage, HDInsight can be used tooanalyze it.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="c50e7-108">必要條件</span><span class="sxs-lookup"><span data-stu-id="c50e7-108">Prerequisites</span></span>

* <span data-ttu-id="c50e7-109">應用程式設定 toouse Application Insights。</span><span class="sxs-lookup"><span data-stu-id="c50e7-109">An application that is configured toouse Application Insights.</span></span>

* <span data-ttu-id="c50e7-110">熟悉以 Linux 為基礎的 HDInsight 叢集的建立程序。</span><span class="sxs-lookup"><span data-stu-id="c50e7-110">Familiarity with creating a Linux-based HDInsight cluster.</span></span> <span data-ttu-id="c50e7-111">如需詳細資訊，請參閱[在 HDInsight 中建立 Spark](hdinsight-apache-spark-jupyter-spark-sql.md)。</span><span class="sxs-lookup"><span data-stu-id="c50e7-111">For more information, see [Create Spark on HDInsight](hdinsight-apache-spark-jupyter-spark-sql.md).</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="c50e7-112">本文件中的 hello 步驟需要使用 Linux 的 HDInsight 叢集。</span><span class="sxs-lookup"><span data-stu-id="c50e7-112">hello steps in this document require an HDInsight cluster that uses Linux.</span></span> <span data-ttu-id="c50e7-113">Linux 為 hello 僅作業系統 HDInsight 3.4 或更新版本上使用。</span><span class="sxs-lookup"><span data-stu-id="c50e7-113">Linux is hello only operating system used on HDInsight version 3.4 or greater.</span></span> <span data-ttu-id="c50e7-114">如需詳細資訊，請參閱 [Windows 上的 HDInsight 淘汰](hdinsight-component-versioning.md#hdinsight-windows-retirement)。</span><span class="sxs-lookup"><span data-stu-id="c50e7-114">For more information, see [HDInsight retirement on Windows](hdinsight-component-versioning.md#hdinsight-windows-retirement).</span></span>

* <span data-ttu-id="c50e7-115">網頁瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="c50e7-115">A web browser.</span></span>

<span data-ttu-id="c50e7-116">hello 下列資源用於開發和測試本文件中：</span><span class="sxs-lookup"><span data-stu-id="c50e7-116">hello following resources were used in developing and testing this document:</span></span>

* <span data-ttu-id="c50e7-117">Application Insights 遙測資料使用產生[Node.js web 應用程式設定 toouse Application Insights](../application-insights/app-insights-nodejs.md)。</span><span class="sxs-lookup"><span data-stu-id="c50e7-117">Application Insights telemetry data was generated using a [Node.js web app configured toouse Application Insights](../application-insights/app-insights-nodejs.md).</span></span>

* <span data-ttu-id="c50e7-118">Linux 上的 Spark HDInsight 叢集版本 3.5 已使用的 tooanalyze hello 資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-118">A Linux-based Spark on HDInsight cluster version 3.5 was used tooanalyze hello data.</span></span>

## <a name="architecture-and-planning"></a><span data-ttu-id="c50e7-119">架構與規劃</span><span class="sxs-lookup"><span data-stu-id="c50e7-119">Architecture and planning</span></span>

<span data-ttu-id="c50e7-120">hello 下列圖表說明此範例中的 hello 服務架構：</span><span class="sxs-lookup"><span data-stu-id="c50e7-120">hello following diagram illustrates hello service architecture of this example:</span></span>

![圖中顯示資料流動從 Application Insights tooblob 儲存體，則正在處理的 HDInsight 上的 Spark](./media/hdinsight-spark-analyze-application-insight-logs/appinsightshdinsight.png)

### <a name="azure-storage"></a><span data-ttu-id="c50e7-122">Azure 儲存體</span><span class="sxs-lookup"><span data-stu-id="c50e7-122">Azure storage</span></span>

<span data-ttu-id="c50e7-123">Application Insights 可以設定的 toocontinuously 匯出遙測資訊 tooblobs。</span><span class="sxs-lookup"><span data-stu-id="c50e7-123">Application Insights can be configured toocontinuously export telemetry information tooblobs.</span></span> <span data-ttu-id="c50e7-124">HDInsight 然後可以讀取的資料儲存在 hello blob。</span><span class="sxs-lookup"><span data-stu-id="c50e7-124">HDInsight can then read data stored in hello blobs.</span></span> <span data-ttu-id="c50e7-125">不過，有一些您必須遵守的需求︰</span><span class="sxs-lookup"><span data-stu-id="c50e7-125">However, there are some requirements that you must follow:</span></span>

* <span data-ttu-id="c50e7-126">**位置**： 如果 hello 儲存體帳戶與 HDInsight 是在不同的位置，但是可能會增加延遲。</span><span class="sxs-lookup"><span data-stu-id="c50e7-126">**Location**: If hello Storage Account and HDInsight are in different locations, it may increase latency.</span></span> <span data-ttu-id="c50e7-127">因為輸出費用套用的 toodata 區域之間移動，它也會增加成本。</span><span class="sxs-lookup"><span data-stu-id="c50e7-127">It also increases cost, as egress charges are applied toodata moving between regions.</span></span>

    > [!WARNING]
    > <span data-ttu-id="c50e7-128">不支援在與 HDInsight 不同的位置使用儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="c50e7-128">Using a Storage Account in a different location than HDInsight is not supported.</span></span>

* <span data-ttu-id="c50e7-129">**blob 類型**：HDInsight 僅支援區塊 blob。</span><span class="sxs-lookup"><span data-stu-id="c50e7-129">**Blob type**: HDInsight only supports block blobs.</span></span> <span data-ttu-id="c50e7-130">Application Insights 預設 toousing 區塊 blob，因此應該根據預設，使用 HDInsight 工作。</span><span class="sxs-lookup"><span data-stu-id="c50e7-130">Application Insights defaults toousing block blobs, so should work by default with HDInsight.</span></span>

<span data-ttu-id="c50e7-131">如需加入額外的儲存體 tooan 現有 HDInsight 叢集的資訊，請參閱 hello[新增額外的儲存體帳戶](hdinsight-hadoop-add-storage.md)文件。</span><span class="sxs-lookup"><span data-stu-id="c50e7-131">For information on adding additional storage tooan existing HDInsight cluster, see hello [Add additional storage accounts](hdinsight-hadoop-add-storage.md) document.</span></span>

### <a name="data-schema"></a><span data-ttu-id="c50e7-132">資料結構描述</span><span class="sxs-lookup"><span data-stu-id="c50e7-132">Data schema</span></span>

<span data-ttu-id="c50e7-133">Application Insights 提供[匯出資料模型](../application-insights/app-insights-export-data-model.md)匯出 tooblobs hello 遙測資料格式的資訊。</span><span class="sxs-lookup"><span data-stu-id="c50e7-133">Application Insights provides [export data model](../application-insights/app-insights-export-data-model.md) information for hello telemetry data format exported tooblobs.</span></span> <span data-ttu-id="c50e7-134">本文件中的 hello 步驟使用 Spark SQL toowork hello 資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-134">hello steps in this document use Spark SQL toowork with hello data.</span></span> <span data-ttu-id="c50e7-135">Spark SQL 可以自動產生記錄的 Application Insights hello JSON 資料結構的結構描述。</span><span class="sxs-lookup"><span data-stu-id="c50e7-135">Spark SQL can automatically generate a schema for hello JSON data structure logged by Application Insights.</span></span>

## <a name="export-telemetry-data"></a><span data-ttu-id="c50e7-136">匯出遙測資料</span><span class="sxs-lookup"><span data-stu-id="c50e7-136">Export telemetry data</span></span>

<span data-ttu-id="c50e7-137">中的 hello 步驟[設定連續匯出](../application-insights/app-insights-export-telemetry.md)tooconfigure 您 Application Insights tooexport 遙測資訊 tooan Azure 儲存體 blob。</span><span class="sxs-lookup"><span data-stu-id="c50e7-137">Follow hello steps in [Configure Continuous Export](../application-insights/app-insights-export-telemetry.md) tooconfigure your Application Insights tooexport telemetry information tooan Azure storage blob.</span></span>

## <a name="configure-hdinsight-tooaccess-hello-data"></a><span data-ttu-id="c50e7-138">設定 HDInsight tooaccess hello 資料</span><span class="sxs-lookup"><span data-stu-id="c50e7-138">Configure HDInsight tooaccess hello data</span></span>

<span data-ttu-id="c50e7-139">如果您要建立的 HDInsight 叢集，請在叢集建立期間新增 hello 儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="c50e7-139">If you are creating an HDInsight cluster, add hello storage account during cluster creation.</span></span>

<span data-ttu-id="c50e7-140">tooadd hello Azure 儲存體帳戶 tooan 現有的叢集，請使用中 hello hello 資訊[新增額外的儲存體帳戶](hdinsight-hadoop-add-storage.md)文件。</span><span class="sxs-lookup"><span data-stu-id="c50e7-140">tooadd hello Azure Storage Account tooan existing cluster, use hello information in hello [Add additional Storage Accounts](hdinsight-hadoop-add-storage.md) document.</span></span>

## <a name="analyze-hello-data-pyspark"></a><span data-ttu-id="c50e7-141">分析 hello 資料： PySpark</span><span class="sxs-lookup"><span data-stu-id="c50e7-141">Analyze hello data: PySpark</span></span>

1. <span data-ttu-id="c50e7-142">從 hello [Azure 入口網站](https://portal.azure.com)，選取您的 HDInsight 叢集上的 Spark。</span><span class="sxs-lookup"><span data-stu-id="c50e7-142">From hello [Azure portal](https://portal.azure.com), select your Spark on HDInsight cluster.</span></span> <span data-ttu-id="c50e7-143">從 hello**快速連結**區段中，選取**叢集儀表板**，然後選取**Jupyter 筆記本**從 hello 叢集 Dashboard__ 刀鋒視窗。</span><span class="sxs-lookup"><span data-stu-id="c50e7-143">From hello **Quick Links** section, select **Cluster Dashboards**, and then select **Jupyter Notebook** from hello Cluster Dashboard__ blade.</span></span>

    ![hello 叢集儀表板](./media/hdinsight-spark-analyze-application-insight-logs/clusterdashboards.png)

2. <span data-ttu-id="c50e7-145">在 hello 右上角的 hello Jupyter 頁面、 選取**新增**，然後**PySpark**。</span><span class="sxs-lookup"><span data-stu-id="c50e7-145">In hello upper right corner of hello Jupyter page, select **New**, and then **PySpark**.</span></span> <span data-ttu-id="c50e7-146">隨即開啟新的瀏覽器索引標籤，其中包含以 Python 為基礎的 Jupyter Notebook。</span><span class="sxs-lookup"><span data-stu-id="c50e7-146">A new browser tab containing a Python-based Jupyter Notebook opens.</span></span>

3. <span data-ttu-id="c50e7-147">Hello 第一個欄位中 (稱為**儲存格**) hello 頁面上，輸入下列文字的 hello:</span><span class="sxs-lookup"><span data-stu-id="c50e7-147">In hello first field (called a **cell**) on hello page, enter hello following text:</span></span>

   ```python
   sc._jsc.hadoopConfiguration().set('mapreduce.input.fileinputformat.input.dir.recursive', 'true')
   ```

    <span data-ttu-id="c50e7-148">此程式碼會設定 Spark toorecursively 存取 hello 目錄結構 hello 輸入資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-148">This code configures Spark toorecursively access hello directory structure for hello input data.</span></span> <span data-ttu-id="c50e7-149">Application Insights 遙測是記錄的 tooa 目錄結構類似 toohello `/{telemetry type}/YYYY-MM-DD/{##}/`。</span><span class="sxs-lookup"><span data-stu-id="c50e7-149">Application Insights telemetry is logged tooa directory structure similar toohello `/{telemetry type}/YYYY-MM-DD/{##}/`.</span></span>

4. <span data-ttu-id="c50e7-150">使用**SHIFT + ENTER** toorun hello 程式碼。</span><span class="sxs-lookup"><span data-stu-id="c50e7-150">Use **SHIFT+ENTER** toorun hello code.</span></span> <span data-ttu-id="c50e7-151">上的 hello 資料格，左方的 hello '\*' hello 這個資料格中的程式碼正在執行 hello 方括號 tooindicate 之間會出現。</span><span class="sxs-lookup"><span data-stu-id="c50e7-151">On hello left side of hello cell, an '\*' appears between hello brackets tooindicate that hello code in this cell is being executed.</span></span> <span data-ttu-id="c50e7-152">在完成，hello '\*' tooa 數目和底下 hello 資料格會顯示下列文字類似 toohello 輸出變更：</span><span class="sxs-lookup"><span data-stu-id="c50e7-152">Once it completes, hello '\*' changes tooa number, and output similar toohello following text is displayed below hello cell:</span></span>

        Creating SparkContext as 'sc'

        ID    YARN Application ID    Kind    State    Spark UI    Driver log    Current session?
        3    application_1468969497124_0001    pyspark    idle    Link    Link    ✔

        Creating HiveContext as 'sqlContext'
        SparkContext and HiveContext created. Executing user code ...
5. <span data-ttu-id="c50e7-153">Hello 底下建立新的儲存格第一次一個。</span><span class="sxs-lookup"><span data-stu-id="c50e7-153">A new cell is created below hello first one.</span></span> <span data-ttu-id="c50e7-154">輸入下列文字放 hello 新儲存格的 hello。</span><span class="sxs-lookup"><span data-stu-id="c50e7-154">Enter hello following text in hello new cell.</span></span> <span data-ttu-id="c50e7-155">取代`CONTAINER`和`STORAGEACCOUNT`hello Azure 儲存體帳戶名稱與包含 Application Insights 資料的 blob 容器名稱。</span><span class="sxs-lookup"><span data-stu-id="c50e7-155">Replace `CONTAINER` and `STORAGEACCOUNT` with hello Azure storage account name and blob container name that contains Application Insights data.</span></span>

   ```python
   %%bash
   hdfs dfs -ls wasb://CONTAINER@STORAGEACCOUNT.blob.core.windows.net/
   ```

    <span data-ttu-id="c50e7-156">使用**SHIFT + ENTER** tooexecute 這個儲存格。</span><span class="sxs-lookup"><span data-stu-id="c50e7-156">Use **SHIFT+ENTER** tooexecute this cell.</span></span> <span data-ttu-id="c50e7-157">您會看到下列文字結果類似 toohello:</span><span class="sxs-lookup"><span data-stu-id="c50e7-157">You see a result similar toohello following text:</span></span>

        Found 1 items
        drwxrwxrwx   -          0 1970-01-01 00:00 wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_2bededa61bc741fbdee6b556571a4831

    <span data-ttu-id="c50e7-158">傳回的 hello wasb 路徑是 hello hello Application Insights 遙測資料位置。</span><span class="sxs-lookup"><span data-stu-id="c50e7-158">hello wasb path returned is hello location of hello Application Insights telemetry data.</span></span> <span data-ttu-id="c50e7-159">變更 hello `hdfs dfs -ls` hello 儲存格 toouse hello wasb 路徑傳回中的行，然後使用**SHIFT + ENTER**再次 toorun hello 儲存格。</span><span class="sxs-lookup"><span data-stu-id="c50e7-159">Change hello `hdfs dfs -ls` line in hello cell toouse hello wasb path returned, and then use **SHIFT+ENTER** toorun hello cell again.</span></span> <span data-ttu-id="c50e7-160">這次 hello 結果應該會顯示 hello 目錄，其中包含遙測資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-160">This time, hello results should display hello directories that contain telemetry data.</span></span>

   > [!NOTE]
   > <span data-ttu-id="c50e7-161">本節中的步驟 hello hello 其餘部分，hello`wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests`目錄使用。</span><span class="sxs-lookup"><span data-stu-id="c50e7-161">For hello remainder of hello steps in this section, hello `wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests` directory was used.</span></span> <span data-ttu-id="c50e7-162">您的目錄結構可能不同。</span><span class="sxs-lookup"><span data-stu-id="c50e7-162">Your directory structure may be different.</span></span>

6. <span data-ttu-id="c50e7-163">在 hello 下一個資料格中，輸入下列程式碼的 hello： 取代`WASB_PATH`hello hello 先前步驟中的路徑。</span><span class="sxs-lookup"><span data-stu-id="c50e7-163">In hello next cell, enter hello following code: Replace `WASB_PATH` with hello path from hello previous step.</span></span>

   ```python
   jsonFiles = sc.textFile('WASB_PATH')
   jsonData = sqlContext.read.json(jsonFiles)
   ```

    <span data-ttu-id="c50e7-164">此程式碼會建立資料框架 hello 連續匯出程序所匯出的 hello JSON 檔案中。</span><span class="sxs-lookup"><span data-stu-id="c50e7-164">This code creates a dataframe from hello JSON files exported by hello continuous export process.</span></span> <span data-ttu-id="c50e7-165">使用**SHIFT + ENTER** toorun 這個儲存格。</span><span class="sxs-lookup"><span data-stu-id="c50e7-165">Use **SHIFT+ENTER** toorun this cell.</span></span>
7. <span data-ttu-id="c50e7-166">在 hello 下一個資料格中，輸入並執行下列建立 hello JSON 檔案的 Spark tooview hello 結構描述的 hello:</span><span class="sxs-lookup"><span data-stu-id="c50e7-166">In hello next cell, enter and run hello following tooview hello schema that Spark created for hello JSON files:</span></span>

   ```python
   jsonData.printSchema()
   ```

    <span data-ttu-id="c50e7-167">每種類型的遙測 hello 結構描述不相同。</span><span class="sxs-lookup"><span data-stu-id="c50e7-167">hello schema for each type of telemetry is different.</span></span> <span data-ttu-id="c50e7-168">hello 下列範例是產生的 web 要求的 hello 結構描述 (資料儲存在 hello`Requests`子目錄):</span><span class="sxs-lookup"><span data-stu-id="c50e7-168">hello following example is hello schema that is generated for web requests (data stored in hello `Requests` subdirectory):</span></span>

        root
        |-- context: struct (nullable = true)
        |    |-- application: struct (nullable = true)
        |    |    |-- version: string (nullable = true)
        |    |-- custom: struct (nullable = true)
        |    |    |-- dimensions: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |    |-- metrics: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- eventTime: string (nullable = true)
        |    |    |-- isSynthetic: boolean (nullable = true)
        |    |    |-- samplingRate: double (nullable = true)
        |    |    |-- syntheticSource: string (nullable = true)
        |    |-- device: struct (nullable = true)
        |    |    |-- browser: string (nullable = true)
        |    |    |-- browserVersion: string (nullable = true)
        |    |    |-- deviceModel: string (nullable = true)
        |    |    |-- deviceName: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- osVersion: string (nullable = true)
        |    |    |-- type: string (nullable = true)
        |    |-- location: struct (nullable = true)
        |    |    |-- city: string (nullable = true)
        |    |    |-- clientip: string (nullable = true)
        |    |    |-- continent: string (nullable = true)
        |    |    |-- country: string (nullable = true)
        |    |    |-- province: string (nullable = true)
        |    |-- operation: struct (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |-- session: struct (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- isFirst: boolean (nullable = true)
        |    |-- user: struct (nullable = true)
        |    |    |-- anonId: string (nullable = true)
        |    |    |-- isAuthenticated: boolean (nullable = true)
        |-- internal: struct (nullable = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- documentVersion: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |-- request: array (nullable = true)
        |    |-- element: struct (containsNull = true)
        |    |    |-- count: long (nullable = true)
        |    |    |-- durationMetric: struct (nullable = true)
        |    |    |    |-- count: double (nullable = true)
        |    |    |    |-- max: double (nullable = true)
        |    |    |    |-- min: double (nullable = true)
        |    |    |    |-- sampledValue: double (nullable = true)
        |    |    |    |-- stdDev: double (nullable = true)
        |    |    |    |-- value: double (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |    |-- responseCode: long (nullable = true)
        |    |    |-- success: boolean (nullable = true)
        |    |    |-- url: string (nullable = true)
        |    |    |-- urlData: struct (nullable = true)
        |    |    |    |-- base: string (nullable = true)
        |    |    |    |-- hashTag: string (nullable = true)
        |    |    |    |-- host: string (nullable = true)
        |    |    |    |-- protocol: string (nullable = true)
8. <span data-ttu-id="c50e7-169">使用 hello 遵循 tooregister hello 資料框架的暫存資料表，並針對 hello 資料執行查詢：</span><span class="sxs-lookup"><span data-stu-id="c50e7-169">Use hello following tooregister hello dataframe as a temporary table and run a query against hello data:</span></span>

   ```python
   jsonData.registerTempTable("requests")
   df = sqlContext.sql("select context.location.city from requests where context.location.city is not null")
   df.show()
   ```

    <span data-ttu-id="c50e7-170">此查詢會傳回其中 context.location.city 不是 null hello 前 20 筆記錄的 hello 縣 （市） 資訊。</span><span class="sxs-lookup"><span data-stu-id="c50e7-170">This query returns hello city information for hello top 20 records where context.location.city is not null.</span></span>

   > [!NOTE]
   > <span data-ttu-id="c50e7-171">hello 內容結構會出現在所有記錄的 Application Insights 的遙測資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-171">hello context structure is present in all telemetry logged by Application Insights.</span></span> <span data-ttu-id="c50e7-172">hello 縣 （市） 項目可能不會填入您記錄中。</span><span class="sxs-lookup"><span data-stu-id="c50e7-172">hello city element may not be populated in your logs.</span></span> <span data-ttu-id="c50e7-173">使用 hello 結構描述 tooidentify 其他項目，您可以查詢可能包含記錄資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-173">Use hello schema tooidentify other elements that you can query that may contain data for your logs.</span></span>

    <span data-ttu-id="c50e7-174">此查詢傳回的資訊類似 toohello 下列文字：</span><span class="sxs-lookup"><span data-stu-id="c50e7-174">This query returns information similar toohello following text:</span></span>

        +---------+
        |     city|
        +---------+
        | Bellevue|
        |  Redmond|
        |  Seattle|
        |Charlotte|
        ...
        +---------+

## <a name="analyze-hello-data-scala"></a><span data-ttu-id="c50e7-175">分析 hello 資料： Scala</span><span class="sxs-lookup"><span data-stu-id="c50e7-175">Analyze hello data: Scala</span></span>

1. <span data-ttu-id="c50e7-176">從 hello [Azure 入口網站](https://portal.azure.com)，選取您的 HDInsight 叢集上的 Spark。</span><span class="sxs-lookup"><span data-stu-id="c50e7-176">From hello [Azure portal](https://portal.azure.com), select your Spark on HDInsight cluster.</span></span> <span data-ttu-id="c50e7-177">從 hello**快速連結**區段中，選取**叢集儀表板**，然後選取**Jupyter 筆記本**從 hello 叢集 Dashboard__ 刀鋒視窗。</span><span class="sxs-lookup"><span data-stu-id="c50e7-177">From hello **Quick Links** section, select **Cluster Dashboards**, and then select **Jupyter Notebook** from hello Cluster Dashboard__ blade.</span></span>

    ![hello 叢集儀表板](./media/hdinsight-spark-analyze-application-insight-logs/clusterdashboards.png)
2. <span data-ttu-id="c50e7-179">在 hello 右上角的 hello Jupyter 頁面、 選取**新增**，然後**Scala**。</span><span class="sxs-lookup"><span data-stu-id="c50e7-179">In hello upper right corner of hello Jupyter page, select **New**, and then **Scala**.</span></span> <span data-ttu-id="c50e7-180">新的瀏覽器索引標籤隨即出現，其中包含以 Scala 為基礎的 Jupyter Notebook。</span><span class="sxs-lookup"><span data-stu-id="c50e7-180">A new browser tab containing a Scala-based Jupyter Notebook appears.</span></span>
3. <span data-ttu-id="c50e7-181">Hello 第一個欄位中 (稱為**儲存格**) hello 頁面上，輸入下列文字的 hello:</span><span class="sxs-lookup"><span data-stu-id="c50e7-181">In hello first field (called a **cell**) on hello page, enter hello following text:</span></span>

   ```scala
   sc.hadoopConfiguration.set("mapreduce.input.fileinputformat.input.dir.recursive", "true")
   ```

    <span data-ttu-id="c50e7-182">此程式碼會設定 Spark toorecursively 存取 hello 目錄結構 hello 輸入資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-182">This code configures Spark toorecursively access hello directory structure for hello input data.</span></span> <span data-ttu-id="c50e7-183">Application Insights 遙測記錄 tooa 目錄結構類似太`/{telemetry type}/YYYY-MM-DD/{##}/`。</span><span class="sxs-lookup"><span data-stu-id="c50e7-183">Application Insights telemetry is logged tooa directory structure similar too`/{telemetry type}/YYYY-MM-DD/{##}/`.</span></span>

4. <span data-ttu-id="c50e7-184">使用**SHIFT + ENTER** toorun hello 程式碼。</span><span class="sxs-lookup"><span data-stu-id="c50e7-184">Use **SHIFT+ENTER** toorun hello code.</span></span> <span data-ttu-id="c50e7-185">上的 hello 資料格，左方的 hello '\*' hello 這個資料格中的程式碼正在執行 hello 方括號 tooindicate 之間會出現。</span><span class="sxs-lookup"><span data-stu-id="c50e7-185">On hello left side of hello cell, an '\*' appears between hello brackets tooindicate that hello code in this cell is being executed.</span></span> <span data-ttu-id="c50e7-186">在完成，hello '\*' tooa 數目和底下 hello 資料格會顯示下列文字類似 toohello 輸出變更：</span><span class="sxs-lookup"><span data-stu-id="c50e7-186">Once it completes, hello '\*' changes tooa number, and output similar toohello following text is displayed below hello cell:</span></span>

        Creating SparkContext as 'sc'

        ID    YARN Application ID    Kind    State    Spark UI    Driver log    Current session?
        3    application_1468969497124_0001    spark    idle    Link    Link    ✔

        Creating HiveContext as 'sqlContext'
        SparkContext and HiveContext created. Executing user code ...
5. <span data-ttu-id="c50e7-187">Hello 底下建立新的儲存格第一次一個。</span><span class="sxs-lookup"><span data-stu-id="c50e7-187">A new cell is created below hello first one.</span></span> <span data-ttu-id="c50e7-188">輸入下列文字放 hello 新儲存格的 hello。</span><span class="sxs-lookup"><span data-stu-id="c50e7-188">Enter hello following text in hello new cell.</span></span> <span data-ttu-id="c50e7-189">取代`CONTAINER`和`STORAGEACCOUNT`使用 hello Azure 儲存體帳戶名稱和 blob 容器名稱，其中包含 Application Insights 記錄。</span><span class="sxs-lookup"><span data-stu-id="c50e7-189">Replace `CONTAINER` and `STORAGEACCOUNT` with hello Azure storage account name and blob container name that contains Application Insights logs.</span></span>

   ```scala
   %%bash
   hdfs dfs -ls wasb://CONTAINER@STORAGEACCOUNT.blob.core.windows.net/
   ```

    <span data-ttu-id="c50e7-190">使用**SHIFT + ENTER** tooexecute 這個儲存格。</span><span class="sxs-lookup"><span data-stu-id="c50e7-190">Use **SHIFT+ENTER** tooexecute this cell.</span></span> <span data-ttu-id="c50e7-191">您會看到下列文字結果類似 toohello:</span><span class="sxs-lookup"><span data-stu-id="c50e7-191">You see a result similar toohello following text:</span></span>

        Found 1 items
        drwxrwxrwx   -          0 1970-01-01 00:00 wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_2bededa61bc741fbdee6b556571a4831

    <span data-ttu-id="c50e7-192">傳回的 hello wasb 路徑是 hello hello Application Insights 遙測資料位置。</span><span class="sxs-lookup"><span data-stu-id="c50e7-192">hello wasb path returned is hello location of hello Application Insights telemetry data.</span></span> <span data-ttu-id="c50e7-193">變更 hello `hdfs dfs -ls` hello 儲存格 toouse hello wasb 路徑傳回中的行，然後使用**SHIFT + ENTER**再次 toorun hello 儲存格。</span><span class="sxs-lookup"><span data-stu-id="c50e7-193">Change hello `hdfs dfs -ls` line in hello cell toouse hello wasb path returned, and then use **SHIFT+ENTER** toorun hello cell again.</span></span> <span data-ttu-id="c50e7-194">這次 hello 結果應該會顯示 hello 目錄，其中包含遙測資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-194">This time, hello results should display hello directories that contain telemetry data.</span></span>

   > [!NOTE]
   > <span data-ttu-id="c50e7-195">本節中的步驟 hello hello 其餘部分，hello`wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests`目錄使用。</span><span class="sxs-lookup"><span data-stu-id="c50e7-195">For hello remainder of hello steps in this section, hello `wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests` directory was used.</span></span> <span data-ttu-id="c50e7-196">這個目錄可能不存在，除非您的遙測資料是用於 Web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="c50e7-196">This directory may not exist unless your telemetry data is for a web app.</span></span>

6. <span data-ttu-id="c50e7-197">在 hello 下一個資料格中，輸入下列程式碼的 hello： 取代`WASB\_PATH`hello hello 先前步驟中的路徑。</span><span class="sxs-lookup"><span data-stu-id="c50e7-197">In hello next cell, enter hello following code: Replace `WASB\_PATH` with hello path from hello previous step.</span></span>

   ```scala
   var jsonFiles = sc.textFile('WASB_PATH')
   val sqlContext = new org.apache.spark.sql.SQLContext(sc)
   var jsonData = sqlContext.read.json(jsonFiles)
   ```

    <span data-ttu-id="c50e7-198">此程式碼會建立資料框架 hello 連續匯出程序所匯出的 hello JSON 檔案中。</span><span class="sxs-lookup"><span data-stu-id="c50e7-198">This code creates a dataframe from hello JSON files exported by hello continuous export process.</span></span> <span data-ttu-id="c50e7-199">使用**SHIFT + ENTER** toorun 這個儲存格。</span><span class="sxs-lookup"><span data-stu-id="c50e7-199">Use **SHIFT+ENTER** toorun this cell.</span></span>

7. <span data-ttu-id="c50e7-200">在 hello 下一個資料格中，輸入並執行下列建立 hello JSON 檔案的 Spark tooview hello 結構描述的 hello:</span><span class="sxs-lookup"><span data-stu-id="c50e7-200">In hello next cell, enter and run hello following tooview hello schema that Spark created for hello JSON files:</span></span>

   ```scala
   jsonData.printSchema
   ```

    <span data-ttu-id="c50e7-201">每種類型的遙測 hello 結構描述不相同。</span><span class="sxs-lookup"><span data-stu-id="c50e7-201">hello schema for each type of telemetry is different.</span></span> <span data-ttu-id="c50e7-202">hello 下列範例是產生的 web 要求的 hello 結構描述 (資料儲存在 hello`Requests`子目錄):</span><span class="sxs-lookup"><span data-stu-id="c50e7-202">hello following example is hello schema that is generated for web requests (data stored in hello `Requests` subdirectory):</span></span>

        root
        |-- context: struct (nullable = true)
        |    |-- application: struct (nullable = true)
        |    |    |-- version: string (nullable = true)
        |    |-- custom: struct (nullable = true)
        |    |    |-- dimensions: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |    |-- metrics: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- eventTime: string (nullable = true)
        |    |    |-- isSynthetic: boolean (nullable = true)
        |    |    |-- samplingRate: double (nullable = true)
        |    |    |-- syntheticSource: string (nullable = true)
        |    |-- device: struct (nullable = true)
        |    |    |-- browser: string (nullable = true)
        |    |    |-- browserVersion: string (nullable = true)
        |    |    |-- deviceModel: string (nullable = true)
        |    |    |-- deviceName: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- osVersion: string (nullable = true)
        |    |    |-- type: string (nullable = true)
        |    |-- location: struct (nullable = true)
        |    |    |-- city: string (nullable = true)
        |    |    |-- clientip: string (nullable = true)
        |    |    |-- continent: string (nullable = true)
        |    |    |-- country: string (nullable = true)
        |    |    |-- province: string (nullable = true)
        |    |-- operation: struct (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |-- session: struct (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- isFirst: boolean (nullable = true)
        |    |-- user: struct (nullable = true)
        |    |    |-- anonId: string (nullable = true)
        |    |    |-- isAuthenticated: boolean (nullable = true)
        |-- internal: struct (nullable = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- documentVersion: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |-- request: array (nullable = true)
        |    |-- element: struct (containsNull = true)
        |    |    |-- count: long (nullable = true)
        |    |    |-- durationMetric: struct (nullable = true)
        |    |    |    |-- count: double (nullable = true)
        |    |    |    |-- max: double (nullable = true)
        |    |    |    |-- min: double (nullable = true)
        |    |    |    |-- sampledValue: double (nullable = true)
        |    |    |    |-- stdDev: double (nullable = true)
        |    |    |    |-- value: double (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |    |-- responseCode: long (nullable = true)
        |    |    |-- success: boolean (nullable = true)
        |    |    |-- url: string (nullable = true)
        |    |    |-- urlData: struct (nullable = true)
        |    |    |    |-- base: string (nullable = true)
        |    |    |    |-- hashTag: string (nullable = true)
        |    |    |    |-- host: string (nullable = true)
        |    |    |    |-- protocol: string (nullable = true)

8. <span data-ttu-id="c50e7-203">使用 hello 遵循 tooregister hello 資料框架的暫存資料表，並針對 hello 資料執行查詢：</span><span class="sxs-lookup"><span data-stu-id="c50e7-203">Use hello following tooregister hello dataframe as a temporary table and run a query against hello data:</span></span>

   ```scala
   jsonData.registerTempTable("requests")
   var city = sqlContext.sql("select context.location.city from requests where context.location.city is not null limit 10").show()
   ```

    <span data-ttu-id="c50e7-204">此查詢會傳回其中 context.location.city 不是 null hello 前 20 筆記錄的 hello 縣 （市） 資訊。</span><span class="sxs-lookup"><span data-stu-id="c50e7-204">This query returns hello city information for hello top 20 records where context.location.city is not null.</span></span>

   > [!NOTE]
   > <span data-ttu-id="c50e7-205">hello 內容結構會出現在所有記錄的 Application Insights 的遙測資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-205">hello context structure is present in all telemetry logged by Application Insights.</span></span> <span data-ttu-id="c50e7-206">hello 縣 （市） 項目可能不會填入您記錄中。</span><span class="sxs-lookup"><span data-stu-id="c50e7-206">hello city element may not be populated in your logs.</span></span> <span data-ttu-id="c50e7-207">使用 hello 結構描述 tooidentify 其他項目，您可以查詢可能包含記錄資料。</span><span class="sxs-lookup"><span data-stu-id="c50e7-207">Use hello schema tooidentify other elements that you can query that may contain data for your logs.</span></span>
   >
   >

    <span data-ttu-id="c50e7-208">此查詢傳回的資訊類似 toohello 下列文字：</span><span class="sxs-lookup"><span data-stu-id="c50e7-208">This query returns information similar toohello following text:</span></span>

        +---------+
        |     city|
        +---------+
        | Bellevue|
        |  Redmond|
        |  Seattle|
        |Charlotte|
        ...
        +---------+

## <a name="next-steps"></a><span data-ttu-id="c50e7-209">後續步驟</span><span class="sxs-lookup"><span data-stu-id="c50e7-209">Next steps</span></span>

<span data-ttu-id="c50e7-210">如需使用 Spark toowork 資料與服務在 Azure 中的範例，請參閱下列文件的 hello:</span><span class="sxs-lookup"><span data-stu-id="c50e7-210">For more examples of using Spark toowork with data and services in Azure, see hello following documents:</span></span>

* [<span data-ttu-id="c50e7-211">Spark 和 BI：在 HDInsight 中搭配使用 Spark 和 BI 工具執行互動式資料分析</span><span class="sxs-lookup"><span data-stu-id="c50e7-211">Spark with BI: Perform interactive data analysis using Spark in HDInsight with BI tools</span></span>](hdinsight-apache-spark-use-bi-tools.md)
* [<span data-ttu-id="c50e7-212">Spark 和機器學習服務：使用 HDInsight 中的 Spark，利用 HVAC 資料來分析建築物溫度</span><span class="sxs-lookup"><span data-stu-id="c50e7-212">Spark with Machine Learning: Use Spark in HDInsight for analyzing building temperature using HVAC data</span></span>](hdinsight-apache-spark-ipython-notebook-machine-learning.md)
* [<span data-ttu-id="c50e7-213">機器學習的 Spark： 使用 HDInsight toopredict 食物檢查結果中的 Spark</span><span class="sxs-lookup"><span data-stu-id="c50e7-213">Spark with Machine Learning: Use Spark in HDInsight toopredict food inspection results</span></span>](hdinsight-apache-spark-machine-learning-mllib-ipython.md)
* [<span data-ttu-id="c50e7-214">Spark 串流：使用 HDInsight 中的 Spark 來建置串流應用程式</span><span class="sxs-lookup"><span data-stu-id="c50e7-214">Spark Streaming: Use Spark in HDInsight for building streaming applications</span></span>](hdinsight-apache-spark-eventhub-streaming.md)
* [<span data-ttu-id="c50e7-215">使用 HDInsight 中的 Spark 進行網站記錄分析</span><span class="sxs-lookup"><span data-stu-id="c50e7-215">Website log analysis using Spark in HDInsight</span></span>](hdinsight-apache-spark-custom-library-website-log-analysis.md)

<span data-ttu-id="c50e7-216">在建立及執行 Spark 應用程式的資訊，請參閱下列文件的 hello:</span><span class="sxs-lookup"><span data-stu-id="c50e7-216">For information on creating and running Spark applications, see hello following documents:</span></span>

* [<span data-ttu-id="c50e7-217">使用 Scala 建立獨立應用程式</span><span class="sxs-lookup"><span data-stu-id="c50e7-217">Create a standalone application using Scala</span></span>](hdinsight-apache-spark-create-standalone-application.md)
* [<span data-ttu-id="c50e7-218">利用 Livy 在 Spark 叢集上遠端執行工作</span><span class="sxs-lookup"><span data-stu-id="c50e7-218">Run jobs remotely on a Spark cluster using Livy</span></span>](hdinsight-apache-spark-livy-rest-interface.md)
