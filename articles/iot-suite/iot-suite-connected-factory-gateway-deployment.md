---
title: "連接您的 Azure IoT 套件 aaaDeploy factory 閘道 |Microsoft 文件"
description: "如何 toodeploy 閘道在 Windows 或 Linux tooenable 連線 toohello 連接工廠預先設定的解決方案。"
services: 
suite: iot-suite
documentationcenter: na
author: dominicbetts
manager: timlt
editor: 
ms.service: iot-suite
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/24/2017
ms.author: dobett
ms.openlocfilehash: 72436dec60eda0de20143f362fe740b0c4412f36
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="deploy-a-gateway-on-windows-or-linux-for-hello-connected-factory-preconfigured-solution"></a><span data-ttu-id="d88b5-103">部署 Windows 或 Linux 上閘道連線的 hello factory 預先設定的解決方案</span><span class="sxs-lookup"><span data-stu-id="d88b5-103">Deploy a gateway on Windows or Linux for hello connected factory preconfigured solution</span></span>

<span data-ttu-id="d88b5-104">hello 軟體所需的閘道連線的 hello factory 預先設定的解決方案 toodeploy 有兩個元件：</span><span class="sxs-lookup"><span data-stu-id="d88b5-104">hello software required toodeploy a gateway for hello connected factory preconfigured solution has two components:</span></span>

* <span data-ttu-id="d88b5-105">hello *OPC Proxy*建立連線 tooIoT 中樞。</span><span class="sxs-lookup"><span data-stu-id="d88b5-105">hello *OPC Proxy* establishes a connection tooIoT Hub.</span></span> <span data-ttu-id="d88b5-106">hello *OPC Proxy*然後等候來自 hello 的命令和控制訊息的整合 hello 連線的 factory 方案入口網站中執行的 OPC 瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="d88b5-106">hello *OPC Proxy* then waits for command and control messages from hello integrated OPC Browser that runs in hello connected factory solution portal.</span></span>
* <span data-ttu-id="d88b5-107">hello *OPC 發行者*連接 tooexisting 內部 OPC UA 伺服器和從中 tooIoT 中樞轉送遙測訊息。</span><span class="sxs-lookup"><span data-stu-id="d88b5-107">hello *OPC Publisher* connects tooexisting on-premises OPC UA servers and forwards telemetry messages from them tooIoT Hub.</span></span>

<span data-ttu-id="d88b5-108">這兩個元件都是開放程式碼，且以 GitHub 上的來源與 Docker 容器的方式提供：</span><span class="sxs-lookup"><span data-stu-id="d88b5-108">Both components are open-source and are available as source on GitHub and as Docker containers:</span></span>

| <span data-ttu-id="d88b5-109">GitHub</span><span class="sxs-lookup"><span data-stu-id="d88b5-109">GitHub</span></span> | <span data-ttu-id="d88b5-110">DockerHub</span><span class="sxs-lookup"><span data-stu-id="d88b5-110">DockerHub</span></span> |
| ------ | --------- |
| <span data-ttu-id="d88b5-111">[OPC 發行者][lnk-publisher-github]</span><span class="sxs-lookup"><span data-stu-id="d88b5-111">[OPC Publisher][lnk-publisher-github]</span></span> | <span data-ttu-id="d88b5-112">[OPC 發行者][lnk-publisher-docker]</span><span class="sxs-lookup"><span data-stu-id="d88b5-112">[OPC Publisher][lnk-publisher-docker]</span></span> |
| <span data-ttu-id="d88b5-113">[OPC Proxy][lnk-proxy-github]</span><span class="sxs-lookup"><span data-stu-id="d88b5-113">[OPC Proxy][lnk-proxy-github]</span></span> | <span data-ttu-id="d88b5-114">[OPC Proxy][lnk-proxy-docker]</span><span class="sxs-lookup"><span data-stu-id="d88b5-114">[OPC Proxy][lnk-proxy-docker]</span></span> |

<span data-ttu-id="d88b5-115">沒有公開 IP 位址或 hello 閘道防火牆中的漏洞所需的其中一個元件。</span><span class="sxs-lookup"><span data-stu-id="d88b5-115">No public-facing IP address or holes in hello gateway firewall are required for either component.</span></span> <span data-ttu-id="d88b5-116">hello OPC Proxy 和 OPC 發行者使用只有輸出連接埠 443、 5671、 和 8883。</span><span class="sxs-lookup"><span data-stu-id="d88b5-116">hello OPC Proxy and OPC Publisher use only outbound ports 443, 5671, and 8883.</span></span>

<span data-ttu-id="d88b5-117">hello 本文章中的步驟示範的閘道器上使用 Docker toodeploy [Windows](#windows-deployment)或[Linux](#linux-deployment)。</span><span class="sxs-lookup"><span data-stu-id="d88b5-117">hello steps in this article show you how toodeploy a gateway using Docker on either [Windows](#windows-deployment) or [Linux](#linux-deployment).</span></span> <span data-ttu-id="d88b5-118">hello 閘道啟用連線 toohello 連接工廠預先設定的解決方案。</span><span class="sxs-lookup"><span data-stu-id="d88b5-118">hello gateway enables connectivity toohello connected factory preconfigured solution.</span></span>

> [!NOTE]
> <span data-ttu-id="d88b5-119">執行 hello Docker 容器中的 hello 閘道軟體[Azure IoT 邊緣]。</span><span class="sxs-lookup"><span data-stu-id="d88b5-119">hello gateway software that runs in hello Docker container is [Azure IoT Edge].</span></span>

## <a name="windows-deployment"></a><span data-ttu-id="d88b5-120">Windows 部署</span><span class="sxs-lookup"><span data-stu-id="d88b5-120">Windows deployment</span></span>

> [!NOTE]
> <span data-ttu-id="d88b5-121">如果您還沒有閘道裝置，Microsoft 建議您從我們的合作夥伴購買商業閘道。</span><span class="sxs-lookup"><span data-stu-id="d88b5-121">If you don't yet have a gateway device, Microsoft recommends you buy a commercial gateway from one of our partners.</span></span> <span data-ttu-id="d88b5-122">請瀏覽 hello [Azure IoT 裝置類別目錄]取得一份 hello 與相容的閘道裝置連線 factory 方案。</span><span class="sxs-lookup"><span data-stu-id="d88b5-122">Visit hello [Azure IoT device catalog] for a list of gateway devices compatible with hello connected factory solution.</span></span> <span data-ttu-id="d88b5-123">請遵循隨附 hello 裝置 tooset hello 閘道組成的 hello 指示。</span><span class="sxs-lookup"><span data-stu-id="d88b5-123">Follow hello instructions that come with hello device tooset up hello gateway.</span></span> <span data-ttu-id="d88b5-124">或者，使用下列的其中一個您現有的閘道設定的指示 toomanually hello。</span><span class="sxs-lookup"><span data-stu-id="d88b5-124">Alternatively, use hello following instructions toomanually set up one of your existing gateways.</span></span>

### <a name="install-docker"></a><span data-ttu-id="d88b5-125">安裝 Docker</span><span class="sxs-lookup"><span data-stu-id="d88b5-125">Install Docker</span></span>

<span data-ttu-id="d88b5-126">在 Windows 閘道裝置上安裝 [Docker for Windows]。</span><span class="sxs-lookup"><span data-stu-id="d88b5-126">Install [Docker for Windows] on your Windows-based gateway device.</span></span> <span data-ttu-id="d88b5-127">在 Windows Docker 安裝期間選取的磁碟機上使用 Docker 您主機機器 tooshare。</span><span class="sxs-lookup"><span data-stu-id="d88b5-127">During Windows Docker setup, select a drive on your host machine tooshare with Docker.</span></span> <span data-ttu-id="d88b5-128">下列螢幕擷取畫面顯示共用 hello D 磁碟機，Windows 系統上的 hello:</span><span class="sxs-lookup"><span data-stu-id="d88b5-128">hello following screenshot shows sharing hello D drive on your Windows system:</span></span>

![安裝 Docker][img-install-docker]

<span data-ttu-id="d88b5-130">然後建立一個稱為資料夾**docker** hello hello 根目錄中共用磁碟機。</span><span class="sxs-lookup"><span data-stu-id="d88b5-130">Then create a folder called **docker** in hello root of hello shared drive.</span></span>
<span data-ttu-id="d88b5-131">您也可以執行此步驟之後從 hello 安裝 docker**設定**功能表。</span><span class="sxs-lookup"><span data-stu-id="d88b5-131">You can also perform this step after installing docker from hello **Settings** menu.</span></span>

### <a name="configure-hello-gateway"></a><span data-ttu-id="d88b5-132">Hello 閘道設定</span><span class="sxs-lookup"><span data-stu-id="d88b5-132">Configure hello gateway</span></span>

1. <span data-ttu-id="d88b5-133">您需要 hello **iothubowner**您的 Azure IoT 套件的連接字串連接工廠部署 toocomplete hello 閘道部署。</span><span class="sxs-lookup"><span data-stu-id="d88b5-133">You need hello **iothubowner** connection string of your Azure IoT Suite connected factory deployment toocomplete hello gateway deployment.</span></span> <span data-ttu-id="d88b5-134">在 hello [Azure 入口網站]，瀏覽的 tooyour 部署 hello 連接工廠方案時，建立 IoT 中樞 hello 資源群組中。</span><span class="sxs-lookup"><span data-stu-id="d88b5-134">In hello [Azure portal], navigate tooyour IoT Hub in hello resource group created when you deployed hello connected factory solution.</span></span> <span data-ttu-id="d88b5-135">按一下**共用存取原則**tooaccess hello **iothubowner**連接字串：</span><span class="sxs-lookup"><span data-stu-id="d88b5-135">Click **Shared access policies** tooaccess hello **iothubowner** connection string:</span></span>

    ![Hello IoT 中樞連接字串中尋找][img-hub-connection]

    <span data-ttu-id="d88b5-137">複製 hello**連接字串-主索引鍵**值。</span><span class="sxs-lookup"><span data-stu-id="d88b5-137">Copy hello **Connection string--primary key** value.</span></span>

1. <span data-ttu-id="d88b5-138">藉由執行 hello 兩個閘道模組，設定您的 IoT 中樞 hello 閘道**一旦**從命令提示字元，使用：</span><span class="sxs-lookup"><span data-stu-id="d88b5-138">Configure hello gateway for your IoT Hub by running hello two gateway modules **once** from a command prompt with:</span></span>

    `docker run -it --rm -h <ApplicationName> -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v //D/docker:/root/.dotnet/corefx/cryptography/x509stores microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName> "<IoTHubOwnerConnectionString>"`

    `docker run -it --rm -v //D/docker:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db`

    * <span data-ttu-id="d88b5-139">**&lt;ApplicationName&gt;** 是 hello 名稱 toogive tooyour OPC UA 發行者 hello 格式**發行者。&lt;完整的網域名稱&gt;**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-139">**&lt;ApplicationName&gt;** is hello name toogive tooyour OPC UA Publisher in hello format **publisher.&lt;your fully qualified domain name&gt;**.</span></span> <span data-ttu-id="d88b5-140">例如，如果您處理站的網路呼叫**myfactorynetwork.com**，hello **ApplicationName**值是**publisher.myfactorynetwork.com**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-140">For example, if your factory network is called **myfactorynetwork.com**, hello **ApplicationName** value is **publisher.myfactorynetwork.com**.</span></span>
    * <span data-ttu-id="d88b5-141">**&lt;IoTHubOwnerConnectionString&gt;** 為 hello **iothubowner** hello 先前步驟中複製的連接字串。</span><span class="sxs-lookup"><span data-stu-id="d88b5-141">**&lt;IoTHubOwnerConnectionString&gt;** is hello **iothubowner** connection string you copied in hello previous step.</span></span> <span data-ttu-id="d88b5-142">這個連接字串只能用在此步驟中，您不需要在 hello 下列步驟：</span><span class="sxs-lookup"><span data-stu-id="d88b5-142">This connection string is only used in this step, you don’t need it in hello following steps:</span></span>

    <span data-ttu-id="d88b5-143">您使用 hello 對應 d:\\docker 資料夾 (hello`-v`引數) 更新 toopersist hello hello 閘道模組使用的兩個 X.509 憑證。</span><span class="sxs-lookup"><span data-stu-id="d88b5-143">You use hello mapped D:\\docker folder (hello `-v` argument) later toopersist hello two X.509 certificates that hello gateway modules use.</span></span>

### <a name="run-hello-gateway"></a><span data-ttu-id="d88b5-144">執行 hello 閘道</span><span class="sxs-lookup"><span data-stu-id="d88b5-144">Run hello gateway</span></span>

1. <span data-ttu-id="d88b5-145">使用下列命令的 hello hello 閘道來重新啟動：</span><span class="sxs-lookup"><span data-stu-id="d88b5-145">Restart hello gateway using hello following commands:</span></span>

    `docker run -it --rm -h <ApplicationName> --expose 62222 -p 62222:62222 -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/Logs -v //D/docker:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v //D/docker:/shared -v //D/docker:/root/.dotnet/corefx/cryptography/x509stores -e _GW_PNFP="/shared/publishednodes.JSON" microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName>`

    `docker run -it --rm -v //D/docker:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -D /mapped/cs.db`

1. <span data-ttu-id="d88b5-146">基於安全性理由，hello 兩個 X.509 憑證保存在 d: hello\\docker 資料夾包含 hello 私密金鑰。</span><span class="sxs-lookup"><span data-stu-id="d88b5-146">For security reasons, hello two X.509 certificates persisted in hello D:\\docker folder contain hello private key.</span></span> <span data-ttu-id="d88b5-147">限制存取 toothis 資料夾 toohello 認證 (通常**管理員**) 使用 toorun hello Docker 容器。</span><span class="sxs-lookup"><span data-stu-id="d88b5-147">Limit access toothis folder toohello credentials (typically **Administrators**) you use toorun hello Docker container.</span></span> <span data-ttu-id="d88b5-148">以滑鼠右鍵按一下 hello d:\\docker 資料夾中，選擇**屬性**，然後**安全性**，然後**編輯**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-148">Right-click hello D:\\docker folder, choose **Properties**, then **Security**, and then **Edit**.</span></span> <span data-ttu-id="d88b5-149">賦予 **Administrators** 完全控制，並移除其他人︰</span><span class="sxs-lookup"><span data-stu-id="d88b5-149">Give **Administrators** full control and remove everyone else:</span></span>

    ![授與權限 tooDocker 共用][img-docker-share]

1. <span data-ttu-id="d88b5-151">驗證網路連線。</span><span class="sxs-lookup"><span data-stu-id="d88b5-151">Verify network connectivity.</span></span> <span data-ttu-id="d88b5-152">從命令提示字元中，輸入 hello 命令`ping publisher.<your fully qualified domain name>`tooping 您的閘道。</span><span class="sxs-lookup"><span data-stu-id="d88b5-152">From a command prompt, enter hello command `ping publisher.<your fully qualified domain name>` tooping your gateway.</span></span> <span data-ttu-id="d88b5-153">如果無法連線到 hello 目的地，新增 hello IP 位址和閘道 toohello hosts 檔案在閘道上的名稱。</span><span class="sxs-lookup"><span data-stu-id="d88b5-153">If hello destination is unreachable, add hello IP address and name of your gateway toohello hosts file on your gateway.</span></span> <span data-ttu-id="d88b5-154">hello 主機檔案位於 hello **Windows\\System32\\驅動程式\\等**資料夾。</span><span class="sxs-lookup"><span data-stu-id="d88b5-154">hello hosts file is located in hello **Windows\\System32\\drivers\\etc** folder.</span></span>

1. <span data-ttu-id="d88b5-155">接下來，請嘗試使用執行 hello 閘道上的本機 OPC UA 用戶端 tooconnect toohello 「 發行者 」。</span><span class="sxs-lookup"><span data-stu-id="d88b5-155">Next, try tooconnect toohello publisher using a local OPC UA client running on hello gateway.</span></span> <span data-ttu-id="d88b5-156">hello OPC UA 端點 URL 為`opc.tcp://publisher.<your fully qualified domain name>:62222`。</span><span class="sxs-lookup"><span data-stu-id="d88b5-156">hello OPC UA endpoint URL is `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span></span> <span data-ttu-id="d88b5-157">如果您沒有 OPC UA 用戶端，則可以下載並使用[開放原始碼的 OPC UA 用戶端]。</span><span class="sxs-lookup"><span data-stu-id="d88b5-157">If you don't have an OPC UA client, you can download and use an [open-source OPC UA client].</span></span>

1. <span data-ttu-id="d88b5-158">當您已成功完成這些本機測試時，瀏覽 toohello**自己 OPC UA 伺服器連接**hello 連接的工廠方案入口網站頁面中。</span><span class="sxs-lookup"><span data-stu-id="d88b5-158">When you have successfully completed these local tests, browse toohello **Connect your own OPC UA Server** page in hello connected factory solution portal.</span></span> <span data-ttu-id="d88b5-159">輸入 hello 發行者端點 URL (`tcp://publisher.<your fully qualified domain name>:62222`) 按一下**連接**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-159">Enter hello publisher endpoint URL (`tcp://publisher.<your fully qualified domain name>:62222`) and click **Connect**.</span></span> <span data-ttu-id="d88b5-160">您會收到憑證警告，然後按一下 [Proceed (繼續)]。</span><span class="sxs-lookup"><span data-stu-id="d88b5-160">You get a certificate warning, then click **Proceed.**</span></span> <span data-ttu-id="d88b5-161">接下來您收到錯誤的 hello 發行者不信任 hello UA Web 用戶端。</span><span class="sxs-lookup"><span data-stu-id="d88b5-161">Next you get an error that hello publisher doesn’t trust hello UA Web Client.</span></span> <span data-ttu-id="d88b5-162">tooresolve 這個錯誤，複製 hello **UA Web 用戶端**憑證從 hello **d:\\docker\\拒絕憑證\\憑證**資料夾 toohello **D:\\docker\\UA 應用程式\\憑證**hello 閘道上的資料夾。</span><span class="sxs-lookup"><span data-stu-id="d88b5-162">tooresolve this error, copy hello **UA Web Client** certificate from hello **D:\\docker\\Rejected Certificates\\certs** folder toohello **D:\\docker\\UA Applications\\certs** folder on hello gateway.</span></span> <span data-ttu-id="d88b5-163">您不需要 toorestart 的 hello 閘道。</span><span class="sxs-lookup"><span data-stu-id="d88b5-163">You do not need toorestart of hello gateway.</span></span> <span data-ttu-id="d88b5-164">重複此步驟。</span><span class="sxs-lookup"><span data-stu-id="d88b5-164">Repeat this step.</span></span> <span data-ttu-id="d88b5-165">您現在可以從 hello 雲端連線 toohello 閘道，而且您會準備 tooadd OPC UA 伺服器 toohello 方案。</span><span class="sxs-lookup"><span data-stu-id="d88b5-165">You can now connect toohello gateway from hello cloud, and you are ready tooadd OPC UA servers toohello solution.</span></span>

### <a name="add-your-opc-ua-servers"></a><span data-ttu-id="d88b5-166">新增 OPC UA 伺服器</span><span class="sxs-lookup"><span data-stu-id="d88b5-166">Add your OPC UA servers</span></span>

1. <span data-ttu-id="d88b5-167">瀏覽 toohello**自己 OPC UA 伺服器連接**hello 連接的工廠方案入口網站頁面中。</span><span class="sxs-lookup"><span data-stu-id="d88b5-167">Browse toohello **Connect your own OPC UA Server** page in hello connected factory solution portal.</span></span> <span data-ttu-id="d88b5-168">請遵循相同的 hello 前面一節 tooestablish 步驟之間的信任 hello 連線的 factory 入口網站和 hello OPC UA 伺服器 hello。</span><span class="sxs-lookup"><span data-stu-id="d88b5-168">Follow hello same steps as in hello preceding section tooestablish trust between hello connected factory portal and hello OPC UA server.</span></span> <span data-ttu-id="d88b5-169">此步驟會建立相互信任的 hello hello 憑證 factory 入口網站和 hello OPC UA 伺服器連線，並建立連線。</span><span class="sxs-lookup"><span data-stu-id="d88b5-169">This step establishes a mutual trust of hello certificates from hello connected factory portal and hello OPC UA server and creates a connection.</span></span>

1. <span data-ttu-id="d88b5-170">瀏覽 hello UA OPC OPC UA 伺服器節點樹狀結構、 以滑鼠右鍵按一下 hello OPC 節點，並選取**發行**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-170">Browse hello OPC UA nodes tree of your OPC UA server, right-click hello OPC nodes, and select **publish**.</span></span> <span data-ttu-id="d88b5-171">發行 toowork 這種方式，如 hello OPC UA 伺服器且 hello 「 發行者 」 必須在 hello 相同的網路。</span><span class="sxs-lookup"><span data-stu-id="d88b5-171">For publishing toowork this way, hello OPC UA server and hello publisher must be on hello same network.</span></span> <span data-ttu-id="d88b5-172">換句話說，如果 hello 完整網域名稱的 hello 發行者是**publisher.mydomain.com** hello hello OPC UA 伺服器必須，例如，完整的網域名稱，然後**myopcuaserver.mydomain.com**.如果您的設定不同，您可以手動新增節點 toohello publishesnodes.json 檔案位於 hello **d:\\docker**資料夾。</span><span class="sxs-lookup"><span data-stu-id="d88b5-172">In other words, if hello fully qualified domain name of hello publisher is **publisher.mydomain.com** then hello fully qualified domain name of hello OPC UA server must be, for example, **myopcuaserver.mydomain.com**. If your setup is different, you can manually add nodes toohello publishesnodes.json file found in hello **D:\\docker** folder.</span></span> <span data-ttu-id="d88b5-173">hello publishesnodes.json 檔案會自動產生 hello 上第一次成功發佈的 OPC 節點。</span><span class="sxs-lookup"><span data-stu-id="d88b5-173">hello publishesnodes.json file is automatically generated on hello first successful publish of an OPC node.</span></span>

1. <span data-ttu-id="d88b5-174">遙測現在順著 hello 閘道裝置。</span><span class="sxs-lookup"><span data-stu-id="d88b5-174">Telemetry now flows from hello gateway device.</span></span> <span data-ttu-id="d88b5-175">您可以在 hello 檢視 hello 遙測**Factory 位置**hello 連線的 factory 入口網站下的檢視**新的處理站**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-175">You can view hello telemetry in hello **Factory Locations** view of hello connected factory portal under **New Factory**.</span></span>

## <a name="linux-deployment"></a><span data-ttu-id="d88b5-176">Linux 部署</span><span class="sxs-lookup"><span data-stu-id="d88b5-176">Linux deployment</span></span>

> [!NOTE]
> <span data-ttu-id="d88b5-177">如果您還沒有閘道裝置，Microsoft 建議您從我們的合作夥伴購買商業閘道。</span><span class="sxs-lookup"><span data-stu-id="d88b5-177">If you don't yet have a gateway device, Microsoft recommends you buy a commercial gateway from one of our partners.</span></span> <span data-ttu-id="d88b5-178">請瀏覽 hello [Azure IoT 裝置類別目錄]取得一份 hello 與相容的閘道裝置連線 factory 方案。</span><span class="sxs-lookup"><span data-stu-id="d88b5-178">Visit hello [Azure IoT device catalog] for a list of gateway devices compatible with hello connected factory solution.</span></span> <span data-ttu-id="d88b5-179">請遵循隨附 hello 裝置 tooset hello 閘道組成的 hello 指示。</span><span class="sxs-lookup"><span data-stu-id="d88b5-179">Follow hello instructions that come with hello device tooset up hello gateway.</span></span> <span data-ttu-id="d88b5-180">或者，使用下列的其中一個您現有的閘道設定的指示 toomanually hello。</span><span class="sxs-lookup"><span data-stu-id="d88b5-180">Alternatively, use hello following instructions toomanually set up one of your existing gateways.</span></span>

<span data-ttu-id="d88b5-181">在 Linux 閘道裝置上[安裝 Docker]。</span><span class="sxs-lookup"><span data-stu-id="d88b5-181">[Install Docker] on your Linux gateway device.</span></span>

### <a name="configure-hello-gateway"></a><span data-ttu-id="d88b5-182">Hello 閘道設定</span><span class="sxs-lookup"><span data-stu-id="d88b5-182">Configure hello gateway</span></span>

1. <span data-ttu-id="d88b5-183">您需要 hello **iothubowner**您的 Azure IoT 套件的連接字串連接工廠部署 toocomplete hello 閘道部署。</span><span class="sxs-lookup"><span data-stu-id="d88b5-183">You need hello **iothubowner** connection string of your Azure IoT Suite connected factory deployment toocomplete hello gateway deployment.</span></span> <span data-ttu-id="d88b5-184">在 hello [Azure 入口網站]，瀏覽的 tooyour 部署 hello 連接工廠方案時，建立 IoT 中樞 hello 資源群組中。</span><span class="sxs-lookup"><span data-stu-id="d88b5-184">In hello [Azure portal], navigate tooyour IoT Hub in hello resource group created when you deployed hello connected factory solution.</span></span> <span data-ttu-id="d88b5-185">按一下**共用存取原則**tooaccess hello **iothubowner**連接字串：</span><span class="sxs-lookup"><span data-stu-id="d88b5-185">Click **Shared access policies** tooaccess hello **iothubowner** connection string:</span></span>

    ![Hello IoT 中樞連接字串中尋找][img-hub-connection]

    <span data-ttu-id="d88b5-187">複製 hello**連接字串-主索引鍵**值。</span><span class="sxs-lookup"><span data-stu-id="d88b5-187">Copy hello **Connection string--primary key** value.</span></span>

1. <span data-ttu-id="d88b5-188">藉由執行 hello 兩個閘道模組，設定您的 IoT 中樞 hello 閘道**一旦**從與殼層：</span><span class="sxs-lookup"><span data-stu-id="d88b5-188">Configure hello gateway for your IoT Hub by running hello two gateway modules **once** from a shell with:</span></span>

    `sudo docker run -it --rm -h <ApplicationName> -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/ -v /shared:/root/.dotnet/corefx/cryptography/x509stores microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName> "<IoTHubOwnerConnectionString>"`

    `sudo docker run --rm -it -v /shared:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -i -c "<IoTHubOwnerConnectionString>" -D /mapped/cs.db`

    * <span data-ttu-id="d88b5-189">**&lt;ApplicationName&gt;**  hello hello OPC UA 應用程式 hello 閘道建立 hello 格式名稱**發行者。&lt;完整的網域名稱&gt;**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-189">**&lt;ApplicationName&gt;** is hello name of hello OPC UA application hello gateway creates in hello format **publisher.&lt;your fully qualified domain name&gt;**.</span></span> <span data-ttu-id="d88b5-190">例如，**publisher.microsoft.com**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-190">For example, **publisher.microsoft.com**.</span></span>
    * <span data-ttu-id="d88b5-191">**&lt;IoTHubOwnerConnectionString&gt;** 為 hello **iothubowner** hello 先前步驟中複製的連接字串。</span><span class="sxs-lookup"><span data-stu-id="d88b5-191">**&lt;IoTHubOwnerConnectionString&gt;** is hello **iothubowner** connection string you copied in hello previous step.</span></span> <span data-ttu-id="d88b5-192">這個連接字串只能用在此步驟中，您不需要在 hello 下列步驟：</span><span class="sxs-lookup"><span data-stu-id="d88b5-192">This connection string is only used in this step, you don’t need it in hello following steps:</span></span>

    <span data-ttu-id="d88b5-193">使用 hello **/ 共用**資料夾 (hello`-v`引數) 更新 toopersist hello hello 閘道模組使用的兩個 X.509 憑證。</span><span class="sxs-lookup"><span data-stu-id="d88b5-193">You use hello **/shared** folder (hello `-v` argument) later toopersist hello two X.509 certificates that hello gateway modules use.</span></span>

### <a name="run-hello-gateway"></a><span data-ttu-id="d88b5-194">執行 hello 閘道</span><span class="sxs-lookup"><span data-stu-id="d88b5-194">Run hello gateway</span></span>

1. <span data-ttu-id="d88b5-195">使用下列命令的 hello hello 閘道來重新啟動：</span><span class="sxs-lookup"><span data-stu-id="d88b5-195">Restart hello gateway using hello following commands:</span></span>

    `sudo docker run -it -h <ApplicationName> --expose 62222 -p 62222:62222 –-rm -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/Logs -v /shared:/build/src/GatewayApp.NetCore/bin/Debug/netcoreapp1.0/publish/CertificateStores -v /shared:/shared -v /shared:/root/.dotnet/corefx/cryptography/x509stores -e _GW_PNFP="/shared/publishednodes.JSON" microsoft/iot-gateway-opc-ua:1.0.0 <ApplicationName>`

    `sudo docker run -it -v /shared:/mapped microsoft/iot-gateway-opc-ua-proxy:0.1.3 -D /mapped/cs.db`

1. <span data-ttu-id="d88b5-196">基於安全性理由，hello 兩個 X.509 憑證保存在 hello **/ 共用**資料夾包含 hello 私密金鑰。</span><span class="sxs-lookup"><span data-stu-id="d88b5-196">For security reasons, hello two X.509 certificates persisted in hello **/shared** folder contain hello private key.</span></span> <span data-ttu-id="d88b5-197">限制存取 toothis 資料夾 toohello 認證使用 toorun hello Docker 容器。</span><span class="sxs-lookup"><span data-stu-id="d88b5-197">Limit access toothis folder toohello credentials you use toorun hello Docker container.</span></span> <span data-ttu-id="d88b5-198">tooset hello 權限**根**只能使用 hello`chmod`殼層 hello 資料夾上的命令。</span><span class="sxs-lookup"><span data-stu-id="d88b5-198">tooset hello permissions for **root** only, use hello `chmod` shell command on hello folder.</span></span>

1. <span data-ttu-id="d88b5-199">驗證網路連線。</span><span class="sxs-lookup"><span data-stu-id="d88b5-199">Verify network connectivity.</span></span> <span data-ttu-id="d88b5-200">從殼層中，輸入 hello 命令`ping publisher.<your fully qualified domain name>`tooping 您的閘道。</span><span class="sxs-lookup"><span data-stu-id="d88b5-200">From a shell, enter hello command `ping publisher.<your fully qualified domain name>` tooping your gateway.</span></span> <span data-ttu-id="d88b5-201">如果無法連線到 hello 目的地，新增 hello IP 位址和閘道 tooyour hosts 檔案在閘道上的名稱。</span><span class="sxs-lookup"><span data-stu-id="d88b5-201">If hello destination is unreachable, add hello IP address and name of your gateway tooyour hosts file on your gateway.</span></span> <span data-ttu-id="d88b5-202">hello 主機檔案位於 hello **/等等**資料夾。</span><span class="sxs-lookup"><span data-stu-id="d88b5-202">hello hosts file is located in hello **/etc** folder.</span></span>

1. <span data-ttu-id="d88b5-203">接下來，請嘗試使用執行 hello 閘道上的本機 OPC UA 用戶端 tooconnect toohello 「 發行者 」。</span><span class="sxs-lookup"><span data-stu-id="d88b5-203">Next, try tooconnect toohello publisher using a local OPC UA client running on hello gateway.</span></span> <span data-ttu-id="d88b5-204">hello OPC UA 端點 URL 為`opc.tcp://publisher.<your fully qualified domain name>:62222`。</span><span class="sxs-lookup"><span data-stu-id="d88b5-204">hello OPC UA endpoint URL is `opc.tcp://publisher.<your fully qualified domain name>:62222`.</span></span> <span data-ttu-id="d88b5-205">如果您沒有 OPC UA 用戶端，則可以下載並使用[開放原始碼的 OPC UA 用戶端]。</span><span class="sxs-lookup"><span data-stu-id="d88b5-205">If you don't have an OPC UA client, you can download and use an [open-source OPC UA client].</span></span>

1. <span data-ttu-id="d88b5-206">當您已成功完成這些本機測試時，瀏覽 toohello**自己 OPC UA 伺服器連接**hello 連接的工廠方案入口網站頁面中。</span><span class="sxs-lookup"><span data-stu-id="d88b5-206">When you have successfully completed these local tests, browse toohello **Connect your own OPC UA Server** page in hello connected factory solution portal.</span></span> <span data-ttu-id="d88b5-207">輸入 hello 發行者端點 URL (`tcp://publisher.<your fully qualified domain name>:62222`) 按一下**連接**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-207">Enter hello publisher endpoint URL (`tcp://publisher.<your fully qualified domain name>:62222`) and click **Connect**.</span></span> <span data-ttu-id="d88b5-208">您會收到憑證警告，然後按一下 [Proceed (繼續)]。</span><span class="sxs-lookup"><span data-stu-id="d88b5-208">You get a certificate warning, then click **Proceed.**</span></span> <span data-ttu-id="d88b5-209">接下來您收到錯誤的 hello 發行者不信任 hello UA Web 用戶端。</span><span class="sxs-lookup"><span data-stu-id="d88b5-209">Next you get an error that hello publisher doesn’t trust hello UA Web Client.</span></span> <span data-ttu-id="d88b5-210">tooresolve 這個錯誤，複製 hello **UA Web 用戶端**憑證從 hello **/共用/已拒絕憑證/憑證**資料夾 toohello **/shared/UA 應用程式/憑證**hello 閘道上的資料夾。</span><span class="sxs-lookup"><span data-stu-id="d88b5-210">tooresolve this error, copy hello **UA Web Client** certificate from hello **/shared/Rejected Certificates/certs** folder toohello **/shared/UA Applications/certs** folder on hello gateway.</span></span> <span data-ttu-id="d88b5-211">您不需要 toorestart 的 hello 閘道。</span><span class="sxs-lookup"><span data-stu-id="d88b5-211">You do not need toorestart of hello gateway.</span></span> <span data-ttu-id="d88b5-212">重複此步驟。</span><span class="sxs-lookup"><span data-stu-id="d88b5-212">Repeat this step.</span></span> <span data-ttu-id="d88b5-213">您現在可以從 hello 雲端連線 toohello 閘道，而且您會準備 tooadd OPC UA 伺服器 toohello 方案。</span><span class="sxs-lookup"><span data-stu-id="d88b5-213">You can now connect toohello gateway from hello cloud, and you are ready tooadd OPC UA servers toohello solution.</span></span>

### <a name="add-your-opc-ua-servers"></a><span data-ttu-id="d88b5-214">新增 OPC UA 伺服器</span><span class="sxs-lookup"><span data-stu-id="d88b5-214">Add your OPC UA servers</span></span>

1. <span data-ttu-id="d88b5-215">瀏覽 toohello**自己 OPC UA 伺服器連接**hello 連接的工廠方案入口網站頁面中。</span><span class="sxs-lookup"><span data-stu-id="d88b5-215">Browse toohello **Connect your own OPC UA Server** page in hello connected factory solution portal.</span></span> <span data-ttu-id="d88b5-216">請遵循相同的 hello 前面一節 tooestablish 步驟之間的信任 hello 連線的 factory 入口網站和 hello OPC UA 伺服器 hello。</span><span class="sxs-lookup"><span data-stu-id="d88b5-216">Follow hello same steps as in hello preceding section tooestablish trust between hello connected factory portal and hello OPC UA server.</span></span> <span data-ttu-id="d88b5-217">此步驟會建立相互信任的 hello hello 憑證 factory 入口網站和 hello OPC UA 伺服器連線，並建立連線。</span><span class="sxs-lookup"><span data-stu-id="d88b5-217">This step establishes a mutual trust of hello certificates from hello connected factory portal and hello OPC UA server and creates a connection.</span></span>

1. <span data-ttu-id="d88b5-218">瀏覽 hello UA OPC OPC UA 伺服器節點樹狀結構、 以滑鼠右鍵按一下 hello OPC 節點，並選取**發行**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-218">Browse hello OPC UA nodes tree of your OPC UA server, right-click hello OPC nodes, and select **publish**.</span></span> <span data-ttu-id="d88b5-219">發行 toowork 這種方式，如 hello OPC UA 伺服器且 hello 「 發行者 」 必須在 hello 相同的網路。</span><span class="sxs-lookup"><span data-stu-id="d88b5-219">For publishing toowork this way, hello OPC UA server and hello publisher must be on hello same network.</span></span> <span data-ttu-id="d88b5-220">換句話說，如果 hello 完整網域名稱的 hello 發行者是**publisher.mydomain.com** hello hello OPC UA 伺服器必須，例如，完整的網域名稱，然後**myopcuaserver.mydomain.com**.如果您的設定不同，您可以手動新增節點 toohello publishesnodes.json 檔案位於 hello **/ 共用**資料夾。</span><span class="sxs-lookup"><span data-stu-id="d88b5-220">In other words, if hello fully qualified domain name of hello publisher is **publisher.mydomain.com** then hello fully qualified domain name of hello OPC UA server must be, for example, **myopcuaserver.mydomain.com**. If your setup is different, you can manually add nodes toohello publishesnodes.json file found in hello **/shared** folder.</span></span> <span data-ttu-id="d88b5-221">hello publishesnodes.json 會自動產生 hello 上第一次成功發佈的 OPC 節點。</span><span class="sxs-lookup"><span data-stu-id="d88b5-221">hello publishesnodes.json is automatically generated on hello first successful publish of an OPC node.</span></span>

1. <span data-ttu-id="d88b5-222">遙測現在順著 hello 閘道裝置。</span><span class="sxs-lookup"><span data-stu-id="d88b5-222">Telemetry now flows from hello gateway device.</span></span> <span data-ttu-id="d88b5-223">您可以在 hello 檢視 hello 遙測**Factory 位置**hello 連線的 factory 入口網站下的檢視**新的處理站**。</span><span class="sxs-lookup"><span data-stu-id="d88b5-223">You can view hello telemetry in hello **Factory Locations** view of hello connected factory portal under **New Factory**.</span></span>

## <a name="next-steps"></a><span data-ttu-id="d88b5-224">後續步驟</span><span class="sxs-lookup"><span data-stu-id="d88b5-224">Next steps</span></span>

<span data-ttu-id="d88b5-225">進一步了解 hello 連線 factory 的 hello 架構 toolearn 預先設定的方案，請參閱[連接的工廠預先設定方案的逐步解說][lnk-walkthrough]。</span><span class="sxs-lookup"><span data-stu-id="d88b5-225">toolearn more about hello architecture of hello connected factory preconfigured solution, see [Connected factory preconfigured solution walkthrough][lnk-walkthrough].</span></span>

[img-install-docker]: ./media/iot-suite-connected-factory-gateway-deployment/image1.png
[img-hub-connection]: ./media/iot-suite-connected-factory-gateway-deployment/image2.png
[img-docker-share]: ./media/iot-suite-connected-factory-gateway-deployment/image3.png

[Docker for Windows]: https://www.docker.com/docker-windows
[Azure IoT 裝置類別目錄]: https://catalog.azureiotsuite.com/?q=opc
[Azure 入口網站]: http://portal.azure.com/
[開放原始碼的 OPC UA 用戶端]: https://github.com/OPCFoundation/UA-.NETStandardLibrary/tree/master/SampleApplications/Samples/Client.Net4
[安裝 Docker]: https://www.docker.com/community-edition#/download
[lnk-walkthrough]: iot-suite-connected-factory-sample-walkthrough.md
[Azure IoT 邊緣]: https://github.com/Azure/iot-edge

[lnk-publisher-github]: https://github.com/Azure/iot-edge-opc-publisher
[lnk-publisher-docker]: https://hub.docker.com/r/microsoft/iot-gateway-opc-ua
[lnk-proxy-github]: https://github.com/Azure/iot-edge-opc-proxy
[lnk-proxy-docker]: https://hub.docker.com/r/microsoft/iot-gateway-opc-ua-proxy