---
title: "Azure 媒體服務的分散 MP4 即時內嵌規格 | Microsoft Docs"
description: "此規格說明以分散 MP4 為基礎的即時串流內嵌通訊協定和格式 (適用於 Azure 媒體服務)。 您可以使用 Azure 媒體服務來串流處理即時事件，並使用 Azure 做為雲端平台廣播即時內容。 本文件也討論建置高度備援且強固之即時內嵌機制的最佳做法。"
services: media-services
documentationcenter: 
author: cenkdin
manager: cfowler
editor: 
ms.assetid: 43fac263-a5ea-44af-8dd5-cc88e423b4de
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/29/2017
ms.author: cenkd;juliako
ms.openlocfilehash: 6250b73504bec765b8299060a29e84e771791cc9
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/29/2017
---
# <a name="azure-media-services-fragmented-mp4-live-ingest-specification"></a><span data-ttu-id="b5fdf-105">Azure 媒體服務的分散 MP4 即時內嵌規格</span><span class="sxs-lookup"><span data-stu-id="b5fdf-105">Azure Media Services fragmented MP4 live ingest specification</span></span>
<span data-ttu-id="b5fdf-106">此規格說明以分散 MP4 為基礎的即時串流內嵌通訊協定和格式 (適用於 Azure 媒體服務)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-106">This specification describes the protocol and format for fragmented MP4-based live streaming ingestion for Azure Media Services.</span></span> <span data-ttu-id="b5fdf-107">媒體服務提供即時串流服務，讓客戶可使用 Azure 做為雲端平台來串流即時事件和廣播即時內容。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-107">Media Services provides a live streaming service that customers can use to stream live events and broadcast content in real time by using Azure as the cloud platform.</span></span> <span data-ttu-id="b5fdf-108">本文件也討論建置高度備援且強固之即時內嵌機制的最佳做法。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-108">This document also discusses best practices for building highly redundant and robust live ingest mechanisms.</span></span>

## <a name="1-conformance-notation"></a><span data-ttu-id="b5fdf-109">1.一致性標記法</span><span class="sxs-lookup"><span data-stu-id="b5fdf-109">1. Conformance notation</span></span>
<span data-ttu-id="b5fdf-110">本文件中「必須」、「不得」、「必要」、「可」、「不可」、「應該」、「不應」、「建議」、「可能」及「選擇性」等關鍵字的解釋如 RFC 2119 中所述。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-110">The key words "MUST," "MUST NOT," "REQUIRED," "SHALL," "SHALL NOT," "SHOULD," "SHOULD NOT," "RECOMMENDED," "MAY," and "OPTIONAL" in this document are to be interpreted as they are described in RFC 2119.</span></span>

## <a name="2-service-diagram"></a><span data-ttu-id="b5fdf-111">2.服務圖表</span><span class="sxs-lookup"><span data-stu-id="b5fdf-111">2. Service diagram</span></span>
<span data-ttu-id="b5fdf-112">下圖顯示媒體服務中即時串流服務的高階架構：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-112">The following diagram shows the high-level architecture of the live streaming service in Media Services:</span></span>

1. <span data-ttu-id="b5fdf-113">即時編碼器會將即時摘要推送到透過 Azure 媒體服務 SDK 建立並佈建的通道。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-113">A live encoder pushes live feeds to channels that are created and provisioned via the Azure Media Services SDK.</span></span>
2. <span data-ttu-id="b5fdf-114">媒體服務中的通道、程式與串流端點會處理所有的即時串流功能，包括內嵌、格式化、雲端 DVR、安全性、延展性和備援能力。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-114">Channels, programs, and streaming endpoints in Media Services handle all the live streaming functionalities, including ingest, formatting, cloud DVR, security, scalability, and redundancy.</span></span>
3. <span data-ttu-id="b5fdf-115">客戶可以選擇性地在串流端點與用戶端端點之間選擇部署 Azure 內容傳遞網路層。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-115">Optionally, customers can choose to deploy an Azure Content Delivery Network layer between the streaming endpoint and the client endpoints.</span></span>
4. <span data-ttu-id="b5fdf-116">用戶端會使用 HTTP 彈性資料流通訊協定，從串流端點開始執行串流。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-116">Client endpoints stream from the streaming endpoint by using HTTP Adaptive Streaming protocols.</span></span> <span data-ttu-id="b5fdf-117">範例包括 Microsoft Smooth Streaming、透過 HTTP 執行的動態彈性資料流 (DASH 或 MPEG-DASH)，以及 Apple HTTP 即時串流 (HLS)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-117">Examples include Microsoft Smooth Streaming, Dynamic Adaptive Streaming over HTTP (DASH, or MPEG-DASH), and Apple HTTP Live Streaming (HLS).</span></span>

![內嵌流程][image1]

## <a name="3-bitstream-format--iso-14496-12-fragmented-mp4"></a><span data-ttu-id="b5fdf-119">3.位元資料流格式 – ISO 14496-12 分散 MP4</span><span class="sxs-lookup"><span data-stu-id="b5fdf-119">3. Bitstream format – ISO 14496-12 fragmented MP4</span></span>
<span data-ttu-id="b5fdf-120">本文件中所討論即時資料流內嵌的電傳格式是根據 [ISO-14496-12]。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-120">The wire format for live streaming ingest discussed in this document is based on [ISO-14496-12].</span></span> <span data-ttu-id="b5fdf-121">如需分散 MP4 格式、點播視訊檔案及即時串流內嵌的詳細說明，請參閱 [[MS-SSTR]](http://msdn.microsoft.com/library/ff469518.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-121">For a detailed explanation of fragmented MP4 format and extensions both for video-on-demand files and live streaming ingestion, see [[MS-SSTR]](http://msdn.microsoft.com/library/ff469518.aspx).</span></span>

### <a name="live-ingest-format-definitions"></a><span data-ttu-id="b5fdf-122">即時內嵌格式定義</span><span class="sxs-lookup"><span data-stu-id="b5fdf-122">Live ingest format definitions</span></span>
<span data-ttu-id="b5fdf-123">下列清單說明適用於即時內嵌至 Azure 媒體服務的特殊格式定義：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-123">The following list describes special format definitions that apply to live ingest into Azure Media Services:</span></span>

1. <span data-ttu-id="b5fdf-124">**ftyp**、**Live Server Manifest Box**，以及 **moov** 方塊「必須」連同每個要求 (HTTP POST) 一起傳送。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-124">The **ftyp**, **Live Server Manifest Box**, and **moov** boxes MUST be sent with each request (HTTP POST).</span></span> <span data-ttu-id="b5fdf-125">這些方塊「必須」在資料流的開頭傳送，且若要繼續執行資料流內嵌時，編碼器每次皆須重新連線。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-125">These boxes MUST be sent at the beginning of the stream and any time the encoder must reconnect to resume stream ingest.</span></span> <span data-ttu-id="b5fdf-126">如需詳細資訊，請參閱 [1] 的第 6 節。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-126">For more information, see Section 6 in [1].</span></span>
2. <span data-ttu-id="b5fdf-127">[1] 的第 3.3.2 節為即時內嵌定義名為 **StreamManifestBox** 的選用方塊。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-127">Section 3.3.2 in [1] defines an optional box called **StreamManifestBox** for live ingest.</span></span> <span data-ttu-id="b5fdf-128">由於 Azure 負載平衡器的路由邏輯，使用此方塊已遭取代。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-128">Due to the routing logic of the Azure load balancer, using this box is deprecated.</span></span> <span data-ttu-id="b5fdf-129">內嵌至媒體服務時，「不應」出現方塊。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-129">The box SHOULD NOT be present when ingesting into Media Services.</span></span> <span data-ttu-id="b5fdf-130">如果有此方塊，則媒體服務會以無訊息方式將其忽略。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-130">If this box is present, Media Services silently ignores it.</span></span>
3. <span data-ttu-id="b5fdf-131">每個片段必須具有在 [1] 之 3.2.3.2 中定義的 **TrackFragmentExtendedHeaderBox** 方塊。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-131">The **TrackFragmentExtendedHeaderBox** box defined in 3.2.3.2 in [1] MUST be present for each fragment.</span></span>
4. <span data-ttu-id="b5fdf-132">「應該」使用第 2 版的 **TrackFragmentExtendedHeaderBox** 方塊，才能產生在多個資料中心中擁有相同 URL 的媒體區段。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-132">Version 2 of the **TrackFragmentExtendedHeaderBox** box SHOULD be used to generate media segments that have identical URLs in multiple datacenters.</span></span> <span data-ttu-id="b5fdf-133">如需跨資料中心容錯移轉以索引為基礎的資料流格式，例如 Apple HLS 和以索引為基礎的 MPEG DASH，則片段索引欄位為「必要」項目。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-133">The fragment index field is REQUIRED for cross-datacenter failover of index-based streaming formats such as Apple HLS and index-based MPEG-DASH.</span></span> <span data-ttu-id="b5fdf-134">若要啟用跨資料中心容錯移轉，多個編碼器之間的片段索引「必須」同步處理，後續的每個媒體片段會增加 1，即使是跨編碼器重新啟動或失敗亦然。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-134">To enable cross-datacenter failover, the fragment index MUST be synced across multiple encoders and be increased by 1 for each successive media fragment, even across encoder restarts or failures.</span></span>
5. <span data-ttu-id="b5fdf-135">[1] 中的第 3.3.6 節定義名為 **MovieFragmentRandomAccessBox** (**mfra**) 的方塊，此方塊「可能」會在即時內嵌結束時傳送，以表示通道的結束資料流 (EOS)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-135">Section 3.3.6 in [1] defines a box called **MovieFragmentRandomAccessBox** (**mfra**) that MAY be sent at the end of live ingestion to indicate end-of-stream (EOS) to the channel.</span></span> <span data-ttu-id="b5fdf-136">由於使用 EOS 的媒體服務內嵌邏輯已遭取代，因此「不應」傳送即時內嵌的 **mfra** 方塊。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-136">Due to the ingest logic of Media Services, using EOS is deprecated, and the **mfra** box for live ingestion SHOULD NOT be sent.</span></span> <span data-ttu-id="b5fdf-137">如果已傳送，媒體服務會以無訊息方式將其忽略。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-137">If sent, Media Services silently ignores it.</span></span> <span data-ttu-id="b5fdf-138">若要重設內嵌點的狀態，建議您使用[通道重設](https://docs.microsoft.com/rest/api/media/operations/channel#reset_channels)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-138">To reset the state of the ingest point, we recommend that you use [Channel Reset](https://docs.microsoft.com/rest/api/media/operations/channel#reset_channels).</span></span> <span data-ttu-id="b5fdf-139">我們也建議您使用[程式停止](https://msdn.microsoft.com/library/azure/dn783463.aspx#stop_programs)以結束簡報和資料流。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-139">We also recommend that you use [Program Stop](https://msdn.microsoft.com/library/azure/dn783463.aspx#stop_programs) to end a presentation and stream.</span></span>
6. <span data-ttu-id="b5fdf-140">MP4 片段持續期間「應該」是常數，可縮減用戶端資訊清單的大小。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-140">The MP4 fragment duration SHOULD be constant, to reduce the size of the client manifests.</span></span> <span data-ttu-id="b5fdf-141">常數 MP4 片段持續時間也可以透過使用重複標記來改善用戶端下載啟發學習法。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-141">A constant MP4 fragment duration also improves client download heuristics through the use of repeat tags.</span></span> <span data-ttu-id="b5fdf-142">持續時間「可能」會變動以補償非整數的畫面播放速率。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-142">The duration MAY fluctuate to compensate for non-integer frame rates.</span></span>
7. <span data-ttu-id="b5fdf-143">MP4 片段持續期間「應該」大約在 2 到 6 秒之間。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-143">The MP4 fragment duration SHOULD be between approximately 2 and 6 seconds.</span></span>
8. <span data-ttu-id="b5fdf-144">「應該」以遞增順序送達 MP4 片段時間戳記和索引 (**TrackFragmentExtendedHeaderBox** `fragment_ absolute_ time` 和 `fragment_index`)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-144">MP4 fragment timestamps and indexes (**TrackFragmentExtendedHeaderBox** `fragment_ absolute_ time` and `fragment_index`) SHOULD arrive in increasing order.</span></span> <span data-ttu-id="b5fdf-145">雖然媒體服務在複製片段方面很有彈性，但是其在根據媒體時間軸重新排列片段順序方面的功能有限。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-145">Although Media Services is resilient to duplicate fragments, it has limited ability to reorder fragments according to the media timeline.</span></span>

## <a name="4-protocol-format--http"></a><span data-ttu-id="b5fdf-146">4.通訊協定格式 – HTTP</span><span class="sxs-lookup"><span data-stu-id="b5fdf-146">4. Protocol format – HTTP</span></span>
<span data-ttu-id="b5fdf-147">媒體服務的 ISO 分散 MP4 式即時內嵌，使用標準的長時間運作 HTTP POST 要求，以將採用分散 MP4 格式封裝的編碼媒體資料傳輸至服務。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-147">ISO fragmented MP4-based live ingest for Media Services uses a standard long-running HTTP POST request to transmit encoded media data that is packaged in fragmented MP4 format to the service.</span></span> <span data-ttu-id="b5fdf-148">每個 HTTP POST 會傳送完整的分散 MP4 位元資料流 ("stream")，其開頭為標頭方塊 (**ftyp**、**Live Server Manifest Box** 及 **moov** 方塊)，並接續著連串的片段 (**moof** 與 **mdat** 方塊)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-148">Each HTTP POST sends a complete fragmented MP4 bitstream ("stream"), starting from the beginning with header boxes (**ftyp**, **Live Server Manifest Box**, and **moov** boxes), and continuing with a sequence of fragments (**moof** and **mdat** boxes).</span></span> <span data-ttu-id="b5fdf-149">如需 HTTP POST 要求的 URL 語法，請參閱 [1] 的第 9.2 節。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-149">For URL syntax for the HTTP POST request, see section 9.2 in [1].</span></span> <span data-ttu-id="b5fdf-150">以下是 POST URL 的範例：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-150">An example of the POST URL is:</span></span> 

    http://customer.channel.mediaservices.windows.net/ingest.isml/streams(720p)

### <a name="requirements"></a><span data-ttu-id="b5fdf-151">需求</span><span class="sxs-lookup"><span data-stu-id="b5fdf-151">Requirements</span></span>
<span data-ttu-id="b5fdf-152">詳細需求如下：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-152">Here are the detailed requirements:</span></span>

1. <span data-ttu-id="b5fdf-153">編碼器「應該」使用相同的內嵌 URL 來傳送空白 “body” (零內容長度) 的 HTTP POST 要求，藉此開始廣播。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-153">The encoder SHOULD start the broadcast by sending an HTTP POST request with an empty “body” (zero content length) by using the same ingestion URL.</span></span> <span data-ttu-id="b5fdf-154">這可協助編碼器快速偵測即時內嵌端點是否有效，以及是否需要任何的驗證或其他條件。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-154">This can help the encoder quickly detect whether the live ingestion endpoint is valid, and if there are any authentication or other conditions required.</span></span> <span data-ttu-id="b5fdf-155">伺服器無法對每個 HTTP 通訊協定傳回 HTTP 回應，直到收到整個要求為止，包括 POST 內文。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-155">Per HTTP protocol, the server can't send back an HTTP response until the entire request, including the POST body, is received.</span></span> <span data-ttu-id="b5fdf-156">由於即時事件其長時間執行的性質，若無此步驟，編碼器在完成傳送所有資料之前，無法偵測到任何錯誤。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-156">Given the long-running nature of a live event, without this step, the encoder might not be able to detect any error until it finishes sending all the data.</span></span>
2. <span data-ttu-id="b5fdf-157">編碼器「必須」處理任何因為 (1) 而造成的錯誤或驗證挑戰。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-157">The encoder MUST handle any errors or authentication challenges because of (1).</span></span> <span data-ttu-id="b5fdf-158">如果 (1) 後續的回應為 200，則繼續進行。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-158">If (1) succeeds with a 200 response, continue.</span></span>
3. <span data-ttu-id="b5fdf-159">編碼器「必須」以分散 MP4 資料流開始新的 HTTP POST 要求。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-159">The encoder MUST start a new HTTP POST request with the fragmented MP4 stream.</span></span> <span data-ttu-id="b5fdf-160">承載的開頭「必須」是標頭方塊，後面加上片段。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-160">The payload MUST start with the header boxes, followed by fragments.</span></span> <span data-ttu-id="b5fdf-161">請注意，由於上一個要求在資料流結束前終止，因此即使編碼器必須重新連線，**ftyp**、**Live Server Manifest Box** 及 **moov** 方塊 (依此順序) 仍「必須」連同每個要求傳送。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-161">Note that the **ftyp**, **Live Server Manifest Box**, and **moov** boxes (in this order) MUST be sent with each request, even if the encoder must reconnect because the previous request was terminated prior to the end of the stream.</span></span> 
4. <span data-ttu-id="b5fdf-162">因為無法預測即時事件的整個內容長度，編碼器「必須」使用區塊傳送編碼上傳。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-162">The encoder MUST use chunked transfer encoding for uploading, because it’s impossible to predict the entire content length of the live event.</span></span>
5. <span data-ttu-id="b5fdf-163">當事件結束時，在傳送最後一個片段之後，編碼器「必須」依正常程序結束區塊傳輸編碼的訊息序列 (大部分的 HTTP 用戶端堆疊會自動處理)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-163">When the event is over, after sending the last fragment, the encoder MUST gracefully end the chunked transfer encoding message sequence (most HTTP client stacks handle it automatically).</span></span> <span data-ttu-id="b5fdf-164">編碼器「必須」等候服務傳回最後的回應碼，然後終止連線。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-164">The encoder MUST wait for the service to return the final response code, and then terminate the connection.</span></span> 
6. <span data-ttu-id="b5fdf-165">如 [1] 中第 9.2 節所述，編碼器「不得」使用 `Events()` 名詞，才能即時內嵌至媒體服務。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-165">The encoder MUST NOT use the `Events()` noun as described in 9.2 in [1] for live ingestion into Media Services.</span></span>
7. <span data-ttu-id="b5fdf-166">如果 HTTP POST 要求在資料流結束之前因為出現 TCP 錯誤而終止或逾時，則編碼器「必須」藉由使用新連線發出新的 POST 要求，並遵循上述要求。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-166">If the HTTP POST request terminates or times out with a TCP error prior to the end of the stream, the encoder MUST issue a new POST request by using a new connection, and follow the preceding requirements.</span></span> <span data-ttu-id="b5fdf-167">此外，編碼器「必須」為資料流中的每個資料軌重新傳送前兩個 MP4 片段，並在不會造成媒體時間軸不連續的情況下繼續運作。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-167">Additionally, the encoder MUST resend the previous two MP4 fragments for each track in the stream, and resume without introducing a discontinuity in the media timeline.</span></span> <span data-ttu-id="b5fdf-168">為每個資料軌重新傳送最後兩個 MP4 片段，可確保不會遺失資料。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-168">Resending the last two MP4 fragments for each track ensures that there is no data loss.</span></span> <span data-ttu-id="b5fdf-169">換句話說，如果資料流包含音訊和視訊播放軌，而且目前的 POST 要求失敗，則編碼器必須重新連線，然後為音訊播放軌重新傳送最後兩個片段 (先前已成功傳送)，為視訊播放軌重新傳送最後兩個片段 (先前已成功傳送)，以確保不會遺失任何資料。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-169">In other words, if a stream contains both an audio and a video track, and the current POST request fails, the encoder must reconnect and resend the last two fragments for the audio track, which were previously successfully sent, and the last two fragments for the video track, which were previously successfully sent, to ensure that there is no data loss.</span></span> <span data-ttu-id="b5fdf-170">編碼器「必須」維護媒體片段的 “forward” 緩衝區，當重新連線時會重新傳送此緩衝區。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-170">The encoder MUST maintain a “forward” buffer of media fragments, which it resends when it reconnects.</span></span>

## <a name="5-timescale"></a><span data-ttu-id="b5fdf-171">5.時幅</span><span class="sxs-lookup"><span data-stu-id="b5fdf-171">5. Timescale</span></span>
<span data-ttu-id="b5fdf-172">[[MS-SSTR]](https://msdn.microsoft.com/library/ff469518.aspx) 描述 **SmoothStreamingMedia** (2.2.2.1 節)、**StreamElement** (2.2.2.3 節)、**StreamFragmentElement** (2.2.2.6 節) 和 **LiveSMIL** (2.2.7.3.1 節) 的「時幅」使用方式。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-172">[[MS-SSTR]](https://msdn.microsoft.com/library/ff469518.aspx) describes the usage of timescale for **SmoothStreamingMedia** (Section 2.2.2.1), **StreamElement** (Section 2.2.2.3), **StreamFragmentElement** (Section 2.2.2.6), and **LiveSMIL** (Section 2.2.7.3.1).</span></span> <span data-ttu-id="b5fdf-173">如果沒有時幅值，則使用的預設值為 10,000,000 (10 MHz)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-173">If the timescale value is not present, the default value used is 10,000,000 (10 MHz).</span></span> <span data-ttu-id="b5fdf-174">雖然 Smooth Streaming 格式規格不會封鎖使用其他的時幅值，但大部分的編碼器實作會使用此預設值 (10 MHz) 來產生 Smooth Streaming 內嵌資料。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-174">Although the Smooth Streaming format specification doesn’t block usage of other timescale values, most encoder implementations use this default value (10 MHz) to generate Smooth Streaming ingest data.</span></span> <span data-ttu-id="b5fdf-175">由於 [Azure 媒體動態封裝](media-services-dynamic-packaging-overview.md) 功能之故，建議您針對視訊資料流使用 90-KHz 時幅，針對音訊資料流使用 44.1 KHz 或 48.1 KHz。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-175">Due to the [Azure Media Dynamic Packaging](media-services-dynamic-packaging-overview.md) feature, we recommend that you use a 90-KHz timescale for video streams and 44.1 KHz or 48.1 KHz for audio streams.</span></span> <span data-ttu-id="b5fdf-176">如果不同的資料流採用不同的時幅值，則「必須」傳送資料流層級時幅。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-176">If different timescale values are used for different streams, the stream-level timescale MUST be sent.</span></span> <span data-ttu-id="b5fdf-177">如需詳細資訊，請參閱 [[MS-SSTR]](https://msdn.microsoft.com/library/ff469518.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-177">For more information, see [[MS-SSTR]](https://msdn.microsoft.com/library/ff469518.aspx).</span></span>     

## <a name="6-definition-of-stream"></a><span data-ttu-id="b5fdf-178">6.「資料流」的定義</span><span class="sxs-lookup"><span data-stu-id="b5fdf-178">6. Definition of “stream”</span></span>
<span data-ttu-id="b5fdf-179">「資料流」是指在撰寫即時簡報、處理資料流容錯移轉和備援案例的即時內嵌中，作業的基本單位。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-179">Stream is the basic unit of operation in live ingestion for composing live presentations, handling streaming failover, and redundancy scenarios.</span></span> <span data-ttu-id="b5fdf-180">「資料流」定義為一個唯一的分散 MP4 位元資料流，其中可能包含單一資料軌或多個資料軌。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-180">Stream is defined as one unique, fragmented MP4 bitstream that might contain a single track or multiple tracks.</span></span> <span data-ttu-id="b5fdf-181">完整即時簡報可包含一或多個資料流，視即時編碼器組態而定。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-181">A full live presentation might contain one or more streams, depending on the configuration of the live encoders.</span></span> <span data-ttu-id="b5fdf-182">以下範例說明各種使用資料流撰寫完整即時簡報的選項。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-182">The following examples illustrate various options of using streams to compose a full live presentation.</span></span>

<span data-ttu-id="b5fdf-183">**範例：**</span><span class="sxs-lookup"><span data-stu-id="b5fdf-183">**Example:**</span></span> 

<span data-ttu-id="b5fdf-184">客戶想要建立一個即時資料流簡報，其中包含下列音訊/視訊位元速率：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-184">A customer wants to create a live streaming presentation that includes the following audio/video bitrates:</span></span>

<span data-ttu-id="b5fdf-185">視訊 - 3000 kbps、1500 kbps、750 kbps</span><span class="sxs-lookup"><span data-stu-id="b5fdf-185">Video – 3000 kbps, 1500 kbps, 750 kbps</span></span>

<span data-ttu-id="b5fdf-186">音訊 - 128 kbps</span><span class="sxs-lookup"><span data-stu-id="b5fdf-186">Audio – 128 kbps</span></span>

### <a name="option-1-all-tracks-in-one-stream"></a><span data-ttu-id="b5fdf-187">選項 1：一個資料流中所有的資料軌</span><span class="sxs-lookup"><span data-stu-id="b5fdf-187">Option 1: All tracks in one stream</span></span>
<span data-ttu-id="b5fdf-188">在此選項中，單一編碼器會產生所有音訊/視訊資料軌，然後將其組合成一個分散的 MP4 位元資料流。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-188">In this option, a single encoder generates all audio/video tracks, and then bundles them into one fragmented MP4 bitstream.</span></span> <span data-ttu-id="b5fdf-189">然後透過單一 HTTP POST 連線傳送分散的 MP4 位元資料流。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-189">The fragmented MP4 bitstream is then sent via a single HTTP POST connection.</span></span> <span data-ttu-id="b5fdf-190">此範例中有此即時簡報的唯一資料流。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-190">In this example, there is only one stream for this live presentation.</span></span>

![資料流 - 一個資料軌][image2]

### <a name="option-2-each-track-in-a-separate-stream"></a><span data-ttu-id="b5fdf-192">選項 2：每個資料軌分在不同的資料流中</span><span class="sxs-lookup"><span data-stu-id="b5fdf-192">Option 2: Each track in a separate stream</span></span>
<span data-ttu-id="b5fdf-193">在此選項中，編碼器在每個分散的 MP4 位元資料流中只有放一個資料軌，並透過分開的 HTTP 連線張貼所有資料流。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-193">In this option, the encoder puts one track into each fragment MP4 bitstream, and then posts all of the streams over separate HTTP connections.</span></span> <span data-ttu-id="b5fdf-194">這可透過一或多個編碼器完成。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-194">This can be done with one encoder or with multiple encoders.</span></span> <span data-ttu-id="b5fdf-195">即時內嵌將此即時簡報視為四個資料流的組合。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-195">The live ingestion sees this live presentation as composed of four streams.</span></span>

![資料流 - 分開的資料軌][image3]

### <a name="option-3-bundle-audio-track-with-the-lowest-bitrate-video-track-into-one-stream"></a><span data-ttu-id="b5fdf-197">選項 3：將音訊資料軌與位元速率最低的視訊資料軌組合一個資料流</span><span class="sxs-lookup"><span data-stu-id="b5fdf-197">Option 3: Bundle audio track with the lowest bitrate video track into one stream</span></span>
<span data-ttu-id="b5fdf-198">在此選項中，客戶選擇將音訊資料軌與位元速率最低的視訊資料軌組合成一個分散 MP4 位元資料流，並讓另外兩個視訊資料軌做為單獨的資料流。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-198">In this option, the customer chooses to bundle the audio track with the lowest-bitrate video track in one fragment MP4 bitstream, and leave the other two video tracks as separate streams.</span></span> 

![資料流 - 音訊與視訊資料軌][image4]

### <a name="summary"></a><span data-ttu-id="b5fdf-200">摘要</span><span class="sxs-lookup"><span data-stu-id="b5fdf-200">Summary</span></span>
<span data-ttu-id="b5fdf-201">此並非詳盡清單，僅列出此範例中部分可用的內嵌選項。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-201">This is not an exhaustive list of all possible ingestion options for this example.</span></span> <span data-ttu-id="b5fdf-202">事實上，即時內嵌支援將資料軌以任何組合分組到資料流。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-202">As a matter of fact, any grouping of tracks into streams is supported by live ingestion.</span></span> <span data-ttu-id="b5fdf-203">客戶和編碼器廠商可以根據工程的複雜性、編碼器的能力，以及備援與容錯移轉考量，來選擇自己的實作。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-203">Customers and encoder vendors can choose their own implementations based on engineering complexity, encoder capacity, and redundancy and failover considerations.</span></span> <span data-ttu-id="b5fdf-204">整個即時簡報只有一個音訊資料軌。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-204">However, in most cases, there is only one audio track for the entire live presentation.</span></span> <span data-ttu-id="b5fdf-205">因此，請務必確保包含音訊資料軌的內嵌資料流是正常的。這項考量通常可讓音訊資料軌放入自己的資料流 (如選項 2)，或以最低位元速率視訊資料軌建立音訊資料軌 (如選項 3)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-205">So, it’s important to ensure the healthiness of the ingest stream that contains the audio track. This consideration often results in putting the audio track in its own stream (as in Option 2) or bundling it with the lowest-bitrate video track (as in Option 3).</span></span> <span data-ttu-id="b5fdf-206">此外若要有更佳的備援與容錯移轉成效，強烈建議針對嵌入到媒體服務的即時內嵌，將同一個音訊資料軌傳送到兩個不同的資料流 (選項 2 中採用備援音訊資料軌)，或以至少兩個最低位元速率視訊資料軌建置音訊資料軌 (選項 3 中以至少兩個視訊資料流建置)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-206">Also, for better redundancy and fault tolerance, sending the same audio track in two different streams (Option 2 with redundant audio tracks) or bundling the audio track with at least two of the lowest-bitrate video tracks (Option 3 with audio bundled in at least two video streams) is highly recommended for live ingest into Media Services.</span></span>

## <a name="7-service-failover"></a><span data-ttu-id="b5fdf-207">7.服務容錯移轉</span><span class="sxs-lookup"><span data-stu-id="b5fdf-207">7. Service failover</span></span>
<span data-ttu-id="b5fdf-208">基於即時資料流的性質，良好的容錯移轉支援是確保服務可用性的關鍵。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-208">Given the nature of live streaming, good failover support is critical for ensuring the availability of the service.</span></span> <span data-ttu-id="b5fdf-209">媒體服務的設計可處理各種類型的故障，包括網路錯誤、伺服器錯誤，以及儲存體問題。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-209">Media Services is designed to handle various types of failures, including network errors, server errors, and storage issues.</span></span> <span data-ttu-id="b5fdf-210">當從即時編碼器端搭配適當的容錯移轉邏輯使用時，客戶便可以從雲端達成高度可靠的即時資料流服務。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-210">When used in conjunction with proper failover logic from the live encoder side, customers can achieve a highly reliable live streaming service from the cloud.</span></span>

<span data-ttu-id="b5fdf-211">在本節中，我們將討論服務容錯移轉的案例。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-211">In this section, we discuss service failover scenarios.</span></span> <span data-ttu-id="b5fdf-212">在此案例中，服務的某一處發生故障，且故障將自己記錄成資訊清單中的網路錯誤。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-212">In this case, the failure happens somewhere within the service, and it manifests itself as a network error.</span></span> <span data-ttu-id="b5fdf-213">以下是如何實施編碼器以處理服務容錯移轉的一些建議：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-213">Here are some recommendations for the encoder implementation for handling service failover:</span></span>

1. <span data-ttu-id="b5fdf-214">建立逾時值為 10 秒的 TCP 連線。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-214">Use a 10-second timeout for establishing the TCP connection.</span></span> <span data-ttu-id="b5fdf-215">如果嘗試建立連線超過 10 秒，便會中止作業並再試一次。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-215">If an attempt to establish the connection takes longer than 10 seconds, abort the operation and try again.</span></span> 
2. <span data-ttu-id="b5fdf-216">傳送 HTTP 要求訊息區塊的逾時值短。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-216">Use a short timeout for sending the HTTP request message chunks.</span></span> <span data-ttu-id="b5fdf-217">如果目標 MP4 片段持續期間為 N 秒，請使用介於 N 到 2N 秒之間的傳送逾時；例如，如果 MP4 片段持續時間是 6 秒，則使用 6 到 12 的逾時。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-217">If the target MP4 fragment duration is N seconds, use a send timeout between N and 2 N seconds; for example, if the MP4 fragment duration is 6 seconds, use a timeout of 6 to 12 seconds.</span></span> <span data-ttu-id="b5fdf-218">如果發生逾時，請重設連線、開啟新連接，並以新的連線繼續資料流內嵌。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-218">If a timeout occurs, reset the connection, open a new connection, and resume stream ingest on the new connection.</span></span> 
3. <span data-ttu-id="b5fdf-219">為每個資料軌維護一個循環緩衝區，其中具有最後兩個已成功完整地傳送到服務的片段。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-219">Maintain a rolling buffer that has the last two fragments for each track that were successfully and completely sent to the service.</span></span>  <span data-ttu-id="b5fdf-220">如果資料流的 HTTP POST 要求在資料流結束前終止或逾時，則開啟新的連線，然後開始另一個 HTTP POST 要求、重新傳送資料流標頭、為每個資料軌重新傳送最後兩個片段，但不在媒體時間軸上造成不連續。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-220">If the HTTP POST request for a stream is terminated or times out prior to the end of the stream, open a new connection and begin another HTTP POST request, resend the stream headers, resend the last two fragments for each track, and resume the stream without introducing a discontinuity in the media timeline.</span></span> <span data-ttu-id="b5fdf-221">這會減少資料遺失的可能性。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-221">This reduces the chance of data loss.</span></span>
4. <span data-ttu-id="b5fdf-222">建議編碼器「不」要限制在發生 TCP 錯誤後，重新嘗試建立連線或繼續串流的次數。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-222">We recommend that the encoder does NOT limit the number of retries to establish a connection or resume streaming after a TCP error occurs.</span></span>
5. <span data-ttu-id="b5fdf-223">發生 TCP 錯誤後：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-223">After a TCP error:</span></span>
  
    <span data-ttu-id="b5fdf-224">a.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-224">a.</span></span> <span data-ttu-id="b5fdf-225">「必須」關閉目前的連線，且「必須」為新的 HTTP POST 要求建立新的連線。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-225">The current connection MUST be closed, and a new connection MUST be created for a new HTTP POST request.</span></span>

    <span data-ttu-id="b5fdf-226">b.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-226">b.</span></span> <span data-ttu-id="b5fdf-227">新的 HTTP POST URL 「必須」與初始 POST URL 相同。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-227">The new HTTP POST URL MUST be the same as the initial POST URL.</span></span>
  
    <span data-ttu-id="b5fdf-228">c.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-228">c.</span></span> <span data-ttu-id="b5fdf-229">新的 HTTP POST「必須」包括與初始 POST 相同的資料流標頭 (**ftyp**、**Live Server Manifest Box**，以及 **moov** 方塊)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-229">The new HTTP POST MUST include stream headers (**ftyp**, **Live Server Manifest Box**, and **moov** boxes) that are identical to the stream headers in the initial POST.</span></span>
  
    <span data-ttu-id="b5fdf-230">d.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-230">d.</span></span> <span data-ttu-id="b5fdf-231">必須重新傳送為每個資料軌傳送的最後兩個片段，且必須繼續資料流，但不在媒體時間軸上造成不連續。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-231">The last two fragments sent for each track must be resent, and streaming must resume without introducing a discontinuity in the media timeline.</span></span> <span data-ttu-id="b5fdf-232">MP4 片段時間戳記必須連續增加，甚至可橫跨 HTTP POST 要求。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-232">The MP4 fragment timestamps must increase continuously, even across HTTP POST requests.</span></span>
6. <span data-ttu-id="b5fdf-233">如果未以可與 MP4 片段持續時間相比的速率傳送資料，則編碼器「應該」終止 HTTP POST 要求。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-233">The encoder SHOULD terminate the HTTP POST request if data is not being sent at a rate commensurate with the MP4 fragment duration.</span></span>  <span data-ttu-id="b5fdf-234">不傳送資料的 HTTP POST 要求可以防止媒體服務在服務更新時，快速地與編碼器中斷連線。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-234">An HTTP POST request that does not send data can prevent Media Services from quickly disconnecting from the encoder in the event of a service update.</span></span> <span data-ttu-id="b5fdf-235">基於這個理由，疏鬆 (廣告訊號) 資料軌的 HTTP POST「應該」短暫存留，一傳送疏鬆片段便立即終止。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-235">For this reason, the HTTP POST for sparse (ad signal) tracks SHOULD be short-lived, terminating as soon as the sparse fragment is sent.</span></span>

## <a name="8-encoder-failover"></a><span data-ttu-id="b5fdf-236">8.編碼器容錯移轉</span><span class="sxs-lookup"><span data-stu-id="b5fdf-236">8. Encoder failover</span></span>
<span data-ttu-id="b5fdf-237">編碼器容錯移轉是第二種容錯移轉案例，此案例必須處理，才能進行端對端即時資料流傳遞。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-237">Encoder failover is the second type of failover scenario that needs to be addressed for end-to-end live streaming delivery.</span></span> <span data-ttu-id="b5fdf-238">在此案例中，錯誤狀況發生在編碼器端。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-238">In this scenario, the error condition occurs on the encoder side.</span></span> 

![編碼器容錯移轉][image5]

<span data-ttu-id="b5fdf-240">發生編碼器容錯移轉時，預期在即時內嵌端點上會：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-240">The following expectations apply from the live ingestion endpoint when encoder failover happens:</span></span>

1. <span data-ttu-id="b5fdf-241">「應該」建立新的編碼器執行個體，以繼續資料流，如此圖所示 (以虛線表示的 3000k 視訊資料流)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-241">A new encoder instance SHOULD be created to continue streaming, as illustrated in the diagram (Stream for 3000k video, with dashed line).</span></span>
2. <span data-ttu-id="b5fdf-242">新編碼器「必須」使用與故障執行個體相同的 HTTP POST 要求 URL。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-242">The new encoder MUST use the same URL for HTTP POST requests as the failed instance.</span></span>
3. <span data-ttu-id="b5fdf-243">新編碼器的 POST 要求「必須」包含與故障執行個體相同的分散 MP4 標頭方塊。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-243">The new encoder’s POST request MUST include the same fragmented MP4 header boxes as the failed instance.</span></span>
4. <span data-ttu-id="b5fdf-244">新編碼器「必須」與所有其他的執行中編碼器正確地同步化，相同的即時簡報才能產生與符合的片段界限同步化的音訊/視訊範例。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-244">The new encoder MUST be properly synced with all other running encoders for the same live presentation to generate synced audio/video samples with aligned fragment boundaries.</span></span>
5. <span data-ttu-id="b5fdf-245">新的資料流「必須」在語意上等同上一個資料流，並可在標頭與片段層級互換。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-245">The new stream MUST be semantically equivalent with the previous stream, and interchangeable at the header and fragment levels.</span></span>
6. <span data-ttu-id="b5fdf-246">新的編碼器「應該」嘗試減少資料遺失。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-246">The new encoder SHOULD try to minimize data loss.</span></span> <span data-ttu-id="b5fdf-247">媒體片段的 `fragment_absolute_time` 與 `fragment_index`「應該」從編碼器上次停止的點開始增加。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-247">The `fragment_absolute_time` and `fragment_index` of media fragments SHOULD increase from the point where the encoder last stopped.</span></span> <span data-ttu-id="b5fdf-248">`fragment_absolute_time` 與 `fragment_index`「應該」連續增加，但允許視需要造成不連續。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-248">The `fragment_absolute_time` and `fragment_index` SHOULD increase in a continuous manner, but it is permissible to introduce a discontinuity, if necessary.</span></span> <span data-ttu-id="b5fdf-249">媒體服務會忽略已收到並處理的片段，因此因重新傳送片段端而發生錯誤，會勝過在媒體時間軸上造成不連續。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-249">Media Services ignores fragments that it has already received and processed, so it's better to err on the side of resending fragments than to introduce discontinuities in the media timeline.</span></span> 

## <a name="9-encoder-redundancy"></a><span data-ttu-id="b5fdf-250">9.編碼器備援</span><span class="sxs-lookup"><span data-stu-id="b5fdf-250">9. Encoder redundancy</span></span>
<span data-ttu-id="b5fdf-251">針對某些需要更高可用性與高品質經驗的重要即時事件，建議您使用主動對主動備援編碼器，以達成順暢的容錯移轉，而不會遺失資料。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-251">For certain critical live events that demand even higher availability and quality of experience, we recommended that you use active-active redundant encoders to achieve seamless failover with no data loss.</span></span>

![編碼器備援][image6]

<span data-ttu-id="b5fdf-253">如此圖所示，兩組編碼器同時將每個資料流的兩個複本推送到即時服務。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-253">As illustrated in this diagram, two groups of encoders push two copies of each stream simultaneously into the live service.</span></span> <span data-ttu-id="b5fdf-254">此設定之所以受到支援，是因為媒體服務能夠根據資料流 ID 與片段時間戳記篩選出重複的片段。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-254">This setup is supported because Media Services can filter out duplicate fragments based on stream ID and fragment timestamp.</span></span> <span data-ttu-id="b5fdf-255">如此所產生的即時資料流與封存會是所有資料流的單一複本，此複本最有可能從兩個來源彙總而成。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-255">The resulting live stream and archive is a single copy of all the streams that is the best possible aggregation from the two sources.</span></span> <span data-ttu-id="b5fdf-256">例如，在極端的假設狀況下，只要有一個編碼器 (不一定要同一個) 在任何一個指定的時間點上對每個資料流執行，則自服務產生的即時資料流就會是連續的，不會遺失資料。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-256">For example, in a hypothetical extreme case, as long as there is one encoder (it doesn’t have to be the same one) running at any given point in time for each stream, the resulting live stream from the service is continuous without data loss.</span></span> 

<span data-ttu-id="b5fdf-257">此案例的需求與「編碼器容錯移轉」案例的需求幾乎相同，唯一不同處是第二組編碼器會與主要編碼器同時執行。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-257">The requirements for this scenario are almost the same as the requirements in the "Encoder failover" case, with the exception that the second set of encoders are running at the same time as the primary encoders.</span></span>

## <a name="10-service-redundancy"></a><span data-ttu-id="b5fdf-258">10.服務備援</span><span class="sxs-lookup"><span data-stu-id="b5fdf-258">10. Service redundancy</span></span>
<span data-ttu-id="b5fdf-259">對於高度備援的全域散佈，有時您必須跨區域備份以處理區域災難。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-259">For highly redundant global distribution, sometimes you must have cross-region backup to handle regional disasters.</span></span> <span data-ttu-id="b5fdf-260">透過展開「編碼器備援」拓撲，客戶可以選擇讓備援服務部署在不同的區域，且該區域與第二組編碼器連線。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-260">Expanding on the “Encoder redundancy” topology, customers can choose to have a redundant service deployment in a different region that's connected with the second set of encoders.</span></span> <span data-ttu-id="b5fdf-261">客戶也可以與「內容傳遞網路」提供者合作，將「全域流量管理員」部署在兩個服務部署之前，藉此順暢地路由用戶端流量。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-261">Customers also can work with a Content Delivery Network provider to deploy a Global Traffic Manager in front of the two service deployments to seamlessly route client traffic.</span></span> <span data-ttu-id="b5fdf-262">編碼器的需求與「編碼器備援」案例相同。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-262">The requirements for the encoders are the same as the “Encoder redundancy” case.</span></span> <span data-ttu-id="b5fdf-263">唯一的例外情況是第二組編碼器需要指向不同的即時內嵌端點。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-263">The only exception is that the second set of encoders needs to be pointed to a different live ingest endpoint.</span></span> <span data-ttu-id="b5fdf-264">下圖顯示此設定：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-264">The following diagram shows this setup:</span></span>

![服務備援][image7]

## <a name="11-special-types-of-ingestion-formats"></a><span data-ttu-id="b5fdf-266">11.特殊類型的內嵌格式</span><span class="sxs-lookup"><span data-stu-id="b5fdf-266">11. Special types of ingestion formats</span></span>
<span data-ttu-id="b5fdf-267">本節討論特殊類型的即時內嵌格式，其設計用來處理特定案例。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-267">This section discusses special types of live ingestion formats that are designed to handle specific scenarios.</span></span>

### <a name="sparse-track"></a><span data-ttu-id="b5fdf-268">疏鬆資料軌</span><span class="sxs-lookup"><span data-stu-id="b5fdf-268">Sparse track</span></span>
<span data-ttu-id="b5fdf-269">當以豐富的用戶端經驗傳遞即時資料流簡報時，通常需要傳輸與主要媒體資料時間同步化的事件或頻內訊號。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-269">When delivering a live streaming presentation with a rich client experience, often it's necessary to transmit time-synced events or signals in-band with the main media data.</span></span> <span data-ttu-id="b5fdf-270">動態即時廣告插入是其中一個例子。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-270">An example of this is dynamic live ad insertion.</span></span> <span data-ttu-id="b5fdf-271">此類型的事件訊號不同於一般音訊/視訊資料流，因為其疏鬆的本質之故。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-271">This type of event signaling is different from regular audio/video streaming because of its sparse nature.</span></span> <span data-ttu-id="b5fdf-272">換句話說，訊號資料通常不會連續發生，其間隔難以預測。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-272">In other words, the signaling data usually does not happen continuously, and the interval can be hard to predict.</span></span> <span data-ttu-id="b5fdf-273">疏鬆資料軌的概念經過設計，可內嵌並廣播頻內訊號資料。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-273">The concept of sparse track was designed to ingest and broadcast in-band signaling data.</span></span>

<span data-ttu-id="b5fdf-274">以下步驟為內嵌疏鬆資料軌的建議實作：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-274">The following steps are a recommended implementation for ingesting sparse track:</span></span>

1. <span data-ttu-id="b5fdf-275">建立個別的分散 MP4 位元資料流，其只包含疏鬆資料軌，但不包含音訊/視訊資料軌。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-275">Create a separate fragmented MP4 bitstream that contains only sparse tracks, without audio/video tracks.</span></span>
2. <span data-ttu-id="b5fdf-276">在如 [1] 的第 6 節定義的 **Live Server Manifest Box** 中，使用 *parentTrackName* 參數指定上層資料軌的名稱。如需詳細資訊，請參閱 [1] 的第 4.2.1.2.1.2 節。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-276">In the **Live Server Manifest Box** as defined in Section 6 in [1], use the *parentTrackName* parameter to specify the name of the parent track. For more information, see section 4.2.1.2.1.2 in [1].</span></span>
3. <span data-ttu-id="b5fdf-277">在 **Live Server Manifest Box** 中，**manifestOutput**「必須」設為 **true**。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-277">In the **Live Server Manifest Box**, **manifestOutput** MUST be set to **true**.</span></span>
4. <span data-ttu-id="b5fdf-278">基於訊號事件的疏鬆特性，我們建議下列事項：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-278">Given the sparse nature of the signaling event, we recommended the following:</span></span>
   
    <span data-ttu-id="b5fdf-279">a.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-279">a.</span></span> <span data-ttu-id="b5fdf-280">即時事件開始時，編碼器會將初始標頭方塊傳送給服務，這可讓該服務在用戶端資訊清單中註冊疏鬆資料軌。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-280">At the beginning of the live event, the encoder sends the initial header boxes to the service, which allows the service to register the sparse track in the client manifest.</span></span>
   
    <span data-ttu-id="b5fdf-281">b.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-281">b.</span></span> <span data-ttu-id="b5fdf-282">未傳送資料時，編碼器「應該」終止 HTTP POST 要求。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-282">The encoder SHOULD terminate the HTTP POST request when data is not being sent.</span></span> <span data-ttu-id="b5fdf-283">不傳送資料之長時間執行的 HTTP POST 要求可以防止媒體服務在服務更新時，快速地與編碼器中斷連線或伺服器重新開機。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-283">A long-running HTTP POST that does not send data can prevent Media Services from quickly disconnecting from the encoder in the event of a service update or server reboot.</span></span> <span data-ttu-id="b5fdf-284">在這些情況下，通訊端的接收作業中已暫時封鎖媒體伺服器。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-284">In these cases, the media server is temporarily blocked in a receive operation on the socket.</span></span>
   
    <span data-ttu-id="b5fdf-285">c.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-285">c.</span></span> <span data-ttu-id="b5fdf-286">在此期間若沒有可用的訊號資料時，編碼器「應該」關閉 HTTP POST 要求。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-286">During the time when signaling data is not available, the encoder SHOULD close the HTTP POST request.</span></span> <span data-ttu-id="b5fdf-287">POST 要求為作用中時，編碼器「應該」傳送資料。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-287">While the POST request is active, the encoder SHOULD send data.</span></span>

    <span data-ttu-id="b5fdf-288">d.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-288">d.</span></span> <span data-ttu-id="b5fdf-289">傳送疏鬆片段時，編碼器可以設定明確的 content-length 標頭 (若有的話)。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-289">When sending sparse fragments, the encoder can set an explicit content-length header, if it’s available.</span></span>

    <span data-ttu-id="b5fdf-290">e.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-290">e.</span></span> <span data-ttu-id="b5fdf-291">透過新連線傳送疏鬆片段時，編碼器「應該」從標頭方塊開始傳送，接著傳送新片段。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-291">When sending sparse fragments with a new connection, the encoder SHOULD start sending from the header boxes, followed by the new fragments.</span></span> <span data-ttu-id="b5fdf-292">此適用於中間發生容錯移轉的狀況，並會一直對先前從未看到該疏鬆資料庫的新伺服器建立新的疏鬆連線。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-292">This is for cases in which failover happens in-between, and the new sparse connection is being established to a new server that has not seen the sparse track before.</span></span>

    <span data-ttu-id="b5fdf-293">f.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-293">f.</span></span> <span data-ttu-id="b5fdf-294">當讓時間戳記值相等或更大的對應上層資料軌片段可供用戶端使用時，疏鬆資料軌片段便會對用戶端變成可用狀態。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-294">The sparse track fragment becomes available to the client when the corresponding parent track fragment that has an equal or larger timestamp value is made available to the client.</span></span> <span data-ttu-id="b5fdf-295">例如，如果疏鬆片段的時間戳記 t=1000，則預期在用戶端看見視訊 (假設上層資料軌名稱為視訊) 片段時間戳記為 1000 或以上後，便可下載 t=1000 的疏鬆片段。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-295">For example, if the sparse fragment has a timestamp of t=1000, it is expected that after the client sees "video" (assuming the parent track name is "video") fragment timestamp 1000 or beyond, it can download the sparse fragment t=1000.</span></span> <span data-ttu-id="b5fdf-296">請注意，實際訊號能夠在簡報時間軸上的不同位置上，運用在其指定用途。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-296">Note that the actual signal could be used for a different position in the presentation timeline for its designated purpose.</span></span> <span data-ttu-id="b5fdf-297">在此範例中，t=1000 的疏鬆片段具有 XML 承載，可將廣告插入到數秒後的位置上。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-297">In this example, it’s possible that the sparse fragment of t=1000 has an XML payload, which is for inserting an ad in a position that’s a few seconds later.</span></span>

    <span data-ttu-id="b5fdf-298">g.</span><span class="sxs-lookup"><span data-stu-id="b5fdf-298">g.</span></span> <span data-ttu-id="b5fdf-299">疏鬆資料軌片段的承載可以是不同格式 (例如 XML、文字或二進位)，視情況而定。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-299">The payload of sparse track fragments can be in different formats (such as XML, text, or binary), depending on the scenario.</span></span>

### <a name="redundant-audio-track"></a><span data-ttu-id="b5fdf-300">備援音訊資料軌</span><span class="sxs-lookup"><span data-stu-id="b5fdf-300">Redundant audio track</span></span>
<span data-ttu-id="b5fdf-301">在一般的 HTTP 彈性資料流案例中 (例如 Smooth Streaming 或 DASH)，通常在整個簡報中只有一個音訊資料軌。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-301">In a typical HTTP adaptive streaming scenario (for example, Smooth Streaming or DASH), often, there's only one audio track in the entire presentation.</span></span> <span data-ttu-id="b5fdf-302">具有多個品質層級的視訊資料軌可讓用戶端在錯誤條件中選擇，而音訊資料軌不同於這類資料軌，當內嵌的資料流中有損壞的音訊資料軌時，音訊資料軌會是唯一的故障點。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-302">Unlike video tracks, which have multiple quality levels for the client to choose from in error conditions, the audio track can be a single point of failure if the ingestion of the stream that contains the audio track is broken.</span></span> 

<span data-ttu-id="b5fdf-303">為解決此問題，媒體服務支援即時內嵌備援音訊資料軌。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-303">To solve this problem, Media Services supports live ingestion of redundant audio tracks.</span></span> <span data-ttu-id="b5fdf-304">其概念與可透過不同的資料流多次傳送音訊資料軌相同。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-304">The idea is that the same audio track can be sent multiple times in different streams.</span></span> <span data-ttu-id="b5fdf-305">雖然服務只會在用戶端資訊清單中註冊音訊資料軌一次，但它能夠使用備援音訊資料軌做為備份，在主要音訊資料軌發生問題時能夠擷取音訊片段。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-305">Although the service only registers the audio track once in the client manifest, it can use redundant audio tracks as backups for retrieving audio fragments if the primary audio track has issues.</span></span> <span data-ttu-id="b5fdf-306">若要內嵌備援音訊資料軌，編碼器必須：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-306">To ingest redundant audio tracks, the encoder needs to:</span></span>

1. <span data-ttu-id="b5fdf-307">在多個分散 MP4 位元資料流中建立相同的音訊資料軌。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-307">Create the same audio track in multiple fragment MP4 bitstreams.</span></span> <span data-ttu-id="b5fdf-308">備援音訊資料軌「必須」在語意上與片段時間戳記相同，並可在標頭與片段層級互換。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-308">The redundant audio tracks MUST be semantically equivalent, with the same fragment timestamps, and be interchangeable at the header and fragment levels.</span></span>
2. <span data-ttu-id="b5fdf-309">確定所有備援音訊資料軌在即時伺服器資訊清單中的 “audio” 項目 ([1] 的第 6 節) 全部相同。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-309">Ensure that the “audio” entry in the Live Server Manifest (Section 6 in [1]) is the same for all redundant audio tracks.</span></span>

<span data-ttu-id="b5fdf-310">以下是備援音訊資料軌的建議實作：</span><span class="sxs-lookup"><span data-stu-id="b5fdf-310">The following implementation is recommended for redundant audio tracks:</span></span>

1. <span data-ttu-id="b5fdf-311">讓資料流獨自傳送每個唯一的音訊資料軌。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-311">Send each unique audio track in a stream by itself.</span></span> <span data-ttu-id="b5fdf-312">另外，為這些音訊資料軌資料流一一傳送備援資料流，其中第 2 個資料流與第 1 個資料流唯一的不同處是 HTTP POST URL 中的識別碼：{protocol}://{server address}/{publishing point path}/Streams({identifier})。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-312">Also, send a redundant stream for each of these audio track streams, where the second stream differs from the first only by the identifier in the HTTP POST URL: {protocol}://{server address}/{publishing point path}/Streams({identifier}).</span></span>
2. <span data-ttu-id="b5fdf-313">使用個別的資料流傳送兩個最低的視訊位元速率。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-313">Use separate streams to send the two lowest video bitrates.</span></span> <span data-ttu-id="b5fdf-314">這些資料流皆「應該」包含每個唯一音訊資料軌的複本。例如，當支援多國語言時，這些資料流「應該」包含每種語言的音訊資料軌。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-314">Each of these streams SHOULD also contain a copy of each unique audio track. For example, when multiple languages are supported, these streams SHOULD contain audio tracks for each language.</span></span>
3. <span data-ttu-id="b5fdf-315">使用不同的伺服器 (編碼器) 執行個體來編碼和傳送 (1) 和 (2) 中所提到的多餘資料流。</span><span class="sxs-lookup"><span data-stu-id="b5fdf-315">Use separate server (encoder) instances to encode and send the redundant streams mentioned in (1) and (2).</span></span> 

## <a name="media-services-learning-paths"></a><span data-ttu-id="b5fdf-316">媒體服務學習路徑</span><span class="sxs-lookup"><span data-stu-id="b5fdf-316">Media Services learning paths</span></span>
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a><span data-ttu-id="b5fdf-317">提供意見反應</span><span class="sxs-lookup"><span data-stu-id="b5fdf-317">Provide feedback</span></span>
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]

[image1]: ./media/media-services-fmp4-live-ingest-overview/media-services-image1.png
[image2]: ./media/media-services-fmp4-live-ingest-overview/media-services-image2.png
[image3]: ./media/media-services-fmp4-live-ingest-overview/media-services-image3.png
[image4]: ./media/media-services-fmp4-live-ingest-overview/media-services-image4.png
[image5]: ./media/media-services-fmp4-live-ingest-overview/media-services-image5.png
[image6]: ./media/media-services-fmp4-live-ingest-overview/media-services-image6.png
[image7]: ./media/media-services-fmp4-live-ingest-overview/media-services-image7.png
