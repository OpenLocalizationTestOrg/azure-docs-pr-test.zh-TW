---
title: "VM 與角色執行個體的解析"
description: "Azure IaaS、混合式解決方案、不同雲端服務之間、Active Directory 以及使用專屬 DNS 伺服器的名稱解析案例  "
services: virtual-network
documentationcenter: na
author: GarethBradshawMSFT
manager: carmonm
editor: tysonn
ms.assetid: 5d73edde-979a-470a-b28c-e103fcf07e3e
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 12/06/2016
ms.author: telmos
ms.openlocfilehash: 479cf8cf358d0b242d8ce030d8639b493e4767d8
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="name-resolution-for-vms-and-role-instances"></a><span data-ttu-id="b4c6e-103">VM 與角色執行個體的名稱解析</span><span class="sxs-lookup"><span data-stu-id="b4c6e-103">Name Resolution for VMs and Role Instances</span></span>
<span data-ttu-id="b4c6e-104">根據您使用 Azure 來裝載 IaaS、PaaS 以及混合式解決方案的方式，您可能需要允許您建立的 VM 與角色執行個體彼此通訊。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-104">Depending on how you use Azure to host IaaS, PaaS, and hybrid solutions, you may need to allow the VMs and role instances that you create to communicate with each other.</span></span> <span data-ttu-id="b4c6e-105">雖然可以使用 IP 位址來進行這項通訊，但是使用能輕鬆記住且不會變更的名稱會更加簡單。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-105">Although this communication can be done by using IP addresses, it is much simpler to use names that can be easily remembered and do not change.</span></span> 

<span data-ttu-id="b4c6e-106">當 Azure 中裝載的角色執行個體和 VM 必須將網域名稱解析為內部 IP 位址時，可以使用兩種方法中的其中一種：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-106">When role instances and VMs hosted in Azure need to resolve domain names to internal IP addresses, they can use one of two methods:</span></span>

* [<span data-ttu-id="b4c6e-107">Azure 提供的名稱解析</span><span class="sxs-lookup"><span data-stu-id="b4c6e-107">Azure-provided name resolution</span></span>](#azure-provided-name-resolution)
* <span data-ttu-id="b4c6e-108">[使用專屬 DNS 伺服器的名稱解析](#name-resolution-using-your-own-dns-server) (可將查詢轉送到 Azure 提供的 DNS 伺服器)</span><span class="sxs-lookup"><span data-stu-id="b4c6e-108">[Name resolution using your own DNS server](#name-resolution-using-your-own-dns-server) (which may forward queries to the Azure-provided DNS servers)</span></span> 

<span data-ttu-id="b4c6e-109">您使用的名稱解析類型取決於 VM 和角色執行個體如何彼此通訊。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-109">The type of name resolution you use depends on how your VMs and role instances need to communicate with each other.</span></span>

<span data-ttu-id="b4c6e-110">**下表說明各種案例和對應的名稱解析方案：**</span><span class="sxs-lookup"><span data-stu-id="b4c6e-110">**The following table illustrates scenarios and corresponding name resolution solutions:**</span></span>

| <span data-ttu-id="b4c6e-111">**案例**</span><span class="sxs-lookup"><span data-stu-id="b4c6e-111">**Scenario**</span></span> | <span data-ttu-id="b4c6e-112">**方案**</span><span class="sxs-lookup"><span data-stu-id="b4c6e-112">**Solution**</span></span> | <bpt id="p1">**</bpt>Suffix<ept id="p1">**</ept> |
| --- | --- | --- |
| <span data-ttu-id="b4c6e-114">位於相同雲端服務或虛擬網路中的角色執行個體或 VM 之間的名稱解析</span><span class="sxs-lookup"><span data-stu-id="b4c6e-114">Name resolution between role instances or VMs located in the same cloud service or virtual network</span></span> |[<span data-ttu-id="b4c6e-115">Azure 提供的名稱解析</span><span class="sxs-lookup"><span data-stu-id="b4c6e-115">Azure-provided name resolution</span></span>](#azure-provided-name-resolution) |<span data-ttu-id="b4c6e-116">主機名稱或 FQDN</span><span class="sxs-lookup"><span data-stu-id="b4c6e-116">hostname or FQDN</span></span> |
| <span data-ttu-id="b4c6e-117">位於不同虛擬網路中的角色執行個體或 VM 之間的名稱解析</span><span class="sxs-lookup"><span data-stu-id="b4c6e-117">Name resolution between role instances or VMs located in different virtual networks</span></span> |<span data-ttu-id="b4c6e-118">客戶管理的 DNS 伺服器將 vnet 之間的查詢轉送供 Azure (DNS Proxy) 解析。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-118">Customer-managed DNS servers forwarding queries between vnets for resolution by Azure (DNS proxy).</span></span>  <span data-ttu-id="b4c6e-119">請參閱 [使用專屬 DNS 伺服器的名稱解析](#name-resolution-using-your-own-dns-server)</span><span class="sxs-lookup"><span data-stu-id="b4c6e-119">see [Name resolution using your own DNS server](#name-resolution-using-your-own-dns-server)</span></span> |<span data-ttu-id="b4c6e-120">僅 FQDN</span><span class="sxs-lookup"><span data-stu-id="b4c6e-120">FQDN only</span></span> |
| <span data-ttu-id="b4c6e-121">解析 Azure 中角色執行個體或 VM 的內部部署電腦及伺服器名稱</span><span class="sxs-lookup"><span data-stu-id="b4c6e-121">Resolution of on-premises computer and service names from role instances or VMs in Azure</span></span> |<span data-ttu-id="b4c6e-122">客戶管理的 DNS 伺服器 (例如內部部署的網域控制站、本機唯讀網域控制站或使用區域傳輸同步的次要 DNS)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-122">Customer-managed DNS servers (e.g. on-premises domain controller, local read-only domain controller or a DNS secondary synced using zone transfers).</span></span>  <span data-ttu-id="b4c6e-123">請參閱 [使用專屬 DNS 伺服器的名稱解析](#name-resolution-using-your-own-dns-server)</span><span class="sxs-lookup"><span data-stu-id="b4c6e-123">See [Name resolution using your own DNS server](#name-resolution-using-your-own-dns-server)</span></span> |<span data-ttu-id="b4c6e-124">僅 FQDN</span><span class="sxs-lookup"><span data-stu-id="b4c6e-124">FQDN only</span></span> |
| <span data-ttu-id="b4c6e-125">從內部部署電腦解析 Azure 主機名稱</span><span class="sxs-lookup"><span data-stu-id="b4c6e-125">Resolution of Azure hostnames from on-premises computers</span></span> |<span data-ttu-id="b4c6e-126">將查詢轉送到所對應 vnet 中客戶管理的 DNS Proxy 伺服器，Proxy 伺服器將查詢轉送給 Azure 進行解析。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-126">Forward queries to a customer-managed DNS proxy server in the corresponding vnet, the proxy server forwards queries to Azure for resolution.</span></span> <span data-ttu-id="b4c6e-127">請參閱 [使用專屬 DNS 伺服器的名稱解析](#name-resolution-using-your-own-dns-server)</span><span class="sxs-lookup"><span data-stu-id="b4c6e-127">See [Name resolution using your own DNS server](#name-resolution-using-your-own-dns-server)</span></span> |<span data-ttu-id="b4c6e-128">僅 FQDN</span><span class="sxs-lookup"><span data-stu-id="b4c6e-128">FQDN only</span></span> |
| <span data-ttu-id="b4c6e-129">內部 IP 的反向 DNS</span><span class="sxs-lookup"><span data-stu-id="b4c6e-129">Reverse DNS for internal IPs</span></span> |[<span data-ttu-id="b4c6e-130">使用專屬 DNS 伺服器的名稱解析</span><span class="sxs-lookup"><span data-stu-id="b4c6e-130">Name resolution using your own DNS server</span></span>](#name-resolution-using-your-own-dns-server) |<span data-ttu-id="b4c6e-131">n/a</span><span class="sxs-lookup"><span data-stu-id="b4c6e-131">n/a</span></span> |
| <span data-ttu-id="b4c6e-132">位於不同雲端服務，不在虛擬網路中的 VM 或角色執行個體之間的名稱解析</span><span class="sxs-lookup"><span data-stu-id="b4c6e-132">Name resolution between VMs or role instances located in different cloud services, not in a virtual network</span></span> |<span data-ttu-id="b4c6e-133">不適用。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-133">Not applicable.</span></span> <span data-ttu-id="b4c6e-134">虛擬網路外部不支援不同雲端服務中 VM 和角色執行個體之間的連線。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-134">Connectivity between VMs and role instances in different cloud services is not supported outside a virtual network.</span></span> |<span data-ttu-id="b4c6e-135">n/a</span><span class="sxs-lookup"><span data-stu-id="b4c6e-135">n/a</span></span> |

## <a name="azure-provided-name-resolution"></a><span data-ttu-id="b4c6e-136">Azure 提供的名稱解析</span><span class="sxs-lookup"><span data-stu-id="b4c6e-136">Azure-provided name resolution</span></span>
<span data-ttu-id="b4c6e-137">除了公用 DNS 名稱的解析之外，Azure 也提供位於相同虛擬網路或雲端服務內的 VM 和角色執行個體的內部名稱解析。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-137">Along with resolution of public DNS names, Azure provides internal name resolution for VMs and role instances that reside within the same virtual network or cloud service.</span></span>  <span data-ttu-id="b4c6e-138">雲端服務中的 VM/執行個體共用相同的 DNS 尾碼，因此主機名稱本身就已足夠；但在傳統虛擬網路中，不同的雲端服務有不同的 DNS 尾碼，因此需要 FQDN 來解析不同雲端服務的名稱。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-138">VMs/instances in a cloud service share the same DNS suffix (so the hostname alone is sufficient) but in classic virtual networks different cloud services have different DNS suffixes so the FQDN is needed to resolve names between different cloud services.</span></span>  <span data-ttu-id="b4c6e-139">在資源管理員部署模型的虛擬網路中，DNS 尾碼在虛擬網路之間是一致的，因此不需要 FQDN，而 DNS 名稱則可以指派給 NIC 和虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-139">In virtual networks in the Resource Manager deployment model, the DNS suffix is consistent across the virtual network (so the FQDN is not needed) and DNS names can be assigned to both NICs and VMs.</span></span> <span data-ttu-id="b4c6e-140">雖然 Azure 提供的名稱解析不需要任何設定，但它不適用於所有部署案例，如上表所示。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-140">Although Azure-provided name resolution does not require any configuration, it is not the appropriate choice for all deployment scenarios, as seen on the table above.</span></span>

> [!NOTE]
> <span data-ttu-id="b4c6e-141">如果是 Web 和背景工作角色，您也可以使用 Azure 服務管理 REST API，根據角色名稱與執行個體數目，存取角色執行個體的內部 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-141">In the case of web and worker roles, you can also access the internal IP addresses of role instances based on the role name and instance number using the Azure Service Management REST API.</span></span> <span data-ttu-id="b4c6e-142">如需詳細資訊，請參閱 [服務管理 REST API 參考](https://msdn.microsoft.com/library/azure/ee460799.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-142">For more information, see [Service Management REST API Reference](https://msdn.microsoft.com/library/azure/ee460799.aspx).</span></span>
> 
> 

### <a name="features-and-considerations"></a><span data-ttu-id="b4c6e-143">功能和注意事項</span><span class="sxs-lookup"><span data-stu-id="b4c6e-143">Features and Considerations</span></span>
<bpt id="p1">**</bpt>Features:<ept id="p1">**</ept>

* <span data-ttu-id="b4c6e-145">方便使用：不需要設定，就能使用 Azure 提供的名稱解析。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-145">Ease of use: No configuration is required in order to use Azure-provided name resolution.</span></span>
* <span data-ttu-id="b4c6e-146">Azure 提供的名稱解析服務都高度可用，可省去您建立和管理 DNS 伺服器叢集的需求。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-146">The Azure-provided name resolution service is highly available, saving you the need to create and manage clusters of your own DNS servers.</span></span>
* <span data-ttu-id="b4c6e-147">可與您自己的 DNS 伺服器搭配使用，以解析內部部署及 Azure 主機名稱。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-147">Can be used in conjunction with your own DNS servers to resolve both on-premises and Azure hostnames.</span></span>
* <span data-ttu-id="b4c6e-148">提供名稱解析給相同雲端服務中的角色執行個體/VM，不需要 FQDN。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-148">Name resolution is provided between role instances/VMs within the same cloud service without need for a FQDN.</span></span>
* <span data-ttu-id="b4c6e-149">在使用資源管理員部署模型的虛擬網路中的 VM 之間提供名稱解析，不需要 FQDN。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-149">Name resolution is provided between VMs in virtual networks that use the Resource Manager deployment model, without need for the FQDN.</span></span> <span data-ttu-id="b4c6e-150">在不同的雲端服務中解析名稱時，傳統部署模型中的虛擬網路需要 FQDN。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-150">Virtual networks in the classic deployment model require the FQDN when resolving names in different cloud services.</span></span> 
* <span data-ttu-id="b4c6e-151">您可以使用最能描述部署的主機名稱，而不是使用自動產生的名稱。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-151">You can use hostnames that best describe your deployments, rather than working with auto-generated names.</span></span>

<bpt id="p1">**</bpt>Considerations:<ept id="p1">**</ept>

* <span data-ttu-id="b4c6e-153">Azure 建立的 DNS 尾碼不能修改。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-153">The Azure-created DNS suffix cannot be modified.</span></span>
* <span data-ttu-id="b4c6e-154">您無法手動註冊您自己的記錄。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-154">You cannot manually register your own records.</span></span>
* <span data-ttu-id="b4c6e-155">不支援 WINS 和 NetBIOS。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-155">WINS and NetBIOS are not supported.</span></span> <span data-ttu-id="b4c6e-156">(您無法在「Windows 檔案總管」中看到您的 VM)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-156">(You cannot see your VMs in Windows Explorer.)</span></span>
* <span data-ttu-id="b4c6e-157">主機名稱必須是 DNS 相容 (只能使用 0-9、a-z 和 '-'，無法以 '-' 開始或結束。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-157">Hostnames must be DNS-compatible (They must use only 0-9, a-z and '-', and cannot start or end with a '-'.</span></span> <span data-ttu-id="b4c6e-158">請參閱 RFC 3696 第 2 節)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-158">See RFC 3696 section 2.)</span></span>
* <span data-ttu-id="b4c6e-159">每個 VM 的 DNS 查詢流量已經過節流。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-159">DNS query traffic is throttled for each VM.</span></span> <span data-ttu-id="b4c6e-160">這應該不會影響大部分的應用程式。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-160">This shouldn't impact most applications.</span></span>  <span data-ttu-id="b4c6e-161">如果觀察到要求節流，請確定用戶端快取已啟用。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-161">If request throttling is observed, ensure that client-side caching is enabled.</span></span>  <span data-ttu-id="b4c6e-162">如需詳細資料，請參閱 [充分利用 Azure 提供的名稱解析](#Getting-the-most-from-Azure-provided-name-resolution)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-162">For more details, see [Getting the most from Azure-provided name resolution](#Getting-the-most-from-Azure-provided-name-resolution).</span></span>
* <span data-ttu-id="b4c6e-163">只有前 180 個雲端服務中的 VM 會在傳統部署模型中為每個虛擬網路註冊。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-163">Only VMs in the first 180 cloud services are registered for each virtual network in a classic deployment model.</span></span> <span data-ttu-id="b4c6e-164">這並不適用於資源管理員部署模型中的虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-164">This does not apply to virtual networks in Resource Manager deployment models.</span></span>

### <a name="getting-the-most-from-azure-provided-name-resolution"></a><span data-ttu-id="b4c6e-165">充分利用 Azure 提供的名稱解析</span><span class="sxs-lookup"><span data-stu-id="b4c6e-165">Getting the most from Azure-provided name resolution</span></span>
<bpt id="p1">**</bpt>Client-side Caching:<ept id="p1">**</ept>

<span data-ttu-id="b4c6e-167">並非所有的 DNS 查詢都需要透過網路傳送。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-167">Not every DNS query needs to be sent across the network.</span></span>  <span data-ttu-id="b4c6e-168">用戶端快取可藉由解決本機快取的週期性 DNS 查詢，協助減少延遲以及改善網路標誌的恢復能力。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-168">Client-side caching helps reduce latency and improve resilience to network blips by resolving recurring DNS queries from a local cache.</span></span>  <span data-ttu-id="b4c6e-169">DNS 記錄包含存留時間 (TTL)，可讓快取盡可能長時間儲存記錄而不會影響記錄的有效性，所以用戶端快取適用於大部分的情況。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-169">DNS records contain a Time-To-Live (TTL) which allows the cache to store the record for as long as possible without impacting record freshness, so client-side caching is suitable for most situations.</span></span>

<span data-ttu-id="b4c6e-170">預設 Windows DNS 用戶端有內建的 DNS 快取。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-170">The default Windows DNS Client has a DNS cache built-in.</span></span>  <span data-ttu-id="b4c6e-171">某些 Linux 發行版預設不包含快取功能，因此我們建議您 (在已經確認沒有本機快取之後) 為每個 Linux VM 新增快取。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-171">Some Linux distros do not include caching by default, it is recommended that one be added to each Linux VM (after checking that there isn't a local cache already).</span></span>

<span data-ttu-id="b4c6e-172">有許多不同 DNS 快取封裝可用，例如 dnsmasq，以下是在最常見的散發版本上安裝 dnsmasq 的步驟：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-172">There are a number of different DNS caching packages available, e.g. dnsmasq, here are the steps to install dnsmasq on the most common distros:</span></span>

* <span data-ttu-id="b4c6e-173">Ubuntu (使用 resolvconf)：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-173">**Ubuntu (uses resolvconf)**:</span></span>
  * <span data-ttu-id="b4c6e-174">只安裝 dnsmasq 封裝 (“sudo apt-get install dnsmasq”)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-174">just install the dnsmasq package (“sudo apt-get install dnsmasq”).</span></span>
* <span data-ttu-id="b4c6e-175">SUSE (使用 netconf)：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-175">**SUSE (uses netconf)**:</span></span>
  * <span data-ttu-id="b4c6e-176">安裝 dnsmasq 封裝 (“sudo zypper install dnsmasq”)</span><span class="sxs-lookup"><span data-stu-id="b4c6e-176">install the dnsmasq package (“sudo zypper install dnsmasq”)</span></span> 
  * <span data-ttu-id="b4c6e-177">啟用 dnsmasq 服務 (“systemctl enable dnsmasq.service”)</span><span class="sxs-lookup"><span data-stu-id="b4c6e-177">enable the dnsmasq service (“systemctl enable dnsmasq.service”)</span></span> 
  * <span data-ttu-id="b4c6e-178">啟動 dnsmasq 服務 (“systemctl start dnsmasq.service”)</span><span class="sxs-lookup"><span data-stu-id="b4c6e-178">start the dnsmasq service (“systemctl start dnsmasq.service”)</span></span> 
  * <span data-ttu-id="b4c6e-179">編輯 “/etc/sysconfig/network/config” 並將 NETCONFIG_DNS_FORWARDER="" 變更為 ”dnsmasq”</span><span class="sxs-lookup"><span data-stu-id="b4c6e-179">edit “/etc/sysconfig/network/config” and change NETCONFIG_DNS_FORWARDER="" to ”dnsmasq”</span></span>
  * <span data-ttu-id="b4c6e-180">更新 resolv.conf ("netconfig update") 來設定快取做為本機 DNS 解析程式</span><span class="sxs-lookup"><span data-stu-id="b4c6e-180">update resolv.conf ("netconfig update") to set the cache as the local DNS resolver</span></span>
* <span data-ttu-id="b4c6e-181">OpenLogic (使用 NetworkManager)：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-181">**OpenLogic (uses NetworkManager)**:</span></span>
  * <span data-ttu-id="b4c6e-182">安裝 dnsmasq 封裝 (“sudo yum install dnsmasq”)</span><span class="sxs-lookup"><span data-stu-id="b4c6e-182">install the dnsmasq package (“sudo yum install dnsmasq”)</span></span>
  * <span data-ttu-id="b4c6e-183">啟用 dnsmasq 服務 (“systemctl enable dnsmasq.service”)</span><span class="sxs-lookup"><span data-stu-id="b4c6e-183">enable the dnsmasq service (“systemctl enable dnsmasq.service”)</span></span>
  * <span data-ttu-id="b4c6e-184">啟動 dnsmasq 服務 (“systemctl start dnsmasq.service”)</span><span class="sxs-lookup"><span data-stu-id="b4c6e-184">start the dnsmasq service (“systemctl start dnsmasq.service”)</span></span>
  * <span data-ttu-id="b4c6e-185">將 “prepend domain-name-servers 127.0.0.1;” 新增至 “/etc/dhclient-eth0.conf”</span><span class="sxs-lookup"><span data-stu-id="b4c6e-185">add “prepend domain-name-servers 127.0.0.1;” to “/etc/dhclient-eth0.conf”</span></span>
  * <span data-ttu-id="b4c6e-186">重新啟動網路服務 (「服務網路重新啟動」) 來設定快取做為本機 DNS 解析程式</span><span class="sxs-lookup"><span data-stu-id="b4c6e-186">restart the network service (“service network restart”) to set the cache as the local DNS resolver</span></span>

> [!NOTE]
> <span data-ttu-id="b4c6e-187">'dnsmasq' 封裝只是適用於 Linux 的眾多 DNS 快取其中之一。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-187">The 'dnsmasq' package is only one of the many DNS caches available for Linux.</span></span>  <span data-ttu-id="b4c6e-188">使用它之前，請檢查特定需求的適用性，而且沒有安裝其他快取。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-188">Before using it, please check its suitability for your particular needs and that no other cache is installed.</span></span>
> 
> 

<bpt id="p1">**</bpt>Client-side Retries:<ept id="p1">**</ept>

<span data-ttu-id="b4c6e-190">DNS 主要是 UDP 通訊協定。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-190">DNS is primarily a UDP protocol.</span></span>  <span data-ttu-id="b4c6e-191">因為 UDP 通訊協定並不保證訊息傳遞，所以重試邏輯會在 DNS 通訊協定本身處理。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-191">As the UDP protocol doesn't guarantee message delivery, retry logic is handled in the DNS protocol itself.</span></span>  <span data-ttu-id="b4c6e-192">每個 DNS 用戶端 (作業系統) 可以展現不同的重試邏輯，根據建立者喜好設定而定：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-192">Each DNS client (operating system) can exhibit different retry logic depending on the creators preference:</span></span>

* <span data-ttu-id="b4c6e-193">Windows 作業系統會在 1 秒後重試，然後再依序隔 2、4、4 秒後重試。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-193">Windows operating systems retry after 1 second and then again after another 2, 4 and another 4 seconds.</span></span> 
* <span data-ttu-id="b4c6e-194">預設 Linux 安裝程式會在 5 秒之後重試。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-194">The default Linux setup retries after 5 seconds.</span></span>  <span data-ttu-id="b4c6e-195">建議您變更為以 1 秒的間隔重試 5 次。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-195">It is recommended to change this to retry 5 times at 1 second intervals.</span></span>  

<span data-ttu-id="b4c6e-196">檢查 Linux VM 上目前的設定，'cat /etc/resolv.conf' 並查看 [選項] 行，例如：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-196">To check the current settings on a Linux VM, 'cat /etc/resolv.conf' and look at the 'options' line, e.g.:</span></span>

    options timeout:1 attempts:5

<span data-ttu-id="b4c6e-197">resolv.conf 檔案通常是自動產生的，且不可編輯。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-197">The resolv.conf file is usually auto-generated and should not be edited.</span></span>  <span data-ttu-id="b4c6e-198">新增 [選項] 行的特定步驟會因散發版本而有所不同：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-198">The specific steps for adding the 'options' line vary by distro:</span></span>

* <span data-ttu-id="b4c6e-199"> (使用 resolvconf)：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-199">**Ubuntu** (uses resolvconf):</span></span>
  * <span data-ttu-id="b4c6e-200">將選項行新增至 '/etc/resolveconf/resolv.conf.d/head'</span><span class="sxs-lookup"><span data-stu-id="b4c6e-200">add the options line to '/etc/resolveconf/resolv.conf.d/head'</span></span> 
  * <span data-ttu-id="b4c6e-201">執行 'resolvconf -u' 以進行更新</span><span class="sxs-lookup"><span data-stu-id="b4c6e-201">run 'resolvconf -u' to update</span></span>
* <span data-ttu-id="b4c6e-202"> (使用 netconf)：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-202">**SUSE** (uses netconf):</span></span>
  * <span data-ttu-id="b4c6e-203">將 'timeout:1 attempts:5' 新增至 '/etc/sysconfig/network/config' 中的 NETCONFIG_DNS_RESOLVER_OPTIONS="" 參數</span><span class="sxs-lookup"><span data-stu-id="b4c6e-203">add 'timeout:1 attempts:5' to the NETCONFIG_DNS_RESOLVER_OPTIONS="" parameter in '/etc/sysconfig/network/config'</span></span> 
  * <span data-ttu-id="b4c6e-204">執行 'netconfig update' 以進行更新</span><span class="sxs-lookup"><span data-stu-id="b4c6e-204">run 'netconfig update' to update</span></span>
* <span data-ttu-id="b4c6e-205"> (使用 NetworkManager)：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-205">**OpenLogic** (uses NetworkManager):</span></span>
  * <span data-ttu-id="b4c6e-206">將 'echo "options timeout:1 attempts:5"' 新增至 '/etc/NetworkManager/dispatcher.d/11-dhclient'</span><span class="sxs-lookup"><span data-stu-id="b4c6e-206">add 'echo "options timeout:1 attempts:5"' to '/etc/NetworkManager/dispatcher.d/11-dhclient'</span></span> 
  * <span data-ttu-id="b4c6e-207">執行 'service network restart' 以進行更新</span><span class="sxs-lookup"><span data-stu-id="b4c6e-207">run 'service network restart' to update</span></span>

## <a name="name-resolution-using-your-own-dns-server"></a><span data-ttu-id="b4c6e-208">使用專屬 DNS 伺服器的名稱解析</span><span class="sxs-lookup"><span data-stu-id="b4c6e-208">Name resolution using your own DNS server</span></span>
<span data-ttu-id="b4c6e-209">在某些情況下，您的名稱解析需要可能會超過 Azure 所能提供的功能，例如使用 Active Directory 網域時，或當您需要虛擬網路 (vnet) 之間的 DNS 解析時。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-209">There are a number of situations where your name resolution needs may go beyond the features provided by Azure, for example when using Active Directory domains or when you require DNS resolution between virtual networks (vnets).</span></span>  <span data-ttu-id="b4c6e-210">為了涵蓋這些案例，Azure 提供可讓您使用專屬 DNS 伺服器的能力。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-210">To cover these scenarios, Azure provides the ability for you to use your own DNS servers.</span></span>  

<span data-ttu-id="b4c6e-211">虛擬網路內的 DNS 可以將要求轉送到 Azure 內的遞迴解析程式，以解析該虛擬網路內的主機名稱。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-211">DNS servers within a virtual network can forward DNS queries to Azure's recursive resolvers to resolve hostnames within that virtual network.</span></span>  <span data-ttu-id="b4c6e-212">例如，在 Azure 中執行的網域控制站 (DC) 可以回應其網域的 DNS 要求，並將所有其他要求轉送到 Azure。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-212">For example, a Domain Controller (DC) running in Azure can respond to DNS queries for its domains and forward all other queries to Azure.</span></span>  <span data-ttu-id="b4c6e-213">這樣可讓 VM 查看您的內部部署資源 (透過 DC) 以及 Azure 提供的主機名稱 (透過轉送)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-213">This allows VMs to see both your on-premises resources (via the DC) and Azure-provided hostnames (via the forwarder).</span></span>  <span data-ttu-id="b4c6e-214">存取 Azure 的遞迴解析程式是透過所提供的虛擬 IP 168.63.129.16。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-214">Access to Azure's recursive resolvers is provided via the virtual IP 168.63.129.16.</span></span>

<span data-ttu-id="b4c6e-215">DNS 轉送也實現 vnet 之間的 DNS 解析，並使內部部署電腦能夠解析 Azure 提供的主機名稱。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-215">DNS forwarding also enables inter-vnet DNS resolution and allows your on-premises machines to resolve Azure-provided hostnames.</span></span>  <span data-ttu-id="b4c6e-216">為了解析 VM的主機名稱，DNS 伺服器 VM 必須位於同一個虛擬網路中，且設定為將主機名稱要求轉送到 Azure。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-216">In order to resolve a VM's hostname, the DNS server VM must reside in the same virtual network and be configured to forward hostname queries to Azure.</span></span>  <span data-ttu-id="b4c6e-217">因為每個 vnet 的 DNS 尾碼都不同，所以您可以使用條件性轉送規則來將 DNS 要求傳送到正確的 vnet 進行解析。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-217">As the DNS suffix is different in each vnet, you can use conditional forwarding rules to send DNS queries to the correct vnet for resolution.</span></span>  <span data-ttu-id="b4c6e-218">下圖顯示使用此方法進行虛擬網路間 DNS 解析的兩個 vnet 及一個內部部署網路。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-218">The following image shows two vnets and an on-premises network doing inter-vnet DNS resolution using this method.</span></span>  <span data-ttu-id="b4c6e-219">如需 DNS 轉寄站的範例，請參閱 [Azure 快速入門範本庫](https://azure.microsoft.com/documentation/templates/301-dns-forwarder/)和 [GitHub](https://github.com/Azure/azure-quickstart-templates/tree/master/301-dns-forwarder)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-219">An example DNS forwarder is available in the [Azure Quickstart Templates gallery](https://azure.microsoft.com/documentation/templates/301-dns-forwarder/) and [GitHub](https://github.com/Azure/azure-quickstart-templates/tree/master/301-dns-forwarder).</span></span>

![虛擬網路之間的 DNS](./media/virtual-networks-name-resolution-for-vms-and-role-instances/inter-vnet-dns.png)

<span data-ttu-id="b4c6e-221">使用 Azure 提供的名稱解析時，會提供一個內部 DNS 尾碼 (*.internal.cloudapp.net) 給每部使用 DHCP 的 VM。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-221">When using Azure-provided name resolution, an Internal DNS suffix (*.internal.cloudapp.net) is provided to each VM using DHCP.</span></span>  <span data-ttu-id="b4c6e-222">這會啟用主機名稱解析，因為主機名稱記錄是在 internal.cloudapp.net 區域中。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-222">This enables hostname resolution as the hostname records are in the internal.cloudapp.net zone.</span></span>  <span data-ttu-id="b4c6e-223">使用您自己的名稱解析解決方案時，則不會提供 IDNS 尾碼給 VM，因為它會干擾其他 DNS 架構 (例如在已加入網域的案例中)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-223">When using your own name resolution solution, the IDNS suffix is not supplied to VMs because it interferes with other DNS architectures (like domain-joined scenarios).</span></span>  <span data-ttu-id="b4c6e-224">我們會改為提供一個沒有作用的預留位置 (reddog.microsoft.com)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-224">Instead we provide a non-functioning placeholder (reddog.microsoft.com).</span></span>  

<span data-ttu-id="b4c6e-225">如有需要，可以使用 PowerShell 或 API 來確定內部 DNS 尾碼︰</span><span class="sxs-lookup"><span data-stu-id="b4c6e-225">If needed, the Internal DNS suffix can be determined using PowerShell or the API:</span></span>

* <span data-ttu-id="b4c6e-226">針對 Resource Manager 部署模型中的虛擬網路，您可以透過[網路介面卡](https://msdn.microsoft.com/library/azure/mt163668.aspx)資源或 [Get-AzureRmNetworkInterface](https://msdn.microsoft.com/library/mt619434.aspx) Cmdlet 來取得尾碼。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-226">For virtual networks in Resource Manager deployment models, the suffix is available via the [network interface card](https://msdn.microsoft.com/library/azure/mt163668.aspx) resource or via the [Get-AzureRmNetworkInterface](https://msdn.microsoft.com/library/mt619434.aspx) cmdlet.</span></span>    
* <span data-ttu-id="b4c6e-227">在傳統部署模型中，可以透過[取得部署 API](https://msdn.microsoft.com/library/azure/ee460804.aspx) 呼叫或 [Get-AzureVM -Debug](https://msdn.microsoft.com/library/azure/dn495236.aspx) Cmdlet 來取得尾碼。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-227">In classic deployment models, the suffix is available via the [Get Deployment API](https://msdn.microsoft.com/library/azure/ee460804.aspx) call or via the [Get-AzureVM -Debug](https://msdn.microsoft.com/library/azure/dn495236.aspx) cmdlet.</span></span>

<span data-ttu-id="b4c6e-228">如果將查詢轉送到 Azure 不符合您的需求，您會需要提供專屬的 DNS 解決方案。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-228">If forwarding queries to Azure doesn't suit your needs, you will need to provide your own DNS solution.</span></span>  <span data-ttu-id="b4c6e-229">您的 DNS 解決方案將需要：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-229">Your DNS solution will need to:</span></span>

* <span data-ttu-id="b4c6e-230">提供適當的主機名稱解析，例如透過 [DDNS](virtual-networks-name-resolution-ddns.md)。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-230">Provide appropriate hostname resolution, e.g. via [DDNS](virtual-networks-name-resolution-ddns.md).</span></span>  <span data-ttu-id="b4c6e-231">請注意，如果使用 DDNS，您可能需要停用 DNS 記錄清除功能，因為 Azure 的 DHCP 租用期很長，所以 DNS 記錄可能會提前被清除。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-231">Note, if using DDNS you may need to disable DNS record scavenging as Azure's DHCP leases are very long and scavenging may remove DNS records prematurely.</span></span> 
* <span data-ttu-id="b4c6e-232">提供適當的遞迴解析來允許外部網域名稱的解析。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-232">Provide appropriate recursive resolution to allow resolution of external domain names.</span></span>
* <span data-ttu-id="b4c6e-233">可從其服務的用戶端存取 (連接埠 53 上的 TCP 和 UDP)，且能夠存取網際網路。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-233">Be accessible (TCP and UDP on port 53) from the clients it serves and be able to access the internet.</span></span>
* <span data-ttu-id="b4c6e-234">受保護以防止來自網際網路的存取，降低外部代理程式的威脅。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-234">Be secured against access from the internet, to mitigate threats posed by external agents.</span></span>

> [!NOTE]
> <span data-ttu-id="b4c6e-235">為了達到最佳效能，使用 Azure VM 做為 DNS 伺服器時，應該停用 IPv6 且 [執行個體層級公用 IP](virtual-networks-instance-level-public-ip.md) 應該指派給每個 DNS 伺服器 VM。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-235">For best performance, when using Azure VMs as DNS servers, IPv6 should be disabled and an [Instance-Level Public IP](virtual-networks-instance-level-public-ip.md) should be assigned to each DNS server VM.</span></span>  <span data-ttu-id="b4c6e-236">如果您選擇使用 Windows Server 做為 DNS 伺服器， [這篇文章](http://blogs.technet.com/b/networking/archive/2015/08/19/name-resolution-performance-of-a-recursive-windows-dns-server-2012-r2.aspx) 提供了其他的效能分析和最佳化方法。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-236">If you choose to use Windows Server as your DNS server, [this article](http://blogs.technet.com/b/networking/archive/2015/08/19/name-resolution-performance-of-a-recursive-windows-dns-server-2012-r2.aspx) provides additional performance analysis and optimizations.</span></span>
> 
> 

### <a name="specifying-dns-servers"></a><span data-ttu-id="b4c6e-237">指定 DNS 伺服器</span><span class="sxs-lookup"><span data-stu-id="b4c6e-237">Specifying DNS servers</span></span>
<span data-ttu-id="b4c6e-238">使用您自己的 DNS 伺服器時，Azure 會提供對每個虛擬網路或每個網路介面 (資源管理員) / 雲端服務 (傳統) 指定多個 DNS 伺服器的能力。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-238">When using your own DNS servers, Azure provides the ability to specify multiple DNS servers per virtual network or per network interface (Resource Manager) / cloud service (classic).</span></span>  <span data-ttu-id="b4c6e-239">針對雲端服務/網路介面指定的 DNS 伺服器的優先順序高於針對虛擬網路指定的那些項目。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-239">DNS servers specified for a cloud service/network interface get precedence over those specified for the virtual network.</span></span>

> [!NOTE]
> <span data-ttu-id="b4c6e-240">網路連接屬性，例如 DNS 伺服器 IP，不應該直接在 Windows VM 內編輯，因為當替換虛擬網路介面卡時，它們可能會在服務修復期間被清除。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-240">Network connection properties, such as DNS server IPs, should not be edited directly within Windows VMs as they may get erased during service heal when the virtual network adaptor gets replaced.</span></span> 
> 
> 

<span data-ttu-id="b4c6e-241">使用 Resource Manager 部署模型時，可以在入口網站、API/範本 ([vnet](https://msdn.microsoft.com/library/azure/mt163661.aspx)、[nic](https://msdn.microsoft.com/library/azure/mt163668.aspx)) 或 PowerShell ([vnet](https://msdn.microsoft.com/library/mt603657.aspx)、[nic](https://msdn.microsoft.com/library/mt619370.aspx)) 中指定 DNS 伺服器。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-241">When using the Resource Manager deployment model, DNS servers can be specified in the Portal, API/Templates ([vnet](https://msdn.microsoft.com/library/azure/mt163661.aspx), [nic](https://msdn.microsoft.com/library/azure/mt163668.aspx)) or PowerShell ([vnet](https://msdn.microsoft.com/library/mt603657.aspx), [nic](https://msdn.microsoft.com/library/mt619370.aspx)).</span></span>

<span data-ttu-id="b4c6e-242">使用傳統部署模型時，可以在入口網站或[網路組態檔案](https://msdn.microsoft.com/library/azure/jj157100)中指定虛擬網路的 DNS 伺服器。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-242">When using the classic deployment model, DNS servers for the virtual network can be specified in the Portal or [the *Network Configuration* file](https://msdn.microsoft.com/library/azure/jj157100).</span></span>  <span data-ttu-id="b4c6e-243">針對雲端服務，則是透過[服務組態](https://msdn.microsoft.com/library/azure/ee758710)檔案或在 PowerShell ([New-AzureVM](https://msdn.microsoft.com/library/azure/dn495254.aspx)) 中指定 DNS 伺服器。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-243">For cloud services, the DNS servers are specified via [the *Service Configuration* file](https://msdn.microsoft.com/library/azure/ee758710) or in PowerShell ([New-AzureVM](https://msdn.microsoft.com/library/azure/dn495254.aspx)).</span></span>

> [!NOTE]
> <span data-ttu-id="b4c6e-244">如果您變更已部署好之虛擬網路/虛擬機器的 DNS 設定，您必須重新啟動每個受影響的 VM，變更才會生效。</span><span class="sxs-lookup"><span data-stu-id="b4c6e-244">If you change the DNS settings for a virtual network/virtual machine that is already deployed, you need to restart each affected VM for the changes to take effect.</span></span>
> 
> 

## <a name="next-steps"></a><span data-ttu-id="b4c6e-245">後續步驟</span><span class="sxs-lookup"><span data-stu-id="b4c6e-245">Next steps</span></span>
<span data-ttu-id="b4c6e-246">資源管理員部署模型：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-246">Resource Manager deployment model:</span></span>

* [<span data-ttu-id="b4c6e-247">建立或更新虛擬網路</span><span class="sxs-lookup"><span data-stu-id="b4c6e-247">Create or update a virtual network</span></span>](https://msdn.microsoft.com/library/azure/mt163661.aspx)
* [<span data-ttu-id="b4c6e-248">建立或更新網路介面卡</span><span class="sxs-lookup"><span data-stu-id="b4c6e-248">Create or update a network interface card</span></span>](https://msdn.microsoft.com/library/azure/mt163668.aspx)
* [<span data-ttu-id="b4c6e-249">New-AzureRmVirtualNetwork</span><span class="sxs-lookup"><span data-stu-id="b4c6e-249">New-AzureRmVirtualNetwork</span></span>](https://msdn.microsoft.com/library/mt603657.aspx)
* [<span data-ttu-id="b4c6e-250">New-AzureRmNetworkInterface</span><span class="sxs-lookup"><span data-stu-id="b4c6e-250">New-AzureRmNetworkInterface</span></span>](https://msdn.microsoft.com/library/mt619370.aspx)

<span data-ttu-id="b4c6e-251">傳統部署模型：</span><span class="sxs-lookup"><span data-stu-id="b4c6e-251">Classic deployment model:</span></span>

* [<span data-ttu-id="b4c6e-252">Azure 服務組態結構描述</span><span class="sxs-lookup"><span data-stu-id="b4c6e-252">Azure Service Configuration Schema</span></span>](https://msdn.microsoft.com/library/azure/ee758710)
* [<span data-ttu-id="b4c6e-253">虛擬網路組態結構描述</span><span class="sxs-lookup"><span data-stu-id="b4c6e-253">Virtual Network Configuration Schema</span></span>](https://msdn.microsoft.com/library/azure/jj157100)
* [<span data-ttu-id="b4c6e-254">使用網路組態檔設定虛擬網路</span><span class="sxs-lookup"><span data-stu-id="b4c6e-254">Configure a Virtual Network by Using a Network Configuration File</span></span>](virtual-networks-using-network-configuration-file.md) 

