---
title: "aaaHybrid 連線與 2 層應用程式 |Microsoft 文件"
description: "深入了解如何 toodeploy 虛擬設備以及 UDR toocreate 在 Azure 中的多層式應用程式環境"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 53599862289dbf9c6ab3289b0cb8dda6430f20f7
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="77e5b-103">虛擬設備的案例</span><span class="sxs-lookup"><span data-stu-id="77e5b-103">Virtual appliance scenario</span></span>
<span data-ttu-id="77e5b-104">在較大的 Azure 客戶之間常見的案例是 hello 需要 tooprovide 兩層式應用程式公開 toohello 網際網路，同時允許存取 toohello 回復層從內部部署資料中心。</span><span class="sxs-lookup"><span data-stu-id="77e5b-104">A common scenario among larger Azure customer is hello need tooprovide a two-tiered application exposed toohello Internet, while allowing access toohello back tier from an on-premises datacenter.</span></span> <span data-ttu-id="77e5b-105">本文件將逐步引導您使用使用者定義的路由 (UDR)、 VPN 閘道和網路的虛擬應用裝置 toodeploy 的案例符合下列需求的 hello 兩層式環境：</span><span class="sxs-lookup"><span data-stu-id="77e5b-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances toodeploy a two-tier environment that meets hello following requirements:</span></span>

* <span data-ttu-id="77e5b-106">Web 應用程式必須能夠從 hello 公開的網際網路。</span><span class="sxs-lookup"><span data-stu-id="77e5b-106">Web application must be accessible from hello public Internet only.</span></span>
* <span data-ttu-id="77e5b-107">Web 伺服器裝載 hello 應用程式必須能夠 tooaccess 後端應用程式伺服器。</span><span class="sxs-lookup"><span data-stu-id="77e5b-107">Web server hosting hello application must be able tooaccess a backend application server.</span></span>
* <span data-ttu-id="77e5b-108">來自 hello 網際網路 toohello web 應用程式的所有流量必須都通過防火牆的虛擬設備。</span><span class="sxs-lookup"><span data-stu-id="77e5b-108">All traffic from hello Internet toohello web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="77e5b-109">這個虛擬設備只用於網際網路流量。</span><span class="sxs-lookup"><span data-stu-id="77e5b-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="77e5b-110">將 toohello 應用程式伺服器的所有流量必須都通過防火牆的虛擬設備。</span><span class="sxs-lookup"><span data-stu-id="77e5b-110">All traffic going toohello application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="77e5b-111">此虛擬應用裝置將用於存取 toohello 後端結束伺服器，以及存取來自 hello 與內部網路透過 VPN 閘道。</span><span class="sxs-lookup"><span data-stu-id="77e5b-111">This virtual appliance will be used for access toohello backend end server, and access coming in from hello on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="77e5b-112">系統管理員必須能夠 toomanage hello 防火牆虛擬應用程式從他們的內部部署電腦、 使用協力廠商防火牆專門用於管理用途的虛擬設備。</span><span class="sxs-lookup"><span data-stu-id="77e5b-112">Administrators must be able toomanage hello firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="77e5b-113">這是標準的 DMZ 和受保護網路的 DMZ 案例。</span><span class="sxs-lookup"><span data-stu-id="77e5b-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="77e5b-114">您可利用 NSG、防火牆虛擬設備或兩者的組合，在 Azure 中建構這類案例。</span><span class="sxs-lookup"><span data-stu-id="77e5b-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="77e5b-115">hello 表會顯示 hello 優缺點 Nsg 與防火牆虛擬應用裝置之間的部分。</span><span class="sxs-lookup"><span data-stu-id="77e5b-115">hello table below shows some of hello pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="77e5b-116">優點</span><span class="sxs-lookup"><span data-stu-id="77e5b-116">Pros</span></span> | <span data-ttu-id="77e5b-117">缺點</span><span class="sxs-lookup"><span data-stu-id="77e5b-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="77e5b-118">NSG</span><span class="sxs-lookup"><span data-stu-id="77e5b-118">NSG</span></span> |<span data-ttu-id="77e5b-119">無成本。</span><span class="sxs-lookup"><span data-stu-id="77e5b-119">No cost.</span></span> <br/><span data-ttu-id="77e5b-120">整合到 Azure RBAC。</span><span class="sxs-lookup"><span data-stu-id="77e5b-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="77e5b-121">可在 ARM 範本中建立規則。</span><span class="sxs-lookup"><span data-stu-id="77e5b-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="77e5b-122">大型環境中的複雜性各有不同。</span><span class="sxs-lookup"><span data-stu-id="77e5b-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="77e5b-123">防火牆</span><span class="sxs-lookup"><span data-stu-id="77e5b-123">Firewall</span></span> |<span data-ttu-id="77e5b-124">完全掌控資料面。</span><span class="sxs-lookup"><span data-stu-id="77e5b-124">Full control over data plane.</span></span> <br/><span data-ttu-id="77e5b-125">透過防火牆主控台集中管理。</span><span class="sxs-lookup"><span data-stu-id="77e5b-125">Central management through firewall console.</span></span> |<span data-ttu-id="77e5b-126">防火牆設備的成本。</span><span class="sxs-lookup"><span data-stu-id="77e5b-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="77e5b-127">不與 Azure RBAC 相整合。</span><span class="sxs-lookup"><span data-stu-id="77e5b-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="77e5b-128">下方的 hello 解決方案會使用防火牆虛擬應用裝置 tooimplement DMZ/保護網路案例。</span><span class="sxs-lookup"><span data-stu-id="77e5b-128">hello solution below uses firewall virtual appliances tooimplement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="77e5b-129">考量</span><span class="sxs-lookup"><span data-stu-id="77e5b-129">Considerations</span></span>
<span data-ttu-id="77e5b-130">您可以將上述說明今天、，如下所示，使用不同的功能在 Azure 中的 hello 環境的部署。</span><span class="sxs-lookup"><span data-stu-id="77e5b-130">You can deploy hello environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="77e5b-131">**虛擬網路 (VNet)**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="77e5b-132">Azure VNet 的作用類似的方式 tooan 在內部部署網路，而且可以分割成子網路 tooprovide 流量隔離和的重要性分離一或多個。</span><span class="sxs-lookup"><span data-stu-id="77e5b-132">An Azure VNet acts in similar fashion tooan on-premises network, and can be segmented into one or more subnets tooprovide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="77e5b-133">**虛擬設備**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-133">**Virtual appliance**.</span></span> <span data-ttu-id="77e5b-134">數個合作夥伴提供 hello 可用於 hello 有三個防火牆上面所述的 Azure Marketplace 中的虛擬設備。</span><span class="sxs-lookup"><span data-stu-id="77e5b-134">Several partners provide virtual appliances in hello Azure Marketplace that can be used for hello three firewalls described above.</span></span> 
* <span data-ttu-id="77e5b-135">**使用者定義路由 (UDR)**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="77e5b-136">路由表可以包含 UDRs Azure 網路 toocontrol hello 封包流量的 VNet 中所使用。</span><span class="sxs-lookup"><span data-stu-id="77e5b-136">Route tables can contain UDRs used by Azure networking toocontrol hello flow of packets within a VNet.</span></span> <span data-ttu-id="77e5b-137">這些路由表可以套用的 toosubnets。</span><span class="sxs-lookup"><span data-stu-id="77e5b-137">These route tables can be applied toosubnets.</span></span> <span data-ttu-id="77e5b-138">在 Azure 中的 hello 最新功能是 hello 能力 tooapply 路由表 toohello GatewaySubnet，提供 hello 能力 tooforward 進入 hello Azure VNet 從混合式連線 tooa 虛擬應用裝置的所有流量。</span><span class="sxs-lookup"><span data-stu-id="77e5b-138">One of hello newest features in Azure is hello ability tooapply a route table toohello GatewaySubnet, providing hello ability tooforward all traffic coming into hello Azure VNet from a hybrid connection tooa virtual appliance.</span></span>
* <span data-ttu-id="77e5b-139">**IP 轉送**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-139">**IP Forwarding**.</span></span> <span data-ttu-id="77e5b-140">根據預設，hello Azure 網路引擎轉送封包 toovirtual 網路介面卡 (Nic) 只有 hello 封包目的地 IP 位址符合 hello NIC 的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="77e5b-140">By default, hello Azure networking engine forward packets toovirtual network interface cards (NICs) only if hello packet destination IP address matches hello NIC IP address.</span></span> <span data-ttu-id="77e5b-141">因此，如果 UDR 定義 tooa 指定虛擬應用裝置必須傳送封包，hello Azure 網路引擎會卸除的封包。</span><span class="sxs-lookup"><span data-stu-id="77e5b-141">Therefore, if a UDR defines that a packet must be sent tooa given virtual appliance, hello Azure networking engine would drop that packet.</span></span> <span data-ttu-id="77e5b-142">tooensure hello 封包傳遞 tooa （在本例中為虛擬應用裝置） 不是 hello 實際目的地為 hello 封包的 VM，您需要 IP 轉送 tooenable hello 虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="77e5b-142">tooensure hello packet is delivered tooa VM (in this case a virtual appliance) that is not hello actual destination for hello packet, you need tooenable IP Forwarding for hello virtual appliance.</span></span>
* <span data-ttu-id="77e5b-143">**網路安全性群組 (NSG)**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="77e5b-144">以下的 hello 範例不會使用 Nsg，但您可以使用此方案 toofurther 篩選 hello 流量進出這些子網路和 Nic 套用 Nsg toohello 子網路和/或 Nic。</span><span class="sxs-lookup"><span data-stu-id="77e5b-144">hello example below does not make use of NSGs, but you could use NSGs applied toohello subnets and/or NICs in this solution toofurther filter hello traffic in and out of those subnets and NICs.</span></span>

![IPv6 網路連線](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="77e5b-146">在此範例中沒有包含 hello 下列訂用帳戶：</span><span class="sxs-lookup"><span data-stu-id="77e5b-146">In this example there is a subscription that contains hello following:</span></span>

* <span data-ttu-id="77e5b-147">2 資源群組，不會顯示 hello 圖表中。</span><span class="sxs-lookup"><span data-stu-id="77e5b-147">2 resource groups, not shown in hello diagram.</span></span> 
  * <span data-ttu-id="77e5b-148">**ONPREMRG**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-148">**ONPREMRG**.</span></span> <span data-ttu-id="77e5b-149">包含所有的資源需要 toosimulate 在內部部署網路。</span><span class="sxs-lookup"><span data-stu-id="77e5b-149">Contains all resources necessary toosimulate an on-premises network.</span></span>
  * <span data-ttu-id="77e5b-150">**AZURERG**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-150">**AZURERG**.</span></span> <span data-ttu-id="77e5b-151">包含針對 hello Azure 虛擬網路環境所需的所有資源。</span><span class="sxs-lookup"><span data-stu-id="77e5b-151">Contains all resources necessary for hello Azure virtual network environment.</span></span> 
* <span data-ttu-id="77e5b-152">名為 VNet **onpremvnet**用的 toomimic 在內部部署資料中心的區段如下所示。</span><span class="sxs-lookup"><span data-stu-id="77e5b-152">A VNet named **onpremvnet** used toomimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="77e5b-153">**onpremsn1**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-153">**onpremsn1**.</span></span> <span data-ttu-id="77e5b-154">包含執行 Ubuntu toomimic 在內部部署伺服器的虛擬機器 (VM) 的子網路。</span><span class="sxs-lookup"><span data-stu-id="77e5b-154">Subnet containing a virtual machine (VM) running Ubuntu toomimic an on-premises server.</span></span>
  * <span data-ttu-id="77e5b-155">**onpremsn2**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-155">**onpremsn2**.</span></span> <span data-ttu-id="77e5b-156">包含執行 Ubuntu toomimic-內部部署電腦系統管理員使用的 VM 子網路。</span><span class="sxs-lookup"><span data-stu-id="77e5b-156">Subnet containing a VM running Ubuntu toomimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="77e5b-157">還有一個名為防火牆虛擬設備**OPFW**上**onpremvnet**太用 toomaintain 通道**azurevnet**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used toomaintain a tunnel too**azurevnet**.</span></span>
* <span data-ttu-id="77e5b-158">名為 **azurevnet** 的 VNet 分段，如下所示。</span><span class="sxs-lookup"><span data-stu-id="77e5b-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="77e5b-159">**azsn1**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-159">**azsn1**.</span></span> <span data-ttu-id="77e5b-160">專用於 hello 外部防火牆的外部防火牆子網路。</span><span class="sxs-lookup"><span data-stu-id="77e5b-160">External firewall subnet used exclusively for hello external firewall.</span></span> <span data-ttu-id="77e5b-161">所有的網際網路流量都會從這個子網路進入。</span><span class="sxs-lookup"><span data-stu-id="77e5b-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="77e5b-162">此子網路只包含連結的 NIC toohello 外部防火牆。</span><span class="sxs-lookup"><span data-stu-id="77e5b-162">This subnet only contains a NIC linked toohello external firewall.</span></span>
  * <span data-ttu-id="77e5b-163">**azsn2**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-163">**azsn2**.</span></span> <span data-ttu-id="77e5b-164">裝載執行做為從 hello 網際網路存取的 web 伺服器的 VM 子網路的前端。</span><span class="sxs-lookup"><span data-stu-id="77e5b-164">Front end subnet hosting a VM running as a web server that will be accessed from hello Internet.</span></span>
  * <span data-ttu-id="77e5b-165">**azsn3**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-165">**azsn3**.</span></span> <span data-ttu-id="77e5b-166">裝載執行會 hello 前端 web 伺服器來存取後端應用程式伺服器的 VM 子網路的後端。</span><span class="sxs-lookup"><span data-stu-id="77e5b-166">Backend subnet hosting a VM running a backend application server that will be accessed by hello front end web server.</span></span>
  * <span data-ttu-id="77e5b-167">**azsn4**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-167">**azsn4**.</span></span> <span data-ttu-id="77e5b-168">管理子網路會使用專門 tooprovide 管理存取 tooall 防火牆虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="77e5b-168">Management subnet used exclusively tooprovide management access tooall firewall virtual appliances.</span></span> <span data-ttu-id="77e5b-169">此子網路只包含 hello 解決方案中使用的虛擬應用裝置每個防火牆的 NIC。</span><span class="sxs-lookup"><span data-stu-id="77e5b-169">This subnet only contains a NIC for each firewall virtual appliance used in hello solution.</span></span>
  * <span data-ttu-id="77e5b-170">**GatewaySubnet**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-170">**GatewaySubnet**.</span></span> <span data-ttu-id="77e5b-171">Azure 的混合式連線子網路所需的 Azure Vnet 與其他網路之間的 ExpressRoute 與 VPN 閘道 tooprovide 連線。</span><span class="sxs-lookup"><span data-stu-id="77e5b-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway tooprovide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="77e5b-172">有 3 的防火牆虛擬應用裝置，在 hello **azurevnet**網路。</span><span class="sxs-lookup"><span data-stu-id="77e5b-172">There are 3 firewall virtual appliances in hello **azurevnet** network.</span></span> 
  * <span data-ttu-id="77e5b-173">**AZF1**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-173">**AZF1**.</span></span> <span data-ttu-id="77e5b-174">公開外部防火牆 toohello 公用網際網路，在 Azure 中使用公用 IP 位址資源。</span><span class="sxs-lookup"><span data-stu-id="77e5b-174">External firewall exposed toohello public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="77e5b-175">您需要 tooensure 3 NIC 的虛擬設備已從 hello 服務商場或直接從您的應用裝置廠商，來佈建的範本。</span><span class="sxs-lookup"><span data-stu-id="77e5b-175">You need tooensure you have a template from hello Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="77e5b-176">**AZF2**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-176">**AZF2**.</span></span> <span data-ttu-id="77e5b-177">使用 toocontrol 之間流量的內部防火牆**azsn2**和**azsn3**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-177">Internal firewall used toocontrol traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="77e5b-178">這也是 3-NIC 的虛擬設備。</span><span class="sxs-lookup"><span data-stu-id="77e5b-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="77e5b-179">**AZF3**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-179">**AZF3**.</span></span> <span data-ttu-id="77e5b-180">管理防火牆存取 tooadministrators hello 從內部部署資料中心，並已連線的 tooa 管理子網路使用 toomanage 所有防火牆應用裝置。</span><span class="sxs-lookup"><span data-stu-id="77e5b-180">Management firewall accessible tooadministrators from hello on-premises datacenter, and connected tooa management subnet used toomanage all firewall appliances.</span></span> <span data-ttu-id="77e5b-181">您可以在 hello Marketplace 中找到 2 NIC 的虛擬設備範本，或要求直接從您的應用裝置廠商。</span><span class="sxs-lookup"><span data-stu-id="77e5b-181">You can find 2-NIC virtual appliance templates in hello Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="77e5b-182">使用者定義的路由 (UDR)</span><span class="sxs-lookup"><span data-stu-id="77e5b-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="77e5b-183">在 Azure 中的每個子網路可以是連結的 tooa UDR 使用資料表 toodefine 該子起始的流量路由方式。</span><span class="sxs-lookup"><span data-stu-id="77e5b-183">Each subnet in Azure can be linked tooa UDR table used toodefine how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="77e5b-184">如果已不定義任何 UDRs，Azure 會使用預設路由 tooallow 流量 tooflow 從一個子網路 tooanother。</span><span class="sxs-lookup"><span data-stu-id="77e5b-184">If no UDRs are defined, Azure uses default routes tooallow traffic tooflow from one subnet tooanother.</span></span> <span data-ttu-id="77e5b-185">toobetter UDRs 了解，請瀏覽[什麼是使用者定義的路由與 IP 轉送](virtual-networks-udr-overview.md#ip-forwarding)。</span><span class="sxs-lookup"><span data-stu-id="77e5b-185">toobetter understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="77e5b-186">tooensure 通訊都會透過 hello 正確的防火牆應用裝置中，根據上述 hello 最後一個需求，您需要 toocreate hello 下列路由表包含在 UDRs **azurevnet**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-186">tooensure communication is done through hello right firewall appliance, based on hello last requirement above, you need toocreate hello following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="77e5b-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="77e5b-187">azgwudr</span></span>
<span data-ttu-id="77e5b-188">在此案例中，hello 只從內部部署 tooAzure 流動的流量會使用的 toomanage hello 防火牆連線太**AZF3**，及流量必須經過 hello 內部防火牆， **AZF2**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-188">In this scenario, hello only traffic flowing from on-premises tooAzure will be used toomanage hello firewalls by connecting too**AZF3**, and that traffic must go through hello internal firewall, **AZF2**.</span></span> <span data-ttu-id="77e5b-189">因此，只有一個路由是必要的 hello **GatewaySubnet**如下所示。</span><span class="sxs-lookup"><span data-stu-id="77e5b-189">Therefore, only one route is necessary in hello **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="77e5b-190">目的地</span><span class="sxs-lookup"><span data-stu-id="77e5b-190">Destination</span></span> | <span data-ttu-id="77e5b-191">下一個躍點</span><span class="sxs-lookup"><span data-stu-id="77e5b-191">Next hop</span></span> | <span data-ttu-id="77e5b-192">說明</span><span class="sxs-lookup"><span data-stu-id="77e5b-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="77e5b-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="77e5b-193">10.0.4.0/24</span></span> |<span data-ttu-id="77e5b-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="77e5b-194">10.0.3.11</span></span> |<span data-ttu-id="77e5b-195">可讓內部部署傳輸 tooreach 管理防火牆**AZF3**</span><span class="sxs-lookup"><span data-stu-id="77e5b-195">Allows on-premises traffic tooreach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="77e5b-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="77e5b-196">azsn2udr</span></span>
| <span data-ttu-id="77e5b-197">目的地</span><span class="sxs-lookup"><span data-stu-id="77e5b-197">Destination</span></span> | <span data-ttu-id="77e5b-198">下一個躍點</span><span class="sxs-lookup"><span data-stu-id="77e5b-198">Next hop</span></span> | <span data-ttu-id="77e5b-199">說明</span><span class="sxs-lookup"><span data-stu-id="77e5b-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="77e5b-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="77e5b-200">10.0.3.0/24</span></span> |<span data-ttu-id="77e5b-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="77e5b-201">10.0.2.11</span></span> |<span data-ttu-id="77e5b-202">可讓主控透過 hello 應用程式伺服器的流量 toohello 後端子網路**AZF2**</span><span class="sxs-lookup"><span data-stu-id="77e5b-202">Allows traffic toohello backend subnet hosting hello application server through **AZF2**</span></span> |
| <span data-ttu-id="77e5b-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="77e5b-203">0.0.0.0/0</span></span> |<span data-ttu-id="77e5b-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="77e5b-204">10.0.2.10</span></span> |<span data-ttu-id="77e5b-205">可讓所有透過路由其他流量 toobe **AZF1**</span><span class="sxs-lookup"><span data-stu-id="77e5b-205">Allows all other traffic toobe routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="77e5b-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="77e5b-206">azsn3udr</span></span>
| <span data-ttu-id="77e5b-207">目的地</span><span class="sxs-lookup"><span data-stu-id="77e5b-207">Destination</span></span> | <span data-ttu-id="77e5b-208">下一個躍點</span><span class="sxs-lookup"><span data-stu-id="77e5b-208">Next hop</span></span> | <span data-ttu-id="77e5b-209">說明</span><span class="sxs-lookup"><span data-stu-id="77e5b-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="77e5b-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="77e5b-210">10.0.2.0/24</span></span> |<span data-ttu-id="77e5b-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="77e5b-211">10.0.3.10</span></span> |<span data-ttu-id="77e5b-212">允許流量太**azsn2**應用程式透過伺服器 toohello 網頁伺服器從 tooflow **AZF2**</span><span class="sxs-lookup"><span data-stu-id="77e5b-212">Allows traffic too**azsn2** tooflow from app server toohello webserver through **AZF2**</span></span> |

<span data-ttu-id="77e5b-213">您也需要 toocreate 路由表中的 hello 子網路**onpremvnet** toomimic hello 內部部署資料中心。</span><span class="sxs-lookup"><span data-stu-id="77e5b-213">You also need toocreate route tables for hello subnets in **onpremvnet** toomimic hello on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="77e5b-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="77e5b-214">onpremsn1udr</span></span>
| <span data-ttu-id="77e5b-215">目的地</span><span class="sxs-lookup"><span data-stu-id="77e5b-215">Destination</span></span> | <span data-ttu-id="77e5b-216">下一個躍點</span><span class="sxs-lookup"><span data-stu-id="77e5b-216">Next hop</span></span> | <span data-ttu-id="77e5b-217">說明</span><span class="sxs-lookup"><span data-stu-id="77e5b-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="77e5b-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="77e5b-218">192.168.2.0/24</span></span> |<span data-ttu-id="77e5b-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="77e5b-219">192.168.1.4</span></span> |<span data-ttu-id="77e5b-220">允許流量太**onpremsn2**透過**OPFW**</span><span class="sxs-lookup"><span data-stu-id="77e5b-220">Allows traffic too**onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="77e5b-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="77e5b-221">onpremsn2udr</span></span>
| <span data-ttu-id="77e5b-222">目的地</span><span class="sxs-lookup"><span data-stu-id="77e5b-222">Destination</span></span> | <span data-ttu-id="77e5b-223">下一個躍點</span><span class="sxs-lookup"><span data-stu-id="77e5b-223">Next hop</span></span> | <span data-ttu-id="77e5b-224">說明</span><span class="sxs-lookup"><span data-stu-id="77e5b-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="77e5b-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="77e5b-225">10.0.3.0/24</span></span> |<span data-ttu-id="77e5b-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="77e5b-226">192.168.2.4</span></span> |<span data-ttu-id="77e5b-227">允許流量 toohello 備份子網路透過 Azure 中**OPFW**</span><span class="sxs-lookup"><span data-stu-id="77e5b-227">Allows traffic toohello backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="77e5b-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="77e5b-228">192.168.1.0/24</span></span> |<span data-ttu-id="77e5b-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="77e5b-229">192.168.2.4</span></span> |<span data-ttu-id="77e5b-230">允許流量太**onpremsn1**透過**OPFW**</span><span class="sxs-lookup"><span data-stu-id="77e5b-230">Allows traffic too**onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="77e5b-231">IP 轉送</span><span class="sxs-lookup"><span data-stu-id="77e5b-231">IP Forwarding</span></span>
<span data-ttu-id="77e5b-232">UDR 和 IP 轉送 」 是您可以使用組合 tooallow 虛擬應用裝置 toobe 用 toocontrol 流量流程在 Azure VNet 中的功能。</span><span class="sxs-lookup"><span data-stu-id="77e5b-232">UDR and IP Forwarding are features that you can use in combination tooallow virtual appliances toobe used toocontrol traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="77e5b-233">虛擬應用裝置只是執行以某種方式，例如防火牆或 NAT 裝置的應用程式使用 toohandle 網路流量的 VM。</span><span class="sxs-lookup"><span data-stu-id="77e5b-233">A virtual appliance is nothing more than a VM that runs an application used toohandle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="77e5b-234">此 VM 必須是能夠 tooreceive 連入流量的虛擬應用裝置中並未提及 tooitself。</span><span class="sxs-lookup"><span data-stu-id="77e5b-234">This virtual appliance VM must be able tooreceive incoming traffic that is not addressed tooitself.</span></span> <span data-ttu-id="77e5b-235">tooallow VM tooreceive 流量定址 tooother 目的地，您必須啟用 IP 轉送 hello VM。</span><span class="sxs-lookup"><span data-stu-id="77e5b-235">tooallow a VM tooreceive traffic addressed tooother destinations, you must enable IP Forwarding for hello VM.</span></span> <span data-ttu-id="77e5b-236">這是 Azure 設定，不是在 hello 客體作業系統設定。</span><span class="sxs-lookup"><span data-stu-id="77e5b-236">This is an Azure setting, not a setting in hello guest operating system.</span></span> <span data-ttu-id="77e5b-237">某些類型的應用程式 toohandle 您的虛擬設備仍需要 toorun hello 連入流量，並適當地路由傳送。</span><span class="sxs-lookup"><span data-stu-id="77e5b-237">Your virtual appliance still needs toorun some type of application toohandle hello incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="77e5b-238">toolearn 深入了解 IP 轉送，請瀏覽[什麼是使用者定義的路由與 IP 轉送](virtual-networks-udr-overview.md#ip-forwarding)。</span><span class="sxs-lookup"><span data-stu-id="77e5b-238">toolearn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="77e5b-239">例如，假設您有下列安裝程式在 Azure vnet 中的 hello:</span><span class="sxs-lookup"><span data-stu-id="77e5b-239">As an example, imagine you have hello following setup in an Azure vnet:</span></span>

* <span data-ttu-id="77e5b-240">子網路 **onpremsn1** 包含名為 **onpremvm1** 的 VM。</span><span class="sxs-lookup"><span data-stu-id="77e5b-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="77e5b-241">子網路 **onpremsn2** 包含名為 **onpremvm2** 的 VM。</span><span class="sxs-lookup"><span data-stu-id="77e5b-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="77e5b-242">名為虛擬應用裝置**OPFW**太連接**onpremsn1**和**onpremsn2**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-242">A virtual appliance named **OPFW** is connected too**onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="77e5b-243">使用者定義路由連結太**onpremsn1**指定所有流量太**onpremsn2**必須太傳送**OPFW**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-243">A user defined route linked too**onpremsn1** specifies that all traffic too**onpremsn2** must be sent too**OPFW**.</span></span>

<span data-ttu-id="77e5b-244">在這點時，如果**onpremvm1**的連線嘗試 tooestablish **onpremvm2**、 hello UDR 將用於和的流量將傳送太**OPFW**為 hello 下一個躍點。</span><span class="sxs-lookup"><span data-stu-id="77e5b-244">At this point, if **onpremvm1** tries tooestablish a connection with **onpremvm2**, hello UDR will be used and traffic will be sent too**OPFW** as hello next hop.</span></span> <span data-ttu-id="77e5b-245">請記住，hello 實際封包目的地未變更，它仍指出**onpremvm2** hello 目的地。</span><span class="sxs-lookup"><span data-stu-id="77e5b-245">Keep in mind that hello actual packet destination is not being changed, it still says **onpremvm2** is hello destination.</span></span> 

<span data-ttu-id="77e5b-246">不含 IP 轉送 」 啟用**OPFW**hello Azure 虛擬網路的邏輯將會卸除 hello 封包，因為它只允許封包傳送 toobe tooa VM，如果 hello VM 的 IP 位址是 hello hello 封包的目的地。</span><span class="sxs-lookup"><span data-stu-id="77e5b-246">Without IP Forwarding enabled for **OPFW**, hello Azure virtual networking logic will drop hello packets, since it only allows packets toobe sent tooa VM if hello VM’s IP address is hello destination for hello packet.</span></span>

<span data-ttu-id="77e5b-247">使用 IP 轉送，hello Azure 虛擬網路的邏輯會轉送 hello 封包 tooOPFW，而不需要變更其原始目的地位址。</span><span class="sxs-lookup"><span data-stu-id="77e5b-247">With IP Forwarding, hello Azure virtual network logic will forward hello packets tooOPFW, without changing its original destination address.</span></span> <span data-ttu-id="77e5b-248">**OPFW**必須處理 hello 封包，並判斷哪些 toodo 它們。</span><span class="sxs-lookup"><span data-stu-id="77e5b-248">**OPFW** must handle hello packets and determine what toodo with them.</span></span>

<span data-ttu-id="77e5b-249">上述 toowork hello 案例中，您必須啟用 IP 轉送 」 hello Nic 上**OPFW**， **AZF1**， **AZF2**，和**AZF3**適用於路由 (hello 的連結的 toohello 管理子網路以外的所有 Nic)。</span><span class="sxs-lookup"><span data-stu-id="77e5b-249">For hello scenario above toowork, you must enable IP Forwarding on hello NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except hello ones linked toohello management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="77e5b-250">防火牆規則</span><span class="sxs-lookup"><span data-stu-id="77e5b-250">Firewall Rules</span></span>
<span data-ttu-id="77e5b-251">如上面所述，IP 轉送只可確保傳送封包 toohello 虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="77e5b-251">As described above, IP Forwarding only ensures packets are sent toohello virtual appliances.</span></span> <span data-ttu-id="77e5b-252">您的應用裝置仍然需要 toodecide 哪些 toodo 與這些封包。</span><span class="sxs-lookup"><span data-stu-id="77e5b-252">Your appliance still needs toodecide what toodo with those packets.</span></span> <span data-ttu-id="77e5b-253">在上述的 hello 情況下，您將需要 toocreate hello 依照您的應用裝置中的規則：</span><span class="sxs-lookup"><span data-stu-id="77e5b-253">In hello scenario above, you will need toocreate hello following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="77e5b-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="77e5b-254">OPFW</span></span>
<span data-ttu-id="77e5b-255">OPFW 代表包含 hello 下列規則在內部部署裝置：</span><span class="sxs-lookup"><span data-stu-id="77e5b-255">OPFW represents an on-premises device containing hello following rules:</span></span>

* <span data-ttu-id="77e5b-256">**路由**: too10.0.0.0/16 的所有流量 (**azurevnet**) 必須透過通道傳送**ONPREMAZURE**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-256">**Route**: All traffic too10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="77e5b-257">**原則**︰允許 **port2** 和 **ONPREMAZURE** 之間所有的雙向流量。</span><span class="sxs-lookup"><span data-stu-id="77e5b-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="77e5b-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="77e5b-258">AZF1</span></span>
<span data-ttu-id="77e5b-259">AZF1 代表 Azure 的虛擬應用裝置，以包含 hello 下列規則：</span><span class="sxs-lookup"><span data-stu-id="77e5b-259">AZF1 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="77e5b-260">**原則**︰允許 **port1** 和 **port2** 之間所有的雙向流量。</span><span class="sxs-lookup"><span data-stu-id="77e5b-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="77e5b-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="77e5b-261">AZF2</span></span>
<span data-ttu-id="77e5b-262">AZF2 代表 Azure 的虛擬應用裝置，以包含 hello 下列規則：</span><span class="sxs-lookup"><span data-stu-id="77e5b-262">AZF2 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="77e5b-263">**路由**: too10.0.0.0/16 的所有流量 (**onpremvnet**) 必須透過傳送 toohello Azure 閘道 IP 位址 (例如 10.0.0.1) **port1**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-263">**Route**: All traffic too10.0.0.0/16 (**onpremvnet**) must be sent toohello Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="77e5b-264">**原則**︰允許 **port1** 和 **port2** 之間所有的雙向流量。</span><span class="sxs-lookup"><span data-stu-id="77e5b-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="77e5b-265">網路安全性群組 (NSG)</span><span class="sxs-lookup"><span data-stu-id="77e5b-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="77e5b-266">這個案例中不會使用 NSG。</span><span class="sxs-lookup"><span data-stu-id="77e5b-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="77e5b-267">不過，您可以套用 Nsg tooeach 子網路 toorestrict 傳入和傳出流量。</span><span class="sxs-lookup"><span data-stu-id="77e5b-267">However, you could apply NSGs tooeach subnet toorestrict incoming and outgoing traffic.</span></span> <span data-ttu-id="77e5b-268">比方說，您可以套用 hello 遵循 NSG 規則 toohello 外部 FW 子網路。</span><span class="sxs-lookup"><span data-stu-id="77e5b-268">For instance, you could apply hello following NSG rules toohello external FW subnet.</span></span>

<span data-ttu-id="77e5b-269">**連入**</span><span class="sxs-lookup"><span data-stu-id="77e5b-269">**Incoming**</span></span>

* <span data-ttu-id="77e5b-270">允許從任何 VM 上的 hello 網際網路 tooport 80 的所有 TCP 流量 hello 子網路中。</span><span class="sxs-lookup"><span data-stu-id="77e5b-270">Allow all TCP traffic from hello Internet tooport 80 on any VM in hello subnet.</span></span>
* <span data-ttu-id="77e5b-271">從網際網路 hello 拒絕所有其他流量。</span><span class="sxs-lookup"><span data-stu-id="77e5b-271">Deny all other traffic from hello Internet.</span></span>

<span data-ttu-id="77e5b-272">**連出**</span><span class="sxs-lookup"><span data-stu-id="77e5b-272">**Outgoing**</span></span>

* <span data-ttu-id="77e5b-273">拒絕所有流量 toohello 網際網路。</span><span class="sxs-lookup"><span data-stu-id="77e5b-273">Deny all traffic toohello Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="77e5b-274">高階步驟</span><span class="sxs-lookup"><span data-stu-id="77e5b-274">High level steps</span></span>
<span data-ttu-id="77e5b-275">toodeploy 此案例中，遵循 hello 高階步驟下方。</span><span class="sxs-lookup"><span data-stu-id="77e5b-275">toodeploy this scenario, follow hello high level steps below.</span></span>

1. <span data-ttu-id="77e5b-276">登入 tooyour Azure 訂用帳戶。</span><span class="sxs-lookup"><span data-stu-id="77e5b-276">Login tooyour Azure Subscription.</span></span>
2. <span data-ttu-id="77e5b-277">如果您想 toodeploy VNet toomimic hello 內部部署網路，佈建 hello 資源屬於**ONPREMRG**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-277">If you want toodeploy a VNet toomimic hello on-premises network, provision hello resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="77e5b-278">佈建 hello 資源屬於**AZURERG**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-278">Provision hello resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="77e5b-279">從佈建 hello 通道**onpremvnet**太**azurevnet**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-279">Provision hello tunnel from **onpremvnet** too**azurevnet**.</span></span>
5. <span data-ttu-id="77e5b-280">佈建的所有資源後，登入太**onpremvm2**間的 ping 10.0.3.101 tootest 連線**onpremsn2**和**azsn3**。</span><span class="sxs-lookup"><span data-stu-id="77e5b-280">Once all resources are provisioned, log on too**onpremvm2** and ping 10.0.3.101 tootest connectivity between **onpremsn2** and **azsn3**.</span></span>

