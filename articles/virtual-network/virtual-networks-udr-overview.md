---
title: "aaaUser 定義路由，並在 Azure 中的 IP 轉送 |Microsoft 文件"
description: "了解 tooconfigure 使用者定義路由 (UDR) 和 IP 轉送 tooforward 流量 toonetwork 在 Azure 中的虛擬應用裝置。"
services: virtual-network
documentationcenter: na
author: jimdial
manager: timlt
editor: tysonn
ms.assetid: c39076c4-11b7-4b46-a904-817503c4b486
ms.service: virtual-network
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/15/2016
ms.author: jdial
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: f1f1d46166d5a7c776f472b7ade1354d943ece10
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="user-defined-routes-and-ip-forwarding"></a><span data-ttu-id="f3bcc-103">使用者定義的路由和 IP 轉送</span><span class="sxs-lookup"><span data-stu-id="f3bcc-103">User-defined routes and IP forwarding</span></span>

<span data-ttu-id="f3bcc-104">當您在 Azure 中新增虛擬機器 (Vm) tooa 虛擬網路 (VNet) 時，您會發現 hello Vm 會自動無法 toocommunicate 彼此 hello 網路上。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-104">When you add virtual machines (VMs) tooa virtual network (VNet) in Azure, you will notice that hello VMs are able toocommunicate with each other over hello network, automatically.</span></span> <span data-ttu-id="f3bcc-105">您不需要 toospecify 閘道，即使 hello Vm 位於不同的子網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-105">You do not need toospecify a gateway, even though hello VMs are in different subnets.</span></span> <span data-ttu-id="f3bcc-106">hello 也適用於來自 hello Vm toohello 通訊公用網際網路，以及混合式連線從 Azure tooyour 擁有資料中心已存在時，甚至 tooyour 與內部網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-106">hello same is true for communication from hello VMs toohello public Internet, and even tooyour on-premises network when a hybrid connection from Azure tooyour own datacenter is present.</span></span>

<span data-ttu-id="f3bcc-107">這個流量可能是通訊的因為 Azure 會使用一系列的系統路由 toodefine IP 流量流動的方式。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-107">This flow of communication is possible because Azure uses a series of system routes toodefine how IP traffic flows.</span></span> <span data-ttu-id="f3bcc-108">系統路由控制 hello hello 下列案例中的通訊流程：</span><span class="sxs-lookup"><span data-stu-id="f3bcc-108">System routes control hello flow of communication in hello following scenarios:</span></span>

* <span data-ttu-id="f3bcc-109">從 hello 相同子網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-109">From within hello same subnet.</span></span>
* <span data-ttu-id="f3bcc-110">從 VNet 中的子網路 tooanother。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-110">From a subnet tooanother within a VNet.</span></span>
* <span data-ttu-id="f3bcc-111">從 Vm toohello 網際網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-111">From VMs toohello Internet.</span></span>
* <span data-ttu-id="f3bcc-112">從透過 VPN 閘道 VNet tooanother VNet。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-112">From a VNet tooanother VNet through a VPN gateway.</span></span>
* <span data-ttu-id="f3bcc-113">從 VNet tooanother VNet 透過 VNet 對等 （服務鏈結）。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-113">From a VNet tooanother VNet through VNet Peering (Service Chaining).</span></span>
* <span data-ttu-id="f3bcc-114">從透過 VPN 閘道的 VNet tooyour 在內部部署網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-114">From a VNet tooyour on-premises network through a VPN gateway.</span></span>

<span data-ttu-id="f3bcc-115">hello 圖顯示簡單的安裝過程中，使用 VNet、 兩個子網路，以及一些 Vm，以及 hello 可讓 IP 流量 tooflow 系統路由。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-115">hello figure below shows a simple setup with a VNet, two subnets, and a few VMs, along with hello system routes that allow IP traffic tooflow.</span></span>

![Azure 中的系統路由](./media/virtual-networks-udr-overview/Figure1.png)

<span data-ttu-id="f3bcc-117">雖然系統路由 hello 使用有助於流量自動為您的部署，有些情況是您想在其中 toocontrol hello 透過路由傳送封包的虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-117">Although hello use of system routes facilitates traffic automatically for your deployment, there are cases in which you want toocontrol hello routing of packets through a virtual appliance.</span></span> <span data-ttu-id="f3bcc-118">您可以因此藉由建立使用者定義的路由指定 hello 反而流動 tooa 特定子網路 toogo tooyour 虛擬設備的封包的下一個躍點和啟用 IP 轉送的 hello 執行為虛擬應用裝置 hello VM。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-118">You can do so by creating user defined routes that specify hello next hop for packets flowing tooa specific subnet toogo tooyour virtual appliance instead, and enabling IP forwarding for hello VM running as hello virtual appliance.</span></span>

<span data-ttu-id="f3bcc-119">hello 下圖示範使用者定義的路由與 IP 轉送 tooforce 封包透過第三個的子網路上的虛擬應用裝置從另一個 toogo 傳送 tooone 子網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-119">hello figure below shows an example of user defined routes and IP forwarding tooforce packets sent tooone subnet from another toogo through a virtual appliance on a third subnet.</span></span>

![Azure 中的系統路由](./media/virtual-networks-udr-overview/Figure2.png)

> [!IMPORTANT]
> <span data-ttu-id="f3bcc-121">套用的 tootraffic 離開子網路的任何資源 （例如，網路介面附加 tooVMs） hello 子網路中為使用者定義的路由。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-121">User-defined routes are applied tootraffic leaving a subnet from any resource (such as network interfaces attached tooVMs) in hello subnet.</span></span> <span data-ttu-id="f3bcc-122">您無法建立路由 toospecify 如何流量輸入子網路 hello 網際網路，從執行個體。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-122">You cannot create routes toospecify how traffic enters a subnet from hello Internet, for instance.</span></span> <span data-ttu-id="f3bcc-123">hello 應用裝置會轉寄流量 toocannot 處於 hello 出 hello 流量來源的相同子網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-123">hello appliance you are forwarding traffic toocannot be in hello same subnet where hello traffic originates.</span></span> <span data-ttu-id="f3bcc-124">請永遠為您的應用裝置建立個別的子網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-124">Always create a separate subnet for your appliances.</span></span> 
> 
> 

## <a name="route-resource"></a><span data-ttu-id="f3bcc-125">路由資源</span><span class="sxs-lookup"><span data-stu-id="f3bcc-125">Route resource</span></span>
<span data-ttu-id="f3bcc-126">透過路由表定義在 hello 實體網路上的每個節點上的 TCP/IP 網路路由傳送封包。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-126">Packets are routed over a TCP/IP network based on a route table defined at each node on hello physical network.</span></span> <span data-ttu-id="f3bcc-127">路由表是一系列個別的路由使用 toodecide 其中 tooforward 封包根據 hello 目的地 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-127">A route table is a collection of individual routes used toodecide where tooforward packets based on hello destination IP address.</span></span> <span data-ttu-id="f3bcc-128">路由包含 hello 下列：</span><span class="sxs-lookup"><span data-stu-id="f3bcc-128">A route consists of hello following:</span></span>

| <span data-ttu-id="f3bcc-129">屬性</span><span class="sxs-lookup"><span data-stu-id="f3bcc-129">Property</span></span> | <span data-ttu-id="f3bcc-130">說明</span><span class="sxs-lookup"><span data-stu-id="f3bcc-130">Description</span></span> | <span data-ttu-id="f3bcc-131">條件約束</span><span class="sxs-lookup"><span data-stu-id="f3bcc-131">Constraints</span></span> | <span data-ttu-id="f3bcc-132">考量</span><span class="sxs-lookup"><span data-stu-id="f3bcc-132">Considerations</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="f3bcc-133">位址首碼</span><span class="sxs-lookup"><span data-stu-id="f3bcc-133">Address Prefix</span></span> |<span data-ttu-id="f3bcc-134">hello 目的地 CIDR toowhich hello 路由套用，例如 10.1.0.0/16。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-134">hello destination CIDR toowhich hello route applies, such as 10.1.0.0/16.</span></span> |<span data-ttu-id="f3bcc-135">必須是有效的 CIDR 範圍，代表 hello 上的位址公用網際網路、 Azure 虛擬網路或在內部部署資料中心。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-135">Must be a valid CIDR range representing addresses on hello public Internet, Azure virtual network, or on-premises datacenter.</span></span> |<span data-ttu-id="f3bcc-136">請確定 hello**位址首碼**未包含 hello 的 hello 位址**下個躍點位址**，否則會進入迴圈，從 hello 來源 toohello 下一個躍點會不進入程式封包hello 目的地。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-136">Make sure hello **Address prefix** does not contain hello address for hello **Next hop address**, otherwise your packets will enter in a loop going from hello source toohello next hop without ever reaching hello destination.</span></span> |
| <span data-ttu-id="f3bcc-137">下一個躍點類型</span><span class="sxs-lookup"><span data-stu-id="f3bcc-137">Next hop type</span></span> |<span data-ttu-id="f3bcc-138">Azure 躍點 hello 封包的 hello 類型應該傳送至。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-138">hello type of Azure hop hello packet should be sent to.</span></span> |<span data-ttu-id="f3bcc-139">必須是 hello 的下列值的其中一個：</span><span class="sxs-lookup"><span data-stu-id="f3bcc-139">Must be one of hello following values:</span></span> <br/> <span data-ttu-id="f3bcc-140">**虛擬網路**。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-140">**Virtual Network**.</span></span> <span data-ttu-id="f3bcc-141">代表 hello 區域虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-141">Represents hello local virtual network.</span></span> <span data-ttu-id="f3bcc-142">例如，如果您有兩個子網路，10.1.0.0/16 和 10.2.0.0/16 在 hello 相同虛擬網路，hello hello 路由表中的每個子網路的路由會有的下一個躍點值*虛擬網路*。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-142">For instance, if you have two subnets, 10.1.0.0/16 and 10.2.0.0/16 in hello same virtual network, hello route for each subnet in hello route table will have a next hop value of *Virtual Network*.</span></span> <br/> <span data-ttu-id="f3bcc-143">**虛擬網路閘道**。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-143">**Virtual Network Gateway**.</span></span> <span data-ttu-id="f3bcc-144">代表 Azure S2S VPN 閘道。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-144">Represents an Azure S2S VPN Gateway.</span></span> <br/> <span data-ttu-id="f3bcc-145">**網際網路**。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-145">**Internet**.</span></span> <span data-ttu-id="f3bcc-146">代表 hello hello Azure 基礎結構所提供的預設網際網路閘道。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-146">Represents hello default Internet gateway provided by hello Azure Infrastructure.</span></span> <br/> <span data-ttu-id="f3bcc-147">**虛擬應用裝置**。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-147">**Virtual Appliance**.</span></span> <span data-ttu-id="f3bcc-148">表示加入 tooyour Azure 虛擬網路的虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-148">Represents a virtual appliance you added tooyour Azure virtual network.</span></span> <br/> <span data-ttu-id="f3bcc-149">**無**。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-149">**None**.</span></span> <span data-ttu-id="f3bcc-150">代表黑洞。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-150">Represents a black hole.</span></span> <span data-ttu-id="f3bcc-151">完全不會轉送轉送 tooa 黑洞的封包。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-151">Packets forwarded tooa black hole will not be forwarded at all.</span></span> |<span data-ttu-id="f3bcc-152">請考慮使用**虛擬設備**toodirect 流量 tooa VM 或 Azure 負載平衡器的內部 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-152">Consider using **Virtual Appliance** toodirect traffic tooa VM or Azure Load Balancer internal IP address.</span></span>  <span data-ttu-id="f3bcc-153">此類型允許 IP 位址，如下所述的 hello 的規格。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-153">This type allows hello specification of an IP address as described below.</span></span> <span data-ttu-id="f3bcc-154">請考慮使用**無**輸入 toostop 封包從流動 tooa 指定目的地。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-154">Consider using a **None** type toostop packets from flowing tooa given destination.</span></span> |
| <span data-ttu-id="f3bcc-155">下一個躍點位址</span><span class="sxs-lookup"><span data-stu-id="f3bcc-155">Next hop address</span></span> |<span data-ttu-id="f3bcc-156">下一個躍點位址 hello 包含 hello 應該要轉送封包的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-156">hello next hop address contains hello IP address packets should be forwarded to.</span></span> <span data-ttu-id="f3bcc-157">下一個躍點值只能用在 hello 下一個躍點類型所在的路由*虛擬設備*。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-157">Next hop values are only allowed in routes where hello next hop type is *Virtual Appliance*.</span></span> |<span data-ttu-id="f3bcc-158">必須是可連線到 hello 其中要套用 hello 使用者定義的路由，而不需要透過虛擬網路內的 IP 位址**虛擬網路閘道**。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-158">Must be an IP address that is reachable within hello Virtual Network where hello User Defined Route is applied, without going through a **Virtual Network Gateway**.</span></span> <span data-ttu-id="f3bcc-159">hello IP 位址有 toobe hello 相同虛擬網路，它會套用，或 peered 虛擬網路上。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-159">hello IP address has toobe on hello same Virtual Network where it is applied, or on a peered Virtual Network.</span></span> |<span data-ttu-id="f3bcc-160">如果 hello IP 位址代表 VM，請確定您已啟用[IP 轉送](#IP-forwarding)hello VM 的 Azure 中。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-160">If hello IP address represents a VM, make sure you enable [IP forwarding](#IP-forwarding) in Azure for hello VM.</span></span> <span data-ttu-id="f3bcc-161">Hello IP 位址代表 hello 內部 IP 位址的 Azure 負載平衡器，請確定您已符合負載平衡每個連接埠規則，如果您希望 tooload 平衡。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-161">If hello IP address represents hello internal IP address of Azure Load Balancer, make sure you have a matching load balancing rule for each port you wish tooload balance.</span></span>|

<span data-ttu-id="f3bcc-162">在 Azure PowerShell 中的某些 hello"NextHopType"值具有不同的名稱：</span><span class="sxs-lookup"><span data-stu-id="f3bcc-162">In Azure PowerShell some of hello "NextHopType" values have different names:</span></span>

* <span data-ttu-id="f3bcc-163">虛擬網路是 VnetLocal</span><span class="sxs-lookup"><span data-stu-id="f3bcc-163">Virtual Network is VnetLocal</span></span>
* <span data-ttu-id="f3bcc-164">虛擬網路閘道是 VirtualNetworkGateway</span><span class="sxs-lookup"><span data-stu-id="f3bcc-164">Virtual Network Gateway is VirtualNetworkGateway</span></span>
* <span data-ttu-id="f3bcc-165">虛擬應用裝置是 VirtualAppliance</span><span class="sxs-lookup"><span data-stu-id="f3bcc-165">Virtual Appliance is VirtualAppliance</span></span>
* <span data-ttu-id="f3bcc-166">網際網路是 Internet</span><span class="sxs-lookup"><span data-stu-id="f3bcc-166">Internet is Internet</span></span>
* <span data-ttu-id="f3bcc-167">無是 None</span><span class="sxs-lookup"><span data-stu-id="f3bcc-167">None is None</span></span>

### <a name="system-routes"></a><span data-ttu-id="f3bcc-168">系統路由</span><span class="sxs-lookup"><span data-stu-id="f3bcc-168">System routes</span></span>
<span data-ttu-id="f3bcc-169">建立虛擬網路中每個子網路會自動關聯於路由表含有下列系統的路由規則的 hello:</span><span class="sxs-lookup"><span data-stu-id="f3bcc-169">Every subnet created in a virtual network is automatically associated with a route table that contains hello following system route rules:</span></span>

* <span data-ttu-id="f3bcc-170">**本機 VNet 規則**：此規則會自動針對虛擬網路中的每個子網路建立。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-170">**Local Vnet Rule**: This rule is automatically created for every subnet in a virtual network.</span></span> <span data-ttu-id="f3bcc-171">它會指定在 hello VNet 中的 hello Vm 之間沒有直接的連結，並沒有任何中繼的下一個躍點。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-171">It specifies that there is a direct link between hello VMs in hello VNet and there is no intermediate next hop.</span></span>
* <span data-ttu-id="f3bcc-172">**在內部部署規則**： 此規則會套用 tooall 流量 toohello 在內部部署位址範圍，並使用做為下一個躍點目的地 hello 的 VPN 閘道。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-172">**On-premises Rule**: This rule applies tooall traffic destined toohello on-premises address range and uses VPN gateway as hello next hop destination.</span></span>
* <span data-ttu-id="f3bcc-173">**網際網路規則**： 此規則會處理所有流量 toohello 公用網際網路 (位址前置詞 0.0.0.0/0) 和使用 hello 基礎結構網際網路閘道為 hello 下個躍點的所有流量 toohello 網際網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-173">**Internet Rule**: This rule handles all traffic destined toohello public Internet (address prefix 0.0.0.0/0) and uses hello infrastructure internet gateway as hello next hop for all traffic destined toohello Internet.</span></span>

### <a name="user-defined-routes"></a><span data-ttu-id="f3bcc-174">使用者定義的路由</span><span class="sxs-lookup"><span data-stu-id="f3bcc-174">User-defined routes</span></span>
<span data-ttu-id="f3bcc-175">針對大多數環境您只需要已定義 azure 的 hello 系統路由。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-175">For most environments you will only need hello system routes already defined by Azure.</span></span> <span data-ttu-id="f3bcc-176">不過，您可能需要 toocreate 路由表，並將一個或多個路由在特定情況下，例如：</span><span class="sxs-lookup"><span data-stu-id="f3bcc-176">However, you may need toocreate a route table and add one or more routes in specific cases, such as:</span></span>

* <span data-ttu-id="f3bcc-177">強制通道透過在內部部署網路 toohello 網際網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-177">Force tunneling toohello Internet via your on-premises network.</span></span>
* <span data-ttu-id="f3bcc-178">在 Azure 環境中使用虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-178">Use of virtual appliances in your Azure environment.</span></span>

<span data-ttu-id="f3bcc-179">在上述的 hello 案例，您會有 toocreate 路由表，並加入使用者定義的路由 tooit。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-179">In hello scenarios above, you will have toocreate a route table and add user defined routes tooit.</span></span> <span data-ttu-id="f3bcc-180">您可以有多個路由表，而且 hello 相同的路由表可以是相關聯的 tooone 或更多子網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-180">You can have multiple route tables, and hello same route table can be associated tooone or more subnets.</span></span> <span data-ttu-id="f3bcc-181">而每個子網路只能關聯的 tooa 單一路由表。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-181">And each subnet can only be associated tooa single route table.</span></span> <span data-ttu-id="f3bcc-182">所有 Vm 和子網路中的雲端服務都使用 hello 路由相關聯資料表 toothat 子網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-182">All VMs and cloud services in a subnet use hello route table associated toothat subnet.</span></span>

<span data-ttu-id="f3bcc-183">子網路會依賴系統路由，直到路由表相關聯的 toohello 子網路。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-183">Subnets rely on system routes until a route table is associated toohello subnet.</span></span> <span data-ttu-id="f3bcc-184">一旦關聯存在之後，在使用者定義的路由和系統路由之間，就會根據最長前置詞比對 (LPM) 完成。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-184">Once an association exists, routing is done based on Longest Prefix Match (LPM) among both user defined routes and system routes.</span></span> <span data-ttu-id="f3bcc-185">如果沒有以 hello 相同 LPM 相符，然後選取路由的多個路由會根據其原來 hello 順序中：</span><span class="sxs-lookup"><span data-stu-id="f3bcc-185">If there is more than one route with hello same LPM match then a route is selected based on its origin in hello following order:</span></span>

1. <span data-ttu-id="f3bcc-186">使用者定義的路由</span><span class="sxs-lookup"><span data-stu-id="f3bcc-186">User defined route</span></span>
2. <span data-ttu-id="f3bcc-187">BGP 路由 (使用 ExpressRoute 時)</span><span class="sxs-lookup"><span data-stu-id="f3bcc-187">BGP route (when ExpressRoute is used)</span></span>
3. <span data-ttu-id="f3bcc-188">系統路由</span><span class="sxs-lookup"><span data-stu-id="f3bcc-188">System route</span></span>

<span data-ttu-id="f3bcc-189">toolearn 如何 toocreate 使用者定義的路由，請參閱[tooCreate 路由的方式，並啟用 Azure 中的 IP 轉送](virtual-network-create-udr-arm-template.md)。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-189">toolearn how toocreate user defined routes, see [How tooCreate Routes and Enable IP Forwarding in Azure](virtual-network-create-udr-arm-template.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f3bcc-190">使用者定義的路由會套用的 tooAzure Vm 和雲端服務。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-190">User defined routes are only applied tooAzure VMs and cloud services.</span></span> <span data-ttu-id="f3bcc-191">比方說，如果您想 tooadd 您在內部部署網路與 Azure 之間的防火牆虛擬應用裝置，您必須 toocreate 您 Azure 的路由表的使用者定義路由轉送所有流量 toohello 在內部部署位址空間 toohello 虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-191">For instance, if you want tooadd a firewall virtual appliance between your on-premises network and Azure, you will have toocreate a user defined route for your Azure route tables that forwards all traffic going toohello on-premises address space toohello virtual appliance.</span></span> <span data-ttu-id="f3bcc-192">您也可以加入使用者定義的路由 (UDR) toohello GatewaySubnet tooforward 從內部部署 tooAzure 的所有流量透過 hello 虛擬設備。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-192">You can also add a user defined route (UDR) toohello GatewaySubnet tooforward all traffic from on-premises tooAzure through hello virtual appliance.</span></span> <span data-ttu-id="f3bcc-193">這是近期內的新增功能。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-193">This is a recent addition.</span></span>
> 
> 

### <a name="bgp-routes"></a><span data-ttu-id="f3bcc-194">BGP 路由</span><span class="sxs-lookup"><span data-stu-id="f3bcc-194">BGP routes</span></span>
<span data-ttu-id="f3bcc-195">如果您有您在內部部署網路與 Azure 之間 ExpressRoute 連線，您可以從您的內部部署網路 tooAzure 啟用 BGP toopropagate 路由。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-195">If you have an ExpressRoute connection between your on-premises network and Azure, you can enable BGP toopropagate routes from your on-premises network tooAzure.</span></span> <span data-ttu-id="f3bcc-196">這些 BGP 路由會以 hello 與系統路由和使用者的相同方式定義每個 Azure 子網路路由。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-196">These BGP routes are used in hello same way as system routes and user defined routes in each Azure subnet.</span></span> <span data-ttu-id="f3bcc-197">如需詳細資訊，請參閱 [ExpressRoute 簡介](../expressroute/expressroute-introduction.md)。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-197">For more information see [ExpressRoute Introduction](../expressroute/expressroute-introduction.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="f3bcc-198">您可以設定您 Azure 環境 toouse 強制通道透過在內部部署網路，藉由建立使用者定義的路由為 hello 下一個躍點使用 hello VPN 閘道子網路 0.0.0.0/0。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-198">You can configure your Azure environment toouse force tunneling through your on-premises network by creating a user defined route for subnet 0.0.0.0/0 that uses hello VPN gateway as hello next hop.</span></span> <span data-ttu-id="f3bcc-199">不過，這只有在您使用的是 VPN 閘道，而不是 ExpressRoute 時，才有作用。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-199">However, this only works if you are using a VPN gateway, not ExpressRoute.</span></span> <span data-ttu-id="f3bcc-200">若是 Expressroute，強制通道是透過 BGP 設定。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-200">For ExpressRoute, forced tunneling is configured through BGP.</span></span>
> 
> 

## <a name="ip-forwarding"></a><span data-ttu-id="f3bcc-201">IP 轉送</span><span class="sxs-lookup"><span data-stu-id="f3bcc-201">IP forwarding</span></span>
<span data-ttu-id="f3bcc-202">如上所述，hello 主要原因 toocreate 的其中一個使用者定義路由是 tooforward 流量 tooa 虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-202">As described above, one of hello main reasons toocreate a user defined route is tooforward traffic tooa virtual appliance.</span></span> <span data-ttu-id="f3bcc-203">虛擬應用裝置只是執行以某種方式，例如防火牆或 NAT 裝置的應用程式使用 toohandle 網路流量的 VM。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-203">A virtual appliance is nothing more than a VM that runs an application used toohandle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="f3bcc-204">此 VM 必須是能夠 tooreceive 連入流量的虛擬應用裝置中並未提及 tooitself。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-204">This virtual appliance VM must be able tooreceive incoming traffic that is not addressed tooitself.</span></span> <span data-ttu-id="f3bcc-205">tooallow VM tooreceive 流量定址 tooother 目的地，您必須啟用 IP 轉送 hello VM。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-205">tooallow a VM tooreceive traffic addressed tooother destinations, you must enable IP Forwarding for hello VM.</span></span> <span data-ttu-id="f3bcc-206">這是 Azure 設定，不是在 hello 客體作業系統設定。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-206">This is an Azure setting, not a setting in hello guest operating system.</span></span>

## <a name="next-steps"></a><span data-ttu-id="f3bcc-207">後續步驟</span><span class="sxs-lookup"><span data-stu-id="f3bcc-207">Next steps</span></span>
* <span data-ttu-id="f3bcc-208">了解如何太[hello Resource Manager 部署模型中建立路由](virtual-network-create-udr-arm-template.md)並 toosubnets 產生關聯。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-208">Learn how too[create routes in hello Resource Manager deployment model](virtual-network-create-udr-arm-template.md) and associate them toosubnets.</span></span> 
* <span data-ttu-id="f3bcc-209">了解如何太[hello 傳統部署模型中建立路由](virtual-network-create-udr-classic-ps.md)並 toosubnets 產生關聯。</span><span class="sxs-lookup"><span data-stu-id="f3bcc-209">Learn how too[create routes in hello classic deployment model](virtual-network-create-udr-classic-ps.md) and associate them toosubnets.</span></span>

