---
title: "Azure 中的使用者定義路由和 IP 轉送 | Microsoft Docs"
description: "了解如何在 Azure 中設定使用者定義的路由 (UDR) 和 IP 轉送，以將流量轉送至網路虛擬應用裝置。"
services: virtual-network
documentationcenter: na
author: jimdial
manager: timlt
editor: tysonn
ms.assetid: c39076c4-11b7-4b46-a904-817503c4b486
ms.service: virtual-network
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 03/15/2016
ms.author: jdial
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 6274e0101f6fb0864c8d1efaef7fcde78b8760c3
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="user-defined-routes-and-ip-forwarding"></a><span data-ttu-id="3849a-103">使用者定義的路由和 IP 轉送</span><span class="sxs-lookup"><span data-stu-id="3849a-103">User-defined routes and IP forwarding</span></span>

<span data-ttu-id="3849a-104">當您在 Azure 中將虛擬機器 (VM) 新增到虛擬網路 (VNet) 時，您會發現 VM 能自動透過網路彼此通訊。</span><span class="sxs-lookup"><span data-stu-id="3849a-104">When you add virtual machines (VMs) to a virtual network (VNet) in Azure, you will notice that the VMs are able to communicate with each other over the network, automatically.</span></span> <span data-ttu-id="3849a-105">您不需要指定閘道，即使 VM 位於不同子網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-105">You do not need to specify a gateway, even though the VMs are in different subnets.</span></span> <span data-ttu-id="3849a-106">VM 到公開網際網路的通訊同樣適用，甚至當存在 Azure 到您的資料中心的混合連線時，也適用於您的內部網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-106">The same is true for communication from the VMs to the public Internet, and even to your on-premises network when a hybrid connection from Azure to your own datacenter is present.</span></span>

<span data-ttu-id="3849a-107">這個通訊流程是可能的，因為 Azure 會使用一連串系統路由來定義 IP 流量流動的方式。</span><span class="sxs-lookup"><span data-stu-id="3849a-107">This flow of communication is possible because Azure uses a series of system routes to define how IP traffic flows.</span></span> <span data-ttu-id="3849a-108">系統路由控制下列案例的通訊流程：</span><span class="sxs-lookup"><span data-stu-id="3849a-108">System routes control the flow of communication in the following scenarios:</span></span>

* <span data-ttu-id="3849a-109">從同一子網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-109">From within the same subnet.</span></span>
* <span data-ttu-id="3849a-110">從 VNet 中的子網路到另一個子網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-110">From a subnet to another within a VNet.</span></span>
* <span data-ttu-id="3849a-111">從 VM 到網際網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-111">From VMs to the Internet.</span></span>
* <span data-ttu-id="3849a-112">透過 VPN 閘道從 VNet 到另一個 VNet。</span><span class="sxs-lookup"><span data-stu-id="3849a-112">From a VNet to another VNet through a VPN gateway.</span></span>
* <span data-ttu-id="3849a-113">透過 VNet 對等互連 (服務鏈結)，從 VNet 到另一個 VNet。</span><span class="sxs-lookup"><span data-stu-id="3849a-113">From a VNet to another VNet through VNet Peering (Service Chaining).</span></span>
* <span data-ttu-id="3849a-114">透過 VPN 閘道從 VNet 到您的內部網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-114">From a VNet to your on-premises network through a VPN gateway.</span></span>

<span data-ttu-id="3849a-115">下圖顯示 1 個 Vnet、2 個子網路和一些 VM，以及允許 IP 流量流動的系統路由的簡易安裝。</span><span class="sxs-lookup"><span data-stu-id="3849a-115">The figure below shows a simple setup with a VNet, two subnets, and a few VMs, along with the system routes that allow IP traffic to flow.</span></span>

![Azure 中的系統路由](./media/virtual-networks-udr-overview/Figure1.png)

<span data-ttu-id="3849a-117">雖然使用系統路由可自動加速您部署的流量，但是也有一些您希望透過虛擬設備控制封包路由的情況。</span><span class="sxs-lookup"><span data-stu-id="3849a-117">Although the use of system routes facilitates traffic automatically for your deployment, there are cases in which you want to control the routing of packets through a virtual appliance.</span></span> <span data-ttu-id="3849a-118">您可以透過建立使用者定義的路由 (其指定流向指定子網路之封包的下個躍點，改為流向您的虛擬設備)，並啟用做為虛擬設備執行之 VM 的 IP 轉送。</span><span class="sxs-lookup"><span data-stu-id="3849a-118">You can do so by creating user defined routes that specify the next hop for packets flowing to a specific subnet to go to your virtual appliance instead, and enabling IP forwarding for the VM running as the virtual appliance.</span></span>

<span data-ttu-id="3849a-119">下圖顯示使用者定義的路由和 IP 轉送的範例，強制由一個子網路傳送到另一個子網路的封包於第三個子網路通過虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="3849a-119">The figure below shows an example of user defined routes and IP forwarding to force packets sent to one subnet from another to go through a virtual appliance on a third subnet.</span></span>

![Azure 中的系統路由](./media/virtual-networks-udr-overview/Figure2.png)

> [!IMPORTANT]
> <span data-ttu-id="3849a-121">使用者定義的路由會套用至從子網路中的任何資源 (例如，連結至 VM 的網路介面) 離開子網路的流量。</span><span class="sxs-lookup"><span data-stu-id="3849a-121">User-defined routes are applied to traffic leaving a subnet from any resource (such as network interfaces attached to VMs) in the subnet.</span></span> <span data-ttu-id="3849a-122">例如，您無法建立路由來指定流量該如何從網際網路進入某個子網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-122">You cannot create routes to specify how traffic enters a subnet from the Internet, for instance.</span></span> <span data-ttu-id="3849a-123">接收轉送流量的應用裝置不得與流量來源的裝置位於相同的子網路中。</span><span class="sxs-lookup"><span data-stu-id="3849a-123">The appliance you are forwarding traffic to cannot be in the same subnet where the traffic originates.</span></span> <span data-ttu-id="3849a-124">請永遠為您的應用裝置建立個別的子網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-124">Always create a separate subnet for your appliances.</span></span> 
> 
> 

## <a name="route-resource"></a><span data-ttu-id="3849a-125">路由資源</span><span class="sxs-lookup"><span data-stu-id="3849a-125">Route resource</span></span>
<span data-ttu-id="3849a-126">根據在實體網路上的每個節點定義的路由表，封包是透過 TCP/IP 網路路由傳送。</span><span class="sxs-lookup"><span data-stu-id="3849a-126">Packets are routed over a TCP/IP network based on a route table defined at each node on the physical network.</span></span> <span data-ttu-id="3849a-127">路由表是個別路由的集合，用於決定根據目的地 IP 位址，在何處轉送封包。</span><span class="sxs-lookup"><span data-stu-id="3849a-127">A route table is a collection of individual routes used to decide where to forward packets based on the destination IP address.</span></span> <span data-ttu-id="3849a-128">路由是由下列項目所組成：</span><span class="sxs-lookup"><span data-stu-id="3849a-128">A route consists of the following:</span></span>

| <span data-ttu-id="3849a-129">屬性</span><span class="sxs-lookup"><span data-stu-id="3849a-129">Property</span></span> | <span data-ttu-id="3849a-130">說明</span><span class="sxs-lookup"><span data-stu-id="3849a-130">Description</span></span> | <span data-ttu-id="3849a-131">條件約束</span><span class="sxs-lookup"><span data-stu-id="3849a-131">Constraints</span></span> | <span data-ttu-id="3849a-132">考量</span><span class="sxs-lookup"><span data-stu-id="3849a-132">Considerations</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="3849a-133">位址首碼</span><span class="sxs-lookup"><span data-stu-id="3849a-133">Address Prefix</span></span> |<span data-ttu-id="3849a-134">路由所套用的目的地 CIDR，例如 10.1.0.0/16。</span><span class="sxs-lookup"><span data-stu-id="3849a-134">The destination CIDR to which the route applies, such as 10.1.0.0/16.</span></span> |<span data-ttu-id="3849a-135">必須為代表公用網際網路、Azure 虛擬網路或內部部署資料中心上之位址的有效 CIDR 範圍。</span><span class="sxs-lookup"><span data-stu-id="3849a-135">Must be a valid CIDR range representing addresses on the public Internet, Azure virtual network, or on-premises datacenter.</span></span> |<span data-ttu-id="3849a-136">請確定 [位址首碼] 未包含 [下一個躍點位址] 的位址，否則您的封包將會進入來源與下一個躍點所形成的迴圈，而永遠不會抵達目的地。</span><span class="sxs-lookup"><span data-stu-id="3849a-136">Make sure the **Address prefix** does not contain the address for the **Next hop address**, otherwise your packets will enter in a loop going from the source to the next hop without ever reaching the destination.</span></span> |
| <span data-ttu-id="3849a-137">下一個躍點類型</span><span class="sxs-lookup"><span data-stu-id="3849a-137">Next hop type</span></span> |<span data-ttu-id="3849a-138">要接收封包的 Azure 躍點的類型。</span><span class="sxs-lookup"><span data-stu-id="3849a-138">The type of Azure hop the packet should be sent to.</span></span> |<span data-ttu-id="3849a-139">必須為下列其中一個值：</span><span class="sxs-lookup"><span data-stu-id="3849a-139">Must be one of the following values:</span></span> <br/> <span data-ttu-id="3849a-140">**虛擬網路**。</span><span class="sxs-lookup"><span data-stu-id="3849a-140">**Virtual Network**.</span></span> <span data-ttu-id="3849a-141">代表本機虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-141">Represents the local virtual network.</span></span> <span data-ttu-id="3849a-142">例如，如果您在相同的虛擬網路中有兩個子網路 (分別是 10.1.0.0/16 和 10.2.0.0/16)，則路由表中每個子網路的路由的下一個躍點值為「虛擬網路」 。</span><span class="sxs-lookup"><span data-stu-id="3849a-142">For instance, if you have two subnets, 10.1.0.0/16 and 10.2.0.0/16 in the same virtual network, the route for each subnet in the route table will have a next hop value of *Virtual Network*.</span></span> <br/> <span data-ttu-id="3849a-143">**虛擬網路閘道**。</span><span class="sxs-lookup"><span data-stu-id="3849a-143">**Virtual Network Gateway**.</span></span> <span data-ttu-id="3849a-144">代表 Azure S2S VPN 閘道。</span><span class="sxs-lookup"><span data-stu-id="3849a-144">Represents an Azure S2S VPN Gateway.</span></span> <br/> <span data-ttu-id="3849a-145">**網際網路**。</span><span class="sxs-lookup"><span data-stu-id="3849a-145">**Internet**.</span></span> <span data-ttu-id="3849a-146">代表 Azure 基礎結構所提供的預設網際網路閘道。</span><span class="sxs-lookup"><span data-stu-id="3849a-146">Represents the default Internet gateway provided by the Azure Infrastructure.</span></span> <br/> <span data-ttu-id="3849a-147">**虛擬應用裝置**。</span><span class="sxs-lookup"><span data-stu-id="3849a-147">**Virtual Appliance**.</span></span> <span data-ttu-id="3849a-148">代表您新增至 Azure 虛擬網路的虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="3849a-148">Represents a virtual appliance you added to your Azure virtual network.</span></span> <br/> <span data-ttu-id="3849a-149">**無**。</span><span class="sxs-lookup"><span data-stu-id="3849a-149">**None**.</span></span> <span data-ttu-id="3849a-150">代表黑洞。</span><span class="sxs-lookup"><span data-stu-id="3849a-150">Represents a black hole.</span></span> <span data-ttu-id="3849a-151">轉送至黑洞的封包將完全不會被轉送。</span><span class="sxs-lookup"><span data-stu-id="3849a-151">Packets forwarded to a black hole will not be forwarded at all.</span></span> |<span data-ttu-id="3849a-152">請考慮使用「虛擬應用裝置」將流量導向 VM 或 Azure Load Balancer 內部 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="3849a-152">Consider using **Virtual Appliance** to direct traffic to a VM or Azure Load Balancer internal IP address.</span></span>  <span data-ttu-id="3849a-153">此類型允許使用如以下所述的 IP 位址規格。</span><span class="sxs-lookup"><span data-stu-id="3849a-153">This type allows the specification of an IP address as described below.</span></span> <span data-ttu-id="3849a-154">請考慮使用 [無]  類型來阻止封包流向指定目的地。</span><span class="sxs-lookup"><span data-stu-id="3849a-154">Consider using a **None** type to stop packets from flowing to a given destination.</span></span> |
| <span data-ttu-id="3849a-155">下一個躍點位址</span><span class="sxs-lookup"><span data-stu-id="3849a-155">Next hop address</span></span> |<span data-ttu-id="3849a-156">下一個躍點位址包含應該要將封包轉送到哪個 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="3849a-156">The next hop address contains the IP address packets should be forwarded to.</span></span> <span data-ttu-id="3849a-157">只有在下一個躍點類型為虛擬應用裝置 所在的路由中，才允許下一個躍點值。</span><span class="sxs-lookup"><span data-stu-id="3849a-157">Next hop values are only allowed in routes where the next hop type is *Virtual Appliance*.</span></span> |<span data-ttu-id="3849a-158">必須為當中套用使用者定義路由的虛擬網路內可連線的 IP 位址，而不需通過**虛擬網路閘道**。</span><span class="sxs-lookup"><span data-stu-id="3849a-158">Must be an IP address that is reachable within the Virtual Network where the User Defined Route is applied, without going through a **Virtual Network Gateway**.</span></span> <span data-ttu-id="3849a-159">IP 位址必須位於所套用的相同虛擬網路上，或位於對等互連的虛擬網路上。</span><span class="sxs-lookup"><span data-stu-id="3849a-159">The IP address has to be on the same Virtual Network where it is applied, or on a peered Virtual Network.</span></span> |<span data-ttu-id="3849a-160">如果 IP 位址代表 VM，請確定您已在 Azure 中啟用 VM 的 [IP 轉送](#IP-forwarding) 。</span><span class="sxs-lookup"><span data-stu-id="3849a-160">If the IP address represents a VM, make sure you enable [IP forwarding](#IP-forwarding) in Azure for the VM.</span></span> <span data-ttu-id="3849a-161">如果 IP 位址代表 Azure Load Balancer 的內部 IP 位址，請確定您想要負載平衡的每個連接埠都有對應的負載平衡規則。</span><span class="sxs-lookup"><span data-stu-id="3849a-161">If the IP address represents the internal IP address of Azure Load Balancer, make sure you have a matching load balancing rule for each port you wish to load balance.</span></span>|

<span data-ttu-id="3849a-162">在 Azure PowerShell 中，有些 "NextHopType" 值有不同的名稱︰</span><span class="sxs-lookup"><span data-stu-id="3849a-162">In Azure PowerShell some of the "NextHopType" values have different names:</span></span>

* <span data-ttu-id="3849a-163">虛擬網路是 VnetLocal</span><span class="sxs-lookup"><span data-stu-id="3849a-163">Virtual Network is VnetLocal</span></span>
* <span data-ttu-id="3849a-164">虛擬網路閘道是 VirtualNetworkGateway</span><span class="sxs-lookup"><span data-stu-id="3849a-164">Virtual Network Gateway is VirtualNetworkGateway</span></span>
* <span data-ttu-id="3849a-165">虛擬應用裝置是 VirtualAppliance</span><span class="sxs-lookup"><span data-stu-id="3849a-165">Virtual Appliance is VirtualAppliance</span></span>
* <span data-ttu-id="3849a-166">網際網路是 Internet</span><span class="sxs-lookup"><span data-stu-id="3849a-166">Internet is Internet</span></span>
* <span data-ttu-id="3849a-167">無是 None</span><span class="sxs-lookup"><span data-stu-id="3849a-167">None is None</span></span>

### <a name="system-routes"></a><span data-ttu-id="3849a-168">系統路由</span><span class="sxs-lookup"><span data-stu-id="3849a-168">System routes</span></span>
<span data-ttu-id="3849a-169">虛擬網路中建立的每個子網路會自動與包含下列系統路由規則的路由表產生關聯：</span><span class="sxs-lookup"><span data-stu-id="3849a-169">Every subnet created in a virtual network is automatically associated with a route table that contains the following system route rules:</span></span>

* <span data-ttu-id="3849a-170">**本機 VNet 規則**：此規則會自動針對虛擬網路中的每個子網路建立。</span><span class="sxs-lookup"><span data-stu-id="3849a-170">**Local Vnet Rule**: This rule is automatically created for every subnet in a virtual network.</span></span> <span data-ttu-id="3849a-171">它會指定 VNet 中 VM 之間的直接連結，沒有下一個中繼躍點。</span><span class="sxs-lookup"><span data-stu-id="3849a-171">It specifies that there is a direct link between the VMs in the VNet and there is no intermediate next hop.</span></span>
* <span data-ttu-id="3849a-172">**內部部署規則**：此規則適用於目的地為內部部署位址範圍的所有流量，並使用 VPN 閘道作為下一個躍點目的地。</span><span class="sxs-lookup"><span data-stu-id="3849a-172">**On-premises Rule**: This rule applies to all traffic destined to the on-premises address range and uses VPN gateway as the next hop destination.</span></span>
* <span data-ttu-id="3849a-173">**網際網路規則**：此規則處理所有公開網際網路 (位址首碼 0.0.0.0/0) 的流量，並使用基礎結構網際網路閘道做為所有網際網路流量的下一個躍點。</span><span class="sxs-lookup"><span data-stu-id="3849a-173">**Internet Rule**: This rule handles all traffic destined to the public Internet (address prefix 0.0.0.0/0) and uses the infrastructure internet gateway as the next hop for all traffic destined to the Internet.</span></span>

### <a name="user-defined-routes"></a><span data-ttu-id="3849a-174">使用者定義的路由</span><span class="sxs-lookup"><span data-stu-id="3849a-174">User-defined routes</span></span>
<span data-ttu-id="3849a-175">對於大部分的環境，您只需要已經由 Azure 所定義的系統路由。</span><span class="sxs-lookup"><span data-stu-id="3849a-175">For most environments you will only need the system routes already defined by Azure.</span></span> <span data-ttu-id="3849a-176">不過，您可能需要在特定情況下建立路由表，並新增一個或多個路由，例如：</span><span class="sxs-lookup"><span data-stu-id="3849a-176">However, you may need to create a route table and add one or more routes in specific cases, such as:</span></span>

* <span data-ttu-id="3849a-177">透過內部部署網路到網際網路的強制通道。</span><span class="sxs-lookup"><span data-stu-id="3849a-177">Force tunneling to the Internet via your on-premises network.</span></span>
* <span data-ttu-id="3849a-178">在 Azure 環境中使用虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="3849a-178">Use of virtual appliances in your Azure environment.</span></span>

<span data-ttu-id="3849a-179">在上述情況下，您必須建立一個路由表，並將使用者定義的路由新增到該路由表。</span><span class="sxs-lookup"><span data-stu-id="3849a-179">In the scenarios above, you will have to create a route table and add user defined routes to it.</span></span> <span data-ttu-id="3849a-180">您可以擁有多個路由表，而且相同的路由表可以與一個或多個子網路產生關聯。</span><span class="sxs-lookup"><span data-stu-id="3849a-180">You can have multiple route tables, and the same route table can be associated to one or more subnets.</span></span> <span data-ttu-id="3849a-181">此外，每個子網路只能與單一路由資料表產生關聯。</span><span class="sxs-lookup"><span data-stu-id="3849a-181">And each subnet can only be associated to a single route table.</span></span> <span data-ttu-id="3849a-182">子網路中的所有 VM 和雲端服務都使用與該子網路相關聯的路由表。</span><span class="sxs-lookup"><span data-stu-id="3849a-182">All VMs and cloud services in a subnet use the route table associated to that subnet.</span></span>

<span data-ttu-id="3849a-183">子網路會依賴系統路由，直到路由表與子網路產生關聯為止。</span><span class="sxs-lookup"><span data-stu-id="3849a-183">Subnets rely on system routes until a route table is associated to the subnet.</span></span> <span data-ttu-id="3849a-184">一旦關聯存在之後，在使用者定義的路由和系統路由之間，就會根據最長前置詞比對 (LPM) 完成。</span><span class="sxs-lookup"><span data-stu-id="3849a-184">Once an association exists, routing is done based on Longest Prefix Match (LPM) among both user defined routes and system routes.</span></span> <span data-ttu-id="3849a-185">如果有多個符合相同 LPM 的路由，則會根據其來源，以下列順序選取路由：</span><span class="sxs-lookup"><span data-stu-id="3849a-185">If there is more than one route with the same LPM match then a route is selected based on its origin in the following order:</span></span>

1. <span data-ttu-id="3849a-186">使用者定義的路由</span><span class="sxs-lookup"><span data-stu-id="3849a-186">User defined route</span></span>
2. <span data-ttu-id="3849a-187">BGP 路由 (使用 ExpressRoute 時)</span><span class="sxs-lookup"><span data-stu-id="3849a-187">BGP route (when ExpressRoute is used)</span></span>
3. <span data-ttu-id="3849a-188">系統路由</span><span class="sxs-lookup"><span data-stu-id="3849a-188">System route</span></span>

<span data-ttu-id="3849a-189">若要了解如何建立使用者定義的路由，請參閱 [如何在 Azure 中建立路由並啟用 IP 轉送](virtual-network-create-udr-arm-template.md)。</span><span class="sxs-lookup"><span data-stu-id="3849a-189">To learn how to create user defined routes, see [How to Create Routes and Enable IP Forwarding in Azure](virtual-network-create-udr-arm-template.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="3849a-190">使用者定義的路由僅會套用至 Azure VM 和雲端服務。</span><span class="sxs-lookup"><span data-stu-id="3849a-190">User defined routes are only applied to Azure VMs and cloud services.</span></span> <span data-ttu-id="3849a-191">例如，如果您想要在內部部署網路與 Azure 之間新增防火牆虛擬應用裝置，您必須為您的 Azure 路由表建立一個使用者定義的路由，此路由會將前往內部部署位址空間的所有流量轉送到虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="3849a-191">For instance, if you want to add a firewall virtual appliance between your on-premises network and Azure, you will have to create a user defined route for your Azure route tables that forwards all traffic going to the on-premises address space to the virtual appliance.</span></span> <span data-ttu-id="3849a-192">您也可以將使用者定義路由 (UDR) 加入 GatewaySubnet，以透過虛擬應用裝置將所有流量從內部部署轉送到 Azure。</span><span class="sxs-lookup"><span data-stu-id="3849a-192">You can also add a user defined route (UDR) to the GatewaySubnet to forward all traffic from on-premises to Azure through the virtual appliance.</span></span> <span data-ttu-id="3849a-193">這是近期內的新增功能。</span><span class="sxs-lookup"><span data-stu-id="3849a-193">This is a recent addition.</span></span>
> 
> 

### <a name="bgp-routes"></a><span data-ttu-id="3849a-194">BGP 路由</span><span class="sxs-lookup"><span data-stu-id="3849a-194">BGP routes</span></span>
<span data-ttu-id="3849a-195">如果您在內部部署網路與 Azure 之間有 ExpressRoute 連線，可以啟用 BGP，將路由從內部部署網路傳播至 Azure。</span><span class="sxs-lookup"><span data-stu-id="3849a-195">If you have an ExpressRoute connection between your on-premises network and Azure, you can enable BGP to propagate routes from your on-premises network to Azure.</span></span> <span data-ttu-id="3849a-196">這些 BGP 路由的使用方式與系統路由相同，也與每個 Azure 子網路中的使用者定義路由相同。</span><span class="sxs-lookup"><span data-stu-id="3849a-196">These BGP routes are used in the same way as system routes and user defined routes in each Azure subnet.</span></span> <span data-ttu-id="3849a-197">如需詳細資訊，請參閱 [ExpressRoute 簡介](../expressroute/expressroute-introduction.md)。</span><span class="sxs-lookup"><span data-stu-id="3849a-197">For more information see [ExpressRoute Introduction](../expressroute/expressroute-introduction.md).</span></span>

> [!IMPORTANT]
> <span data-ttu-id="3849a-198">您可以設定 Azure 環境透過內部部署網路使用強制通道，方法是，為使用 VPN 閘道做為下一個躍點的子網路 0.0.0.0/0 建立使用者定義的路由。</span><span class="sxs-lookup"><span data-stu-id="3849a-198">You can configure your Azure environment to use force tunneling through your on-premises network by creating a user defined route for subnet 0.0.0.0/0 that uses the VPN gateway as the next hop.</span></span> <span data-ttu-id="3849a-199">不過，這只有在您使用的是 VPN 閘道，而不是 ExpressRoute 時，才有作用。</span><span class="sxs-lookup"><span data-stu-id="3849a-199">However, this only works if you are using a VPN gateway, not ExpressRoute.</span></span> <span data-ttu-id="3849a-200">若是 Expressroute，強制通道是透過 BGP 設定。</span><span class="sxs-lookup"><span data-stu-id="3849a-200">For ExpressRoute, forced tunneling is configured through BGP.</span></span>
> 
> 

## <a name="ip-forwarding"></a><span data-ttu-id="3849a-201">IP 轉送</span><span class="sxs-lookup"><span data-stu-id="3849a-201">IP forwarding</span></span>
<span data-ttu-id="3849a-202">如上所述，建立使用者定義的路由的主要原因之一是將流量轉送到虛擬應用裝置。</span><span class="sxs-lookup"><span data-stu-id="3849a-202">As described above, one of the main reasons to create a user defined route is to forward traffic to a virtual appliance.</span></span> <span data-ttu-id="3849a-203">虛擬應用裝置無非就是一個 VM，可執行用來以某種方式處理網路流量的應用程式，例如防火牆或 NAT 裝置。</span><span class="sxs-lookup"><span data-stu-id="3849a-203">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="3849a-204">此虛擬應用裝置 VM 必須能夠接收未定址到本身的連入流量。</span><span class="sxs-lookup"><span data-stu-id="3849a-204">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="3849a-205">若要讓 VM 接收定址到其他目的地的流量，您必須針對 VM 啟用 IP 轉送。</span><span class="sxs-lookup"><span data-stu-id="3849a-205">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="3849a-206">這是 Azure 設定，不是客體作業系統中的設定。</span><span class="sxs-lookup"><span data-stu-id="3849a-206">This is an Azure setting, not a setting in the guest operating system.</span></span>

## <a name="next-steps"></a><span data-ttu-id="3849a-207">後續步驟</span><span class="sxs-lookup"><span data-stu-id="3849a-207">Next steps</span></span>
* <span data-ttu-id="3849a-208">了解如何 [在資源管理員部署模型中建立路由](virtual-network-create-udr-arm-template.md) 並將其關聯至子網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-208">Learn how to [create routes in the Resource Manager deployment model](virtual-network-create-udr-arm-template.md) and associate them to subnets.</span></span> 
* <span data-ttu-id="3849a-209">了解如何 [在傳統部署模型中建立路由](virtual-network-create-udr-classic-ps.md) 並將其關聯至子網路。</span><span class="sxs-lookup"><span data-stu-id="3849a-209">Learn how to [create routes in the classic deployment model](virtual-network-create-udr-classic-ps.md) and associate them to subnets.</span></span>

