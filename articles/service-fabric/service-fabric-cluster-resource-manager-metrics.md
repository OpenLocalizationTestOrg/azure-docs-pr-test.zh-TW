---
title: "使用計量來管理 Azure 微服務負載 | Microsoft Docs"
description: "了解如何在 Service Fabric 中設定及使用計量，以管理服務資源耗用量。"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 0d622ea6-a7c7-4bef-886b-06e6b85a97fb
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 7e020bb6c02c80127e4225ba695017dff9b5a168
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/18/2017
---
# <a name="managing-resource-consumption-and-load-in-service-fabric-with-metrics"></a><span data-ttu-id="c7cb7-103">在 Service Fabric 中使用度量管理資源耗用量和負載</span><span class="sxs-lookup"><span data-stu-id="c7cb7-103">Managing resource consumption and load in Service Fabric with metrics</span></span>
<span data-ttu-id="c7cb7-104">*計量*是您的服務所關切的資源，且是由叢集中的節點提供。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-104">*Metrics* are the resources that your services care about and which are provided by the nodes in the cluster.</span></span> <span data-ttu-id="c7cb7-105">計量就是任何您想要管理，以便改善或監視服務效能的項目。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-105">A metric is anything that you want to manage in order to improve or monitor the performance of your services.</span></span> <span data-ttu-id="c7cb7-106">例如，您可能會監看記憶體耗用量以得知您的服務是否為多載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-106">For example, you might watch memory consumption to know if your service is overloaded.</span></span> <span data-ttu-id="c7cb7-107">另一個用法是，了解服務是否能夠移至記憶體限制較小的其他位置，以取得更佳的效能。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-107">Another use is to figure out whether the service could move elsewhere where memory is less constrained in order to get better performance.</span></span>

<span data-ttu-id="c7cb7-108">像記憶體、磁碟 及 CPU 使用率等項目都是計量的範例。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-108">Things like Memory, Disk, and CPU usage are examples of metrics.</span></span> <span data-ttu-id="c7cb7-109">這些計量是實體計量，也就是對應至節點上需要管理之實體資源的資源。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-109">These metrics are physical metrics, resources that correspond to physical resources on the node that need to be managed.</span></span> <span data-ttu-id="c7cb7-110">計量也可以是 (且通常是) 邏輯計量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-110">Metrics can also be (and commonly are) logical metrics.</span></span> <span data-ttu-id="c7cb7-111">邏輯計量的範例是 “MyWorkQueueDepth”、"MessagesToProcess" 或 "TotalRecords" 之類的項目。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-111">Logical metrics are things like “MyWorkQueueDepth” or "MessagesToProcess" or "TotalRecords".</span></span> <span data-ttu-id="c7cb7-112">邏輯計量是由應用程式定義，並且間接對應到某些實體資源耗用量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-112">Logical metrics are application-defined and indirectly correspond to some physical resource consumption.</span></span> <span data-ttu-id="c7cb7-113">邏輯計量是常見的，因為很難以每個服務為基礎測量及報告實體資源耗用量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-113">Logical metrics are common because it can be hard to measure and report consumption of physical resources on a per-service basis.</span></span> <span data-ttu-id="c7cb7-114">測量及報告您自己的實體計量有點複雜，這也是為什麼 Service Fabric 會提供一些預設計量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-114">The complexity of measuring and reporting your own physical metrics is also why Service Fabric provides some default metrics.</span></span>

## <a name="default-metrics"></a><span data-ttu-id="c7cb7-115">預設度量</span><span class="sxs-lookup"><span data-stu-id="c7cb7-115">Default metrics</span></span>
<span data-ttu-id="c7cb7-116">假設您想要開始撰寫和部署您的服務。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-116">Let’s say that you want to get started writing and deploying your service.</span></span> <span data-ttu-id="c7cb7-117">此時，您不知道它會取用哪些實體或邏輯資源。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-117">At this point you don’t know what physical or logical resources it consumes.</span></span> <span data-ttu-id="c7cb7-118">沒關係！</span><span class="sxs-lookup"><span data-stu-id="c7cb7-118">That’s fine!</span></span> <span data-ttu-id="c7cb7-119">未指定其他計量時，Service Fabric 叢集資源管理員會使用某些預設計量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-119">The Service Fabric Cluster Resource Manager uses some default metrics when no other metrics are specified.</span></span> <span data-ttu-id="c7cb7-120">如下：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-120">They are:</span></span>

  - <span data-ttu-id="c7cb7-121">PrimaryCount - 節點上主要複本的計數</span><span class="sxs-lookup"><span data-stu-id="c7cb7-121">PrimaryCount - count of Primary replicas on the node</span></span> 
  - <span data-ttu-id="c7cb7-122">ReplicaCount - 節點上具狀態複本的總數</span><span class="sxs-lookup"><span data-stu-id="c7cb7-122">ReplicaCount - count of total stateful replicas on the node</span></span>
  - <span data-ttu-id="c7cb7-123">Count - 節點上所有服務物件 (無狀態和具狀態) 的計數</span><span class="sxs-lookup"><span data-stu-id="c7cb7-123">Count - count of all service objects (stateless and stateful) on the node</span></span>

| <span data-ttu-id="c7cb7-124">計量</span><span class="sxs-lookup"><span data-stu-id="c7cb7-124">Metric</span></span> | <span data-ttu-id="c7cb7-125">無狀態執行個體負載</span><span class="sxs-lookup"><span data-stu-id="c7cb7-125">Stateless Instance Load</span></span> | <span data-ttu-id="c7cb7-126">具狀態次要負載</span><span class="sxs-lookup"><span data-stu-id="c7cb7-126">Stateful Secondary Load</span></span> | <span data-ttu-id="c7cb7-127">具狀態主要負載</span><span class="sxs-lookup"><span data-stu-id="c7cb7-127">Stateful Primary Load</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="c7cb7-128">PrimaryCount</span><span class="sxs-lookup"><span data-stu-id="c7cb7-128">PrimaryCount</span></span> |<span data-ttu-id="c7cb7-129">0</span><span class="sxs-lookup"><span data-stu-id="c7cb7-129">0</span></span> |<span data-ttu-id="c7cb7-130">0</span><span class="sxs-lookup"><span data-stu-id="c7cb7-130">0</span></span> |<span data-ttu-id="c7cb7-131">1</span><span class="sxs-lookup"><span data-stu-id="c7cb7-131">1</span></span> |
| <span data-ttu-id="c7cb7-132">ReplicaCount</span><span class="sxs-lookup"><span data-stu-id="c7cb7-132">ReplicaCount</span></span> |<span data-ttu-id="c7cb7-133">0</span><span class="sxs-lookup"><span data-stu-id="c7cb7-133">0</span></span> |<span data-ttu-id="c7cb7-134">1</span><span class="sxs-lookup"><span data-stu-id="c7cb7-134">1</span></span> |<span data-ttu-id="c7cb7-135">1</span><span class="sxs-lookup"><span data-stu-id="c7cb7-135">1</span></span> |
| <span data-ttu-id="c7cb7-136">Count</span><span class="sxs-lookup"><span data-stu-id="c7cb7-136">Count</span></span> |<span data-ttu-id="c7cb7-137">1</span><span class="sxs-lookup"><span data-stu-id="c7cb7-137">1</span></span> |<span data-ttu-id="c7cb7-138">1</span><span class="sxs-lookup"><span data-stu-id="c7cb7-138">1</span></span> |<span data-ttu-id="c7cb7-139">1</span><span class="sxs-lookup"><span data-stu-id="c7cb7-139">1</span></span> |

<span data-ttu-id="c7cb7-140">針對基本工作負載，預設計量會提供叢集中工作的適當分配。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-140">For basic workloads, the default metrics provide a decent distribution of work in the cluster.</span></span> <span data-ttu-id="c7cb7-141">在下列範例中，讓我們看看建立兩個服務以及依賴預設計量以進行平衡時會發生什麼情況。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-141">In the following example, let’s see what happens when we create two services and rely on the default metrics for balancing.</span></span> <span data-ttu-id="c7cb7-142">第一個服務是帶有三個資料分割且目標複本集大小為三的具狀態服務。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-142">The first service is a stateful service with three partitions and a target replica set size of three.</span></span> <span data-ttu-id="c7cb7-143">第二個服務是帶有一個資料分割且執行個體計數為三的無狀態服務。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-143">The second service is a stateless service with one partition and an instance count of three.</span></span>

<span data-ttu-id="c7cb7-144">以下是您將看到的情況：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-144">Here's what you get:</span></span>

<span data-ttu-id="c7cb7-145"><center>
![使用預設計量的叢集配置][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="c7cb7-145"><center>
![Cluster Layout with Default Metrics][Image1]
</center></span></span>

<span data-ttu-id="c7cb7-146">注意事項：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-146">Some things to note:</span></span>
  - <span data-ttu-id="c7cb7-147">具狀態服務的主要複本會分散到數個節點</span><span class="sxs-lookup"><span data-stu-id="c7cb7-147">Primary replicas for the stateful service are distributed across several nodes</span></span>
  - <span data-ttu-id="c7cb7-148">相同資料分割的複本是在不同節點上</span><span class="sxs-lookup"><span data-stu-id="c7cb7-148">Replicas for the same partition are on different nodes</span></span>
  - <span data-ttu-id="c7cb7-149">主要複本與次要複本的總數分佈在叢集中</span><span class="sxs-lookup"><span data-stu-id="c7cb7-149">The total number of primaries and secondaries is distributed in the cluster</span></span>
  - <span data-ttu-id="c7cb7-150">服務物件的總數平均配置於每個節點</span><span class="sxs-lookup"><span data-stu-id="c7cb7-150">The total number of service objects are evenly allocated on each node</span></span>

<span data-ttu-id="c7cb7-151">很好！</span><span class="sxs-lookup"><span data-stu-id="c7cb7-151">Good!</span></span>

<span data-ttu-id="c7cb7-152">預設計量是個很好的起點。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-152">The default metrics work great as a start.</span></span> <span data-ttu-id="c7cb7-153">不過，預設計量只能做到這個程度。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-153">However, the default metrics will only carry you so far.</span></span> <span data-ttu-id="c7cb7-154">例如︰您選擇的資料分割配置導致所有資料分割完全平均使用的可能性為何？</span><span class="sxs-lookup"><span data-stu-id="c7cb7-154">For example: What's the likelihood that the partitioning scheme you picked results in perfectly even utilization by all partitions?</span></span> <span data-ttu-id="c7cb7-155">所指定服務的負載在一段時間內保持不變或只是現在跨多個資料分割相同的機率為何？</span><span class="sxs-lookup"><span data-stu-id="c7cb7-155">What’s the chance that the load for a given service is constant over time, or even just the same across multiple partitions right now?</span></span>

<span data-ttu-id="c7cb7-156">您可以僅使用預設計量來執行。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-156">You could run with just the default metrics.</span></span> <span data-ttu-id="c7cb7-157">不過，這樣通常表示叢集使用率較低，比您想要的更不平均。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-157">However, doing so usually means that your cluster utilization is lower and more uneven than you’d like.</span></span> <span data-ttu-id="c7cb7-158">這是因為預設計量不是調適性的，而是假設所有項目都相等。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-158">This is because the default metrics aren't adaptive and presume everything is equivalent.</span></span> <span data-ttu-id="c7cb7-159">例如，忙碌的主要複本和一個不忙碌的其他複本都會對 PrimaryCount 計量貢獻 "1"。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-159">For example, a Primary that is busy and one that is not both contribute "1" to the PrimaryCount metric.</span></span> <span data-ttu-id="c7cb7-160">在最糟的情況下，使用預設計量也可能導致節點被過度排定，而造成效能問題。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-160">In the worst case, using only the default metrics can also result in overscheduled nodes resulting in performance issues.</span></span> <span data-ttu-id="c7cb7-161">如果您對充分利用叢集並避免效能問題感興趣，您必須使用自訂計量和動態負載報告。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-161">If you're interested in getting the most out of your cluster and avoiding performance issues, you need to use custom metrics and dynamic load reporting.</span></span>

## <a name="custom-metrics"></a><span data-ttu-id="c7cb7-162">自訂度量</span><span class="sxs-lookup"><span data-stu-id="c7cb7-162">Custom metrics</span></span>
<span data-ttu-id="c7cb7-163">當您建立服務時，可以為每個具名服務執行個體設定計量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-163">Metrics are configured on a per-named-service-instance basis when you’re creating the service.</span></span>

<span data-ttu-id="c7cb7-164">任何計量都有一些描述它的屬性：名稱、權數及預設負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-164">Any metric has some properties that describe it: a name, a weight, and a default load.</span></span>

* <span data-ttu-id="c7cb7-165">計量名稱：計量的名稱。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-165">Metric Name: The name of the metric.</span></span> <span data-ttu-id="c7cb7-166">從「資源管理員」的觀點來看，計量名稱是叢集內計量的唯一識別碼。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-166">The metric name is a unique identifier for the metric within the cluster from the Resource Manager’s perspective.</span></span>
* <span data-ttu-id="c7cb7-167">Weight︰計量權數定義了就此服務而言，此計量相對於其他計量的重要程度。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-167">Weight: Metric weight defines how important this metric is relative to the other metrics for this service.</span></span>
* <span data-ttu-id="c7cb7-168">預設負載：預設負載會依據服務是無狀態或具狀態服務來以不同方式表示。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-168">Default Load: The default load is represented differently depending on whether the service is stateless or stateful.</span></span>
  * <span data-ttu-id="c7cb7-169">就無狀態服務而言，每個計量都有名為 DefaultLoad 的單一屬性</span><span class="sxs-lookup"><span data-stu-id="c7cb7-169">For stateless services, each metric has a single property named DefaultLoad</span></span>
  * <span data-ttu-id="c7cb7-170">針對具狀態服務，您需定義：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-170">For stateful services you define:</span></span>
    * <span data-ttu-id="c7cb7-171">PrimaryDefaultLoad：當此計量作為「主要」複本時，此服務將取用的預設量</span><span class="sxs-lookup"><span data-stu-id="c7cb7-171">PrimaryDefaultLoad: The default amount of this metric this service consumes when it is a Primary</span></span>
    * <span data-ttu-id="c7cb7-172">SecondaryDefaultLoad：當此計量作為「次要」複本時，此服務將取用的預設量</span><span class="sxs-lookup"><span data-stu-id="c7cb7-172">SecondaryDefaultLoad: The default amount of this metric this service consumes when it is a Secondary</span></span>

> [!NOTE]
> <span data-ttu-id="c7cb7-173">如果您定義自訂計量並_同時_也想要使用預設計量，您必須_明確地_加回預設計量並且定義它們的權數和值。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-173">If you define custom metrics and you want to _also_ use the default metrics, you need to _explicitly_ add the default metrics back and define weights and values for them.</span></span> <span data-ttu-id="c7cb7-174">這是因為您必須定義預設計量與自訂計量之間的關聯性。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-174">This is because you must define the relationship between the default metrics and your custom metrics.</span></span> <span data-ttu-id="c7cb7-175">例如，也許您會在意 ConnectionCount 或 WorkQueueDepth 更甚於主要分配。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-175">For example, maybe you care about ConnectionCount or WorkQueueDepth more than Primary distribution.</span></span> <span data-ttu-id="c7cb7-176">根據預設，PrimaryCount 計量的權數是「高」，所以當您新增其他計量時想要將它降低為「中」，以確保它們優先。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-176">By default the weight of the PrimaryCount metric is High, so you want to reduce it to Medium when you add your other metrics to ensure they take precedence.</span></span>
>

### <a name="defining-metrics-for-your-service---an-example"></a><span data-ttu-id="c7cb7-177">為您的服務定義計量 - 範例</span><span class="sxs-lookup"><span data-stu-id="c7cb7-177">Defining metrics for your service - an example</span></span>
<span data-ttu-id="c7cb7-178">假設您想要下列設定：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-178">Let’s say you want the following configuration:</span></span>

  - <span data-ttu-id="c7cb7-179">您的服務報告名為 "ConnectionCount” 的計量</span><span class="sxs-lookup"><span data-stu-id="c7cb7-179">Your service reports a metric named "ConnectionCount”</span></span>
  - <span data-ttu-id="c7cb7-180">您也想要使用預設計量</span><span class="sxs-lookup"><span data-stu-id="c7cb7-180">You also want to use the default metrics</span></span> 
  - <span data-ttu-id="c7cb7-181">您已經完成一些測量，而知道該服務的主要複本通常佔用 20 單位的 "ConnectionCount"。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-181">You’ve done some measurements and know that normally a Primary replica of that service takes up 20 units of "ConnectionCount"</span></span>
  - <span data-ttu-id="c7cb7-182">而次要複本則佔用 5 單位的 "ConnectionCount"</span><span class="sxs-lookup"><span data-stu-id="c7cb7-182">Secondaries use 5 units of "ConnectionCount"</span></span>
  - <span data-ttu-id="c7cb7-183">您知道就管理這項特定服務的效能而言，"ConnectionCount" 是最重要的計量</span><span class="sxs-lookup"><span data-stu-id="c7cb7-183">You know that "ConnectionCount" is the most important metric in terms of managing the performance of this particular service</span></span>
  - <span data-ttu-id="c7cb7-184">但您仍然希望主要複本達到平衡。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-184">You still want Primary replicas balanced.</span></span> <span data-ttu-id="c7cb7-185">無論如何，平衡主要複本通常是個不錯的主意。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-185">Balancing primary replicas is generally a good idea no matter what.</span></span> <span data-ttu-id="c7cb7-186">這有助於防止遺失某些節點或容錯網域而影響它隨附的大多數主要複本。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-186">This helps prevent the loss of some node or fault domain from impacting a majority of primary replicas along with it.</span></span> 
  - <span data-ttu-id="c7cb7-187">否則，預設計量是好的</span><span class="sxs-lookup"><span data-stu-id="c7cb7-187">Otherwise, the default metrics are fine</span></span>

<span data-ttu-id="c7cb7-188">以下是您以該計量組態建立服務時將撰寫的程式碼：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-188">Here’s the code that you would write to create a service with that metric configuration:</span></span>

<span data-ttu-id="c7cb7-189">程式碼：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-189">Code:</span></span>

```csharp
StatefulServiceDescription serviceDescription = new StatefulServiceDescription();
StatefulServiceLoadMetricDescription connectionMetric = new StatefulServiceLoadMetricDescription();
connectionMetric.Name = "ConnectionCount";
connectionMetric.PrimaryDefaultLoad = 20;
connectionMetric.SecondaryDefaultLoad = 5;
connectionMetric.Weight = ServiceLoadMetricWeight.High;

StatefulServiceLoadMetricDescription primaryCountMetric = new StatefulServiceLoadMetricDescription();
primaryCountMetric.Name = "PrimaryCount";
primaryCountMetric.PrimaryDefaultLoad = 1;
primaryCountMetric.SecondaryDefaultLoad = 0;
primaryCountMetric.Weight = ServiceLoadMetricWeight.Medium;

StatefulServiceLoadMetricDescription replicaCountMetric = new StatefulServiceLoadMetricDescription();
replicaCountMetric.Name = "ReplicaCount";
replicaCountMetric.PrimaryDefaultLoad = 1;
replicaCountMetric.SecondaryDefaultLoad = 1;
replicaCountMetric.Weight = ServiceLoadMetricWeight.Low;

StatefulServiceLoadMetricDescription totalCountMetric = new StatefulServiceLoadMetricDescription();
totalCountMetric.Name = "Count";
totalCountMetric.PrimaryDefaultLoad = 1;
totalCountMetric.SecondaryDefaultLoad = 1;
totalCountMetric.Weight = ServiceLoadMetricWeight.Low;

serviceDescription.Metrics.Add(connectionMetric);
serviceDescription.Metrics.Add(primaryCountMetric);
serviceDescription.Metrics.Add(replicaCountMetric);
serviceDescription.Metrics.Add(totalCountMetric);

await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

<span data-ttu-id="c7cb7-190">PowerShell：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-190">Powershell:</span></span>

```posh
New-ServiceFabricService -ApplicationName $applicationName -ServiceName $serviceName -ServiceTypeName $serviceTypeName –Stateful -MinReplicaSetSize 3 -TargetReplicaSetSize 3 -PartitionSchemeSingleton –Metric @("ConnectionCount,High,20,5”,"PrimaryCount,Medium,1,0”,"ReplicaCount,Low,1,1”,"Count,Low,1,1”)
```

> [!NOTE]
> <span data-ttu-id="c7cb7-191">上述範例與本文件的其餘部分描述以每個具名服務為基礎來管理計量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-191">The above examples and the rest of this document describe managing metrics on a per-named-service basis.</span></span> <span data-ttu-id="c7cb7-192">也可以在服務_類型_層級定義您的服務計量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-192">It is also possible to define metrics for your services at the service _type_ level.</span></span> <span data-ttu-id="c7cb7-193">這會透過在您的服務資訊清單中指定它們來完成。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-193">This is accomplished by specifying them in your service manifests.</span></span> <span data-ttu-id="c7cb7-194">不建議定義類型層級度量有幾個原因。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-194">Defining type level metrics is not recommended for several reasons.</span></span> <span data-ttu-id="c7cb7-195">第一個原因是，計量名稱經常是環境特定的。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-195">The first reason is that metric names are frequently environment-specific.</span></span> <span data-ttu-id="c7cb7-196">除非有確實的就地合約，否則您無法確定一個環境中的計量 "Cores" 不是其他環境中的 "MiliCores" 或 "CoReS"。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-196">Unless there is a firm contract in place, you cannot be sure that the metric "Cores" in one environment isn't "MiliCores" or "CoReS" in others.</span></span> <span data-ttu-id="c7cb7-197">如果您的計量在資訊清單中定義，您必須為每個環境建立資訊清單。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-197">If your metrics are defined in your manifest you need to create new manifests per environment.</span></span> <span data-ttu-id="c7cb7-198">這通常會導致只有些許差異的不同資訊清單擴散，進而造成管理困難。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-198">This usually leads to a proliferation of different manifests with only minor differences, which can lead to management difficulties.</span></span>  
>
> <span data-ttu-id="c7cb7-199">計量負載通常會為每個具名服務執行個體指派。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-199">Metric loads are commonly assigned on a per-named-service-instance basis.</span></span> <span data-ttu-id="c7cb7-200">例如，假設您為 CustomerA 建立一個服務執行個體，該客戶計劃只會輕度使用。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-200">For example, let's say you create one instance of the service for CustomerA who plans to use it only lightly.</span></span> <span data-ttu-id="c7cb7-201">同時假設您為 CustomerB 建立另一個執行個體，該客戶有更大的工作負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-201">Let's also say you create another for CustomerB who has a larger workload.</span></span> <span data-ttu-id="c7cb7-202">在此情況下，您可能會想要調整這些服務的預設負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-202">In this case, you'd probably want to tweak the default loads for those services.</span></span> <span data-ttu-id="c7cb7-203">如果您有透過資訊清單定義的計量和負載，並且想要支援此案例，則對於每個客戶需要不同的應用程式和服務類型。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-203">If you have metrics and loads defined via manifests and you want to support this scenario, it requires different application and service types for each customer.</span></span> <span data-ttu-id="c7cb7-204">在服務建立時定義的值會覆寫資訊清單中定義的值，因此您可以用來設定特定預設值。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-204">The values defined at service creation time override those defined in the manifest, so you could use that to set the specific defaults.</span></span> <span data-ttu-id="c7cb7-205">不過，這麼做會使資訊清單中宣告的值不符合服務實際執行的值。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-205">However, doing that causes the values declared in the manifests to not match those the service actually runs with.</span></span> <span data-ttu-id="c7cb7-206">這會導致混淆。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-206">This can lead to confusion.</span></span> 
>

<span data-ttu-id="c7cb7-207">提醒您，如果您只想要使用預設計量，您就完全不必碰觸計量集合，或在建立服務時執行任何特殊動作。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-207">As a reminder: if you just want to use the default metrics, you don’t need to touch the metrics collection at all or do anything special when creating your service.</span></span> <span data-ttu-id="c7cb7-208">未定義其他計量時，會自動使用預設計量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-208">The default metrics get used automatically when no others are defined.</span></span> 

<span data-ttu-id="c7cb7-209">現在，我們再更詳細地瀏覽這些設定，並且討論其影響的行為。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-209">Now, let's go through each of these settings in more detail and talk about the behavior that it influences.</span></span>

## <a name="load"></a><span data-ttu-id="c7cb7-210">載入</span><span class="sxs-lookup"><span data-stu-id="c7cb7-210">Load</span></span>
<span data-ttu-id="c7cb7-211">定義計量的整個重點在於代表某個負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-211">The whole point of defining metrics is to represent some load.</span></span> <span data-ttu-id="c7cb7-212">「負載」係指特定節點上的某個服務執行個體或複本取用的特定計量數量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-212">*Load* is how much of a given metric is consumed by some service instance or replica on a given node.</span></span> <span data-ttu-id="c7cb7-213">隨時可以設定負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-213">Load can be configured at almost any point.</span></span> <span data-ttu-id="c7cb7-214">例如：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-214">For example:</span></span>

  - <span data-ttu-id="c7cb7-215">建立服務時，可以定義負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-215">Load can be defined when a service is created.</span></span> <span data-ttu-id="c7cb7-216">這稱為_預設負載_。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-216">This is called _default load_.</span></span>
  - <span data-ttu-id="c7cb7-217">計量資訊，包括建立服務之後服務可以更新的預設負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-217">The metric information, including default loads, for a service can updated after the service is created.</span></span> <span data-ttu-id="c7cb7-218">這稱為_更新服務_。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-218">This is called _updating a service_.</span></span> 
  - <span data-ttu-id="c7cb7-219">指定資料分割的負載可以重設為該服務的預設值。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-219">The loads for a given partition can be reset to the default values for that service.</span></span> <span data-ttu-id="c7cb7-220">這稱為_重設資料分割負載_。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-220">This is called _resetting partition load_.</span></span>
  - <span data-ttu-id="c7cb7-221">負載可以每個服務物件為基礎，在執行階段以動態方式報告。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-221">Load can be reported on a per service object basis dynamically during runtime.</span></span> <span data-ttu-id="c7cb7-222">這稱為_報告負載_。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-222">This is called _reporting load_.</span></span> 
  
<span data-ttu-id="c7cb7-223">這些策略全部可以在相同服務的存留期內使用。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-223">All of these strategies can be used within the same service over its lifetime.</span></span> 

## <a name="default-load"></a><span data-ttu-id="c7cb7-224">預設負載</span><span class="sxs-lookup"><span data-stu-id="c7cb7-224">Default load</span></span>
<span data-ttu-id="c7cb7-225">預設負載係指此服務的每個服務物件 (無狀態執行個體或具狀態複本) 取用的計量數量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-225">*Default load* is how much of the metric each service object (stateless instance or stateful replica) of this service consumes.</span></span> <span data-ttu-id="c7cb7-226">叢集資源管理員會將這個數字用於服務物件的負載，直到它接收其他資訊，例如動態負載報告。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-226">The Cluster Resource Manager uses this number for the load of the service object until it receives other information, such as a dynamic load report.</span></span> <span data-ttu-id="c7cb7-227">針對簡單服務，預設負載是靜態定義。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-227">For simpler services, the default load is a static definition.</span></span> <span data-ttu-id="c7cb7-228">預設負載永遠不會更新，並且在服務的存留期使用。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-228">The default load is never updated and is used for the lifetime of the service.</span></span> <span data-ttu-id="c7cb7-229">預設負載非常適用於簡單的容量規劃案例，其中特定數量的資源是供不同的工作負載專用，不會變更。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-229">Default loads works great for simple capacity planning scenarios where certain amounts of resources are dedicated to different workloads and do not change.</span></span>

> [!NOTE]
> <span data-ttu-id="c7cb7-230">如需有關容量管理和定義叢集中節點容量的詳細資訊，請參閱[這篇文章](service-fabric-cluster-resource-manager-cluster-description.md#capacity)。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-230">For more information on capacity management and defining capacities for the nodes in your cluster, please see [this article](service-fabric-cluster-resource-manager-cluster-description.md#capacity).</span></span>
> 

<span data-ttu-id="c7cb7-231">「叢集資源管理員」允許具狀態服務為其「主要」複本和「次要」複本指定不同的預設負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-231">The Cluster Resource Manager allows stateful services to specify a different default load for their Primaries and Secondaries.</span></span> <span data-ttu-id="c7cb7-232">而無狀態服務則只能指定一個值，套用至所有執行個體。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-232">Stateless services can only specify one value that applies to all instances.</span></span> <span data-ttu-id="c7cb7-233">就具狀態服務而言，主要和次要複本的預設負載通常不同，因為複本在每個角色中是執行不同類型的工作。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-233">For stateful services, the default load for Primary and Secondary replicas are typically different since replicas do different kinds of work in each role.</span></span> <span data-ttu-id="c7cb7-234">例如，主要複本通常會同時為讀取和寫入 (以及大多數運算負擔) 提供服務，而次要複本則不會。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-234">For example, Primaries usually serve both reads and writes, and handle most of the computational burden, while secondaries do not.</span></span> <span data-ttu-id="c7cb7-235">主要複本的預設負載通常高於次要複本的預設負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-235">Usually the default load for a primary replica is higher than the default load for secondary replicas.</span></span> <span data-ttu-id="c7cb7-236">實際數字應該取決於您自己的測量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-236">The real numbers should depend on your own measurements.</span></span>

## <a name="dynamic-load"></a><span data-ttu-id="c7cb7-237">動態負載</span><span class="sxs-lookup"><span data-stu-id="c7cb7-237">Dynamic load</span></span>
<span data-ttu-id="c7cb7-238">假設您已經執行服務達一段時間。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-238">Let’s say that you’ve been running your service for a while.</span></span> <span data-ttu-id="c7cb7-239">藉由一些監視，您已注意到：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-239">With some monitoring, you’ve noticed that:</span></span>

1. <span data-ttu-id="c7cb7-240">所指定服務的某些資料分割或執行個體比其他資料分割或執行個體耗用更多資源</span><span class="sxs-lookup"><span data-stu-id="c7cb7-240">Some partitions or instances of a given service consume more resources than others</span></span>
2. <span data-ttu-id="c7cb7-241">某些服務的負載會隨著時間改變。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-241">Some services have load that varies over time.</span></span>

<span data-ttu-id="c7cb7-242">有很多原因可能造成這些類型的負載變動。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-242">There's lots of things that could cause these types of load fluctuations.</span></span> <span data-ttu-id="c7cb7-243">例如，不同的服務或資料分割會與具有不同需求的不同客戶相關聯。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-243">For example, different services or partitions are associated with different customers with different requirements.</span></span> <span data-ttu-id="c7cb7-244">由於服務的工作量會隨著一天的行程而異，所以也可以變更負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-244">Load could also change because the amount of work the service does varies over the course of the day.</span></span> <span data-ttu-id="c7cb7-245">不論是哪種原因，通常沒有任何單一數字可供您用來作為預設值。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-245">Regardless of the reason, there’s usually no single number that you can use for default.</span></span> <span data-ttu-id="c7cb7-246">如果您想要最大限度的利用叢集，更是如此。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-246">This is especially true if you want to get the most utilization out of the cluster.</span></span> <span data-ttu-id="c7cb7-247">您為預設負載挑選的任何值有時都會出錯。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-247">Any value you pick for default load is wrong some of the time.</span></span> <span data-ttu-id="c7cb7-248">不正確的預設負載會導致「叢集資源管理員」配置的資源不是太多就是不足。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-248">Incorrect default loads result in the Cluster Resource Manager either over or under allocating resources.</span></span> <span data-ttu-id="c7cb7-249">結果就是即使「叢集資源管理員」認為叢集已達平衡狀態，但您的節點卻有使用率太高或太低的情況。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-249">As a result, you have nodes that are over or under utilized even though the Cluster Resource Manager thinks the cluster is balanced.</span></span> <span data-ttu-id="c7cb7-250">由於預設負載提供初始放置的某些資訊，因此它們仍有其實用性，但是它們並無法反映實際工作負載的完整面貌。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-250">Default loads are still good since they provide some information for initial placement, but they're not a complete story for real workloads.</span></span> <span data-ttu-id="c7cb7-251">為了準確地擷取變動的資源需求，「叢集資源管理員」允許每個服務物件在執行階段期間更新自己的負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-251">To accurately capture changing resource requirements, the Cluster Resource Manager allows each service object to update its own load during runtime.</span></span> <span data-ttu-id="c7cb7-252">這稱為動態負載報告功能。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-252">This is called dynamic load reporting.</span></span>

<span data-ttu-id="c7cb7-253">動態負載報告可讓複本或執行個體在其存留期中調整其配置/回報的計量負載。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-253">Dynamic load reports allow replicas or instances to adjust their allocation/reported load of metrics over their lifetime.</span></span> <span data-ttu-id="c7cb7-254">閒置且未執行任何工作的服務複本或執行個體通常會回報使用少量的指定計量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-254">A service replica or instance that was cold and not doing any work would usually report that it was using low amounts of a given metric.</span></span> <span data-ttu-id="c7cb7-255">忙碌的複本或執行個體則會回報使用較多的資源。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-255">A busy replica or instance would report that they are using more.</span></span>

<span data-ttu-id="c7cb7-256">依據每一複本或執行個體報告負載可讓「叢集資源管理員」重新組織叢集內的個別服務物件。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-256">Reporting load per replica or instance allows the Cluster Resource Manager to reorganize the individual service objects in the cluster.</span></span> <span data-ttu-id="c7cb7-257">重新組織服務可協助確保它們取得所需的資源。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-257">Reorganizing the services helps ensure that they get the resources they require.</span></span> <span data-ttu-id="c7cb7-258">忙碌的服務可有效地從其他閒置或執行較少工作的複本或執行個體「回收」資源。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-258">Busy services effectively get to "reclaim" resources from other replicas or instances that are currently cold or doing less work.</span></span>

<span data-ttu-id="c7cb7-259">在「可靠服務」中，動態報告負載的程式碼看起來會像這樣：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-259">Within Reliable Services, the code to report load dynamically looks like this:</span></span>

<span data-ttu-id="c7cb7-260">程式碼：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-260">Code:</span></span>

```csharp
this.Partition.ReportLoad(new List<LoadMetric> { new LoadMetric("CurrentConnectionCount", 1234), new LoadMetric("metric1", 42) });
```

<span data-ttu-id="c7cb7-261">服務可以報告在建立時為它定義的任何計量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-261">A service can report on any of the metrics defined for it at creation time.</span></span> <span data-ttu-id="c7cb7-262">如果服務報告的計量負載並非設定為使用，Service Fabric 會忽略該報告。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-262">If a service reports load for a metric that it is not configured to use, Service Fabric ignores that report.</span></span> <span data-ttu-id="c7cb7-263">如果相同時間有其他報告的有效計量，系統就會接受這些報告。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-263">If there are other metrics reported at the same time that are valid, those reports are accepted.</span></span> <span data-ttu-id="c7cb7-264">服務程式碼可以測量並報告它知道的所有計量，而操作員則可以指定要使用的的計量設定，而不需變更服務程式碼。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-264">Service code can measure and report all the metrics it knows how to, and operators can specify the metric configuration to use without having to change the service code.</span></span> 

### <a name="updating-a-services-metric-configuration"></a><span data-ttu-id="c7cb7-265">更新服務的計量設定</span><span class="sxs-lookup"><span data-stu-id="c7cb7-265">Updating a service's metric configuration</span></span>
<span data-ttu-id="c7cb7-266">與服務相關聯的計量清單和這些計量的屬性，可以在服務存留時動態地更新。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-266">The list of metrics associated with the service, and the properties of those metrics can be updated dynamically while the service is live.</span></span> <span data-ttu-id="c7cb7-267">這樣可以進行實驗並具有彈性。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-267">This allows for experimentation and flexibility.</span></span> <span data-ttu-id="c7cb7-268">非常有用的某些範例為：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-268">Some examples of when this is useful are:</span></span>

  - <span data-ttu-id="c7cb7-269">針對特定服務停用具有錯誤報告的計量</span><span class="sxs-lookup"><span data-stu-id="c7cb7-269">disabling a metric with a buggy report for a particular service</span></span>
  - <span data-ttu-id="c7cb7-270">根據想要的行為重新設定計量的權數</span><span class="sxs-lookup"><span data-stu-id="c7cb7-270">reconfiguring the weights of metrics based on desired behavior</span></span>
  - <span data-ttu-id="c7cb7-271">只有在程式碼已經部署並透過其他機制進行驗證之後，才啟用新的計量</span><span class="sxs-lookup"><span data-stu-id="c7cb7-271">enabling a new metric only after the code has already been deployed and validated via other mechanisms</span></span>
  - <span data-ttu-id="c7cb7-272">根據觀察到的行為和耗用量變更服務的預設負載</span><span class="sxs-lookup"><span data-stu-id="c7cb7-272">changing the default load for a service based on observed behavior and consumption</span></span>

<span data-ttu-id="c7cb7-273">變更計量設定的主要 API 在 C# 中是 `FabricClient.ServiceManagementClient.UpdateServiceAsync`，在 PowerShell 中是 `Update-ServiceFabricService`。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-273">The main APIs for changing metric configuration are `FabricClient.ServiceManagementClient.UpdateServiceAsync` in C# and `Update-ServiceFabricService` in PowerShell.</span></span> <span data-ttu-id="c7cb7-274">您使用這些 API 指定的任何資訊都會立即取代服務的現有計量資訊。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-274">Whatever information you specify with these APIs replaces the existing metric information for the service immediately.</span></span> 

## <a name="mixing-default-load-values-and-dynamic-load-reports"></a><span data-ttu-id="c7cb7-275">混用預設負載值和動態負載報告</span><span class="sxs-lookup"><span data-stu-id="c7cb7-275">Mixing default load values and dynamic load reports</span></span>
<span data-ttu-id="c7cb7-276">預設負載和動態負載可以用於相同的服務。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-276">Default load and dynamic loads can be used for the same service.</span></span> <span data-ttu-id="c7cb7-277">當服務利用預設負載和動態負載報告時，預設負載會作為預估值，直到動態報告出現為止。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-277">When a service utilizes both default load and dynamic load reports, default load serves as an estimate until dynamic reports show up.</span></span> <span data-ttu-id="c7cb7-278">預設負載相當好，因為它提供一些可供「叢集資源管理員」使用的資訊。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-278">Default load is good because it gives the Cluster Resource Manager something to work with.</span></span> <span data-ttu-id="c7cb7-279">預設負載可讓「叢集資源管理員」在建立服務物件時，就將它們放在適當的位置。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-279">The default load allows the Cluster Resource Manager to place the service objects in good locations when they are created.</span></span> <span data-ttu-id="c7cb7-280">如果未提供任何預設負載資訊，就會以隨機方式有效率地放置服務。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-280">If no default load information is provided, placement of services is effectively random.</span></span> <span data-ttu-id="c7cb7-281">當負載報告較晚到達時，初始隨機放置經常錯誤，叢集資源管理員必須移動服務。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-281">When load reports arrive later the initial random placement is often wrong and the Cluster Resource Manager has to move services.</span></span>

<span data-ttu-id="c7cb7-282">讓我們採用先前的範例，看看當我們加入一些自訂負載和動態負載報告功能時會發生什麼狀況。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-282">Let’s take our previous example and see what happens when we add some custom metrics and dynamic load reporting.</span></span> <span data-ttu-id="c7cb7-283">在此範例中，我們使用 “MemoryInMb” 作為範例計量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-283">In this example, we use “MemoryInMb” as an example metric.</span></span>

> [!NOTE]
> <span data-ttu-id="c7cb7-284">記憶體是 Service Fabric 可以進行[資源管理](service-fabric-resource-governance.md)的其中一個系統計量，您自行報告通常有難度。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-284">Memory is one of the system metrics that Service Fabric can [resource govern](service-fabric-resource-governance.md), and reporting it yourself is typically difficult.</span></span> <span data-ttu-id="c7cb7-285">實際上我們不期待您報告記憶體耗用量。在這裡使用記憶體是協助了解叢集資源管理員的功能。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-285">We don't actually expect you to report on Memory consumption; Memory is used here as an aid to learning about the capabilities of the Cluster Resource Manager.</span></span>
>

<span data-ttu-id="c7cb7-286">讓我們假設一開始使用下列命令建立了具狀態服務︰</span><span class="sxs-lookup"><span data-stu-id="c7cb7-286">Let’s presume that we initially created the stateful service with the following command:</span></span>

<span data-ttu-id="c7cb7-287">PowerShell：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-287">Powershell:</span></span>

```posh
New-ServiceFabricService -ApplicationName $applicationName -ServiceName $serviceName -ServiceTypeName $serviceTypeName –Stateful -MinReplicaSetSize 3 -TargetReplicaSetSize 3 -PartitionSchemeSingleton –Metric @("MemoryInMb,High,21,11”,"PrimaryCount,Medium,1,0”,"ReplicaCount,Low,1,1”,"Count,Low,1,1”)
```

<span data-ttu-id="c7cb7-288">提醒您，此語法是 ("MetricName, MetricWeight, PrimaryDefaultLoad, SecondaryDefaultLoad")。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-288">As a reminder, this syntax is ("MetricName, MetricWeight, PrimaryDefaultLoad, SecondaryDefaultLoad").</span></span>

<span data-ttu-id="c7cb7-289">讓我們看看可能的叢集配置看起來如何︰</span><span class="sxs-lookup"><span data-stu-id="c7cb7-289">Let's see what one possible cluster layout could look like:</span></span>

<span data-ttu-id="c7cb7-290"><center>
![使用預設和自訂計量平衡的叢集][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="c7cb7-290"><center>
![Cluster Balanced with both Default and Custom metrics][Image2]
</center></span></span>

<span data-ttu-id="c7cb7-291">有幾件事值得一提：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-291">Some things that are worth noting:</span></span>

* <span data-ttu-id="c7cb7-292">資料分割內的次要複本可以有自己的負載</span><span class="sxs-lookup"><span data-stu-id="c7cb7-292">Secondary replicas within a partition can each have their own load</span></span>
* <span data-ttu-id="c7cb7-293">整體計量看起來已達平衡。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-293">Overall the metrics look balanced.</span></span> <span data-ttu-id="c7cb7-294">就記憶體而言，最大和最小負載之間的比例為 1.75 (負載最高的節點是 N3，最低的是 N2，而 28/16 = 1.75)。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-294">For Memory, the ratio between the maximum and minimum load is 1.75 (the node with the most load is N3, the least is N2, and 28/16 = 1.75).</span></span>

<span data-ttu-id="c7cb7-295">還有一些我們仍需說明的事項：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-295">There are some things that we still need to explain:</span></span>

* <span data-ttu-id="c7cb7-296">何者決定 1.75 的比率是否合理？</span><span class="sxs-lookup"><span data-stu-id="c7cb7-296">What determined whether a ratio of 1.75 was reasonable or not?</span></span> <span data-ttu-id="c7cb7-297">「叢集資源管理員」如何知道已經做得夠好還是有待加強？</span><span class="sxs-lookup"><span data-stu-id="c7cb7-297">How does the Cluster Resource Manager know if that’s good enough or if there is more work to do?</span></span>
* <span data-ttu-id="c7cb7-298">何時發生平衡？</span><span class="sxs-lookup"><span data-stu-id="c7cb7-298">When does balancing happen?</span></span>
* <span data-ttu-id="c7cb7-299">記憶體的權數「很高」是什麼意思？</span><span class="sxs-lookup"><span data-stu-id="c7cb7-299">What does it mean that Memory was weighted “High”?</span></span>

## <a name="metric-weights"></a><span data-ttu-id="c7cb7-300">度量權數</span><span class="sxs-lookup"><span data-stu-id="c7cb7-300">Metric weights</span></span>
<span data-ttu-id="c7cb7-301">追蹤各個不同服務的相同計量相當重要。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-301">Tracking the same metrics across different services is important.</span></span> <span data-ttu-id="c7cb7-302">該全域檢視可讓「叢集資源管理員」追蹤叢集中的耗用量、平衡各個節點之間的耗用量，以及確保節點不會超出容量。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-302">That global view is what allows the Cluster Resource Manager to track consumption in the cluster, balance consumption across nodes, and ensure that nodes don’t go over capacity.</span></span> <span data-ttu-id="c7cb7-303">不過，服務在相同計量的重要性方面可能有不同的檢視。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-303">However, services may have different views as to the importance of the same metric.</span></span> <span data-ttu-id="c7cb7-304">此外，在具有許多計量和許多服務的叢集中，可能並非所有計量都有完美平衡的解決方案。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-304">Also, in a cluster with many metrics and lots of services, perfectly balanced solutions may not exist for all metrics.</span></span> <span data-ttu-id="c7cb7-305">「叢集資源管理員」應該如何處理這些情況？</span><span class="sxs-lookup"><span data-stu-id="c7cb7-305">How should the Cluster Resource Manager handle these situations?</span></span>

<span data-ttu-id="c7cb7-306">計量權數可讓「叢集資源管理員」在沒有完美解答時，決定如何平衡叢集。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-306">Metric weights allow the Cluster Resource Manager to decide how to balance the cluster when there’s no perfect answer.</span></span> <span data-ttu-id="c7cb7-307">計量權數也可讓「叢集資源管理員」以不同的方式平衡特定服務。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-307">Metric weights also allow the Cluster Resource Manager to balance specific services differently.</span></span> <span data-ttu-id="c7cb7-308">度量可以有四個不同的權數層級︰零、低、中和高。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-308">Metrics can have four different weight levels: Zero, Low, Medium, and High.</span></span> <span data-ttu-id="c7cb7-309">在考量項目是否平衡時，權數為「零」的計量並沒有任何貢獻。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-309">A metric with a weight of Zero contributes nothing when considering whether things are balanced or not.</span></span> <span data-ttu-id="c7cb7-310">不過，其負載對容量管理仍有所貢獻。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-310">However, its load does still contribute to capacity management.</span></span> <span data-ttu-id="c7cb7-311">具有「零」權數的計量仍然相當有用，並且經常作為服務行為和效能監視的一部分。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-311">Metrics with Zero weight are still useful and are frequently used as a part of service behavior and performance monitoring.</span></span> <span data-ttu-id="c7cb7-312">[這篇文章](service-fabric-diagnostics-event-generation-infra.md)提供有關使用計量進行監視，以及診斷服務的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-312">[This article](service-fabric-diagnostics-event-generation-infra.md) provides more information on the use of metrics for monitoring and diagnostics of your services.</span></span> 

<span data-ttu-id="c7cb7-313">叢集中不同計量權數的實際影響在於「叢集資源管理員」會產生不同的解決方案。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-313">The real impact of different metric weights in the cluster is that the Cluster Resource Manager generates different solutions.</span></span> <span data-ttu-id="c7cb7-314">計量權數會告訴「叢集資源管理員」某些計量比其他計量重要。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-314">Metric weights tell the Cluster Resource Manager that certain metrics are more important than others.</span></span> <span data-ttu-id="c7cb7-315">當沒有完美的解決方案時，「叢集資源管理員」可以偏好選擇能更有效平衡較高權數計量的解決方案。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-315">When there's no perfect solution the Cluster Resource Manager can prefer solutions which balance the higher weighted metrics better.</span></span> <span data-ttu-id="c7cb7-316">如果服務認為特定計量不重要，它可能會發現對該計量的使用不平衡。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-316">If a service thinks a particular metric is unimportant, it may find their use of that metric imbalanced.</span></span> <span data-ttu-id="c7cb7-317">這可讓另一項服務取得對其重要之某些計量的平均分配。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-317">This allows another service to get an even distribution of some metric that is important to it.</span></span>

<span data-ttu-id="c7cb7-318">讓我們看看一些負載報告的範例，以及不同的計量權數如何在叢集中造成不同的配置。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-318">Let’s look at an example of some load reports and how different metric weights results in different allocations in the cluster.</span></span> <span data-ttu-id="c7cb7-319">在此範例中，我們看到切換計量的相對權數會導致「叢集資源管理員」建立不同的服務佈局。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-319">In this example, we see that switching the relative weight of the metrics causes the Cluster Resource Manager to create different arrangements of services.</span></span>

<span data-ttu-id="c7cb7-320"><center>
![計量權數範例及其對平衡解決方案的影響][Image3]
</center></span><span class="sxs-lookup"><span data-stu-id="c7cb7-320"><center>
![Metric Weight Example and Its Impact on Balancing Solutions][Image3]
</center></span></span>

<span data-ttu-id="c7cb7-321">在此範例中，有四個不同的服務，它們都針對兩個不同計量 (MetricA 和 MetricB) 報告不同值。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-321">In this example, there are four different services, all reporting different values for two different metrics, MetricA and MetricB.</span></span> <span data-ttu-id="c7cb7-322">在其中一個案例中，所有定義 MetricA 的服務是最重要的 (權數 = 高)，MetricB 則是較不重要的 (權數 = 低)。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-322">In one case, all the services define MetricA is the most important one (Weight = High) and MetricB as unimportant (Weight = Low).</span></span> <span data-ttu-id="c7cb7-323">因此，我們看到「叢集資源管理員」是以讓 MetricA 比 MetricB 更加平衡的方式來設置服務。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-323">As a result, we see that the Cluster Resource Manager places the services so that MetricA is better balanced than MetricB.</span></span> <span data-ttu-id="c7cb7-324">「更加平衡」表示 MetricA 具有比 MetricB 較低的標準差。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-324">"Better balanced" means that MetricA has a lower has a lower standard deviation than MetricB.</span></span> <span data-ttu-id="c7cb7-325">在第二個案例中，我們將計量權數反轉。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-325">In the second case, we reverse the metric weights.</span></span> <span data-ttu-id="c7cb7-326">結果就是「叢集資源管理員」會交換服務 A 與 B，以便產生 MetricB 比 MetricA 更加平衡的配置。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-326">As a result, the Cluster Resource Manager swaps services A and B to come up with an allocation where MetricB is better balanced than MetricA.</span></span>

> [!NOTE]
> <span data-ttu-id="c7cb7-327">計量權數會決定叢集資源管理員應該如何平衡，但是不會決定平衡應該何時發生。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-327">Metric weights determine how the Cluster Resource Manager should balance, but not when balancing should happen.</span></span> <span data-ttu-id="c7cb7-328">如需有關平衡的詳細資訊，請參閱[這篇文章](service-fabric-cluster-resource-manager-balancing.md)</span><span class="sxs-lookup"><span data-stu-id="c7cb7-328">For more information on balancing, check out [this article](service-fabric-cluster-resource-manager-balancing.md)</span></span>
>

### <a name="global-metric-weights"></a><span data-ttu-id="c7cb7-329">全域度量權數</span><span class="sxs-lookup"><span data-stu-id="c7cb7-329">Global metric weights</span></span>
<span data-ttu-id="c7cb7-330">假設 Services 將 MetricA 定義權數「高」，且 ServiceB 將 MetricA 的權數設定為「低」或「零」。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-330">Let's say ServiceA defines MetricA as weight High, and ServiceB sets the weight for MetricA to Low or Zero.</span></span> <span data-ttu-id="c7cb7-331">最後使用的實際權數是什麼？</span><span class="sxs-lookup"><span data-stu-id="c7cb7-331">What’s the actual weight that ends up getting used?</span></span>

<span data-ttu-id="c7cb7-332">針對每個計量都會追蹤多個權數。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-332">There are multiple weights that are tracked for every metric.</span></span> <span data-ttu-id="c7cb7-333">第一個權數是在建立服務時針對計量定義的權數。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-333">The first weight is the one defined for the metric when the service is created.</span></span> <span data-ttu-id="c7cb7-334">其他權數是全域權數，它會自動計算。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-334">The other weight is a global weight, which is computed automatically.</span></span> <span data-ttu-id="c7cb7-335">「叢集資源管理員」在計算解決方案的分數時會同時使用這兩種權數。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-335">The Cluster Resource Manager uses both these weights when scoring solutions.</span></span> <span data-ttu-id="c7cb7-336">將這兩個權數列入考量很重要。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-336">Taking both weights into account is important.</span></span> <span data-ttu-id="c7cb7-337">這可讓叢集資源管理員根據自己的優先順序平衡每個服務，也可確保會正確地配置整個叢集。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-337">This allows the Cluster Resource Manager to balance each service according to its own priorities, and also ensure that the cluster as a whole is allocated correctly.</span></span>

<span data-ttu-id="c7cb7-338">如果「叢集資源管理員」既不在意全域平衡也不在意區域平衡，會發生什麼狀況？</span><span class="sxs-lookup"><span data-stu-id="c7cb7-338">What would happen if the Cluster Resource Manager didn’t care about both global and local balance?</span></span> <span data-ttu-id="c7cb7-339">建構全域平衡的解決方案雖然簡單，但是會導致個別服務的資源平衡不佳。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-339">Well, it’s easy to construct solutions that are globally balanced, but which result in poor resource balance for individual services.</span></span> <span data-ttu-id="c7cb7-340">在以下範例中，讓我們看看僅使用預設計量設定的服務，並了解如果只考量全域平衡，會發生什麼狀況：</span><span class="sxs-lookup"><span data-stu-id="c7cb7-340">In the following example, let’s look at a service configured with just the default metrics, and see what happens when only global balance is considered:</span></span>

<span data-ttu-id="c7cb7-341"><center>
![全域唯一解決方案的影響][Image4]
</center></span><span class="sxs-lookup"><span data-stu-id="c7cb7-341"><center>
![The Impact of a Global Only Solution][Image4]
</center></span></span>

<span data-ttu-id="c7cb7-342">在上半部的範例中，只考量了全域平衡，叢集整體上的確達到平衡。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-342">In the top example based only on global balance, the cluster as a whole is indeed balanced.</span></span> <span data-ttu-id="c7cb7-343">所有節點的主要複本計數和複本總數都相同。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-343">All nodes have the same count of primaries and the same number total replicas.</span></span> <span data-ttu-id="c7cb7-344">不過，如果您查看此配置的實際影響，就不是那麼理想︰遺失任何節點都會對特定工作負載帶來不成比例的影響，因為這會取出其所有主要複本。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-344">However, if you look at the actual impact of this allocation it’s not so good: the loss of any node impacts a particular workload disproportionately, because it takes out all of its primaries.</span></span> <span data-ttu-id="c7cb7-345">例如，如果第一個節點發生失敗，圓形服務之三個不同資料分割的三個主要複本將會全部遺失。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-345">For example, if the first node fails the three primaries for the three different partitions of the Circle service would all be lost.</span></span> <span data-ttu-id="c7cb7-346">相反地，「三角形」和「六邊形」服務的資料分割遺失複本。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-346">Conversely, the Triangle and Hexagon services have their partitions lose a replica.</span></span> <span data-ttu-id="c7cb7-347">這樣不會造成中斷，只是必須復原關閉的複本。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-347">This causes no disruption, other than having to recover the down replica.</span></span>

<span data-ttu-id="c7cb7-348">在下半部的範例中，「叢集資源管理員」已同時根據全域和個別服務平衡來分配複本。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-348">In the bottom example, the Cluster Resource Manager has distributed the replicas based on both the global and per-service balance.</span></span> <span data-ttu-id="c7cb7-349">在計算解決方案的分數時，它會將大部分權數給予全域解決方案，而將一部分 (可設定) 給予個別的服務。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-349">When calculating the score of the solution it gives most of the weight to the global solution, and a (configurable) portion to individual services.</span></span> <span data-ttu-id="c7cb7-350">計算計量的全域平衡時，是根據每項服務之計量權數的平均值來計算。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-350">Global balance for a metric is calculated based on the average of the metric weights from each service.</span></span> <span data-ttu-id="c7cb7-351">平衡每項服務時，是根據其自己已定義的計量權數來平衡。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-351">Each service is balanced according to its own defined metric weights.</span></span> <span data-ttu-id="c7cb7-352">這可確保根據服務本身的要求，在服務彼此之間達到平衡。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-352">This ensures that the services are balanced within themselves according to their own needs.</span></span> <span data-ttu-id="c7cb7-353">因此，如果相同的第一個節點發生失敗，失敗會分散在所有服務的所有資料分割。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-353">As a result, if the same first node fails the failure is distributed across all partitions of all services.</span></span> <span data-ttu-id="c7cb7-354">對每個資料分割的影響都一樣。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-354">The impact to each is the same.</span></span>

## <a name="next-steps"></a><span data-ttu-id="c7cb7-355">後續步驟</span><span class="sxs-lookup"><span data-stu-id="c7cb7-355">Next steps</span></span>
- <span data-ttu-id="c7cb7-356">如需有關設定服務的詳細資訊，請參閱[深入了解設定服務](service-fabric-cluster-resource-manager-configure-services.md)(service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="c7cb7-356">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)(service-fabric-cluster-resource-manager-configure-services.md)</span></span>
- <span data-ttu-id="c7cb7-357">定義重組度量是合併 (而不是擴增) 節點上負載的一種方式。若要了解如何設定重組，請參閱 [這篇文章](service-fabric-cluster-resource-manager-defragmentation-metrics.md)</span><span class="sxs-lookup"><span data-stu-id="c7cb7-357">Defining Defragmentation Metrics is one way to consolidate load on nodes instead of spreading it out. To learn how to configure defragmentation, refer to [this article](service-fabric-cluster-resource-manager-defragmentation-metrics.md)</span></span>
- <span data-ttu-id="c7cb7-358">若要了解叢集資源管理員如何管理並平衡叢集中的負載，請查看關於 [平衡負載](service-fabric-cluster-resource-manager-balancing.md)</span><span class="sxs-lookup"><span data-stu-id="c7cb7-358">To find out about how the Cluster Resource Manager manages and balances load in the cluster, check out the article on [balancing load](service-fabric-cluster-resource-manager-balancing.md)</span></span>
- <span data-ttu-id="c7cb7-359">從頭開始，並 [取得 Service Fabric 叢集資源管理員的簡介](service-fabric-cluster-resource-manager-introduction.md)</span><span class="sxs-lookup"><span data-stu-id="c7cb7-359">Start from the beginning and [get an Introduction to the Service Fabric Cluster Resource Manager](service-fabric-cluster-resource-manager-introduction.md)</span></span>
- <span data-ttu-id="c7cb7-360">移動成本是向叢集資源管理員發出訊號，表示移動某些服務會比較貴的其中一種方式。</span><span class="sxs-lookup"><span data-stu-id="c7cb7-360">Movement Cost is one way of signaling to the Cluster Resource Manager that certain services are more expensive to move than others.</span></span> <span data-ttu-id="c7cb7-361">若要深入了解移動成本，請參閱 [這篇文章](service-fabric-cluster-resource-manager-movement-cost.md)</span><span class="sxs-lookup"><span data-stu-id="c7cb7-361">To learn more about movement cost, refer to [this article](service-fabric-cluster-resource-manager-movement-cost.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-cluster-layout-with-default-metrics.png
[Image2]:./media/service-fabric-cluster-resource-manager-metrics/Service-Fabric-Resource-Manager-Dynamic-Load-Reports.png
[Image3]:./media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-metric-weights-impact.png
[Image4]:./media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-global-vs-local-balancing.png
