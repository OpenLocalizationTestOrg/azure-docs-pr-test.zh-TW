---
title: "錯誤分析服務概觀 | Microsoft Docs"
description: "本文描述 Service Fabric 中的錯誤分析服務，以引發錯誤和針對您的服務執行測試案例。"
services: service-fabric
documentationcenter: .net
author: anmolah
manager: timlt
editor: vturecek
ms.assetid: 1f064276-293a-4989-a513-e0d0b9fdf703
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 06/15/2017
ms.author: anmola
ms.openlocfilehash: f275fa5d3d6d727b016e55c188321d7e68091a33
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="introduction-to-the-fault-analysis-service"></a><span data-ttu-id="11a59-103">錯誤分析服務簡介</span><span class="sxs-lookup"><span data-stu-id="11a59-103">Introduction to the Fault Analysis Service</span></span>
<span data-ttu-id="11a59-104">錯誤分析服務的設計目的是測試建置於 Microsoft Azure Service Fabric 上的服務。</span><span class="sxs-lookup"><span data-stu-id="11a59-104">The Fault Analysis Service is designed for testing services that are built on Microsoft Azure Service Fabric.</span></span> <span data-ttu-id="11a59-105">您可以利用錯誤分析服務引發有意義的錯誤，針對應用程式執行完整的測試案例。</span><span class="sxs-lookup"><span data-stu-id="11a59-105">With the Fault Analysis Service you can induce meaningful faults and run complete test scenarios against your applications.</span></span> <span data-ttu-id="11a59-106">這些錯誤及案例會在受控制、安全且一致的情況下，執行及驗證服務在其生命週期會發生的各種狀態和轉換情形。</span><span class="sxs-lookup"><span data-stu-id="11a59-106">These faults and scenarios exercise and validate the numerous states and transitions that a service will experience throughout its lifetime, all in a controlled, safe, and consistent manner.</span></span>

<span data-ttu-id="11a59-107">動作是個別錯誤，可鎖定服務以進行測試。</span><span class="sxs-lookup"><span data-stu-id="11a59-107">Actions are the individual faults targeting a service for testing it.</span></span> <span data-ttu-id="11a59-108">服務開發人員可以使用這些動作當做建置組塊，來撰寫複雜的案例。</span><span class="sxs-lookup"><span data-stu-id="11a59-108">A service developer can use these as building blocks to write complicated scenarios.</span></span> <span data-ttu-id="11a59-109">例如：</span><span class="sxs-lookup"><span data-stu-id="11a59-109">For example:</span></span>

* <span data-ttu-id="11a59-110">重新啟動節點，以模擬任意次數的機器或 VM 重新開機情況。</span><span class="sxs-lookup"><span data-stu-id="11a59-110">Restart a node to simulate any number of situations where a machine or VM is rebooted.</span></span>
* <span data-ttu-id="11a59-111">移動您的具狀態服務複本，以模擬負載平衡、容錯移轉或應用程式升級。</span><span class="sxs-lookup"><span data-stu-id="11a59-111">Move a replica of your stateful service to simulate load balancing, failover, or application upgrade.</span></span>
* <span data-ttu-id="11a59-112">在具狀態服務上叫用仲裁遺失，以建立無法繼續進行寫入作業的狀況，因為可接受新資料的「備份」或「次要」複本不足。</span><span class="sxs-lookup"><span data-stu-id="11a59-112">Invoke quorum loss on a stateful service to create a situation where write operations can't proceed because there aren't enough "back-up" or "secondary" replicas to accept new data.</span></span>
* <span data-ttu-id="11a59-113">在具狀態服務上叫用資料遺失，以建立所有記憶體內狀態為完全抹除的狀況。</span><span class="sxs-lookup"><span data-stu-id="11a59-113">Invoke data loss on a stateful service to create a situation where all in-memory state is completely wiped out.</span></span>

<span data-ttu-id="11a59-114">案例都是一個或多個動作組成的複雜作業。</span><span class="sxs-lookup"><span data-stu-id="11a59-114">Scenarios are complex operations composed of one or more actions.</span></span> <span data-ttu-id="11a59-115">錯誤分析服務提供兩個內建的完整案例︰</span><span class="sxs-lookup"><span data-stu-id="11a59-115">The Fault Analysis Service provides two built-in complete scenarios:</span></span>

* <span data-ttu-id="11a59-116">混亂案例</span><span class="sxs-lookup"><span data-stu-id="11a59-116">Chaos Scenario</span></span>
* <span data-ttu-id="11a59-117">容錯移轉案例</span><span class="sxs-lookup"><span data-stu-id="11a59-117">Failover Scenario</span></span>

## <a name="testing-as-a-service"></a><span data-ttu-id="11a59-118">測試即服務</span><span class="sxs-lookup"><span data-stu-id="11a59-118">Testing as a service</span></span>
<span data-ttu-id="11a59-119">錯誤分析服務是一種 Service Fabric 系統服務，會自動隨 Service Fabric 叢集啟動。</span><span class="sxs-lookup"><span data-stu-id="11a59-119">The Fault Analysis Service is a Service Fabric system service that is automatically started with a Service Fabric cluster.</span></span> <span data-ttu-id="11a59-120">此服務會如同主機般來進行插入錯誤、執行測試案例，以及分析健康狀態。</span><span class="sxs-lookup"><span data-stu-id="11a59-120">This service acts as the host for fault injection, test scenario execution, and health analysis.</span></span> 

![錯誤分析服務][0]

<span data-ttu-id="11a59-122">當啟動錯誤動作或測試案例時，命令就會傳送至錯誤分析服務，執行錯誤動作或測試案例。</span><span class="sxs-lookup"><span data-stu-id="11a59-122">When a fault action or test scenario is initiated, a command is sent to the Fault Analysis Service to run the fault action or test scenario.</span></span> <span data-ttu-id="11a59-123">錯誤分析服務是可以設定的，以便它穩妥執行錯誤和案例，並驗證結果。</span><span class="sxs-lookup"><span data-stu-id="11a59-123">The Fault Analysis Service is stateful so that it can reliably run faults and scenarios and validate results.</span></span> <span data-ttu-id="11a59-124">例如，錯誤分析服務可以穩妥地執行長時間執行的測試案例。</span><span class="sxs-lookup"><span data-stu-id="11a59-124">For example, a long-running test scenario can be reliably executed by the Fault Analysis Service.</span></span> <span data-ttu-id="11a59-125">而且，因為測試是在叢集內部執行，所以服務可以檢查叢集狀態和您的服務，以提供更多有關失敗的深度資訊。</span><span class="sxs-lookup"><span data-stu-id="11a59-125">And because tests are being executed inside the cluster, the service can examine the state of the cluster and your services to provide more in-depth information about failures.</span></span>

## <a name="testing-distributed-systems"></a><span data-ttu-id="11a59-126">測試分散式系統</span><span class="sxs-lookup"><span data-stu-id="11a59-126">Testing distributed systems</span></span>
<span data-ttu-id="11a59-127">Service Fabric 大幅簡化了撰寫和管理分散式可擴充應用程式的工作。</span><span class="sxs-lookup"><span data-stu-id="11a59-127">Service Fabric makes the job of writing and managing distributed scalable applications significantly easier.</span></span> <span data-ttu-id="11a59-128">同樣地，錯誤分析服務也讓測試分散式應用程式更加輕鬆。</span><span class="sxs-lookup"><span data-stu-id="11a59-128">The Fault Analysis Service makes testing a distributed application similarly easier.</span></span> <span data-ttu-id="11a59-129">測試時，有三個主要問題需要解決：</span><span class="sxs-lookup"><span data-stu-id="11a59-129">There are three main issues that need to be solved while testing:</span></span>

1. <span data-ttu-id="11a59-130">模擬/產生真實案例中可能發生的失敗：Service Fabric 其中一個重要的層面是，它讓分散式應用程式從各種不同的失敗中復原。</span><span class="sxs-lookup"><span data-stu-id="11a59-130">Simulating/generating failures that might occur in real-world scenarios: One of the important aspects of Service Fabric is that it enables distributed applications to recover from various failures.</span></span> <span data-ttu-id="11a59-131">但為了測試應用程式是否可以從這些失敗中復原，我們需要能夠在受控制的測試環境中模擬/產生這些真實失敗情形的機制。</span><span class="sxs-lookup"><span data-stu-id="11a59-131">However, to test that the application is able to recover from these failures, we need a mechanism to simulate/generate these real-world failures in a controlled test environment.</span></span>
2. <span data-ttu-id="11a59-132">能夠產生相互關聯的失敗：系統中的基本失敗，例如網路故障和機器故障，很容易個別產生。</span><span class="sxs-lookup"><span data-stu-id="11a59-132">The ability to generate correlated failures: Basic failures in the system, such as network failures and machine failures, are easy to produce individually.</span></span> <span data-ttu-id="11a59-133">由於這些個別失敗的互動是重要的，所以會產生大量實際會發生的案例。</span><span class="sxs-lookup"><span data-stu-id="11a59-133">Generating a significant number of scenarios that can happen in the real world as a result of the interactions of these individual failures is non-trivial.</span></span>
3. <span data-ttu-id="11a59-134">跨各種開發和部署層級的統一經驗：許多錯誤插入系統都能讓您執行各種類型的失敗。</span><span class="sxs-lookup"><span data-stu-id="11a59-134">Unified experience across various levels of development and deployment: There are many fault injection systems that can do various types of failures.</span></span> <span data-ttu-id="11a59-135">不過，當您從一整體開發人員案例，移至大型測試環境中執行相同測試，以將案例用在生產環境中測試時，經驗就會不佳。</span><span class="sxs-lookup"><span data-stu-id="11a59-135">However, the experience in all of these is poor when moving from one-box developer scenarios, to running the same tests in large test environments, to using them for tests in production.</span></span>

<span data-ttu-id="11a59-136">雖然有許多可解決這些問題的機制，但是在從一整體開發人員環境到在生產環境叢集進行測試的過程中，卻缺少能以必要保證發揮相同作用的系統。</span><span class="sxs-lookup"><span data-stu-id="11a59-136">While there are many mechanisms to solve these problems, a system that does the same with required guarantees--all the way from a one-box developer environment, to test in production clusters--is missing.</span></span> <span data-ttu-id="11a59-137">錯誤分析服務有利於應用程式開發人員專注於測試他們的商務邏輯。</span><span class="sxs-lookup"><span data-stu-id="11a59-137">The Fault Analysis Service helps the application developers concentrate on testing their business logic.</span></span> <span data-ttu-id="11a59-138">錯誤分析服務提供所有必要功能，以測試服務與基礎分散式系統的互動。</span><span class="sxs-lookup"><span data-stu-id="11a59-138">The Fault Analysis Service provides all the capabilities needed to test the interaction of the service with the underlying distributed system.</span></span>

### <a name="simulatinggenerating-real-world-failure-scenarios"></a><span data-ttu-id="11a59-139">模擬/產生真實失敗案例</span><span class="sxs-lookup"><span data-stu-id="11a59-139">Simulating/generating real-world failure scenarios</span></span>
<span data-ttu-id="11a59-140">若要測試分散式系統抵抗失敗的強健性，我們需要一個可產生失敗的機制。</span><span class="sxs-lookup"><span data-stu-id="11a59-140">To test the robustness of a distributed system against failures, we need a mechanism to generate failures.</span></span> <span data-ttu-id="11a59-141">雖然理論上產生失敗似乎很簡單，例如節點停機，卻也發生了與 Service Fabric 正嘗試解決的同一組一致性問題。</span><span class="sxs-lookup"><span data-stu-id="11a59-141">While in theory, generating a failure like a node down seems easy, it starts hitting the same set of consistency problems that Service Fabric is trying to solve.</span></span> <span data-ttu-id="11a59-142">如果我們想要將關閉節點做為範例，則需要的工作流程如下：</span><span class="sxs-lookup"><span data-stu-id="11a59-142">As an example, if we want to shut down a node, the required workflow is the following:</span></span>

1. <span data-ttu-id="11a59-143">從用戶端發出關閉節點要求。</span><span class="sxs-lookup"><span data-stu-id="11a59-143">From the client, issue a shutdown node request.</span></span>
2. <span data-ttu-id="11a59-144">將要求傳送至正確的節點。</span><span class="sxs-lookup"><span data-stu-id="11a59-144">Send the request to the right node.</span></span>
   
    <span data-ttu-id="11a59-145">a.</span><span class="sxs-lookup"><span data-stu-id="11a59-145">a.</span></span> <span data-ttu-id="11a59-146">如果找不到節點，要求應該會失敗。</span><span class="sxs-lookup"><span data-stu-id="11a59-146">If the node is not found, it should fail.</span></span>
   
    <span data-ttu-id="11a59-147">b.</span><span class="sxs-lookup"><span data-stu-id="11a59-147">b.</span></span> <span data-ttu-id="11a59-148">如果找到節點，應該只會在節點關閉時才傳回要求。</span><span class="sxs-lookup"><span data-stu-id="11a59-148">If the node is found, it should return only if the node is shut down.</span></span>

<span data-ttu-id="11a59-149">若要從測試角度確認失敗，測試必須知道在導致此失敗時，失敗確實會發生。</span><span class="sxs-lookup"><span data-stu-id="11a59-149">To verify the failure from a test perspective, the test needs to know that when this failure is induced, the failure actually happens.</span></span> <span data-ttu-id="11a59-150">Service Fabric 提供的保證就是，當命令到達該節點時，節點會停機，或是已經停機。</span><span class="sxs-lookup"><span data-stu-id="11a59-150">The guarantee that Service Fabric provides is that either the node will go down or was already down when the command reached the node.</span></span> <span data-ttu-id="11a59-151">在任一情況中，測試應該都能正確地推論出狀態，以及正確地推斷驗證是否成功。</span><span class="sxs-lookup"><span data-stu-id="11a59-151">In either case the test should be able to correctly reason about the state and succeed or fail correctly in its validation.</span></span> <span data-ttu-id="11a59-152">在 Service Fabric 外部實作的系統如果執行一組相同的失敗，可能會發生許多網路、硬體和軟體問題，這會導致無法提供上述的保證。</span><span class="sxs-lookup"><span data-stu-id="11a59-152">A system implemented outside of Service Fabric to do the same set of failures could hit many network, hardware, and software issues, which would prevent it from providing the preceding guarantees.</span></span> <span data-ttu-id="11a59-153">如果出現前述問題，Service Fabric 會重設叢集狀態以因應問題，使錯誤分析服務仍然可以提供一組適當的保證。</span><span class="sxs-lookup"><span data-stu-id="11a59-153">In the presence of the issues stated before, Service Fabric will reconfigure the cluster state to work around the issues, and hence the Fault Analysis Service will still be able to give the right set of guarantees.</span></span>

### <a name="generating-required-events-and-scenarios"></a><span data-ttu-id="11a59-154">產生必要的事件和案例</span><span class="sxs-lookup"><span data-stu-id="11a59-154">Generating required events and scenarios</span></span>
<span data-ttu-id="11a59-155">雖然一致地模擬真實失敗情形並不容易著手，但可以產生相互關聯的失敗更是難上加難。</span><span class="sxs-lookup"><span data-stu-id="11a59-155">While simulating a real-world failure consistently is tough to start with, the ability to generate correlated failures is even tougher.</span></span> <span data-ttu-id="11a59-156">舉例來說，發生下列狀況時，具狀態的持續性服務中會遺失資料：</span><span class="sxs-lookup"><span data-stu-id="11a59-156">For example, a data loss happens in a stateful persisted service when the following things happen:</span></span>

1. <span data-ttu-id="11a59-157">只有複本寫入仲裁會在複寫中被趕上。</span><span class="sxs-lookup"><span data-stu-id="11a59-157">Only a write quorum of the replicas are caught up on replication.</span></span> <span data-ttu-id="11a59-158">所有次要複本均落後於主要複本。</span><span class="sxs-lookup"><span data-stu-id="11a59-158">All the secondary replicas lag behind the primary.</span></span>
2. <span data-ttu-id="11a59-159">因為複本停止運作 (由於程式碼封裝或節點停止運作)，導致寫入仲裁停止運作。</span><span class="sxs-lookup"><span data-stu-id="11a59-159">The write quorum goes down because of the replicas going down (due to a code package or node going down).</span></span>
3. <span data-ttu-id="11a59-160">因為複本的資料遺失 (由於磁碟損毀或機器重新安裝映像)，寫入仲裁無法恢復。</span><span class="sxs-lookup"><span data-stu-id="11a59-160">The write quorum cannot come back up because the data for the replicas is lost (due to disk corruption or machine reimaging).</span></span>

<span data-ttu-id="11a59-161">這些相互關聯的失敗確實會在真實情況中發生，但是不像個別失敗那麼頻繁。</span><span class="sxs-lookup"><span data-stu-id="11a59-161">These correlated failures do happen in the real world but not as frequently as individual failures.</span></span> <span data-ttu-id="11a59-162">在這些案例於生產環境中發生前，能夠先測試這些案例會很重要。</span><span class="sxs-lookup"><span data-stu-id="11a59-162">The ability to test for these scenarios before they happen in production is critical.</span></span> <span data-ttu-id="11a59-163">更重要的是在受控制的情況下 (所有工程師都在待命的白天時)，能夠在生產環境的工作負載中模擬這些案例。</span><span class="sxs-lookup"><span data-stu-id="11a59-163">Even more important is the ability to simulate these scenarios with production workloads in controlled circumstances (in the middle of the day with all engineers on deck).</span></span> <span data-ttu-id="11a59-164">這樣會比生產環境在清晨 2 點第一次發生這些案例要來得更好。</span><span class="sxs-lookup"><span data-stu-id="11a59-164">That is much better than having it happen for the first time in production at 2:00 A.M.</span></span>

### <a name="unified-experience-across-different-environments"></a><span data-ttu-id="11a59-165">跨不同環境的統一經驗</span><span class="sxs-lookup"><span data-stu-id="11a59-165">Unified experience across different environments</span></span>
<span data-ttu-id="11a59-166">傳統作法已建立了三組不同的經驗，一個用於開發環境、一個用於測試環境，另一個則用於生產環境。</span><span class="sxs-lookup"><span data-stu-id="11a59-166">The practice traditionally has been to create three different sets of experiences, one for the development environment, one for tests, and one for production.</span></span> <span data-ttu-id="11a59-167">此模型為：</span><span class="sxs-lookup"><span data-stu-id="11a59-167">The model was:</span></span>

1. <span data-ttu-id="11a59-168">在開發環境中產生狀態轉換，讓個別方法能進行單元測試。</span><span class="sxs-lookup"><span data-stu-id="11a59-168">In the development environment, produce state transitions that allow unit tests of individual methods.</span></span>
2. <span data-ttu-id="11a59-169">在測試環境中產生失敗，以使用練習各種失敗案例的端對端測試。</span><span class="sxs-lookup"><span data-stu-id="11a59-169">In the test environment, produce failures to allow end-to-end tests that exercise various failure scenarios.</span></span>
3. <span data-ttu-id="11a59-170">將生產環境保留原狀，以防止任何人為失敗，並確保有非常快速的人力可回應失敗。</span><span class="sxs-lookup"><span data-stu-id="11a59-170">Keep the production environment pristine to prevent any non-natural failures and to ensure that there is extremely quick human response to failure.</span></span>

<span data-ttu-id="11a59-171">我們打算在 Service Fabric 中透過錯誤分析服務扭轉此情形，並從開發人員環境到生產環境中使用相同的方法。</span><span class="sxs-lookup"><span data-stu-id="11a59-171">In Service Fabric, through the Fault Analysis Service, we are proposing to turn this around and use the same methodology from developer environment to production.</span></span> <span data-ttu-id="11a59-172">作法有二：</span><span class="sxs-lookup"><span data-stu-id="11a59-172">There are two ways to achieve this:</span></span>

1. <span data-ttu-id="11a59-173">若要引發受控制的失敗，請在一整體環境到生產環境叢集中，一律使用錯誤分析服務 API。</span><span class="sxs-lookup"><span data-stu-id="11a59-173">To induce controlled failures, use the Fault Analysis Service APIs from a one-box environment all the way to production clusters.</span></span>
2. <span data-ttu-id="11a59-174">若要讓叢集故障，使失敗自動發生，請使用錯誤分析服務產生自動失敗。</span><span class="sxs-lookup"><span data-stu-id="11a59-174">To give the cluster a fever that causes automatic induction of failures, use the Fault Analysis Service to generate automatic failures.</span></span> <span data-ttu-id="11a59-175">透過組態來控制失敗率，可讓不同環境以不同的方式測試同一個服務。</span><span class="sxs-lookup"><span data-stu-id="11a59-175">Controlling the rate of failures through configuration enables the same service to be tested differently in different environments.</span></span>

<span data-ttu-id="11a59-176">在 Service Fabric 中，雖然失敗的規模會因為環境不同而有所差異，但實際機制是相同的。</span><span class="sxs-lookup"><span data-stu-id="11a59-176">With Service Fabric, though the scale of failures would be different in the different environments, the actual mechanisms would be identical.</span></span> <span data-ttu-id="11a59-177">這不但可讓您用更快的程式碼部署管線，還能在真實情況處於負載時測試服務。</span><span class="sxs-lookup"><span data-stu-id="11a59-177">This allows for a much quicker code-to-deployment pipeline and the ability to test the services under real-world loads.</span></span>

## <a name="using-the-fault-analysis-service"></a><span data-ttu-id="11a59-178">使用錯誤分析服務</span><span class="sxs-lookup"><span data-stu-id="11a59-178">Using the Fault Analysis Service</span></span>
<span data-ttu-id="11a59-179">**C#**</span><span class="sxs-lookup"><span data-stu-id="11a59-179">**C#**</span></span>

<span data-ttu-id="11a59-180">錯誤分析服務功能位於 Microsoft.ServiceFabric NuGet 封裝中的 System.Fabric 命名空間中。</span><span class="sxs-lookup"><span data-stu-id="11a59-180">Fault Analysis Service features are in the System.Fabric namespace in the Microsoft.ServiceFabric NuGet package.</span></span> <span data-ttu-id="11a59-181">若要使用錯誤分析服務功能，請在您的專案中包含此 NuGet 封裝作為參考。</span><span class="sxs-lookup"><span data-stu-id="11a59-181">To use the Fault Analysis Service features, include the nuget package as a reference in your project.</span></span>

<span data-ttu-id="11a59-182">**PowerShell**</span><span class="sxs-lookup"><span data-stu-id="11a59-182">**PowerShell**</span></span>

<span data-ttu-id="11a59-183">若要使用 PowerShell，您必須安裝 Service Fabric SDK。</span><span class="sxs-lookup"><span data-stu-id="11a59-183">To use PowerShell, you must install the Service Fabric SDK.</span></span> <span data-ttu-id="11a59-184">安裝 SDK 後，會自動載入 ServiceFabric PowerShell 模組供您使用。</span><span class="sxs-lookup"><span data-stu-id="11a59-184">After the SDK is installed, the ServiceFabric PowerShell module is auto loaded for you to use.</span></span>

## <a name="next-steps"></a><span data-ttu-id="11a59-185">後續步驟</span><span class="sxs-lookup"><span data-stu-id="11a59-185">Next steps</span></span>
<span data-ttu-id="11a59-186">為了建立真實的雲端規模調整服務，能夠在部署前後確保服務可以承受真實失敗是不可或缺的。</span><span class="sxs-lookup"><span data-stu-id="11a59-186">To create truly cloud-scale services, it is critical to ensure, both before and after deployment, that services can withstand real world failures.</span></span> <span data-ttu-id="11a59-187">對現今的服務產業而言，具有快速創新以及快速將程式碼移至生產環境的能力非常重要。</span><span class="sxs-lookup"><span data-stu-id="11a59-187">In the services world today, the ability to innovate quickly and move code to production quickly is very important.</span></span> <span data-ttu-id="11a59-188">錯誤分析服務正好能協助服務開發人員這麼做。</span><span class="sxs-lookup"><span data-stu-id="11a59-188">The Fault Analysis Service helps service developers to do precisely that.</span></span>

<span data-ttu-id="11a59-189">使用內建的[測試案例](service-fabric-testability-scenarios.md)開始測試應用程式和服務，或使用錯誤分析服務提供的[錯誤動作](service-fabric-testability-actions.md)，撰寫您自己的測試案例。</span><span class="sxs-lookup"><span data-stu-id="11a59-189">Begin testing your applications and services using the built-in [test scenarios](service-fabric-testability-scenarios.md), or author your own test scenarios using the [fault actions](service-fabric-testability-actions.md) provided by the Fault Analysis Service.</span></span>

<!--Image references-->
[0]: ./media/service-fabric-testability-overview/faultanalysisservice.png
