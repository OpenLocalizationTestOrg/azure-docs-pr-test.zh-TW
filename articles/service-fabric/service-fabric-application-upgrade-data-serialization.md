---
title: "應用程式升級：資料序列化 | Microsoft Docs"
description: "資料序列化的最佳作法，以及它如何影響應用程式輪流升級。"
services: service-fabric
documentationcenter: .net
author: vturecek
manager: timlt
editor: 
ms.assetid: a5f36366-a2ab-4ae3-bb08-bc2f9533bc5a
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 06/29/2017
ms.author: vturecek
ms.openlocfilehash: 6aa3ac7842df4657fca7f6b4264e1c6fe52dc0c6
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="how-data-serialization-affects-an-application-upgrade"></a><span data-ttu-id="624d7-103">資料序列化如何影響應用程式升級</span><span class="sxs-lookup"><span data-stu-id="624d7-103">How data serialization affects an application upgrade</span></span>
<span data-ttu-id="624d7-104">在 [輪流應用程式升級](service-fabric-application-upgrade.md)中，升級會套用至節點的子集，一次一個升級網域。</span><span class="sxs-lookup"><span data-stu-id="624d7-104">In a [rolling application upgrade](service-fabric-application-upgrade.md), the upgrade is applied to a subset of nodes, one upgrade domain at a time.</span></span> <span data-ttu-id="624d7-105">在此過程中，有些升級網域會有您應用程式的新版本，有些升級網域則有您應用程式的舊版本。</span><span class="sxs-lookup"><span data-stu-id="624d7-105">During this process, some upgrade domains are on the newer version of your application, and some upgrade domains are on the older version of your application.</span></span> <span data-ttu-id="624d7-106">在首度發行期間，新版的應用程式必須能夠讀取舊版的資料，而舊版的應用程式必須能夠讀取新版的資料。</span><span class="sxs-lookup"><span data-stu-id="624d7-106">During the rollout, the new version of your application must be able to read the old version of your data, and the old version of your application must be able to read the new version of your data.</span></span> <span data-ttu-id="624d7-107">如果資料格式沒有向前及向後相容，升級便可能會失敗，或是發生更糟糕的狀況，像是資料可能會遺失或損毀。</span><span class="sxs-lookup"><span data-stu-id="624d7-107">If the data format is not forward and backward compatible, the upgrade may fail, or worse, data may be lost or corrupted.</span></span> <span data-ttu-id="624d7-108">本文將討論您資料格式的構成項目並提供最佳作法，以確保您的資料向前及向後相容。</span><span class="sxs-lookup"><span data-stu-id="624d7-108">This article discusses what constitutes your data format and offers best practices for ensuring that your data is forward and backward compatible.</span></span>

## <a name="what-makes-up-your-data-format"></a><span data-ttu-id="624d7-109">資料格式的構成項目？</span><span class="sxs-lookup"><span data-stu-id="624d7-109">What makes up your data format?</span></span>
<span data-ttu-id="624d7-110">在 Azure Service Fabric 中，保留及複寫的資料來自您的 C# 類別。</span><span class="sxs-lookup"><span data-stu-id="624d7-110">In Azure Service Fabric, the data that is persisted and replicated comes from your C# classes.</span></span> <span data-ttu-id="624d7-111">針對使用[可靠集合](service-fabric-reliable-services-reliable-collections.md)的應用程式，該資料就是可靠的字典和佇列中的物件。</span><span class="sxs-lookup"><span data-stu-id="624d7-111">For applications that use [Reliable Collections](service-fabric-reliable-services-reliable-collections.md), that data is the objects in the reliable dictionaries and queues.</span></span> <span data-ttu-id="624d7-112">對於使用 [Reliable Actors](service-fabric-reliable-actors-introduction.md)的應用程式，也就是動作項目的備份狀態。</span><span class="sxs-lookup"><span data-stu-id="624d7-112">For applications that use [Reliable Actors](service-fabric-reliable-actors-introduction.md), that is the backing state for the actor.</span></span> <span data-ttu-id="624d7-113">這些 C# 類別必須是可序列化，以便保存和複寫。</span><span class="sxs-lookup"><span data-stu-id="624d7-113">These C# classes must be serializable to be persisted and replicated.</span></span> <span data-ttu-id="624d7-114">因此，資料格式是由已序列化的欄位和屬性，以及其序列化方式來定義。</span><span class="sxs-lookup"><span data-stu-id="624d7-114">Therefore, the data format is defined by the fields and properties that are serialized, as well as how they are serialized.</span></span> <span data-ttu-id="624d7-115">例如，在 `IReliableDictionary<int, MyClass>` 中，資料是序列化 `int` 和序列化 `MyClass`。</span><span class="sxs-lookup"><span data-stu-id="624d7-115">For example, in an `IReliableDictionary<int, MyClass>` the data is a serialized `int` and a serialized `MyClass`.</span></span>

### <a name="code-changes-that-result-in-a-data-format-change"></a><span data-ttu-id="624d7-116">程式碼變更造成資料格式變更</span><span class="sxs-lookup"><span data-stu-id="624d7-116">Code changes that result in a data format change</span></span>
<span data-ttu-id="624d7-117">由於資料格式是由 C# 類別決定，所以類別的變更可能會導致資料格式變更。</span><span class="sxs-lookup"><span data-stu-id="624d7-117">Since the data format is determined by C# classes, changes to the classes may cause a data format change.</span></span> <span data-ttu-id="624d7-118">請小心確保輪流升級能夠處理資料格式變更。</span><span class="sxs-lookup"><span data-stu-id="624d7-118">Care must be taken to ensure that a rolling upgrade can handle the data format change.</span></span> <span data-ttu-id="624d7-119">可能會造成資料格式變更的範例：</span><span class="sxs-lookup"><span data-stu-id="624d7-119">Examples that may cause data format changes:</span></span>

* <span data-ttu-id="624d7-120">新增或移除欄位或屬性</span><span class="sxs-lookup"><span data-stu-id="624d7-120">Adding or removing fields or properties</span></span>
* <span data-ttu-id="624d7-121">重新命名欄位或屬性</span><span class="sxs-lookup"><span data-stu-id="624d7-121">Renaming fields or properties</span></span>
* <span data-ttu-id="624d7-122">變更欄位或屬性的類型</span><span class="sxs-lookup"><span data-stu-id="624d7-122">Changing the types of fields or properties</span></span>
* <span data-ttu-id="624d7-123">變更類別名稱或命名空間</span><span class="sxs-lookup"><span data-stu-id="624d7-123">Changing the class name or namespace</span></span>

### <a name="data-contract-as-the-default-serializer"></a><span data-ttu-id="624d7-124">將資料合約做為預設的序列化程式</span><span class="sxs-lookup"><span data-stu-id="624d7-124">Data Contract as the default serializer</span></span>
<span data-ttu-id="624d7-125">序列化程式通常負責讀取資料，以及還原序列化為目前版本，即使資料是舊版或 *新* 版。</span><span class="sxs-lookup"><span data-stu-id="624d7-125">The serializer is generally responsible for reading the data and deserializing it into the current version, even if the data is in an older or *newer* version.</span></span> <span data-ttu-id="624d7-126">預設的序列化程式是 [資料合約序列化程式](https://msdn.microsoft.com/library/ms733127.aspx)，其具有定義完善的版本控制規則。</span><span class="sxs-lookup"><span data-stu-id="624d7-126">The default serializer is the [Data Contract serializer](https://msdn.microsoft.com/library/ms733127.aspx), which has well-defined versioning rules.</span></span> <span data-ttu-id="624d7-127">可靠的集合允許覆寫序列化程式，但是 Reliable Actors 目前不允許。</span><span class="sxs-lookup"><span data-stu-id="624d7-127">Reliable Collections allow the serializer to be overridden, but Reliable Actors currently do not.</span></span> <span data-ttu-id="624d7-128">資料序列化程式在啟用輪流升級中扮演著重要的角色。</span><span class="sxs-lookup"><span data-stu-id="624d7-128">The data serializer plays an important role in enabling rolling upgrades.</span></span> <span data-ttu-id="624d7-129">資料合約序列化程式是我們建議用於 Service Fabric 應用程式的序列化程式。</span><span class="sxs-lookup"><span data-stu-id="624d7-129">The Data Contract serializer is the serializer that we recommend for Service Fabric applications.</span></span>

## <a name="how-the-data-format-affects-a-rolling-upgrade"></a><span data-ttu-id="624d7-130">資料格式如何影響輪流升級</span><span class="sxs-lookup"><span data-stu-id="624d7-130">How the data format affects a rolling upgrade</span></span>
<span data-ttu-id="624d7-131">輪流升級期間，有兩種序列化程式可能會遇到舊版或 *新* 版資料的主要案例：</span><span class="sxs-lookup"><span data-stu-id="624d7-131">During a rolling upgrade, there are two main scenarios where the serializer may encounter an older or *newer* version of your data:</span></span>

1. <span data-ttu-id="624d7-132">節點升級並重新啟動之後，新的序列化程式會載入資料，該資料保存到舊版的磁碟。</span><span class="sxs-lookup"><span data-stu-id="624d7-132">After a node is upgraded and starts back up, the new serializer will load the data that was persisted to disk by the old version.</span></span>
2. <span data-ttu-id="624d7-133">輪流升級期間，叢集將會包含舊和新版本程式碼的混合。</span><span class="sxs-lookup"><span data-stu-id="624d7-133">During the rolling upgrade, the cluster will contain a mix of the old and new versions of your code.</span></span> <span data-ttu-id="624d7-134">由於複本會放在不同升級網域，且複本會互相傳送資料，因此您的新版和/或舊版資料可能會遇到新版和/或舊版序列化程式。</span><span class="sxs-lookup"><span data-stu-id="624d7-134">Since replicas may be placed in different upgrade domains, and replicas send data to each other, the new and/or old version of your data may be encountered by the new and/or old version of your serializer.</span></span>

> [!NOTE]
> <span data-ttu-id="624d7-135">此處的「新版」和「舊版」是指您正在執行的程式碼的版本。</span><span class="sxs-lookup"><span data-stu-id="624d7-135">The "new version" and "old version" here refer to the version of your code that is running.</span></span> <span data-ttu-id="624d7-136">「新序列化程式」是指在您的新版應用程式中執行的序列化程式程式碼。</span><span class="sxs-lookup"><span data-stu-id="624d7-136">The "new serializer" refers to the serializer code that is executing in the new version of your application.</span></span> <span data-ttu-id="624d7-137">「新資料」是指來自您的新版應用程式的序列化 C# 類別。</span><span class="sxs-lookup"><span data-stu-id="624d7-137">The "new data" refers to the serialized C# class from the new version of your application.</span></span>
> 
> 

<span data-ttu-id="624d7-138">兩個版本的程式碼和資料格式必須同時向前及向後相容。</span><span class="sxs-lookup"><span data-stu-id="624d7-138">The two versions of code and data format must be both forward and backward compatible.</span></span> <span data-ttu-id="624d7-139">如果它們不相容，輪流升級可能會失敗，或可能會遺失資料。</span><span class="sxs-lookup"><span data-stu-id="624d7-139">If they are not compatible, the rolling upgrade may fail or data may be lost.</span></span> <span data-ttu-id="624d7-140">輪流升級可能會失敗，因為程式碼或序列化程式在遇到其他版本時可能會擲回例外狀況或錯誤。</span><span class="sxs-lookup"><span data-stu-id="624d7-140">The rolling upgrade may fail because the code or serializer may throw exceptions or a fault when it encounters the other version.</span></span> <span data-ttu-id="624d7-141">比方說，如果已加入新屬性，但是舊的序列化程式在還原序列化期間捨棄它，則可能會遺失資料。</span><span class="sxs-lookup"><span data-stu-id="624d7-141">Data may be lost if, for example, a new property was added but the old serializer discards it during deserialization.</span></span>

<span data-ttu-id="624d7-142">資料合約是建議的解決方案，以確保您的資料相容。</span><span class="sxs-lookup"><span data-stu-id="624d7-142">Data Contract is the recommended solution for ensuring that your data is compatible.</span></span> <span data-ttu-id="624d7-143">它有新增、移除及變更欄位的定義完善版本控制規則。</span><span class="sxs-lookup"><span data-stu-id="624d7-143">It has well-defined versioning rules for adding, removing, and changing fields.</span></span> <span data-ttu-id="624d7-144">它也支援處理未知欄位、連結到序列化和還原序列化程序，以及處理類別繼承。</span><span class="sxs-lookup"><span data-stu-id="624d7-144">It also has support for dealing with unknown fields, hooking into the serialization and deserialization process, and dealing with class inheritance.</span></span> <span data-ttu-id="624d7-145">如需詳細資訊，請參閱 [使用資料合約](https://msdn.microsoft.com/library/ms733127.aspx)。</span><span class="sxs-lookup"><span data-stu-id="624d7-145">For more information, see [Using Data Contract](https://msdn.microsoft.com/library/ms733127.aspx).</span></span>

## <a name="next-steps"></a><span data-ttu-id="624d7-146">後續步驟</span><span class="sxs-lookup"><span data-stu-id="624d7-146">Next steps</span></span>
<span data-ttu-id="624d7-147">[使用 Visual Studio 升級您的應用程式](service-fabric-application-upgrade-tutorial.md) 將引導您完成使用 Visual Studio 進行應用程式升級的步驟。</span><span class="sxs-lookup"><span data-stu-id="624d7-147">[Upgrading your Application Using Visual Studio](service-fabric-application-upgrade-tutorial.md) walks you through an application upgrade using Visual Studio.</span></span>

<span data-ttu-id="624d7-148">[使用 PowerShell 升級您的應用程式](service-fabric-application-upgrade-tutorial-powershell.md) 將引導您完成使用 PowerShell 進行應用程式升級的步驟。</span><span class="sxs-lookup"><span data-stu-id="624d7-148">[Upgrading your Application Using Powershell](service-fabric-application-upgrade-tutorial-powershell.md) walks you through an application upgrade using PowerShell.</span></span>

<span data-ttu-id="624d7-149">使用 [升級參數](service-fabric-application-upgrade-parameters.md)來控制您應用程式的升級方式。</span><span class="sxs-lookup"><span data-stu-id="624d7-149">Control how your application upgrades by using [Upgrade Parameters](service-fabric-application-upgrade-parameters.md).</span></span>

<span data-ttu-id="624d7-150">參考 [進階主題](service-fabric-application-upgrade-advanced.md)，以了解如何在升級您的應用程式時使用進階功能。</span><span class="sxs-lookup"><span data-stu-id="624d7-150">Learn how to use advanced functionality while upgrading your application by referring to [Advanced Topics](service-fabric-application-upgrade-advanced.md).</span></span>

<span data-ttu-id="624d7-151">參考 [疑難排解應用程式升級 ](service-fabric-application-upgrade-troubleshooting.md)中的步驟，以修正應用程式升級中常見的問題。</span><span class="sxs-lookup"><span data-stu-id="624d7-151">Fix common problems in application upgrades by referring to the steps in [Troubleshooting Application Upgrades ](service-fabric-application-upgrade-troubleshooting.md).</span></span>

