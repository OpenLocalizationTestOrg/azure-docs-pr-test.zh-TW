---
title: "Service Fabric 的健康狀態監視 | Microsoft Docs"
description: "Azure Service Fabric 健康狀態監視模型的簡介，該模型提供對叢集及其應用程式和服務的監視。"
services: service-fabric
documentationcenter: .net
author: oanapl
manager: timlt
editor: 
ms.assetid: 1d979210-b1eb-4022-be24-799fd9d8e003
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/19/2017
ms.author: oanapl
ms.openlocfilehash: 598a4d35faebb592f840b1bec7e77c7a091ea2de
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/18/2017
---
# <a name="introduction-to-service-fabric-health-monitoring"></a><span data-ttu-id="d8e08-103">Service Fabric 健康狀態監視簡介</span><span class="sxs-lookup"><span data-stu-id="d8e08-103">Introduction to Service Fabric health monitoring</span></span>
<span data-ttu-id="d8e08-104">Azure Service Fabric 導入了健康狀態模型，提供豐富、彈性且可延伸的健康狀態評估與報告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-104">Azure Service Fabric introduces a health model that provides rich, flexible, and extensible health evaluation and reporting.</span></span> <span data-ttu-id="d8e08-105">此模型允許幾乎即時地監視叢集狀態以及其中所執行的服務。</span><span class="sxs-lookup"><span data-stu-id="d8e08-105">The model allows near-real-time monitoring of the state of the cluster and the services running in it.</span></span> <span data-ttu-id="d8e08-106">您可以輕鬆地取得健康狀態資訊，並在潛在問題引起連鎖反應和造成大規模中斷之前，予以更正。</span><span class="sxs-lookup"><span data-stu-id="d8e08-106">You can easily obtain health information and correct potential issues before they cascade and cause massive outages.</span></span> <span data-ttu-id="d8e08-107">在一般模型中，服務會根據其本機檢視傳送報告，且該資訊會進行彙總以提供整體叢集層級檢視。</span><span class="sxs-lookup"><span data-stu-id="d8e08-107">In the typical model, services send reports based on their local views, and that information is aggregated to provide an overall cluster-level view.</span></span>

<span data-ttu-id="d8e08-108">Service Fabric 元件會使用此健康狀態模型來報告其目前狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-108">Service Fabric components use this rich health model to report their current state.</span></span> <span data-ttu-id="d8e08-109">您可以使用相同機制來報告應用程式的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-109">You can use the same mechanism to report health from your applications.</span></span> <span data-ttu-id="d8e08-110">只要投入時間規劃高品質的健康狀態報告來擷取您的自訂條件，就能更輕鬆地偵測並修正執行中應用程式的問題。</span><span class="sxs-lookup"><span data-stu-id="d8e08-110">If you invest in high-quality health reporting that captures your custom conditions, you can detect and fix issues for your running application much more easily.</span></span>

<span data-ttu-id="d8e08-111">下列 Microsoft Virtual Academy 影片也會說明 Service Fabric 健康狀態模型及其使用方式︰<center><a target="_blank" href="https://mva.microsoft.com/training-courses/building-microservices-applications-on-azure-service-fabric-16747?l=tevZw56yC_1906218965">
<img src="./media/service-fabric-health-introduction/HealthIntroVid.png" WIDTH="360" HEIGHT="244">
</a></center></span><span class="sxs-lookup"><span data-stu-id="d8e08-111">The following Microsoft Virtual Academy video also describes the Service Fabric health model and how it's used: <center><a target="_blank" href="https://mva.microsoft.com/training-courses/building-microservices-applications-on-azure-service-fabric-16747?l=tevZw56yC_1906218965">
<img src="./media/service-fabric-health-introduction/HealthIntroVid.png" WIDTH="360" HEIGHT="244">
</a></center></span></span>

> [!NOTE]
> <span data-ttu-id="d8e08-112">我們會啟動健康狀態子系統來滿足受監視升級的需求。</span><span class="sxs-lookup"><span data-stu-id="d8e08-112">We started the health subsystem to address a need for monitored upgrades.</span></span> <span data-ttu-id="d8e08-113">Service Fabric 提供受監視應用程式和叢集升級，可以確保完整的可用性、永不停機，且幾乎或完全不需要使用者介入。</span><span class="sxs-lookup"><span data-stu-id="d8e08-113">Service Fabric provides monitored application and cluster upgrades that ensure full availability, no downtime and minimal to no user intervention.</span></span> <span data-ttu-id="d8e08-114">為了達成這些目的，升級會依照已設定的升級原則來檢查健康情況。</span><span class="sxs-lookup"><span data-stu-id="d8e08-114">To achieve these goals, the upgrade checks health based on configured upgrade policies.</span></span> <span data-ttu-id="d8e08-115">只有在健康情況達到所需的臨界值時，才可繼續進行升級。</span><span class="sxs-lookup"><span data-stu-id="d8e08-115">An upgrade can proceed only when health respects desired thresholds.</span></span> <span data-ttu-id="d8e08-116">否則，升級會自動回復或暫停，讓系統管理員有機會來修正問題。</span><span class="sxs-lookup"><span data-stu-id="d8e08-116">Otherwise, the upgrade is either automatically rolled back or paused to give administrators a chance to fix the issues.</span></span> <span data-ttu-id="d8e08-117">若要深入了解應用程式升級，請參閱 [這篇文章](service-fabric-application-upgrade.md)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-117">To learn more about application upgrades, see [this article](service-fabric-application-upgrade.md).</span></span>
> 
> 

## <a name="health-store"></a><span data-ttu-id="d8e08-118">健康狀態資料存放區</span><span class="sxs-lookup"><span data-stu-id="d8e08-118">Health store</span></span>
<span data-ttu-id="d8e08-119">健康狀態資料存放區會保留叢集中實體的健康狀態相關資訊，以便輕鬆進行擷取和評估。</span><span class="sxs-lookup"><span data-stu-id="d8e08-119">The health store keeps health-related information about entities in the cluster for easy retrieval and evaluation.</span></span> <span data-ttu-id="d8e08-120">其會實作為 Service Fabric 保存的具狀態服務，以確保高可用性和延展性。</span><span class="sxs-lookup"><span data-stu-id="d8e08-120">It is implemented as a Service Fabric persisted stateful service to ensure high availability and scalability.</span></span> <span data-ttu-id="d8e08-121">健康狀態資料存放區是 **fabric:/System** 應用程式的一部分，在叢集已啟動且正在執行時可供使用。</span><span class="sxs-lookup"><span data-stu-id="d8e08-121">The health store is part of the **fabric:/System** application, and it is available when the cluster is up and running.</span></span>

## <a name="health-entities-and-hierarchy"></a><span data-ttu-id="d8e08-122">健康狀態實體和階層</span><span class="sxs-lookup"><span data-stu-id="d8e08-122">Health entities and hierarchy</span></span>
<span data-ttu-id="d8e08-123">健康狀態實體會在邏輯階層中組合管理，用來擷取不同實體之間的互動和相依性。</span><span class="sxs-lookup"><span data-stu-id="d8e08-123">The health entities are organized in a logical hierarchy that captures interactions and dependencies among different entities.</span></span> <span data-ttu-id="d8e08-124">健康狀態存放區會依照從 Service Fabric 元件收到的報告，自動建置健康情況實體和階層。</span><span class="sxs-lookup"><span data-stu-id="d8e08-124">The health store automatically builds health entities and hierarchy based on reports received from Service Fabric components.</span></span>

<span data-ttu-id="d8e08-125">健康狀態實體會鏡像處理 Service Fabric 實體</span><span class="sxs-lookup"><span data-stu-id="d8e08-125">The health entities mirror the Service Fabric entities.</span></span> <span data-ttu-id="d8e08-126">(例如，**健康狀態應用程式實體**符合部署於叢集中的應用程式執行個體，而**健康狀態節點實體**符合 Service Fabric 叢集節點)。健康狀態階層會擷取系統實體的互動，並作為進階健康狀態評估的基礎。</span><span class="sxs-lookup"><span data-stu-id="d8e08-126">(For example, **health application entity** matches an application instance deployed in the cluster, while **health node entity** matches a Service Fabric cluster node.) The health hierarchy captures the interactions of the system entities, and it is the basis for advanced health evaluation.</span></span> <span data-ttu-id="d8e08-127">您可以在 [Service Fabric 技術概觀](service-fabric-technical-overview.md)中了解重要的 Service Fabric 概念。</span><span class="sxs-lookup"><span data-stu-id="d8e08-127">You can learn about key Service Fabric concepts in [Service Fabric technical overview](service-fabric-technical-overview.md).</span></span> <span data-ttu-id="d8e08-128">如需應用程式的詳細資訊，請參閱 [Service Fabric 應用程式模型](service-fabric-application-model.md)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-128">For more on application, see [Service Fabric application model](service-fabric-application-model.md).</span></span>

<span data-ttu-id="d8e08-129">健康狀態實體和階層可讓您有效率地報告、偵錯和監視叢集和應用程式。</span><span class="sxs-lookup"><span data-stu-id="d8e08-129">The health entities and hierarchy allow the cluster and applications to be effectively reported, debugged, and monitored.</span></span> <span data-ttu-id="d8e08-130">健康狀態模型可針對叢集中許多移動的項目提供精確且「細微」  的健康狀態呈現方式。</span><span class="sxs-lookup"><span data-stu-id="d8e08-130">The health model provides an accurate, *granular* representation of the health of the many moving pieces in the cluster.</span></span>

<span data-ttu-id="d8e08-131">![健康狀態實體][1]。</span><span class="sxs-lookup"><span data-stu-id="d8e08-131">![Health entities.][1]</span></span>
<span data-ttu-id="d8e08-132">階層中的健康狀態實體將依照父系-子系關聯性組合管理。</span><span class="sxs-lookup"><span data-stu-id="d8e08-132">The health entities, organized in a hierarchy based on parent-child relationships.</span></span>

[1]: ./media/service-fabric-health-introduction/servicefabric-health-hierarchy.png

<span data-ttu-id="d8e08-133">健康狀態實體包含：</span><span class="sxs-lookup"><span data-stu-id="d8e08-133">The health entities are:</span></span>

* <span data-ttu-id="d8e08-134">**叢集**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-134">**Cluster**.</span></span> <span data-ttu-id="d8e08-135">表示 Service Fabric 叢集的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-135">Represents the health of a Service Fabric cluster.</span></span> <span data-ttu-id="d8e08-136">叢集健康情況報告會說明影響整體叢集的條件。</span><span class="sxs-lookup"><span data-stu-id="d8e08-136">Cluster health reports describe conditions that affect the entire cluster.</span></span> <span data-ttu-id="d8e08-137">這些條件會影響叢集中的多個實體或叢集本身。</span><span class="sxs-lookup"><span data-stu-id="d8e08-137">These conditions affect multiple entities in the cluster or the cluster itself.</span></span> <span data-ttu-id="d8e08-138">據此條件，此報告無法將問題縮小到一或多個狀況不良的子系。</span><span class="sxs-lookup"><span data-stu-id="d8e08-138">Based on the condition, the reporter can't narrow the issue down to one or more unhealthy children.</span></span> <span data-ttu-id="d8e08-139">範例包括因網路分割或通訊問題而造成叢集核心分裂。</span><span class="sxs-lookup"><span data-stu-id="d8e08-139">Examples include the brain of the cluster splitting due to network partitioning or communication issues.</span></span>
* <span data-ttu-id="d8e08-140">**節點**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-140">**Node**.</span></span> <span data-ttu-id="d8e08-141">表示 Service Fabric 節點的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-141">Represents the health of a Service Fabric node.</span></span> <span data-ttu-id="d8e08-142">節點健康狀態報告會說明影響節點功能的條件。</span><span class="sxs-lookup"><span data-stu-id="d8e08-142">Node health reports describe conditions that affect the node functionality.</span></span> <span data-ttu-id="d8e08-143">它們通常會影響在其上執行的所有已部署的實體。</span><span class="sxs-lookup"><span data-stu-id="d8e08-143">They typically affect all the deployed entities running on it.</span></span> <span data-ttu-id="d8e08-144">範例包括節點的磁碟空間不足 (或其他電腦全域屬性，例如記憶體、連線) 以及節點已關閉時。</span><span class="sxs-lookup"><span data-stu-id="d8e08-144">Examples include node out of disk space (or other machine-wide properties, such as memory, connections) and when a node is down.</span></span> <span data-ttu-id="d8e08-145">節點實體將透過節點名稱 (字串) 來識別。</span><span class="sxs-lookup"><span data-stu-id="d8e08-145">The node entity is identified by the node name (string).</span></span>
* <span data-ttu-id="d8e08-146">**應用程式**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-146">**Application**.</span></span> <span data-ttu-id="d8e08-147">表示叢集中所執行應用程式執行個體的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-147">Represents the health of an application instance running in the cluster.</span></span> <span data-ttu-id="d8e08-148">應用程式健康狀態報告會說明影響應用程式整體健康狀態的條件。</span><span class="sxs-lookup"><span data-stu-id="d8e08-148">Application health reports describe conditions that affect the overall health of the application.</span></span> <span data-ttu-id="d8e08-149">它們不能將範圍縮小至個別的子系 (服務或已部署的應用程式)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-149">They can't be narrowed down to individual children (services or deployed applications).</span></span> <span data-ttu-id="d8e08-150">範例包括應用程式中不同服務之間的端對端互動。</span><span class="sxs-lookup"><span data-stu-id="d8e08-150">Examples include the end-to-end interaction among different services in the application.</span></span> <span data-ttu-id="d8e08-151">應用程式實體將透過應用程式名稱 (URI) 來識別。</span><span class="sxs-lookup"><span data-stu-id="d8e08-151">The application entity is identified by the application name (URI).</span></span>
* <span data-ttu-id="d8e08-152">**服務**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-152">**Service**.</span></span> <span data-ttu-id="d8e08-153">表示叢集中所執行服務的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-153">Represents the health of a service running in the cluster.</span></span> <span data-ttu-id="d8e08-154">服務健康情況報告會說明影響服務整體健康狀態的條件。</span><span class="sxs-lookup"><span data-stu-id="d8e08-154">Service health reports describe conditions that affect the overall health of the service.</span></span> <span data-ttu-id="d8e08-155">此報告無法將問題縮小為狀況不良的磁碟分割或複本。</span><span class="sxs-lookup"><span data-stu-id="d8e08-155">The reporter can't narrow down the issue to an unhealthy partition or replica.</span></span> <span data-ttu-id="d8e08-156">範例包括造成所有分割區發生問題的服務組態 (例如，連接埠或外部檔案共用)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-156">Examples include a service configuration (such as port or external file share) that is causing issues for all partitions.</span></span> <span data-ttu-id="d8e08-157">服務實體將透過服務名稱 (URI) 來識別。</span><span class="sxs-lookup"><span data-stu-id="d8e08-157">The service entity is identified by the service name (URI).</span></span>
* <span data-ttu-id="d8e08-158">**資料分割**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-158">**Partition**.</span></span> <span data-ttu-id="d8e08-159">表示服務資料分割的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-159">Represents the health of a service partition.</span></span> <span data-ttu-id="d8e08-160">資料分割健康狀態報告會說明影響整體複本集的條件。</span><span class="sxs-lookup"><span data-stu-id="d8e08-160">Partition health reports describe conditions that affect the entire replica set.</span></span> <span data-ttu-id="d8e08-161">範例包括當複本的數目低於目標計數以及當分割區發生仲裁遺失時。</span><span class="sxs-lookup"><span data-stu-id="d8e08-161">Examples include when the number of replicas is below target count and when a partition is in quorum loss.</span></span> <span data-ttu-id="d8e08-162">分割區實體將透過分割識別碼 (GUID) 來識別。</span><span class="sxs-lookup"><span data-stu-id="d8e08-162">The partition entity is identified by the partition ID (GUID).</span></span>
* <span data-ttu-id="d8e08-163">**複本**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-163">**Replica**.</span></span> <span data-ttu-id="d8e08-164">表示具狀態服務複本或無狀態服務執行個體的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-164">Represents the health of a stateful service replica or a stateless service instance.</span></span> <span data-ttu-id="d8e08-165">複本是看門狗和系統元件可針對應用程式進行報告的最小單位。</span><span class="sxs-lookup"><span data-stu-id="d8e08-165">The replica is the smallest unit that watchdogs and system components can report on for an application.</span></span> <span data-ttu-id="d8e08-166">針對具狀態服務，範例包括無法將作業複寫至次要資料庫並使複寫變慢的主要複本。</span><span class="sxs-lookup"><span data-stu-id="d8e08-166">For stateful services, examples include a primary replica that can't replicate operations to secondaries and slow replication.</span></span> <span data-ttu-id="d8e08-167">此外，若無狀態的執行個體在執行時資源不足或發生連線問題，則其會進行報告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-167">Also, a stateless instance can report when it is running out of resources or has connectivity issues.</span></span> <span data-ttu-id="d8e08-168">複本實體將透過分割識別碼 (GUID) 以及複本或執行個體識別碼 (完整) 來識別。</span><span class="sxs-lookup"><span data-stu-id="d8e08-168">The replica entity is identified by the partition ID (GUID) and the replica or instance ID (long).</span></span>
* <span data-ttu-id="d8e08-169">**已部署應用程式**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-169">**DeployedApplication**.</span></span> <span data-ttu-id="d8e08-170">表示 *節點上所執行應用程式*的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-170">Represents the health of an *application running on a node*.</span></span> <span data-ttu-id="d8e08-171">已部署應用程式健康狀態報告會描述專屬於節點上應用程式的條件，且無法將範圍縮小至部署在相同節點上的服務封裝。</span><span class="sxs-lookup"><span data-stu-id="d8e08-171">Deployed application health reports describe conditions specific to the application on the node that can't be narrowed down to service packages deployed on the same node.</span></span> <span data-ttu-id="d8e08-172">範例包括無法在該節點上下載應用程式套件時，以及在節點上設定應用程式安全性主體時發生問題。</span><span class="sxs-lookup"><span data-stu-id="d8e08-172">Examples include errors when application package can't be downloaded on that node and issues setting up application security principals on the node.</span></span> <span data-ttu-id="d8e08-173">已部署的應用程式將透過應用程式名稱 (URI) 和節點名稱 (字串) 來識別。</span><span class="sxs-lookup"><span data-stu-id="d8e08-173">The deployed application is identified by application name (URI) and node name (string).</span></span>
* <span data-ttu-id="d8e08-174">**已部署服務封裝**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-174">**DeployedServicePackage**.</span></span> <span data-ttu-id="d8e08-175">表示叢集的節點上所執行的服務封裝的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-175">Represents the health of a service package running on a node in the cluster.</span></span> <span data-ttu-id="d8e08-176">其會描述專屬於服務封裝的條件，該條件對於相同應用程式之相同節點上的其他服務封裝不會造成影響。</span><span class="sxs-lookup"><span data-stu-id="d8e08-176">It describes conditions specific to a service package that do not affect the other service packages on the same node for the same application.</span></span> <span data-ttu-id="d8e08-177">範例包括服務封裝中的程式碼封裝無法啟動，以及無法讀取組態封裝。</span><span class="sxs-lookup"><span data-stu-id="d8e08-177">Examples include a code package in the service package that cannot be started and a configuration package that cannot be read.</span></span> <span data-ttu-id="d8e08-178">已部署的服務套件將透過應用程式名稱 (URI)、節點名稱 (字串) 和服務資訊清單名稱 (字串) 來識別。</span><span class="sxs-lookup"><span data-stu-id="d8e08-178">The deployed service package is identified by application name (URI), node name (string), service manifest name (string), and service package activation ID (string).</span></span>

<span data-ttu-id="d8e08-179">健康狀態模型的細微性可讓您輕鬆地偵測並更正問題。</span><span class="sxs-lookup"><span data-stu-id="d8e08-179">The granularity of the health model makes it easy to detect and correct issues.</span></span> <span data-ttu-id="d8e08-180">例如，如果服務沒有回應，則可報告應用程式執行個體的狀況不良。</span><span class="sxs-lookup"><span data-stu-id="d8e08-180">For example, if a service is not responding, it is feasible to report that the application instance is unhealthy.</span></span> <span data-ttu-id="d8e08-181">但在該層級上回報並不理想，因為問題可能不會影響該應用程式中的所有服務。</span><span class="sxs-lookup"><span data-stu-id="d8e08-181">Reporting at that level is not ideal, however, because the issue might not be affecting all the services within that application.</span></span> <span data-ttu-id="d8e08-182">報告應套用至狀況不良的服務上，或者若有更多資訊指向特定的子系分割區，則套用至該分割區上。</span><span class="sxs-lookup"><span data-stu-id="d8e08-182">The report should be applied to the unhealthy service or to a specific child partition, if more information points to that partition.</span></span> <span data-ttu-id="d8e08-183">資料將自動浮現於階層中，而狀況不良的分割區將顯示於服務和應用程式層級上。</span><span class="sxs-lookup"><span data-stu-id="d8e08-183">The data automatically surfaces through the hierarchy, and an unhealthy partition is made visible at service and application levels.</span></span> <span data-ttu-id="d8e08-184">此彙總可協助您更快速找出並解決問題的根本原因。</span><span class="sxs-lookup"><span data-stu-id="d8e08-184">This aggregation helps to pinpoint and resolve the root cause of the issue more quickly.</span></span>

<span data-ttu-id="d8e08-185">健康狀態階層是由父系-子系關聯性所組成。</span><span class="sxs-lookup"><span data-stu-id="d8e08-185">The health hierarchy is composed of parent-child relationships.</span></span> <span data-ttu-id="d8e08-186">叢集是由節點和應用程式所組成。</span><span class="sxs-lookup"><span data-stu-id="d8e08-186">A cluster is composed of nodes and applications.</span></span> <span data-ttu-id="d8e08-187">應用程式包含服務和已部署的應用程式。</span><span class="sxs-lookup"><span data-stu-id="d8e08-187">Applications have services and deployed applications.</span></span> <span data-ttu-id="d8e08-188">已部署的應用程式包含已部署的服務封裝。</span><span class="sxs-lookup"><span data-stu-id="d8e08-188">Deployed applications have deployed service packages.</span></span> <span data-ttu-id="d8e08-189">服務包含資料分割，且每個資料分割包含一個或多個複本。</span><span class="sxs-lookup"><span data-stu-id="d8e08-189">Services have partitions, and each partition has one or more replicas.</span></span> <span data-ttu-id="d8e08-190">節點和已部署實體之間具有特殊關聯性。</span><span class="sxs-lookup"><span data-stu-id="d8e08-190">There is a special relationship between nodes and deployed entities.</span></span> <span data-ttu-id="d8e08-191">由其授權單位系統元件 (容錯移轉管理員服務) 報告為健康情況不良的節點，會影響已部署的應用程式、服務套件，以及部署於其中的複本。</span><span class="sxs-lookup"><span data-stu-id="d8e08-191">An unhealthy node as reported by its authority system component, the Failover Manager service, affects the deployed applications, service packages, and replicas deployed on it.</span></span>

<span data-ttu-id="d8e08-192">健康狀態階層會依照最新健康狀態報告來表示系統的最新狀態，且幾乎是即時資訊。</span><span class="sxs-lookup"><span data-stu-id="d8e08-192">The health hierarchy represents the latest state of the system based on the latest health reports, which is almost real-time information.</span></span>
<span data-ttu-id="d8e08-193">內部和外部看門狗可以依照應用程式特定邏輯或自訂監視的條件來報告相同實體。</span><span class="sxs-lookup"><span data-stu-id="d8e08-193">Internal and external watchdogs can report on the same entities based on application-specific logic or custom monitored conditions.</span></span> <span data-ttu-id="d8e08-194">使用者報告會與系統報告同時存在。</span><span class="sxs-lookup"><span data-stu-id="d8e08-194">User reports coexist with the system reports.</span></span>

<span data-ttu-id="d8e08-195">在設計大型雲端服務期間，投入時間規劃如何報告和回應健康情況。</span><span class="sxs-lookup"><span data-stu-id="d8e08-195">Plan to invest in how to report and respond to health during the design of a large cloud service.</span></span> <span data-ttu-id="d8e08-196">此預先投入可讓您更輕鬆地偵錯、監視和操作該服務。</span><span class="sxs-lookup"><span data-stu-id="d8e08-196">This up-front investement makes the service easier to debug, monitor, and operate.</span></span>

## <a name="health-states"></a><span data-ttu-id="d8e08-197">健康狀態</span><span class="sxs-lookup"><span data-stu-id="d8e08-197">Health states</span></span>
<span data-ttu-id="d8e08-198">Service Fabric 會使用三種健康狀態來描述實體的健康狀態是否良好：「OK」、「Warning」和「Error」。</span><span class="sxs-lookup"><span data-stu-id="d8e08-198">Service Fabric uses three health states to describe whether an entity is healthy or not: OK, warning, and error.</span></span> <span data-ttu-id="d8e08-199">傳送至健康狀態資料存放區的任何報告都必須指定這其中一個狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-199">Any report sent to the health store must specify one of these states.</span></span> <span data-ttu-id="d8e08-200">健康狀態評估結果即為這些狀態的其中之一。</span><span class="sxs-lookup"><span data-stu-id="d8e08-200">The health evaluation result is one of these states.</span></span>

<span data-ttu-id="d8e08-201">可能的 [健康狀態](https://docs.microsoft.com/dotnet/api/system.fabric.health.healthstate) 為：</span><span class="sxs-lookup"><span data-stu-id="d8e08-201">The possible [health states](https://docs.microsoft.com/dotnet/api/system.fabric.health.healthstate) are:</span></span>

* <span data-ttu-id="d8e08-202">**OK**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-202">**OK**.</span></span> <span data-ttu-id="d8e08-203">實體的健康狀態良好。</span><span class="sxs-lookup"><span data-stu-id="d8e08-203">The entity is healthy.</span></span> <span data-ttu-id="d8e08-204">報告實體本身或其子系 (適用時) 沒有已知問題。</span><span class="sxs-lookup"><span data-stu-id="d8e08-204">There are no known issues reported on it or its children (when applicable).</span></span>
* <span data-ttu-id="d8e08-205">**Warning**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-205">**Warning**.</span></span> <span data-ttu-id="d8e08-206">實體發生一些問題，但仍可正常運作。</span><span class="sxs-lookup"><span data-stu-id="d8e08-206">The entity has some issues, but it can still function correctly.</span></span> <span data-ttu-id="d8e08-207">例如，發生延遲，但尚未造成任何功能上的問題。</span><span class="sxs-lookup"><span data-stu-id="d8e08-207">For example, there are delays, but they do not cause any functional issues yet.</span></span> <span data-ttu-id="d8e08-208">在某些情況下，不需外部介入，警告狀況即可本身進行修正。</span><span class="sxs-lookup"><span data-stu-id="d8e08-208">In some cases, the warning condition may fix itself without external intervention.</span></span> <span data-ttu-id="d8e08-209">在這些情況下，健康情況報告會引起關注，並提供後續狀況的可見性。</span><span class="sxs-lookup"><span data-stu-id="d8e08-209">In these cases, health reports raise awareness and provide visibility into what is going on.</span></span> <span data-ttu-id="d8e08-210">在其他情況中，「Warning」狀況可能會惡化為嚴重問題，但不需使用者介入。</span><span class="sxs-lookup"><span data-stu-id="d8e08-210">In other cases, the warning condition may degrade into a severe problem without user intervention.</span></span>
* <span data-ttu-id="d8e08-211">**Error**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-211">**Error**.</span></span> <span data-ttu-id="d8e08-212">實體的狀況不良。</span><span class="sxs-lookup"><span data-stu-id="d8e08-212">The entity is unhealthy.</span></span> <span data-ttu-id="d8e08-213">因為實體無法正常運作，故應採取動作來修正實體的狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-213">Action should be taken to fix the state of the entity, because it can't function properly.</span></span>
* <span data-ttu-id="d8e08-214">**Unknown**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-214">**Unknown**.</span></span> <span data-ttu-id="d8e08-215">實體不存在於健康狀態資料存放區中。</span><span class="sxs-lookup"><span data-stu-id="d8e08-215">The entity doesn't exist in the health store.</span></span> <span data-ttu-id="d8e08-216">此結果可以從合併來自多個元件之結果的分散式查詢中取得。</span><span class="sxs-lookup"><span data-stu-id="d8e08-216">This result can be obtained from the distributed queries that merge results from multiple components.</span></span> <span data-ttu-id="d8e08-217">例如，取得節點清單查詢會傳送至 **FailoverManager**、**ClusterManager** 和 **HealthManager**，而取得應用程式清單查詢會傳送至 **ClusterManager** 和 **HealthManager**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-217">For example, the get node list query goes to **FailoverManager**, **ClusterManager**, and **HealthManager**; get application list query goes to **ClusterManager** and **HealthManager**.</span></span> <span data-ttu-id="d8e08-218">這些查詢會合併來自多個系統元件的結果。</span><span class="sxs-lookup"><span data-stu-id="d8e08-218">These queries merge results from multiple system components.</span></span> <span data-ttu-id="d8e08-219">若其他系統元件傳回的實體不存在於健康情況存放區，則合併的查詢會處於未知的健康情況。</span><span class="sxs-lookup"><span data-stu-id="d8e08-219">If another system component returns an entity that is not present in health store, the merged result has unknown health state.</span></span> <span data-ttu-id="d8e08-220">因為尚未處理健康情況報告或實體已在刪除後清除，所以實體不在存放區中。</span><span class="sxs-lookup"><span data-stu-id="d8e08-220">An entity is not in store because health reports have not yet been processed or the entity has been cleaned up after deletion.</span></span>

## <a name="health-policies"></a><span data-ttu-id="d8e08-221">健康狀態原則</span><span class="sxs-lookup"><span data-stu-id="d8e08-221">Health policies</span></span>
<span data-ttu-id="d8e08-222">健康狀態資料存放區會套用健康狀態原則，依照它的報告及其子系來判斷實體的健康狀態是否良好。</span><span class="sxs-lookup"><span data-stu-id="d8e08-222">The health store applies health policies to determine whether an entity is healthy based on its reports and its children.</span></span>

> [!NOTE]
> <span data-ttu-id="d8e08-223">健康狀態原則可在叢集資訊清單 (適用於叢集和節點健康狀態評估) 或應用程式資訊清單 (適用於應用程式評估及其任何子系) 中指定。</span><span class="sxs-lookup"><span data-stu-id="d8e08-223">Health policies can be specified in the cluster manifest (for cluster and node health evaluation) or in the application manifest (for application evaluation and any of its children).</span></span> <span data-ttu-id="d8e08-224">健康情況評估要求也可傳入僅用於該評估的自訂健康情況評估原則。</span><span class="sxs-lookup"><span data-stu-id="d8e08-224">Health evaluation requests can also pass in custom health evaluation policies, which are used only for that evaluation.</span></span>
> 
> 

<span data-ttu-id="d8e08-225">根據預設，Service Fabric 適用於父系-子系階層式關聯性的嚴格規則 (所有項目都必須是狀況良好的) 。</span><span class="sxs-lookup"><span data-stu-id="d8e08-225">By default, Service Fabric applies strict rules (everything must be healthy) for the parent-child hierarchical relationship.</span></span> <span data-ttu-id="d8e08-226">如果有一個子系具有一個狀況不良的事件，就會將父系視為狀況不良。</span><span class="sxs-lookup"><span data-stu-id="d8e08-226">If even one of the children has one unhealthy event, the parent is considered unhealthy.</span></span>

### <a name="cluster-health-policy"></a><span data-ttu-id="d8e08-227">叢集健康狀態原則</span><span class="sxs-lookup"><span data-stu-id="d8e08-227">Cluster health policy</span></span>
<span data-ttu-id="d8e08-228">[叢集健康狀態原則](https://docs.microsoft.com/dotnet/api/system.fabric.health.clusterhealthpolicy) 是用來評估叢集健康狀態和節點健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-228">The [cluster health policy](https://docs.microsoft.com/dotnet/api/system.fabric.health.clusterhealthpolicy) is used to evaluate the cluster health state and node health states.</span></span> <span data-ttu-id="d8e08-229">原則可以定義於叢集資訊清單中。</span><span class="sxs-lookup"><span data-stu-id="d8e08-229">The policy can be defined in the cluster manifest.</span></span> <span data-ttu-id="d8e08-230">如果原則不存在，則會使用預設原則 (不容許失敗)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-230">If it is not present, the default policy (zero tolerated failures) is used.</span></span>
<span data-ttu-id="d8e08-231">叢集健康狀態原則包含：</span><span class="sxs-lookup"><span data-stu-id="d8e08-231">The cluster health policy contains:</span></span>

* <span data-ttu-id="d8e08-232">[ConsiderWarningAsError](https://docs.microsoft.com/dotnet/api/system.fabric.health.clusterhealthpolicy.considerwarningaserror)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-232">[ConsiderWarningAsError](https://docs.microsoft.com/dotnet/api/system.fabric.health.clusterhealthpolicy.considerwarningaserror).</span></span> <span data-ttu-id="d8e08-233">指定是否要在健康狀態評估期間將「Warning」健康狀態報告視為錯誤。</span><span class="sxs-lookup"><span data-stu-id="d8e08-233">Specifies whether to treat warning health reports as errors during health evaluation.</span></span> <span data-ttu-id="d8e08-234">預設：false。</span><span class="sxs-lookup"><span data-stu-id="d8e08-234">Default: false.</span></span>
* <span data-ttu-id="d8e08-235">[MaxPercentUnhealthyApplications](https://docs.microsoft.com/dotnet/api/system.fabric.health.clusterhealthpolicy.maxpercentunhealthyapplications)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-235">[MaxPercentUnhealthyApplications](https://docs.microsoft.com/dotnet/api/system.fabric.health.clusterhealthpolicy.maxpercentunhealthyapplications).</span></span> <span data-ttu-id="d8e08-236">指定在系統將叢集視為「Error」之前，對狀況不良之應用程式的最大容許百分比。</span><span class="sxs-lookup"><span data-stu-id="d8e08-236">Specifies the maximum tolerated percentage of applications that can be unhealthy before the cluster is considered in error.</span></span>
* <span data-ttu-id="d8e08-237">[MaxPercentUnhealthyNodes](https://docs.microsoft.com/dotnet/api/system.fabric.health.clusterhealthpolicy.maxpercentunhealthynodes)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-237">[MaxPercentUnhealthyNodes](https://docs.microsoft.com/dotnet/api/system.fabric.health.clusterhealthpolicy.maxpercentunhealthynodes).</span></span> <span data-ttu-id="d8e08-238">指定在系統將叢集視為「Error」之前，對狀況不良之節點的最大容許百分比。</span><span class="sxs-lookup"><span data-stu-id="d8e08-238">Specifies the maximum tolerated percentage of nodes that can be unhealthy before the cluster is considered in error.</span></span> <span data-ttu-id="d8e08-239">在大型叢集中，永遠都有一些節點會關閉或需要修復，因此應設定此百分比來容許這種情形。</span><span class="sxs-lookup"><span data-stu-id="d8e08-239">In large clusters, some nodes are always down or out for repairs, so this percentage should be configured to tolerate that.</span></span>
* <span data-ttu-id="d8e08-240">[ApplicationTypeHealthPolicyMap](https://docs.microsoft.com/dotnet/api/system.fabric.health.clusterhealthpolicy.applicationtypehealthpolicymap)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-240">[ApplicationTypeHealthPolicyMap](https://docs.microsoft.com/dotnet/api/system.fabric.health.clusterhealthpolicy.applicationtypehealthpolicymap).</span></span> <span data-ttu-id="d8e08-241">應用程式類型的健康狀態原則對應可以在叢集健康狀態評估期間，用來描述特殊的應用程式類型。</span><span class="sxs-lookup"><span data-stu-id="d8e08-241">The application type health policy map can be used during cluster health evaluation to describe special application types.</span></span> <span data-ttu-id="d8e08-242">根據預設，所有的應用程式都會放入集區，並使用 MaxPercentUnhealthyApplications 加以評估。</span><span class="sxs-lookup"><span data-stu-id="d8e08-242">By default, all applications are put into a pool and evaluated with MaxPercentUnhealthyApplications.</span></span> <span data-ttu-id="d8e08-243">如果某些應用程式類型應該以不同方式處理，則可以從全域集區中取出它們。</span><span class="sxs-lookup"><span data-stu-id="d8e08-243">If some application types should be treated differently, they can be taken out of the global pool.</span></span> <span data-ttu-id="d8e08-244">反之，則會根據對應中的應用程式類型名稱相關聯的百分比來評估它們。</span><span class="sxs-lookup"><span data-stu-id="d8e08-244">Instead, they are evaluated against the percentages associated with their application type name in the map.</span></span> <span data-ttu-id="d8e08-245">例如，在叢集中，有數千個不同類型的應用程式，以及某個特殊應用程式類型的數個控制應用程式執行個體。</span><span class="sxs-lookup"><span data-stu-id="d8e08-245">For example, in a cluster there are thousands of applications of different types, and a few control application instances of a special application type.</span></span> <span data-ttu-id="d8e08-246">控制應用程式應該絕對不會發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="d8e08-246">The control applications should never be in error.</span></span> <span data-ttu-id="d8e08-247">您可以將全域的 MaxPercentUnhealthyApplications 指定為 20%，以容許一些失敗，但如果應用程式類型為 "ControlApplicationType"，請將 MaxPercentUnhealthyApplications 設為 0。</span><span class="sxs-lookup"><span data-stu-id="d8e08-247">You can specify global MaxPercentUnhealthyApplications to 20% to tolerate some failures, but for the application type "ControlApplicationType" set the MaxPercentUnhealthyApplications to 0.</span></span> <span data-ttu-id="d8e08-248">如此一來，如果這許多應用程式中有一些的狀況不良，但低於全域狀況不良的百分比，則會將叢集評估為 Warning。</span><span class="sxs-lookup"><span data-stu-id="d8e08-248">This way, if some of the many applications are unhealthy, but below the global unhealthy percentage, the cluster would be evaluated to Warning.</span></span> <span data-ttu-id="d8e08-249">Warning 健康狀態並不會影響叢集升級或由 Error 健康狀態觸發的其他監視。</span><span class="sxs-lookup"><span data-stu-id="d8e08-249">A warning health state does not impact cluster upgrade or other monitoring triggered by Error health state.</span></span> <span data-ttu-id="d8e08-250">但是，即使只有一個控制應用程式錯誤，也會造成叢集狀況不良，視升級組態而定，這將會觸發回復或暫停叢集升級。</span><span class="sxs-lookup"><span data-stu-id="d8e08-250">But even one control application in error would make cluster unhealthy, which triggers roll back or pauses the cluster upgrade, depending on the upgrade configuration.</span></span>
  <span data-ttu-id="d8e08-251">對於對應中定義的應用程式類型，所有的應用程式執行個體都是從應用程式的全域集區中所取出。</span><span class="sxs-lookup"><span data-stu-id="d8e08-251">For the application types defined in the map, all application instances are taken out of the global pool of applications.</span></span> <span data-ttu-id="d8e08-252">系統會使用對應的特定 MaxPercentUnhealthyApplications，根據應用程式類型的應用程式總數來評估它們。</span><span class="sxs-lookup"><span data-stu-id="d8e08-252">They are evaluated based on the total number of applications of the application type, using the specific MaxPercentUnhealthyApplications from the map.</span></span> <span data-ttu-id="d8e08-253">所有其他的應用程式都會保留於全域集區中，並使用 MaxPercentUnhealthyApplications 加以評估。</span><span class="sxs-lookup"><span data-stu-id="d8e08-253">All the rest of the applications remain in the global pool and are evaluated with MaxPercentUnhealthyApplications.</span></span>

<span data-ttu-id="d8e08-254">下列範例是來自叢集資訊清單的摘要。</span><span class="sxs-lookup"><span data-stu-id="d8e08-254">The following example is an excerpt from a cluster manifest.</span></span> <span data-ttu-id="d8e08-255">若要定義應用程式類型對應中的項目，請在參數名稱前面加上 "ApplicationTypeMaxPercentUnhealthyApplications-"，後面接著應用程式類型名稱。</span><span class="sxs-lookup"><span data-stu-id="d8e08-255">To define entries in the application type map, prefix the parameter name with "ApplicationTypeMaxPercentUnhealthyApplications-", followed by the application type name.</span></span>

```xml
<FabricSettings>
  <Section Name="HealthManager/ClusterHealthPolicy">
    <Parameter Name="ConsiderWarningAsError" Value="False" />
    <Parameter Name="MaxPercentUnhealthyApplications" Value="20" />
    <Parameter Name="MaxPercentUnhealthyNodes" Value="20" />
    <Parameter Name="ApplicationTypeMaxPercentUnhealthyApplications-ControlApplicationType" Value="0" />
  </Section>
</FabricSettings>
```

### <a name="application-health-policy"></a><span data-ttu-id="d8e08-256">應用程式健康狀態原則</span><span class="sxs-lookup"><span data-stu-id="d8e08-256">Application health policy</span></span>
<span data-ttu-id="d8e08-257">[應用程式健康狀態原則](https://docs.microsoft.com/dotnet/api/system.fabric.health.applicationhealthpolicy) 會針對應用程式及其子系，說明完成事件和子系狀態彙總評估的方式。</span><span class="sxs-lookup"><span data-stu-id="d8e08-257">The [application health policy](https://docs.microsoft.com/dotnet/api/system.fabric.health.applicationhealthpolicy) describes how the evaluation of events and child-states aggregation is done for applications and their children.</span></span> <span data-ttu-id="d8e08-258">在應用程式封裝中，它可以定義於應用程式資訊清單 (即 **ApplicationManifest.xml**) 中。</span><span class="sxs-lookup"><span data-stu-id="d8e08-258">It can be defined in the application manifest, **ApplicationManifest.xml**, in the application package.</span></span> <span data-ttu-id="d8e08-259">若未指定任何原則，則當健康狀態報告或子系處於「Warning」或「Error」健康狀態時，Service Fabric 會假設實體狀況不良。</span><span class="sxs-lookup"><span data-stu-id="d8e08-259">If no policies are specified, Service Fabric assumes that the entity is unhealthy if it has a health report or a child at the warning or error health state.</span></span>
<span data-ttu-id="d8e08-260">可設定的原則包含：</span><span class="sxs-lookup"><span data-stu-id="d8e08-260">The configurable policies are:</span></span>

* <span data-ttu-id="d8e08-261">[ConsiderWarningAsError](https://docs.microsoft.com/dotnet/api/system.fabric.health.applicationhealthpolicy.considerwarningaserror.aspx)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-261">[ConsiderWarningAsError](https://docs.microsoft.com/dotnet/api/system.fabric.health.applicationhealthpolicy.considerwarningaserror.aspx).</span></span> <span data-ttu-id="d8e08-262">指定是否要在健康狀態評估期間將「Warning」健康狀態報告視為錯誤。</span><span class="sxs-lookup"><span data-stu-id="d8e08-262">Specifies whether to treat warning health reports as errors during health evaluation.</span></span> <span data-ttu-id="d8e08-263">預設：false。</span><span class="sxs-lookup"><span data-stu-id="d8e08-263">Default: false.</span></span>
* <span data-ttu-id="d8e08-264">[MaxPercentUnhealthyDeployedApplications](https://docs.microsoft.com/dotnet/api/system.fabric.health.applicationhealthpolicy.maxpercentunhealthydeployedapplications)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-264">[MaxPercentUnhealthyDeployedApplications](https://docs.microsoft.com/dotnet/api/system.fabric.health.applicationhealthpolicy.maxpercentunhealthydeployedapplications).</span></span> <span data-ttu-id="d8e08-265">指定在系統將應用程式視為「Error」之前，對狀況不良之已部署應用程式的最大容許百分比。</span><span class="sxs-lookup"><span data-stu-id="d8e08-265">Specifies the maximum tolerated percentage of deployed applications that can be unhealthy before the application is considered in error.</span></span> <span data-ttu-id="d8e08-266">此百分比的計算方式是將狀況不良的已部署應用程式數目，除以叢集中目前部署應用程式的節點數目。</span><span class="sxs-lookup"><span data-stu-id="d8e08-266">This percentage is calculated by dividing the number of unhealthy deployed applications over the number of nodes that the applications are currently deployed on in the cluster.</span></span> <span data-ttu-id="d8e08-267">針對較少的節點數目，計算會四捨五入以容許一個失敗。</span><span class="sxs-lookup"><span data-stu-id="d8e08-267">The computation rounds up to tolerate one failure on small numbers of nodes.</span></span> <span data-ttu-id="d8e08-268">預設百分比：零。</span><span class="sxs-lookup"><span data-stu-id="d8e08-268">Default percentage: zero.</span></span>
* <span data-ttu-id="d8e08-269">[DefaultServiceTypeHealthPolicy](https://docs.microsoft.com/dotnet/api/system.fabric.health.applicationhealthpolicy.defaultservicetypehealthpolicy)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-269">[DefaultServiceTypeHealthPolicy](https://docs.microsoft.com/dotnet/api/system.fabric.health.applicationhealthpolicy.defaultservicetypehealthpolicy).</span></span> <span data-ttu-id="d8e08-270">指定預設服務類型健康狀態原則，這會取代應用程式中所有服務類型的預設健康狀態原則。</span><span class="sxs-lookup"><span data-stu-id="d8e08-270">Specifies the default service type health policy, which replaces the default health policy for all service types in the application.</span></span>
* <span data-ttu-id="d8e08-271">[ServiceTypeHealthPolicyMap](https://docs.microsoft.com/dotnet/api/system.fabric.health.applicationhealthpolicy.servicetypehealthpolicymap)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-271">[ServiceTypeHealthPolicyMap](https://docs.microsoft.com/dotnet/api/system.fabric.health.applicationhealthpolicy.servicetypehealthpolicymap).</span></span> <span data-ttu-id="d8e08-272">針對每個服務類型提供服務健康狀態原則的對應。</span><span class="sxs-lookup"><span data-stu-id="d8e08-272">Provides a map of service health policies per service type.</span></span> <span data-ttu-id="d8e08-273">這些原則會取代每個指定服務類型的預設服務類型健康狀態原則。</span><span class="sxs-lookup"><span data-stu-id="d8e08-273">These policies replace the default service type health policies for each specified service type.</span></span> <span data-ttu-id="d8e08-274">例如，如果應用程式具有無狀態閘道服務類型和具狀態引擎服務類型，您可以設定不同的健康狀態原則來評估它們。</span><span class="sxs-lookup"><span data-stu-id="d8e08-274">For example, if an application has a stateless gateway service type and a stateful engine service type, you can configure the health policies for their evaluation differently.</span></span> <span data-ttu-id="d8e08-275">當您針對每個服務類型指定原則時，可以對服務的健康狀態取得更細微的控制。</span><span class="sxs-lookup"><span data-stu-id="d8e08-275">When you specify policy per service type, you can gain more granular control of the health of the service.</span></span>

### <a name="service-type-health-policy"></a><span data-ttu-id="d8e08-276">服務類型健康狀態原則</span><span class="sxs-lookup"><span data-stu-id="d8e08-276">Service type health policy</span></span>
<span data-ttu-id="d8e08-277">[服務類型健康狀態原則](https://docs.microsoft.com/dotnet/api/system.fabric.health.servicetypehealthpolicy) 會指定評估和彙總服務及服務子系的方式。</span><span class="sxs-lookup"><span data-stu-id="d8e08-277">The [service type health policy](https://docs.microsoft.com/dotnet/api/system.fabric.health.servicetypehealthpolicy) specifies how to evaluate and aggregate the services and the children of services.</span></span> <span data-ttu-id="d8e08-278">原則包含：</span><span class="sxs-lookup"><span data-stu-id="d8e08-278">The policy contains:</span></span>

* <span data-ttu-id="d8e08-279">[MaxPercentUnhealthyPartitionsPerService](https://docs.microsoft.com/dotnet/api/system.fabric.health.servicetypehealthpolicy.maxpercentunhealthypartitionsperservice)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-279">[MaxPercentUnhealthyPartitionsPerService](https://docs.microsoft.com/dotnet/api/system.fabric.health.servicetypehealthpolicy.maxpercentunhealthypartitionsperservice).</span></span> <span data-ttu-id="d8e08-280">指定在系統將服務視為狀況不良之前，狀況不良之分割區的最大容許百分比。</span><span class="sxs-lookup"><span data-stu-id="d8e08-280">Specifies the maximum tolerated percentage of unhealthy partitions before a service is considered unhealthy.</span></span> <span data-ttu-id="d8e08-281">預設百分比：零。</span><span class="sxs-lookup"><span data-stu-id="d8e08-281">Default percentage: zero.</span></span>
* <span data-ttu-id="d8e08-282">[MaxPercentUnhealthyReplicasPerPartition](https://docs.microsoft.com/dotnet/api/system.fabric.health.servicetypehealthpolicy.maxpercentunhealthyreplicasperpartition)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-282">[MaxPercentUnhealthyReplicasPerPartition](https://docs.microsoft.com/dotnet/api/system.fabric.health.servicetypehealthpolicy.maxpercentunhealthyreplicasperpartition).</span></span> <span data-ttu-id="d8e08-283">指定在系統將分割區視為狀況不良之前，狀況不良之複本的最大容許百分比。</span><span class="sxs-lookup"><span data-stu-id="d8e08-283">Specifies the maximum tolerated percentage of unhealthy replicas before a partition is considered unhealthy.</span></span> <span data-ttu-id="d8e08-284">預設百分比：零。</span><span class="sxs-lookup"><span data-stu-id="d8e08-284">Default percentage: zero.</span></span>
* <span data-ttu-id="d8e08-285">[MaxPercentUnhealthyServices](https://docs.microsoft.com/dotnet/api/system.fabric.health.servicetypehealthpolicy.maxpercentunhealthyservices)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-285">[MaxPercentUnhealthyServices](https://docs.microsoft.com/dotnet/api/system.fabric.health.servicetypehealthpolicy.maxpercentunhealthyservices).</span></span> <span data-ttu-id="d8e08-286">指定在系統將應用程式視為狀況不良之前，狀況不良之服務的最大容許百分比。</span><span class="sxs-lookup"><span data-stu-id="d8e08-286">Specifies the maximum tolerated percentage of unhealthy services before the application is considered unhealthy.</span></span> <span data-ttu-id="d8e08-287">預設百分比：零。</span><span class="sxs-lookup"><span data-stu-id="d8e08-287">Default percentage: zero.</span></span>

<span data-ttu-id="d8e08-288">下列範例是來自應用程式資訊清單的摘要：</span><span class="sxs-lookup"><span data-stu-id="d8e08-288">The following example is an excerpt from an application manifest:</span></span>

```xml
    <Policies>
        <HealthPolicy ConsiderWarningAsError="true" MaxPercentUnhealthyDeployedApplications="20">
            <DefaultServiceTypeHealthPolicy
                   MaxPercentUnhealthyServices="0"
                   MaxPercentUnhealthyPartitionsPerService="10"
                   MaxPercentUnhealthyReplicasPerPartition="0"/>
            <ServiceTypeHealthPolicy ServiceTypeName="FrontEndServiceType"
                   MaxPercentUnhealthyServices="0"
                   MaxPercentUnhealthyPartitionsPerService="20"
                   MaxPercentUnhealthyReplicasPerPartition="0"/>
            <ServiceTypeHealthPolicy ServiceTypeName="BackEndServiceType"
                   MaxPercentUnhealthyServices="20"
                   MaxPercentUnhealthyPartitionsPerService="0"
                   MaxPercentUnhealthyReplicasPerPartition="0">
            </ServiceTypeHealthPolicy>
        </HealthPolicy>
    </Policies>
```

## <a name="health-evaluation"></a><span data-ttu-id="d8e08-289">健康狀態評估</span><span class="sxs-lookup"><span data-stu-id="d8e08-289">Health evaluation</span></span>
<span data-ttu-id="d8e08-290">使用者和自動化服務可以隨時評估任何實體的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-290">Users and automated services can evaluate health for any entity at any time.</span></span> <span data-ttu-id="d8e08-291">為了評估實體的健康狀態，健康狀態資料存放區會彙總實體的所有健康狀態報告，並評估其所有子系 (適用時)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-291">To evaluate an entity's health, the health store aggregates all health reports on the entity and evaluates all its children (when applicable).</span></span> <span data-ttu-id="d8e08-292">健康狀態彙總演算法會使用健康狀態原則，來指定如何評估健康狀態報告，以及如何彙總子系健康狀態 (適用時)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-292">The health aggregation algorithm uses health policies that specify how to evaluate health reports and how to aggregate child health states (when applicable).</span></span>

### <a name="health-report-aggregation"></a><span data-ttu-id="d8e08-293">健康狀態報告彙總</span><span class="sxs-lookup"><span data-stu-id="d8e08-293">Health report aggregation</span></span>
<span data-ttu-id="d8e08-294">一個實體可以具有由不同回報者針對不同屬性 (系統元件或看門狗) 所傳送的多個健康狀態報告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-294">One entity can have multiple health reports sent by different reporters (system components or watchdogs) on different properties.</span></span> <span data-ttu-id="d8e08-295">彙總會使用相關聯的健康狀態原則，特別是應用程式的 ConsiderWarningAsError 成員或叢集健康狀態原則。</span><span class="sxs-lookup"><span data-stu-id="d8e08-295">The aggregation uses the associated health policies, in particular the ConsiderWarningAsError member of application or cluster health policy.</span></span> <span data-ttu-id="d8e08-296">ConsiderWarningAsError 指定如何評估警告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-296">ConsiderWarningAsError specifies how to evaluate warnings.</span></span>

<span data-ttu-id="d8e08-297">已彙總健康狀態是由實體上的 *最差* 健康狀態報告所觸發。</span><span class="sxs-lookup"><span data-stu-id="d8e08-297">The aggregated health state is triggered by the *worst* health reports on the entity.</span></span> <span data-ttu-id="d8e08-298">若至少有一個「Error」健康狀態報告存在，則已彙總的健康狀態會顯示為錯誤。</span><span class="sxs-lookup"><span data-stu-id="d8e08-298">If there is at least one error health report, the aggregated health state is an error.</span></span>

![健康狀態報告彙總，包含「Error」報告。][2]

<span data-ttu-id="d8e08-300">有一或多個錯誤健康狀態報告的健康狀態實體會評估為「錯誤」。</span><span class="sxs-lookup"><span data-stu-id="d8e08-300">A health entity that has one or more error health reports is evaluated as Error.</span></span> <span data-ttu-id="d8e08-301">已過期的健康狀態報告，不論其健康狀態如何，結果也是如此。</span><span class="sxs-lookup"><span data-stu-id="d8e08-301">The same is true for an expired health report, regardless of its health state.</span></span>

[2]: ./media/service-fabric-health-introduction/servicefabric-health-report-eval-error.png

<span data-ttu-id="d8e08-302">如果沒有任何「Error」報告以及一或多個「Warning」，則根據 ConsiderWarningAsError 原則旗標而定，已彙總的健康狀態可能會是「Warning」或「Error」。</span><span class="sxs-lookup"><span data-stu-id="d8e08-302">If there are no error reports and one or more warnings, the aggregated health state is either warning or error, depending on the ConsiderWarningAsError policy flag.</span></span>

![健康狀態報告彙總，包含「Warning」報告和已設為 false 的 ConsiderWarningAsError。][3]

<span data-ttu-id="d8e08-304">健康狀態報告彙總包含「Warning」報告以及設為 false (預設值) 的 ConsiderWarningAsError。</span><span class="sxs-lookup"><span data-stu-id="d8e08-304">Health report aggregation with warning report and ConsiderWarningAsError set to false (default).</span></span>

[3]: ./media/service-fabric-health-introduction/servicefabric-health-report-eval-warning.png

### <a name="child-health-aggregation"></a><span data-ttu-id="d8e08-305">子系健康狀態彙總</span><span class="sxs-lookup"><span data-stu-id="d8e08-305">Child health aggregation</span></span>
<span data-ttu-id="d8e08-306">實體的已彙總健康狀態會反映子系健康狀態 (適用時)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-306">The aggregated health state of an entity reflects the child health states (when applicable).</span></span> <span data-ttu-id="d8e08-307">彙總子系健康狀態的演算法會依照實體類型使用適用的健康狀態原則。</span><span class="sxs-lookup"><span data-stu-id="d8e08-307">The algorithm for aggregating child health states uses the health policies applicable based on the entity type.</span></span>

![子系實體健康狀態彙總。][4]

<span data-ttu-id="d8e08-309">以健康狀態原則為基礎的子系彙總。</span><span class="sxs-lookup"><span data-stu-id="d8e08-309">Child aggregation based on health policies.</span></span>

[4]: ./media/service-fabric-health-introduction/servicefabric-health-hierarchy-eval.png

<span data-ttu-id="d8e08-310">當健康狀態資料存放區已評估過所有子系之後，即會根據狀況不良子系已設定的最大百分比來彙總其健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-310">After the health store has evaluated all the children, it aggregates their health states based on the configured maximum percentage of unhealthy children.</span></span> <span data-ttu-id="d8e08-311">此百分比是根據實體和子類型而取自於原則。</span><span class="sxs-lookup"><span data-stu-id="d8e08-311">This percentage is taken from the policy based on the entity and child type.</span></span>

* <span data-ttu-id="d8e08-312">若所有子系都具有「OK」狀態，則子系已彙總的健康狀態為「OK」。</span><span class="sxs-lookup"><span data-stu-id="d8e08-312">If all children have OK states, the child aggregated health state is OK.</span></span>
* <span data-ttu-id="d8e08-313">若子系同時具有「OK」和「Warning」狀態，則子系已彙總的健康狀態會是「Warning」。</span><span class="sxs-lookup"><span data-stu-id="d8e08-313">If children have both OK and warning states, the child aggregated health state is warning.</span></span>
* <span data-ttu-id="d8e08-314">若具有「Error」狀態的子系不符合狀況不良子系的最大允許百分比，則已彙總的健康狀態為「Error」。</span><span class="sxs-lookup"><span data-stu-id="d8e08-314">If there are children with error states that do not respect the maximum allowed percentage of unhealthy children, the aggregated health state is an error.</span></span>
* <span data-ttu-id="d8e08-315">若具有「Error」狀態的子系符合狀況不良子系的最大允許百分比，則已彙總的健康狀態為「Warning」。</span><span class="sxs-lookup"><span data-stu-id="d8e08-315">If the children with error states respect the maximum allowed percentage of unhealthy children, the aggregated health state is warning.</span></span>

## <a name="health-reporting"></a><span data-ttu-id="d8e08-316">健康狀態報告</span><span class="sxs-lookup"><span data-stu-id="d8e08-316">Health reporting</span></span>
<span data-ttu-id="d8e08-317">系統元件、System Fabric 應用程式和內部/外部看門狗可以報告 Service Fabric 實體。</span><span class="sxs-lookup"><span data-stu-id="d8e08-317">System components, System Fabric applications, and internal/external watchdogs can report against Service Fabric entities.</span></span> <span data-ttu-id="d8e08-318">報告程式會依照其所監視的條件，來決定「本機」  受監視實體的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-318">The reporters make *local* determinations of the health of the monitored entities, based on the conditions they are monitoring.</span></span> <span data-ttu-id="d8e08-319">回報者不需查看任何全域狀態或彙總資料。</span><span class="sxs-lookup"><span data-stu-id="d8e08-319">They don't need to look at any global state or aggregate data.</span></span> <span data-ttu-id="d8e08-320">最好是使用簡單的報告程式，因為太複雜的有機體需要查看許多項目，才能推斷所要傳送的資訊。</span><span class="sxs-lookup"><span data-stu-id="d8e08-320">The desired behavior is to have simple reporters, and not complex organisms that need to look at many things to infer what information to send.</span></span>

<span data-ttu-id="d8e08-321">若要將健康狀態資料傳送至健康狀態資料存放區，報告程式需要識別受影響的實體，並建立健康狀態報告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-321">To send health data to the health store, a reporter needs to identify the affected entity and create a health report.</span></span> <span data-ttu-id="d8e08-322">若要傳送報告，請使用 [FabricClient.HealthClient.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth) API、`Partition` 或 `CodePackageActivationContext` 物件上公開的報告健康情況 API、PowerShell cmdlet 或 REST。</span><span class="sxs-lookup"><span data-stu-id="d8e08-322">To send the report, use the [FabricClient.HealthClient.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth) API, report health APIs exposed on the `Partition` or `CodePackageActivationContext` objects, PowerShell cmdlets, or REST.</span></span>

### <a name="health-reports"></a><span data-ttu-id="d8e08-323">健康狀態報告</span><span class="sxs-lookup"><span data-stu-id="d8e08-323">Health reports</span></span>
<span data-ttu-id="d8e08-324">叢集中每個實體的 [健康狀態報告](https://docs.microsoft.com/dotnet/api/system.fabric.health.healthreport) 包含下列資訊：</span><span class="sxs-lookup"><span data-stu-id="d8e08-324">The [health reports](https://docs.microsoft.com/dotnet/api/system.fabric.health.healthreport) for each of the entities in the cluster contain the following information:</span></span>

* <span data-ttu-id="d8e08-325">**SourceId**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-325">**SourceId**.</span></span> <span data-ttu-id="d8e08-326">用來識別健康狀態事件回報者的唯一字串。</span><span class="sxs-lookup"><span data-stu-id="d8e08-326">A string that uniquely identifies the reporter of the health event.</span></span>
* <span data-ttu-id="d8e08-327">**實體識別碼**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-327">**Entity identifier**.</span></span> <span data-ttu-id="d8e08-328">識別報告所套用的實體。</span><span class="sxs-lookup"><span data-stu-id="d8e08-328">Identifies the entity where the report is applied.</span></span> <span data-ttu-id="d8e08-329">其會依照 [實體類型](service-fabric-health-introduction.md#health-entities-and-hierarchy)而有所不同：</span><span class="sxs-lookup"><span data-stu-id="d8e08-329">It differs based on the [entity type](service-fabric-health-introduction.md#health-entities-and-hierarchy):</span></span>
  
  * <span data-ttu-id="d8e08-330">叢集。</span><span class="sxs-lookup"><span data-stu-id="d8e08-330">Cluster.</span></span> <span data-ttu-id="d8e08-331">無。</span><span class="sxs-lookup"><span data-stu-id="d8e08-331">None.</span></span>
  * <span data-ttu-id="d8e08-332">節點。</span><span class="sxs-lookup"><span data-stu-id="d8e08-332">Node.</span></span> <span data-ttu-id="d8e08-333">節點名稱 (字串)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-333">Node name  (string).</span></span>
  * <span data-ttu-id="d8e08-334">應用程式。</span><span class="sxs-lookup"><span data-stu-id="d8e08-334">Application.</span></span> <span data-ttu-id="d8e08-335">應用程式名稱 (URI)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-335">Application name (URI).</span></span> <span data-ttu-id="d8e08-336">表示叢集中已部署應用程式執行個體的名稱。</span><span class="sxs-lookup"><span data-stu-id="d8e08-336">Represents the name of the application instance deployed in the cluster.</span></span>
  * <span data-ttu-id="d8e08-337">服務。</span><span class="sxs-lookup"><span data-stu-id="d8e08-337">Service.</span></span> <span data-ttu-id="d8e08-338">服務名稱 (URI)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-338">Service name (URI).</span></span> <span data-ttu-id="d8e08-339">表示叢集中已部署服務執行個體的名稱。</span><span class="sxs-lookup"><span data-stu-id="d8e08-339">Represents the name of the service instance deployed in the cluster.</span></span>
  * <span data-ttu-id="d8e08-340">分割區。</span><span class="sxs-lookup"><span data-stu-id="d8e08-340">Partition.</span></span> <span data-ttu-id="d8e08-341">分割識別碼 (GUID)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-341">Partition ID (GUID).</span></span> <span data-ttu-id="d8e08-342">表示資料分割的唯一識別碼。</span><span class="sxs-lookup"><span data-stu-id="d8e08-342">Represents the partition unique identifier.</span></span>
  * <span data-ttu-id="d8e08-343">複本。</span><span class="sxs-lookup"><span data-stu-id="d8e08-343">Replica.</span></span> <span data-ttu-id="d8e08-344">具狀態服務複本識別碼，或無狀態服務執行個體識別碼 (INT64)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-344">The stateful service replica ID or the stateless service instance ID (INT64).</span></span>
  * <span data-ttu-id="d8e08-345">DeployedApplication。</span><span class="sxs-lookup"><span data-stu-id="d8e08-345">DeployedApplication.</span></span> <span data-ttu-id="d8e08-346">應用程式名稱 (URI) 和節點名稱 (字串)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-346">Application name (URI) and node name (string).</span></span>
  * <span data-ttu-id="d8e08-347">DeployedServicePackage。</span><span class="sxs-lookup"><span data-stu-id="d8e08-347">DeployedServicePackage.</span></span> <span data-ttu-id="d8e08-348">應用程式名稱 (URI)、節點名稱 (字串) 和服務資訊清單名稱 (字串)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-348">Application name (URI), node name (string), and service manifest name (string).</span></span>
* <span data-ttu-id="d8e08-349">**Property**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-349">**Property**.</span></span> <span data-ttu-id="d8e08-350">可讓回報者針對實體的特定屬性來分類健康狀態事件的 *字串* (非固定列舉)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-350">A *string* (not a fixed enumeration) that allows the reporter to categorize the health event for a specific property of the entity.</span></span> <span data-ttu-id="d8e08-351">例如，報告程式 A 可以針對 Node01 的「儲存體」屬性報告健康情況，而報告程式 B 可以針對 Node01 的「連線」屬性報告健康情況。</span><span class="sxs-lookup"><span data-stu-id="d8e08-351">For example, reporter A can report the health of the Node01 "Storage" property and reporter B can report the health of the Node01 "Connectivity" property.</span></span> <span data-ttu-id="d8e08-352">在健康狀態資料存放區中，這兩個報告會將 Node01 實體視為個別的健康狀態事件。</span><span class="sxs-lookup"><span data-stu-id="d8e08-352">In the health store, these reports are treated as separate health events for the Node01 entity.</span></span>
* <span data-ttu-id="d8e08-353">**Description**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-353">**Description**.</span></span> <span data-ttu-id="d8e08-354">可讓報告程式提供健康狀態事件相關詳細資訊的字串。</span><span class="sxs-lookup"><span data-stu-id="d8e08-354">A string that allows a reporter to provide detailed information about the health event.</span></span> <span data-ttu-id="d8e08-355">**SourceId**、**Property** 和 **HealthState** 應在報告中完整說明。</span><span class="sxs-lookup"><span data-stu-id="d8e08-355">**SourceId**, **Property**, and **HealthState** should fully describe the report.</span></span> <span data-ttu-id="d8e08-356">說明可增加人們可讀取的報告相關資訊。</span><span class="sxs-lookup"><span data-stu-id="d8e08-356">The description adds human-readable information about the report.</span></span> <span data-ttu-id="d8e08-357">文字可讓系統管理員和使用者更容易了解健全狀況報告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-357">The text makes it easier for administrators and users to understand the health report.</span></span>
* <span data-ttu-id="d8e08-358">**HealthState**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-358">**HealthState**.</span></span> <span data-ttu-id="d8e08-359">描述報告健康狀態的 [列舉](service-fabric-health-introduction.md#health-states) 。</span><span class="sxs-lookup"><span data-stu-id="d8e08-359">An [enumeration](service-fabric-health-introduction.md#health-states) that describes the health state of the report.</span></span> <span data-ttu-id="d8e08-360">接受的值是「OK」、「Warning」和「Error」。</span><span class="sxs-lookup"><span data-stu-id="d8e08-360">The accepted values are OK, Warning, and Error.</span></span>
* <span data-ttu-id="d8e08-361">**TimeToLive**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-361">**TimeToLive**.</span></span> <span data-ttu-id="d8e08-362">指出健康狀態報告持續有效的時間範圍。</span><span class="sxs-lookup"><span data-stu-id="d8e08-362">A timespan that indicates how long the health report is valid.</span></span> <span data-ttu-id="d8e08-363">可以搭配 **RemoveWhenExpired**，讓健康狀態資料存放區知道如何評估過期的事件。</span><span class="sxs-lookup"><span data-stu-id="d8e08-363">Coupled with **RemoveWhenExpired**, it lets the health store know how to evaluate expired events.</span></span> <span data-ttu-id="d8e08-364">根據預設，該值為「Infinite」，代表報告將永遠有效。</span><span class="sxs-lookup"><span data-stu-id="d8e08-364">By default, the value is infinite, and the report is valid forever.</span></span>
* <span data-ttu-id="d8e08-365">**RemoveWhenExpired**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-365">**RemoveWhenExpired**.</span></span> <span data-ttu-id="d8e08-366">布林值。</span><span class="sxs-lookup"><span data-stu-id="d8e08-366">A Boolean.</span></span> <span data-ttu-id="d8e08-367">若設為 True，則過期的健康狀態報告會自動從健康狀態資料存放區移除，且報告不會影響實體健康狀態評估。</span><span class="sxs-lookup"><span data-stu-id="d8e08-367">If set to true, the expired health report is automatically removed from the health store, and the report doesn't impact entity health evaluation.</span></span> <span data-ttu-id="d8e08-368">只有當報告在一段指定時間內有效時才會使用此值，且報告程式不需明確地將其清除。它也會用來從健康狀態資料存放區刪除報告 (例如，變更看門狗，並停止傳送含有先前來源和屬性的報告)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-368">Used when the report is valid for a specified period of time only, and the reporter doesn't need to explicitly clear it out. It's also used to delete reports from the health store (for example, a watchdog is changed and stops sending reports with previous source and property).</span></span> <span data-ttu-id="d8e08-369">其傳送的報告可以使用短暫的 TimeToLive 和 RemoveWhenExpired，以便從健康狀態資料存放區清除任何先前的狀態。</span><span class="sxs-lookup"><span data-stu-id="d8e08-369">It can send a report with a brief TimeToLive along with RemoveWhenExpired to clear up any previous state from the health store.</span></span> <span data-ttu-id="d8e08-370">若將此值設為 False，則會將過期的報告視為健康狀態評估的錯誤。</span><span class="sxs-lookup"><span data-stu-id="d8e08-370">If the value is set to false, the expired report is treated as an error on the health evaluation.</span></span> <span data-ttu-id="d8e08-371">False 值示意健康狀態資料存放區，來源應定期報告此屬性。</span><span class="sxs-lookup"><span data-stu-id="d8e08-371">The false value signals to the health store that the source should report periodically on this property.</span></span> <span data-ttu-id="d8e08-372">如果沒有，則一定是看門狗發生了某些錯誤。</span><span class="sxs-lookup"><span data-stu-id="d8e08-372">If it doesn't, then there must be something wrong with the watchdog.</span></span> <span data-ttu-id="d8e08-373">看門狗的健康狀態是藉由將事件視為錯誤來擷取。</span><span class="sxs-lookup"><span data-stu-id="d8e08-373">The watchdog's health is captured by considering the event as an error.</span></span>
* <span data-ttu-id="d8e08-374">**SequenceNumber**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-374">**SequenceNumber**.</span></span> <span data-ttu-id="d8e08-375">這個值是必須持續增加的正整數，其表示報告的順序。</span><span class="sxs-lookup"><span data-stu-id="d8e08-375">A positive integer that needs to be ever-increasing, it represents the order of the reports.</span></span> <span data-ttu-id="d8e08-376">健康狀態資料存放區會使用其來偵測因網路延遲或其他問題而較晚收到的陳舊報告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-376">It is used by the health store to detect stale reports that are received late because of network delays or other issues.</span></span> <span data-ttu-id="d8e08-377">針對相同的實體、來源和屬性，若序號小於或等於最新套用的數字，則報告會遭到拒絕。</span><span class="sxs-lookup"><span data-stu-id="d8e08-377">A report is rejected if the sequence number is less than or equal to the most recently applied number for the same entity, source, and property.</span></span> <span data-ttu-id="d8e08-378">如果未指定，即會自動產生序號。</span><span class="sxs-lookup"><span data-stu-id="d8e08-378">If it is not specified, the sequence number is generated automatically.</span></span> <span data-ttu-id="d8e08-379">只有在報告狀態轉換時，才需放入序號。</span><span class="sxs-lookup"><span data-stu-id="d8e08-379">It is necessary to put in the sequence number only when reporting on state transitions.</span></span> <span data-ttu-id="d8e08-380">在此情況下，來源必須記住它所傳送的報告，並保留在容錯移轉復原的資訊。</span><span class="sxs-lookup"><span data-stu-id="d8e08-380">In this situation, the source needs to remember which reports it sent and keep the information for recovery on failover.</span></span>

<span data-ttu-id="d8e08-381">每個健康狀態報告都需要四種資訊 (SourceId、實體識別碼、Property 和 HealthState)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-381">These four pieces of information--SourceId, entity identifier, Property, and HealthState--are required for every health report.</span></span> <span data-ttu-id="d8e08-382">不允許 SourceId 字串以前置詞 "**System.**" 開頭，因為這是保留給系統報告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-382">The SourceId string is not allowed to start with the prefix "**System.**", which is reserved for system reports.</span></span> <span data-ttu-id="d8e08-383">針對相同的實體，相同的來源和屬性僅能有一個報告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-383">For the same entity, there is only one report for the same source and property.</span></span> <span data-ttu-id="d8e08-384">無論在健康狀態用戶端 (若是批次處理) 或健康狀態資料存放區端，相同來源和屬性的多個報告會互相覆寫。</span><span class="sxs-lookup"><span data-stu-id="d8e08-384">Multiple reports for the same source and property override each other, either on the health client side (if they are batched) or on the health store side.</span></span> <span data-ttu-id="d8e08-385">取代是以序號為根據；較新的報告 (具有較大的序號) 會取代較舊的報告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-385">The replacement is based on sequence numbers; newer reports (with higher sequence numbers) replace older reports.</span></span>

### <a name="health-events"></a><span data-ttu-id="d8e08-386">健康狀態事件</span><span class="sxs-lookup"><span data-stu-id="d8e08-386">Health events</span></span>
<span data-ttu-id="d8e08-387">就內部而言，健康狀態資料存放區會保留 [健康狀態事件](https://docs.microsoft.com/dotnet/api/system.fabric.health.healthevent)，其中包含報告的所有資訊以及其他中繼資料。</span><span class="sxs-lookup"><span data-stu-id="d8e08-387">Internally, the health store keeps [health events](https://docs.microsoft.com/dotnet/api/system.fabric.health.healthevent), which contain all the information from the reports, and additional metadata.</span></span> <span data-ttu-id="d8e08-388">中繼資料包括報告送至健康狀態用戶端的時間，以及在伺服器端修改該報告的時間。</span><span class="sxs-lookup"><span data-stu-id="d8e08-388">The metadata includes the time the report was given to the health client and the time it was modified on the server side.</span></span> <span data-ttu-id="d8e08-389">健康狀態事件將透過 [健康狀態查詢](service-fabric-view-entities-aggregated-health.md#health-queries)來傳回。</span><span class="sxs-lookup"><span data-stu-id="d8e08-389">The health events are returned by [health queries](service-fabric-view-entities-aggregated-health.md#health-queries).</span></span>

<span data-ttu-id="d8e08-390">新增的中繼資料包含：</span><span class="sxs-lookup"><span data-stu-id="d8e08-390">The added metadata contains:</span></span>

* <span data-ttu-id="d8e08-391">**SourceUtcTimestamp**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-391">**SourceUtcTimestamp**.</span></span> <span data-ttu-id="d8e08-392">報告送至健康狀態用戶端的時間 (國際標準時間)</span><span class="sxs-lookup"><span data-stu-id="d8e08-392">The time the report was given to the health client (Coordinated Universal Time).</span></span>
* <span data-ttu-id="d8e08-393">**LastModifiedUtcTimestamp**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-393">**LastModifiedUtcTimestamp**.</span></span> <span data-ttu-id="d8e08-394">報告上一次在伺服器端修改的時間 (國際標準時間)</span><span class="sxs-lookup"><span data-stu-id="d8e08-394">The time the report was last modified on the server side (Coordinated Universal Time).</span></span>
* <span data-ttu-id="d8e08-395">**IsExpired**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-395">**IsExpired**.</span></span> <span data-ttu-id="d8e08-396">指出報告於健康狀態資料存放區執行查詢時是否已到期的旗標。</span><span class="sxs-lookup"><span data-stu-id="d8e08-396">A flag to indicate whether the report was expired when the query was executed by the health store.</span></span> <span data-ttu-id="d8e08-397">只有當 RemoveWhenExpired 為 False，事件才會過期。</span><span class="sxs-lookup"><span data-stu-id="d8e08-397">An event can be expired only if RemoveWhenExpired is false.</span></span> <span data-ttu-id="d8e08-398">否則，事件不會由查詢傳回，並從存放區中移除。</span><span class="sxs-lookup"><span data-stu-id="d8e08-398">Otherwise, the event is not returned by query and is removed from the store.</span></span>
* <span data-ttu-id="d8e08-399">**LastOkTransitionAt**、**LastWarningTransitionAt**、**LastErrorTransitionAt**。</span><span class="sxs-lookup"><span data-stu-id="d8e08-399">**LastOkTransitionAt**, **LastWarningTransitionAt**, **LastErrorTransitionAt**.</span></span> <span data-ttu-id="d8e08-400">上一次轉換 OK/Warning/Error 的時間。</span><span class="sxs-lookup"><span data-stu-id="d8e08-400">The last time for OK/warning/error transitions.</span></span> <span data-ttu-id="d8e08-401">這些欄位會針對事件的健康狀態轉換提供歷程記錄。</span><span class="sxs-lookup"><span data-stu-id="d8e08-401">These fields give the history of the health state transitions for the event.</span></span>

<span data-ttu-id="d8e08-402">狀態轉換欄位可用於更聰明的警示或「歷程記錄」的健康狀態事件資訊。</span><span class="sxs-lookup"><span data-stu-id="d8e08-402">The state transition fields can be used for smarter alerts or "historical" health event information.</span></span> <span data-ttu-id="d8e08-403">所適用的案例如下：</span><span class="sxs-lookup"><span data-stu-id="d8e08-403">They enable scenarios such as:</span></span>

* <span data-ttu-id="d8e08-404">當屬性處於「Warning/Error」狀態持續超過 X 分鐘時發出警示。</span><span class="sxs-lookup"><span data-stu-id="d8e08-404">Alert when a property has been at warning/error for more than X minutes.</span></span> <span data-ttu-id="d8e08-405">檢查一段時間的狀況，可避免暫時狀況所造成的警示。</span><span class="sxs-lookup"><span data-stu-id="d8e08-405">Checking the condition for a period of time avoids alerts on temporary conditions.</span></span> <span data-ttu-id="d8e08-406">例如，當健康狀態處於「Warning」狀態持續超過五分鐘時發出警示，可以轉譯為 (HealthState == Warning 且 Now - LastWarningTransitionTime > 5 分鐘)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-406">For example, an alert if the health state has been warning for more than five minutes can be translated into (HealthState == Warning and Now - LastWarningTransitionTime > 5 minutes).</span></span>
* <span data-ttu-id="d8e08-407">僅在前 X 分鐘內發生變更的情況時發出警示。</span><span class="sxs-lookup"><span data-stu-id="d8e08-407">Alert only on conditions that have changed in the last X minutes.</span></span> <span data-ttu-id="d8e08-408">如果報告在指定的時間之前即處於「Error」狀態，則可忽略 (因為其先前已發出訊號)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-408">If a report was already at error before the specified time, it can be ignored because it was already signaled previously.</span></span>
* <span data-ttu-id="d8e08-409">若屬性交叉出現警告和錯誤，請判斷狀況不良 (亦即不是 OK) 已持續多久。</span><span class="sxs-lookup"><span data-stu-id="d8e08-409">If a property is toggling between warning and error, determine how long it has been unhealthy (that is, not OK).</span></span> <span data-ttu-id="d8e08-410">例如，若屬性狀況良好的狀態不超過 5 分鐘時發出警示，可以轉譯為 (HealthState != Ok 且 Now - LastOkTransitionTime > 5 分鐘)。</span><span class="sxs-lookup"><span data-stu-id="d8e08-410">For example, an alert if the property hasn't been healthy for more than five minutes can be translated into (HealthState != Ok and Now - LastOkTransitionTime > 5 minutes).</span></span>

## <a name="example-report-and-evaluate-application-health"></a><span data-ttu-id="d8e08-411">範例：報告和評估應用程式健康狀態</span><span class="sxs-lookup"><span data-stu-id="d8e08-411">Example: Report and evaluate application health</span></span>
<span data-ttu-id="d8e08-412">下列範例會從來源 **MyWatchdog**，透過應用程式 **fabric:/WordCount** 上的 PowerShell 來傳送健康狀態報告。</span><span class="sxs-lookup"><span data-stu-id="d8e08-412">The following example sends a health report through PowerShell on the application **fabric:/WordCount** from the source **MyWatchdog**.</span></span> <span data-ttu-id="d8e08-413">健康狀態報告會在 Error 健康狀態中包含健康狀態屬性「可用性」的相關資訊，並包含「Infinite」的 TimeToLive。</span><span class="sxs-lookup"><span data-stu-id="d8e08-413">The health report contains information about the health property "availability" in an error health state, with infinite TimeToLive.</span></span> <span data-ttu-id="d8e08-414">然後它會查詢應用程式健康狀態，並在健康狀態事件清單中傳回已彙總的健康狀態錯誤和已報告的健康狀態事件。</span><span class="sxs-lookup"><span data-stu-id="d8e08-414">Then it queries the application health, which returns aggregated health state errors and the reported health events in the list of health events.</span></span>

```powershell
PS C:\> Send-ServiceFabricApplicationHealthReport –ApplicationName fabric:/WordCount –SourceId "MyWatchdog" –HealthProperty "Availability" –HealthState Error

PS C:\> Get-ServiceFabricApplicationHealth fabric:/WordCount -ExcludeHealthStatistics


ApplicationName                 : fabric:/WordCount
AggregatedHealthState           : Error
UnhealthyEvaluations            :
                                  Error event: SourceId='MyWatchdog', Property='Availability'.

ServiceHealthStates             :
                                  ServiceName           : fabric:/WordCount/WordCountService
                                  AggregatedHealthState : Error

                                  ServiceName           : fabric:/WordCount/WordCountWebService
                                  AggregatedHealthState : Ok

DeployedApplicationHealthStates :
                                  ApplicationName       : fabric:/WordCount
                                  NodeName              : _Node_0
                                  AggregatedHealthState : Ok

                                  ApplicationName       : fabric:/WordCount
                                  NodeName              : _Node_2
                                  AggregatedHealthState : Ok

                                  ApplicationName       : fabric:/WordCount
                                  NodeName              : _Node_3
                                  AggregatedHealthState : Ok

                                  ApplicationName       : fabric:/WordCount
                                  NodeName              : _Node_4
                                  AggregatedHealthState : Ok

                                  ApplicationName       : fabric:/WordCount
                                  NodeName              : _Node_1
                                  AggregatedHealthState : Ok

HealthEvents                    :
                                  SourceId              : System.CM
                                  Property              : State
                                  HealthState           : Ok
                                  SequenceNumber        : 360
                                  SentAt                : 3/22/2016 7:56:53 PM
                                  ReceivedAt            : 3/22/2016 7:56:53 PM
                                  TTL                   : Infinite
                                  Description           : Application has been created.
                                  RemoveWhenExpired     : False
                                  IsExpired             : False
                                  Transitions           : Error->Ok = 3/22/2016 7:56:53 PM, LastWarning = 1/1/0001 12:00:00 AM

                                  SourceId              : MyWatchdog
                                  Property              : Availability
                                  HealthState           : Error
                                  SequenceNumber        : 131032204762818013
                                  SentAt                : 3/23/2016 3:27:56 PM
                                  ReceivedAt            : 3/23/2016 3:27:56 PM
                                  TTL                   : Infinite
                                  Description           :
                                  RemoveWhenExpired     : False
                                  IsExpired             : False
                                  Transitions           : Ok->Error = 3/23/2016 3:27:56 PM, LastWarning = 1/1/0001 12:00:00 AM
```

## <a name="health-model-usage"></a><span data-ttu-id="d8e08-415">健康狀態模型使用方式</span><span class="sxs-lookup"><span data-stu-id="d8e08-415">Health model usage</span></span>
<span data-ttu-id="d8e08-416">健康狀態模型可讓雲端服務和基礎 Service Fabric 平台進行調整，因為監視及健康狀態決定會分散至叢集內的不同監視器。</span><span class="sxs-lookup"><span data-stu-id="d8e08-416">The health model allows cloud services and the underlying Service Fabric platform to scale, because monitoring and health determinations are distributed among the different monitors within the cluster.</span></span>
<span data-ttu-id="d8e08-417">其他系統在叢集層級具有單一的集中式服務，可剖析服務所發出的所有「可能」  的實用資訊。</span><span class="sxs-lookup"><span data-stu-id="d8e08-417">Other systems have a single, centralized service at the cluster level that parses all the *potentially* useful information emitted by services.</span></span> <span data-ttu-id="d8e08-418">這個方法會防礙其延展性。</span><span class="sxs-lookup"><span data-stu-id="d8e08-418">This approach hinders their scalability.</span></span> <span data-ttu-id="d8e08-419">同時也不允許其收集特定資訊來協助識別問題和潛在問題，並盡可能接近根本原因。</span><span class="sxs-lookup"><span data-stu-id="d8e08-419">It also doesn't allow them to collect specific information to help identify issues and potential issues as close to the root cause as possible.</span></span>

<span data-ttu-id="d8e08-420">健康狀態模型常用來監視和診斷，以便評估叢集和應用程式健康狀態，以及監視升級。</span><span class="sxs-lookup"><span data-stu-id="d8e08-420">The health model is used heavily for monitoring and diagnosis, for evaluating cluster and application health, and for monitored upgrades.</span></span> <span data-ttu-id="d8e08-421">其他服務會使用健康狀態資料來執行自動修復、建置叢集健康狀態歷程記錄，以及發出特定情況的警示。</span><span class="sxs-lookup"><span data-stu-id="d8e08-421">Other services use health data to perform automatic repairs, build cluster health history, and issue alerts on certain conditions.</span></span>

## <a name="next-steps"></a><span data-ttu-id="d8e08-422">後續步驟</span><span class="sxs-lookup"><span data-stu-id="d8e08-422">Next steps</span></span>
[<span data-ttu-id="d8e08-423">檢視 Service Fabric 健康狀態報告</span><span class="sxs-lookup"><span data-stu-id="d8e08-423">View Service Fabric health reports</span></span>](service-fabric-view-entities-aggregated-health.md)

[<span data-ttu-id="d8e08-424">使用系統健康狀態報告進行疑難排解</span><span class="sxs-lookup"><span data-stu-id="d8e08-424">Use system health reports for troubleshooting</span></span>](service-fabric-understand-and-troubleshoot-with-system-health-reports.md)

[<span data-ttu-id="d8e08-425">如何回報和檢查服務健全狀況</span><span class="sxs-lookup"><span data-stu-id="d8e08-425">How to report and check service health</span></span>](service-fabric-diagnostics-how-to-report-and-check-service-health.md)

[<span data-ttu-id="d8e08-426">新增自訂 Service Fabric 健康狀態報告</span><span class="sxs-lookup"><span data-stu-id="d8e08-426">Add custom Service Fabric health reports</span></span>](service-fabric-report-health.md)

[<span data-ttu-id="d8e08-427">在本機上監視及診斷服務</span><span class="sxs-lookup"><span data-stu-id="d8e08-427">Monitor and diagnose services locally</span></span>](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md)

[<span data-ttu-id="d8e08-428">Service Fabric 應用程式升級</span><span class="sxs-lookup"><span data-stu-id="d8e08-428">Service Fabric application upgrade</span></span>](service-fabric-application-upgrade.md)

