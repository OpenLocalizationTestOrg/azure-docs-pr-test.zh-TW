---
title: "Service Fabric 應用程式升級 | Microsoft Docs"
description: "本文章提供升級 Service Fabric 應用程式的簡介，其中包括選擇升級模式和執行健康狀態檢查。"
services: service-fabric
documentationcenter: .net
author: mani-ramaswamy
manager: timlt
editor: 
ms.assetid: 803c9c63-373a-4d6a-8ef2-ea97e16e88dd
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 8/9/2017
ms.author: subramar
ms.openlocfilehash: 4c2752bee8e9a859b23dbf47662d15798b551bb5
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/18/2017
---
# <a name="service-fabric-application-upgrade"></a><span data-ttu-id="f2e18-103">Service Fabric 應用程式升級</span><span class="sxs-lookup"><span data-stu-id="f2e18-103">Service Fabric application upgrade</span></span>
<span data-ttu-id="f2e18-104">Azure Service Fabric 應用程式是服務集合。</span><span class="sxs-lookup"><span data-stu-id="f2e18-104">An Azure Service Fabric application is a collection of services.</span></span> <span data-ttu-id="f2e18-105">在升級期間，Service Fabric 會比較新的 [應用程式資訊清單](service-fabric-application-model.md#describe-an-application) 與舊版本，並決定應用程式中哪些服務需要更新。</span><span class="sxs-lookup"><span data-stu-id="f2e18-105">During an upgrade, Service Fabric compares the new [application manifest](service-fabric-application-model.md#describe-an-application) with the previous version and determines which services in the application require updates.</span></span> <span data-ttu-id="f2e18-106">Service Fabric 會比較服務資訊清單中的版本號碼和上一版中的版本號碼。</span><span class="sxs-lookup"><span data-stu-id="f2e18-106">Service Fabric compares the version numbers in the service manifests with the version numbers in the previous version.</span></span> <span data-ttu-id="f2e18-107">如果服務未變更，則該服務不會升級。</span><span class="sxs-lookup"><span data-stu-id="f2e18-107">If a service has not changed, that service is not upgraded.</span></span>

## <a name="rolling-upgrades-overview"></a><span data-ttu-id="f2e18-108">輪流升級概觀</span><span class="sxs-lookup"><span data-stu-id="f2e18-108">Rolling upgrades overview</span></span>
<span data-ttu-id="f2e18-109">在輪流應用程式升級中，升級是階段執行。</span><span class="sxs-lookup"><span data-stu-id="f2e18-109">In a rolling application upgrade, the upgrade is performed in stages.</span></span> <span data-ttu-id="f2e18-110">在每個階段中，升級會套用至叢集中的節點子集，稱為更新網域。</span><span class="sxs-lookup"><span data-stu-id="f2e18-110">At each stage, the upgrade is applied to a subset of nodes in the cluster, called an update domain.</span></span> <span data-ttu-id="f2e18-111">如此一來，應用程式在整個升級過程中仍然可供使用。</span><span class="sxs-lookup"><span data-stu-id="f2e18-111">As a result, the application remains available throughout the upgrade.</span></span> <span data-ttu-id="f2e18-112">升級期間，叢集可能包含舊和新版本的混合。</span><span class="sxs-lookup"><span data-stu-id="f2e18-112">During the upgrade, the cluster may contain a mix of the old and new versions.</span></span>

<span data-ttu-id="f2e18-113">因此，兩個版本必須是向前及向後相容。</span><span class="sxs-lookup"><span data-stu-id="f2e18-113">For that reason, the two versions must be forward and backward compatible.</span></span> <span data-ttu-id="f2e18-114">如果它們不相容，應用程式系統管理員負責執行多階段升級，以維護可用性。</span><span class="sxs-lookup"><span data-stu-id="f2e18-114">If they are not compatible, the application administrator is responsible for staging a multiple-phase upgrade to maintain availability.</span></span> <span data-ttu-id="f2e18-115">在多階段升級中，第一個步驟是升級到與先前版本相容的應用程式中繼版本。</span><span class="sxs-lookup"><span data-stu-id="f2e18-115">In a multiple-phase upgrade, the first step is upgrading to an intermediate version of the application that is compatible with the previous version.</span></span> <span data-ttu-id="f2e18-116">第二個步驟是升級與更新前版本中斷相容性，但與中繼版本相容的最終版本。</span><span class="sxs-lookup"><span data-stu-id="f2e18-116">The second step is to upgrade the final version that breaks compatibility with the pre-update version, but is compatible with the intermediate version.</span></span>

<span data-ttu-id="f2e18-117">當您設定叢集時，會在叢集資訊清單中指定更新網域。</span><span class="sxs-lookup"><span data-stu-id="f2e18-117">Update domains are specified in the cluster manifest when you configure the cluster.</span></span> <span data-ttu-id="f2e18-118">更新網域不會以特定順序收到更新。</span><span class="sxs-lookup"><span data-stu-id="f2e18-118">Update domains do not receive updates in a particular order.</span></span> <span data-ttu-id="f2e18-119">更新網域是應用程式的部署邏輯單元。</span><span class="sxs-lookup"><span data-stu-id="f2e18-119">An update domain is a logical unit of deployment for an application.</span></span> <span data-ttu-id="f2e18-120">更新網域可以讓服務在升級期間維持高可用性。</span><span class="sxs-lookup"><span data-stu-id="f2e18-120">Update domains allow the services to remain at high availability during an upgrade.</span></span>

<span data-ttu-id="f2e18-121">如果升級套用到叢集中的所有節點 (應用程式只有一個更新網域就是這種情形)，則不可能進行輪流升級。</span><span class="sxs-lookup"><span data-stu-id="f2e18-121">Non-rolling upgrades are possible if the upgrade is applied to all nodes in the cluster, which is the case when the application has only one update domain.</span></span> <span data-ttu-id="f2e18-122">不建議使用此方法，因為升級時服務會中斷且無法使用。</span><span class="sxs-lookup"><span data-stu-id="f2e18-122">This approach is not recommended, since the service goes down and isn't available at the time of upgrade.</span></span> <span data-ttu-id="f2e18-123">此外，當叢集僅以一個更新網域進行設定時，Azure 不提供任何保證。</span><span class="sxs-lookup"><span data-stu-id="f2e18-123">Additionally, Azure doesn't provide any guarantees when a cluster is set up with only one update domain.</span></span>

## <a name="health-checks-during-upgrades"></a><span data-ttu-id="f2e18-124">升級期間的健康狀態檢查</span><span class="sxs-lookup"><span data-stu-id="f2e18-124">Health checks during upgrades</span></span>
<span data-ttu-id="f2e18-125">對於升級，需要設定健康狀態原則 (或可能會使用預設值)。</span><span class="sxs-lookup"><span data-stu-id="f2e18-125">For an upgrade, health policies have to be set (or default values may be used).</span></span> <span data-ttu-id="f2e18-126">當所有更新網域在指定的逾時內升級，且所有更新網域都視為健康時，則稱為成功升級。</span><span class="sxs-lookup"><span data-stu-id="f2e18-126">An upgrade is termed successful when all update domains are upgraded within the specified time-outs, and when all update domains are deemed healthy.</span></span>  <span data-ttu-id="f2e18-127">健康的更新網域意指更新網域會通過健康狀態原則中指定的所有健康狀態檢查。</span><span class="sxs-lookup"><span data-stu-id="f2e18-127">A healthy update domain means that the update domain passed all the health checks specified in the health policy.</span></span> <span data-ttu-id="f2e18-128">例如，健康狀態原則可能會要求應用程式執行個體中的所有服務都必須 *健康狀態良好*，如 Service Fabric 定義的健康狀況。</span><span class="sxs-lookup"><span data-stu-id="f2e18-128">For example, a health policy may mandate that all services within an application instance must be *healthy*, as health is defined by Service Fabric.</span></span>

<span data-ttu-id="f2e18-129">Service Fabric 在升級期間進行的健康狀態原則以及檢查不限於服務和應用程式。</span><span class="sxs-lookup"><span data-stu-id="f2e18-129">Health policies and checks during upgrade by Service Fabric are service and application agnostic.</span></span> <span data-ttu-id="f2e18-130">也就是說，不會完成任何服務專屬的測試。</span><span class="sxs-lookup"><span data-stu-id="f2e18-130">That is, no service-specific tests are done.</span></span>  <span data-ttu-id="f2e18-131">例如，您的服務可能需要輸送量，但 Service Fabric 並沒有檢查輸送量的資訊。</span><span class="sxs-lookup"><span data-stu-id="f2e18-131">For example, your service might have a throughput requirement, but Service Fabric does not have the information to check throughput.</span></span> <span data-ttu-id="f2e18-132">如需了解會執行的檢查，請參閱 [健康狀態文章](service-fabric-health-introduction.md) 。</span><span class="sxs-lookup"><span data-stu-id="f2e18-132">Refer to the [health articles](service-fabric-health-introduction.md) for the checks that are performed.</span></span> <span data-ttu-id="f2e18-133">在升級期間進行的檢查包括是否已正確地複製應用程式封裝、是否已啟動執行個體等等。</span><span class="sxs-lookup"><span data-stu-id="f2e18-133">The checks that happen during an upgrade include tests for whether the application package was copied correctly, whether the instance was started, and so on.</span></span>

<span data-ttu-id="f2e18-134">應用程式健康狀態是應用程式的子系實體彙總。</span><span class="sxs-lookup"><span data-stu-id="f2e18-134">The application health is an aggregation of the child entities of the application.</span></span> <span data-ttu-id="f2e18-135">簡單地說，Service Fabric 會透過應用程式報告的健康狀態來評估應用程式的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="f2e18-135">In short, Service Fabric evaluates the health of the application through the health that is reported on the application.</span></span> <span data-ttu-id="f2e18-136">它也會以此種方式評估應用程式所有服務的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="f2e18-136">It also evaluates the health of all the services for the application this way.</span></span> <span data-ttu-id="f2e18-137">Service Fabric 會進一步藉由彙總其子項的健康狀態 (例如服務複本) 來評估應用程式服務的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="f2e18-137">Service Fabric further evaluates the health of the application services by aggregating the health of their children, such as the service replica.</span></span> <span data-ttu-id="f2e18-138">一旦符合應用程式健康狀態原則，便可以繼續升級。</span><span class="sxs-lookup"><span data-stu-id="f2e18-138">Once the application health policy is satisfied, the upgrade can proceed.</span></span> <span data-ttu-id="f2e18-139">如果違反健康狀態原則，則應用程式升級將會失敗。</span><span class="sxs-lookup"><span data-stu-id="f2e18-139">If the health policy is violated, the application upgrade fails.</span></span>

## <a name="upgrade-modes"></a><span data-ttu-id="f2e18-140">升級模式</span><span class="sxs-lookup"><span data-stu-id="f2e18-140">Upgrade modes</span></span>
<span data-ttu-id="f2e18-141">我們建議的應用程式升級模式為監視模式，這是常用的模式。</span><span class="sxs-lookup"><span data-stu-id="f2e18-141">The mode that we recommend for application upgrade is the monitored mode, which is the commonly used mode.</span></span> <span data-ttu-id="f2e18-142">監視模式會在一個更新網域上執行升級，如果所有健康狀態檢查都通過 (每個指定的原則)，即會自動移至下一個更新網域。</span><span class="sxs-lookup"><span data-stu-id="f2e18-142">Monitored mode performs the upgrade on one update domain, and if all health checks pass (per the policy specified), moves on to the next update domain automatically.</span></span>  <span data-ttu-id="f2e18-143">如果健康狀態檢查失敗及/或達到逾時，更新網域的升級就會回復，或者手動變更為未受監視的手動模式。</span><span class="sxs-lookup"><span data-stu-id="f2e18-143">If health checks fail and/or time-outs are reached, the upgrade is either rolled back for the update domain, or the mode is changed to unmonitored manual.</span></span> <span data-ttu-id="f2e18-144">您可以設定升級在升級失敗時選擇這兩種其中一種模式。</span><span class="sxs-lookup"><span data-stu-id="f2e18-144">You can configure the upgrade to choose one of those two modes for failed upgrades.</span></span> 

<span data-ttu-id="f2e18-145">不受監控手動模式在每次於更新網域上升級之後都需要手動介入，以開始進行下一個更新網域上的升級。</span><span class="sxs-lookup"><span data-stu-id="f2e18-145">Unmonitored manual mode needs manual intervention after every upgrade on an update domain, to kick off the upgrade on the next update domain.</span></span> <span data-ttu-id="f2e18-146">系統不會執行任何 Service Fabric 健康狀態檢查。</span><span class="sxs-lookup"><span data-stu-id="f2e18-146">No Service Fabric health checks are performed.</span></span> <span data-ttu-id="f2e18-147">系統管理員在開始下一個更新網域中的升級之前，會執行健康狀態或狀態檢查。</span><span class="sxs-lookup"><span data-stu-id="f2e18-147">The administrator performs the health or status checks before starting the upgrade in the next update domain.</span></span>

## <a name="upgrade-default-services"></a><span data-ttu-id="f2e18-148">升級預設服務</span><span class="sxs-lookup"><span data-stu-id="f2e18-148">Upgrade default services</span></span>
<span data-ttu-id="f2e18-149">您可以在應用程式的升級程序期間升級 Service Fabric 應用程式內的預設服務。</span><span class="sxs-lookup"><span data-stu-id="f2e18-149">Default services within Service Fabric application can be upgraded during the upgrade process of an application.</span></span> <span data-ttu-id="f2e18-150">預設服務會在[應用程式資訊清單](service-fabric-application-model.md#describe-an-application)中定義。</span><span class="sxs-lookup"><span data-stu-id="f2e18-150">Default services are defined in the [application manifest](service-fabric-application-model.md#describe-an-application).</span></span> <span data-ttu-id="f2e18-151">升級預設服務的標準規則如下︰</span><span class="sxs-lookup"><span data-stu-id="f2e18-151">The standard rules of upgrading default services are:</span></span>

1. <span data-ttu-id="f2e18-152">會建立不存在於叢集中的新[應用程式資訊清單](service-fabric-application-model.md#describe-an-application)中的預設服務。</span><span class="sxs-lookup"><span data-stu-id="f2e18-152">Default services in the new [application manifest](service-fabric-application-model.md#describe-an-application) that do not exist in the cluster are created.</span></span>
> [!TIP]
> <span data-ttu-id="f2e18-153">[EnableDefaultServicesUpgrade](service-fabric-cluster-fabric-settings.md#fabric-settings-that-you-can-customize) 必須設為 true，以啟用下列規則。</span><span class="sxs-lookup"><span data-stu-id="f2e18-153">[EnableDefaultServicesUpgrade](service-fabric-cluster-fabric-settings.md#fabric-settings-that-you-can-customize) needs to be set to true to enable the following rules.</span></span> <span data-ttu-id="f2e18-154">從 v5.5 可支援此功能。</span><span class="sxs-lookup"><span data-stu-id="f2e18-154">This feature is supported from v5.5.</span></span>

2. <span data-ttu-id="f2e18-155">會更新在上一個[應用程式資訊清單](service-fabric-application-model.md#describe-an-application)及新版本中的預設服務。</span><span class="sxs-lookup"><span data-stu-id="f2e18-155">Default services existing in both previous [application manifest](service-fabric-application-model.md#describe-an-application) and new version are updated.</span></span> <span data-ttu-id="f2e18-156">在新版本中的服務描述將會覆寫已在叢集中的部分。</span><span class="sxs-lookup"><span data-stu-id="f2e18-156">Service descriptions in the new version would overwrite those already in the cluster.</span></span> <span data-ttu-id="f2e18-157">在更新預設服務失敗時，應用程式升級會自動回復。</span><span class="sxs-lookup"><span data-stu-id="f2e18-157">Application upgrade would rollback automatically upon updating default service failure.</span></span>
3. <span data-ttu-id="f2e18-158">會刪除上一個[應用程式資訊清單](service-fabric-application-model.md#describe-an-application)中的預設服務，但不會刪除新版中的預設服務。</span><span class="sxs-lookup"><span data-stu-id="f2e18-158">Default services in the previous [application manifest](service-fabric-application-model.md#describe-an-application) but not in the new version are deleted.</span></span> <span data-ttu-id="f2e18-159">**請注意，無法還原此刪除預設服務。**</span><span class="sxs-lookup"><span data-stu-id="f2e18-159">**Note that this deleting default services can not be reverted.**</span></span>

<span data-ttu-id="f2e18-160">如果應用程式升級已回復，預設服務會還原為開始升級前的狀態。</span><span class="sxs-lookup"><span data-stu-id="f2e18-160">In case of an application upgrade is rolled back, default services are reverted to the status before upgrade started.</span></span> <span data-ttu-id="f2e18-161">但永遠無法建立已刪除的服務。</span><span class="sxs-lookup"><span data-stu-id="f2e18-161">But deleted services can never be created.</span></span>

## <a name="application-upgrade-flowchart"></a><span data-ttu-id="f2e18-162">應用程式升級流程圖</span><span class="sxs-lookup"><span data-stu-id="f2e18-162">Application upgrade flowchart</span></span>
<span data-ttu-id="f2e18-163">本段落下面的流程圖可以協助您了解 Service Fabric 應用程式的升級程序。</span><span class="sxs-lookup"><span data-stu-id="f2e18-163">The flowchart following this paragraph can help you understand the upgrade process of a Service Fabric application.</span></span> <span data-ttu-id="f2e18-164">特別是，此流程會說明逾時 (包括 HealthCheckStableDuration、HealthCheckRetryTimeout 和 UpgradeHealthCheckInterval) 如何協助控制一個更新網域中的升級被視為成功或失敗的時機。</span><span class="sxs-lookup"><span data-stu-id="f2e18-164">In particular, the flow describes how the time-outs, including *HealthCheckStableDuration*, *HealthCheckRetryTimeout*, and *UpgradeHealthCheckInterval*, help control when the upgrade in one update domain is considered a success or a failure.</span></span>

![Service Fabric 應用程式的升級程序][image]

## <a name="next-steps"></a><span data-ttu-id="f2e18-166">後續步驟</span><span class="sxs-lookup"><span data-stu-id="f2e18-166">Next steps</span></span>
<span data-ttu-id="f2e18-167">[使用 Visual Studio 升級您的應用程式](service-fabric-application-upgrade-tutorial.md) 將引導您完成使用 Visual Studio 進行應用程式升級的步驟。</span><span class="sxs-lookup"><span data-stu-id="f2e18-167">[Upgrading your Application Using Visual Studio](service-fabric-application-upgrade-tutorial.md) walks you through an application upgrade using Visual Studio.</span></span>

<span data-ttu-id="f2e18-168">[使用 PowerShell 升級您的應用程式](service-fabric-application-upgrade-tutorial-powershell.md) 將引導您完成使用 PowerShell 進行應用程式升級的步驟。</span><span class="sxs-lookup"><span data-stu-id="f2e18-168">[Upgrading your Application Using Powershell](service-fabric-application-upgrade-tutorial-powershell.md) walks you through an application upgrade using PowerShell.</span></span>

<span data-ttu-id="f2e18-169">使用 [升級參數](service-fabric-application-upgrade-parameters.md)來控制您應用程式的升級方式。</span><span class="sxs-lookup"><span data-stu-id="f2e18-169">Control how your application upgrades by using [Upgrade Parameters](service-fabric-application-upgrade-parameters.md).</span></span>

<span data-ttu-id="f2e18-170">了解如何使用 [資料序列化](service-fabric-application-upgrade-data-serialization.md)，以讓您的應用程式升級相容。</span><span class="sxs-lookup"><span data-stu-id="f2e18-170">Make your application upgrades compatible by learning how to use [Data Serialization](service-fabric-application-upgrade-data-serialization.md).</span></span>

<span data-ttu-id="f2e18-171">參考 [進階主題](service-fabric-application-upgrade-advanced.md)，以了解如何在升級您的應用程式時使用進階功能。</span><span class="sxs-lookup"><span data-stu-id="f2e18-171">Learn how to use advanced functionality while upgrading your application by referring to [Advanced Topics](service-fabric-application-upgrade-advanced.md).</span></span>

<span data-ttu-id="f2e18-172">參考 [疑難排解應用程式升級](service-fabric-application-upgrade-troubleshooting.md)中的步驟，以修正應用程式升級中常見的問題。</span><span class="sxs-lookup"><span data-stu-id="f2e18-172">Fix common problems in application upgrades by referring to the steps in [Troubleshooting Application Upgrades](service-fabric-application-upgrade-troubleshooting.md).</span></span>

[image]: media/service-fabric-application-upgrade/service-fabric-application-upgrade-flowchart.png
