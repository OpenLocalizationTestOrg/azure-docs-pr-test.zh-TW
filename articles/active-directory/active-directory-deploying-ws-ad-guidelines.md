---
title: "在 Azure 虛擬機器上部署 Windows Server Active Directory 的指導方針 | Microsoft Docs"
description: "如果您知道如何部署 AD 網域服務和內部部署 AD 同盟服務，了解它們如何在 Azure 虛擬機器上運作。"
services: active-directory
documentationcenter: 
author: femila
manager: femila
editor: 
ms.assetid: 04df4c46-e6b6-4754-960a-57b823d617fa
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 07/26/2017
ms.author: femila
ms.openlocfilehash: 342d9e2787add3d04f1b744152e135db98848179
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/03/2017
---
# <a name="guidelines-for-deploying-windows-server-active-directory-on-azure-virtual-machines"></a><span data-ttu-id="1f6a3-103">在 Azure 虛擬機器上部署 Windows Server Active Directory 的指導方針</span><span class="sxs-lookup"><span data-stu-id="1f6a3-103">Guidelines for deploying Windows Server Active Directory on Azure virtual machines</span></span>
<span data-ttu-id="1f6a3-104">本文說明 Windows Server Active Directory 網域服務 (ADDS) 和 Active Directory Federation Services (ADFS) 的內部部署與在 Microsoft Azure 虛擬機器上面部署之間的差異。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-104">This article explains the important differences between deploying Windows Server Active Directory Domain Services (AD DS) and Active Directory Federation Services (AD FS) on-premises versus deploying them on Microsoft Azure virtual machines.</span></span>

## <a name="scope-and-audience"></a><span data-ttu-id="1f6a3-105">範圍和對象</span><span class="sxs-lookup"><span data-stu-id="1f6a3-105">Scope and audience</span></span>
<span data-ttu-id="1f6a3-106">這篇文章適用於已體驗過部署 Active Directory 內部部署的使用者。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-106">The article is intended for those already experienced with deploying Active Directory on-premises.</span></span> <span data-ttu-id="1f6a3-107">它涵蓋了在 Microsoft Azure 虛擬機器/Azure 虛擬網路和傳統內部部署 Active Directory 部署上部署 Active Directory 的差異。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-107">It covers the differences between deploying Active Directory on Microsoft Azure virtual machines/Azure virtual networks and traditional on-premises Active Directory deployments.</span></span> <span data-ttu-id="1f6a3-108">Azure 虛擬機器和 Azure 虛擬網路是基礎結構即服務 (IaaS) 的一部分，提供給組織以利用在雲端中的運算資源。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-108">Azure virtual machines and Azure virtual networks are part of an Infrastructure-as-a-Service (IaaS) offering for organizations to leverage computing resources in the cloud.</span></span>

<span data-ttu-id="1f6a3-109">如果不熟悉 AD 部署，請視情況參閱 [AD DS 部署指南](https://technet.microsoft.com/library/cc753963)或[規劃 AD FS 部署](https://technet.microsoft.com/library/dn151324.aspx)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-109">For those that are not familiar with AD deployment, see the [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963) or [Plan your AD FS deployment](https://technet.microsoft.com/library/dn151324.aspx) as appropriate.</span></span>

<span data-ttu-id="1f6a3-110">本文假設讀者已熟悉下列概念︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-110">This article assumes that the reader is familiar with the following concepts:</span></span>

* <span data-ttu-id="1f6a3-111">Windows Server AD DS 部署和管理</span><span class="sxs-lookup"><span data-stu-id="1f6a3-111">Windows Server AD DS deployment and management</span></span>
* <span data-ttu-id="1f6a3-112">部署和設定 DNS 以支援 Windows Server AD DS 基礎結構</span><span class="sxs-lookup"><span data-stu-id="1f6a3-112">Deployment and configuration of DNS to support a Windows Server AD DS infrastructure</span></span>
* <span data-ttu-id="1f6a3-113">Windows Server AD FS 部署和管理</span><span class="sxs-lookup"><span data-stu-id="1f6a3-113">Windows Server AD FS deployment and management</span></span>
* <span data-ttu-id="1f6a3-114">部署、設定及管理可以使用 Windows Server AD FS 權杖的信賴憑證者應用程式 (網站和 Web 服務)</span><span class="sxs-lookup"><span data-stu-id="1f6a3-114">Deploying, configuring, and managing relying party applications (websites and web services) that can consume Windows Server AD FS tokens</span></span>
* <span data-ttu-id="1f6a3-115">一般虛擬機器的概念，例如如何設定虛擬機器、虛擬磁碟和虛擬網路</span><span class="sxs-lookup"><span data-stu-id="1f6a3-115">General virtual machine concepts, such as how to configure a virtual machine, virtual disks, and virtual networks</span></span>

<span data-ttu-id="1f6a3-116">本文強調混合式部署案例的需求，其中 Windows Server AD DS 或 AD FS 是一部分內部部署，一部分則部署在 Azure 虛擬機器上。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-116">This article highlights the requirements for a hybrid deployment scenario in which Windows Server AD DS or AD FS are partly deployed on-premises and partly deployed on Azure virtual machines.</span></span> <span data-ttu-id="1f6a3-117">本文首先涵蓋在 Azure 虛擬機器上執行 Windows Server AD DS 和 AD FS 與在內部部署執行之間的重大差異，以及影響設計和部署的重要決策點。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-117">The document first covers the critical differences between running Windows Server AD DS and AD FS on Azure virtual machines versus on-premises, and important decision points that affect design and deployment.</span></span> <span data-ttu-id="1f6a3-118">本文的其餘部分更詳細說明每個決策點的指導方針，以及如何將指導方針套用到各種部署案例。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-118">The rest of the paper explains guidelines for each of the decision points in more detail, and how to apply the guidelines to various deployment scenarios.</span></span>

<span data-ttu-id="1f6a3-119">本文不會討論 [Azure Active Directory](http://azure.microsoft.com/services/active-directory/)的組態，它是以 REST 為基礎的服務，可為雲端應用程式提供身分識別管理和存取控制功能。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-119">This article does not discuss the configuration of [Azure Active Directory](http://azure.microsoft.com/services/active-directory/), which is a REST-based service that provides identity management and access control capabilities for cloud applications.</span></span> <span data-ttu-id="1f6a3-120">但是，Azure Active Directory (Azure AD) 和 Windows Server AD DS 是設計為一起運作，為現今的混合式 IT 環境和現代化應用程式提供身分識別與存取管理解決方案。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-120">Azure Active Directory (Azure AD) and Windows Server AD DS are, however, designed to work together to provide an identity and access management solution for today’s hybrid IT environments and modern applications.</span></span> <span data-ttu-id="1f6a3-121">為了協助了解 Windows Server AD DS 與 Azure AD 之間的差異和關聯性，請考慮下列各項︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-121">To help understand the differences and relationships between Windows Server AD DS and Azure AD, consider the following:</span></span>

1. <span data-ttu-id="1f6a3-122">當您使用 Azure 將內部部署資料中心擴充到雲端時，可能在雲端的 Azure 虛擬機器上執行 Windows Server AD DS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-122">You might run Windows Server AD DS in the cloud on Azure virtual machines when you are using Azure to extend your on-premises datacenter into the cloud.</span></span>
2. <span data-ttu-id="1f6a3-123">您可以使用 Azure AD，為使用者提供軟體即服務 (SaaS) 應用程式的單一登入。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-123">You might use Azure AD to give your users single sign-on to Software-as-a-Service (SaaS) applications.</span></span> <span data-ttu-id="1f6a3-124">例如，Microsoft Office 365 會使用這項技術，而且在 Azure 或其他雲端平台中執行的應用程式也可以使用此技術。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-124">Microsoft Office 365 uses this technology, for example, and applications running on Azure or other cloud platforms can also use it.</span></span>
3. <span data-ttu-id="1f6a3-125">您可以使用 Azure AD (其存取控制服務) 讓使用者使用來自 Facebook、Google、Microsoft 及其他身分識別提供者的身分識別登入至應用程式 (在雲端或內部部署中託管)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-125">You might use Azure AD (its Access Control Service) to let users sign in using identities from Facebook, Google, Microsoft, and other identity providers to applications that are hosted in the cloud or on-premises.</span></span>

<span data-ttu-id="1f6a3-126">如需有關這些差異的詳細資訊，請參閱 [Azure 身分識別](fundamentals-identity.md)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-126">For more information about these differences, see [Azure Identity](fundamentals-identity.md).</span></span>

## <a name="related-resources"></a><span data-ttu-id="1f6a3-127">相關資源</span><span class="sxs-lookup"><span data-stu-id="1f6a3-127">Related resources</span></span>
<span data-ttu-id="1f6a3-128">您可以下載並執行 [Azure 虛擬機器整備性評估](https://www.microsoft.com/download/details.aspx?id=40898)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-128">You may download and run the [Azure Virtual Machine Readiness Assessment](https://www.microsoft.com/download/details.aspx?id=40898).</span></span> <span data-ttu-id="1f6a3-129">評估將會自動檢查您的內部部署環境，並且根據在本主題中找到的指引產生自訂報告，協助您將環境移轉至 Azure。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-129">The assessment will automatically inspect your on-premises environment and generate a customized report based on the guidance found in this topic to help you migrate the environment to Azure.</span></span>

<span data-ttu-id="1f6a3-130">我們建議您同時檢閱涵蓋下列主題的教學課程、指南及影片︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-130">We recommend that you also first review the tutorials, guides, and videos that cover the following topics:</span></span>

* [<span data-ttu-id="1f6a3-131">在 Azure 入口網站中設定純雲端虛擬網路</span><span class="sxs-lookup"><span data-stu-id="1f6a3-131">Configure a Cloud-Only Virtual Network in the Azure Portal</span></span>](../virtual-network/virtual-networks-create-vnet-arm-pportal.md)
* [<span data-ttu-id="1f6a3-132">在 Azure 入口網站中設定站對站 VPN</span><span class="sxs-lookup"><span data-stu-id="1f6a3-132">Configure a Site-to-Site VPN in the Azure Portal</span></span>](../vpn-gateway/vpn-gateway-site-to-site-create.md)
* [<span data-ttu-id="1f6a3-133">在 Azure 虛擬網路上安裝新的 Active Directory 樹系</span><span class="sxs-lookup"><span data-stu-id="1f6a3-133">Install a new Active Directory forest on an Azure virtual network</span></span>](active-directory-new-forest-virtual-machine.md)
* [<span data-ttu-id="1f6a3-134">在 Azure 中安裝複本 Active Directory 網域控制站</span><span class="sxs-lookup"><span data-stu-id="1f6a3-134">Install a replica Active Directory domain controller on Azure</span></span>](active-directory-install-replica-active-directory-domain-controller.md)
* [<span data-ttu-id="1f6a3-135">Microsoft Azure IT Pro IaaS：(01) 虛擬機器基本概念</span><span class="sxs-lookup"><span data-stu-id="1f6a3-135">Microsoft Azure IT Pro IaaS: (01) Virtual Machine Fundamentals</span></span>](https://channel9.msdn.com/Series/Windows-Azure-IT-Pro-IaaS/01)
* [<span data-ttu-id="1f6a3-136">Microsoft Azure IT Pro IaaS：(05) 建立虛擬網路和跨單位連線</span><span class="sxs-lookup"><span data-stu-id="1f6a3-136">Microsoft Azure IT Pro IaaS: (05) Creating Virtual Networks and Cross-Premises Connectivity</span></span>](https://channel9.msdn.com/Series/Windows-Azure-IT-Pro-IaaS/05)

## <a name="introduction"></a><span data-ttu-id="1f6a3-137">簡介</span><span class="sxs-lookup"><span data-stu-id="1f6a3-137">Introduction</span></span>
<span data-ttu-id="1f6a3-138">在 Azure 虛擬機器上部署 Windows Server Active Directory 的基本需求與在內部部署虛擬機器 (和某些實體機器) 上部署有些微的差異。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-138">The fundamental requirements for deploying Windows Server Active Directory on Azure virtual machines differ very little from deploying it in on-premises virtual machines (and, to some extent, physical machines).</span></span> <span data-ttu-id="1f6a3-139">例如，在 Windows Server AD DS 的案例中，如果您在 Azure 虛擬機器上部署的網域控制站 (DC) 是現有內部部署公司網域/樹系的複本，則 Azure 部署可以大致比照您處理任何其他 Windows Server Active Directory 網站的相同方式處理。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-139">For example, in the case of Windows Server AD DS, if the domain controllers (DCs) that you deploy on Azure virtual machines are replicas in an existing on-premises corporate domain/forest, then the Azure deployment can largely be treated in the same way as you might treat any other additional Windows Server Active Directory site.</span></span> <span data-ttu-id="1f6a3-140">也就是說，子網路必須在 Windows Server AD DS 中定義、建立網站、將子網路連接至該網站，並且使用適當的網站連結連接到其他網站。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-140">That is, subnets must be defined in Windows Server AD DS, a site created, the subnets linked to that site, and connected to other sites using appropriate site-links.</span></span> <span data-ttu-id="1f6a3-141">不過，所有 Azure 部署有一些常見的差異，有些則會依據特定部署案例而異。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-141">There are, however, some differences that are common to all Azure deployments and some that vary according to the specific deployment scenario.</span></span> <span data-ttu-id="1f6a3-142">兩個基本差異如下所列︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-142">Two fundamental differences are outlined below:</span></span>

### <a name="azure-virtual-machines-may-need-connectivity-to-the-on-premises-corporate-network"></a><span data-ttu-id="1f6a3-143">Azure 虛擬機器可能需要連接到內部部署公司網路。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-143">Azure virtual machines may need connectivity to the on-premises corporate network.</span></span>
<span data-ttu-id="1f6a3-144">將 Azure 虛擬機器連接回內部部署公司網路需要 Azure 虛擬網路，其中包括站對站或站對點虛擬私人網路 (VPN) 元件，能夠順暢連接 Azure 虛擬機器與內部部署機器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-144">Connecting Azure virtual machines back to an on-premises corporate network requires Azure virtual network, which includes a site-to-site or site-to-point virtual private network (VPN) component able to seamlessly connect Azure virtual machines and on-premises machines.</span></span> <span data-ttu-id="1f6a3-145">這個 VPN 元件也可以讓內部部署網域成員電腦存取 Windows Server Active Directory 網域，其網域控制站於 Azure 虛擬機器上託管。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-145">This VPN component could also enable on-premises domain member computers to access a Windows Server Active Directory domain whose domain controllers are hosted exclusively on Azure virtual machines.</span></span> <span data-ttu-id="1f6a3-146">然而請務必注意，如果 VPN 失敗，取決於 Windows Server Active Directory 的驗證和其他作業也會失敗。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-146">It is important to note, though, that if the VPN fails, authentication and other operations that depend on Windows Server Active Directory will also fail.</span></span> <span data-ttu-id="1f6a3-147">雖然使用者可以使用現有的快取認證登入，所有票證尚未核發或已變過時的對等式或用戶端對伺服器驗證嘗試都會失敗。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-147">While users may be able to sign in using existing cached credentials, all peer-to-peer or client-to-server authentication attempts for which tickets have yet to be issued or have become stale will fail.</span></span>

<span data-ttu-id="1f6a3-148">請參閱[虛擬網路](http://azure.microsoft.com/documentation/services/virtual-network/)以取得示範影片和逐步教學課程清單，包括[在 Azure 入口網站中設定站對站 VPN](../vpn-gateway/vpn-gateway-site-to-site-create.md)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-148">See [Virtual Network](http://azure.microsoft.com/documentation/services/virtual-network/) for a demonstration video and a list of step-by-step tutorials, including [Configure a Site-to-Site VPN in the Azure portal](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>

> [!NOTE]
> <span data-ttu-id="1f6a3-149">您也可以未連接內部部署網路的 Azure 虛擬網路上部署 Windows Server Active Directory。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-149">You can also deploy Windows Server Active Directory on an Azure virtual network that does not have connectivity with an on-premises network.</span></span> <span data-ttu-id="1f6a3-150">不過，本主題中的指導方針會假設使用 Azure 虛擬網路，因為它提供 Windows Server 必要的 IP 位址功能。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-150">The guidelines in this topic, however, assume that an Azure virtual network is used because it provides IP addressing capabilities that are essential to Windows Server.</span></span>
> 
> 

### <a name="static-ip-addresses-must-be-configured-with-azure-powershell"></a><span data-ttu-id="1f6a3-151">必須使用 Azure PowerShell 設定靜態 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-151">Static IP addresses must be configured with Azure PowerShell.</span></span>
<span data-ttu-id="1f6a3-152">預設會配置動態位址，但是請改為使用 Set-AzureStaticVNetIP Cmdlet 以指派靜態 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-152">Dynamic addresses are allocated by default, but use the Set-AzureStaticVNetIP cmdlet to assign a static IP address instead.</span></span> <span data-ttu-id="1f6a3-153">這樣會設定靜態 IP 位址，在服務修復和 VM 關機/重新啟動期間是持續性的。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-153">That sets a static IP address that will persist through service healing and VM shutdown/restart.</span></span> <span data-ttu-id="1f6a3-154">如需詳細資訊，請參閱 [虛擬機器的靜態內部 IP 位址](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-154">For more information, see [Static internal IP address for virtual machines](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/).</span></span>

## <span data-ttu-id="1f6a3-155"><a name="BKMK_Glossary"></a>詞彙和定義</span><span class="sxs-lookup"><span data-stu-id="1f6a3-155"><a name="BKMK_Glossary"></a>Terms and definitions</span></span>
<span data-ttu-id="1f6a3-156">以下是各種 Azure 技術詞彙的非詳盡清單，您將在本文中參考。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-156">The following is a non-exhaustive list of terms for various Azure technologies which will be referenced in this article.</span></span>

* <span data-ttu-id="1f6a3-157">Azure 虛擬機器︰Azure 中的 IaaS 方案，可讓客戶部署 VM，執行幾乎任何傳統式內部部署伺服器工作負載。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-157">**Azure virtual machines**: The IaaS offering in Azure that allows customers to deploy VMs running nearly any traditionally on-premises server workload.</span></span>
* <span data-ttu-id="1f6a3-158">Azure 虛擬網路︰Azure 中的網路服務，可讓客戶建立和管理 Azure 中的虛擬網路，以及安全地連結到他們自己的內部部署網路基礎結構，方法是使用虛擬私人網路 (VPN)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-158">**Azure virtual network**: The networking service in Azure that lets customers create and manage virtual networks in Azure and securely link them to their own on-premises networking infrastructure by using a virtual private network (VPN).</span></span>
* <span data-ttu-id="1f6a3-159">虛擬 IP 位址︰未繫結至特定電腦或網路介面卡的網際網路對應 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-159">**Virtual IP address**: An internet-facing IP address that is not bound to a specific computer or network interface card.</span></span> <span data-ttu-id="1f6a3-160">雲端服務獲指派虛擬 IP，用於接收重新導向至 Azure VM 的網路流量。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-160">Cloud services are assigned a virtual IP address for receiving network traffic which is redirected to an Azure VM.</span></span> <span data-ttu-id="1f6a3-161">虛擬 IP 位址是雲端服務的屬性，該雲端服務可包含一或多個 Azure 虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-161">A virtual IP address is a property of a cloud-service which can contain one or more Azure virtual machines.</span></span> <span data-ttu-id="1f6a3-162">另外請注意，Azure 虛擬網路可以包含一或多個雲端服務。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-162">Also note that an Azure virtual network can contain one or more cloud-services.</span></span> <span data-ttu-id="1f6a3-163">虛擬 IP 位址提供原生負載平衡功能。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-163">Virtual IP addresses provide native load-balancing capabilities.</span></span>
* <span data-ttu-id="1f6a3-164">動態 IP 位址︰這是僅供內部使用的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-164">**Dynamic IP address**: This is the IP address that is internal only.</span></span> <span data-ttu-id="1f6a3-165">它應該針對託管 DC/DNS 伺服器角色的 VM，設定為靜態 IP 位址 (方法是使用 Set-AzureStaticVNetIP Cmdlet)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-165">It should be configured as a static IP address (by using the Set-AzureStaticVNetIP cmdlet) for VMs that host the DC/DNS server roles.</span></span>
* <span data-ttu-id="1f6a3-166">服務修復：Azure 在偵測到某個服務失敗之後，讓該服務自動返回執行中狀態的程序。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-166">**Service healing**: The process in which Azure automatically returns a service to a running state again after it detects that the service has failed.</span></span> <span data-ttu-id="1f6a3-167">服務修復是 Azure 支援可用性和恢復功能的其中一個層面。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-167">Service healing is one of the aspects of Azure that supports availability and resiliency.</span></span> <span data-ttu-id="1f6a3-168">雖然不太可能，在 VM 上執行的 DC 服務修復事件的後續結果與未規劃的重新開機類似，但是有一些副作用︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-168">While unlikely, the result following a service healing incident for a DC running on a VM is similar to an unplanned reboot, but has a few side-effects:</span></span>
  
  * <span data-ttu-id="1f6a3-169">VM 中的虛擬網路介面卡將會變更</span><span class="sxs-lookup"><span data-stu-id="1f6a3-169">The virtual network adapter in the VM will change</span></span>
  * <span data-ttu-id="1f6a3-170">虛擬網路介面卡的 MAC 位址將會變更</span><span class="sxs-lookup"><span data-stu-id="1f6a3-170">The MAC address of the virtual network adapter will change</span></span>
  * <span data-ttu-id="1f6a3-171">VM 的處理器/CPU 識別碼將會變更</span><span class="sxs-lookup"><span data-stu-id="1f6a3-171">The Processor/CPU ID of the VM will change</span></span>
  * <span data-ttu-id="1f6a3-172">只要 VM 連接至虛擬網路且 VM 的 IP 位址是靜態，虛擬網路介面卡的 IP 組態就不會變更。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-172">The IP configuration of the virtual network adapter will not change as long as the VM is attached to a virtual network and the VM’s IP address is static.</span></span>
  
  <span data-ttu-id="1f6a3-173">但是，這些行為會影響 Windows Server Active Directory，因為它的 MAC 位址或處理器/CPU 識別碼沒有相依性，並且在 Azure 上的所有 Windows Server Active Directory 部署都建議在 Azure 虛擬網路上執行，如上所述。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-173">None of these behaviors affect Windows Server Active Directory because it has no dependency on the MAC address or Processor/CPU ID, and all Windows Server Active Directory deployments on Azure are recommended to be run on an Azure virtual network as outlined above.</span></span>

## <a name="is-it-safe-to-virtualize-windows-server-active-directory-domain-controllers"></a><span data-ttu-id="1f6a3-174">虛擬化 Windows Server Active Directory 網域控制站是否安全？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-174">Is it safe to virtualize Windows Server Active Directory domain controllers?</span></span>
<span data-ttu-id="1f6a3-175">在 Azure 虛擬機器上部署 Windows Server Active Directory DC 受限於與在虛擬機器中內部部署執行 DC 相同的指導方針。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-175">Deploying Windows Server Active Directory DCs on Azure virtual machines is subject to the same guidelines as running DCs on-premises in a virtual machine.</span></span> <span data-ttu-id="1f6a3-176">只要遵循備份和還原 DC 的指導方針，那麼執行虛擬化 DC 是安全的作法。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-176">Running virtualized DCs is a safe practice as long as guidelines for backing up and restoring DCs are followed.</span></span> <span data-ttu-id="1f6a3-177">如需執行虛擬化 DC 的條件約束和指導方針的詳細資訊，請參閱 [在 Hyper-V 中執行網域控制站](https://technet.microsoft.com/library/dd363553)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-177">For more information about constraints and guidelines for running virtualized DCs, see [Running Domain Controllers in Hyper-V](https://technet.microsoft.com/library/dd363553).</span></span>

<span data-ttu-id="1f6a3-178">Hypervisor 提供或忽略技術，可能會造成許多分散式系統的問題，包括 Windows Server Active Directory。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-178">Hypervisors provide or trivialize technologies that can cause problems for many distributed systems, including Windows Server Active Directory.</span></span> <span data-ttu-id="1f6a3-179">例如，在實體伺服器上，您可以複製磁碟或使用不受支援的方法來回復伺服器的狀態，包括使用 SAN 等等；但是在實體伺服器上這樣做，遠比在 hypervisor 中還原虛擬機器快照還要困難。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-179">For example, on a physical server, you can clone a disk or use unsupported methods to roll back the state of a server, including using SANs and so on, but doing that on a physical server is much harder than restoring a virtual machine snapshot in a hypervisor.</span></span> <span data-ttu-id="1f6a3-180">Azure 提供的功能，可能會導致相同的非預期狀況。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-180">Azure offers functionality that can result in the same undesirable condition.</span></span> <span data-ttu-id="1f6a3-181">例如，您不應該複製 DC 的 VHD 檔案，而是應該執行定期備份，因為還原它們可能導致與使用快照還原功能類似的狀況。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-181">For example, you should not copy VHD files of DCs instead of performing regular backups because restoring them can result in a similar situation to using snapshot restore features.</span></span>

<span data-ttu-id="1f6a3-182">這類回復會引進 USN 泡沫，可能導致 DC 之間永久的分歧狀態。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-182">Such rollbacks introduce USN bubbles that can lead to permanently divergent states between DCs.</span></span> <span data-ttu-id="1f6a3-183">這可能會導致以下問題︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-183">That can cause issues such as:</span></span>

* <span data-ttu-id="1f6a3-184">停留物件</span><span class="sxs-lookup"><span data-stu-id="1f6a3-184">Lingering objects</span></span>
* <span data-ttu-id="1f6a3-185">密碼不一致</span><span class="sxs-lookup"><span data-stu-id="1f6a3-185">Inconsistent passwords</span></span>
* <span data-ttu-id="1f6a3-186">屬性值不一致</span><span class="sxs-lookup"><span data-stu-id="1f6a3-186">Inconsistent attribute values</span></span>
* <span data-ttu-id="1f6a3-187">如果回復主要結構描述則結構描述不相符</span><span class="sxs-lookup"><span data-stu-id="1f6a3-187">Schema mismatches if the schema master is rolled back</span></span>

<span data-ttu-id="1f6a3-188">如需 DC 如何受到影響的詳細資訊，請參閱 [USN 和 USN 回復](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx#usn_and_usn_rollback)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-188">For more information about how DCs are impacted, see [USN and USN Rollback](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv.aspx#usn_and_usn_rollback).</span></span>

<span data-ttu-id="1f6a3-189">從 Windows Server 2012 開始， [額外的保護措施已內建至 AD DS](https://technet.microsoft.com/library/hh831734.aspx)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-189">Beginning with Windows Server 2012, [additional safeguards are built in to AD DS](https://technet.microsoft.com/library/hh831734.aspx).</span></span> <span data-ttu-id="1f6a3-190">只要基礎 hypervisor 平台支援 VM-GenerationID，這些保護措施就能協助保護虛擬化網域控制站避免上述問題。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-190">These safeguards help protect virtualized domain controllers against the aforementioned problems, as long as the underlying hypervisor platform supports VM-GenerationID.</span></span> <span data-ttu-id="1f6a3-191">Azure 支援 VM-GenerationID，這表示在 Azure 虛擬機器上執行 Windows Server 2012 或更新版本的的網域控制站具有額外的保護措施。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-191">Azure supports VM-GenerationID, which means that domain controllers that run Windows Server 2012 or later on Azure virtual machines have the additional safeguards.</span></span>

> [!NOTE]
> <span data-ttu-id="1f6a3-192">您應該關閉並重新啟動 VM (在客體作業系統內的 Azure 中執行網域控制站角色)，而不是使用 Azure 入口網站的 [關機] 選項。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-192">You should shut down and restart a VM that runs the domain controller role in Azure within the guest operating system instead of using the **Shut Down** option in the Azure porta.</span></span> <span data-ttu-id="1f6a3-193">目前，使用入口網站關閉 VM 會造成 VM 無法解除配置。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-193">Today, using the portal to shut down a VM causes the VM to be deallocated.</span></span> <span data-ttu-id="1f6a3-194">解除配置的 VM 的優點是不會產生費用，但它也會重設 VM-GenerationID，這對於 DC 不是預期的結果。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-194">A deallocated VM has the advantage of not incurring charges, but it also resets the VM-GenerationID, which is undesirable for a DC.</span></span> <span data-ttu-id="1f6a3-195">當 VM-GenerationID 重設時，也會重設 AD DS 資料庫的 invocationID、捨棄 RID 集區，且 SYSVOL 會標示為非授權。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-195">When the VM-GenerationID is reset, the invocationID of the AD DS database is also reset, the RID pool is discarded, and SYSVOL is marked as non-authoritative.</span></span> <span data-ttu-id="1f6a3-196">如需詳細資訊，請參閱 [Active Directory Domain Services (AD DS) 虛擬化的簡介](https://technet.microsoft.com/library/hh831734.aspx)和[安全的虛擬化 DFSR](http://blogs.technet.com/b/filecab/archive/2013/04/05/safely-virtualizing-dfsr.aspx)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-196">For more information, see [Introduction to Active Directory Domain Services (AD DS) Virtualization](https://technet.microsoft.com/library/hh831734.aspx) and [Safely Virtualizing DFSR](http://blogs.technet.com/b/filecab/archive/2013/04/05/safely-virtualizing-dfsr.aspx).</span></span>
> 
> 

## <a name="why-deploy-windows-server-ad-ds-on-azure-virtual-machines"></a><span data-ttu-id="1f6a3-197">為什麼要在 Azure 虛擬機器上部署 Windows Server AD DS？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-197">Why deploy Windows Server AD DS on Azure Virtual Machines?</span></span>
<span data-ttu-id="1f6a3-198">許多 Windows Server AD DS 部署案例都非常適合部署為 Azure 上的 VM。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-198">Many Windows Server AD DS deployment scenarios are well-suited for deployment as VMs on Azure.</span></span> <span data-ttu-id="1f6a3-199">例如，假設您有一家公司在歐洲，需要驗證位於亞洲遠端位置中的使用者。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-199">For example, suppose you have a company in Europe that needs to authenticate users in a remote location in Asia.</span></span> <span data-ttu-id="1f6a3-200">由於部署的成本以及他們對於管理部署後伺服器的專業知識有限，該公司之前尚未在亞洲部署 Windows Server Active Directory DC。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-200">The company has not previously deployed Windows Server Active Directory DCs in Asia due to the cost to deploy them and limited expertise to manage the servers post-deployment.</span></span> <span data-ttu-id="1f6a3-201">如此一來，來自亞洲的驗證要求會由在歐洲的 DC 提供服務，結果不理想。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-201">As a result, authentication requests from Asia are serviced by DCs in Europe with suboptimal results.</span></span> <span data-ttu-id="1f6a3-202">在此情況下，您可以在 VM 上部署 DC，該 VM 必須於亞洲的 Azure 資料中心內執行。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-202">In this case, you can deploy a DC on a VM that you have specified must be run within the Azure datacenter in Asia.</span></span> <span data-ttu-id="1f6a3-203">將該 DC 連接至直接連接到遠端位置的 Azure 虛擬網路會提高驗證效能。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-203">Attaching that DC to an Azure virtual network that is connected directly to the remote location will improve authentication performance.</span></span>

<span data-ttu-id="1f6a3-204">Azure 也非常適合替代耗費成本的災害復原 (DR) 網站。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-204">Azure is also well-suited as a substitute to otherwise costly disaster recovery (DR) sites.</span></span> <span data-ttu-id="1f6a3-205">託管少量網域控制站和在 Azure 上的單一虛擬網路的相對低廉成本，是極具吸引力的替代方案。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-205">The relatively low-cost of hosting a small number of domain controllers and a single virtual network on Azure represents an attractive alternative.</span></span>

<span data-ttu-id="1f6a3-206">最後，您會希望在 Azure 上部署 SharePoint 等網路應用程式，如此一來就需要 Windows Server Active Directory，但是不相依於內部部署網路或公司 Windows Server Active Directory。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-206">Finally, you may want to deploy a network application on Azure, such as SharePoint, that requires Windows Server Active Directory but has no dependency on the on-premises network or the corporate Windows Server Active Directory.</span></span> <span data-ttu-id="1f6a3-207">在此情況下，在 Azure 上部署隔離的樹系以符合 SharePoint 伺服器的要求是最佳作法。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-207">In this case, deploying an isolated forest on Azure to meet the SharePoint server’s requirements is optimal.</span></span> <span data-ttu-id="1f6a3-208">同樣地，也支援部署需要連接到內部部署網路與公司 Active Directory 的網路應用程式。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-208">Again, deploying network applications that do require connectivity to the on-premises network and the corporate Active Directory is also supported.</span></span>

> [!NOTE]
> <span data-ttu-id="1f6a3-209">因為它提供 Layer-3 連接，在 Azure 虛擬網路與內部部署網路之間提供連接的 VPN 元件也可以啟用在內部部署執行的成員伺服器，進而運用在 Azure 虛擬網路作為 Azure 虛擬機器執行的 DC。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-209">Since it provides a layer-3 connection, the VPN component that provides connectivity between an Azure virtual network and an on-premises network can also enable member servers that run on-premises to leverage DCs that run as Azure virtual machines on Azure virtual network.</span></span> <span data-ttu-id="1f6a3-210">但是如果 VPN 無法使用，內部部署電腦與以 Azure 為基礎的網域控制站之間的通訊將無法運作，因而導致驗證和其他各種錯誤發生。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-210">But if the VPN is unavailable, communication between on-premises computers and Azure-based domain controllers will not function, resulting in authentication and various other errors.</span></span>  
> 
> 

## <a name="contrasts-between-deploying-windows-server-active-directory-domain-controllers-on-azure-virtual-machines-versus-on-premises"></a><span data-ttu-id="1f6a3-211">在 Azure 虛擬機器上與在內部部署上部署 Windows Server Active Directory 網域控制站之間的對照</span><span class="sxs-lookup"><span data-stu-id="1f6a3-211">Contrasts between deploying Windows Server Active Directory domain controllers on Azure Virtual Machines versus on-premises</span></span>
* <span data-ttu-id="1f6a3-212">對於包含多部 VM 的任何 Windows Server Active Directory 部署案例，必須使用 Azure 虛擬網路讓 IP 位址保時一致。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-212">For any Windows Server Active Directory deployment scenario that includes more than a single VM, it is necessary to use an Azure virtual network for IP address consistency.</span></span> <span data-ttu-id="1f6a3-213">請注意，本指南假設 DC 在 Azure 虛擬網路上執行。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-213">Note that this guide assumes that DCs are running on an Azure virtual network.</span></span>
* <span data-ttu-id="1f6a3-214">如同內部部署 DC，建議使用靜態 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-214">As with on-premises DCs, static IP addresses are recommended.</span></span> <span data-ttu-id="1f6a3-215">靜態 IP 位址只能使用 Azure PowerShell 進行設定。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-215">A static IP address can only be configured by using Azure PowerShell.</span></span> <span data-ttu-id="1f6a3-216">如需詳細資訊，請參閱 [VM 的靜態內部 IP 位址](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/) 。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-216">See [Static internal IP address for VMs](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/) for more details.</span></span> <span data-ttu-id="1f6a3-217">如果您有監控系統，或其他檢查客體作業系統內靜態 IP 位址組態的解決方案，可以指派相同的靜態 IP 位址給 VM 網路介面卡屬性。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-217">If you have monitoring systems or other solutions that check for static IP address configuration within the guest operating system, you can assign the same static IP address to the network adapter properties of the VM.</span></span> <span data-ttu-id="1f6a3-218">但是請注意，如果 VM 正在進行服務修復或在入口網站中關機，且已解除配置其位址，則將會捨棄網路介面卡。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-218">But be aware that the network adapter will be discarded if the VM undergoes service healing or is shut down in the portal and has its address deallocated.</span></span> <span data-ttu-id="1f6a3-219">在此情況下，必須重設客體內的靜態 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-219">In that case, the static IP address within the guest will need to be reset.</span></span>
* <span data-ttu-id="1f6a3-220">在虛擬網路上部署 VM 不代表 (或需要) 連接回內部部署網路；只是表示虛擬網路有這個可能性。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-220">Deploying VMs on a virtual network does not imply (or require) connectivity back to an on-premises network; the virtual network merely enables that possibility.</span></span> <span data-ttu-id="1f6a3-221">您必須建立虛擬網路以在 Azure 和您的內部部署網路之間進行私密通訊。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-221">You must create a virtual network for private communication between Azure and your on-premises network.</span></span> <span data-ttu-id="1f6a3-222">您必須在內部部署網路上部署 VPN 端點。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-222">You need to deploy a VPN endpoint on the on-premises network.</span></span> <span data-ttu-id="1f6a3-223">VPN 會從 Azure 開啟到內部部署網路。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-223">The VPN is opened from Azure to the on-premises network.</span></span> <span data-ttu-id="1f6a3-224">如需詳細資訊，請參閱[虛擬網路概觀](../virtual-network/virtual-networks-overview.md)和[在 Azure 入口網站中設定站對站 VPN](../vpn-gateway/vpn-gateway-site-to-site-create.md)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-224">For more information, see [Virtual Network Overview](../virtual-network/virtual-networks-overview.md) and [Configure a Site-to-Site VPN in the Azure Portal](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>

> [!NOTE]
> <span data-ttu-id="1f6a3-225">選擇 [建立點對站 VPN](../vpn-gateway/vpn-gateway-point-to-site-create.md) 可以將個別的以 Windows 為基礎的電腦直接連接到 Azure 虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-225">An option to [create a point-to-site VPN](../vpn-gateway/vpn-gateway-point-to-site-create.md) is available to connect individual Windows-based computers directly to an Azure virtual network.</span></span>
> 
> 

* <span data-ttu-id="1f6a3-226">不論您是否建立虛擬網路，Azure 會針對輸出流量計費，而不會對輸入流量計費。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-226">Regardless of whether you create a virtual network or not, Azure charges for egress traffic but not ingress.</span></span> <span data-ttu-id="1f6a3-227">不同的 Windows Server Active Directory 設計選擇會影響部署產生的輸出流量。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-227">Various Windows Server Active Directory design choices can affect how much egress traffic is generated by a deployment.</span></span> <span data-ttu-id="1f6a3-228">例如，部署唯讀網域控制站 (RODC) 會限制輸出流量，因為它不會複寫輸出。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-228">For example, deploying a read-only domain controller (RODC) limits egress traffic because it does not replicate outbound.</span></span> <span data-ttu-id="1f6a3-229">但是部署 RODC 的決策必須權衡針對 DC 執行寫入作業的需求，和網站中的應用程式和服務與 RODC 的 [相容性](https://technet.microsoft.com/library/cc755190) 。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-229">But the decision to deploy an RODC needs to be weighed against the need to perform write operations against the DC and the [compatibility](https://technet.microsoft.com/library/cc755190) that applications and services in the site have with RODCs.</span></span> <span data-ttu-id="1f6a3-230">如需流量費用的詳細資訊，請參閱 [Azure 價格一覽](http://azure.microsoft.com/pricing/)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-230">For more information about traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span>
* <span data-ttu-id="1f6a3-231">雖然您可以完全控制要用於 VM 內部部署的伺服器資源，例如 RAM、磁碟大小等等，但在 Azure 上您必須從預先設定的伺服器大小清單中選取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-231">While you have complete control over what server resources to use for VMs on-premises, such as RAM, disk size, and so on, on Azure you must select from a list of preconfigured server sizes.</span></span> <span data-ttu-id="1f6a3-232">對於 DC，除了作業系統磁碟以外，還需要資料磁碟，以便儲存 Windows Server Active Directory 資料庫。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-232">For a DC, a data disk is needed in addition to the operating system disk in order to store the Windows Server Active Directory database.</span></span>

## <a name="can-you-deploy-windows-server-ad-fs-on-azure-virtual-machines"></a><span data-ttu-id="1f6a3-233">是否可以在 Azure 虛擬機器上部署 Windows Server AD FS？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-233">Can you deploy Windows Server AD FS on Azure virtual machines?</span></span>
<span data-ttu-id="1f6a3-234">是，您可以在 Azure 虛擬機器上部署 Windows Server AD FS，內部部署 [AD FS 部署的最佳作法](https://technet.microsoft.com/library/dn151324.aspx) 同樣適用於在 Azure 上部署 AD FS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-234">Yes, you can deploy Windows Server AD FS on Azure virtual machines, and the [best practices for AD FS deployment](https://technet.microsoft.com/library/dn151324.aspx) on-premises apply equally to AD FS deployment on Azure.</span></span> <span data-ttu-id="1f6a3-235">但是某些最佳作法，例如負載平衡和高可用性，需要超越 AD FS 方案本身的技術。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-235">But some of the best practices such as load balancing and high availability require technologies beyond what AD FS offers itself.</span></span> <span data-ttu-id="1f6a3-236">這些作法必須由基礎結構提供。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-236">They must be provided by the underlying infrastructure.</span></span> <span data-ttu-id="1f6a3-237">讓我們複習這些最佳作法，並且使用 Azure VM 和 Azure 虛擬網路來查看如何達成。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-237">Let’s review some of those best practices and see how they can be achieved by using Azure VMs and an Azure virtual network.</span></span>

1. <span data-ttu-id="1f6a3-238">**永遠不會直接將 Security Token Service (STS) 伺服器公開至網際網路。**</span><span class="sxs-lookup"><span data-stu-id="1f6a3-238">**Never expose security token service (STS) servers directly to the Internet.**</span></span>
   
    <span data-ttu-id="1f6a3-239">因為 STS 會發出安全性權杖，所以這一點很重要。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-239">This is important because the STS issues security tokens.</span></span> <span data-ttu-id="1f6a3-240">如此一來，應該以與網域控制站相同的保護層級來處理 STS 伺服器 (例如 AD FS 伺服器)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-240">As a result, STS servers such as AD FS servers should be treated with the same level of protection as a domain controller.</span></span> <span data-ttu-id="1f6a3-241">如果 STS 遭到入侵，惡意使用者有能力發出存取權杖，可能包含他們對於信任組織中的信賴憑證者應用程式以及其他 STS 伺服器的選擇的宣告。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-241">If an STS is compromised, malicious users have the ability to issue access tokens potentially containing claims of their choosing to relying party applications and other STS servers in trusting organizations.</span></span>
2. <span data-ttu-id="1f6a3-242">**針對相同網路中的所有使用者網域將 Active Directory 網域控制站部署為 AD FS 伺服器。**</span><span class="sxs-lookup"><span data-stu-id="1f6a3-242">**Deploy Active Directory domain controllers for all user domains in the same network as the AD FS servers.**</span></span>
   
    <span data-ttu-id="1f6a3-243">AD FS 伺服器使用 Active Directory 網域服務來驗證使用者。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-243">AD FS servers use Active Directory Domain Services to authenticate users.</span></span> <span data-ttu-id="1f6a3-244">建議在相同網路上將網域控制站部署為 AD FS 伺服器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-244">It is recommended to deploy domain controllers on the same network as the AD FS servers.</span></span> <span data-ttu-id="1f6a3-245">如果 Azure 網路與內部部署網路之間的連結中斷，這會提供業務持續性，並且針對登入縮短延遲和提高效能。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-245">This provides business continuity in case the link between the Azure network and your on-premises network is broken, and enables lower latency and increased performance for logins.</span></span>
3. <span data-ttu-id="1f6a3-246">**部署多個 AD FS 節點以取得高可用性和平衡負載。**</span><span class="sxs-lookup"><span data-stu-id="1f6a3-246">**Deploy multiple AD FS nodes for high availability and balancing the load.**</span></span>
   
    <span data-ttu-id="1f6a3-247">在大部分情況下，AD FS 啟用的應用程式失敗是無法接受的，因為需要安全性權杖的應用程式往往非常關鍵。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-247">In most cases, the failure of an application that AD FS enables is unacceptable because the applications that require security tokens are often mission critical.</span></span> <span data-ttu-id="1f6a3-248">因此，由於 AD FS 目前位於存取關鍵任務應用程式的關鍵路徑中，AD FS 服務可透過多個 AD FS Proxy 和 AD FS 伺服器成為可用性十分高的服務。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-248">As a result, and because AD FS now resides in the critical path to accessing mission critical applications, the AD FS service must be highly available through multiple AD FS proxies and AD FS servers.</span></span> <span data-ttu-id="1f6a3-249">若要達到要求的分佈，通常會將負載平衡器部署在 AD FS Proxy 和 AD FS 伺服器前面。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-249">To achieve distribution of requests, load balancers are typically deployed in front of both the AD FS Proxies and the AD FS servers.</span></span>
4. <span data-ttu-id="1f6a3-250">**針對網際網路存取部署一或多個 Web 應用程式 Proxy 節點。**</span><span class="sxs-lookup"><span data-stu-id="1f6a3-250">**Deploy one or more Web Application Proxy nodes for internet access.**</span></span>
   
    <span data-ttu-id="1f6a3-251">當使用者需要存取受 AD FS 服務保護的應用程式時，必須可從網際網路取得 AD FS 服務。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-251">When users need to access applications protected by the AD FS service, the AD FS service needs to be available from the internet.</span></span> <span data-ttu-id="1f6a3-252">這可透過部署 Web 應用程式 Proxy 服務來達成。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-252">This is achieved by deploying the Web Application Proxy service.</span></span> <span data-ttu-id="1f6a3-253">為了達成高可用性和負載平衡的目的，強烈建議部署多個節點。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-253">It is strongly recommended to deploy more than one node for the purposes of high availability and load balancing.</span></span>
5. <span data-ttu-id="1f6a3-254">**從 Web 應用程式 Proxy 節點限制存取內部網路資源。**</span><span class="sxs-lookup"><span data-stu-id="1f6a3-254">**Restrict access from the Web Application Proxy nodes to internal network resources.**</span></span>
   
    <span data-ttu-id="1f6a3-255">若要允許外部使用者從網際網路存取 AD FS，您需要部署 Web 應用程式 Proxy 節點 (或在舊版的 Windows Server 部署 AD FS Proxy)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-255">To allow external users to access AD FS from the internet, you need to deploy Web Application Proxy nodes (or AD FS Proxy in earlier versions of Windows Server).</span></span> <span data-ttu-id="1f6a3-256">Web 應用程式 proxy 節點會直接在網際網路公開。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-256">The Web Application proxy nodes are directly exposed to the Internet.</span></span> <span data-ttu-id="1f6a3-257">它們不一定要加入網域，而且只需要透過 TCP 連接埠 443 和 80 存取 AD FS 伺服器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-257">They are not required to be domain-joined and they only need access to the AD FS servers over TCP ports 443 and 80.</span></span> <span data-ttu-id="1f6a3-258">強烈建議封鎖其他所有電腦 (尤其是網域控制站) 的通訊。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-258">It is strongly recommended that communication to all other computers (especially domain controllers) is blocked.</span></span>
   
    <span data-ttu-id="1f6a3-259">這通常是藉由 DMZ 的方式在內部部署達成。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-259">This is typically achieved on-premises by means of a DMZ.</span></span> <span data-ttu-id="1f6a3-260">防火牆會使用作業的白名單模式，將來自 DMZ 的流量限制為內部部署網路 (亦即，僅允許來自指定 IP 位址且透過指定連接埠的流量，並且會封鎖所有其他流量)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-260">Firewalls use a whitelist mode of operation to restrict traffic from the DMZ to the on-premises network (that is, only traffic from the specified IP addresses and over specified ports is allowed, and all other traffic is blocked).</span></span>

<span data-ttu-id="1f6a3-261">下圖顯示傳統的內部部署 AD FS 部署。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-261">The following diagram shows a traditional on-premises AD FS deployment.</span></span>

![傳統內部部署 Active Directory Federation Services 部署的圖表](media/active-directory-deploying-ws-ad-guidelines/ADFS_onprem.png)

<span data-ttu-id="1f6a3-263">不過，因為 Azure 未提供原生、功能完整的防火牆功能，必須使用其他選項來限制流量。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-263">However, because Azure does not provide native, full-featured firewall capability, other options need to be used to restrict traffic.</span></span> <span data-ttu-id="1f6a3-264">下表顯示每個選項及其優缺點。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-264">The following table shows each option and its advantages and disadvantages.</span></span>

| <span data-ttu-id="1f6a3-265">選項</span><span class="sxs-lookup"><span data-stu-id="1f6a3-265">Option</span></span> | <span data-ttu-id="1f6a3-266">優點</span><span class="sxs-lookup"><span data-stu-id="1f6a3-266">Advantage</span></span> | <span data-ttu-id="1f6a3-267">缺點</span><span class="sxs-lookup"><span data-stu-id="1f6a3-267">Disadvantage</span></span> |
| --- | --- | --- |
| [<span data-ttu-id="1f6a3-268">Azure 網路 ACL</span><span class="sxs-lookup"><span data-stu-id="1f6a3-268">Azure network ACLs</span></span>](../virtual-network/virtual-networks-acl.md) |<span data-ttu-id="1f6a3-269">較便宜又簡單的初始組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-269">Less costly and simpler initial configuration</span></span> |<span data-ttu-id="1f6a3-270">如果在部署中加入任何新的 VM，則需要額外的網路 ACL 組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-270">Additional network ACL configuration required if any new VMs are added to the deployment</span></span> |
| [<span data-ttu-id="1f6a3-271">Barracuda NG 防火牆</span><span class="sxs-lookup"><span data-stu-id="1f6a3-271">Barracuda NG firewall</span></span>](https://www.barracuda.com/products/ngfirewall) |<span data-ttu-id="1f6a3-272">作業的白名單模式且不需要網路 ACL 組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-272">Whitelist mode of operation and it requires no network ACL configuration</span></span> |<span data-ttu-id="1f6a3-273">初始設定的增加成本與複雜度</span><span class="sxs-lookup"><span data-stu-id="1f6a3-273">Increased cost and complexity for initial setup</span></span> |

<span data-ttu-id="1f6a3-274">在此情況下部署 AD FS 的高階步驟，如下所示︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-274">The high-level steps to deploy AD FS in this case are as follows:</span></span>

1. <span data-ttu-id="1f6a3-275">使用 VPN 或 [ExpressRoute](http://azure.microsoft.com/services/expressroute/)，建立具有跨單位連線的虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-275">Create a virtual network with cross-premises connectivity, using either a VPN or [ExpressRoute](http://azure.microsoft.com/services/expressroute/).</span></span>
2. <span data-ttu-id="1f6a3-276">在虛擬網路上部署網域控制站。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-276">Deploy domain controllers on the virtual network.</span></span> <span data-ttu-id="1f6a3-277">此步驟為選用步驟，但建議執行。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-277">This step is optional but recommended.</span></span>
3. <span data-ttu-id="1f6a3-278">在虛擬網路上部署已加入網域的 AD FS 伺服器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-278">Deploy domain-joined AD FS servers on the virtual network.</span></span>
4. <span data-ttu-id="1f6a3-279">建立 [內部負載平衡集](http://azure.microsoft.com/blog/internal-load-balancing/) ，包括 AD FS 伺服器，並且在虛擬網路內使用新的私人 IP 位址 (動態 IP 位址)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-279">Create an [internal load balanced set](http://azure.microsoft.com/blog/internal-load-balancing/) that includes the AD FS servers and uses a new private IP address within the virtual network (a dynamic IP address).</span></span>
   
   1. <span data-ttu-id="1f6a3-280">更新 DNS，建立 FQDN 以指向內部負載平衡集的私人 (動態) IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-280">Update DNS to create the FQDN to point to the private (dynamic) IP address of the internal load balanced set.</span></span>
5. <span data-ttu-id="1f6a3-281">針對 Web 應用程式 Proxy 節點建立雲端服務 (或不同的虛擬網路)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-281">Create a cloud service (or a separate virtual network) for the Web Application Proxy nodes.</span></span>
6. <span data-ttu-id="1f6a3-282">在雲端服務或虛擬網路中部署 Web 應用程式 Proxy 節點</span><span class="sxs-lookup"><span data-stu-id="1f6a3-282">Deploy the Web Application Proxy nodes in the cloud service or virtual network</span></span>
   
   1. <span data-ttu-id="1f6a3-283">建立外部負載平衡集，其中包括 Web 應用程式 Proxy 節點。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-283">Create an external load balanced set that includes the Web Application Proxy nodes.</span></span>
   2. <span data-ttu-id="1f6a3-284">更新外部 DNS 名稱 (FQDN)，以指向雲端服務公用 IP 位址 (虛擬 IP 位址)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-284">Update the external DNS name (FQDN) to point to the cloud service public IP address (the virtual IP address).</span></span>
   3. <span data-ttu-id="1f6a3-285">設定 AD FS Proxy，以針對 AD FS 伺服器使用對應至內部負載平衡集的 FQDN。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-285">Configure AD FS proxies to use the FQDN that corresponds to the internal load balanced set for the AD FS servers.</span></span>
   4. <span data-ttu-id="1f6a3-286">更新以宣告為基礎的網站以針對其宣告提供者使用外部 FQDN。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-286">Update claims-based web sites to use the external FQDN for their claims provider.</span></span>
7. <span data-ttu-id="1f6a3-287">將 Web 應用程式 Proxy 之間的存取限制為 AD FS 虛擬網路內的任何機器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-287">Restrict access between Web Application Proxy to any machine in the AD FS virtual network.</span></span>

<span data-ttu-id="1f6a3-288">若要限制流量，Azure 內部負載平衡器的負載平衡集必須設定為僅限至 TCP 連接埠 80 和 443 的流量，並且捨棄到負載平衡集的內部動態 IP 位址的所有其他流量。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-288">To restrict traffic, the load-balanced set for the Azure internal load balancer needs to be configured for only traffic to TCP ports 80 and 443, and all other traffic to the internal dynamic IP address of the load balanced set is dropped.</span></span>

![允許 TCP 443 + 80 的 ADFS 網路 ACL 的圖表。](media/active-directory-deploying-ws-ad-guidelines/ADFS_ACLs.png)

<span data-ttu-id="1f6a3-290">僅允許從下列來源到 AD FS 伺服器的流量︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-290">Traffic to the AD FS servers would be permitted only by the following sources:</span></span>

* <span data-ttu-id="1f6a3-291">Azure 內部負載平衡器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-291">The Azure internal load balancer.</span></span>
* <span data-ttu-id="1f6a3-292">內部部署網路上系統管理員的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-292">The IP address of an administrator on the on-premises network.</span></span>

> [!WARNING]
> <span data-ttu-id="1f6a3-293">設計必須防止 Web 應用程式 Proxy 節點到達 Azure 虛擬網路中的其他 VM，或內部部署網路上的任何位置。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-293">The design must prevent Web Application Proxy nodes from reaching any other VMs in the Azure virtual network or any locations on the on-premises network.</span></span> <span data-ttu-id="1f6a3-294">可以藉由針對 Express Route 連接設定內部部署應用裝置中的防火牆規則，或針對站對站 VPN 連接設定 VPN 裝置來完成這項操作。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-294">That can be done by configuring firewall rules in the on-premises appliance for Express Route connections or the VPN device for site-to-site VPN connections.</span></span>
> 
> 

<span data-ttu-id="1f6a3-295">此選項的缺點是需要設定多個裝置的網路 ACL，包括內部負載平衡器、AD FS 伺服器，以及加入至虛擬網路的任何其他伺服器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-295">A disadvantage to this option is the need to configure the network ACLs for multiple devices, including internal load balancer, the AD FS servers, and any other servers that get added to the virtual network.</span></span> <span data-ttu-id="1f6a3-296">如果在部署中加入任何裝置，但是未設定網路 ACL 以限制其流量，整個部署會處於風險中。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-296">If any device is added to the deployment without configuring network ACLs to restrict traffic to it, the entire deployment can be at risk.</span></span> <span data-ttu-id="1f6a3-297">如果 Web 應用程式 Proxy 節點的 IP 位址有所變更，必須重設網路 ACL (也就是說，Proxy 應該設定為使用 [靜態動態 IP 位址](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/))。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-297">If the IP addresses of the Web Application Proxy nodes ever change, the network ACLs must be reset (which means the proxies should be configured to use [static dynamic IP addresses](http://azure.microsoft.com/blog/static-internal-ip-address-for-virtual-machines/)).</span></span>

![使用網路 ACLS 的 Azure 上的 ADFS。](media/active-directory-deploying-ws-ad-guidelines/ADFS_Azure.png)

<span data-ttu-id="1f6a3-299">另一個選項是使用 [Barracuda NG Firewall](https://www.barracuda.com/products/ngfirewall) 應用裝置，以控制 AD FS Proxy 伺服器和 AD FS 伺服器之間的流量。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-299">Another option is to use the [Barracuda NG Firewall](https://www.barracuda.com/products/ngfirewall) appliance to control traffic between AD FS proxy servers and the AD FS servers.</span></span> <span data-ttu-id="1f6a3-300">這個選項會遵守安全性和高可用性的最佳作法，而且在初始設定之後需要的管理較少，因為 Barracuda NG Firewall 應用裝置提供防火牆管理的白名單模式，且可以直接在 Azure 虛擬網路上安裝。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-300">This option complies with best practices for security and high availability, and requires less administration after the initial setup because the Barracuda NG Firewall appliance provides a whitelist mode of firewall administration and it can be installed directly on an Azure virtual network.</span></span> <span data-ttu-id="1f6a3-301">這樣即排除每當新的伺服器加入至部署就要設定網路 ACL 的必要。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-301">That eliminates the need to configure network ACLs any time a new server is added to the deployment.</span></span> <span data-ttu-id="1f6a3-302">但是，此選項會增加初始部署的複雜度和成本。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-302">But this option adds initial deployment complexity and cost.</span></span>

<span data-ttu-id="1f6a3-303">在此情況下，會部署兩個虛擬網路而不是一個。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-303">In this case, two virtual networks are deployed instead of one.</span></span> <span data-ttu-id="1f6a3-304">我們稱之為 VNet1 和 VNet2。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-304">We'll call them VNet1 and VNet2.</span></span> <span data-ttu-id="1f6a3-305">VNet1 包含 Proxy，而 VNet2 包含 STS 和回到公司網路的網路連接。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-305">VNet1 contains the proxies and VNet2 contains the STSs and the network connection back to the corporate network.</span></span> <span data-ttu-id="1f6a3-306">因此 VNet1 實際上會 (幾乎是) 與 VNet2 隔離，接著，從公司網路隔離。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-306">VNet1 is therefore physically (albeit virtually) isolated from VNet2 and, in turn, from the corporate network.</span></span> <span data-ttu-id="1f6a3-307">然後 VNet1 會連接到 VNet2，使用已知為傳輸獨立網路架構 (TINA) 的特殊通道技術。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-307">VNet1 is then connected to VNet2 using a special tunneling technology known as Transport Independent Network Architecture (TINA).</span></span> <span data-ttu-id="1f6a3-308">TINA 通道會附加至每個使用 Barracuda NG Firewall 的虛擬網路 — 每個虛擬網路上的一個 Barracuda。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-308">The TINA tunnel is attached to each of the virtual networks using a Barracuda NG firewall—one Barracuda on each of the virtual networks.</span></span>  <span data-ttu-id="1f6a3-309">若要取得高可用性，建議您在每個虛擬網路上部署兩個 Barracuda，一個主動，另一個被動。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-309">For high-availability, it is recommended that you deploy two Barracudas on each virtual network; one active, the other passive.</span></span> <span data-ttu-id="1f6a3-310">它們提供非常豐富的防火牆功能，讓我們模擬 Azure 中傳統內部部署 DMZ 的作業。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-310">They offer extremely rich firewalling capabilities which allow us to mimic the operation of a traditional on-premises DMZ in Azure.</span></span>

![使用防火牆的 Azure 上的 ADFS。](media/active-directory-deploying-ws-ad-guidelines/ADFS_Azure_firewall.png)

<span data-ttu-id="1f6a3-312">如需詳細資訊，請參閱 [AD FS：將宣告感知內部部署前端應用程式擴充到網際網路](#BKMK_CloudOnlyFed)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-312">For more information, see [AD FS: Extend a claims-aware on-premises front-end application to the Internet](#BKMK_CloudOnlyFed).</span></span>

### <a name="an-alternative-to-ad-fs-deployment-if-the-goal-is-office-365-sso-alone"></a><span data-ttu-id="1f6a3-313">如果目標只有 Office 365 SSO，有替代的 AD FS 部署</span><span class="sxs-lookup"><span data-stu-id="1f6a3-313">An alternative to AD FS deployment if the goal is Office 365 SSO alone</span></span>
<span data-ttu-id="1f6a3-314">如果您的目標只是為了能夠登入 Office 365，還有另一個替代方式可以完全部署 AD FS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-314">There is another alternative to deploying AD FS altogether if your goal is only to enable sign-in for Office 365.</span></span> <span data-ttu-id="1f6a3-315">在此情況下，您可以只使用密碼同步處理內部部署來部署 DirSync，達到與最小部署複雜度的相同最終結果，因為這種方法不需要 AD FS 或 Azure。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-315">In that case, you can simply deploy DirSync with password sync on-premises and achieve the same end-result with minimal deployment complexity because this approach does not require AD FS or Azure.</span></span>

<span data-ttu-id="1f6a3-316">下表比較部署和不部署 AD FS 時的登入程序的運作方式。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-316">The following table compares how the sign-in processes work with and without deploying AD FS.</span></span>

| <span data-ttu-id="1f6a3-317">使用 AD FS 和 DirSync 的 Office 365 單一登入</span><span class="sxs-lookup"><span data-stu-id="1f6a3-317">Office 365 single sign-on using AD FS and DirSync</span></span> | <span data-ttu-id="1f6a3-318">使用 DirSync + Password Sync 的 Office 365 相同登入</span><span class="sxs-lookup"><span data-stu-id="1f6a3-318">Office 365 same sign-on using DirSync + Password Sync</span></span> |
| --- | --- |
| <span data-ttu-id="1f6a3-319">1.使用者登入公司網路，向 Windows Server Active Directory 進行驗證。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-319">1. The user logs on to a corporate network, and is authenticated to Windows Server Active Directory.</span></span> |<span data-ttu-id="1f6a3-320">1.使用者登入公司網路，向 Windows Server Active Directory 進行驗證。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-320">1. The user logs on to a corporate network, and is authenticated to Windows Server Active Directory.</span></span> |
| <span data-ttu-id="1f6a3-321">2.使用者嘗試存取 Office 365 (I am @contoso.com)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-321">2. The user tries to access Office 365 (I am @contoso.com).</span></span> |<span data-ttu-id="1f6a3-322">2.使用者嘗試存取 Office 365 (I am @contoso.com)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-322">2. The user tries to access Office 365 (I am @contoso.com).</span></span> |
| <span data-ttu-id="1f6a3-323">3.Office 365 將使用者重新導向至 Azure AD。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-323">3. Office 365 redirects the user to Azure AD.</span></span> |<span data-ttu-id="1f6a3-324">3.Office 365 將使用者重新導向至 Azure AD。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-324">3. Office 365 redirects the user to Azure AD.</span></span> |
| <span data-ttu-id="1f6a3-325">4.因為 Azure AD 無法驗證使用者及了解有 AD FS 內部部署信任，所以它會將使用者重新導向至 AD FS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-325">4. Since Azure AD can’t authenticate the user and understands there is a trust with AD FS on-premises, it redirects the user to AD FS.</span></span> |<span data-ttu-id="1f6a3-326">4.Azure AD 不能直接接受 Kerberos 票證，並且沒有信任關係存在，因此會要求使用者輸入認證。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-326">4. Azure AD can’t accept Kerberos tickets directly and no trust relationship exists so it requests that the user enter credentials.</span></span> |
| <span data-ttu-id="1f6a3-327">5.使用者傳送 Kerberos 票證至 AD FS STS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-327">5. The user sends a Kerberos ticket to the AD FS STS.</span></span> |<span data-ttu-id="1f6a3-328">5.使用者輸入相同的內部部署密碼，且 Azure AD 對於 DirSync 所同步的使用者名稱和密碼進行驗證。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-328">5. The user enters the same on-premises password, and Azure AD validates them against the user name and password that was synchronized by DirSync.</span></span> |
| <span data-ttu-id="1f6a3-329">6.AD FS 將 Kerberos 票證轉換為必要的權杖格式/宣告，並將使用者重新導向至 Azure AD。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-329">6. AD FS transforms the Kerberos ticket to the required token format/claims and redirects the user to Azure AD.</span></span> |<span data-ttu-id="1f6a3-330">6.Azure AD 將使用者重新導向至 Office 365。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-330">6. Azure AD redirects the user to Office 365.</span></span> |
| <span data-ttu-id="1f6a3-331">7.使用者向 Azure AD 驗證 (另一個轉換發生時)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-331">7. The user authenticates to Azure AD (another transformation occurs).</span></span> |<span data-ttu-id="1f6a3-332">7.使用者可以使用 Azure AD 權杖登入 Office 365 和 OWA。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-332">7. The user can sign in to Office 365 and OWA using the Azure AD token.</span></span> |
| <span data-ttu-id="1f6a3-333">8.Azure AD 將使用者重新導向至 Office 365。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-333">8. Azure AD redirects the user to Office 365.</span></span> | |
| <span data-ttu-id="1f6a3-334">9.使用者以無訊息模式登入 Office 365。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-334">9. The user is silently signed on to Office 365.</span></span> | |

<span data-ttu-id="1f6a3-335">在 Office 365 與 DirSync 與密碼同步案例中 (沒有 AD FS)，單一登入由「相同登入」取代，其中「相同」表示使用者必須重新輸入存取 Office 365 時相同的內部部署認證。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-335">In the Office 365 with DirSync with password sync scenario (no AD FS), single sign-on is replaced by “same sign-on” where “same” simply means that users must re-enter their same on-premises credentials when accessing Office 365.</span></span> <span data-ttu-id="1f6a3-336">請注意，使用者的瀏覽器可記住這項資料，有助於減少後續提示。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-336">Note that this data can be remembered by the user’s browser to help reduce subsequent prompts.</span></span>

### <a name="additional-food-for-thought"></a><span data-ttu-id="1f6a3-337">其他考量</span><span class="sxs-lookup"><span data-stu-id="1f6a3-337">Additional food for thought</span></span>
* <span data-ttu-id="1f6a3-338">如果您在 Azure 虛擬機器上部署 AD FS Proxy，需要連接 AD FS 伺服器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-338">If you deploy an AD FS proxy on an Azure virtual machine, connectivity to the AD FS servers is needed.</span></span> <span data-ttu-id="1f6a3-339">如果是內部部署，建議您利用虛擬網路提供的站對站 VPN 連接，讓 Web 應用程式 Proxy 節點與其 AD FS 伺服器通訊。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-339">If they are on-premises, it is recommended that you leverage the site-to-site VPN connectivity provided by the virtual network to allow the Web Application Proxy nodes to communicate with their AD FS servers.</span></span>
* <span data-ttu-id="1f6a3-340">如果您在 Azure 虛擬機器上部署 AD FS 伺服器，則需要 Windows Server Active Directory 網域控制站的連接、屬性存放區和組態資料庫，且可能也需要 ExpressRoute 或 Azure 虛擬網路與內部部署網路之間的站對站 VPN 連接。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-340">If you deploy an AD FS server on an Azure virtual machine, connectivity to Windows Server Active Directory domain controllers, Attribute Stores, and Configuration databases is necessary and may also require an ExpressRoute or a site-to-site VPN connection between the Azure virtual network and the on-premises network.</span></span>
* <span data-ttu-id="1f6a3-341">費用會套用至來自 Azure 虛擬機器的所有流量 (輸出流量)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-341">Charges are applied to all traffic from Azure virtual machines (egress traffic).</span></span> <span data-ttu-id="1f6a3-342">如果成本是驅動因素，建議在 Azure 上部署 Web 應用程式 Proxy 節點，將 AD FS 伺服器保留在內部部署。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-342">If cost is the driving factor, it is advisable to deploy the Web Application Proxy nodes on Azure, leaving the AD FS servers on-premises.</span></span> <span data-ttu-id="1f6a3-343">如果 AD FS 伺服器也部署在 Azure 虛擬機器上，則會產生驗證內部部署使用者的額外成本。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-343">If the AD FS servers are deployed on Azure virtual machines as well, additional costs will be incurred to authenticate on-premises users.</span></span> <span data-ttu-id="1f6a3-344">輸出流量會產生成本，無論是周遊 ExpressRoute 或 VPN 站對站連接。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-344">Egress traffic incurs a cost regardless of whether or not it is traversing the ExpressRoute or the VPN site-to-site connection.</span></span>
* <span data-ttu-id="1f6a3-345">如果您決定使用 Azure 的原生伺服器負載平衡功能以取得 AD FS 伺服器的高可用性，請注意負載平衡會提供探查，用來判斷雲端服務中的虛擬機器的健康狀態。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-345">If you decide to use Azure’s native server load balancing capabilities for high availability of AD FS servers, note that load balancing provides probes that are used to determine the health of the virtual machines within the cloud service.</span></span> <span data-ttu-id="1f6a3-346">如果是 Azure 虛擬機器 (相對於 Web 或背景工作角色)，因為回應預設探查的代理程式不存在於 Azure 虛擬機器上，所以必須使用自訂探查。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-346">In the case of Azure virtual machines (as opposed to web or worker roles), a custom probe must be used since the agent that responds to the default probes is not present on Azure virtual machines.</span></span> <span data-ttu-id="1f6a3-347">為了簡單起見，您可以使用自訂 TCP 探查，這只需要成功建立 TCP 連接 (TCP SYN 分割傳送及回應 TCP SYN ACK 分割)，以判斷虛擬機器健康狀態。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-347">For simplicity, you might use a custom TCP probe — this requires only that a TCP connection (a TCP SYN segment sent and responded to with a TCP SYN ACK segment) be successfully established to determine virtual machine health.</span></span> <span data-ttu-id="1f6a3-348">您可以設定自訂探查以使用任何 TCP 連接埠 (您的虛擬機器會主動接聽)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-348">You can configure the custom probe to use any TCP port to which your virtual machines are actively listening.</span></span>

> [!NOTE]
> <span data-ttu-id="1f6a3-349">需要直接在網際網路公開同一組連接埠 (例如連接埠 80 和 443) 的機器不能共用相同的雲端服務。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-349">Machines that need to expose the same set of ports directly to the Internet (such as port 80 and 443) cannot share the same cloud service.</span></span> <span data-ttu-id="1f6a3-350">因此，建議您為 Windows Server AD FS 伺服器建立專用的雲端服務，以避免應用程式和 Windows Server AD FS 間可能的連接埠需求重疊。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-350">It is, therefore, recommended that you create a dedicated cloud service for your Windows Server AD FS servers in order to avoid potential overlaps between port requirements for an application and Windows Server AD FS.</span></span>
> 
> 

## <a name="deployment-scenarios"></a><span data-ttu-id="1f6a3-351">部署案例</span><span class="sxs-lookup"><span data-stu-id="1f6a3-351">Deployment scenarios</span></span>
<span data-ttu-id="1f6a3-352">下列各節概述常見部署案例，以強調必須列入考量的重要考量事項。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-352">The following section outlines commonplace deployment scenarios to draw attention to important considerations that must be taken into account.</span></span> <span data-ttu-id="1f6a3-353">每個案例有關於決策和考量因素之更多詳細資料的連結。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-353">Each scenario has links to more details about the decisions and factors to consider.</span></span>

1. [<span data-ttu-id="1f6a3-354">AD DS︰部署 AD DS 感知應用程式，不需要公司網路連接</span><span class="sxs-lookup"><span data-stu-id="1f6a3-354">AD DS: Deploy an AD DS-aware application with no requirement for corporate network connectivity</span></span>](#BKMK_CloudOnly)
   
    <span data-ttu-id="1f6a3-355">例如，網際網路對應 SharePoint 服務會部署在 Azure 虛擬機器上。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-355">For example, an Internet-facing SharePoint service is deployed on an Azure virtual machine.</span></span> <span data-ttu-id="1f6a3-356">應用程式與公司網路資源沒有任何相依性。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-356">The application has no dependencies on corporate-network resources.</span></span> <span data-ttu-id="1f6a3-357">應用程式確實需要 Windows Server AD DS，但是不需要公司 Windows Server AD DS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-357">The application does require Windows Server AD DS but does NOT require the corporate Windows Server AD DS.</span></span>
2. [<span data-ttu-id="1f6a3-358">AD FS：將宣告感知內部部署前端應用程式擴充到網際網路</span><span class="sxs-lookup"><span data-stu-id="1f6a3-358">AD FS: Extend a claims-aware on-premises front-end application to the Internet</span></span>](#BKMK_CloudOnlyFed)
   
    <span data-ttu-id="1f6a3-359">例如，已在內部部署成功部署而且由公司使用者使用的宣告感知應用程式必須可從網際網路存取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-359">For example, a claims-aware application that has been successfully deployed on-premises and used by corporate users needs to become accessible from the Internet.</span></span> <span data-ttu-id="1f6a3-360">應用程式必須能夠由使用自己公司身分識別的商務夥伴和現有公司使用者直接透過網際網路存取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-360">The application needs to be accessed directly over the Internet both by business partners using their own corporate identities and by existing corporate users.</span></span>
3. [<span data-ttu-id="1f6a3-361">AD DS：部署 Windows Server AD DS 感知應用程式，它需要連接公司網路</span><span class="sxs-lookup"><span data-stu-id="1f6a3-361">AD DS: Deploy a Windows Server AD DS-aware application that requires connectivity to the corporate network</span></span>](#BKMK_HybridExt)
   
    <span data-ttu-id="1f6a3-362">例如，支援 Windows 整合式驗證並使用 Windows Server AD DS 做為組態和使用者設定檔資料儲存機制的 LDAP 感知應用程式，會部署在 Azure 虛擬機器上。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-362">For example, an LDAP-aware application that supports Windows-integrated authentication and uses Windows Server AD DS as a repository for configuration and user-profile data is deployed on an Azure virtual machine.</span></span> <span data-ttu-id="1f6a3-363">應用程式最好能夠運用現有的公司 Windows Server AD DS，並提供單一登入。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-363">It is desirable for the application to leverage the existing corporate Windows Server AD DS and provide single sign-on.</span></span> <span data-ttu-id="1f6a3-364">應用程式不是宣告感知。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-364">The application is not claims-aware.</span></span>

### <span data-ttu-id="1f6a3-365"><a name="BKMK_CloudOnly"></a>1.AD DS︰部署 AD DS 感知應用程式，不需要公司網路連接</span><span class="sxs-lookup"><span data-stu-id="1f6a3-365"><a name="BKMK_CloudOnly"></a>1. AD DS: Deploy an AD DS-aware application with no requirement for corporate network connectivity</span></span>
<span data-ttu-id="1f6a3-366">![僅限雲端的 AD DS 部署](media/active-directory-deploying-ws-ad-guidelines/ADDS_cloud.png)
**圖 1**</span><span class="sxs-lookup"><span data-stu-id="1f6a3-366">![Cloud-only AD DS deployment](media/active-directory-deploying-ws-ad-guidelines/ADDS_cloud.png)
**Figure 1**</span></span>

#### <a name="description"></a><span data-ttu-id="1f6a3-367">說明</span><span class="sxs-lookup"><span data-stu-id="1f6a3-367">Description</span></span>
<span data-ttu-id="1f6a3-368">SharePoint 是部署在 Azure 虛擬機器上，且應用程式與公司網路資源沒有任何相依性。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-368">SharePoint is deployed on an Azure virtual machine and the application has no dependencies on corporate-network resources.</span></span> <span data-ttu-id="1f6a3-369">應用程式確實需要 Windows Server AD DS，但是「不」  需要公司 Windows Server AD DS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-369">The application does require Windows Server AD DS but does *not* require the corporate Windows Server AD DS.</span></span> <span data-ttu-id="1f6a3-370">不需要 Kerberos 或同盟信任，因為使用者可透過應用程式自行佈建至 Windows Server AD DS 網域，該網域也裝載於 Azure 虛擬機器上的雲端。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-370">No Kerberos or federated trusts are required because users are self-provisioned through the application into the Windows Server AD DS domain that is also hosted in the cloud on Azure virtual machines.</span></span>

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a><span data-ttu-id="1f6a3-371">案例考量以及如何在案例中套用技術領域</span><span class="sxs-lookup"><span data-stu-id="1f6a3-371">Scenario considerations and how technology areas apply to the scenario</span></span>
* <span data-ttu-id="1f6a3-372">[網路拓撲](#BKMK_NetworkTopology)︰建立 Azure 虛擬網路，而不需要跨單位連線 (也稱為站對站連接)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-372">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network without cross-premises connectivity (also known as site-to-site connectivity).</span></span>
* <span data-ttu-id="1f6a3-373">[DC 部署組態](#BKMK_DeploymentConfig)︰將新的網域控制站部署到新的單一網域 Windows Server Active Directory 樹系。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-373">[DC deployment configuration](#BKMK_DeploymentConfig): Deploy a new domain controller into a new, single-domain, Windows Server Active Directory forest.</span></span> <span data-ttu-id="1f6a3-374">這應該與 Windows DNS 伺服器一起部署。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-374">This should be deployed along with the Windows DNS server.</span></span>
* <span data-ttu-id="1f6a3-375">[Windows Server Active Directory 網站拓撲](#BKMK_ADSiteTopology)︰使用預設的 Windows Server Active Directory 網站 (所有電腦的名稱會是 Default-First-Site-Name)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-375">[Windows Server Active Directory site topology](#BKMK_ADSiteTopology): Use the default Windows Server Active Directory site (all computers will be in Default-First-Site-Name).</span></span>
* <span data-ttu-id="1f6a3-376">[IP 位址和 DNS](#BKMK_IPAddressDNS)：</span><span class="sxs-lookup"><span data-stu-id="1f6a3-376">[IP addressing and DNS](#BKMK_IPAddressDNS):</span></span>
  
  * <span data-ttu-id="1f6a3-377">針對 DC 使用 Set-AzureStaticVNetIP Azure PowerShell Cmdlet 設定靜態 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-377">Set a static IP address for the DC by using the Set-AzureStaticVNetIP Azure PowerShell cmdlet.</span></span>
  * <span data-ttu-id="1f6a3-378">在 Azure 的網域控制站上安裝和設定 Windows Server DNS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-378">Install and configure Windows Server DNS on the domain controller(s) on Azure.</span></span>
  * <span data-ttu-id="1f6a3-379">使用裝載 DC 和 DNS 伺服器角色的 VM 的名稱和 IP 位址，設定虛擬網路屬性。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-379">Configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles.</span></span>
* <span data-ttu-id="1f6a3-380">[通用類別目錄](#BKMK_GC)︰樹系中的第一個 DC 必須是通用類別目錄伺服器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-380">[Global Catalog](#BKMK_GC): The first DC in the forest must be a global catalog server.</span></span> <span data-ttu-id="1f6a3-381">額外的 DC 也應該設定為 GC，因為在單一網域樹系中，通用類別目錄不需要從 DC 進行任何其他工作。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-381">Additional DCs should also be configured as GCs because in a single domain forest, the global catalog does not require any additional work from the DC.</span></span>
* <span data-ttu-id="1f6a3-382">[Windows Server AD DS 資料庫和 SYSVOL 的位置](#BKMK_PlaceDB)︰將資料磁碟新增至 DC 做為 Azure VM 執行，以便儲存 Windows Server Active Directory 資料庫、記錄和 SYSVOL。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-382">[Placement of the Windows Server AD DS database and SYSVOL](#BKMK_PlaceDB): Add a data disk to DCs running as Azure VMs in order to store the Windows Server Active Directory database, logs, and SYSVOL.</span></span>
* <span data-ttu-id="1f6a3-383">[備份和還原](#BKMK_BUR)︰決定您要儲存系統狀態備份的位置。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-383">[Backup and Restore](#BKMK_BUR): Determine where you want to store system state backups.</span></span> <span data-ttu-id="1f6a3-384">如有需要，將另一個資料磁碟加入至 DC VM 以儲存備份。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-384">If necessary, add another data disk to the DC VM to store backups.</span></span>

### <span data-ttu-id="1f6a3-385"><a name="BKMK_CloudOnlyFed"></a>2 AD FS：將宣告感知內部部署前端應用程式擴充到網際網路</span><span class="sxs-lookup"><span data-stu-id="1f6a3-385"><a name="BKMK_CloudOnlyFed"></a>2 AD FS: Extend a claims-aware on-premises front-end application to the Internet</span></span>
<span data-ttu-id="1f6a3-386">![具有跨單位連線的同盟](media/active-directory-deploying-ws-ad-guidelines/Federation_xprem.png)
**圖 2**</span><span class="sxs-lookup"><span data-stu-id="1f6a3-386">![Federation with cross-premises connectivity](media/active-directory-deploying-ws-ad-guidelines/Federation_xprem.png)
**Figure 2**</span></span>

#### <a name="description"></a><span data-ttu-id="1f6a3-387">說明</span><span class="sxs-lookup"><span data-stu-id="1f6a3-387">Description</span></span>
<span data-ttu-id="1f6a3-388">已在內部部署成功部署而且由公司使用者使用的宣告感知應用程式必須可直接從網際網路存取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-388">A claims-aware application that has been successfully deployed on-premises and used by corporate users needs to become accessible directly from the Internet.</span></span> <span data-ttu-id="1f6a3-389">應用程式做為 SQL Database (在其中儲存資料) 的 Web 前端。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-389">The application serves as a web frontend to a SQL database in which it stores data.</span></span> <span data-ttu-id="1f6a3-390">應用程式所使用的 SQL Server 也位於公司網路。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-390">The SQL servers used by the application are also located on the corporate network.</span></span> <span data-ttu-id="1f6a3-391">兩個 Windows Server AD FS STS 和負載平衡器已經部署於內部部署，以提供公司使用者的存取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-391">Two Windows Server AD FS STSs and a load-balancer have been deployed on-premises to provide access to the corporate users.</span></span> <span data-ttu-id="1f6a3-392">應用程式現在必須另外能夠由使用自己公司身分識別的商務夥伴和現有公司使用者直接透過網際網路存取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-392">The application now needs to be additionally accessed directly over the Internet both by business partners using their own corporate identities and by existing corporate users.</span></span>

<span data-ttu-id="1f6a3-393">為了簡化及符合這個新要求的部署和組態需求，它會決定將兩個額外的 Web 前端和兩部 Windows Server AD FS Proxy 伺服器安裝在 Azure 虛擬機器上。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-393">In an effort to simplify and meet the deployment and configuration needs of this new requirement, it is decided that two additional web frontends and two Windows Server AD FS proxy servers be installed on Azure virtual machines.</span></span> <span data-ttu-id="1f6a3-394">所有四個 VM 將會直接公開到網際網路，並提供與內部部署網路的連接，方法是使用 Azure 虛擬網路的站對站 VPN 功能。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-394">All four VMs will be exposed directly to the Internet and will be provided connectivity to the on-premises network using Azure Virtual Network’s site-to-site VPN capability.</span></span>

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a><span data-ttu-id="1f6a3-395">案例考量以及如何在案例中套用技術領域</span><span class="sxs-lookup"><span data-stu-id="1f6a3-395">Scenario considerations and how technology areas apply to the scenario</span></span>
* <span data-ttu-id="1f6a3-396">[網路拓撲](#BKMK_NetworkTopology)：建立 Azure 虛擬網路和[設定跨單位連線](../vpn-gateway/vpn-gateway-site-to-site-create.md)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-396">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network and [configure cross-premises connectivity](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="1f6a3-397">對於每一個 Windows Server AD FS 憑證，請確定在 Azure 上執行的 Windows Server AD FS 執行個體可以觸達憑證範本及產生的憑證中定義的 URL。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-397">For each of the Windows Server AD FS certificates, ensure that the URL defined within the certificate template and the resulting certificates can be reached by the Windows Server AD FS instances running on Azure.</span></span> <span data-ttu-id="1f6a3-398">這可能需要跨單位連線至您的 PKI 基礎結構的部分。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-398">This may require cross-premises connectivity to parts of your PKI infrastructure.</span></span> <span data-ttu-id="1f6a3-399">例如，如果 CRL 的端點是以 LDAP 為基礎且僅於內部部署裝載，則需要跨單位連線。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-399">For example if the CRL's endpoint is LDAP-based and hosted exclusively on-premises, then cross-premises connectivity will be required.</span></span> <span data-ttu-id="1f6a3-400">如果不想要這樣，可能必須使用 CA 發行的憑證，其 CRL 可以透過網際網路存取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-400">If this is not desirable, it may be necessary to use certificates issued by a CA whose CRL is accessible over the Internet.</span></span>
  > 
  > 
* <span data-ttu-id="1f6a3-401">[雲端服務組態](#BKMK_CloudSvcConfig)︰請確定您有兩個雲端服務，以便提供兩個負載平衡虛擬 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-401">[Cloud services configuration](#BKMK_CloudSvcConfig): Ensure you have two cloud services in order provide two load-balanced virtual IP addresses.</span></span> <span data-ttu-id="1f6a3-402">第一個雲端服務的虛擬 IP 位址會導向至連接埠 80 和 443 上的兩個 Windows Server AD FS Proxy VM。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-402">The first cloud service’s virtual IP address will be directed to the two Windows Server AD FS proxy VMs on ports 80 and 443.</span></span> <span data-ttu-id="1f6a3-403">Windows Server AD FS Proxy VM 將會設定為指向內部部署負載平衡器的 IP 位址，它位於 Windows Server AD FS STS 前端。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-403">The Windows Server AD FS proxy VMs will be configured to point to the IP address of the on-premises load-balancer that fronts the Windows Server AD FS STSs.</span></span> <span data-ttu-id="1f6a3-404">第二個雲端服務的虛擬 IP 位址會再次導向至連接埠 80 和 443 上執行 Web 前端的兩個 VM。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-404">The second cloud service’s virtual IP address will be directed to the two VMs running the web frontend again on ports 80 and 443.</span></span> <span data-ttu-id="1f6a3-405">設定自訂探查以確保負載平衡器只會將流量導向正常運作的 Windows Server AD FS Proxy 和 Web 前端 VM。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-405">Configure a custom probe to ensure the load-balancer only directs traffic to functioning Windows Server AD FS proxy and web frontend VMs.</span></span>
* <span data-ttu-id="1f6a3-406">[同盟伺服器組態](#BKMK_FedSrvConfig)︰設定 Windows Server AD FS 做為同盟伺服器 (STS)，為雲端中建立的 Windows Server Active Directory 樹系產生安全性權杖。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-406">[Federation server configuration](#BKMK_FedSrvConfig): Configure Windows Server AD FS as a federation server (STS) to generate security tokens for the Windows Server Active Directory forest created in the cloud.</span></span> <span data-ttu-id="1f6a3-407">以您希望接受其身分識別的不同夥伴設定同盟宣告提供者信任關係，並使用您想要為其產生權杖的不同應用程式設定信賴憑證者信任關係。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-407">Set federation claims provider trust relationships with the different partners you wish to accept identities from, and configure relying party trust relationships with the different applications you want to generate tokens to.</span></span>
  
    <span data-ttu-id="1f6a3-408">在大部分情況下，Windows Server AD FS Proxy 伺服器會基於安全性理由而部署在網際網路對應的容量，其 Windows Server AD FS 同盟對應項目依然隔離為直接網際網路連接。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-408">In most scenarios, Windows Server AD FS proxy servers are deployed in an Internet-facing capacity for security purposes while their Windows Server AD FS federation counterparts remain isolated from direct Internet connectivity.</span></span> <span data-ttu-id="1f6a3-409">不論您的部署案例為何，必須使用虛擬 IP 位址設定您的雲端服務，提供公開 IP 位址和可以橫跨兩個 Windows Server AD FS STS 執行個體或 Proxy 執行個體進行負載平衡的連接埠。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-409">Regardless of your deployment scenario, you must configure your cloud service with a virtual IP address that will provide a publicly exposed IP address and port that is able to load-balance across either your two Windows Server AD FS STS instances or proxy instances.</span></span>
* <span data-ttu-id="1f6a3-410">[Windows Server AD FS 高可用性組態](#BKMK_ADFSHighAvail)︰建議您至少以兩部伺服器部署 Windows Server AD FS 伺服器陣列，以便容錯移轉和負載平衡。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-410">[Windows Server AD FS high availability configuration](#BKMK_ADFSHighAvail): It is advisable to deploy a Windows Server AD FS farm with at least two servers for failover and load balancing.</span></span> <span data-ttu-id="1f6a3-411">您可能想要考慮針對 Windows Server AD FS 組態資料使用 Windows 內部資料庫 (WID)，並且使用 Azure 的內部負載平衡功能，將連入要求分散到伺服器陣列中的伺服器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-411">You might want to consider using the Windows Internal Database (WID) for Windows Server AD FS configuration data, and use the internal load balancing capability of Azure to distribute incoming requests across the servers in the farm.</span></span>

<span data-ttu-id="1f6a3-412">如需詳細資訊，請參閱 [AD DS 部署指南](https://technet.microsoft.com/library/cc753963)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-412">For more information, see the [AD DS Deployment Guide](https://technet.microsoft.com/library/cc753963).</span></span>

### <span data-ttu-id="1f6a3-413"><a name="BKMK_HybridExt"></a>3.AD DS：部署 Windows Server AD DS 感知應用程式，它需要連接公司網路</span><span class="sxs-lookup"><span data-stu-id="1f6a3-413"><a name="BKMK_HybridExt"></a>3. AD DS: Deploy a Windows Server AD DS-aware application that requires connectivity to the corporate network</span></span>
<span data-ttu-id="1f6a3-414">![跨單位 AD DS 部署](media/active-directory-deploying-ws-ad-guidelines/ADDS_xprem.png)
**圖 3**</span><span class="sxs-lookup"><span data-stu-id="1f6a3-414">![Cross-premises AD DS deployment](media/active-directory-deploying-ws-ad-guidelines/ADDS_xprem.png)
**Figure 3**</span></span>

#### <a name="description"></a><span data-ttu-id="1f6a3-415">說明</span><span class="sxs-lookup"><span data-stu-id="1f6a3-415">Description</span></span>
<span data-ttu-id="1f6a3-416">LDAP 感知應用程式會部署在 Azure 虛擬機器上。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-416">An LDAP-aware application is deployed on an Azure virtual machine.</span></span> <span data-ttu-id="1f6a3-417">支援 Windows 整合式驗證並使用 Windows Server AD DS 做為組態和使用者設定檔資料的儲存機制。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-417">It supports Windows-integrated authentication and uses Windows Server AD DS as a repository for configuration and user profile data.</span></span> <span data-ttu-id="1f6a3-418">應用程式的目標是運用現有的公司 Windows Server AD DS，並提供單一登入。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-418">The goal is for the application to leverage the existing corporate Windows Server AD DS and provide single sign-on.</span></span> <span data-ttu-id="1f6a3-419">應用程式不是宣告感知。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-419">The application is not claims-aware.</span></span> <span data-ttu-id="1f6a3-420">使用者也必須直接從網際網路存取應用程式。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-420">Users also need to access the application directly from the Internet.</span></span> <span data-ttu-id="1f6a3-421">為了最佳化效能和成本，決定將屬於公司網域的兩個額外網域控制站隨著應用程式一起部署在 Azure 上。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-421">To optimize for performance and cost, it is decided that two additional domain controllers that are part of the corporate domain be deployed alongside the application on Azure.</span></span>

#### <a name="scenario-considerations-and-how-technology-areas-apply-to-the-scenario"></a><span data-ttu-id="1f6a3-422">案例考量以及如何在案例中套用技術領域</span><span class="sxs-lookup"><span data-stu-id="1f6a3-422">Scenario considerations and how technology areas apply to the scenario</span></span>
* <span data-ttu-id="1f6a3-423">[網路拓撲：](#BKMK_NetworkTopology)使用[跨單位連線](../vpn-gateway/vpn-gateway-site-to-site-create.md)建立 Azure 虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-423">[Network topology](#BKMK_NetworkTopology): Create an Azure virtual network with [cross-premises connectivity](../vpn-gateway/vpn-gateway-site-to-site-create.md).</span></span>
* <span data-ttu-id="1f6a3-424">[安裝方法](#BKMK_InstallMethod)︰從公司 Windows Server Active Directory 網域部署複本 DC。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-424">[Installation method](#BKMK_InstallMethod): Deploy replica DCs from the corporate Windows Server Active Directory domain.</span></span> <span data-ttu-id="1f6a3-425">對於複本 DC，您可以在 VM 上安裝 Windows Server AD DS，並選擇性地使用從媒體安裝 (IFM) 功能來減少在安裝期間複寫到新的 DC 所需的資料量。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-425">For a replica DC, you can install Windows Server AD DS on the VM, and optionally use the Install From Media (IFM) feature to reduce the amount of data that needs to be replicated to the new DC during installation.</span></span> <span data-ttu-id="1f6a3-426">如需教學課程，請參閱 [在 Azure 中安裝複本 Active Directory 網域控制站](active-directory-install-replica-active-directory-domain-controller.md)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-426">For a tutorial, see [Install a replica Active Directory domain controller on Azure](active-directory-install-replica-active-directory-domain-controller.md).</span></span> <span data-ttu-id="1f6a3-427">即使您使用 IFM，但是更有效率的方式可能是建置虛擬 DC 內部部署，並將整個虛擬硬碟 (VHD) 移至雲端，而不是在安裝期間複寫 Windows Server AD DS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-427">Even if you use IFM, it may be more efficient to build the virtual DC on-premises and move the entire Virtual Hard Disk (VHD) to the cloud instead of replicating Windows Server AD DS during installation.</span></span> <span data-ttu-id="1f6a3-428">基於安全考量，建議您在 VHD 複製到 Azure 之後，從內部部署網路刪除。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-428">For safety, it is recommended that you delete the VHD from the on-premises network once it has been copied to Azure.</span></span>
* <span data-ttu-id="1f6a3-429">[Windows Server Active Directory 網站拓撲](#BKMK_ADSiteTopology)：在 Active Directory 網站及服務中建立新的 Azure 網站。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-429">[Windows Server Active Directory site topology](#BKMK_ADSiteTopology): Create a new Azure site in Active Directory Sites and Services.</span></span> <span data-ttu-id="1f6a3-430">建立 Windows Server Active Directory 子網路物件來代表 Azure 虛擬網路，並且將子網路加入至網站。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-430">Create a Windows Server Active Directory subnet object to represent the Azure virtual network and add the subnet to the site.</span></span> <span data-ttu-id="1f6a3-431">建立新的網站連結，其中包含新的 Azure 網站和 Azure 虛擬網路 VPN 端點所在的網站，以便控制和最佳化 Windows Server Active Directory 與 Azure 之間的流量。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-431">Create a new site link that includes the new Azure site and the site in which the Azure virtual network VPN endpoint is located in order to control and optimize Windows Server Active Directory traffic to and from Azure.</span></span>
* <span data-ttu-id="1f6a3-432">[IP 位址和 DNS](#BKMK_IPAddressDNS)：</span><span class="sxs-lookup"><span data-stu-id="1f6a3-432">[IP addressing and DNS](#BKMK_IPAddressDNS):</span></span>
  
  * <span data-ttu-id="1f6a3-433">針對 DC 使用 Set-AzureStaticVNetIP Azure PowerShell Cmdlet 設定靜態 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-433">Set a static IP address for the DC by using the Set-AzureStaticVNetIP Azure PowerShell cmdlet.</span></span>
  * <span data-ttu-id="1f6a3-434">在 Azure 的網域控制站上安裝和設定 Windows Server DNS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-434">Install and configure Windows Server DNS on the domain controller(s) on Azure.</span></span>
  * <span data-ttu-id="1f6a3-435">使用裝載 DC 和 DNS 伺服器角色的 VM 的名稱和 IP 位址，設定虛擬網路屬性。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-435">Configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles.</span></span>
* <span data-ttu-id="1f6a3-436">[地理位置分散 DC](#BKMK_DistributedDCs)︰視需要設定其他虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-436">[Geo-distributed DCs](#BKMK_DistributedDCs): Configure additional virtual networks as needed.</span></span> <span data-ttu-id="1f6a3-437">如果您的 Active Directory 網站拓撲需要對應至不同 Azure 區域地理位置的 DC，則您會想要據以建立 Active Directory 網站。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-437">If your Active Directory site topology requires DCs in geographies that correspond to different Azure regions, than you want to create Active Directory sites accordingly.</span></span>
* <span data-ttu-id="1f6a3-438">[唯讀 DC](#BKMK_RODC)：根據於您對於 DC 執行寫入作業的需求，以及網站中應用程式和服務與 RODC 的相容性，您可能會希望在 Azure 網站中部署 RODC。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-438">[Read-only DCs](#BKMK_RODC): You might deploy an RODC in the Azure site, depending on your requirements for performing write operations against the DC and the compatibility of applications and services in the site with RODCs.</span></span> <span data-ttu-id="1f6a3-439">如需應用程式相容性的詳細資訊，請參閱 [唯讀網域控制站應用程式相容性指南](https://technet.microsoft.com/library/cc755190)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-439">For more information about application compatibility, see the [Read-Only domain controllers application compatibility guide](https://technet.microsoft.com/library/cc755190).</span></span>
* <span data-ttu-id="1f6a3-440">[通用類別目錄](#BKMK_GC)︰需要 GC 以處理多網域樹系中的登入要求。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-440">[Global Catalog](#BKMK_GC): GCs are needed to service logon requests in multidomain forests.</span></span> <span data-ttu-id="1f6a3-441">如果您未在 Azure 網站上部署 GC，就會發生輸出流量成本，因為驗證要求會造成查詢其他網站的 GC。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-441">If you do not deploy a GC in the Azure site, you will incur egress traffic costs as authentication requests cause queries GCs in other sites.</span></span> <span data-ttu-id="1f6a3-442">若要將該流量降到最低，您可以針對 Active Directory 網站及服務中的 Azure 網站啟用萬用群組成員資格快取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-442">To minimize that traffic, you can enable universal group membership caching for the Azure site in Active Directory Sites and Services.</span></span>
  
    <span data-ttu-id="1f6a3-443">如果您部署 GC，設定網站連結和網站連結成本，讓 Azure 網站中的 GC 不會成為其他 GC (需要複寫相同的部分網域分割區) 慣用的來源 DC。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-443">If you deploy a GC, configure site links and site links costs so that the GC in the Azure site is not preferred as a source DC by other GCs that need to replicate the same partial domain partitions.</span></span>
* <span data-ttu-id="1f6a3-444">[Windows Server AD DS 資料庫和 SYSVOL 的位置](#BKMK_PlaceDB)︰將資料磁碟新增至 DC 以在 Azure VM 上執行，以便儲存 Windows Server Active Directory 資料庫、記錄和 SYSVOL。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-444">[Placement of the Windows Server AD DS database and SYSVOL](#BKMK_PlaceDB): Add a data disk to DCs running on Azure VMs in order to store the Windows Server Active Directory database, logs, and SYSVOL.</span></span>
* <span data-ttu-id="1f6a3-445">[備份和還原](#BKMK_BUR)︰決定您要儲存系統狀態備份的位置。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-445">[Backup and Restore](#BKMK_BUR): Determine where you want to store system state backups.</span></span> <span data-ttu-id="1f6a3-446">如有需要，將另一個資料磁碟加入至 DC VM 以儲存備份。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-446">If necessary, add another data disk to the DC VM to store backups.</span></span>

## <a name="deployment-decisions-and-factors"></a><span data-ttu-id="1f6a3-447">部署決策和因素</span><span class="sxs-lookup"><span data-stu-id="1f6a3-447">Deployment decisions and factors</span></span>
<span data-ttu-id="1f6a3-448">這個資料表摘要說明上述案例中受到影響的 Windows Server Active Directory 技術領域和要考量的對應決策，在其下有詳細資料的連結。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-448">This table summarizes the Windows Server Active Directory technology areas that are impacted in the preceding scenarios and the corresponding decisions to consider, with links to more detail below.</span></span> <span data-ttu-id="1f6a3-449">某些技術領域可能不適用於所有部署案例，某些技術領域對於部署案例比起其他技術領域可能更為重要。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-449">Some technology areas might not be applicable to every deployment scenario, and some technology areas might be more critical to a deployment scenario than other technology areas.</span></span>

<span data-ttu-id="1f6a3-450">例如，如果您在虛擬網路上部署複本 DC，而且樹系只有單一網域，則選擇部署通用類別目錄伺服器在此情況下對於部署案例並不重要，因為它不會建立任何額外的複寫需求。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-450">For example, if you deploy a replica DC on a virtual network and your forest has only a single domain, then choosing to deploy a global catalog server in that case will not be critical to the deployment scenario because it will not create any additional replication requirements.</span></span> <span data-ttu-id="1f6a3-451">相反地，如果樹系有幾個網域，則決定在虛擬網路上部署通用類別目錄可能會影響可用的頻寬、效能、驗證、目錄查閱等等。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-451">On the other hand, if the forest has several domains, then the decision to deploy a global catalog on a virtual network could affect available bandwidth, performance, authentication, directory lookups, and so on.</span></span>

| <span data-ttu-id="1f6a3-452">Windows Server Active Directory 技術領域</span><span class="sxs-lookup"><span data-stu-id="1f6a3-452">Windows Server Active Directory technology area</span></span> | <span data-ttu-id="1f6a3-453">決策</span><span class="sxs-lookup"><span data-stu-id="1f6a3-453">Decisions</span></span> | <span data-ttu-id="1f6a3-454">因素</span><span class="sxs-lookup"><span data-stu-id="1f6a3-454">Factors</span></span> |
| --- | --- | --- |
| [<span data-ttu-id="1f6a3-455">網路拓撲</span><span class="sxs-lookup"><span data-stu-id="1f6a3-455">Network topology</span></span>](#BKMK_NetworkTopology) |<span data-ttu-id="1f6a3-456">建立虛擬網路？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-456">Do you create a virtual network?</span></span> |<li><span data-ttu-id="1f6a3-457">存取公司資源的需求</span><span class="sxs-lookup"><span data-stu-id="1f6a3-457">Requirements to access Corp resources</span></span></li> <li><span data-ttu-id="1f6a3-458">驗證</span><span class="sxs-lookup"><span data-stu-id="1f6a3-458">Authentication</span></span></li> <li><span data-ttu-id="1f6a3-459">帳戶管理</span><span class="sxs-lookup"><span data-stu-id="1f6a3-459">Account management</span></span></li> |
| [<span data-ttu-id="1f6a3-460">DC 部署組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-460">DC deployment configuration</span></span>](#BKMK_DeploymentConfig) |<li><span data-ttu-id="1f6a3-461">在沒有任何信任的情況下部署個別樹系？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-461">Deploy a separate forest without any trusts?</span></span></li> <li><span data-ttu-id="1f6a3-462">部署具有同盟的新樹系？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-462">Deploy a new forest with federation?</span></span></li> <li><span data-ttu-id="1f6a3-463">部署具有 Windows Server Active Directory 樹系信任或 Kerberos 的新樹系？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-463">Deploy a new forest with Windows Server Active Directory forest trust or Kerberos?</span></span></li> <li><span data-ttu-id="1f6a3-464">藉由部署複本 DC 擴充公司樹系？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-464">Extend Corp forest by deploying a replica DC?</span></span></li> <li><span data-ttu-id="1f6a3-465">藉由部署新的子網域或網域樹系擴充公司樹系？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-465">Extend Corp forest by deploying a new child domain or domain tree?</span></span></li> |<li><span data-ttu-id="1f6a3-466">安全性</span><span class="sxs-lookup"><span data-stu-id="1f6a3-466">Security</span></span></li> <li><span data-ttu-id="1f6a3-467">法規遵循</span><span class="sxs-lookup"><span data-stu-id="1f6a3-467">Compliance</span></span></li> <li><span data-ttu-id="1f6a3-468">成本</span><span class="sxs-lookup"><span data-stu-id="1f6a3-468">Cost</span></span></li> <li><span data-ttu-id="1f6a3-469">恢復功能和容錯</span><span class="sxs-lookup"><span data-stu-id="1f6a3-469">Resiliency and fault-tolerance</span></span></li> <li><span data-ttu-id="1f6a3-470">應用程式相容性</span><span class="sxs-lookup"><span data-stu-id="1f6a3-470">Application compatibility</span></span></li> |
| [<span data-ttu-id="1f6a3-471">Windows Server Active Directory 網站拓撲</span><span class="sxs-lookup"><span data-stu-id="1f6a3-471">Windows Server Active Directory site topology</span></span>](#BKMK_ADSiteTopology) |<span data-ttu-id="1f6a3-472">您如何使用 Azure 虛擬網路設定子網路、網站和網站連結，以最佳化流量並且讓成本降至最低？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-472">How do you configure subnets, sites, and site links with Azure Virtual Network to optimize traffic and minimize cost?</span></span> |<li><span data-ttu-id="1f6a3-473">子網路和站台定義</span><span class="sxs-lookup"><span data-stu-id="1f6a3-473">Subnet and site definitions</span></span></li> <li><span data-ttu-id="1f6a3-474">站台連結屬性和變更通知</span><span class="sxs-lookup"><span data-stu-id="1f6a3-474">Site link properties and change notification</span></span></li> <li><span data-ttu-id="1f6a3-475">複寫壓縮</span><span class="sxs-lookup"><span data-stu-id="1f6a3-475">Replication compression</span></span></li> |
| [<span data-ttu-id="1f6a3-476">IP 位址和 DNS</span><span class="sxs-lookup"><span data-stu-id="1f6a3-476">IP addressing and DNS</span></span>](#BKMK_IPAddressDNS) |<span data-ttu-id="1f6a3-477">如何設定 IP 位址和名稱解析？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-477">How to configure IP addresses and name resolution?</span></span> |<li><span data-ttu-id="1f6a3-478">使用 Set-AzureStaticVNetIP Cmdlet 以指派靜態 IP 位址</span><span class="sxs-lookup"><span data-stu-id="1f6a3-478">Use the Use the Set-AzureStaticVNetIP cmdlet to assign a static IP address</span></span></li> <li><span data-ttu-id="1f6a3-479">使用裝載 DC 和 DNS 伺服器角色的 VM 的名稱和 IP 位址，安裝 Windows Server DNS 伺服器和設定虛擬網路屬性。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-479">Install Windows Server DNS server and configure the virtual network properties with the name and IP address of the VM that hosts the DC and DNS server roles</span></span></li> |
| [<span data-ttu-id="1f6a3-480">地理位置分散 DC</span><span class="sxs-lookup"><span data-stu-id="1f6a3-480">Geo-distributed DCs</span></span>](#BKMK_DistributedDCs) |<span data-ttu-id="1f6a3-481">如何複寫到個別虛擬網路上的 DC？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-481">How to replicate to DCs on separate virtual networks?</span></span> |<span data-ttu-id="1f6a3-482">如果您的 Active Directory 網站拓撲需要對應至不同 Azure 區域的地理位置的 DC，則您會想要據以建立 Active Directory 網站。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-482">If your Active Directory site topology requires DCs in geographies that corresponds to different Azure regions, than you want to create Active Directory sites accordingly.</span></span> <span data-ttu-id="1f6a3-483">[將虛擬網路設定為虛擬網路連接](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md) 以在個別虛擬網路上的網域控制站之間複寫。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-483">[Configure virtual network to virtual network Connectivity](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md) to replicate between domain controllers on separate virtual networks.</span></span> |
| [<span data-ttu-id="1f6a3-484">唯讀 DC</span><span class="sxs-lookup"><span data-stu-id="1f6a3-484">Read-only DCs</span></span>](#BKMK_RODC) |<span data-ttu-id="1f6a3-485">使用唯讀或可寫入 DC？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-485">Use read-only or writeable DCs?</span></span> |<li><span data-ttu-id="1f6a3-486">篩選 HBI/PII 屬性</span><span class="sxs-lookup"><span data-stu-id="1f6a3-486">Filter HBI/PII attributes</span></span></li> <li><span data-ttu-id="1f6a3-487">篩選祕密</span><span class="sxs-lookup"><span data-stu-id="1f6a3-487">Filter secrets</span></span></li> <li><span data-ttu-id="1f6a3-488">限制輸出流量</span><span class="sxs-lookup"><span data-stu-id="1f6a3-488">Limit outbound traffic</span></span></li> |
| [<span data-ttu-id="1f6a3-489">通用類別目錄</span><span class="sxs-lookup"><span data-stu-id="1f6a3-489">Global catalog</span></span>](#BKMK_GC) |<span data-ttu-id="1f6a3-490">安裝通用類別目錄？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-490">Install global catalog?</span></span> |<li><span data-ttu-id="1f6a3-491">對於單一網域樹系，讓所有 DC 都是 GC</span><span class="sxs-lookup"><span data-stu-id="1f6a3-491">For single-domain forest, make all DCs GCs</span></span></li> <li><span data-ttu-id="1f6a3-492">對於多網域樹系，需要 GC 以進行驗證</span><span class="sxs-lookup"><span data-stu-id="1f6a3-492">For multidomain forest, GCs are required for authentication</span></span></li> |
| [<span data-ttu-id="1f6a3-493">安裝方法</span><span class="sxs-lookup"><span data-stu-id="1f6a3-493">Installation method</span></span>](#BKMK_InstallMethod) |<span data-ttu-id="1f6a3-494">如何在 Azure 上安裝 DC？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-494">How to install DC in Azure?</span></span> |<span data-ttu-id="1f6a3-495">下列任一方法︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-495">Either:</span></span> <li><span data-ttu-id="1f6a3-496">使用 Windows PowerShell 或 Dcpromo 安裝 AD DS</span><span class="sxs-lookup"><span data-stu-id="1f6a3-496">Install AD DS using Windows PowerShell or Dcpromo</span></span></li> <li><span data-ttu-id="1f6a3-497">移動內部部署虛擬 DC 的 VHD</span><span class="sxs-lookup"><span data-stu-id="1f6a3-497">Move VHD of an on-premises virtual DC</span></span></li> |
| [<span data-ttu-id="1f6a3-498">Windows Server AD DS 資料庫和 SYSVOL 的位置</span><span class="sxs-lookup"><span data-stu-id="1f6a3-498">Placement of the Windows Server AD DS database and SYSVOL</span></span>](#BKMK_PlaceDB) |<span data-ttu-id="1f6a3-499">Windows Server AD DS 資料庫、記錄和 SYSVOL 的儲存位置？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-499">Where to store Windows Server AD DS database, logs, and SYSVOL?</span></span> |<span data-ttu-id="1f6a3-500">變更 Dcpromo.exe 預設值。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-500">Change Dcpromo.exe default values.</span></span> <span data-ttu-id="1f6a3-501">這些重要的 Active Directory 檔案「必須」  放在 Azure 資料磁碟，而不是實作寫入快取的作業系統磁碟。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-501">These critical Active Directory files *must* be placed on Azure Data Disks instead of Operating System disks that implement write caching.</span></span> |
| [<span data-ttu-id="1f6a3-502">備份與還原</span><span class="sxs-lookup"><span data-stu-id="1f6a3-502">Backup and Restore</span></span>](#BKMK_BUR) |<span data-ttu-id="1f6a3-503">如何保護及復原資料？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-503">How to safeguard and recover data?</span></span> |<span data-ttu-id="1f6a3-504">建立系統狀態備份</span><span class="sxs-lookup"><span data-stu-id="1f6a3-504">Create system state backups</span></span> |
| [<span data-ttu-id="1f6a3-505">同盟伺服器組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-505">Federation server configuration</span></span>](#BKMK_FedSrvConfig) |<li><span data-ttu-id="1f6a3-506">在雲端中部署具有同盟的新樹系？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-506">Deploy a new forest with federation in the cloud?</span></span></li> <li><span data-ttu-id="1f6a3-507">部署 AD FS 內部部署並且在雲端中公開 Proxy？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-507">Deploy AD FS on-premises and expose a proxy in the cloud?</span></span></li> |<li><span data-ttu-id="1f6a3-508">安全性</span><span class="sxs-lookup"><span data-stu-id="1f6a3-508">Security</span></span></li> <li><span data-ttu-id="1f6a3-509">法規遵循</span><span class="sxs-lookup"><span data-stu-id="1f6a3-509">Compliance</span></span></li> <li><span data-ttu-id="1f6a3-510">成本</span><span class="sxs-lookup"><span data-stu-id="1f6a3-510">Cost</span></span></li> <li><span data-ttu-id="1f6a3-511">商務夥伴的應用程式存取</span><span class="sxs-lookup"><span data-stu-id="1f6a3-511">Access to applications by business partners</span></span></li> |
| [<span data-ttu-id="1f6a3-512">雲端服務組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-512">Cloud services configuration</span></span>](#BKMK_CloudSvcConfig) |<span data-ttu-id="1f6a3-513">雲端服務會在您第一次建立虛擬機器時以隱含方式部署。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-513">A cloud service is implicitly deployed the first time you create a virtual machine.</span></span> <span data-ttu-id="1f6a3-514">您是否需要部署額外的雲端服務？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-514">Do you need to deploy additional cloud services?</span></span> |<li><span data-ttu-id="1f6a3-515">VM 是否需要直接公開至網際網路？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-515">Does a VM or VMs require direct exposure to the Internet?</span></span></li> <li> <span data-ttu-id="1f6a3-516">服務是否需要負載平衡？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-516">Does the service require load-balancing?</span></span></li> |
| [<span data-ttu-id="1f6a3-517">公用和私人 IP 位址 (動態 IP 與虛擬 IP) 的同盟伺服器需求</span><span class="sxs-lookup"><span data-stu-id="1f6a3-517">Federation server requirements for public and private IP addressing (dynamic IP vs. virtual IP)</span></span>](#BKMK_FedReqVIPDIP) |<li><span data-ttu-id="1f6a3-518">Windows Server AD FS 執行個體是否需要直接從網際網路觸達？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-518">Does the Windows Server AD FS instance need to be reached directly from the Internet?</span></span></li> <li><span data-ttu-id="1f6a3-519">在雲端中部署的應用程式是否需要它自己的網際網路對應 IP 位址和連接埠？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-519">Does the application being deployed in the cloud require its own Internet-facing IP address and port?</span></span></li> |<span data-ttu-id="1f6a3-520">針對您的部署所需的每個虛擬 IP 位址建立一個雲端服務</span><span class="sxs-lookup"><span data-stu-id="1f6a3-520">Create one cloud-service for each virtual IP address that is required by your deployment</span></span> |
| [<span data-ttu-id="1f6a3-521">Windows Server AD FS 高可用性組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-521">Windows Server AD FS high availability configuration</span></span>](#BKMK_ADFSHighAvail) |<li><span data-ttu-id="1f6a3-522">在我的 Windows Server AD FS 伺服器陣列中有多少節點？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-522">How many nodes in my Windows Server AD FS server farm?</span></span></li> <li><span data-ttu-id="1f6a3-523">在我的 Windows Server AD FS Proxy 伺服器陣列中要部署多少節點？</span><span class="sxs-lookup"><span data-stu-id="1f6a3-523">How many nodes to deploy in my Windows Server AD FS proxy farm?</span></span></li> |<span data-ttu-id="1f6a3-524">恢復功能和容錯</span><span class="sxs-lookup"><span data-stu-id="1f6a3-524">Resiliency and fault tolerance</span></span> |

### <span data-ttu-id="1f6a3-525"><a name="BKMK_NetworkTopology"></a>網路拓撲</span><span class="sxs-lookup"><span data-stu-id="1f6a3-525"><a name="BKMK_NetworkTopology"></a>Network topology</span></span>
<span data-ttu-id="1f6a3-526">若要符合 Windows Server AD DS 的 IP 位址一致性和 DNS 需求，就必須先建立 [Azure 虛擬網路](../virtual-network/virtual-networks-overview.md) 並且附加虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-526">In order to meet the IP address consistency and DNS requirements of Windows Server AD DS, it is necessary to first create an [Azure virtual network](../virtual-network/virtual-networks-overview.md) and attach your virtual machines to it.</span></span> <span data-ttu-id="1f6a3-527">在建立期間，您必須決定是否要選擇性地將連接擴充到內部部署公司網路，以透明方式將 Azure 虛擬機器連接到內部部署機器 — 利用傳統 VPN 技術來達成，而且需要 VPN 端點在公司網路邊緣上公開。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-527">During its creation, you must decide whether to optionally extend connectivity to your on-premises corporate network, which transparently connects Azure virtual machines to on-premises machines — this is achieved using traditional VPN technologies and requires that a VPN endpoint be exposed on the edge of the corporate network.</span></span> <span data-ttu-id="1f6a3-528">也就是說，VPN 是從 Azure 起始到公司網路，反之則不成立。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-528">That is, the VPN is initiated from Azure to the corporate network, not vice-versa.</span></span>

<span data-ttu-id="1f6a3-529">請注意，將虛擬網路擴充到內部部署網路時所產生的費用會超出每個 VM 的標準費用。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-529">Note that additional charges apply when extending a virtual network to your on-premises network beyond the standard charges that apply to each VM.</span></span> <span data-ttu-id="1f6a3-530">具體而言，有 Azure 虛擬網路閘道的 CPU 時間的費用，和跨 VPN 與內部部署機器通訊的每個 VM 所產生的輸出流量的費用。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-530">Specifically, there are charges for CPU time of the Azure Virtual Network gateway and for the egress traffic generated by each VM that communicates with on-premises machines across the VPN.</span></span> <span data-ttu-id="1f6a3-531">如需網路流量費用的詳細資訊，請參閱 [Azure 價格一覽](http://azure.microsoft.com/pricing/)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-531">For more information about network traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span>

### <span data-ttu-id="1f6a3-532"><a name="BKMK_DeploymentConfig"></a>DC 部署組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-532"><a name="BKMK_DeploymentConfig"></a>DC deployment configuration</span></span>
<span data-ttu-id="1f6a3-533">您設定 DC 的方式取決於想要在 Azure 上執行之服務的需求。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-533">The way you configure the DC depends on the requirements for the service you want to run on Azure.</span></span> <span data-ttu-id="1f6a3-534">例如，您可以部署新樹系，與自己的公司樹系隔離，以測試概念證明、新的應用程式或需要目錄服務但不是特定存取內部公司資源的某些其他短期專案。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-534">For example, you might deploy a new forest, isolated from your own corporate forest, for testing a proof-of-concept, a new application, or some other short term project that requires directory services but not specific access to internal corporate resources.</span></span>

<span data-ttu-id="1f6a3-535">優點是隔離的樹系 DC 不會以內部部署 DC 複寫，導致系統本身產生較少的輸出網路流量而直接降低成本。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-535">As a benefit, an isolated forest DC does not replicate with on-premises DCs, resulting in less outbound network traffic generated by the system itself, directly reducing costs.</span></span> <span data-ttu-id="1f6a3-536">如需網路流量費用的詳細資訊，請參閱 [Azure 價格一覽](http://azure.microsoft.com/pricing/)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-536">For more information about network traffic charges, see [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span>

<span data-ttu-id="1f6a3-537">另一個範例，假設您有服務的隱私權需求，但是服務取決於您的內部 Windows Server Active Directory 的存取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-537">As another example, suppose you have privacy requirements for a service, but the service depends on access to your internal Windows Server Active Directory.</span></span> <span data-ttu-id="1f6a3-538">如果您可以在雲端中裝載服務的資料，可以在 Azure 上為您的內部樹系部署新的子網域。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-538">If you are allowed to host data for the service in the cloud, you might deploy a new child domain for your internal forest on Azure.</span></span> <span data-ttu-id="1f6a3-539">在此情況下，您可以為新的子網域部署 DC (不含通用類別目錄以便協助處理隱私權問題)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-539">In this case, you can deploy a DC for the new child domain (without the global catalog in order to help address privacy concerns).</span></span> <span data-ttu-id="1f6a3-540">此案例連同複本 DC 部署，需要虛擬網路以與內部部署 DC 連接。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-540">This scenario, along with a replica DC deployment, requires a virtual network for connectivity with your on-premises DCs.</span></span>

<span data-ttu-id="1f6a3-541">如果您建立新樹系，請選擇要使用 [Active Directory 信任](https://technet.microsoft.com/library/cc771397)或[同盟信任](https://technet.microsoft.com/library/dd807036)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-541">If you create a new forest, choose whether to use [Active Directory trusts](https://technet.microsoft.com/library/cc771397) or [Federation trusts](https://technet.microsoft.com/library/dd807036).</span></span> <span data-ttu-id="1f6a3-542">平衡相容性、安全性、法規遵循、成本和恢復功能所需的要求。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-542">Balance the requirements dictated by compatibility, security, compliance, cost, and resiliency.</span></span> <span data-ttu-id="1f6a3-543">例如，若要利用 [選擇性驗證](https://technet.microsoft.com/library/cc755844) ，您可以選擇在 Azure 上部署新樹系，並且在內部部署樹系與雲端樹系之間建立 Windows Server Active Directory 信任。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-543">For example, to take advantage of [selective authentication](https://technet.microsoft.com/library/cc755844) you might choose to deploy a new forest on Azure and create a Windows Server Active Directory trust between the on-premises forest and the cloud forest.</span></span> <span data-ttu-id="1f6a3-544">不過，如果應用程式是宣告感知，您可能會部署同盟信任而不是 Active Directory 樹系信任。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-544">If the application is claims-aware, however, you might deploy federation trusts instead of Active Directory forest trusts.</span></span> <span data-ttu-id="1f6a3-545">另一個因素是藉由將內部部署 Windows Server Active Directory 擴充至雲端以複寫更多資料，或者因為驗證和查詢負載而產生更多輸出流量所造成的成本。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-545">Another factor will be the cost to either replicate more data by extending your on-premises Windows Server Active Directory to the cloud or generate more outbound traffic as a result of authentication and query load.</span></span>

<span data-ttu-id="1f6a3-546">可用性和容錯的需求也會影響您的選擇。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-546">Requirements for availability and fault tolerance also affect your choice.</span></span> <span data-ttu-id="1f6a3-547">例如，如果連結中斷，利用 Kerberos 信任或同盟信任的應用程式可能都會完全中斷，除非您已經在 Azure 上部署足夠的基礎結構。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-547">For example, if the link is interrupted, applications leveraging either a Kerberos trust or a federation trust are all likely entirely broken unless you have deployed sufficient infrastructure on Azure.</span></span> <span data-ttu-id="1f6a3-548">替代部署組態，例如複本 DC (可寫入或 RODC)，會增加能夠容忍連結中斷的可能性。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-548">Alternative deployment configurations such as replica DCs (writeable or RODCs) increase the likelihood of being able to tolerate link outages.</span></span>

### <span data-ttu-id="1f6a3-549"><a name="BKMK_ADSiteTopology"></a>Windows Server Active Directory 網站拓撲</span><span class="sxs-lookup"><span data-stu-id="1f6a3-549"><a name="BKMK_ADSiteTopology"></a>Windows Server Active Directory site topology</span></span>
<span data-ttu-id="1f6a3-550">您必須正確定義網站與網站連結，才能最佳化流量並且讓成本降至最低。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-550">You need to correctly define sites and site links in order to optimize traffic and minimize cost.</span></span> <span data-ttu-id="1f6a3-551">網站、網站連結和子網路會影響 DC 與驗證流量的流程之間的複寫拓撲。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-551">Sites, site-links, and subnets affect the replication topology between DCs and the flow of authentication traffic.</span></span> <span data-ttu-id="1f6a3-552">請考慮下列流量費用，然後根據您的部署案例的需求部署及設定 DC︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-552">Consider the following traffic charges and then deploy and configure DCs according to the requirements of your deployment scenario:</span></span>

* <span data-ttu-id="1f6a3-553">閘道器本身每小時會有少許費用：</span><span class="sxs-lookup"><span data-stu-id="1f6a3-553">There is a nominal fee per hour for the gateway itself:</span></span>
  
  * <span data-ttu-id="1f6a3-554">您可以自行斟酌啟動或停止</span><span class="sxs-lookup"><span data-stu-id="1f6a3-554">It can be started and stopped as you see fit</span></span>
  * <span data-ttu-id="1f6a3-555">如果停止，Azure VM 就會從公司網路隔離</span><span class="sxs-lookup"><span data-stu-id="1f6a3-555">If stopped, Azure VMs are isolated from the corporate network</span></span>
* <span data-ttu-id="1f6a3-556">輸入流量是免費的</span><span class="sxs-lookup"><span data-stu-id="1f6a3-556">Inbound traffic is free</span></span>
* <span data-ttu-id="1f6a3-557">輸出流量會根據 [Azure 價格一覽](http://azure.microsoft.com/pricing/)計費。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-557">Outbound traffic is charged, according to [Azure pricing at-a-glance](http://azure.microsoft.com/pricing/).</span></span> <span data-ttu-id="1f6a3-558">您可以最佳化內部部署網站和雲端網站之間的網站連結屬性，如下所示︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-558">You can optimize site link properties between on-premises sites and the cloud sites as follows:</span></span>
  
  * <span data-ttu-id="1f6a3-559">如果您使用多個虛擬網路，請適當地設定網站連結和成本以防止 Windows Server AD DS 將 Azure 網站的優先順序放在可以免費提供相同層級服務的網站前面。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-559">If you are using multiple virtual networks, configure the site-links and their costs appropriately to prevent Windows Server AD DS from prioritizing the Azure site over one that can provide the same levels of service at no charge.</span></span> <span data-ttu-id="1f6a3-560">您也可以考慮停用橋接所有網站連結 (BASL) 選項 (預設為啟用)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-560">You might also consider disabling the Bridge all site link (BASL) option (which is enabled by default).</span></span> <span data-ttu-id="1f6a3-561">這可確保只有直接連接的網站彼此複寫。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-561">This ensures that only directly-connected sites replicate with one another.</span></span> <span data-ttu-id="1f6a3-562">可轉移連接網站中的 DC 不再能夠直接彼此複寫，而是必須透過共同網站複寫。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-562">DCs in transitively connected sites are no longer able to replicate directly with each other, but must replicate through a common site or sites.</span></span> <span data-ttu-id="1f6a3-563">如果中繼網站基於某些原因而無法使用，即使網站之間的連接可以使用，可轉移連接網站中的 DC 之間的複寫不會發生。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-563">If the intermediary sites become unavailable for some reason, replication between DCs in transitively connected sites will not occur even if connectivity between the sites is available.</span></span> <span data-ttu-id="1f6a3-564">最後，如果仍然想要其中的可轉移複寫行為，請建立網站連結橋接器，包含適當的網站連結和網站，例如內部部署、公司網路網站。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-564">Finally, where sections of transitive replication behavior remain desirable, create site link bridges that contain the appropriate site-links and sites, such as on-premises, corporate network sites.</span></span>
  * <span data-ttu-id="1f6a3-565">[設定網站連結成本](https://technet.microsoft.com/library/cc794882) 以避免非預期的流量。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-565">[Configure site link costs](https://technet.microsoft.com/library/cc794882) appropriately to avoid unintended traffic.</span></span> <span data-ttu-id="1f6a3-566">例如，如果已啟用 [嘗試下一個最接近的網站]  設定，請確定虛擬網路網站不是下一個最接近的網站，方法是增加網站連結物件 (將 Azure 網站連接回公司網路) 的相關聯成本。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-566">For example, if **Try Next Closest Site** setting is enabled, make sure the virtual network sites are not the next closest by increasing the cost associated of the site-link object that connects the Azure site back to the corporate network.</span></span>
  * <span data-ttu-id="1f6a3-567">根據物件變更的一致性需求和速率，設定網站連結[間隔](https://technet.microsoft.com/library/cc794878)和[排程](https://technet.microsoft.com/library/cc816906)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-567">Configure site link [intervals](https://technet.microsoft.com/library/cc794878) and [schedules](https://technet.microsoft.com/library/cc816906) according to consistency requirements and rate of object changes.</span></span> <span data-ttu-id="1f6a3-568">對齊複寫排程與延遲容許範圍。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-568">Align replication schedule with latency tolerance.</span></span> <span data-ttu-id="1f6a3-569">DC 只會複寫值的最後狀態，因此如果有足夠的物件變更速率，減少複寫間隔可節省成本。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-569">DCs replicate only the last state of a value, so decreasing the replication interval can save costs if there is a sufficient object change rate.</span></span>
* <span data-ttu-id="1f6a3-570">如果將成本降至最低是優先事項，請確定已排程複寫且變更通知未啟用。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-570">If minimizing costs is a priority, ensure replication is scheduled and change notification is not enabled.</span></span> <span data-ttu-id="1f6a3-571">這是在網站之間複寫時的預設組態。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-571">This is the default configuration when replicating between sites.</span></span> <span data-ttu-id="1f6a3-572">如果您要在虛擬網路上部署 RODC，這並不重要，因為 RODC 不會複寫任何輸出變更。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-572">This is not important if you are deploying an RODC on a virtual network because the RODC will not replicate any changes outbound.</span></span> <span data-ttu-id="1f6a3-573">但是，如果您部署可寫入 DC，應該確定網站連結未設定為以不必要的頻率複寫更新。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-573">But if you deploy a writable DC, you should make sure the site link is not configured to replicate updates with unnecessary frequency.</span></span> <span data-ttu-id="1f6a3-574">如果您部署通用類別目錄伺服器 (GC)，請確定每一個包含 GC 的網站，從與具有比 Azure 網站中的 GC 成本還要低的網站連結連接的網站中的來源 DC 複寫網域分割區。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-574">If you deploy a global catalog server (GC), make sure that every other site that contains a GC replicates domain partitions from a source DC in a site that is connected with a site-link or site-links that have a lower cost than the GC in the Azure site.</span></span>
* <span data-ttu-id="1f6a3-575">還可以進一步減少在網站之間複寫所產生的網路流量，方法是變更複寫壓縮演算法。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-575">It is possible to further still reduce network traffic generated by replication between sites by changing the replication compression algorithm.</span></span> <span data-ttu-id="1f6a3-576">壓縮演算法是由 REG_DWORD 登錄項目 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Replicator 壓縮演算法所控制。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-576">The compression algorithm is controlled by the REG_DWORD registry entry HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Replicator compression algorithm.</span></span> <span data-ttu-id="1f6a3-577">預設值為 3，這與 Xpress Compress 演算法相互關聯。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-577">The default value is 3, which correlates to the Xpress Compress algorithm.</span></span> <span data-ttu-id="1f6a3-578">您可以將值變更為 2，如此會將演算法變更為 MSZip。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-578">You can change the value to 2, which changes the algorithm to MSZip.</span></span> <span data-ttu-id="1f6a3-579">在大部分情況下，這樣會增加壓縮，但是也增加 CPU 使用量。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-579">In most cases, this will increase the compression, but it does so at the expense of CPU utilization.</span></span> <span data-ttu-id="1f6a3-580">如需詳細資訊，請參閱 [Active Directory 複寫拓撲如何運作](https://technet.microsoft.com/library/cc755994)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-580">For more information, see [How Active Directory replication topology works](https://technet.microsoft.com/library/cc755994).</span></span>

### <span data-ttu-id="1f6a3-581"><a name="BKMK_IPAddressDNS"></a>IP 位址和 DNS</span><span class="sxs-lookup"><span data-stu-id="1f6a3-581"><a name="BKMK_IPAddressDNS"></a>IP addressing and DNS</span></span>
<span data-ttu-id="1f6a3-582">Azure 虛擬機器預設會配置「DHCP 租用位址」。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-582">Azure virtual machines are allocated “DHCP-leased addresses” by default.</span></span> <span data-ttu-id="1f6a3-583">因為 Azure 虛擬網路動態位址在虛擬機器的存留期是持續存在於虛擬機器，所以符合 Windows Server AD DS 的需求。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-583">Because Azure virtual network dynamic addresses persist with a virtual machine for the lifetime of the virtual machine, the requirements of Windows Server AD DS are met.</span></span>

<span data-ttu-id="1f6a3-584">因此，當您在 Azure 上使用動態位址，實際上是使用靜態 IP 位址，因為它在租用期間可路由，而且租用期間就等於雲端服務的存留期。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-584">As a result, when you use a dynamic address on Azure, you are in effect using a static IP address because it is routable for the period of the lease, and the period of the lease is equal to the lifetime of the cloud service.</span></span>

<span data-ttu-id="1f6a3-585">不過，如果關閉 VM，則會解除配置動態位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-585">However, the dynamic address is deallocated if the VM is shutdown.</span></span> <span data-ttu-id="1f6a3-586">若要避免解除配置 IP 位址，您可以 [使用 Set-AzureStaticVNetIP 指派靜態 IP 位址](http://social.technet.microsoft.com/wiki/contents/articles/23447.how-to-assign-a-private-static-ip-to-an-azure-vm.aspx)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-586">To prevent the IP address from being deallocated, you can [use Set-AzureStaticVNetIP to assign a static IP address](http://social.technet.microsoft.com/wiki/contents/articles/23447.how-to-assign-a-private-static-ip-to-an-azure-vm.aspx).</span></span>

<span data-ttu-id="1f6a3-587">針對名稱解析，部署您自己的 (或利用現有) DNS 伺服器基礎結構；Azure 提供的 DNS 不符合 Windows Server AD DS 的進階名稱解析需求。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-587">For name resolution, deploy your own (or leverage your existing) DNS server infrastructure; Azure-provided DNS does not meet the advanced name resolution needs of Windows Server AD DS.</span></span> <span data-ttu-id="1f6a3-588">例如，不支援動態 SRV 記錄等等。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-588">For example, it does not support dynamic SRV records, and so on.</span></span> <span data-ttu-id="1f6a3-589">名稱解析是 DC 和加入網域的用戶端的重要組態項目。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-589">Name resolution is a critical configuration item for DCs and domain-joined clients.</span></span> <span data-ttu-id="1f6a3-590">DC 必須能夠註冊資源記錄及解析其他 DC 的資源記錄。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-590">DCs must be capable of registering resource records and resolving other DC’s resource records.</span></span>
<span data-ttu-id="1f6a3-591">基於容錯和效能理由，最好是在 Azure 上執行的 DC 上安裝 Windows Server DNS 服務。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-591">For fault tolerance and performance reasons, it is optimal to install the Windows Server DNS service on the DCs running on Azure.</span></span> <span data-ttu-id="1f6a3-592">然後使用 DNS 伺服器的名稱和 IP 位址設定 Azure 虛擬網路屬性。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-592">Then configure the Azure virtual network properties with the name and IP address of the DNS server.</span></span> <span data-ttu-id="1f6a3-593">當虛擬網路上的其他 VM 啟動時，其 DNS 用戶端解析程式設定會設定 DNS 伺服器做為動態 IP 位址配置的一部分。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-593">When other VMs on the virtual network start, their DNS client resolver settings will be configured with DNS server as part of the dynamic IP address allocation.</span></span>

> [!NOTE]
> <span data-ttu-id="1f6a3-594">您無法將內部部署電腦加入直接透過網際網路於 Azure 託管的 Windows Server AD DS Active Directory 網域。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-594">You cannot join on-premises computers to a Windows Server AD DS Active Directory domain that is hosted on Azure directly over the Internet.</span></span> <span data-ttu-id="1f6a3-595">Active Directory 和加入網域作業的連接埠需求會不切實際地將它轉譯，將必要的連接埠和實際上就是整個 DC 直接公開到網際網路。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-595">The port requirements for Active Directory and the domain-join operation render it impractical to directly expose the necessary ports and in effect, an entire DC to the Internet.</span></span>
> 
> 

<span data-ttu-id="1f6a3-596">VM 會在啟動或有名稱變更時自動註冊其 DNS 名稱。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-596">VMs register their DNS name automatically on startup or when there is a name change.</span></span>

<span data-ttu-id="1f6a3-597">如需此範例和示範如何佈建第一個 VM 並在其上安裝 AD DS 的另一個範例的詳細資訊，請參閱 [在 Microsoft Azure 上安裝新的 Active Directory 樹系](active-directory-new-forest-virtual-machine.md)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-597">For more information about this example and another example that shows how to provision the first VM and install AD DS on it, see [Install a new Active Directory forest on Microsoft Azure](active-directory-new-forest-virtual-machine.md).</span></span> <span data-ttu-id="1f6a3-598">如需使用 Windows PowerShell 的詳細資訊，請參閱[安裝 Azure PowerShell](/powershell/azureps-cmdlets-docs) 和 [Azure 管理 Cmdlet](/powershell/module/azurerm.compute/#virtual_machines)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-598">For more information about using Windows PowerShell, see [Install Azure PowerShell](/powershell/azureps-cmdlets-docs) and [Azure Management Cmdlets](/powershell/module/azurerm.compute/#virtual_machines).</span></span>

### <span data-ttu-id="1f6a3-599"><a name="BKMK_DistributedDCs"></a>地理位置分散 DC</span><span class="sxs-lookup"><span data-stu-id="1f6a3-599"><a name="BKMK_DistributedDCs"></a>Geo-distributed DCs</span></span>
<span data-ttu-id="1f6a3-600">在不同的虛擬網路上裝載多個 DC 時，Azure 提供一些優點︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-600">Azure offers advantages when hosting multiple DCs on different virtual networks:</span></span>

* <span data-ttu-id="1f6a3-601">多網站容錯</span><span class="sxs-lookup"><span data-stu-id="1f6a3-601">Multi-site fault-tolerance</span></span>
* <span data-ttu-id="1f6a3-602">實際上接近分公司辦公室 (更低的延遲性)</span><span class="sxs-lookup"><span data-stu-id="1f6a3-602">Physical proximity to branch offices (lower latency)</span></span>

<span data-ttu-id="1f6a3-603">如需設定虛擬網路之間直接通訊的詳細資訊，請參閱 [設定虛擬網路至虛擬網路連接](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-603">For information about configuring direct communication between virtual networks, see [Configure virtual network to virtual network connectivity](../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md).</span></span>

### <span data-ttu-id="1f6a3-604"><a name="BKMK_RODC"></a>唯讀 DC</span><span class="sxs-lookup"><span data-stu-id="1f6a3-604"><a name="BKMK_RODC"></a>Read-only DCs</span></span>
<span data-ttu-id="1f6a3-605">您必須選擇要部署唯讀或可寫入 DC。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-605">You need to choose whether to deploy read-only or writeable DCs.</span></span> <span data-ttu-id="1f6a3-606">您可能比較傾向於部署 RODC，因為您不會實際控制它們，但是 RODC 是設計用來在其實體安全性有風險的位置 (例如分公司辦公室) 部署。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-606">You might be inclined to deploy RODCs because you will not have physical control over them, but RODCs are designed to be deployed in locations where their physical security is at risk, such as branch offices.</span></span>

<span data-ttu-id="1f6a3-607">Azure 沒有分公司辦公室的實體安全性風險，但是 RODC 經過證明可能更符合成本效益，因為它們所提供的功能非常適合這些環境，儘管原因非常不同。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-607">Azure does not present the physical security risk of a branch office, but RODCs might still prove to be more cost effective because the features they provide are well-suited to these environments albeit for very different reasons.</span></span> <span data-ttu-id="1f6a3-608">例如，RODC 沒有輸出複寫，並可選擇性地填入機密資訊 (密碼)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-608">For example, RODCs have no outbound replication and are able to selectively populate secrets (passwords).</span></span> <span data-ttu-id="1f6a3-609">而其缺點是缺少這些密碼可能需要隨選輸出流量，以在使用者或電腦驗證時對其進行驗證。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-609">On the downside, the lack of these secrets might require on-demand outbound traffic to validate them as a user or computer authenticates.</span></span> <span data-ttu-id="1f6a3-610">但是，密碼可以選擇性地預先填入及快取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-610">But secrets can be selectively prepopulated and cached.</span></span>

<span data-ttu-id="1f6a3-611">RODC 提供 HBI 和 PII 考量的額外優點，因為您可以將包含機密資料的屬性加入至 RODC 已篩選屬性集 (FAS)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-611">RODCs provide an additional advantage in and around HBI and PII concerns because you can add attributes that contain sensitive data to the RODC filtered attribute set (FAS).</span></span> <span data-ttu-id="1f6a3-612">FAS 是一組可自訂的屬性，不會複寫到 RODC。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-612">The FAS is a customizable set of attributes that are not replicated to RODCs.</span></span> <span data-ttu-id="1f6a3-613">如果您不允許或不想在 Azure 上儲存 PII 或 HBI，您可以使用 FAS 當做保護。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-613">You can use the FAS as a safeguard in case you are not permitted or do not want to store PII or HBI on Azure.</span></span> <span data-ttu-id="1f6a3-614">如需詳細資訊，請參閱 [RODC 已篩選屬性集[(https://technet.microsoft.com/library/cc753459)]。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-614">For more information, see [RODC filtered attribute set[(https://technet.microsoft.com/library/cc753459)].</span></span>

<span data-ttu-id="1f6a3-615">請確定應用程式與您打算使用的 RODC 相容。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-615">Make sure that applications will be compatible with RODCs you plan to use.</span></span> <span data-ttu-id="1f6a3-616">許多已啟用 Windows Server Active Directory 功能的應用程式適用於 RODC，但是有些應用程式如果沒有可寫入 DC 的存取權，就會無效率地執行或失敗。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-616">Many Windows Server Active Directory-enabled applications work well with RODCs, but some applications can perform inefficiently or fail if they do not have access to a writable DC.</span></span> <span data-ttu-id="1f6a3-617">如需詳細資訊，請參閱 [唯讀 DC 應用程式相容性指南](https://technet.microsoft.com/library/cc755190)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-617">For more information, see [Read-Only DCs application compatibility guide](https://technet.microsoft.com/library/cc755190).</span></span>

### <span data-ttu-id="1f6a3-618"><a name="BKMK_GC"></a>通用類別目錄</span><span class="sxs-lookup"><span data-stu-id="1f6a3-618"><a name="BKMK_GC"></a>Global catalog</span></span>
<span data-ttu-id="1f6a3-619">您必須選擇是否要安裝通用類別目錄 (GC)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-619">You need to choose whether to install a global catalog (GC).</span></span> <span data-ttu-id="1f6a3-620">在單一網域樹系中，您應該將所有 DC 設為通用類別目錄伺服器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-620">In a single domain forest, you should configure all DCs as global catalog servers.</span></span> <span data-ttu-id="1f6a3-621">這樣不會增加成本，因為沒有任何額外複寫流量。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-621">It will not increase costs because there will be no additional replication traffic.</span></span>

<span data-ttu-id="1f6a3-622">在多網域樹系中，在驗證程序期間，需要 GC 以擴充萬用群組成員資格。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-622">In a multidomain forest, GCs are necessary to expand Universal Group memberships during the authentication process.</span></span> <span data-ttu-id="1f6a3-623">如果您未部署 GC，在虛擬網路上根據 Azure 的 DC 進行驗證的工作負載將會間接產生輸出驗證流量，在每次驗證嘗試期間查詢 GC 內部部署。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-623">If you do not deploy a GC, workloads on the virtual network that authenticate against a DC on Azure will indirectly generate outbound authentication traffic to query GCs on-premises during each authentication attempt.</span></span>

<span data-ttu-id="1f6a3-624">與 GC 相關聯的成本比較無法預期，因為它們裝載每個網域 (部分)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-624">The costs associated with GCs are less-predictable because they host every domain (in-part).</span></span> <span data-ttu-id="1f6a3-625">如果工作負載裝載網際網路對應的服務，並且根據 Windows Server AD DS 驗證使用者，則成本可能完全無法預測。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-625">If the workload hosts an Internet-facing service and authenticates users against Windows Server AD DS, the costs could be completely unpredictable.</span></span> <span data-ttu-id="1f6a3-626">若要協助減少驗證期間的雲端網站外的 GC 查詢，您可以 [啟用萬用群組成員資格快取](https://technet.microsoft.com/library/cc816928)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-626">To help reduce GC queries outside of the cloud site during authentication, you can [enable Universal Group Membership Caching](https://technet.microsoft.com/library/cc816928).</span></span>

### <span data-ttu-id="1f6a3-627"><a name="BKMK_InstallMethod"></a>安裝方法</span><span class="sxs-lookup"><span data-stu-id="1f6a3-627"><a name="BKMK_InstallMethod"></a>Installation method</span></span>
<span data-ttu-id="1f6a3-628">您必須選擇如何在虛擬網路上安裝 DC︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-628">You need to choose how to install the DCs on the virtual network:</span></span>

* <span data-ttu-id="1f6a3-629">升級新的 DC。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-629">Promote new DCs.</span></span> <span data-ttu-id="1f6a3-630">如需詳細資訊，請參閱 [在 Azure 虛擬網路上安裝新的 Active Directory 樹系](active-directory-new-forest-virtual-machine.md)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-630">For more information, see [Install a new Active Directory forest on an Azure virtual network](active-directory-new-forest-virtual-machine.md).</span></span>
* <span data-ttu-id="1f6a3-631">將內部部署虛擬 DC 的 VHD 移至雲端。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-631">Move the VHD of an on-premises virtual DC to the cloud.</span></span> <span data-ttu-id="1f6a3-632">在此情況下，您必須確定內部部署虛擬 DC 「已移動」、未「複製」(copy) 或「複製」(clone)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-632">In this case, you must ensure that the on-premises virtual DC is “moved,” not “copied” or “cloned.”</span></span>

<span data-ttu-id="1f6a3-633">針對 DC 僅使用 Azure 虛擬機器 (相對於 Azure「Web」或「背景工作角色」VM)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-633">Use only Azure virtual machines for DCs (as opposed to Azure “web” or “worker” role VMs).</span></span> <span data-ttu-id="1f6a3-634">它們很持久，而且需要 DC 狀態的持久性。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-634">They are durable and durability of state for a DC is required.</span></span> <span data-ttu-id="1f6a3-635">Azure 虛擬機器是針對類似 DC 的工作負載而設計的。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-635">Azure virtual machines are designed for workloads such as DCs.</span></span>

<span data-ttu-id="1f6a3-636">請勿使用 SYSPREP 來部署或複製 DC。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-636">Do not use SYSPREP to deploy or clone DCs.</span></span> <span data-ttu-id="1f6a3-637">複製 DC 的能力是從 Windows Server 2012 開始。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-637">The ability to clone DCs is only available beginning in Windows Server 2012.</span></span> <span data-ttu-id="1f6a3-638">複製功能需要支援基礎 hypervisor 中的 VMGenerationID。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-638">The cloning feature requires support for VMGenerationID in the underlying hypervisor.</span></span> <span data-ttu-id="1f6a3-639">Windows Server 2012 和 Azure 虛擬網路中的 Hyper-V 都支援 VMGenerationID，如同協力廠商虛擬化軟體廠商一樣。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-639">Hyper-V in Windows Server 2012 and Azure virtual networks both support VMGenerationID, as do third-party virtualization software vendors.</span></span>

### <span data-ttu-id="1f6a3-640"><a name="BKMK_PlaceDB"></a>Windows Server AD DS 資料庫和 SYSVOL 的位置</span><span class="sxs-lookup"><span data-stu-id="1f6a3-640"><a name="BKMK_PlaceDB"></a>Placement of the Windows Server AD DS database and SYSVOL</span></span>
<span data-ttu-id="1f6a3-641">選取 Windows Server AD DS 資料庫、記錄和 SYSVOL 的儲存位置。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-641">Select where to locate the Windows Server AD DS database, logs, and SYSVOL.</span></span> <span data-ttu-id="1f6a3-642">必須部署在 Azure 資料磁碟上。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-642">They must be deployed on Azure Data disks.</span></span>

> [!NOTE]
> <span data-ttu-id="1f6a3-643">Azure 資料磁碟限制為 1 TB。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-643">Azure Data disks are constrained to 1 TB.</span></span>
> 
> 

<span data-ttu-id="1f6a3-644">根據預設，資料磁碟機未快取寫入。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-644">Data disk drives do not cache writes by default.</span></span> <span data-ttu-id="1f6a3-645">連接到 VM 的資料磁碟機會使用貫穿式寫入快取。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-645">Data disk drives that are attached to a VM use write-through caching.</span></span> <span data-ttu-id="1f6a3-646">貫穿式寫入快取會確定從 VM 的作業系統的觀點來看，寫入在交易完成之前致力於持久的 Azure 儲存體。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-646">Write-through caching makes sure the write is committed to durable Azure storage before the transaction is complete from the perspective of the VM’s operating system.</span></span> <span data-ttu-id="1f6a3-647">它提供持久性，但是會讓寫入稍微慢一點。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-647">It provides durability, at the expense of slightly slower writes.</span></span>

<span data-ttu-id="1f6a3-648">這對於 Windows Server AD DS 很重要，因為事後寫入磁碟快取會讓 DC 所做的假設失效。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-648">This is important for Windows Server AD DS because write-behind disk-caching invalidates assumptions made by the DC.</span></span> <span data-ttu-id="1f6a3-649">Windows Server AD DS 會嘗試停用寫入快取，但是由磁碟 IO 系統決定要不要接受。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-649">Windows Server AD DS attempts to disable write caching but it is up to the disk IO system to honor it.</span></span> <span data-ttu-id="1f6a3-650">在某些情況下可能會無法停用寫入快取，造成 USN 回復，進而導致物件停留和其他問題。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-650">Failure to disable write caching may, under certain circumstances, introduce USN rollback resulting in lingering objects and other problems.</span></span>

<span data-ttu-id="1f6a3-651">對於虛擬 DC 的最佳作法，請執行下列作業︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-651">As a best practice for virtual DCs, do the following:</span></span>

* <span data-ttu-id="1f6a3-652">在 Azure 資料磁碟上將 [主機快取偏好設定] 設為 [無]。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-652">Set the Host Cache Preference setting on the Azure data disk for NONE.</span></span> <span data-ttu-id="1f6a3-653">這可避免 AD DS 作業的寫入快取問題。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-653">This prevents issues with write caching for AD DS operations.</span></span>
* <span data-ttu-id="1f6a3-654">將資料庫、記錄及 SYSVOL 儲存在相同的資料磁碟或不同的資料磁碟。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-654">Store the database, logs, and SYSVOL on the either same data disk or separate data disks.</span></span> <span data-ttu-id="1f6a3-655">一般而言，這是與用於作業系統本身的磁碟不同的磁碟。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-655">Typically, this is a separate disk from the disk used for the operating system itself.</span></span> <span data-ttu-id="1f6a3-656">重點是，Windows Server AD DS 資料庫和 SYSVOL 不能儲存在 Azure 作業系統磁碟類型上。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-656">The key takeaway is that the Windows Server AD DS database and SYSVOL must not be stored on an Azure Operating System disk type.</span></span> <span data-ttu-id="1f6a3-657">根據預設，AD DS 安裝程序會在 %systemroot% 資料夾中安裝這些元件，對於 Azure 並非建議選項。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-657">By default, the AD DS installation process installs these components in %systemroot% folder, which is NOT recommended for Azure.</span></span>

### <span data-ttu-id="1f6a3-658"><a name="BKMK_BUR"></a>備份與還原</span><span class="sxs-lookup"><span data-stu-id="1f6a3-658"><a name="BKMK_BUR"></a>Backup and restore</span></span>
<span data-ttu-id="1f6a3-659">請注意通常對於 DC 的備份與還原支援和不支援的項目，具體而言，就是在 VM 中執行的項目。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-659">Be aware of what is and is not supported for backup and restore of a DC in general, and more specifically, those running in a VM.</span></span> <span data-ttu-id="1f6a3-660">請參閱 [虛擬化 DC 的備份與還原考量](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv#backup_and_restore_considerations_for_virtualized_domain_controllers)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-660">See [Backup and Restore Considerations for Virtualized DCs](https://technet.microsoft.com/library/virtual_active_directory_domain_controller_virtualization_hyperv#backup_and_restore_considerations_for_virtualized_domain_controllers).</span></span>

<span data-ttu-id="1f6a3-661">建立系統狀態備份，方法是只使用特別知道 Windows Server AD DS 的備份需求的備份軟體，例如 Windows Server Backup。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-661">Create system state backups by using only backup software that is specifically aware of backup requirements for Windows Server AD DS, such as Windows Server Backup.</span></span>

<span data-ttu-id="1f6a3-662">請勿複製 (copy) 或複製 (clone) DC 的 VHD 檔案，而是執行定期備份。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-662">Do not copy or clone VHD files of DCs instead of performing regular backups.</span></span> <span data-ttu-id="1f6a3-663">如果需要還原，使用複製的 VHD 而未使用 Windows Server 2012 和支援的 hypervisor 會產生 USN 泡沫。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-663">Should a restore ever be required, doing so using cloned or copied VHDs without Windows Server 2012 and a supported hypervisor will introduce USN bubbles.</span></span>

### <span data-ttu-id="1f6a3-664"><a name="BKMK_FedSrvConfig"></a>同盟伺服器組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-664"><a name="BKMK_FedSrvConfig"></a>Federation server configuration</span></span>
<span data-ttu-id="1f6a3-665">Windows Server AD FS 同盟伺服器 (STS) 的組態一部分取決於您想要在 Azure 上部署的應用程式是否需要存取內部部署網路上的資源。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-665">The configuration of Windows Server AD FS federation servers (STSs) depends in part on whether the applications that you want to deploy on Azure need to access resources on your on-premises network.</span></span>

<span data-ttu-id="1f6a3-666">如果應用程式符合下列準則，您可以部署應用程式，與內部部署網路隔離。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-666">If the applications meet the following criteria, you could deploy the applications in isolation from your on-premises network.</span></span>

* <span data-ttu-id="1f6a3-667">它們接受 SAML 安全性權杖</span><span class="sxs-lookup"><span data-stu-id="1f6a3-667">They accept SAML security tokens</span></span>
* <span data-ttu-id="1f6a3-668">它們可公開至網際網路</span><span class="sxs-lookup"><span data-stu-id="1f6a3-668">They are exposable to the Internet</span></span>
* <span data-ttu-id="1f6a3-669">它們不會存取內部部署資源</span><span class="sxs-lookup"><span data-stu-id="1f6a3-669">They do not access on-premises resources</span></span>

<span data-ttu-id="1f6a3-670">在此情況下，設定 Windows Server AD FS STS，如下所示︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-670">In this case, configure Windows Server AD FS STSs as follows:</span></span>

1. <span data-ttu-id="1f6a3-671">在 Azure 上設定隔離的單一網域樹系。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-671">Configure an isolated single-domain forest on Azure.</span></span>
2. <span data-ttu-id="1f6a3-672">藉由設定 Windows Server AD FS 同盟伺服器陣列，提供樹系的同盟存取權。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-672">Provide federated access to the forest by configuring a Windows Server AD FS federation server farm.</span></span>
3. <span data-ttu-id="1f6a3-673">在內部部署樹系中設定 Windows Server AD FS (同盟伺服器陣列和同盟伺服器 Proxy 伺服器陣列)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-673">Configure Windows Server AD FS (federation server farm and federation server proxy farm) in the on-premises forest.</span></span>
4. <span data-ttu-id="1f6a3-674">建立內部部署與 Windows Server AD FS 的 Azure 執行個體之間的同盟信任關係。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-674">Establish a federation trust relationship between the on-premises and Azure instances of Windows Server AD FS.</span></span>

<span data-ttu-id="1f6a3-675">相反地，如果應用程式需要存取內部部署資源，您可以使用 Azure 上的應用程式設定 Windows Server AD FS，如下所示︰</span><span class="sxs-lookup"><span data-stu-id="1f6a3-675">On the other hand, if the applications require access to on-premises resources, you could configure Windows Server AD FS with the application on Azure as follows:</span></span>

1. <span data-ttu-id="1f6a3-676">設定內部部署網路與 Azure 之間的連接。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-676">Configure connectivity between on-premises networks and Azure.</span></span>
2. <span data-ttu-id="1f6a3-677">在內部部署樹系中設定 Windows Server AD FS 同盟伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-677">Configure a Windows Server AD FS federation server farm in the on-premises forest.</span></span>
3. <span data-ttu-id="1f6a3-678">在 Azure 上設定 Windows Server AD FS 同盟伺服器 Proxy 伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-678">Configure a Windows Server AD FS federation server proxy farm on Azure.</span></span>

<span data-ttu-id="1f6a3-679">此組態的優點是能夠減少公開內部部署資源，類似於以周邊網路中的應用程式設定 Windows Server AD FS。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-679">This configuration has the advantage of reducing the exposure of on-premises resources, similar to configuring Windows Server AD FS with applications in a perimeter network.</span></span>

<span data-ttu-id="1f6a3-680">請注意，在任一案例中，如果需要企業對企業共同作業，您可以建立具有多個識別提供者的信任關係。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-680">Note that in either scenario, you can establish trusts relationships with more identity providers, if business-to-business collaboration is needed.</span></span>

### <span data-ttu-id="1f6a3-681"><a name="BKMK_CloudSvcConfig"></a>雲端服務組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-681"><a name="BKMK_CloudSvcConfig"></a>Cloud services configuration</span></span>
<span data-ttu-id="1f6a3-682">如果您想要將 VM 直接公開至網際網路，或者公開網際網路對應負載平衡應用程式，則需要雲端服務。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-682">Cloud services are necessary if you want to expose a VM directly to the Internet or to expose an Internet-facing load-balanced application.</span></span> <span data-ttu-id="1f6a3-683">這是可行的，因為每個雲端服務提供一個可設定虛擬 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-683">This is possible because each cloud service offers a single configurable virtual IP address.</span></span>

### <span data-ttu-id="1f6a3-684"><a name="BKMK_FedReqVIPDIP"></a>公用和私人 IP 位址 (動態 IP 與虛擬 IP) 的同盟伺服器需求</span><span class="sxs-lookup"><span data-stu-id="1f6a3-684"><a name="BKMK_FedReqVIPDIP"></a>Federation server requirements for public and private IP addressing (dynamic IP vs. virtual IP)</span></span>
<span data-ttu-id="1f6a3-685">每個 Azure 虛擬機器會接收動態 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-685">Each Azure virtual machine receives a dynamic IP address.</span></span> <span data-ttu-id="1f6a3-686">動態 IP 位址是只能在 Azure 中存取的私人位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-686">A dynamic IP address is a private address accessible only within Azure.</span></span> <span data-ttu-id="1f6a3-687">不過，在大部分情況下，必須為您的 Windows Server AD FS 部署設定虛擬 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-687">In most cases, however, it will be necessary to configure a virtual IP address for your Windows Server AD FS deployments.</span></span> <span data-ttu-id="1f6a3-688">需要虛擬 IP 以將 Windows Server AD FS 端點公開到網際網路，並且由同盟夥伴和用戶端用於驗證和持續管理。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-688">The virtual IP is necessary to expose Windows Server AD FS endpoints to the Internet, and will be used by federated partners and clients for authentication and ongoing management.</span></span> <span data-ttu-id="1f6a3-689">虛擬 IP 位址是雲端服務的屬性，該雲端服務包含一或多個 Azure 虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-689">A virtual IP address is a property of a cloud service which contains one or more Azure virtual machines.</span></span> <span data-ttu-id="1f6a3-690">如果在 Azure 和 Windows Server AD FS 上部署的宣告感知應用程式都是網際網路對應並且共用共同的連接埠，都需要自己的虛擬 IP 位址，因此必須為應用程式建立一個雲端服務，為 Windows Server AD FS 建立第二個雲端服務。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-690">If the claims-aware application deployed on Azure and Windows Server AD FS are both Internet-facing and share common ports, each will require a virtual IP address of its own and it will therefore be necessary to create one cloud service for the application and a second for Windows Server AD FS.</span></span>

<span data-ttu-id="1f6a3-691">如需詞彙虛擬 IP 位址和動態 IP 位址的定義，請參閱 [詞彙和定義](#BKMK_Glossary)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-691">For definitions of the terms virtual IP address and dynamic IP address, see [Terms and definitions](#BKMK_Glossary).</span></span>

### <span data-ttu-id="1f6a3-692"><a name="BKMK_ADFSHighAvail"></a>Windows Server AD FS 高可用性組態</span><span class="sxs-lookup"><span data-stu-id="1f6a3-692"><a name="BKMK_ADFSHighAvail"></a>Windows Server AD FS high availability configuration</span></span>
<span data-ttu-id="1f6a3-693">雖然您可以部署獨立的 Windows Server AD FS 同盟服務，建議針對 AD FS STS 和生產環境中的 Proxy 部署具有至少兩個節點的伺服器陣列。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-693">While it is possible to deploy standalone Windows Server AD FS federation services, it is recommended to deploy a farm with at least two nodes for both AD FS STS and proxies for production environments.</span></span>

<span data-ttu-id="1f6a3-694">請參閱 [AD FS 2.0 設計指南](https://technet.microsoft.com/library/dd807036)中的 [AD FS 2.0 部署拓撲考量](https://technet.microsoft.com/library/gg982489)，以決定哪個部署組態選項最適合您的特定需求。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-694">See [AD FS 2.0 deployment topology considerations](https://technet.microsoft.com/library/gg982489) in the [AD FS 2.0 Design Guide](https://technet.microsoft.com/library/dd807036) to decide which deployment configuration options best suit your particular needs.</span></span>

> [!NOTE]
> <span data-ttu-id="1f6a3-695">若要取得 Azure 上 Windows Server AD FS 端點的負載平衡，請在相同的雲端服務中設定 Windows Server AD FS 伺服器陣列的所有成員，並針對 HTTP (預設為 80) 和 HTTPS 連接埠 (預設為 443) 使用 Azure 的負載平衡功能。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-695">In order to get load balancing for Windows Server AD FS endpoints on Azure, configure all members of the Windows Server AD FS farm in the same cloud service, and use the load balancing capability of Azure for HTTP (default 80) and HTTPS ports (default 443).</span></span> <span data-ttu-id="1f6a3-696">如需詳細資訊，請參閱 [Azure 負載平衡器探查](https://msdn.microsoft.com/library/azure/jj151530)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-696">For more information, see [Azure load-balancer probe](https://msdn.microsoft.com/library/azure/jj151530).</span></span>
> <span data-ttu-id="1f6a3-697">Azure 不支援 Windows Server 網路負載平衡 (NLB)。</span><span class="sxs-lookup"><span data-stu-id="1f6a3-697">Windows Server Network Load Balancing (NLB) is not supported on Azure.</span></span>
> 
> 

