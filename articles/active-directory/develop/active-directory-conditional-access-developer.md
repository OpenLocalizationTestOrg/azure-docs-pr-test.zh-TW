---
title: "Azure Active Directory 條件式存取的指引 aaaDeveloper |Microsoft 文件"
description: "Azure Active Directory 條件式存取的開發人員指引和案例"
services: active-directory
keywords: 
author: danieldobalian
manager: mbaldwin
editor: PatAltimore
ms.author: dadobali
ms.date: 07/19/2017
ms.assetid: 115bdab2-e1fd-4403-ac15-d4195e24ac95
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.openlocfilehash: 589393f5d084d64872b372d895dc889f300592bf
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="developer-guidance-for-azure-active-directory-conditional-access"></a><span data-ttu-id="2282b-103">Azure Active Directory 條件式存取的開發人員指引</span><span class="sxs-lookup"><span data-stu-id="2282b-103">Developer Guidance for Azure Active Directory Conditional Access</span></span>

<span data-ttu-id="2282b-104">Azure Active Directory (AD) 提供數種方式 toosecure 您的應用程式，並保護服務。</span><span class="sxs-lookup"><span data-stu-id="2282b-104">Azure Active Directory (AD) offers several ways toosecure your app and protect a service.</span></span>  <span data-ttu-id="2282b-105">這些獨特功能其中之一就是條件式存取。</span><span class="sxs-lookup"><span data-stu-id="2282b-105">One of these unique features is conditional access.</span></span>  <span data-ttu-id="2282b-106">條件式存取可讓開發人員和企業客戶 tooprotect 服務的方式包括：</span><span class="sxs-lookup"><span data-stu-id="2282b-106">Conditional access enables developers and enterprise customers tooprotect services in a multitude of ways including:</span></span>

* <span data-ttu-id="2282b-107">Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="2282b-107">Multi-factor authentication</span></span>
* <span data-ttu-id="2282b-108">允許只 Intune 註冊裝置 tooaccess 特定服務</span><span class="sxs-lookup"><span data-stu-id="2282b-108">Allowing only Intune enrolled devices tooaccess specific services</span></span>
* <span data-ttu-id="2282b-109">限制使用者位置及 IP 範圍</span><span class="sxs-lookup"><span data-stu-id="2282b-109">Restricting user locations and IP ranges</span></span>

<span data-ttu-id="2282b-110">多個 hello 完整功能條件式存取的詳細資訊，請參閱[hello Azure 傳統入口網站中的條件式存取](../active-directory-conditional-access.md)。</span><span class="sxs-lookup"><span data-stu-id="2282b-110">For more information on hello full capabilities of conditional access, see [Conditional access in hello Azure classic portal](../active-directory-conditional-access.md).</span></span> 

<span data-ttu-id="2282b-111">在本文中，我們會著重在哪些條件式存取權就表示 toodevelopers 建置應用程式的 Azure AD。</span><span class="sxs-lookup"><span data-stu-id="2282b-111">In this article, we focus on what conditional access means toodevelopers building apps for Azure AD.</span></span>  <span data-ttu-id="2282b-112">它假設對於[單一](active-directory-integrating-applications.md)和[多租用戶](active-directory-devhowto-multi-tenant-overview.md)應用程式以及[常見驗證模式](active-directory-authentication-scenarios.md)的認知。</span><span class="sxs-lookup"><span data-stu-id="2282b-112">It assumes knowledge of [single](active-directory-integrating-applications.md) and [multi-tenant](active-directory-devhowto-multi-tenant-overview.md) apps and [common authentication patterns](active-directory-authentication-scenarios.md).</span></span>

<span data-ttu-id="2282b-113">我們將探討 hello 影響存取您沒有在控制項的資源，可能會有套用條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-113">We'll dive into hello impact of accessing resources you don't have control over that may have conditional access policies applied.</span></span>  <span data-ttu-id="2282b-114">此外，我們探討 hello 含意 hello 代表的資料流程中的條件式存取的 web 應用程式，存取 hello Microsoft Graph 和呼叫 Api。</span><span class="sxs-lookup"><span data-stu-id="2282b-114">Moreover, we explore hello implications of conditional access in hello on-behalf-of flow, web apps, accessing hello Microsoft Graph, and calling APIs.</span></span>

## <a name="how-does-conditional-access-impact-an-app"></a><span data-ttu-id="2282b-115">條件式存取如何影響應用程式？</span><span class="sxs-lookup"><span data-stu-id="2282b-115">How does conditional access impact an app?</span></span>

### <a name="app-topologies-impacted"></a><span data-ttu-id="2282b-116">受影響的應用程式拓樸</span><span class="sxs-lookup"><span data-stu-id="2282b-116">App topologies impacted</span></span>

<span data-ttu-id="2282b-117">在最常見的情況下，條件式存取不會變更應用程式的行為，或需要 hello 開發人員從任何變更。</span><span class="sxs-lookup"><span data-stu-id="2282b-117">In most common cases, conditional access does not change an app's behavior or requires any changes from hello developer.</span></span>  <span data-ttu-id="2282b-118">只有在某些情況下當應用程式間接或無訊息方式要求的語彙基元服務中，應用程式會要求程式碼會變更 toohandle 條件式存取 「 挑戰"。</span><span class="sxs-lookup"><span data-stu-id="2282b-118">Only in certain cases when an app indirectly or silently requests a token for a service, an app requires code changes toohandle conditional access "challenges".</span></span>  <span data-ttu-id="2282b-119">這有如執行互動式登入要求一樣簡單。</span><span class="sxs-lookup"><span data-stu-id="2282b-119">It may be as simple as performing an interactive sign-in request.</span></span> 

<span data-ttu-id="2282b-120">具體來說，hello 下列案例需要程式碼 toohandle 條件式存取 「 挑戰":</span><span class="sxs-lookup"><span data-stu-id="2282b-120">Specifically, hello following scenarios require code toohandle conditional access "challenges":</span></span> 

* <span data-ttu-id="2282b-121">存取 hello Microsoft Graph 應用程式</span><span class="sxs-lookup"><span data-stu-id="2282b-121">Apps accessing hello Microsoft Graph</span></span>
* <span data-ttu-id="2282b-122">應用程式執行 hello 代表的流程</span><span class="sxs-lookup"><span data-stu-id="2282b-122">Apps performing hello on-behalf-of flow</span></span>
* <span data-ttu-id="2282b-123">存取多個服務/資源的應用程式</span><span class="sxs-lookup"><span data-stu-id="2282b-123">Apps accessing multiple services/resources</span></span>
* <span data-ttu-id="2282b-124">使用 ADAL.js 的單一頁面應用程式</span><span class="sxs-lookup"><span data-stu-id="2282b-124">Single page apps using ADAL.js</span></span>

<span data-ttu-id="2282b-125">條件式存取原則可以套用的 toohello 應用程式，但也可以套用的 tooa web API 應用程式存取。</span><span class="sxs-lookup"><span data-stu-id="2282b-125">Conditional access policies can be applied toohello app, but also can be applied tooa web API your app accesses.</span></span> <span data-ttu-id="2282b-126">toolearn 深入了解 tooconfigure 條件式存取原則，請參閱[開始使用 Azure Active Directory 條件式存取](../active-directory-conditional-access-azuread-connected-apps.md#configure-per-application-access-rules)。</span><span class="sxs-lookup"><span data-stu-id="2282b-126">toolearn more about how tooconfigure a conditional access policy, please see [Getting started with Azure Active Directory Conditional Access](../active-directory-conditional-access-azuread-connected-apps.md#configure-per-application-access-rules).</span></span>

<span data-ttu-id="2282b-127">根據 hello 的案例，企業客戶可以套用，並隨時移除條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-127">Depending on hello scenario, an enterprise customer can apply and remove conditional access policies at any time.</span></span>  <span data-ttu-id="2282b-128">為了讓您的應用程式 toocontinue 正常運作時套用新原則時，您需要 tooimplement hello"挑戰 」 處理。</span><span class="sxs-lookup"><span data-stu-id="2282b-128">In order for your app toocontinue functioning when a new policy is applied, you need tooimplement hello "challenge" handling.</span></span> <span data-ttu-id="2282b-129">下列範例中的 hello 說明挑戰處理。</span><span class="sxs-lookup"><span data-stu-id="2282b-129">hello following examples illustrate challenge handling.</span></span> 

### <a name="conditional-access-examples"></a><span data-ttu-id="2282b-130">條件式存取範例</span><span class="sxs-lookup"><span data-stu-id="2282b-130">Conditional access examples</span></span>

<span data-ttu-id="2282b-131">某些案例需要程式碼變更 toohandle 條件式存取，而其他人可正常是。</span><span class="sxs-lookup"><span data-stu-id="2282b-131">Some scenarios require code changes toohandle conditional access whereas others work as is.</span></span>  <span data-ttu-id="2282b-132">以下是幾個使用條件式存取，提供一些深入 hello 差異 toodo multi-factor authentication 的案例。</span><span class="sxs-lookup"><span data-stu-id="2282b-132">Here are a few scenarios using conditional access toodo multi-factor authentication that gives some insight into hello difference.</span></span>

* <span data-ttu-id="2282b-133">您要建置單一租用戶 iOS 應用程式，並套用條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-133">You are building a single-tenant iOS app and apply a conditional access policy.</span></span>  <span data-ttu-id="2282b-134">hello 應用程式登入使用者，並不會要求存取 tooan API。</span><span class="sxs-lookup"><span data-stu-id="2282b-134">hello app signs in a user and doesn't request access tooan API.</span></span>  <span data-ttu-id="2282b-135">當 hello 使用者登入時，會自動叫用 hello 原則，以及 hello 使用者需要 tooperform multi-factor authentication (MFA)。</span><span class="sxs-lookup"><span data-stu-id="2282b-135">When hello user signs in, hello policy is automatically invoked and hello user needs tooperform multi-factor authentication (MFA).</span></span> 
* <span data-ttu-id="2282b-136">您要建置使用 hello Microsoft Graph tooaccess 交換，在其他服務之間的多租用戶 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="2282b-136">You are building a multi-tenant web app that uses hello Microsoft Graph tooaccess Exchange, among other services.</span></span>  <span data-ttu-id="2282b-137">採用此應用程式的企業客戶要設定 SharePoint Online 上的原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-137">An enterprise customer who adopts this app sets a policy on SharePoint Online.</span></span>  <span data-ttu-id="2282b-138">當 hello web 應用程式要求語彙基元 MS 圖形時，要套用的原則上的任何 Microsoft 服務 （特別是服務可以透過 graph 存取）。</span><span class="sxs-lookup"><span data-stu-id="2282b-138">When hello web app requests a token for MS Graph, a policy on any Microsoft Service is applied (specifically services that can be accessed through graph).</span></span>  <span data-ttu-id="2282b-139">系統會提示這個使用者進行 MFA。</span><span class="sxs-lookup"><span data-stu-id="2282b-139">This end-user is prompted for MFA.</span></span> <span data-ttu-id="2282b-140">Hello 的情況下，在 hello 使用者登入有效的語彙基元中，宣告"挑戰"會傳回 toohello web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="2282b-140">In hello case, hello end-user is signed in with valid tokens, a claims "challenge" is returned toohello web app.</span></span>  
* <span data-ttu-id="2282b-141">您要建置使用中介層服務 tooaccess hello Microsoft Graph 的原生應用程式。</span><span class="sxs-lookup"><span data-stu-id="2282b-141">You are building a native app that uses a middle tier service tooaccess hello Microsoft Graph.</span></span>  <span data-ttu-id="2282b-142">企業客戶在 hello 公司中使用此應用程式適用於原則 tooExchange 線上。</span><span class="sxs-lookup"><span data-stu-id="2282b-142">An enterprise customer at hello company using this app applies a policy tooExchange Online.</span></span>  <span data-ttu-id="2282b-143">當使用者登入時，hello 原生應用程式要求存取 toohello 中介層，並將傳送嗨 token。</span><span class="sxs-lookup"><span data-stu-id="2282b-143">When an end-user signs in, hello native app requests access toohello middle tier and sends hello token.</span></span>  <span data-ttu-id="2282b-144">hello 中介層執行上-代表 」 流程 toorequest 存取 toohello MS 圖形。</span><span class="sxs-lookup"><span data-stu-id="2282b-144">hello middle tier performs on-behalf-of flow toorequest access toohello MS Graph.</span></span>  <span data-ttu-id="2282b-145">此時，宣告"挑戰"呈現 toohello 中介層。</span><span class="sxs-lookup"><span data-stu-id="2282b-145">At this point, a claims "challenge" is presented toohello middle tier.</span></span> <span data-ttu-id="2282b-146">hello 中介層會傳送 hello 挑戰後 toohello 原生應用程式，這需要 toocomply 與 hello 條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-146">hello middle tier sends hello challenge back toohello native app, which needs toocomply with hello conditional access policy.</span></span>

### <a name="complying-with-a-conditional-access-policy"></a><span data-ttu-id="2282b-147">遵守條件式存取原則</span><span class="sxs-lookup"><span data-stu-id="2282b-147">Complying with a conditional access policy</span></span>

<span data-ttu-id="2282b-148">對於數個不同的應用程式的拓撲，條件式存取原則會評估建立 hello 工作階段。</span><span class="sxs-lookup"><span data-stu-id="2282b-148">For several different app topologies, a conditional access policy is evaluated when hello session is established.</span></span>  <span data-ttu-id="2282b-149">與條件式存取原則的應用程式和服務的 hello 資料粒度上，會叫用所在的 hello 點取決於 hello 案例中，您正嘗試 tooaccomplish。</span><span class="sxs-lookup"><span data-stu-id="2282b-149">As a conditional access policy operates on hello granularity of apps and services, hello point at which it is invoked depends heavily on hello scenario you're trying tooaccomplish.</span></span>

<span data-ttu-id="2282b-150">當您的應用程式嘗試 tooaccess 具有條件式存取原則的服務時，它可能會遇到的條件式存取的挑戰。</span><span class="sxs-lookup"><span data-stu-id="2282b-150">When your app attempts tooaccess a service with a conditional access policy, it may encounter a conditional access challenge.</span></span>  <span data-ttu-id="2282b-151">這項挑戰，會編碼在 hello`claims`傳入從 Azure AD 的回應或 hello Microsoft Graph 參數。</span><span class="sxs-lookup"><span data-stu-id="2282b-151">This challenge is encoded in hello `claims` parameter that comes in a response from Azure AD or hello Microsoft Graph.</span></span>  <span data-ttu-id="2282b-152">以下是這項挑戰參數的範例：</span><span class="sxs-lookup"><span data-stu-id="2282b-152">Here's an example of this challenge parameter:</span></span> 

```
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

<span data-ttu-id="2282b-153">開發人員可以使用這項挑戰，並將其附加到新的要求 tooAzure AD。</span><span class="sxs-lookup"><span data-stu-id="2282b-153">Developers can take this challenge and append it onto a new request tooAzure AD.</span></span>  <span data-ttu-id="2282b-154">傳遞此狀態會提示 hello 使用者 tooperform 任何動作的必要 toocomply 與 hello 條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-154">Passing this state prompts hello end-user tooperform any action necessary toocomply with hello conditional access policy.</span></span> <span data-ttu-id="2282b-155">在下列案例的 hello，說明 hello 錯誤和如何 tooextract hello 參數特性。</span><span class="sxs-lookup"><span data-stu-id="2282b-155">In hello following scenarios, specifics of hello error and how tooextract hello parameter are explained.</span></span> 

## <a name="scenarios"></a><span data-ttu-id="2282b-156">案例</span><span class="sxs-lookup"><span data-stu-id="2282b-156">Scenarios</span></span>

### <a name="prerequisites"></a><span data-ttu-id="2282b-157">必要條件</span><span class="sxs-lookup"><span data-stu-id="2282b-157">Prerequisites</span></span>

<span data-ttu-id="2282b-158">Azure AD 條件式存取是 [Azure AD Premium](../active-directory-whatis.md#choose-an-edition) 中包含的一項功能。</span><span class="sxs-lookup"><span data-stu-id="2282b-158">Azure AD conditional access is a feature included in [Azure AD Premium](../active-directory-whatis.md#choose-an-edition).</span></span>  <span data-ttu-id="2282b-159">您可以進一步了解授權需求在 hello[未經授權的使用方式報表](../active-directory-conditional-access-unlicensed-usage-report.md)。</span><span class="sxs-lookup"><span data-stu-id="2282b-159">You can learn more about licensing requirements in hello [unlicensed usage report](../active-directory-conditional-access-unlicensed-usage-report.md).</span></span>  <span data-ttu-id="2282b-160">開發人員可以加入 hello [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx)，包括免費訂用帳戶 toohello Enterprise Mobility Suite 包含 Azure AD Premium。</span><span class="sxs-lookup"><span data-stu-id="2282b-160">Developers can join hello [Microsoft Developer Network](https://msdn.microsoft.com/dn308572.aspx), which includes a free subscription toohello Enterprise Mobility Suite which includes Azure AD Premium.</span></span>

### <a name="considerations-for-specific-scenarios"></a><span data-ttu-id="2282b-161">特定情節的考量</span><span class="sxs-lookup"><span data-stu-id="2282b-161">Considerations for specific scenarios</span></span>

<span data-ttu-id="2282b-162">hello 下列資訊僅適用於這些條件式存取案例：</span><span class="sxs-lookup"><span data-stu-id="2282b-162">hello following information only applies in these conditional access scenarios:</span></span>

* <span data-ttu-id="2282b-163">存取 hello Microsoft Graph 應用程式</span><span class="sxs-lookup"><span data-stu-id="2282b-163">Apps accessing hello Microsoft Graph</span></span>
* <span data-ttu-id="2282b-164">應用程式執行 hello 代表的流程</span><span class="sxs-lookup"><span data-stu-id="2282b-164">Apps performing hello on-behalf-of flow</span></span>
* <span data-ttu-id="2282b-165">存取多個服務/資源的應用程式</span><span class="sxs-lookup"><span data-stu-id="2282b-165">Apps accessing multiple services/resources</span></span>
* <span data-ttu-id="2282b-166">使用 ADAL.js 的單一頁面應用程式</span><span class="sxs-lookup"><span data-stu-id="2282b-166">Single page apps using ADAL.js</span></span>

<span data-ttu-id="2282b-167">在下列各節的 hello，我們將會成常見的案例是更複雜。</span><span class="sxs-lookup"><span data-stu-id="2282b-167">In hello following sections, we'll get into common scenarios in which are more complex.</span></span>  <span data-ttu-id="2282b-168">hello 核心作業系統的原則是條件式存取原則在時間會評估 hello 要求 hello 語彙基元 hello 服務已套用，除非它正由 hello Microsoft Graph 存取的條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-168">hello core operating principle is conditional access policies are evaluated at hello time hello token is requested for hello service that has a conditional access policy applied unless it's being accessed through hello Microsoft Graph.</span></span>

### <a name="scenario-app-accessing-hello-microsoft-graph"></a><span data-ttu-id="2282b-169">存取 hello Microsoft Graph 的案例： 應用程式</span><span class="sxs-lookup"><span data-stu-id="2282b-169">Scenario: App accessing hello Microsoft Graph</span></span>

<span data-ttu-id="2282b-170">在此案例中，我們逐步 hello 案例 web 應用程式要求存取 toohello Microsoft Graph 時。</span><span class="sxs-lookup"><span data-stu-id="2282b-170">In this scenario, we walk through hello case when a web app requests access toohello Microsoft Graph.</span></span> <span data-ttu-id="2282b-171">hello 條件式存取原則在此情況下無法 tooSharePoint、 Exchange 或指派做為工作負載，透過 hello Microsoft Graph 存取的一些其他服務。</span><span class="sxs-lookup"><span data-stu-id="2282b-171">hello conditional access policy in this case could be assigned tooSharePoint, Exchange, or some other service that is accessed as a workload through hello Microsoft Graph.</span></span>  <span data-ttu-id="2282b-172">在此範例中，假設 Sharepoint Online 上具有條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-172">In this example, let's assume there's a conditional access policy on Sharepoint Online.</span></span>

![應用程式存取 hello Microsoft Graph 流程圖](media/active-directory-conditional-access-developer/app-accessing-microsoft-graph-scenario.png)

<span data-ttu-id="2282b-174">hello 應用程式第一次要求授權 toohello 需要存取沒有條件式存取的下游工作負載的 Microsoft 圖形。</span><span class="sxs-lookup"><span data-stu-id="2282b-174">hello app first requests authorization toohello Microsoft Graph which requires accessing a downstream workload without conditional access.</span></span>  <span data-ttu-id="2282b-175">hello 要求成功，而不叫用任何原則和 hello 應用程式接收 Microsoft Graph 的權杖。</span><span class="sxs-lookup"><span data-stu-id="2282b-175">hello request succeeds without invoking any policy and hello app receives tokens for Microsoft Graph.</span></span>  <span data-ttu-id="2282b-176">此時，hello 應用程式可能使用 hello 存取權杖承載要求中的 hello 端點要求。</span><span class="sxs-lookup"><span data-stu-id="2282b-176">At this point, hello app may use hello access token in a bearer request for hello endpoint requested.</span></span> <span data-ttu-id="2282b-177">現在，hello 應用程式需要 tooaccess Sharepoint Online 的 Microsoft Graph 端點，例如：`https://graph.microsoft.com/v1.0/me/mySite`</span><span class="sxs-lookup"><span data-stu-id="2282b-177">Now, hello app needs tooaccess a Sharepoint Online endpoint of Microsoft Graph, for example: `https://graph.microsoft.com/v1.0/me/mySite`</span></span>

<span data-ttu-id="2282b-178">hello 應用程式已有有效的語彙基元 hello Microsoft Graph，讓它可以執行 hello 新要求，而不發出新的權杖。</span><span class="sxs-lookup"><span data-stu-id="2282b-178">hello app already has a valid token for hello Microsoft Graph, so it can perform hello new request without being issued a new token.</span></span> <span data-ttu-id="2282b-179">此要求會失敗並從 hello 形式 HTTP 403 禁止使用的 Microsoft Graph 發出宣告挑戰```WWW-Authenticate```挑戰。</span><span class="sxs-lookup"><span data-stu-id="2282b-179">This request fails and a claims challenge is issued from Microsoft Graph in hello form of an HTTP 403 Forbidden with a ```WWW-Authenticate``` challenge.</span></span>
<span data-ttu-id="2282b-180">Hello 回應的範例如下：</span><span class="sxs-lookup"><span data-stu-id="2282b-180">Here's an example of hello response:</span></span> 

```
HTTP 403; Forbidden 
error=insufficient_claims
www-authenticate="Bearer realm="", authorization_uri="https://login.windows.net/common/oauth2/authorize", client_id="<GUID>", error=insufficient_claims, claims={"access_token":{"polids":{"essential":true,"values":["<GUID>"]}}}"
```

<span data-ttu-id="2282b-181">hello 宣告挑戰位於 hello```WWW-Authenticate```標頭，它可以是 hello 下一個要求的已剖析的 tooextract hello 宣告參數。</span><span class="sxs-lookup"><span data-stu-id="2282b-181">hello claims challenge is inside hello ```WWW-Authenticate``` header, which can be parsed tooextract hello claims parameter for hello next request.</span></span>  <span data-ttu-id="2282b-182">一旦附加的 toohello 新要求，Azure AD 登入 hello 使用者和 hello 應用程式現在已符合 hello 條件式存取原則時，就會知道 tooevaluate hello 條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-182">Once it's appended toohello new request, Azure AD knows tooevaluate hello conditional access policy when signing in hello user and hello app is now in compliance with hello conditional access policy.</span></span>  <span data-ttu-id="2282b-183">重複 hello 要求 toohello Sharepoint Online 端點就會成功。</span><span class="sxs-lookup"><span data-stu-id="2282b-183">Repeating hello request toohello Sharepoint Online endpoint succeeds.</span></span>

<span data-ttu-id="2282b-184">程式碼範例示範如何 toohandle hello 宣告挑戰，請參閱 toohello [.NET 桌面程式碼範例](https://github.com/Azure-Samples/active-directory-dotnet-native-desktop)ADAL.NET 或 hello[代表的程式碼範例](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca)ADAL.net。</span><span class="sxs-lookup"><span data-stu-id="2282b-184">For code samples that demonstrate how toohandle hello claims challenge, refer toohello [.NET Desktop code sample](https://github.com/Azure-Samples/active-directory-dotnet-native-desktop) for ADAL .NET or hello [On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca) for ADAL .NET.</span></span>

### <a name="scenario-app-performing-hello-on-behalf-of-flow"></a><span data-ttu-id="2282b-185">案例： 應用程式執行 hello 代表的流程</span><span class="sxs-lookup"><span data-stu-id="2282b-185">Scenario: App performing hello on-behalf-of flow</span></span>

<span data-ttu-id="2282b-186">在此案例中，我們逐步解說中的原生應用程式呼叫 web 服務 API 的 hello 案例。</span><span class="sxs-lookup"><span data-stu-id="2282b-186">In this scenario, we walk through hello case in which a native app calls a web service/API.</span></span>  <span data-ttu-id="2282b-187">接著，此服務會執行[hello"代表的 「 資料流程](active-directory-authentication-scenarios.md#application-types-and-scenarios)toocall 下游服務。</span><span class="sxs-lookup"><span data-stu-id="2282b-187">In turn, this service does [hello "on-behalf-of" flow](active-directory-authentication-scenarios.md#application-types-and-scenarios) toocall a downstream service.</span></span>  <span data-ttu-id="2282b-188">在此案例中，我們已經套用我們條件式存取原則 toohello 下游服務 (Web API 2)，會使用原生應用程式，而不是伺服器/精靈應用程式。</span><span class="sxs-lookup"><span data-stu-id="2282b-188">In our case, we've applied our conditional access policy toohello downstream service (Web API 2) and are using a native app rather than a server/daemon app.</span></span> 

![應用程式執行 hello 代表的流程圖](media/active-directory-conditional-access-developer/app-performing-on-behalf-of-scenario.png)

<span data-ttu-id="2282b-190">hello 語彙基元的初始要求 Web API 1 不會提示 hello 的多重要素驗證的使用者，因為 Web API 1 可能不會永遠達到 hello 下游應用程式開發介面。</span><span class="sxs-lookup"><span data-stu-id="2282b-190">hello initial token request for Web API 1 does not prompt hello end-user for multi-factor authentication as Web API 1 may not always hit hello downstream API.</span></span>  <span data-ttu-id="2282b-191">Web API 1 會 toorequest 語彙基元代表的 hello 使用者嘗試對 Web API 2，一旦 hello 要求失敗，因為 hello 使用者不具有登入多重要素驗證。</span><span class="sxs-lookup"><span data-stu-id="2282b-191">Once Web API 1 tries toorequest a token on-behalf-of hello user for Web API 2, hello request fails since hello user has not signed in with multi-factor authentication.</span></span>

<span data-ttu-id="2282b-192">Azure AD 會傳回 HTTP 回應，包含一些有趣的資料：</span><span class="sxs-lookup"><span data-stu-id="2282b-192">Azure AD returns an HTTP response with some interesting data:</span></span> 

> [!NOTE]
> <span data-ttu-id="2282b-193">這個執行個體中很多因素驗證錯誤的描述，但有各種不同的`interaction_required`可能相關 tooconditional 存取。</span><span class="sxs-lookup"><span data-stu-id="2282b-193">In this instance it's a multi-factor authentication error description, but there's a wide range of `interaction_required` possible pertaining tooconditional access.</span></span>  

```
HTTP 400; Bad Request 
error=interaction_required
error_description=AADSTS50076: Due tooa configuration change made by your administrator, or because you moved tooa new location, you must use multi-factor authentication tooaccess '<Web API 2 App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
```

<span data-ttu-id="2282b-194">在我們的 Web API 1，攔截 hello 錯誤`error=interaction_required`，並傳送後 hello`claims`挑戰 toohello 傳統型應用程式。</span><span class="sxs-lookup"><span data-stu-id="2282b-194">In our Web API 1, we catch hello error `error=interaction_required`, and send back hello `claims` challenge toohello desktop app.</span></span>  <span data-ttu-id="2282b-195">此時，hello 桌面應用程式可以進行新`acquireToken()`呼叫，並附加 hello`claims`做為額外的查詢字串參數的挑戰。</span><span class="sxs-lookup"><span data-stu-id="2282b-195">At that point, hello desktop app can make a new `acquireToken()` call and append hello `claims`challenge as an extra query string parameter.</span></span>  <span data-ttu-id="2282b-196">這個新的要求需要 hello 使用者 toodo 多因素驗證，然後傳送這個新的語彙基元後 tooWeb API 1 和完整 hello 代表的流程。</span><span class="sxs-lookup"><span data-stu-id="2282b-196">This new request requires hello user toodo multi-factor authentication and then send this new token back tooWeb API 1 and complete hello on-behalf-of flow.</span></span>

<span data-ttu-id="2282b-197">tootry 出此案例中，請參閱我們[.NET 程式碼範例](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca)。</span><span class="sxs-lookup"><span data-stu-id="2282b-197">tootry out this scenario, see our [.NET code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span></span>  <span data-ttu-id="2282b-198">它會示範如何 toopass hello 宣告挑戰，從 Web API 1 toohello 原生應用程式，並建構 hello 用戶端應用程式內的新要求。</span><span class="sxs-lookup"><span data-stu-id="2282b-198">It demonstrates how toopass hello claims challenge back from Web API 1 toohello native app and construct a new request inside hello client app.</span></span> 

### <a name="scenario-app-accessing-multiple-services"></a><span data-ttu-id="2282b-199">情節：存取多個服務的應用程式</span><span class="sxs-lookup"><span data-stu-id="2282b-199">Scenario: App accessing multiple services</span></span>

<span data-ttu-id="2282b-200">在此案例中，我們逐步 hello 案例 web 應用程式存取兩個服務都有一個具有條件式存取原則指派。</span><span class="sxs-lookup"><span data-stu-id="2282b-200">In this scenario, we walk through hello case in which a web app accesses two services one of which has a conditional access policy assigned.</span></span>  <span data-ttu-id="2282b-201">根據您的應用程式邏輯，可能存在您的應用程式不需要存取 tooboth web 服務的路徑。</span><span class="sxs-lookup"><span data-stu-id="2282b-201">Depending on your app logic, there may exist a path in which your app does not require access tooboth web services.</span></span>  <span data-ttu-id="2282b-202">在此案例中，您可以在其中要求權杖的 hello 順序會扮演重要角色 hello 使用者體驗中。</span><span class="sxs-lookup"><span data-stu-id="2282b-202">In this scenario, hello order in which you request a token plays an important role in hello end-user experience.</span></span>

<span data-ttu-id="2282b-203">假設我們有 A 和 B 的 web 服務，而 web 服務 B 已套用我們的條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-203">Let's assume we have web service A and B and web service B has our conditional access policy applied.</span></span>  <span data-ttu-id="2282b-204">雖然 hello 初始互動式驗證要求需要兩個服務的同意，hello 條件式存取原則不需要在所有情況下。</span><span class="sxs-lookup"><span data-stu-id="2282b-204">While hello initial interactive auth request requires consent for both services, hello conditional access policy is not required in all cases.</span></span>  <span data-ttu-id="2282b-205">如果 hello 應用程式要求 web 服務 B 的語彙基元，然後叫用 hello 原則和 web 服務的後續要求也成功，如下所示。</span><span class="sxs-lookup"><span data-stu-id="2282b-205">If hello app requests a token for web service B, then hello policy is invoked and subsequent requests for web service A also succeeds as follows.</span></span>

![存取多個服務的應用程式流程圖](media/active-directory-conditional-access-developer/app-accessing-multiple-services-scenario.png)

<span data-ttu-id="2282b-207">或者，如果 hello 應用程式一開始要求 web 服務的權杖，hello 使用者不會叫用 hello 條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-207">Alternatively, if hello app initially requests a token for web service A, hello end-user does not invoke hello conditional access policy.</span></span>  <span data-ttu-id="2282b-208">這允許 hello 應用程式開發人員 toocontrol hello 使用者體驗，並不會強制 hello 條件式存取原則 toobe 在所有情況下叫用。</span><span class="sxs-lookup"><span data-stu-id="2282b-208">This allows hello app developer toocontrol hello end-user experience and not force hello conditional access policy toobe invoked in all cases.</span></span> <span data-ttu-id="2282b-209">hello 很難解釋的情況是如果 hello 應用程式接著會要求 web 服務 b 的語彙基元此時，hello 使用者需要 toocomply 與 hello 條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-209">hello tricky case is if hello app subsequently requests a token for web service B. At this point, hello end-user needs toocomply with hello conditional access policy.</span></span>  <span data-ttu-id="2282b-210">當 hello 應用程式嘗試過`acquireToken`，可能會產生下列錯誤 （hello 下列圖表中所述） 的 hello:</span><span class="sxs-lookup"><span data-stu-id="2282b-210">When hello app tries too`acquireToken`, it may generate hello following error (illustrated in hello following diagram):</span></span> 

```
HTTP 400; Bad Request
error=interaction_required
error_description=AADSTS50076: Due tooa configuration change made by your administrator, or because you moved tooa new location, you must use multi-factor authentication tooaccess '<Web API App/Client ID>'.
claims={"access_token":{"polids":{"essential":true,"Values":["<GUID>"]}}}
``` 

![存取多個要求新權杖之服務的應用程式](media/active-directory-conditional-access-developer/app-accessing-multiple-services-new-token.png)

<span data-ttu-id="2282b-212">如果 hello 應用程式使用 hello ADAL 程式庫，失敗 tooacquire hello 權杖永遠重試一次以互動方式。</span><span class="sxs-lookup"><span data-stu-id="2282b-212">If hello app is using hello ADAL library, a failure tooacquire hello token is always retried interactively.</span></span>  <span data-ttu-id="2282b-213">此互動式要求時，hello 使用者有 hello 機會 toocomply hello 條件式存取。</span><span class="sxs-lookup"><span data-stu-id="2282b-213">When this interactive request occurs, hello end-user has hello opportunity toocomply with hello conditional access.</span></span>  <span data-ttu-id="2282b-214">這是 true，除非 hello 要求`AcquireTokenSilentAsync`或`PromptBehavior.Never`hello 應用程式在此情況下需要互動式 tooperform```AcquireToken```要求 toogive hello 結束使用 hello 機會 toocomply hello 原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-214">This is true unless hello request is a `AcquireTokenSilentAsync` or `PromptBehavior.Never` in which case hello app needs tooperform an interactive ```AcquireToken``` request toogive hello end use hello opportunity toocomply with hello policy.</span></span> 

### <a name="scenario-single-page-app-spa-using-adaljs"></a><span data-ttu-id="2282b-215">情節：使用 ADAL.js 的單一頁面應用程式 (SPA)</span><span class="sxs-lookup"><span data-stu-id="2282b-215">Scenario: Single Page App (SPA) using ADAL.js</span></span>

<span data-ttu-id="2282b-216">在此案例中，我們逐步解說 hello 案例我們有單一頁面應用程式 (SPA) 時，使用 ADAL.js toocall 條件式存取受保護的 web API。</span><span class="sxs-lookup"><span data-stu-id="2282b-216">In this scenario, we walk through hello case when we have a single page app (SPA), using ADAL.js toocall a conditional access protected web API.</span></span>  <span data-ttu-id="2282b-217">這是簡單的架構，但有一些需要 toobe 開發周圍條件式存取時列入考量的細節。</span><span class="sxs-lookup"><span data-stu-id="2282b-217">This is a simple architecture but has some nuances that need toobe taken into account when developing around conditional access.</span></span>

<span data-ttu-id="2282b-218">在 ADAL.js 中，有幾個函式可取得權杖：`login()`、`acquireToken(...)`、`acquireTokenPopup(…)` 和 `acquireTokenRedirect(…)`。</span><span class="sxs-lookup"><span data-stu-id="2282b-218">In ADAL.js, there are a few functions that obtain tokens: `login()`, `acquireToken(...)`, `acquireTokenPopup(…)`, and `acquireTokenRedirect(…)`.</span></span> 

* <span data-ttu-id="2282b-219">`login()` 會透過互動式登入要求取得 ID 權杖，但不會取得任何服務的存取權杖 (包括受條件式存取保護的 web API)。</span><span class="sxs-lookup"><span data-stu-id="2282b-219">`login()` obtains an ID token through an interactive sign-in request but does not obtain access tokens for any service (including a conditional access protected web API).</span></span>  
* <span data-ttu-id="2282b-220">`acquireToken(…)`可以是使用的 toosilently 取得存取權杖，這表示它不在任何情況下顯示 UI。</span><span class="sxs-lookup"><span data-stu-id="2282b-220">`acquireToken(…)` can then be used toosilently obtain an access token meaning it does not show UI in any circumstance.</span></span>  
* <span data-ttu-id="2282b-221">`acquireTokenPopup(…)`和`acquireTokenRedirect(…)`會同時使用的 toointeractively 要求權杖的資源，這表示它們永遠會顯示登入 UI。</span><span class="sxs-lookup"><span data-stu-id="2282b-221">`acquireTokenPopup(…)` and `acquireTokenRedirect(…)` are both used toointeractively request a token for a resource meaning they always show sign-in UI.</span></span>

<span data-ttu-id="2282b-222">當應用程式需要存取語彙基元 toocall Web API 時，它會試著`acquireToken(…)`。</span><span class="sxs-lookup"><span data-stu-id="2282b-222">When an app needs an access token toocall a Web API, it attempts an `acquireToken(…)`.</span></span>  <span data-ttu-id="2282b-223">如果 hello 語彙基元的工作階段已過期，或者我們需要 toocomply 與條件式存取原則，然後 hello *acquireToken*函式會失敗，並 hello 應用程式會使用`acquireTokenPopup()`或`acquireTokenRedirect()`。</span><span class="sxs-lookup"><span data-stu-id="2282b-223">If hello token session is expired or we need toocomply with a conditional access policy, then hello *acquireToken* function fails and hello app uses `acquireTokenPopup()` or `acquireTokenRedirect()`.</span></span>

![使用 ADAL 的單一頁面應用程式流程圖](media/active-directory-conditional-access-developer/spa-using-adal-scenario.png)

<span data-ttu-id="2282b-225">我們會使用條件式存取情節來步解說範例。</span><span class="sxs-lookup"><span data-stu-id="2282b-225">Let's walk through an example with our conditional access scenario.</span></span>  <span data-ttu-id="2282b-226">hello 使用者只要登陸 hello 站台，並不會有一個工作階段。</span><span class="sxs-lookup"><span data-stu-id="2282b-226">hello end-user just landed on hello site and doesn’t have a session.</span></span>  <span data-ttu-id="2282b-227">我們執行 `login()` 呼叫時，無需進行多重要素驗證即可取得 ID 權杖。</span><span class="sxs-lookup"><span data-stu-id="2282b-227">We perform a `login()` call, get an ID token without multi-factor authentication.</span></span>  <span data-ttu-id="2282b-228">然後 hello 使用者點擊需要 hello 應用程式 toorequest 資料從 web API 的按鈕。</span><span class="sxs-lookup"><span data-stu-id="2282b-228">Then hello user hits a button that requires hello app toorequest data from a web API.</span></span>  <span data-ttu-id="2282b-229">hello 應用程式會嘗試 toodo`acquireToken()`卻會呼叫失敗，因為未執行多重要素驗證尚未 hello 使用者，而且需要 toocomply 與 hello 條件式存取原則。</span><span class="sxs-lookup"><span data-stu-id="2282b-229">hello app tries toodo an `acquireToken()` call but fails since hello user has not performed multi-factor authentication yet and needs toocomply with hello conditional access policy.</span></span>

<span data-ttu-id="2282b-230">Azure AD 會傳送下列 HTTP 回應的回復 hello:</span><span class="sxs-lookup"><span data-stu-id="2282b-230">Azure AD sends back hello following HTTP response:</span></span> 

```
HTTP 400; Bad Request 
error=interaction_required
error_description=AADSTS50076: Due tooa configuration change made by your administrator, or because you moved tooa new location, you must use multi-factor authentication tooaccess '<Web API App/Client ID>'.
```

<span data-ttu-id="2282b-231">我們的應用程式需要 toocatch hello `error=interaction_required`。</span><span class="sxs-lookup"><span data-stu-id="2282b-231">Our app needs toocatch hello `error=interaction_required`.</span></span>  <span data-ttu-id="2282b-232">hello 應用程式可以接著使用`acquireTokenPopup()`或`acquireTokenRedirect()`在 hello 相同資源。</span><span class="sxs-lookup"><span data-stu-id="2282b-232">hello application can then use either `acquireTokenPopup()` or `acquireTokenRedirect()` on hello same resource.</span></span>  <span data-ttu-id="2282b-233">hello 使用者是強制的 toodo 多重要素驗證。</span><span class="sxs-lookup"><span data-stu-id="2282b-233">hello user is forced toodo a multi-factor authentication.</span></span> <span data-ttu-id="2282b-234">Hello 應用程式 hello 使用者完成 hello 多重要素驗證之後，會發出從頭 hello 的存取權杖要求的資源。</span><span class="sxs-lookup"><span data-stu-id="2282b-234">After hello user completes hello multi-factor authentication, hello app is issued a fresh access token for hello requested resource.</span></span>

<span data-ttu-id="2282b-235">tootry 出此案例中，請參閱我們[JS SPA 代表的程式碼範例](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca)。</span><span class="sxs-lookup"><span data-stu-id="2282b-235">tootry out this scenario, see our [JS SPA On-behalf-of code sample](https://github.com/Azure-Samples/active-directory-dotnet-webapi-onbehalfof-ca).</span></span>  <span data-ttu-id="2282b-236">Hello 條件式存取原則和 web 應用程式開發介面，您先前註冊與 JS SPA toodemonstrate 這種情況下，會使用此程式碼範例。</span><span class="sxs-lookup"><span data-stu-id="2282b-236">This code sample uses hello conditional access policy and web API you registered earlier with a JS SPA toodemonstrate this scenario.</span></span> <span data-ttu-id="2282b-237">它會顯示如何 tooproperly 控制代碼 hello 宣告挑戰，並取得存取權杖可用於您的 Web API。</span><span class="sxs-lookup"><span data-stu-id="2282b-237">It shows how tooproperly handle hello claims challenge and get an access token that can be used for your Web API.</span></span> <span data-ttu-id="2282b-238">一般或者，簽出 hello [Angular.js 程式碼範例](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp)如角度 SPA 的指引</span><span class="sxs-lookup"><span data-stu-id="2282b-238">Alternatively, checkout hello general [Angular.js code sample](https://github.com/Azure-Samples/active-directory-angularjs-singlepageapp) for guidance on an Angular SPA</span></span>


## <a name="see-also"></a><span data-ttu-id="2282b-239">另請參閱</span><span class="sxs-lookup"><span data-stu-id="2282b-239">See also</span></span>

* <span data-ttu-id="2282b-240">toolearn 進一步了解 hello 功能，請參閱[在 Azure AD 中的條件式存取](../active-directory-conditional-access.md)。</span><span class="sxs-lookup"><span data-stu-id="2282b-240">toolearn more about hello capabilities, see [Conditional Access in Azure AD](../active-directory-conditional-access.md).</span></span>
* <span data-ttu-id="2282b-241">如需更多的 Azure AD 程式碼範例，請參閱[程式碼範例的 Github 存放庫](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory)。</span><span class="sxs-lookup"><span data-stu-id="2282b-241">For more Azure AD code samples, see [Github Repo of Code Samples](https://github.com/azure-samples?utf8=%E2%9C%93&q=active-directory).</span></span> 
* <span data-ttu-id="2282b-242">如需 hello ADAL SDK 及存取 hello 參考文件的詳細資訊，請參閱[文件庫指南](active-directory-authentication-libraries.md)。</span><span class="sxs-lookup"><span data-stu-id="2282b-242">For more info on hello ADAL SDK's and access hello reference documentation, see [library guide](active-directory-authentication-libraries.md).</span></span>
* <span data-ttu-id="2282b-243">toolearn 進一步了解多租用戶的案例中，請參閱[如何在使用者使用 hello 多租用戶模式 toosign](active-directory-devhowto-multi-tenant-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="2282b-243">toolearn more about multi-tenant scenarios, see [How toosign in users using hello multi-tenant pattern](active-directory-devhowto-multi-tenant-overview.md).</span></span>
