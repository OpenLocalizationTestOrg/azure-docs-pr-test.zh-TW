---
title: "Azure AD 的驗證案例 | Microsoft Docs"
description: "Azure Active Directory (AAD) 五個最常見驗證案例的概觀"
services: active-directory
documentationcenter: dev-center-name
author: skwan
manager: mbaldwin
editor: 
ms.assetid: 0c84e7d0-16aa-4897-82f2-f53c6c990fd9
ms.service: active-directory
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 04/27/2017
ms.author: skwan
ms.custom: aaddev
ms.openlocfilehash: 2f9410bdaa037f1839cf7c12c3532b51be669ed5
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/18/2017
---
# <a name="authentication-scenarios-for-azure-ad"></a><span data-ttu-id="6adb3-103">Azure AD 的驗證案例</span><span class="sxs-lookup"><span data-stu-id="6adb3-103">Authentication Scenarios for Azure AD</span></span>
<span data-ttu-id="6adb3-104">Azure Active Directory (Azure AD) 提供身分識別做為服務來簡化開發人員的驗證工作，支援業界標準通訊協定，例如 OAuth 2.0 和 OpenID Connect，以及適用於不同平台的開放原始碼程式庫，協助您開始快速撰寫程式碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-104">Azure Active Directory (Azure AD) simplifies authentication for developers by providing identity as a service, with support for industry-standard protocols such as OAuth 2.0 and OpenID Connect, as well as open source libraries for different platforms to help you start coding quickly.</span></span> <span data-ttu-id="6adb3-105">本文件將協助您了解 Azure AD 支援的各種案例，並示範如何開始著手。</span><span class="sxs-lookup"><span data-stu-id="6adb3-105">This document will help you understand the various scenarios Azure AD supports and will show you how to get started.</span></span> <span data-ttu-id="6adb3-106">分成下列各節：</span><span class="sxs-lookup"><span data-stu-id="6adb3-106">It’s divided into the following sections:</span></span>

* [<span data-ttu-id="6adb3-107">Azure AD 中的驗證基本概念</span><span class="sxs-lookup"><span data-stu-id="6adb3-107">Basics of Authentication in Azure AD</span></span>](#basics-of-authentication-in-azure-ad)
* [<span data-ttu-id="6adb3-108">Azure AD 安全性權杖中的宣告</span><span class="sxs-lookup"><span data-stu-id="6adb3-108">Claims in Azure AD Security Tokens</span></span>](#claims-in-azure-ad-security-tokens)
* [<span data-ttu-id="6adb3-109">在 Azure AD 中登錄應用程式的基本概念</span><span class="sxs-lookup"><span data-stu-id="6adb3-109">Basics of Registering an Application in Azure AD</span></span>](#basics-of-registering-an-application-in-azure-ad)
* [<span data-ttu-id="6adb3-110">應用程式類型和案例</span><span class="sxs-lookup"><span data-stu-id="6adb3-110">Application Types and Scenarios</span></span>](#application-types-and-scenarios)
  
  * [<span data-ttu-id="6adb3-111">Web 瀏覽器到 Web 應用程式</span><span class="sxs-lookup"><span data-stu-id="6adb3-111">Web Browser to Web Application</span></span>](#web-browser-to-web-application)
  * [<span data-ttu-id="6adb3-112">單一頁面應用程式 (SPA)</span><span class="sxs-lookup"><span data-stu-id="6adb3-112">Single Page Application (SPA)</span></span>](#single-page-application-spa)
  * [<span data-ttu-id="6adb3-113">原生應用程式到 Web API</span><span class="sxs-lookup"><span data-stu-id="6adb3-113">Native Application to Web API</span></span>](#native-application-to-web-api)
  * [<span data-ttu-id="6adb3-114">Web 應用程式到 Web API</span><span class="sxs-lookup"><span data-stu-id="6adb3-114">Web Application to Web API</span></span>](#web-application-to-web-api)
  * [<span data-ttu-id="6adb3-115">精靈或伺服器應用程式到 Web API</span><span class="sxs-lookup"><span data-stu-id="6adb3-115">Daemon or Server Application to Web API</span></span>](#daemon-or-server-application-to-web-api)

## <a name="basics-of-authentication-in-azure-ad"></a><span data-ttu-id="6adb3-116">Azure AD 中的驗證基本概念</span><span class="sxs-lookup"><span data-stu-id="6adb3-116">Basics of Authentication in Azure AD</span></span>
<span data-ttu-id="6adb3-117">如果您不熟悉 Azure AD 中的驗證基本概念，請閱讀本節。</span><span class="sxs-lookup"><span data-stu-id="6adb3-117">If you are unfamiliar with basic concepts of authentication in Azure AD, read this section.</span></span> <span data-ttu-id="6adb3-118">否則，您可以往下跳到 [應用程式類型和案例](#application-types-and-scenarios)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-118">Otherwise, you may want to skip down to [Application Types and Scenarios](#application-types-and-scenarios).</span></span>

<span data-ttu-id="6adb3-119">我們來看一下需要身分識別的最基本案例：Web 瀏覽器使用者需要向 Web 應用程式驗證。</span><span class="sxs-lookup"><span data-stu-id="6adb3-119">Let’s consider the most basic scenario where identity is required: a user in a web browser needs to authenticate to a web application.</span></span> <span data-ttu-id="6adb3-120">此案例在 [Web 瀏覽器到 Web 應用程式](#web-browser-to-web-application) 一節中有更詳細的描述，但提供很好的起點來說明 Azure AD 的功能，並從概念上說明案例的運作方式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-120">This scenario is described in greater detail in the [Web Browser to Web Application](#web-browser-to-web-application) section, but it’s a useful starting point to illustrate the capabilities of Azure AD and conceptualize how the scenario works.</span></span> <span data-ttu-id="6adb3-121">請針對此案例細想下圖：</span><span class="sxs-lookup"><span data-stu-id="6adb3-121">Consider the following diagram for this scenario:</span></span>

![登入 Web 應用程式概觀](./media/active-directory-authentication-scenarios/basics_of_auth_in_aad.png)

<span data-ttu-id="6adb3-123">根據上圖，您對其中各種元件必須有所了解：</span><span class="sxs-lookup"><span data-stu-id="6adb3-123">With the diagram above in mind, here’s what you need to know about its various components:</span></span>

* <span data-ttu-id="6adb3-124">Azure AD 是身分識別提供者，負責驗證組織目錄中的使用者和應用程式的身分識別，最後在成功驗證那些使用者和應用程式時發行安全性權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-124">Azure AD is the identity provider, responsible for verifying the identity of users and applications that exist in an organization’s directory, and ultimately issuing security tokens upon successful authentication of those users and applications.</span></span>
* <span data-ttu-id="6adb3-125">想要將驗證外包給 Azure AD 的應用程式必須在 Azure AD 中註冊，Azure AD 會在目錄中註冊並唯一識別此應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-125">An application that wants to outsource authentication to Azure AD must be registered in Azure AD, which registers and uniquely identifies the app in the directory.</span></span>
* <span data-ttu-id="6adb3-126">開發人員可以使用開放原始碼 Azure AD 驗證程式庫，為您處理通訊協定的細節，以輕鬆完成驗證。</span><span class="sxs-lookup"><span data-stu-id="6adb3-126">Developers can use the open source Azure AD authentication libraries to make authentication easy by handling the protocol details for you.</span></span> <span data-ttu-id="6adb3-127">如需詳細資訊，請參閱 [Azure Active Directory 驗證程式庫](active-directory-authentication-libraries.md) 。</span><span class="sxs-lookup"><span data-stu-id="6adb3-127">See [Azure Active Directory Authentication Libraries](active-directory-authentication-libraries.md) for more information.</span></span>

<span data-ttu-id="6adb3-128">• 使用者通過驗證之後，應用程式必須驗證使用者的安全性權杖，以確定相關各方的驗證成功。</span><span class="sxs-lookup"><span data-stu-id="6adb3-128">• Once a user has been authenticated, the application must validate the user’s security token to ensure that authentication was successful for the intended parties.</span></span> <span data-ttu-id="6adb3-129">開發人員可以使用提供的驗證程式庫來驗證來自 Azure AD 的任何權杖，包括 JSON Web Token (JWT) 或 SAML 2.0。</span><span class="sxs-lookup"><span data-stu-id="6adb3-129">Developers can use the provided authentication libraries to handle validation of any token from Azure AD, including JSON Web Tokens (JWT) or SAML 2.0.</span></span> <span data-ttu-id="6adb3-130">如果您想要手動執行驗證，請參閱 [JWT 權杖處理常式](https://msdn.microsoft.com/library/dn205065.aspx) 文件。</span><span class="sxs-lookup"><span data-stu-id="6adb3-130">If you want to perform validation manually, see the [JWT Token Handler](https://msdn.microsoft.com/library/dn205065.aspx) documentation.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="6adb3-131">Azure AD 使用公開金鑰密碼編譯來簽署權杖並驗證它們有效。</span><span class="sxs-lookup"><span data-stu-id="6adb3-131">Azure AD uses public key cryptography to sign tokens and verify that they are valid.</span></span> <span data-ttu-id="6adb3-132">如需有關應用程式中必要的邏輯以確保永遠以最新金鑰更新的相關資訊，請參閱 [Azure AD 中簽署金鑰變換的相關重要資訊](active-directory-signing-key-rollover.md) 。</span><span class="sxs-lookup"><span data-stu-id="6adb3-132">See [Important Information About Signing Key Rollover in Azure AD](active-directory-signing-key-rollover.md) for more information on the necessary logic you must have in your application to ensure it’s always updated with the latest keys.</span></span>
> 
> 

<span data-ttu-id="6adb3-133">• 驗證程序的要求和回應流程由使用的驗證通訊協定決定，例如 OAuth 2.0、OpenID Connect，WS-同盟或 SAML 2.0。</span><span class="sxs-lookup"><span data-stu-id="6adb3-133">• The flow of requests and responses for the authentication process is determined by the authentication protocol that was used, such as OAuth 2.0, OpenID Connect, WS-Federation, or SAML 2.0.</span></span> <span data-ttu-id="6adb3-134">[Azure Active Directory 驗證通訊協定](active-directory-authentication-protocols.md) 主題和下列各節中更詳細地討論這些通訊協定。</span><span class="sxs-lookup"><span data-stu-id="6adb3-134">These protocols are discussed in more detail in the [Azure Active Directory Authentication Protocols](active-directory-authentication-protocols.md) topic and in the sections below.</span></span>

> [!NOTE]
> <span data-ttu-id="6adb3-135">Azure AD 支援 OAuth 2.0 和 OpenID Connect 標準，這些標準廣泛運用持有者權杖，包括以 JWT 表示的持有者權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-135">Azure AD supports the OAuth 2.0 and OpenID Connect standards that make extensive use of bearer tokens, including bearer tokens represented as JWTs.</span></span> <span data-ttu-id="6adb3-136">持有人權杖是輕巧型的安全性權杖，授權「持有者」存取受保護的資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-136">A bearer token is a lightweight security token that grants the “bearer” access to a protected resource.</span></span> <span data-ttu-id="6adb3-137">從這個意義上說，「持有者」是可出示權杖的任何一方。</span><span class="sxs-lookup"><span data-stu-id="6adb3-137">In this sense, the “bearer” is any party that can present the token.</span></span> <span data-ttu-id="6adb3-138">雖然某一方必須先向 Azure AD 驗證以收到持有人權杖，但如果傳輸和儲存時未採取必要的步驟來保護權杖，它可能會被非預期的一方攔截和使用。</span><span class="sxs-lookup"><span data-stu-id="6adb3-138">Though a party must first authenticate with Azure AD to receive the bearer token, if the required steps are not taken to secure the token in transmission and storage, it can be intercepted and used by an unintended party.</span></span> <span data-ttu-id="6adb3-139">雖然某些安全性權杖都有內建的機制，可防止未經授權的人士使用權杖，但持有者權杖沒有這項機制，而必須以安全通道來傳輸，例如傳輸層安全性 (HTTPS)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-139">While some security tokens have a built-in mechanism for preventing unauthorized parties from using them, bearer tokens do not have this mechanism and must be transported in a secure channel such as transport layer security (HTTPS).</span></span> <span data-ttu-id="6adb3-140">如果持有人權杖以純文字傳輸，惡意人士可能使用攔截式攻擊來取得權杖，然後未經授權存取受保護的資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-140">If a bearer token is transmitted in the clear, a man-in the middle attack can be used by a malicious party to acquire the token and use it for an unauthorized access to a protected resource.</span></span> <span data-ttu-id="6adb3-141">儲存或快取持有者權杖供以後使用時，也適用相同的安全性原則。</span><span class="sxs-lookup"><span data-stu-id="6adb3-141">The same security principles apply when storing or caching bearer tokens for later use.</span></span> <span data-ttu-id="6adb3-142">務必確定您的應用程式以安全的方式傳輸和儲存持有者權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-142">Always ensure that your application transmits and stores bearer tokens in a secure manner.</span></span> <span data-ttu-id="6adb3-143">關於持有者權杖的其他安全性考量，請參閱 [RFC 6750 第 5 節](http://tools.ietf.org/html/rfc6750)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-143">For more security considerations on bearer tokens, see [RFC 6750 Section 5](http://tools.ietf.org/html/rfc6750).</span></span>
> 
> 

<span data-ttu-id="6adb3-144">既然您已有基本概念的概觀，請閱讀下列各節，了解 Azure AD 中的佈建運作方式，以及 Azure AD 支援的常見案例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-144">Now that you have an overview of the basics, read the sections below to understand how provisioning works in Azure AD and the common scenarios Azure AD supports.</span></span>

## <a name="claims-in-azure-ad-security-tokens"></a><span data-ttu-id="6adb3-145">Azure AD 安全性權杖中的宣告</span><span class="sxs-lookup"><span data-stu-id="6adb3-145">Claims in Azure AD Security Tokens</span></span>
<span data-ttu-id="6adb3-146">Azure AD 所簽發的安全性權杖包含宣告，或已驗證之主體的相關資訊的判斷提示。</span><span class="sxs-lookup"><span data-stu-id="6adb3-146">Security tokens issued by Azure AD contain claims, or assertions of information about the subject that has been authenticated.</span></span> <span data-ttu-id="6adb3-147">這些宣告可以供應用程式用於執行各種工作。</span><span class="sxs-lookup"><span data-stu-id="6adb3-147">These claims can be used by the application for various tasks.</span></span> <span data-ttu-id="6adb3-148">比方說，它們可以用來驗證權杖、識別主體的目錄租用戶、顯示使用者資訊、判斷主體的授權等。</span><span class="sxs-lookup"><span data-stu-id="6adb3-148">For example, they can be used to validate the token, identify the subject's directory tenant, display user information, determine the subject's authorization, and so on.</span></span> <span data-ttu-id="6adb3-149">任何給定的安全性權杖中的宣告取決於權杖類型、用來驗證使用者的認證類型，以及應用程式組態。</span><span class="sxs-lookup"><span data-stu-id="6adb3-149">The claims present in any given security token are dependent upon the type of token, the type of credential used to authenticate the user, and the application configuration.</span></span> <span data-ttu-id="6adb3-150">下表提供由 Azure AD 發出的每一種宣告的簡短描述。</span><span class="sxs-lookup"><span data-stu-id="6adb3-150">A brief description of each type of claim emitted by Azure AD is provided in the table below.</span></span> <span data-ttu-id="6adb3-151">如需詳細資訊，請參閱 [支援的權杖和宣告類型](active-directory-token-and-claims.md)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-151">For more information, refer to [Supported Token and Claim Types](active-directory-token-and-claims.md).</span></span>

| <span data-ttu-id="6adb3-152">宣告</span><span class="sxs-lookup"><span data-stu-id="6adb3-152">Claim</span></span> | <span data-ttu-id="6adb3-153">說明</span><span class="sxs-lookup"><span data-stu-id="6adb3-153">Description</span></span> |
| --- | --- |
| <span data-ttu-id="6adb3-154">應用程式識別碼</span><span class="sxs-lookup"><span data-stu-id="6adb3-154">Application ID</span></span> |<span data-ttu-id="6adb3-155">識別使用權杖的應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-155">Identifies the application that is using the token.</span></span> |
| <span data-ttu-id="6adb3-156">觀眾</span><span class="sxs-lookup"><span data-stu-id="6adb3-156">Audience</span></span> |<span data-ttu-id="6adb3-157">識別權杖針對的收件者資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-157">Identifies the recipient resource the token is intended for.</span></span> |
| <span data-ttu-id="6adb3-158">應用程式驗證內容類別參考</span><span class="sxs-lookup"><span data-stu-id="6adb3-158">Application Authentication Context Class Reference</span></span> |<span data-ttu-id="6adb3-159">指出如何驗證用戶端 (公用用戶端與機密用戶端的比較)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-159">Indicates how the client was authenticated (public client vs. confidential client).</span></span> |
| <span data-ttu-id="6adb3-160">驗證時刻</span><span class="sxs-lookup"><span data-stu-id="6adb3-160">Authentication Instant</span></span> |<span data-ttu-id="6adb3-161">記錄驗證發生的日期和時間。</span><span class="sxs-lookup"><span data-stu-id="6adb3-161">Records the date and time when the authentication occurred.</span></span> |
| <span data-ttu-id="6adb3-162">驗證方法</span><span class="sxs-lookup"><span data-stu-id="6adb3-162">Authentication Method</span></span> |<span data-ttu-id="6adb3-163">指出如何驗證權杖的主體 (密碼、憑證等)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-163">Indicates how the subject of the token was authenticated (password, certificate, etc.).</span></span> |
| <span data-ttu-id="6adb3-164">名字</span><span class="sxs-lookup"><span data-stu-id="6adb3-164">First Name</span></span> |<span data-ttu-id="6adb3-165">提供 Azure AD 中設定的使用者名字。</span><span class="sxs-lookup"><span data-stu-id="6adb3-165">Provides the given name of the user as set in Azure AD.</span></span> |
| <span data-ttu-id="6adb3-166">群組</span><span class="sxs-lookup"><span data-stu-id="6adb3-166">Groups</span></span> |<span data-ttu-id="6adb3-167">包含使用者所屬的 Azure AD 群組的物件識別碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-167">Contains object Ids of Azure AD groups the user is a member of.</span></span> |
| <span data-ttu-id="6adb3-168">身分識別提供者</span><span class="sxs-lookup"><span data-stu-id="6adb3-168">Identity Provider</span></span> |<span data-ttu-id="6adb3-169">記錄驗證權杖主體的身分識別提供者。</span><span class="sxs-lookup"><span data-stu-id="6adb3-169">Records the identity provider that authenticated the subject of the token.</span></span> |
| <span data-ttu-id="6adb3-170">發出時間</span><span class="sxs-lookup"><span data-stu-id="6adb3-170">Issued At</span></span> |<span data-ttu-id="6adb3-171">記錄核發權杖的時間，通常用於權杖有效期限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-171">Records the time at which the token was issued, often used for token freshness.</span></span> |
| <span data-ttu-id="6adb3-172">簽發者</span><span class="sxs-lookup"><span data-stu-id="6adb3-172">Issuer</span></span> |<span data-ttu-id="6adb3-173">識別發出權杖的 STS，以及 Azure AD 租用戶。</span><span class="sxs-lookup"><span data-stu-id="6adb3-173">Identifies the STS that emitted the token as well as the Azure AD tenant.</span></span> |
| <span data-ttu-id="6adb3-174">姓氏</span><span class="sxs-lookup"><span data-stu-id="6adb3-174">Last Name</span></span> |<span data-ttu-id="6adb3-175">提供 Azure AD 中設定的使用者姓氏。</span><span class="sxs-lookup"><span data-stu-id="6adb3-175">Provides the surname of the user as set in Azure AD.</span></span> |
| <span data-ttu-id="6adb3-176">名稱</span><span class="sxs-lookup"><span data-stu-id="6adb3-176">Name</span></span> |<span data-ttu-id="6adb3-177">提供人類看得懂的值，用以識別權杖的主體。</span><span class="sxs-lookup"><span data-stu-id="6adb3-177">Provides a human readable value that identifies the subject of the token.</span></span> |
| <span data-ttu-id="6adb3-178">物件識別碼</span><span class="sxs-lookup"><span data-stu-id="6adb3-178">Object Id</span></span> |<span data-ttu-id="6adb3-179">包含主體在 Azure AD 中不可變的唯一識別碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-179">Contains an immutable, unique identifier of the subject in Azure AD.</span></span> |
| <span data-ttu-id="6adb3-180">角色</span><span class="sxs-lookup"><span data-stu-id="6adb3-180">Roles</span></span> |<span data-ttu-id="6adb3-181">包含已授與使用者的 Azure AD 應用程式角色的易記名稱。</span><span class="sxs-lookup"><span data-stu-id="6adb3-181">Contains friendly names of Azure AD Application Roles that the user has been granted.</span></span> |
| <span data-ttu-id="6adb3-182">Scope</span><span class="sxs-lookup"><span data-stu-id="6adb3-182">Scope</span></span> |<span data-ttu-id="6adb3-183">指出授與用戶端應用程式的權限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-183">Indicates the permissions granted to the client application.</span></span> |
| <span data-ttu-id="6adb3-184">主旨</span><span class="sxs-lookup"><span data-stu-id="6adb3-184">Subject</span></span> |<span data-ttu-id="6adb3-185">指出權杖判斷提示相關資訊的主體。</span><span class="sxs-lookup"><span data-stu-id="6adb3-185">Indicates the principal about which the token asserts information.</span></span> |
| <span data-ttu-id="6adb3-186">租用戶識別碼</span><span class="sxs-lookup"><span data-stu-id="6adb3-186">Tenant Id</span></span> |<span data-ttu-id="6adb3-187">包含發出權杖的目錄租用戶的不變唯一識別碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-187">Contains an immutable, unique identifier of the directory tenant that issued the token.</span></span> |
| <span data-ttu-id="6adb3-188">權杖存留期</span><span class="sxs-lookup"><span data-stu-id="6adb3-188">Token Lifetime</span></span> |<span data-ttu-id="6adb3-189">定義權杖有效的時間間隔。</span><span class="sxs-lookup"><span data-stu-id="6adb3-189">Defines the time interval within which a token is valid.</span></span> |
| <span data-ttu-id="6adb3-190">使用者主體名稱</span><span class="sxs-lookup"><span data-stu-id="6adb3-190">User Principal Name</span></span> |<span data-ttu-id="6adb3-191">包含主體的使用者主體名稱。</span><span class="sxs-lookup"><span data-stu-id="6adb3-191">Contains the user principal name of the subject.</span></span> |
| <span data-ttu-id="6adb3-192">版本</span><span class="sxs-lookup"><span data-stu-id="6adb3-192">Version</span></span> |<span data-ttu-id="6adb3-193">包含權杖的版本號碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-193">Contains the version number of the token.</span></span> |

## <a name="basics-of-registering-an-application-in-azure-ad"></a><span data-ttu-id="6adb3-194">在 Azure AD 中登錄應用程式的基本概念</span><span class="sxs-lookup"><span data-stu-id="6adb3-194">Basics of Registering an Application in Azure AD</span></span>
<span data-ttu-id="6adb3-195">將驗證外包給 Azure AD 的任何應用程式必須在目錄中註冊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-195">Any application that outsources authentication to Azure AD must be registered in a directory.</span></span> <span data-ttu-id="6adb3-196">此步驟涉及向 Azure AD 說明您的應用程式，包括它所在的 URL、驗證之後用來傳送回覆的 URL、用來識別應用程式的 URI 等。</span><span class="sxs-lookup"><span data-stu-id="6adb3-196">This step involves telling Azure AD about your application, including the URL where it’s located, the URL to send replies after authentication, the URI to identify your application, and more.</span></span> <span data-ttu-id="6adb3-197">需要這項資訊有幾個主要理由：</span><span class="sxs-lookup"><span data-stu-id="6adb3-197">This information is required for a few key reasons:</span></span>

* <span data-ttu-id="6adb3-198">Azure AD 處理登入或交換權杖時，需要座標才能與應用程式通訊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-198">Azure AD needs coordinates to communicate with the application when handling sign-on or exchanging tokens.</span></span> <span data-ttu-id="6adb3-199">其中包括：</span><span class="sxs-lookup"><span data-stu-id="6adb3-199">These include the following:</span></span>
  
  * <span data-ttu-id="6adb3-200">應用程式識別碼 URI：應用程式的識別碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-200">Application ID URI: The identifier for an application.</span></span> <span data-ttu-id="6adb3-201">這個值會在驗證期間傳送至 Azure AD，以指出呼叫端想要哪一個應用程式的權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-201">This value is sent to Azure AD during authentication to indicate which application the caller wants a token for.</span></span> <span data-ttu-id="6adb3-202">此外，這個值包含在權杖中，應用程式由此可知它就是預定的目標。</span><span class="sxs-lookup"><span data-stu-id="6adb3-202">Additionally, this value is included in the token so that the application knows it was the intended target.</span></span>
  * <span data-ttu-id="6adb3-203">回覆 URL 和重新導向 URI：在 Web API 或 Web 應用程式中，回覆 URL 是 Azure AD 傳送驗證回應的目標位置，包括驗證成功時的權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-203">Reply URL and Redirect URI: In the case of a web API or web application, the Reply URL is the location to which Azure AD will send the authentication response, including a token if authentication was successful.</span></span> <span data-ttu-id="6adb3-204">在原生應用程式中，重新導向 URI 是 Azure AD 在 OAuth 2.0 要求中將使用者代理程式重新導向的唯一識別碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-204">In the case of a native application, the Redirect URI is a unique identifier to which Azure AD will redirect the user-agent in an OAuth 2.0 request.</span></span>
  * <span data-ttu-id="6adb3-205">應用程式識別碼：註冊應用程式時由 Azure AD 產生的應用程式識別碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-205">Application ID: The ID for an application, which is generated by Azure AD when the application is registered.</span></span> <span data-ttu-id="6adb3-206">當要求授權碼或權杖時，應用程式識別碼和金鑰會在驗證期間傳送至 Azure AD。</span><span class="sxs-lookup"><span data-stu-id="6adb3-206">When requesting an authorization code or token, the Application ID and key are sent to Azure AD during authentication.</span></span>
  * <span data-ttu-id="6adb3-207">金鑰：向 Azure AD 驗證來呼叫 Web API 時，隨應用程式識別碼一起傳送的金鑰。</span><span class="sxs-lookup"><span data-stu-id="6adb3-207">Key: The key that is sent along with a Application ID when authenticating to Azure AD to call a web API.</span></span>
* <span data-ttu-id="6adb3-208">Azure AD 需要確定應用程式具有存取目錄資料、您組織中其他應用程式等等的必要權限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-208">Azure AD needs to ensure the application has the required permissions to access your directory data, other applications in your organization, and so on</span></span>

<span data-ttu-id="6adb3-209">當您了解可以開發及與 Azure AD 整合的應用程式有兩種類別時，佈建就變得更清楚：</span><span class="sxs-lookup"><span data-stu-id="6adb3-209">Provisioning becomes clearer when you understand that there are two categories of applications that can be developed and integrated with Azure AD:</span></span>

* <span data-ttu-id="6adb3-210">單一租用戶應用程式：單一租用戶應用程式適合在一個組織中使用。</span><span class="sxs-lookup"><span data-stu-id="6adb3-210">Single tenant application: A single tenant application is intended for use in one organization.</span></span> <span data-ttu-id="6adb3-211">這些通常是由企業開發人員撰寫的企業營運 (LoB) 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-211">These are typically line-of-business (LoB) applications written by an enterprise developer.</span></span> <span data-ttu-id="6adb3-212">單一租用戶應用程式只需要由一個目錄中的使用者存取，因此，它只需要佈建在一個目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-212">A single tenant application only needs to be accessed by users in one directory, and as a result, it only needs to be provisioned in one directory.</span></span> <span data-ttu-id="6adb3-213">這些應用程式通常是由組織中的開發人員註冊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-213">These applications are typically registered by a developer in the organization.</span></span>
* <span data-ttu-id="6adb3-214">多租用戶應用程式：多租用戶應用程式適合在許多組織中使用，而不只一個組織。</span><span class="sxs-lookup"><span data-stu-id="6adb3-214">Multi-tenant application: A multi-tenant application is intended for use in many organizations, not just one organization.</span></span> <span data-ttu-id="6adb3-215">這些通常是由獨立軟體廠商 (ISV) 撰寫的軟體即服務 (SaaS) 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-215">These are typically software-as-a-service (SaaS) applications written by an independent software vendor (ISV).</span></span> <span data-ttu-id="6adb3-216">多租用戶應用程式需要佈建在將會用到它們的每個目錄中，而這需要使用者或系統管理員同意才能註冊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-216">Multi-tenant applications need to be provisioned in each directory where they will be used, which requires user or administrator consent to register them.</span></span> <span data-ttu-id="6adb3-217">當應用程式目錄中已在目錄中註冊並獲權存取 Graph API 或其他 Web API 時，此同意程序會啟動。</span><span class="sxs-lookup"><span data-stu-id="6adb3-217">This consent process starts when an application has been registered in the directory and is given access to the Graph API or perhaps another web API.</span></span> <span data-ttu-id="6adb3-218">當不同組織的使用者或系統管理員註冊來使用應用程式時，他們會看到一個對話方塊顯示應用程式需要的權限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-218">When a user or administrator from a different organization signs up to use the application, they are presented with a dialog that displays the permissions the application requires.</span></span> <span data-ttu-id="6adb3-219">使用者或系統管理員可以同意應用程式，讓應用程式存取所述的資料，最後將應用程式註冊在他們的目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-219">The user or administrator can then consent to the application, which gives the application access to the stated data, and finally registers the application in their directory.</span></span> <span data-ttu-id="6adb3-220">如需詳細資訊，請參閱 [同意架構的概觀](active-directory-integrating-applications.md#overview-of-the-consent-framework)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-220">For more information, see [Overview of the Consent Framework](active-directory-integrating-applications.md#overview-of-the-consent-framework).</span></span>

<span data-ttu-id="6adb3-221">開發多租用戶應用程式，而非單一租用戶應用程式時，有一些其他考量需要注意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-221">Some additional considerations arise when developing a multi-tenant application instead of a single tenant application.</span></span> <span data-ttu-id="6adb3-222">例如，如果要讓您的應用程式供多個目錄中的使用者使用，您需要有機制來判斷他們所在的租用戶。</span><span class="sxs-lookup"><span data-stu-id="6adb3-222">For example, if you are making your application available to users in multiple directories, you need a mechanism to determine which tenant they’re in.</span></span> <span data-ttu-id="6adb3-223">單一租用戶應用程式只需要在它自己的目錄中查看使用者，但多租用戶應用程式需要從 Azure AD 的所有目錄中識別特定的使用者。</span><span class="sxs-lookup"><span data-stu-id="6adb3-223">A single tenant application only needs to look in its own directory for a user, while a multi-tenant application needs to identify a specific user from all the directories in Azure AD.</span></span> <span data-ttu-id="6adb3-224">為了完成這項工作，Azure AD 提供一個共同驗證端點，供任何多租用戶應用程式引導登入要求，而非提供租用戶特定的端點。</span><span class="sxs-lookup"><span data-stu-id="6adb3-224">To accomplish this task, Azure AD provides a common authentication endpoint where any multi-tenant application can direct sign-in requests, instead of a tenant-specific endpoint.</span></span> <span data-ttu-id="6adb3-225">對 Azure AD 中的所有目錄而言，此端點是 https://login.microsoftonline.com/common，其中租用戶專屬端點可能是 https://login.microsoftonline.com/contoso.onmicrosoft.com。開發您的應用程式時尤其必須考量共同端點，因為在登入、登出和權杖驗證期間，您需要必要的邏輯來處理多個租用戶。</span><span class="sxs-lookup"><span data-stu-id="6adb3-225">This endpoint is https://login.microsoftonline.com/common for all directories in Azure AD, whereas a tenant-specific endpoint might be https://login.microsoftonline.com/contoso.onmicrosoft.com. The common endpoint is especially important to consider when developing your application because you’ll need the necessary logic to handle multiple tenants during sign-in, sign-out, and token validation.</span></span>

<span data-ttu-id="6adb3-226">如果您目前正在開發單一租用戶應用程式，但想要提供給許多組織使用，您可以在 Azure AD 中輕鬆地變更應用程式及其組態，將它變成具備多租用戶功能。</span><span class="sxs-lookup"><span data-stu-id="6adb3-226">If you are currently developing a single tenant application but want to make it available to many organizations, you can easily make changes to the application and its configuration in Azure AD to make it multi-tenant capable.</span></span> <span data-ttu-id="6adb3-227">此外，不論您是在單一租用戶或多租用戶應用程式中提供驗證，Azure AD 對所有目錄中的所有權杖都使用相同的簽署金鑰。</span><span class="sxs-lookup"><span data-stu-id="6adb3-227">In addition, Azure AD uses the same signing key for all tokens in all directories, whether you are providing authentication in a single tenant or multi-tenant application.</span></span>

<span data-ttu-id="6adb3-228">本文件列出的每個案例都有一個小節來說明其佈建需求。</span><span class="sxs-lookup"><span data-stu-id="6adb3-228">Each scenario listed in this document includes a sub-section that describes its provisioning requirements.</span></span> <span data-ttu-id="6adb3-229">如需關於在 Azure AD 中佈建應用程式的深入資訊，以及了解單一和多租用戶應用程式之間的差異，請參閱 [整合應用程式與 Azure Active Directory](active-directory-integrating-applications.md) ，以取得詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-229">For more in-depth information about provisioning an application in Azure AD and the differences between single and multi-tenant applications, see [Integrating Applications with Azure Active Directory](active-directory-integrating-applications.md) for more information.</span></span> <span data-ttu-id="6adb3-230">繼續閱讀來了解 Azure AD 中常見的應用程式案例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-230">Continue reading to understand the common application scenarios in Azure AD.</span></span>

## <a name="application-types-and-scenarios"></a><span data-ttu-id="6adb3-231">應用程式類型和案例</span><span class="sxs-lookup"><span data-stu-id="6adb3-231">Application Types and Scenarios</span></span>
<span data-ttu-id="6adb3-232">本文件中所述的每個案例也可以使用各種語言和平台進行開發。</span><span class="sxs-lookup"><span data-stu-id="6adb3-232">Each of the scenarios described in this document can be developed using various languages and platforms.</span></span> <span data-ttu-id="6adb3-233">它們皆有完整的程式碼範例支援，這些程式碼範例是在我們的[程式碼範例指南](active-directory-code-samples.md)中，或者直接從相對應的 [GitHub 範例存放庫](https://github.com/Azure-Samples?utf8=%E2%9C%93&query=active-directory)提供使用。</span><span class="sxs-lookup"><span data-stu-id="6adb3-233">They are all backed by complete code samples which are available in our [Code Samples guide](active-directory-code-samples.md), or directly from the corresponding [GitHub sample repositories](https://github.com/Azure-Samples?utf8=%E2%9C%93&query=active-directory).</span></span> <span data-ttu-id="6adb3-234">此外，如果您的應用程式需要端對端案例的特定片段或區段，在大部分情況下可以獨立加入這項功能。</span><span class="sxs-lookup"><span data-stu-id="6adb3-234">In addition, if your application needs a specific piece or segment of an end-to-end scenario, in most cases that functionality can be added independently.</span></span> <span data-ttu-id="6adb3-235">例如，如果您有一個呼叫 Web API 的原生應用程式，您可以輕鬆加入也會呼叫該 Web API 的 Web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-235">For example, if you have a native application that calls a web API, you can easily add a web application that also calls the web API.</span></span> <span data-ttu-id="6adb3-236">下圖說明這些案例和應用程式類型，以及如何加入不同的元件：</span><span class="sxs-lookup"><span data-stu-id="6adb3-236">The following diagram illustrates these scenarios and application types, and how different components can be added:</span></span>

![應用程式類型和案例](./media/active-directory-authentication-scenarios/application_types_and_scenarios.png)

<span data-ttu-id="6adb3-238">以下是 Azure AD 支援的五個主要應用程式案例：</span><span class="sxs-lookup"><span data-stu-id="6adb3-238">These are the five primary application scenarios supported by Azure AD:</span></span>

* <span data-ttu-id="6adb3-239">[Web 瀏覽器到 Web 應用程式](#web-browser-to-web-application)：使用者需要登入 Azure AD 所保護的 Web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-239">[Web Browser to Web Application](#web-browser-to-web-application): A user needs to sign in to a web application that is secured by Azure AD.</span></span>
* <span data-ttu-id="6adb3-240">[單一頁面應用程式 (SPA)](#single-page-application-spa)：使用者需要登入 Azure AD 所保護的單一頁面應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-240">[Single Page Application (SPA)](#single-page-application-spa): A user needs to sign in to a single page application that is secured by Azure AD.</span></span>
* <span data-ttu-id="6adb3-241">[原生應用程式到 Web API](#native-application-to-web-api)：在電話、平板電腦或電腦執行的原生應用程式需要驗證使用者，以便從 Azure AD 所保護的 Web API 取得資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-241">[Native Application to Web API](#native-application-to-web-api): A native application that runs on a phone, tablet, or PC needs to authenticate a user to get resources from a web API that is secured by Azure AD.</span></span>
* <span data-ttu-id="6adb3-242">[Web 應用程式到 Web API](#web-application-to-web-api)：Web 應用程式需要從 Azure AD 所保護的 Web API 取得資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-242">[Web Application to Web API](#web-application-to-web-api): A web application needs to get resources from a web API secured by Azure AD.</span></span>
* <span data-ttu-id="6adb3-243">[精靈或伺服器應用程式到 Web API](#daemon-or-server-application-to-web-api)：無 Web 使用者介面的精靈應用程式或伺服器應用程式，需要從 Azure AD 所保護的 Web API 取得資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-243">[Daemon or Server Application to Web API](#daemon-or-server-application-to-web-api): A daemon application or a server application with no web user interface needs to get resources from a web API secured by Azure AD.</span></span>

### <a name="web-browser-to-web-application"></a><span data-ttu-id="6adb3-244">Web 瀏覽器到 Web 應用程式</span><span class="sxs-lookup"><span data-stu-id="6adb3-244">Web Browser to Web Application</span></span>
<span data-ttu-id="6adb3-245">本節描述一個應用程式向 Web 應用程式驗證 Web 瀏覽器中的使用者。</span><span class="sxs-lookup"><span data-stu-id="6adb3-245">This section describes an application that authenticates a user in a web browser to a web application.</span></span> <span data-ttu-id="6adb3-246">在此案例中，Web 應用程式會引導使用者的瀏覽器，將他們登入 Azure AD。</span><span class="sxs-lookup"><span data-stu-id="6adb3-246">In this scenario, the web application directs the user’s browser to sign them in to Azure AD.</span></span> <span data-ttu-id="6adb3-247">Azure AD 會透過使用者的瀏覽器傳回登入回應，其中包含關於安全性權杖中的使用者宣告。</span><span class="sxs-lookup"><span data-stu-id="6adb3-247">Azure AD returns a sign-in response through the user’s browser, which contains claims about the user in a security token.</span></span> <span data-ttu-id="6adb3-248">此案例支援使用 WS-同盟、SAML 2.0 和 OpenID Connect 通訊協定來登入。</span><span class="sxs-lookup"><span data-stu-id="6adb3-248">This scenario supports sign-on using the WS-Federation, SAML 2.0, and OpenID Connect protocols.</span></span>

#### <a name="diagram"></a><span data-ttu-id="6adb3-249">圖表</span><span class="sxs-lookup"><span data-stu-id="6adb3-249">Diagram</span></span>
![瀏覽器到 Web 應用程式的驗證流程](./media/active-directory-authentication-scenarios/web_browser_to_web_api.png)

#### <a name="description-of-protocol-flow"></a><span data-ttu-id="6adb3-251">通訊協定流程的描述</span><span class="sxs-lookup"><span data-stu-id="6adb3-251">Description of Protocol Flow</span></span>
1. <span data-ttu-id="6adb3-252">當使用者造訪應用程式且需要登入時，他們透過登入要求而重新導向 Azure AD 中的驗證端點。</span><span class="sxs-lookup"><span data-stu-id="6adb3-252">When a user visits the application and needs to sign in, they are redirected via a sign-in request to the authentication endpoint in Azure AD.</span></span>
2. <span data-ttu-id="6adb3-253">使用者在登入頁面上登入。</span><span class="sxs-lookup"><span data-stu-id="6adb3-253">The user signs in on the sign-in page.</span></span>
3. <span data-ttu-id="6adb3-254">如果驗證成功，Azure AD 會建立驗證權杖，並將登入回應傳回至 Azure 入口網站中設定的應用程式回覆 URL。</span><span class="sxs-lookup"><span data-stu-id="6adb3-254">If authentication is successful, Azure AD creates an authentication token and returns a sign-in response to the application’s Reply URL that was configured in the Azure Portal.</span></span> <span data-ttu-id="6adb3-255">對於實際執行應用程式，此回覆 URL 應該為 HTTPS。</span><span class="sxs-lookup"><span data-stu-id="6adb3-255">For a production application, this Reply URL should be HTTPS.</span></span> <span data-ttu-id="6adb3-256">傳回的權杖包含應用程式驗證權杖所需的使用者與 Azure AD 宣告。</span><span class="sxs-lookup"><span data-stu-id="6adb3-256">The returned token includes claims about the user and Azure AD that are required by the application to validate the token.</span></span>
4. <span data-ttu-id="6adb3-257">應用程式會使用 Azure AD 的同盟中繼資料文件可用的公開簽署金鑰和簽發者資訊來驗證權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-257">The application validates the token by using a public signing key and issuer information available at the federation metadata document for Azure AD.</span></span> <span data-ttu-id="6adb3-258">應用程式驗證權杖之後，Azure AD 會對使用者啟動新的工作階段。</span><span class="sxs-lookup"><span data-stu-id="6adb3-258">After the application validates the token, Azure AD starts a new session with the user.</span></span> <span data-ttu-id="6adb3-259">此工作階段可讓使用者存取應用程式，直到過期為止。</span><span class="sxs-lookup"><span data-stu-id="6adb3-259">This session allows the user to access the application until it expires.</span></span>

#### <a name="code-samples"></a><span data-ttu-id="6adb3-260">程式碼範例</span><span class="sxs-lookup"><span data-stu-id="6adb3-260">Code Samples</span></span>
<span data-ttu-id="6adb3-261">請參閱「Web 瀏覽器到 Web 應用程式」案例的程式碼範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-261">See the code samples for Web Browser to Web Application scenarios.</span></span> <span data-ttu-id="6adb3-262">請經常回來查看，我們會隨時加入新的範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-262">And, check back frequently -- we add new samples all the time.</span></span> <span data-ttu-id="6adb3-263">[Web 瀏覽器到 Web 應用程式](active-directory-code-samples.md#web-browser-to-web-application)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-263">[Web Browser to Web Application](active-directory-code-samples.md#web-browser-to-web-application).</span></span>

#### <a name="registering"></a><span data-ttu-id="6adb3-264">註冊</span><span class="sxs-lookup"><span data-stu-id="6adb3-264">Registering</span></span>
* <span data-ttu-id="6adb3-265">單一租用戶：如果您只是要為您的組織建置應用程式，則必須使用 Azure 入口網站，將它註冊在公司的目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-265">Single Tenant: If you are building an application just for your organization, it must be registered in your company’s directory by using the Azure Portal.</span></span>
* <span data-ttu-id="6adb3-266">多租用戶：如果您要建置的應用程式可供組織外的使用者使用，它必須註冊在公司的目錄中，但也必須在每個將會使用該應用程式的組織的目錄中註冊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-266">Multi-Tenant: If you are building an application that can be used by users outside your organization, it must be registered in your company’s directory, but also must be registered in each organization’s directory that will be using the application.</span></span> <span data-ttu-id="6adb3-267">若要讓您的應用程式出現在他們的目錄中，您可以為客戶加上註冊程序，讓他們同意應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-267">To make your application available in their directory, you can include a sign-up process for your customers that enables them to consent to your application.</span></span> <span data-ttu-id="6adb3-268">當他們註冊您的應用程式時，他們會看到對話方塊顯示應用程式所需的權限，以及是否同意的選項。</span><span class="sxs-lookup"><span data-stu-id="6adb3-268">When they sign up for your application, they will be presented with a dialog that shows the permissions the application requires, and then the option to consent.</span></span> <span data-ttu-id="6adb3-269">根據所需的權限，其他組織的系統管理員可能必須同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-269">Depending on the required permissions, an administrator in the other organization may be required to give consent.</span></span> <span data-ttu-id="6adb3-270">當使用者或系統管理員同意時，應用程式就會註冊在他們的目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-270">When the user or administrator consents, the application is registered in their directory.</span></span> <span data-ttu-id="6adb3-271">如需詳細資訊，請參閱 [整合應用程式與 Azure Active Directory](active-directory-integrating-applications.md)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-271">For more information, see [Integrating Applications with Azure Active Directory](active-directory-integrating-applications.md).</span></span>

#### <a name="token-expiration"></a><span data-ttu-id="6adb3-272">權杖到期</span><span class="sxs-lookup"><span data-stu-id="6adb3-272">Token Expiration</span></span>
<span data-ttu-id="6adb3-273">當 Azure AD 所簽發的權杖存留期到期時，使用者工作階段就過期。</span><span class="sxs-lookup"><span data-stu-id="6adb3-273">The user’s session expires when the lifetime of the token issued by Azure AD expires.</span></span> <span data-ttu-id="6adb3-274">如有需要，您的應用程式可以縮短這段時間，例如因為一段時間沒有活動而將使用者登出。</span><span class="sxs-lookup"><span data-stu-id="6adb3-274">Your application can shorten this time period if desired, such as signing out users based on a period of inactivity.</span></span> <span data-ttu-id="6adb3-275">當工作階段到期時，會提示使用者重新登入。</span><span class="sxs-lookup"><span data-stu-id="6adb3-275">When the session expires, the user will be prompted to sign in again.</span></span>

### <a name="single-page-application-spa"></a><span data-ttu-id="6adb3-276">單一頁面應用程式 (SPA)</span><span class="sxs-lookup"><span data-stu-id="6adb3-276">Single Page Application (SPA)</span></span>
<span data-ttu-id="6adb3-277">本節描述單一頁面應用程式的驗證，此應用程式會使用 Azure AD 和 OAuth 2.0 隱含授權授與來保護其 Web API 後端。</span><span class="sxs-lookup"><span data-stu-id="6adb3-277">This section describes authentication for a Single Page Application, that uses Azure AD and the OAuth 2.0 implicit authorization grant to secure its web API back end.</span></span> <span data-ttu-id="6adb3-278">單一頁面應用程式通常建構為在瀏覽器中執行的 JavaScript 展示層 (前端)，以及在伺服器上執行並實作應用程式商務邏輯的 Web API 後端。</span><span class="sxs-lookup"><span data-stu-id="6adb3-278">Single Page Applications are typically structured as a JavaScript presentation layer (front end) that runs in the browser and a Web API back end that runs on a server and implements the application’s business logic.</span></span> <span data-ttu-id="6adb3-279">若要深入了解隱含授權授與，並協助您決定其是否適合您的應用程式案例，請參閱 [了解 Azure Active Directory 中的 OAuth2 隱含授與流程](active-directory-dev-understanding-oauth2-implicit-grant.md)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-279">To learn more about the implicit authorization grant, and help you decide whether it's right for your application scenario, see [Understanding the OAuth2 implicit grant flow in Azure Active Directory](active-directory-dev-understanding-oauth2-implicit-grant.md).</span></span>

<span data-ttu-id="6adb3-280">在此案例中，當使用者登入時，JavaScript 前端會使用 [Active Directory Authentication Library for JavaScript (ADAL.JS)](https://github.com/AzureAD/azure-activedirectory-library-for-js/tree/dev) 和隱含授權授與，從 Azure AD 取得的識別碼權杖 (id_token)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-280">In this scenario, when the user signs in, the JavaScript front end uses [Active Directory Authentication Library for JavaScript (ADAL.JS)](https://github.com/AzureAD/azure-activedirectory-library-for-js/tree/dev) and the implicit authorization grant to obtain an ID token (id_token) from Azure AD.</span></span> <span data-ttu-id="6adb3-281">權杖會留在快取中，而用戶端呼叫 Web API 後端時會將權杖附加至要求做為持有人權杖，並使用 OWIN 中介軟體來保護。</span><span class="sxs-lookup"><span data-stu-id="6adb3-281">The token is cached and the client attaches it to the request as the bearer token when making calls to its Web API back end, which is secured using the OWIN middleware.</span></span> 

#### <a name="diagram"></a><span data-ttu-id="6adb3-282">圖表</span><span class="sxs-lookup"><span data-stu-id="6adb3-282">Diagram</span></span>
![單一頁面應用程式圖表](./media/active-directory-authentication-scenarios/single_page_app.png)

#### <a name="description-of-protocol-flow"></a><span data-ttu-id="6adb3-284">通訊協定流程的描述</span><span class="sxs-lookup"><span data-stu-id="6adb3-284">Description of Protocol Flow</span></span>
1. <span data-ttu-id="6adb3-285">使用者導覽至 Web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-285">The user navigates to the web application.</span></span>
2. <span data-ttu-id="6adb3-286">應用程式將 JavaScript 前端 (展示層) 傳回至瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="6adb3-286">The application returns the JavaScript front end (presentation layer) to the browser.</span></span>
3. <span data-ttu-id="6adb3-287">使用者起始登入，例如按一下登入連結。</span><span class="sxs-lookup"><span data-stu-id="6adb3-287">The user initiates sign in, for example by clicking a sign in link.</span></span> <span data-ttu-id="6adb3-288">瀏覽器傳送 GET 給 Azure AD 授權端點來要求識別碼權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-288">The browser sends a GET to the Azure AD authorization endpoint to request an ID token.</span></span> <span data-ttu-id="6adb3-289">此要求在查詢參數中包含應用程式識別碼和回覆 URL。</span><span class="sxs-lookup"><span data-stu-id="6adb3-289">This request includes the application ID and reply URL in the query parameters.</span></span>
4. <span data-ttu-id="6adb3-290">Azure AD 根據 Azure 入口網站中設定的註冊回覆 URL，驗證回覆 URL。</span><span class="sxs-lookup"><span data-stu-id="6adb3-290">Azure AD validates the Reply URL against the registered Reply URL that was configured in the Azure Portal.</span></span>
5. <span data-ttu-id="6adb3-291">使用者在登入頁面上登入。</span><span class="sxs-lookup"><span data-stu-id="6adb3-291">The user signs in on the sign-in page.</span></span>
6. <span data-ttu-id="6adb3-292">如果驗證成功，Azure AD 就會建立識別碼權杖，並當做 URL 片段 (#) 傳回至應用程式的回覆 URL。</span><span class="sxs-lookup"><span data-stu-id="6adb3-292">If authentication is successful, Azure AD creates an ID token and returns it as a URL fragment (#) to the application’s Reply URL.</span></span> <span data-ttu-id="6adb3-293">對於實際執行應用程式，此回覆 URL 應該為 HTTPS。</span><span class="sxs-lookup"><span data-stu-id="6adb3-293">For a production application, this Reply URL should be HTTPS.</span></span> <span data-ttu-id="6adb3-294">傳回的權杖包含應用程式驗證權杖所需的使用者與 Azure AD 宣告。</span><span class="sxs-lookup"><span data-stu-id="6adb3-294">The returned token includes claims about the user and Azure AD that are required by the application to validate the token.</span></span>
7. <span data-ttu-id="6adb3-295">瀏覽器中執行的 JavaScript 用戶端程式碼從回應中擷取權杖，用以保護對應用程式 Web API 後端的呼叫。</span><span class="sxs-lookup"><span data-stu-id="6adb3-295">The JavaScript client code running in the browser extracts the token from the response to use in securing calls to the application’s web API back end.</span></span>
8. <span data-ttu-id="6adb3-296">瀏覽器使用授權標頭中的存取權杖，呼叫應用程式的 Web API 後端。</span><span class="sxs-lookup"><span data-stu-id="6adb3-296">The browser calls the application’s web API back end with the access token in the authorization header.</span></span>

#### <a name="code-samples"></a><span data-ttu-id="6adb3-297">程式碼範例</span><span class="sxs-lookup"><span data-stu-id="6adb3-297">Code Samples</span></span>
<span data-ttu-id="6adb3-298">請參閱「單一頁面應用程式 (SPA)」案例的程式碼範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-298">See the code samples for Single Page Application (SPA) scenarios.</span></span> <span data-ttu-id="6adb3-299">請務必經常回來查看，我們會隨時加入新的範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-299">Be sure to check back frequently -- we add new samples all the time.</span></span> <span data-ttu-id="6adb3-300">[單一頁面應用程式 (SPA)](active-directory-code-samples.md#single-page-application-spa)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-300">[Single Page Application (SPA)](active-directory-code-samples.md#single-page-application-spa).</span></span>

#### <a name="registering"></a><span data-ttu-id="6adb3-301">註冊</span><span class="sxs-lookup"><span data-stu-id="6adb3-301">Registering</span></span>
* <span data-ttu-id="6adb3-302">單一租用戶：如果您只是要為您的組織建置應用程式，則必須使用 Azure 入口網站，將它註冊在公司的目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-302">Single Tenant: If you are building an application just for your organization, it must be registered in your company’s directory by using the Azure Portal.</span></span>
* <span data-ttu-id="6adb3-303">多租用戶：如果您要建置的應用程式可供組織外的使用者使用，它必須註冊在公司的目錄中，但也必須在每個將會使用該應用程式的組織的目錄中註冊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-303">Multi-Tenant: If you are building an application that can be used by users outside your organization, it must be registered in your company’s directory, but also must be registered in each organization’s directory that will be using the application.</span></span> <span data-ttu-id="6adb3-304">若要讓您的應用程式出現在他們的目錄中，您可以為客戶加上註冊程序，讓他們同意應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-304">To make your application available in their directory, you can include a sign-up process for your customers that enables them to consent to your application.</span></span> <span data-ttu-id="6adb3-305">當他們註冊您的應用程式時，他們會看到對話方塊顯示應用程式所需的權限，以及是否同意的選項。</span><span class="sxs-lookup"><span data-stu-id="6adb3-305">When they sign up for your application, they will be presented with a dialog that shows the permissions the application requires, and then the option to consent.</span></span> <span data-ttu-id="6adb3-306">根據所需的權限，其他組織的系統管理員可能必須同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-306">Depending on the required permissions, an administrator in the other organization may be required to give consent.</span></span> <span data-ttu-id="6adb3-307">當使用者或系統管理員同意時，應用程式就會註冊在他們的目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-307">When the user or administrator consents, the application is registered in their directory.</span></span> <span data-ttu-id="6adb3-308">如需詳細資訊，請參閱 [整合應用程式與 Azure Active Directory](active-directory-integrating-applications.md)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-308">For more information, see [Integrating Applications with Azure Active Directory](active-directory-integrating-applications.md).</span></span>

<span data-ttu-id="6adb3-309">註冊應用程式之後，它必須設定為使用 OAuth 2.0 隱含授權通訊協定。</span><span class="sxs-lookup"><span data-stu-id="6adb3-309">After registering the application, it must be configured to use OAuth 2.0 Implicit Grant protocol.</span></span> <span data-ttu-id="6adb3-310">根據預設，應用程式都停用此通訊協定。</span><span class="sxs-lookup"><span data-stu-id="6adb3-310">By default, this protocol is disabled for applications.</span></span> <span data-ttu-id="6adb3-311">若要對您的應用程式啟用 OAuth2 隱含授權通訊協定，請在 Azure 入口網站編輯其應用程式資訊清單，將 "oauth2AllowImplicitFlow" 值設為 true。</span><span class="sxs-lookup"><span data-stu-id="6adb3-311">To enable the OAuth2 Implicit Grant protocol for your application, edit its application manifest from the Azure Portal and set the “oauth2AllowImplicitFlow” value to true.</span></span> <span data-ttu-id="6adb3-312">如需詳細指示，請參閱 [啟用單一頁面應用程式的 OAuth 2.0 隱含授權](active-directory-integrating-applications.md)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-312">For detailed instructions, see [Enabling OAuth 2.0 Implicit Grant for Single Page Applications](active-directory-integrating-applications.md).</span></span>

#### <a name="token-expiration"></a><span data-ttu-id="6adb3-313">權杖到期</span><span class="sxs-lookup"><span data-stu-id="6adb3-313">Token Expiration</span></span>
<span data-ttu-id="6adb3-314">當您使用 ADAL.js 來管理向 Azure AD 驗證時，有數個功能可協助更新過期的權杖，並針對應用程式可能呼叫的其他 Web API 資源取得權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-314">When you use ADAL.js to manage authentication with Azure AD, you benefit from several features that facilitate refreshing an expired token as well as getting tokens for additional web API resources that may be called by the application.</span></span> <span data-ttu-id="6adb3-315">當使用者成功向 Azure AD 驗證時，瀏覽器與 Azure AD 之間會為使用者建立一個以 Cookie 保護的工作階段。</span><span class="sxs-lookup"><span data-stu-id="6adb3-315">When the user successfully authenticates with Azure AD, a session secured by a cookie is established for the user between the browser and Azure AD.</span></span> <span data-ttu-id="6adb3-316">請務必注意，工作階段存在於使用者與 Azure AD 之間，而不是在使用者與伺服器上執行的 Web 應用程式之間。</span><span class="sxs-lookup"><span data-stu-id="6adb3-316">It’s important to note that the session exists between the user and Azure AD and not between the user and the web application running on the server.</span></span> <span data-ttu-id="6adb3-317">當權杖過期時，ADAL.js 會使用此工作階段來自動取得另一個權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-317">When a token expires, ADAL.js uses this session to silently obtain another token.</span></span> <span data-ttu-id="6adb3-318">在作法上是使用隱藏的 iFrame 來傳送和接收要求，而且是透過 OAuth 隱含授權通訊協定。</span><span class="sxs-lookup"><span data-stu-id="6adb3-318">It does this by using a hidden iFrame to send and receive the request using the OAuth Implicit Grant protocol.</span></span> <span data-ttu-id="6adb3-319">ADAL.js 也可以使用這個相同的機制，針對應用程式會呼叫的其他 Web API 資源，自動從 Azure AD 取得存取權杖，但這些資源必須支援跨原始資源共用 (CORS)、已註冊在使用者的目錄中，而且使用者在登入期間已做出任何必要的同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-319">ADAL.js can also use this same mechanism to silently obtain access tokens from Azure AD for other web API resources that the application calls as long as these resources support cross-origin resource sharing (CORS), are registered in the user’s directory, and any required consent was given by the user during sign-in.</span></span>

### <a name="native-application-to-web-api"></a><span data-ttu-id="6adb3-320">原生應用程式到 Web API</span><span class="sxs-lookup"><span data-stu-id="6adb3-320">Native Application to Web API</span></span>
<span data-ttu-id="6adb3-321">本節描述代表使用者呼叫 Web API 的原生應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-321">This section describes a native application that calls a web API on behalf of a user.</span></span> <span data-ttu-id="6adb3-322">此案例是根據 OAuth 2.0 授權碼授與類型和公用用戶端，如 [OAuth 2.0 規格](http://tools.ietf.org/html/rfc6749)第 4.1 節所述。</span><span class="sxs-lookup"><span data-stu-id="6adb3-322">This scenario is built on the OAuth 2.0 authorization code grant type with a public client, as described in section 4.1 of the [OAuth 2.0 specification](http://tools.ietf.org/html/rfc6749).</span></span> <span data-ttu-id="6adb3-323">此原生應用程式使用 OAuth 2.0 通訊協定，為使用者取得存取權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-323">The native application obtains an access token for the user by using the OAuth 2.0 protocol.</span></span> <span data-ttu-id="6adb3-324">接著，此存取權杖隨著要求傳送至 Web API，Web API 再授權使用者並傳回所需的資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-324">This access token is then sent in the request to the web API, which authorizes the user and returns the desired resource.</span></span>

#### <a name="diagram"></a><span data-ttu-id="6adb3-325">圖表</span><span class="sxs-lookup"><span data-stu-id="6adb3-325">Diagram</span></span>
![原生應用程式到 Web API 圖表](./media/active-directory-authentication-scenarios/native_app_to_web_api.png)

#### <a name="authentication-flow-for-native-application-to-api"></a><span data-ttu-id="6adb3-327">原生應用程式到 API 的驗證流程</span><span class="sxs-lookup"><span data-stu-id="6adb3-327">Authentication flow for native application to API</span></span>
#### <a name="description-of-protocol-flow"></a><span data-ttu-id="6adb3-328">通訊協定流程的描述</span><span class="sxs-lookup"><span data-stu-id="6adb3-328">Description of Protocol Flow</span></span>
<span data-ttu-id="6adb3-329">如果您使用 AD 驗證程式庫，則會為您處理如下所述的大部分通訊協定細節，例如瀏覽器快顯視窗、權杖快取和重新整理權杖的處理。</span><span class="sxs-lookup"><span data-stu-id="6adb3-329">If you are using the AD Authentication Libraries, most of the protocol details described below are handled for you, such as the browser pop-up, token caching, and handling of refresh tokens.</span></span>

1. <span data-ttu-id="6adb3-330">原生應用程式使用瀏覽器快顯視窗，對 Azure AD 中的授權端點提出要求。</span><span class="sxs-lookup"><span data-stu-id="6adb3-330">Using a browser pop-up, the native application makes a request to the authorization endpoint in Azure AD.</span></span> <span data-ttu-id="6adb3-331">此要求包含應用程式識別碼和原生應用程式的重新導向 URI (如 Azure 入口網站所示)，以及 Web API 的應用程式識別碼 URI。</span><span class="sxs-lookup"><span data-stu-id="6adb3-331">This request includes the Application ID and the redirect URI of the native application as shown in the Azure Portal, and the application ID URI for the web API.</span></span> <span data-ttu-id="6adb3-332">如果使用者尚未登入，系統會提示他們再次登入。</span><span class="sxs-lookup"><span data-stu-id="6adb3-332">If the user hasn’t already signed in, they are prompted to sign in again</span></span>
2. <span data-ttu-id="6adb3-333">Azure AD 驗證使用者。</span><span class="sxs-lookup"><span data-stu-id="6adb3-333">Azure AD authenticates the user.</span></span> <span data-ttu-id="6adb3-334">如果是多租用戶應用程式，且需要同意才能使用應用程式，則會要求使用者同意 (如果他們還沒有同意)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-334">If it is a multi-tenant application and consent is required to use the application, the user will be required to consent if they haven’t already done so.</span></span> <span data-ttu-id="6adb3-335">表示同意且成功驗證之後，Azure AD 會發出授權碼回應傳回至用戶端應用程式的重新導向 URI。</span><span class="sxs-lookup"><span data-stu-id="6adb3-335">After granting consent and upon successful authentication, Azure AD issues an authorization code response back to the client application’s redirect URI.</span></span>
3. <span data-ttu-id="6adb3-336">當 Azure AD 發出授權碼回應傳回至重新導向 URI 時，用戶端應用程式會停止瀏覽器互動，並從回應中擷取授權碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-336">When Azure AD issues an authorization code response back to the redirect URI, the client application stops browser interaction and extracts the authorization code from the response.</span></span> <span data-ttu-id="6adb3-337">用戶端應用程式會使用此授權碼，傳送要求至 Azure AD 的權杖端點，此要求包含授權碼、用戶端應用程式的詳細資料 應用程式識別碼和重新導向 URI)，以及所需的資源 (Web API 的應用程式識別碼 URI)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-337">Using this authorization code, the client application sends a request to Azure AD’s token endpoint that includes the authorization code, details about the client application (Application ID and redirect URI), and the desired resource (application ID URI for the web API).</span></span>
4. <span data-ttu-id="6adb3-338">Azure AD 驗證授權碼及用戶端應用程式和 Web API 的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-338">The authorization code and information about the client application and web API are validated by Azure AD.</span></span> <span data-ttu-id="6adb3-339">成功驗證後，Azure AD 會傳回兩個權杖：JWT 存取權杖和 JWT 重新整理權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-339">Upon successful validation, Azure AD returns two tokens: a JWT access token and a JWT refresh token.</span></span> <span data-ttu-id="6adb3-340">此外，Azure AD 會傳回使用者的基本資訊，例如其顯示名稱和租用戶識別碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-340">In addition, Azure AD returns basic information about the user, such as their display name and tenant ID.</span></span>
5. <span data-ttu-id="6adb3-341">用戶端應用程式使用傳回的 JWT 存取權杖，透過 HTTPS，在對 Web API 的要求的 Authorization 標頭中加上 JWT 字串並指定 "Bearer"。</span><span class="sxs-lookup"><span data-stu-id="6adb3-341">Over HTTPS, the client application uses the returned JWT access token to add the JWT string with a “Bearer” designation in the Authorization header of the request to the web API.</span></span> <span data-ttu-id="6adb3-342">接著，Web API 驗證 JWT 權杖，如果驗證成功，則傳回所需的資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-342">The web API then validates the JWT token, and if validation is successful, returns the desired resource.</span></span>
6. <span data-ttu-id="6adb3-343">當存取權杖到期時，用戶端應用程式會收到錯誤，指出使用者必須再次驗證。</span><span class="sxs-lookup"><span data-stu-id="6adb3-343">When the access token expires, the client application will receive an error that indicates the user needs to authenticate again.</span></span> <span data-ttu-id="6adb3-344">如果應用程式具有有效的重新整理權杖，它可用來取得新的存取權杖，不會提示使用者重新登入。</span><span class="sxs-lookup"><span data-stu-id="6adb3-344">If the application has a valid refresh token, it can be used to acquire a new access token without prompting the user to sign in again.</span></span> <span data-ttu-id="6adb3-345">如果重新整理權杖到期，應用程式必須再一次以互動方式驗證使用者。</span><span class="sxs-lookup"><span data-stu-id="6adb3-345">If the refresh token expires, the application will need to interactively authenticate the user once again.</span></span>

> [!NOTE]
> <span data-ttu-id="6adb3-346">Azure AD 所簽發的重新整理權杖可用來存取多個資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-346">The refresh token issued by Azure AD can be used to access multiple resources.</span></span> <span data-ttu-id="6adb3-347">例如，如果您的用戶端應用程式有權限呼叫兩個 Web API，重新整理權杖也可用來取得其他 Web API 的存取權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-347">For example, if you have a client application that has permission to call two web APIs, the refresh token can be used to get an access token to the other web API as well.</span></span>
> 
> 

#### <a name="code-samples"></a><span data-ttu-id="6adb3-348">程式碼範例</span><span class="sxs-lookup"><span data-stu-id="6adb3-348">Code Samples</span></span>
<span data-ttu-id="6adb3-349">請參閱「原生應用程式到 Web API」案例的程式碼範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-349">See the code samples for Native Application to Web API scenarios.</span></span> <span data-ttu-id="6adb3-350">請經常回來查看，我們會隨時加入新的範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-350">And, check back frequently -- we add new samples all the time.</span></span> <span data-ttu-id="6adb3-351">[原生應用程式到 Web API](active-directory-code-samples.md#native-application-to-web-api)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-351">[Native Application to Web API](active-directory-code-samples.md#native-application-to-web-api).</span></span>

#### <a name="registering"></a><span data-ttu-id="6adb3-352">註冊</span><span class="sxs-lookup"><span data-stu-id="6adb3-352">Registering</span></span>
* <span data-ttu-id="6adb3-353">單一租用戶：原生應用程式和 Web API 必須註冊在 Azure AD 的相同目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-353">Single Tenant: Both the native application and the web API must be registered in the same directory in Azure AD.</span></span> <span data-ttu-id="6adb3-354">Web API 可以設定為公開一組權限，用以限制原生應用程式對其資源的存取權。</span><span class="sxs-lookup"><span data-stu-id="6adb3-354">The web API can be configured to expose a set of permissions, which are used to limit the native application’s access to its resources.</span></span> <span data-ttu-id="6adb3-355">然後，用戶端應用程式從 Azure 入口網站的 [其他應用程式的權限] 下拉式功能表中，選取所需的權限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-355">The client application then selects the desired permissions from the “Permissions to Other Applications” drop-down menu in the Azure Portal.</span></span>
* <span data-ttu-id="6adb3-356">多租用戶：首先，原生應用程式僅註冊在開發人員或發行者的目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-356">Multi-Tenant: First, the native application only ever registered in the developer or publisher’s directory.</span></span> <span data-ttu-id="6adb3-357">第二，設定原生應用程式來指出它運作所需的權限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-357">Second, the native application is configured to indicate the permissions it requires to be functional.</span></span> <span data-ttu-id="6adb3-358">當目的地目錄中的使用者或系統管理員同意應用程式時 (使得應用程式可供組織使用)，這份必要權限清單會顯示在對話方塊中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-358">This list of required permissions is shown in a dialog when a user or administrator in the destination directory gives consent to the application, which makes it available to their organization.</span></span> <span data-ttu-id="6adb3-359">有些應用程式只需要使用者層級權限，亦即組織中的任何使用者都可同意應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-359">Some applications require just user-level permissions, which any user in the organization can consent to.</span></span> <span data-ttu-id="6adb3-360">其他應用程式需要系統管理員層級權限，亦即組織中的使用者無法同意應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-360">Other applications require administrator-level permissions, which a user in the organization cannot consent to.</span></span> <span data-ttu-id="6adb3-361">只有目錄管理員才能對需要此權限層級的應用程式表示同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-361">Only a directory administrator can give consent to applications that require this level of permissions.</span></span> <span data-ttu-id="6adb3-362">當使用者或系統管理員同意時，只有 Web API 會註冊在他們的目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-362">When the user or administrator consents, only the web API is registered in their directory.</span></span> <span data-ttu-id="6adb3-363">如需詳細資訊，請參閱 [整合應用程式與 Azure Active Directory](active-directory-integrating-applications.md)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-363">For more information, see [Integrating Applications with Azure Active Directory](active-directory-integrating-applications.md).</span></span>

#### <a name="token-expiration"></a><span data-ttu-id="6adb3-364">權杖到期</span><span class="sxs-lookup"><span data-stu-id="6adb3-364">Token Expiration</span></span>
<span data-ttu-id="6adb3-365">當原生應用程式使用其授權碼來取得 JWT 存取權杖時，它也會收到 JWT 重新整理權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-365">When the native application uses its authorization code to get a JWT access token, it also receives a JWT refresh token.</span></span> <span data-ttu-id="6adb3-366">當存取權杖到期時，重新整理權杖可用來重新驗證使用者，而不需要他們再次登入。</span><span class="sxs-lookup"><span data-stu-id="6adb3-366">When the access token expires, the refresh token can be used to re-authenticate the user without requiring them to sign in again.</span></span> <span data-ttu-id="6adb3-367">然後，此重新整理權杖用來驗證使用者，結果會產生新的存取權杖和重新整理權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-367">This refresh token is then used to authenticate the user, which results in a new access token and refresh token.</span></span>

### <a name="web-application-to-web-api"></a><span data-ttu-id="6adb3-368">Web 應用程式到 Web API</span><span class="sxs-lookup"><span data-stu-id="6adb3-368">Web Application to Web API</span></span>
<span data-ttu-id="6adb3-369">本節描述需要從 Web API 取得資源的 Web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-369">This section describes a web application that needs to get resources from a web API.</span></span> <span data-ttu-id="6adb3-370">在此案例中，有兩個識別類型可供 Web 應用程式用來驗證和呼叫 Web API：應用程式識別或委派的使用者識別。</span><span class="sxs-lookup"><span data-stu-id="6adb3-370">In this scenario, there are two identity types that the web application can use to authenticate and call the web API: an application identity, or a delegated user identity.</span></span>

<span data-ttu-id="6adb3-371">*應用程式識別* ：此案例使用 OAuth 2.0 用戶端認證授與來驗證應用程式和存取 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-371">*Application identity:* This scenario uses OAuth 2.0 client credentials grant to authenticate as the application and access the web API.</span></span> <span data-ttu-id="6adb3-372">使用應用程式識別時，Web API 只能偵測到 Web 應用程式正在呼叫它，因為 Web API 沒有收到關於使用者的任何資訊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-372">When using an application identity, the web API can only detect that the web application is calling it, as the web API does not receive any information about the user.</span></span> <span data-ttu-id="6adb3-373">如果應用程式收到使用者的相關資訊，此資訊會透過應用程式通訊協定傳送，但未經過 Azure AD 簽署。</span><span class="sxs-lookup"><span data-stu-id="6adb3-373">If the application receives information about the user, it will be sent via the application protocol, and it is not signed by Azure AD.</span></span> <span data-ttu-id="6adb3-374">Web API 信任 Web 應用程式已驗證使用者。</span><span class="sxs-lookup"><span data-stu-id="6adb3-374">The web API trusts that the web application authenticated the user.</span></span> <span data-ttu-id="6adb3-375">基於這個理由，這種模式稱為受信任子系統。</span><span class="sxs-lookup"><span data-stu-id="6adb3-375">For this reason, this pattern is called a trusted subsystem.</span></span>

<span data-ttu-id="6adb3-376">*委派的使用者識別* ：有兩種方式可實現此案例：OpenID Connect 和搭配機密用戶端的 OAuth 2.0 授權碼授與。</span><span class="sxs-lookup"><span data-stu-id="6adb3-376">*Delegated user identity:* This scenario can be accomplished in two ways: OpenID Connect, and OAuth 2.0 authorization code grant with a confidential client.</span></span> <span data-ttu-id="6adb3-377">Web 應用程式會為使用者取得存取權杖，向 Web API 證明使用者已順利通過 Web 應用程式的驗證，而且 Web 應用程式能夠取得委派的使用者識別來呼叫 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-377">The web application obtains an access token for the user, which proves to the web API that the user successfully authenticated to the web application and that the web application was able to obtain a delegated user identity to call the web API.</span></span> <span data-ttu-id="6adb3-378">此存取權杖隨著要求傳送至 Web API，Web API 再授權使用者並傳回所需的資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-378">This access token is sent in the request to the web API, which authorizes the user and returns the desired resource.</span></span>

#### <a name="diagram"></a><span data-ttu-id="6adb3-379">圖表</span><span class="sxs-lookup"><span data-stu-id="6adb3-379">Diagram</span></span>
![Web 應用程式到 Web API 圖表](./media/active-directory-authentication-scenarios/web_app_to_web_api.png)

#### <a name="description-of-protocol-flow"></a><span data-ttu-id="6adb3-381">通訊協定流程的描述</span><span class="sxs-lookup"><span data-stu-id="6adb3-381">Description of Protocol Flow</span></span>
<span data-ttu-id="6adb3-382">下列流程中討論應用程式識別和委派的使用者識別類型。</span><span class="sxs-lookup"><span data-stu-id="6adb3-382">Both the application identity and delegated user identity types are discussed in the flow below.</span></span> <span data-ttu-id="6adb3-383">它們之間的主要差異是委派的使用者識別必須先取得授權碼，使用者才能登入並存取 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-383">The key difference between them is that the delegated user identity must first acquire an authorization code before the user can sign-in and gain access to the web API.</span></span>

##### <a name="application-identity-with-oauth-20-client-credentials-grant"></a><span data-ttu-id="6adb3-384">採用 OAuth 2.0 用戶端認證授與的應用程式識別</span><span class="sxs-lookup"><span data-stu-id="6adb3-384">Application Identity with OAuth 2.0 Client Credentials Grant</span></span>
1. <span data-ttu-id="6adb3-385">使用者在 Web 應用程式中登入 Azure AD (請參閱上方的 [Web 瀏覽器到 Web 應用程式](#web-browser-to-web-application) )。</span><span class="sxs-lookup"><span data-stu-id="6adb3-385">A user is signed in to Azure AD in the web application (see the [Web Browser to Web Application](#web-browser-to-web-application) above).</span></span>
2. <span data-ttu-id="6adb3-386">Web 應用程式需要取得存取權杖，才能向 Web API 驗證和擷取所需的資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-386">The web application needs to acquire an access token so that it can authenticate to the web API and retrieve the desired resource.</span></span> <span data-ttu-id="6adb3-387">它向 Azure AD 的權杖端點提出要求，並提供認證、應用程式識別碼和 Web API 的應用程式識別碼 URI。</span><span class="sxs-lookup"><span data-stu-id="6adb3-387">It makes a request to Azure AD’s token endpoint, providing the credential, Application ID, and web API’s application ID URI.</span></span>
3. <span data-ttu-id="6adb3-388">Azure AD 驗證應用程式，並傳回用來呼叫 Web API 的 JWT 存取權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-388">Azure AD authenticates the application and returns a JWT access token that is used to call the web API.</span></span>
4. <span data-ttu-id="6adb3-389">Web 應用程式使用傳回的 JWT 存取權杖，透過 HTTPS，在對 Web API 的要求的 Authorization 標頭中加上 JWT 字串並指定 "Bearer"。</span><span class="sxs-lookup"><span data-stu-id="6adb3-389">Over HTTPS, the web application uses the returned JWT access token to add the JWT string with a “Bearer” designation in the Authorization header of the request to the web API.</span></span> <span data-ttu-id="6adb3-390">接著，Web API 驗證 JWT 權杖，如果驗證成功，則傳回所需的資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-390">The web API then validates the JWT token, and if validation is successful, returns the desired resource.</span></span>

##### <a name="delegated-user-identity-with-openid-connect"></a><span data-ttu-id="6adb3-391">採用 OpenID Connect 的委派的使用者識別</span><span class="sxs-lookup"><span data-stu-id="6adb3-391">Delegated User Identity with OpenID Connect</span></span>
1. <span data-ttu-id="6adb3-392">使用者使用 Azure AD 登入 Web 應用程式 (請參閱上方的 [Web 瀏覽器到 Web 應用程式](#web-browser-to-web-application) 一節)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-392">A user is signed in to a web application using Azure AD (see the [Web Browser to Web Application](#web-browser-to-web-application) section above).</span></span> <span data-ttu-id="6adb3-393">如果 Web 應用程式的使用者尚未同意允許 Web 應用程式代表他來呼叫 Web API，使用者必須同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-393">If the user of the web application has not yet consented to allowing the web application to call the web API on its behalf, the user will need to consent.</span></span> <span data-ttu-id="6adb3-394">應用程式會顯示它需要的權限，如果其中任何一項是系統管理員層級權限，則目錄中的一般使用者將無法同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-394">The application will display the permissions it requires, and if any of these are administrator-level permissions, a normal user in the directory will not be able to consent.</span></span> <span data-ttu-id="6adb3-395">此同意程序僅適用於多租用戶應用程式，而非單一租用戶應用程式，因為應用程式已具有必要的權限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-395">This consent process only applies to multi-tenant applications, not single tenant applications, as the application will already have the necessary permissions.</span></span> <span data-ttu-id="6adb3-396">使用者登入後，Web 應用程式會收到識別碼權杖和使用者相關資訊，以及授權碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-396">When the user signed in, the web application received an ID token with information about the user, as well as an authorization code.</span></span>
2. <span data-ttu-id="6adb3-397">Web 應用程式會使用 Azure AD 簽發的授權碼，傳送要求至 Azure AD 的權杖端點，此要求包含授權碼、用戶端應用程式的詳細資料 (應用程式識別碼和重新導向 URI)，以及所需的資源 (Web API 的應用程式識別碼 URI)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-397">Using the authorization code issued by Azure AD, the web application sends a request to Azure AD’s token endpoint that includes the authorization code, details about the client application (Application ID and redirect URI), and the desired resource (application ID URI for the web API).</span></span>
3. <span data-ttu-id="6adb3-398">Azure AD 驗證授權碼及 Web 應用程式和 Web API 的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-398">The authorization code and information about the web application and web API are validated by Azure AD.</span></span> <span data-ttu-id="6adb3-399">成功驗證後，Azure AD 會傳回兩個權杖：JWT 存取權杖和 JWT 重新整理權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-399">Upon successful validation, Azure AD returns two tokens: a JWT access token and a JWT refresh token.</span></span>
4. <span data-ttu-id="6adb3-400">Web 應用程式使用傳回的 JWT 存取權杖，透過 HTTPS，在對 Web API 的要求的 Authorization 標頭中加上 JWT 字串並指定 "Bearer"。</span><span class="sxs-lookup"><span data-stu-id="6adb3-400">Over HTTPS, the web application uses the returned JWT access token to add the JWT string with a “Bearer” designation in the Authorization header of the request to the web API.</span></span> <span data-ttu-id="6adb3-401">接著，Web API 驗證 JWT 權杖，如果驗證成功，則傳回所需的資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-401">The web API then validates the JWT token, and if validation is successful, returns the desired resource.</span></span>

##### <a name="delegated-user-identity-with-oauth-20-authorization-code-grant"></a><span data-ttu-id="6adb3-402">採用 OAuth 2.0 授權碼授與的委派的使用者識別</span><span class="sxs-lookup"><span data-stu-id="6adb3-402">Delegated User Identity with OAuth 2.0 Authorization Code Grant</span></span>
1. <span data-ttu-id="6adb3-403">使用者已經登入 Web 應用程式，其驗證機制與 Azure AD 無關。</span><span class="sxs-lookup"><span data-stu-id="6adb3-403">A user is already signed in to a web application, whose authentication mechanism is independent of Azure AD.</span></span>
2. <span data-ttu-id="6adb3-404">Web 應用程式需要授權碼才能取得存取權杖，因此它透過瀏覽器向 Azure AD 授權端點發出要求，並提供應用程式識別碼和成功驗證之後的 Web 應用程式重新導向 URI。</span><span class="sxs-lookup"><span data-stu-id="6adb3-404">The web application requires an authorization code to acquire an access token, so it issues a request through the browser to Azure AD’s authorization endpoint, providing the Application ID and redirect URI for the web application after successful authentication.</span></span> <span data-ttu-id="6adb3-405">使用者登入 Azure AD。</span><span class="sxs-lookup"><span data-stu-id="6adb3-405">The user signs in to Azure AD.</span></span>
3. <span data-ttu-id="6adb3-406">如果 Web 應用程式的使用者尚未同意允許 Web 應用程式代表他來呼叫 Web API，使用者必須同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-406">If the user of the web application has not yet consented to allowing the web application to call the web API on its behalf, the user will need to consent.</span></span> <span data-ttu-id="6adb3-407">應用程式會顯示它需要的權限，如果其中任何一項是系統管理員層級權限，則目錄中的一般使用者將無法同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-407">The application will display the permissions it requires, and if any of these are administrator-level permissions, a normal user in the directory will not be able to consent.</span></span> <span data-ttu-id="6adb3-408">此同意適用於單一和多租用戶應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-408">This consent applies to both single and multi-tenant application.</span></span>  <span data-ttu-id="6adb3-409">在單一租用戶案例中，管理員可以代表其使用者執行要同意的管理員同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-409">In the single tenant case, an admin can perform admin consent to consent on behalf of their users.</span></span>  <span data-ttu-id="6adb3-410">可以使用 [Azure 入口網站](https://portal.azure.com)中的 `Grant Permissions` 按鈕來完成。</span><span class="sxs-lookup"><span data-stu-id="6adb3-410">This can be done using the `Grant Permissions` button in the [Azure Portal](https://portal.azure.com).</span></span> 
4. <span data-ttu-id="6adb3-411">使用者同意之後，Web 應用程式會收到它取得存取權杖所需的授權碼。</span><span class="sxs-lookup"><span data-stu-id="6adb3-411">After the user has consented, the web application receives the authorization code that it needs to acquire an access token.</span></span>
5. <span data-ttu-id="6adb3-412">Web 應用程式會使用 Azure AD 簽發的授權碼，傳送要求至 Azure AD 的權杖端點，此要求包含授權碼、用戶端應用程式的詳細資料 (應用程式識別碼和重新導向 URI)，以及所需的資源 (Web API 的應用程式識別碼 URI)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-412">Using the authorization code issued by Azure AD, the web application sends a request to Azure AD’s token endpoint that includes the authorization code, details about the client application (Application ID and redirect URI), and the desired resource (application ID URI for the web API).</span></span>
6. <span data-ttu-id="6adb3-413">Azure AD 驗證授權碼及 Web 應用程式和 Web API 的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-413">The authorization code and information about the web application and web API are validated by Azure AD.</span></span> <span data-ttu-id="6adb3-414">成功驗證後，Azure AD 會傳回兩個權杖：JWT 存取權杖和 JWT 重新整理權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-414">Upon successful validation, Azure AD returns two tokens: a JWT access token and a JWT refresh token.</span></span>
7. <span data-ttu-id="6adb3-415">Web 應用程式使用傳回的 JWT 存取權杖，透過 HTTPS，在對 Web API 的要求的 Authorization 標頭中加上 JWT 字串並指定 "Bearer"。</span><span class="sxs-lookup"><span data-stu-id="6adb3-415">Over HTTPS, the web application uses the returned JWT access token to add the JWT string with a “Bearer” designation in the Authorization header of the request to the web API.</span></span> <span data-ttu-id="6adb3-416">接著，Web API 驗證 JWT 權杖，如果驗證成功，則傳回所需的資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-416">The web API then validates the JWT token, and if validation is successful, returns the desired resource.</span></span>

#### <a name="code-samples"></a><span data-ttu-id="6adb3-417">程式碼範例</span><span class="sxs-lookup"><span data-stu-id="6adb3-417">Code Samples</span></span>
<span data-ttu-id="6adb3-418">請參閱「Web 應用程式到 Web API」案例的程式碼範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-418">See the code samples for Web Application to Web API scenarios.</span></span> <span data-ttu-id="6adb3-419">請經常回來查看，我們會隨時加入新的範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-419">And, check back frequently -- we add new samples all the time.</span></span> <span data-ttu-id="6adb3-420">Web [應用程式到 Web API](active-directory-code-samples.md#web-application-to-web-api)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-420">Web [Application to Web API](active-directory-code-samples.md#web-application-to-web-api).</span></span>

#### <a name="registering"></a><span data-ttu-id="6adb3-421">註冊</span><span class="sxs-lookup"><span data-stu-id="6adb3-421">Registering</span></span>
* <span data-ttu-id="6adb3-422">單一租用戶：無論是應用程式識別或委派的使用者識別的情況，Web 應用程式和 Web API 都必須註冊在 Azure AD 的相同目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-422">Single Tenant: For both the application identity and delegated user identity cases, the web application and the web API must be registered in the same directory in Azure AD.</span></span> <span data-ttu-id="6adb3-423">Web API 可以設定為公開一組權限，用以限制 Web 應用程式對其資源的存取權。</span><span class="sxs-lookup"><span data-stu-id="6adb3-423">The web API can be configured to expose a set of permissions, which are used to limit the web application’s access to its resources.</span></span> <span data-ttu-id="6adb3-424">如果使用委派的識別類型，Web 應用程式需要從 Azure 入口網站的 [其他應用程式的權限] 下拉式功能表中，選取所需的權限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-424">If a delegated user identity type is being used, the web application needs to select the desired permissions from the “Permissions to Other Applications” drop-down menu in the Azure Portal.</span></span> <span data-ttu-id="6adb3-425">如果使用應用程式識別類型，則不需要此步驟。</span><span class="sxs-lookup"><span data-stu-id="6adb3-425">This step is not required if the application identity type is being used.</span></span>
* <span data-ttu-id="6adb3-426">多租用戶：首先，設定 Web 應用程式來指出它運作所需的權限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-426">Multi-Tenant: First, the web application is configured to indicate the permissions it requires to be functional.</span></span> <span data-ttu-id="6adb3-427">當目的地目錄中的使用者或系統管理員同意應用程式時 (使得應用程式可供組織使用)，這份必要權限清單會顯示在對話方塊中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-427">This list of required permissions is shown in a dialog when a user or administrator in the destination directory gives consent to the application, which makes it available to their organization.</span></span> <span data-ttu-id="6adb3-428">有些應用程式只需要使用者層級權限，亦即組織中的任何使用者都可同意應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-428">Some applications require just user-level permissions, which any user in the organization can consent to.</span></span> <span data-ttu-id="6adb3-429">其他應用程式需要系統管理員層級權限，亦即組織中的使用者無法同意應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-429">Other applications require administrator-level permissions, which a user in the organization cannot consent to.</span></span> <span data-ttu-id="6adb3-430">只有目錄管理員才能對需要此權限層級的應用程式表示同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-430">Only a directory administrator can give consent to applications that require this level of permissions.</span></span> <span data-ttu-id="6adb3-431">當使用者或系統管理員同意時，Web 應用程式和 Web API 都會註冊在他們的目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-431">When the user or administrator consents, the web application and the web API are both registered in their directory.</span></span>

#### <a name="token-expiration"></a><span data-ttu-id="6adb3-432">權杖到期</span><span class="sxs-lookup"><span data-stu-id="6adb3-432">Token Expiration</span></span>
<span data-ttu-id="6adb3-433">當 Web 應用程式使用其授權碼來取得 JWT 存取權杖時，它也會收到 JWT 重新整理權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-433">When the web application uses its authorization code to get a JWT access token, it also receives a JWT refresh token.</span></span> <span data-ttu-id="6adb3-434">當存取權杖到期時，重新整理權杖可用來重新驗證使用者，而不需要他們再次登入。</span><span class="sxs-lookup"><span data-stu-id="6adb3-434">When the access token expires, the refresh token can be used to re-authenticate the user without requiring them to sign in again.</span></span> <span data-ttu-id="6adb3-435">然後，此重新整理權杖用來驗證使用者，結果會產生新的存取權杖和重新整理權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-435">This refresh token is then used to authenticate the user, which results in a new access token and refresh token.</span></span>

### <a name="daemon-or-server-application-to-web-api"></a><span data-ttu-id="6adb3-436">精靈或伺服器應用程式到 Web API</span><span class="sxs-lookup"><span data-stu-id="6adb3-436">Daemon or Server Application to Web API</span></span>
<span data-ttu-id="6adb3-437">本節描述需要從 Web API 取得資源的精靈或伺服器應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-437">This section describes a daemon or server application that needs to get resources from a web API.</span></span> <span data-ttu-id="6adb3-438">有兩個子案例適用於本節：需要呼叫 Web API 且基於 OAuth 2.0 用戶端認證授與類型的精靈；需要呼叫 Web API 且基於 OAuth 2.0 On-Behalf-Of 草稿規格的伺服器應用程式 (例如 Web API)。</span><span class="sxs-lookup"><span data-stu-id="6adb3-438">There are two sub-scenarios that apply to this section: A daemon that needs to call a web API, built on OAuth 2.0 client credentials grant type; and a server application (such as a web API) that needs to call a web API, built on OAuth 2.0 On-Behalf-Of draft specification.</span></span>

<span data-ttu-id="6adb3-439">在精靈應用程式需要呼叫 Web API 的案例中，務必了解一些事情。</span><span class="sxs-lookup"><span data-stu-id="6adb3-439">For the scenario when a daemon application needs to call a web API, it’s important to understand a few things.</span></span> <span data-ttu-id="6adb3-440">首先，使用者無法與精靈應用程式互動，應用程式必須有自己的身分識別。</span><span class="sxs-lookup"><span data-stu-id="6adb3-440">First, user interaction is not possible with a daemon application, which requires the application to have its own identity.</span></span> <span data-ttu-id="6adb3-441">像是批次工作，或在背景執行的作業系統服務，就是精靈應用程式的例子。</span><span class="sxs-lookup"><span data-stu-id="6adb3-441">An example of a daemon application is a batch job, or an operating system service running in the background.</span></span> <span data-ttu-id="6adb3-442">這類應用程式會使用其應用程式識別，並向 Azure AD 出示其應用程式識別碼、認證 (密碼或憑證) 和應用程式識別碼 URI，以要求存取權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-442">This type of application requests an access token by using its application identity and presenting its Application ID, credential (password or certificate), and application ID URI to Azure AD.</span></span> <span data-ttu-id="6adb3-443">成功驗證之後，精靈會從 Azure AD 收到存取權杖，然後用來呼叫 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-443">After successful authentication, the daemon receives an access token from Azure AD, which is then used to call the web API.</span></span>

<span data-ttu-id="6adb3-444">在伺服器應用程式需要呼叫 Web API 的案例中，最好使用範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-444">For the scenario when a server application needs to call a web API, it’s helpful to use an example.</span></span> <span data-ttu-id="6adb3-445">假設使用者已在原生應用程式上驗證，而此原生應用程式需要呼叫 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-445">Imagine that a user has authenticated on a native application, and this native application needs to call a web API.</span></span> <span data-ttu-id="6adb3-446">Azure AD 會發出 JWT 存取權杖來呼叫 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-446">Azure AD issues a JWT access token to call the web API.</span></span> <span data-ttu-id="6adb3-447">如果 Web API 需要呼叫另一個下游 Web API，它可以使用代表流程來委派使用者的身分識別，並向第二層 Web API 驗證。</span><span class="sxs-lookup"><span data-stu-id="6adb3-447">If the web API needs to call another downstream web API, it can use the on-behalf-of flow to delegate the user’s identity and authenticate to the second-tier web API.</span></span>

#### <a name="diagram"></a><span data-ttu-id="6adb3-448">圖表</span><span class="sxs-lookup"><span data-stu-id="6adb3-448">Diagram</span></span>
![精靈或伺服器應用程式到 Web API 圖表](./media/active-directory-authentication-scenarios/daemon_server_app_to_web_api.png)

#### <a name="description-of-protocol-flow"></a><span data-ttu-id="6adb3-450">通訊協定流程的描述</span><span class="sxs-lookup"><span data-stu-id="6adb3-450">Description of Protocol Flow</span></span>
##### <a name="application-identity-with-oauth-20-client-credentials-grant"></a><span data-ttu-id="6adb3-451">採用 OAuth 2.0 用戶端認證授與的應用程式識別</span><span class="sxs-lookup"><span data-stu-id="6adb3-451">Application Identity with OAuth 2.0 Client Credentials Grant</span></span>
1. <span data-ttu-id="6adb3-452">首先，伺服器應用程式本身必須向 Azure AD 驗證，沒有任何人為互動，例如互動式登入對話方塊。</span><span class="sxs-lookup"><span data-stu-id="6adb3-452">First, the server application needs to authenticate with Azure AD as itself, without any human interaction such as an interactive sign-on dialog.</span></span> <span data-ttu-id="6adb3-453">它向 Azure AD 的權杖端點提出要求，並提供認證、應用程式識別碼和應用程式識別碼 URI。</span><span class="sxs-lookup"><span data-stu-id="6adb3-453">It makes a request to Azure AD’s token endpoint, providing the credential, Application ID, and application ID URI.</span></span>
2. <span data-ttu-id="6adb3-454">Azure AD 驗證應用程式，並傳回用來呼叫 Web API 的 JWT 存取權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-454">Azure AD authenticates the application and returns a JWT access token that is used to call the web API.</span></span>
3. <span data-ttu-id="6adb3-455">Web 應用程式使用傳回的 JWT 存取權杖，透過 HTTPS，在對 Web API 的要求的 Authorization 標頭中加上 JWT 字串並指定 "Bearer"。</span><span class="sxs-lookup"><span data-stu-id="6adb3-455">Over HTTPS, the web application uses the returned JWT access token to add the JWT string with a “Bearer” designation in the Authorization header of the request to the web API.</span></span> <span data-ttu-id="6adb3-456">接著，Web API 驗證 JWT 權杖，如果驗證成功，則傳回所需的資源。</span><span class="sxs-lookup"><span data-stu-id="6adb3-456">The web API then validates the JWT token, and if validation is successful, returns the desired resource.</span></span>

##### <a name="delegated-user-identity-with-oauth-20-on-behalf-of-draft-specification"></a><span data-ttu-id="6adb3-457">採用 OAuth 2.0 On-Behalf-Of 草稿規格的委派的使用者識別</span><span class="sxs-lookup"><span data-stu-id="6adb3-457">Delegated User Identity with OAuth 2.0 On-Behalf-Of Draft Specification</span></span>
<span data-ttu-id="6adb3-458">下面討論的流程假設使用者已在另一個應用程式上驗證 (例如，原生應用程式)，且其使用者識別已用來取得第一層 Web API 的存取權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-458">The flow discussed below assumes that a user has been authenticated on another application (such as a native application), and their user identity has been used to acquire an access token to the first-tier web API.</span></span>

1. <span data-ttu-id="6adb3-459">原生應用程式將存取權杖傳送到第一層 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-459">The native application sends the access token to the first-tier web API.</span></span>
2. <span data-ttu-id="6adb3-460">第一層 Web API 傳送要求至 Azure AD 的權杖端點，並提供其應用程式識別碼和認證，以及使用者的存取權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-460">The first-tier web API sends a request to Azure AD’s token endpoint, providing its Application ID and credentials, as well as the user’s access token.</span></span> <span data-ttu-id="6adb3-461">此外，傳送的要求包含 on_behalf_of 參數，指出 Web API 正在代表原始使用者要求新權杖來呼叫下游 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-461">In addition, the request is sent with an on_behalf_of parameter that indicates the web API is requesting new tokens to call a downstream web API on behalf of the original user.</span></span>
3. <span data-ttu-id="6adb3-462">Azure AD 確認第一層 Web API 有權存取第二層 Web API，並驗證要求，然後傳回 JWT 存取權杖和 JWT 重新整理權杖給第一層 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-462">Azure AD verifies that the first-tier web API has permissions to access the second-tier web API and validates the request, returning a JWT access token and a JWT refresh token to the first-tier web API.</span></span>
4. <span data-ttu-id="6adb3-463">接著，第一層 Web API 透過 HTTPS，在要求的 Authorization 標頭中附加權杖字串，以呼叫第二層 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-463">Over HTTPS, the first-tier web API then calls the second-tier web API by appending the token string in the Authorization header in the request.</span></span> <span data-ttu-id="6adb3-464">只要存取權杖和重新整理權杖有效，第一層 Web API 就可以繼續呼叫第二層 Web API。</span><span class="sxs-lookup"><span data-stu-id="6adb3-464">The first-tier web API can continue to call the second-tier web API as long as the access token and refresh tokens are valid.</span></span>

#### <a name="code-samples"></a><span data-ttu-id="6adb3-465">程式碼範例</span><span class="sxs-lookup"><span data-stu-id="6adb3-465">Code Samples</span></span>
<span data-ttu-id="6adb3-466">請參閱「精靈或伺服器應用程式到 Web API」案例的程式碼範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-466">See the code samples for Daemon or Server Application to Web API scenarios.</span></span> <span data-ttu-id="6adb3-467">請經常回來查看，我們會隨時加入新的範例。</span><span class="sxs-lookup"><span data-stu-id="6adb3-467">And, check back frequently -- we add new samples all the time.</span></span> [<span data-ttu-id="6adb3-468">伺服器或精靈應用程式到 Web API</span><span class="sxs-lookup"><span data-stu-id="6adb3-468">Server or Daemon Application to Web API</span></span>](active-directory-code-samples.md#server-or-daemon-application-to-web-api)

#### <a name="registering"></a><span data-ttu-id="6adb3-469">註冊</span><span class="sxs-lookup"><span data-stu-id="6adb3-469">Registering</span></span>
* <span data-ttu-id="6adb3-470">單一租用戶：無論是應用程式識別或委派的使用者識別的情況，精靈或伺服器應用程式都必須註冊在 Azure AD 的相同目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-470">Single Tenant: For both the application identity and delegated user identity cases, the daemon or server application must be registered in the same directory in Azure AD.</span></span> <span data-ttu-id="6adb3-471">Web API 可以設定為公開一組權限，用以限制精靈或伺服器應用程式對其資源的存取權。</span><span class="sxs-lookup"><span data-stu-id="6adb3-471">The web API can be configured to expose a set of permissions, which are used to limit the daemon or server’s access to its resources.</span></span> <span data-ttu-id="6adb3-472">如果使用委派的識別類型，伺服器應用程式需要從 Azure 入口網站的 [其他應用程式的權限] 下拉式功能表中，選取所需的權限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-472">If a delegated user identity type is being used, the server application needs to select the desired permissions from the “Permissions to Other Applications” drop-down menu in the Azure Portal.</span></span> <span data-ttu-id="6adb3-473">如果使用應用程式識別類型，則不需要此步驟。</span><span class="sxs-lookup"><span data-stu-id="6adb3-473">This step is not required if the application identity type is being used.</span></span>
* <span data-ttu-id="6adb3-474">多租用戶：首先，設定精靈或伺服器應用程式來指出它運作所需的權限。</span><span class="sxs-lookup"><span data-stu-id="6adb3-474">Multi-Tenant: First, the daemon or server application is configured to indicate the permissions it requires to be functional.</span></span> <span data-ttu-id="6adb3-475">當目的地目錄中的使用者或系統管理員同意應用程式時 (使得應用程式可供組織使用)，這份必要權限清單會顯示在對話方塊中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-475">This list of required permissions is shown in a dialog when a user or administrator in the destination directory gives consent to the application, which makes it available to their organization.</span></span> <span data-ttu-id="6adb3-476">有些應用程式只需要使用者層級權限，亦即組織中的任何使用者都可同意應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-476">Some applications require just user-level permissions, which any user in the organization can consent to.</span></span> <span data-ttu-id="6adb3-477">其他應用程式需要系統管理員層級權限，亦即組織中的使用者無法同意應用程式。</span><span class="sxs-lookup"><span data-stu-id="6adb3-477">Other applications require administrator-level permissions, which a user in the organization cannot consent to.</span></span> <span data-ttu-id="6adb3-478">只有目錄管理員才能對需要此權限層級的應用程式表示同意。</span><span class="sxs-lookup"><span data-stu-id="6adb3-478">Only a directory administrator can give consent to applications that require this level of permissions.</span></span> <span data-ttu-id="6adb3-479">當使用者或系統管理員同意時，這兩個 Web API 都會註冊在他們的目錄中。</span><span class="sxs-lookup"><span data-stu-id="6adb3-479">When the user or administrator consents, both of the web APIs are registered in their directory.</span></span>

#### <a name="token-expiration"></a><span data-ttu-id="6adb3-480">權杖到期</span><span class="sxs-lookup"><span data-stu-id="6adb3-480">Token Expiration</span></span>
<span data-ttu-id="6adb3-481">當第一個應用程式使用其授權碼來取得 JWT 存取權杖時，它也會收到 JWT 重新整理權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-481">When the first application uses its authorization code to get a JWT access token, it also receives a JWT refresh token.</span></span> <span data-ttu-id="6adb3-482">當存取權杖到期時，重新整理權杖可用來重新驗證使用者，而不會提示輸入認證。</span><span class="sxs-lookup"><span data-stu-id="6adb3-482">When the access token expires, the refresh token can be used to re-authenticate the user without prompting for credentials.</span></span> <span data-ttu-id="6adb3-483">然後，此重新整理權杖用來驗證使用者，結果會產生新的存取權杖和重新整理權杖。</span><span class="sxs-lookup"><span data-stu-id="6adb3-483">This refresh token is then used to authenticate the user, which results in a new access token and refresh token.</span></span>

## <a name="see-also"></a><span data-ttu-id="6adb3-484">另請參閱</span><span class="sxs-lookup"><span data-stu-id="6adb3-484">See Also</span></span>
[<span data-ttu-id="6adb3-485">Azure Active Directory 開發人員指南</span><span class="sxs-lookup"><span data-stu-id="6adb3-485">Azure Active Directory Developer's Guide</span></span>](active-directory-developers-guide.md)

[<span data-ttu-id="6adb3-486">Azure Active Directory 程式碼範例</span><span class="sxs-lookup"><span data-stu-id="6adb3-486">Azure Active Directory Code Samples</span></span>](active-directory-code-samples.md)

[<span data-ttu-id="6adb3-487">Azure AD 中簽署金鑰變換的相關重要資訊</span><span class="sxs-lookup"><span data-stu-id="6adb3-487">Important Information About Signing Key Rollover in Azure AD</span></span>](active-directory-signing-key-rollover.md)

[<span data-ttu-id="6adb3-488">Azure AD 中的 OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="6adb3-488">OAuth 2.0 in Azure AD</span></span>](https://msdn.microsoft.com/library/azure/dn645545.aspx)

