---
title: "如何設定應用程式 Proxy 應用程式以使用 Kerberos 限制委派 | Microsoft Docs"
description: "如何針對 Azure AD 應用程式 Proxy 應用程式設定 Kerberos 限制委派。"
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 3a768c30cb874d42d7b4fbd2eeaa6c0e23904e10
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/03/2017
---
# <a name="how-to-configure-an-application-proxy-application-to-use-kerberos-constrained-delegation"></a><span data-ttu-id="c1682-103">如何設定應用程式 Proxy 應用程式以使用 Kerberos 限制委派</span><span class="sxs-lookup"><span data-stu-id="c1682-103">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>

<span data-ttu-id="c1682-104">可用來針對已發佈應用程式達成 SSO 的方法會因應用程式而異，而 Azure 應用程式 Proxy 提供的其中一個現成選項，便是 Kerberos 限制委派 (KCD)。</span><span class="sxs-lookup"><span data-stu-id="c1682-104">The methods available for achieving SSO to published applications can somewhat vary from application to application and one of the options that Azure Application Proxy offers right out of the box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="c1682-105">我們會在此設定連接器主機，來代表使用者對後端應用程式執行受限制 Kerberos 驗證。</span><span class="sxs-lookup"><span data-stu-id="c1682-105">This is where a connector host is configured to perform constrained kerberos authentication to backend applications, on behalf of users.</span></span>

<span data-ttu-id="c1682-106">啟用 KCD 的實際程序相當簡單，使用者通常只需要大致了解達成 SSO 的各種元件和驗證流程。</span><span class="sxs-lookup"><span data-stu-id="c1682-106">The actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of the various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="c1682-107">有關 KCD SSO 無法正常運作的案例，可能較不易找到良好的疑難排解資訊來源。</span><span class="sxs-lookup"><span data-stu-id="c1682-107">Finding good sources of information to help troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="c1682-108">因此，本文嘗試提供統整的參考內容，這應該有助於針對一些常見的問題進行疑難排解和自我修復。</span><span class="sxs-lookup"><span data-stu-id="c1682-108">As such, this article attempts to provide a single point of reference that should help troubleshoot and self-remediate some of the most common issues that we see.</span></span> <span data-ttu-id="c1682-109">同時，本文也提供其他指導方針，以診斷更複雜及困難的實作。</span><span class="sxs-lookup"><span data-stu-id="c1682-109">At the same time offer additional guidance for diagnosing the more complex and troubled of implementation.</span></span>

<span data-ttu-id="c1682-110">請注意，本文會做出以下假設：</span><span class="sxs-lookup"><span data-stu-id="c1682-110">note that this article makes the following assumptions:</span></span>

-   <span data-ttu-id="c1682-111">Azure 應用程式 Proxy 已經根據我們的[文件](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable)進行部署，且針對非 KCD 應用程式的一般存取都能夠正常運作。</span><span class="sxs-lookup"><span data-stu-id="c1682-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access to non KCD applications is working as expected.</span></span>

-   <span data-ttu-id="c1682-112">已發佈的目標應用程式是以 IIS 和 Microsoft 的 Kerberos 實作為基礎。</span><span class="sxs-lookup"><span data-stu-id="c1682-112">The published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="c1682-113">伺服器和應用程式主機位於單一的 Active Directory 網域中。</span><span class="sxs-lookup"><span data-stu-id="c1682-113">The server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="c1682-114">如需有關跨網域和樹系案例的詳細資訊，請參閱 [KCD 白皮書 (英文)](http://aka.ms/KCDPaper)。</span><span class="sxs-lookup"><span data-stu-id="c1682-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="c1682-115">對象應用程式是在已啟用預先驗證的 Azure 租用戶中發佈，而且使用者必須透過表單式驗證向 Azure 驗證。</span><span class="sxs-lookup"><span data-stu-id="c1682-115">The subject application is published in an Azure tenant with pre-authentication enabled, and users are expected to authenticate to Azure via forms based authentication.</span></span> <span data-ttu-id="c1682-116">本文並未涵蓋各種豐富型用戶端驗證案例，但會於未來新增。</span><span class="sxs-lookup"><span data-stu-id="c1682-116">Rich client authentication scenarios are not covered by this article, but be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="c1682-117">必要條件</span><span class="sxs-lookup"><span data-stu-id="c1682-117">Prerequisites</span></span>

<span data-ttu-id="c1682-118">Azure 應用程式 Proxy 可以部署到幾乎所有類型的基礎結構或環境，且架構當然會隨組織而有所不同。</span><span class="sxs-lookup"><span data-stu-id="c1682-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and the architectures no doubt vary from organization to organization.</span></span> <span data-ttu-id="c1682-119">造成 KCD 相關問題最常見的一個原因並不是環境本身，而僅僅是設定錯誤或一般性的疏忽。</span><span class="sxs-lookup"><span data-stu-id="c1682-119">One of the most common causes of KCD related issues are not the environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="c1682-120">基於這個理由，建議您在開始進行疑難排解之前，先確定您已滿足我們主要的[使用 KCD SSO 搭配應用程式 Proxy 文章](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)中所述的所有必要條件。</span><span class="sxs-lookup"><span data-stu-id="c1682-120">For this reason, our advice is always to start by making sure you have met all the pre-requisites laid out in our main [Using KCD SSO with the Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="c1682-121">特別是在 2012R2 上設定 KCD 的小節，因為這會採用與在舊版 Windows 上設定 KCD 完全不同的方式。但同時您也應留意其他數個考量：</span><span class="sxs-lookup"><span data-stu-id="c1682-121">Particularly the section on configuring KCD on 2012R2, as this employs a fundamentally different approach to configuring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="c1682-122">由於網域成員伺服器開啟與特定網域控制站的安全通道對話，</span><span class="sxs-lookup"><span data-stu-id="c1682-122">It is not uncommon for a domain member server to open a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="c1682-123">然後隨時變更至另一個對話的情況並不罕見，因此連接器主機通常並不應該限制為僅能與特定本機網站 DC 通訊。</span><span class="sxs-lookup"><span data-stu-id="c1682-123">Then move to another dialog at any given time, so connector hosts should generally not be restricted to being able to communicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="c1682-124">類似於上一點，跨網域案例依賴將連接器主機導向至 DC 的轉介，且該 DC 可能位於本機網路周邊之外。</span><span class="sxs-lookup"><span data-stu-id="c1682-124">Similar to the above point, cross domain scenarios rely on referrals that direct a connector host to DCs that may reside outside of the local network perimeter.</span></span> <span data-ttu-id="c1682-125">在此案例中，請同樣務必確定您也允許流向代表其他個別網域之 DC 的流量，否則委派會失敗。</span><span class="sxs-lookup"><span data-stu-id="c1682-125">In this scenario it is equally important to make sure you are also allowing traffic onwards to DCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="c1682-126">您應該盡可能避免在連接器主機和 DC 之間放置任何作用中的 IPS/IDS 裝置，因為這些裝置有時候會侵入及干擾核心 RPC 流量</span><span class="sxs-lookup"><span data-stu-id="c1682-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="c1682-127">雖然我們都想要盡快且有效地解決問題，但整體的工作可能會相當耗時，因此您應該盡可能在最簡單的案例中嘗試並測試委派。</span><span class="sxs-lookup"><span data-stu-id="c1682-127">As much as we’d like to resolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in the simplest of scenarios.</span></span> <span data-ttu-id="c1682-128">您加入越多的變數，就需要應付更多的問題。</span><span class="sxs-lookup"><span data-stu-id="c1682-128">The more variables you introduce, the more you may have to contend with.</span></span> <span data-ttu-id="c1682-129">例如，將您的測試限制為單一連接器可以節省寶貴的時間，其他的連接器則可以在問題解決後再加入。</span><span class="sxs-lookup"><span data-stu-id="c1682-129">For example, limiting your testing to a single connector can save valuable time, and additional connectors can be added after the issues has been resolved.</span></span>

<span data-ttu-id="c1682-130">有些環境因素也可能造成問題，因此我們在此再次提醒您，請盡可能嘗試將架構縮減為最低限度來進行測試。</span><span class="sxs-lookup"><span data-stu-id="c1682-130">Some environmental factors may also be contributing to an issue, so again if possible try and minimize the architecture to a bare minimum for testing.</span></span> <span data-ttu-id="c1682-131">例如，由於內部防火牆 ACL 設定錯誤的情況並不罕見，因此可能的話，請允許來自連接器的所有流量直接通往 DC 和後端應用程式。</span><span class="sxs-lookup"><span data-stu-id="c1682-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through to the DCs and backend application.</span></span> 

<span data-ttu-id="c1682-132">事實上，放置連接器的最佳位置便是讓它盡可能接近其目標。</span><span class="sxs-lookup"><span data-stu-id="c1682-132">Actually the absolute best place to position connectors is as close to their targets as can be.</span></span> <span data-ttu-id="c1682-133">在測試同時設置內嵌的防火牆，只會增加不必要的複雜性，而且可能會延長您的調查時間。</span><span class="sxs-lookup"><span data-stu-id="c1682-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="c1682-134">所以，KCD 問題到底是由什麼構成？</span><span class="sxs-lookup"><span data-stu-id="c1682-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="c1682-135">有數個常見的徵兆會指出 KCD SSO 失敗，而問題的第一個徵兆通常會在瀏覽器中出現。</span><span class="sxs-lookup"><span data-stu-id="c1682-135">Well, there several classic indications of KCD SSO failing and the first signs of an issue usually manifest themselves in the browser.</span></span>

   ![不正確的 KCD 組態錯誤](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![因為缺少權限而導致授權失敗](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="c1682-138">這些都有無法執行 SSO 的相同徵狀，並因此拒絕使用者存取應用程式。</span><span class="sxs-lookup"><span data-stu-id="c1682-138">all which bear the same symptom of failing to perform SSO, and consequently denying the user access to the application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="c1682-139">疑難排解</span><span class="sxs-lookup"><span data-stu-id="c1682-139">Troubleshooting</span></span>

<span data-ttu-id="c1682-140">接著，您必須根據問題與觀察到的徵狀來進行疑難排解。</span><span class="sxs-lookup"><span data-stu-id="c1682-140">How you then troubleshoot depend on the issue and observed symptoms.</span></span> <span data-ttu-id="c1682-141">在進一步之前，建議您先參閱下列連結，其中可能包含您尚未了解的有用資訊：</span><span class="sxs-lookup"><span data-stu-id="c1682-141">Before going any further we would suggest the following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="c1682-142">針對應用程式 Proxy 問題和錯誤訊息進行疑難排解</span><span class="sxs-lookup"><span data-stu-id="c1682-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="c1682-143">Kerberos 錯誤與徵狀</span><span class="sxs-lookup"><span data-stu-id="c1682-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="c1682-144">在內部部署和雲端身分識別不相同時使用 SSO</span><span class="sxs-lookup"><span data-stu-id="c1682-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="c1682-145">如果您已經進行到這裡，則必然存在主要問題。</span><span class="sxs-lookup"><span data-stu-id="c1682-145">If you’ve got this far, then the main issue definitely exists.</span></span> <span data-ttu-id="c1682-146">您必須更深入地鑽研，因此我們會先將流程分為可以進行疑難排解的三個不同階段。</span><span class="sxs-lookup"><span data-stu-id="c1682-146">You need to dig deeper, so start by separating the flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="c1682-147">**用戶端預先驗證**：外部使用者透過瀏覽器向 Azure 進行驗證。</span><span class="sxs-lookup"><span data-stu-id="c1682-147">**Client pre-authentication** - The external user authenticating to Azure via a browser.</span></span>

<span data-ttu-id="c1682-148">KCD SSO 若要運作，必須要能夠向 Azure 進行預先驗證。</span><span class="sxs-lookup"><span data-stu-id="c1682-148">Being able to pre-authenticate to Azure is imperative for KCD SSO to function.</span></span> <span data-ttu-id="c1682-149">如果有發生任何問題，便應該先測試並解決這項問題。</span><span class="sxs-lookup"><span data-stu-id="c1682-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="c1682-150">請注意，預先驗證階段與 KCD 或已發佈的應用程式無關。</span><span class="sxs-lookup"><span data-stu-id="c1682-150">Note that the pre-authentication stage has no relation to KCD or the published application.</span></span> <span data-ttu-id="c1682-151">透過例行性檢查 Azure 中是否存在對象帳戶，且該帳戶是否被停用/封鎖，應該就能輕鬆地修正任何不一致。</span><span class="sxs-lookup"><span data-stu-id="c1682-151">It should be fairly easy to correct any discrepancies by sanity checking the subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="c1682-152">瀏覽器中的錯誤回應，通常便能提供足夠的資訊以了解原因。</span><span class="sxs-lookup"><span data-stu-id="c1682-152">The error response in the browser is usually descriptive enough to understand the cause.</span></span> <span data-ttu-id="c1682-153">如果您無法確定，也可以查看我們其他的疑難排解文件。</span><span class="sxs-lookup"><span data-stu-id="c1682-153">You can also check our other Troubleshoot docs to verify if you aren’t sure.</span></span>

<span data-ttu-id="c1682-154">**委派服務**：代表使用者從 KDC (Kerberos 發佈中心) 取得 Kerberos 服務票證的 Azure Proxy 連接器。</span><span class="sxs-lookup"><span data-stu-id="c1682-154">**Delegation service** - The Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="c1682-155">用戶端與 Azure 前端之間的外部通訊，除了確保 KCD 正常運作外，應該和 KCD 沒有任何關係。</span><span class="sxs-lookup"><span data-stu-id="c1682-155">The external communications between the client and the Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="c1682-156">這是為了使 Azure Proxy 服務可以獲得用來取得 Kerberos 票證的有效使用者識別碼。</span><span class="sxs-lookup"><span data-stu-id="c1682-156">This is so the Azure Proxy service can be provided with a valid user ID that be used to obtain a kerberos ticket.</span></span> <span data-ttu-id="c1682-157">如果不這麼做，就無法使用 KCD 並且會失敗。</span><span class="sxs-lookup"><span data-stu-id="c1682-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="c1682-158">如先前所述，瀏覽器錯誤訊息通常會針對失敗的原因提供一些很好的線索。</span><span class="sxs-lookup"><span data-stu-id="c1682-158">As mentioned previously, the browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="c1682-159">請務必記下回應中的活動識別碼和時間戳記，因為這可讓您將行為與 Azure Proxy 事件記錄檔中的實際事件相互關聯。</span><span class="sxs-lookup"><span data-stu-id="c1682-159">Make sure to note down the activity ID and timestamp in the response as this allow you to correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![不正確的 KCD 組態錯誤](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="c1682-161">而事件記錄檔中看到的對應項目，會被視為事件 13019 或 12027。</span><span class="sxs-lookup"><span data-stu-id="c1682-161">And the corresponding entries seen the event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="c1682-162">您可以在 [應用程式及服務記錄檔] &gt; [Microsoft] &gt; [AadApplicationProxy] &gt; [連接器] &gt; [管理] 中找到連接器事件記錄檔。</span><span class="sxs-lookup"><span data-stu-id="c1682-162">You can find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![應用程式 Proxy 事件記錄檔中的事件 13019](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![應用程式 Proxy 事件記錄檔中的事件 12027](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="c1682-165">在您的內部 DNS 中針對應用程式位址使用 A 記錄，而非 CName</span><span class="sxs-lookup"><span data-stu-id="c1682-165">Use an A record in your internal DNS for the application’s address, and not a CName</span></span>

-   <span data-ttu-id="c1682-166">重新確認連接器主機已授與權限以委派至指定目標帳戶的 SPN，而且已選取 [使用任何驗證通訊協定]。</span><span class="sxs-lookup"><span data-stu-id="c1682-166">Re-confirm that the connector host has been granted the rights to delegate to the designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="c1682-167">這部分涵蓋於我們主要的 [SSO 組態文章](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span><span class="sxs-lookup"><span data-stu-id="c1682-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="c1682-168">確定 AD 中只存在單一 SPN 執行個體，方法是從任何網域成員主機上的命令提示字元發出 **setspn -x**</span><span class="sxs-lookup"><span data-stu-id="c1682-168">Verify that there is only a single instance of the SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="c1682-169">檢查是否強制執行網域原則來限制[發出的 Kerberos 權杖大小上限 (英文)](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/)，因為這會在超過上限的情況下防止連接器取得權杖</span><span class="sxs-lookup"><span data-stu-id="c1682-169">Check to see if a domain policy is being enforced to limit the [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent the connector from obtaining a token if found to be excessive</span></span>

<span data-ttu-id="c1682-170">擷取連接器主機和網域 KDC 之間交換的網路追蹤，將會是針對問題取得更低層級詳細資料的下一個最佳步驟。</span><span class="sxs-lookup"><span data-stu-id="c1682-170">A network trace capturing the exchanges between the connector host and a domain KDC would then be the next best step in obtaining more low level detail on the issues.</span></span> <span data-ttu-id="c1682-171">您可以在[深入探討疑難排解文件 (英文)](https://aka.ms/proxytshootpaper) 中找到此資訊。</span><span class="sxs-lookup"><span data-stu-id="c1682-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="c1682-172">如果票證看起來沒問題，則您應該會在記錄檔中看到事件，指出因應用程式傳回 401 而導致驗證失敗。</span><span class="sxs-lookup"><span data-stu-id="c1682-172">If ticketing looks good, you should see an event in the logs stating that authentication failed due to the application returning a 401.</span></span> <span data-ttu-id="c1682-173">這通常表示目標應用程式拒絕您的票證，因此請繼續進行接下來的下一個階段。</span><span class="sxs-lookup"><span data-stu-id="c1682-173">This typically indicates that the target application rejecting your ticket, so proceed with the following next stage.</span></span>

<span data-ttu-id="c1682-174">**目標應用程式**：連接器所提供之 Kerberos 票證的取用者</span><span class="sxs-lookup"><span data-stu-id="c1682-174">**Target application** - The consumer of the kerberos ticket provided by the connector</span></span>

<span data-ttu-id="c1682-175">在這個階段，連接器應該已經以第一個應用程式要求內之標頭的形式，將 Kerberos 服務票證傳送到後端。</span><span class="sxs-lookup"><span data-stu-id="c1682-175">At this stage the connector is expected to have sent a kerberos service ticket to the backend, as a header within the first application request.</span></span>

-   <span data-ttu-id="c1682-176">使用應用程式在入口網站中定義的內部 URL，驗證應用程式可從連接器主機上的瀏覽器直接存取。</span><span class="sxs-lookup"><span data-stu-id="c1682-176">Using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="c1682-177">然後您就可以成功登入。</span><span class="sxs-lookup"><span data-stu-id="c1682-177">Then you can login successfully.</span></span> <span data-ttu-id="c1682-178">執行此操作的詳細資料，可在 [連接器疑難排解] 頁面上找到。</span><span class="sxs-lookup"><span data-stu-id="c1682-178">Details on doing this can be found on the connector Troubleshoot page.</span></span>

-   <span data-ttu-id="c1682-179">在連接器主機上繼續確認瀏覽器與應用程式之間的驗證使用 Kerberos，方法是執行下列動作：</span><span class="sxs-lookup"><span data-stu-id="c1682-179">Still on the connector host, confirm that the authentication between the browser and the application is using kerberos, by doing one of the following:</span></span>

1.  <span data-ttu-id="c1682-180">在 Internet Explorer 中執行開發工具 (**F12**)，或從連接器主機使用 [Fiddler (英文)](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/)。</span><span class="sxs-lookup"><span data-stu-id="c1682-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="c1682-181">使用內部 URL 移至應用程式，然後檢查應用程式回應中傳回的 WWW 授權標頭，以確保存在交涉或 Kerberos。</span><span class="sxs-lookup"><span data-stu-id="c1682-181">Go to the application using the internal URL, and inspect the offered WWW authorization headers returned in the response from the application, to ensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="c1682-182">在瀏覽器至應用程式的回應中傳回的後續 Kerberos Blob，通常會以 **YII** 做為開頭，因此這是一個判斷 Kerberos 可以使用的最佳指標。</span><span class="sxs-lookup"><span data-stu-id="c1682-182">A subsequent kerberos blob returned in the response from the browser to the application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="c1682-183">另一方面，NTLM 一律會以 **TlRMTVNTUAAB** 做為開頭，它會在從 Base64 解碼的情況下讀取 NTLMSSP。</span><span class="sxs-lookup"><span data-stu-id="c1682-183">NTLM on the other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="c1682-184">如果您在 Blob 的開頭看到 **TlRMTVNTUAAB**，便表示「無法」使用 Kerberos。</span><span class="sxs-lookup"><span data-stu-id="c1682-184">If you see **TlRMTVNTUAAB** at the start of the blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="c1682-185">如果您沒有看到它，則應該可以使用 Kerberos。</span><span class="sxs-lookup"><span data-stu-id="c1682-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="c1682-186">請注意，如果使用 Fiddler，這個方法需要在 IIS 中的應用程式設定上將延伸保護暫時停用。</span><span class="sxs-lookup"><span data-stu-id="c1682-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on the application’s config in IIS.</span></span>

     ![瀏覽器網路檢查視窗](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="c1682-188">*圖：*由於這個開頭不是 TIRMTVNTUAAB，所以 Kerberos 在此範例中可以使用。</span><span class="sxs-lookup"><span data-stu-id="c1682-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="c1682-189">這是 Kerberos Blob 開頭不是 YII 的範例。</span><span class="sxs-lookup"><span data-stu-id="c1682-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="c1682-190">暫時從 IIS 網站上的提供者清單移除 NTLM，然後直接從連接器主機上的 IE 存取應用程式。</span><span class="sxs-lookup"><span data-stu-id="c1682-190">Temporarily remove NTLM from the providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="c1682-191">當提供者清單中不存在 NTLM 時，您應該便只能使用 Kerberos 存取應用程式。</span><span class="sxs-lookup"><span data-stu-id="c1682-191">With NTLM no longer in the providers list, you should be able to access the application using Kerberos only.</span></span> <span data-ttu-id="c1682-192">如果失敗，則表示應用程式的設定有問題，且 Kerberos 驗證無法正常運作。</span><span class="sxs-lookup"><span data-stu-id="c1682-192">If this fails, then that suggests that there is a problem with the application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="c1682-193">如果 Kerberos 無法使用，請接著檢查 IIS 中的應用程式驗證設定，以確定交涉已列於最上層，而 NTLM 則位於它的下方。</span><span class="sxs-lookup"><span data-stu-id="c1682-193">If Kerberos is not available, then check the application’s authentication settings in IIS to make sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="c1682-194">(不是 Negotiate:kerberos 或 Negotiate:PKU2U)。</span><span class="sxs-lookup"><span data-stu-id="c1682-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="c1682-195">只有在 Kerberos 能正常運作的情況下才繼續。</span><span class="sxs-lookup"><span data-stu-id="c1682-195">Only continue if Kerberos is functional.</span></span>

   ![Windows 驗證提供者](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="c1682-197">Kerberos 和 NTLM 就位之後，現在請暫時在入口網站中停用應用程式的預先驗證。</span><span class="sxs-lookup"><span data-stu-id="c1682-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="c1682-198">查看您是否能使用外部 URL 從網際網路存取它。</span><span class="sxs-lookup"><span data-stu-id="c1682-198">See if you can access it from the internet using the external URL.</span></span> <span data-ttu-id="c1682-199">系統應該會提示您進行驗證，而您應該可以使用上一個步驟中的相同帳戶進行驗證。</span><span class="sxs-lookup"><span data-stu-id="c1682-199">You should be prompted to authenticate and should be able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="c1682-200">如果不行，這表示問題是在後端應用程式，而與 KCD 完全無關。</span><span class="sxs-lookup"><span data-stu-id="c1682-200">If not, this indicates a problem with the backend application and not KCD at all.</span></span>

-   <span data-ttu-id="c1682-201">現在，請重新在入口網站中啟用預先驗證，並嘗試透過應用程式的外部 URL 連線到應用程式，來透過 Azure 驗證。</span><span class="sxs-lookup"><span data-stu-id="c1682-201">Now re-enable pre-authentication in the portal and authenticate through Azure by attempting to connect to the application via it’s external URL.</span></span> <span data-ttu-id="c1682-202">如果 SSO 失敗，則您應該會在瀏覽器中看到禁止錯誤訊息，並在記錄檔中看見事件 13022：</span><span class="sxs-lookup"><span data-stu-id="c1682-202">If SSO has failed, then you should see a forbidden error message in the browser, plus event 13022 in the log:</span></span>

    <span data-ttu-id="c1682-203">「因為後端伺服器以 HTTP 401 錯誤回應 Kerberos 驗證嘗試，Microsoft AAD 應用程式 Proxy 連接器便無法驗證使用者。」</span><span class="sxs-lookup"><span data-stu-id="c1682-203">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![HTTP 401 禁止錯誤](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="c1682-205">檢查 IIS 應用程式，確定設定的應用程式集區已設定為使用 SPN 針對 AD 所設定的相同帳戶，方法是以下列方法瀏覽至 IIS 中</span><span class="sxs-lookup"><span data-stu-id="c1682-205">Check the IIS application to ensure the configured application pool is configured to use the same account that the SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![IIS 應用程式組態視窗](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="c1682-207">一旦您知道身分識別後，請從命令提示字元中發出下列命令，以確定此帳戶確實是搭配目標 SPN 進行設定。</span><span class="sxs-lookup"><span data-stu-id="c1682-207">Once you know the identity, issue the following from a cmd prompt to make sure this account is definitely configured with the SPN in question.</span></span> <span data-ttu-id="c1682-208">例如，**setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="c1682-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![SetSPN 命令視窗](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="c1682-210">檢查入口網站中針對應用程式的設定所定義的 SPN，是否與針對應用程式之應用集區所使用的目標 AD 帳戶所設定的 SPN 相同</span><span class="sxs-lookup"><span data-stu-id="c1682-210">Check that the SPN defined against the application’s settings in the portal is the same SPN that is configured against the target AD account in use by the application’s app pool</span></span>

   ![Azure 入口網站中的 SPN 組態](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="c1682-212">移至 IIS 並選取應用程式的 [設定編輯器] 選項，然後瀏覽至 **system.webServer/security/authentication/windowsAuthentication** 以確定 **UseAppPoolCredentials** 已設定為 true</span><span class="sxs-lookup"><span data-stu-id="c1682-212">Go into IIS and select the **Configuration Editor** option for the application, and navigate to **system.webServer/security/authentication/windowsAuthentication** to make sure that **UseAppPoolCredentials** is set to true</span></span>

   ![IIS 設定應用程式集區認證選項](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="c1682-214">雖然保留核心模式啟用對於改善 Kerberos 作業的效能很有用，但這也會導致要求之服務的票證可以使用電腦帳戶解密。</span><span class="sxs-lookup"><span data-stu-id="c1682-214">While being useful in improving the performance of Kerberos operations, leaving Kernel mode enabled also causes the ticket for the requested service to be decrypted using machine account.</span></span> <span data-ttu-id="c1682-215">這也稱為本機系統，因此當應用程式裝載於伺服器陣列中的多部伺服器上時，將此設定設為 true 將會中斷 KCD。</span><span class="sxs-lookup"><span data-stu-id="c1682-215">This is also called the Local system, so having this set to true break KCD when the application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="c1682-216">做為額外的檢查，您也可以停用「延伸」保護。</span><span class="sxs-lookup"><span data-stu-id="c1682-216">As an additional check, you may also want to disable the **Extended** protection too.</span></span> <span data-ttu-id="c1682-217">曾經有發生過案例，證明在非常特定的組態 (其中應用程式被發佈為預設網站的子資料夾) 啟用此保護時會中斷 KCD。</span><span class="sxs-lookup"><span data-stu-id="c1682-217">There have been encountered scenarios where this has proved to break KCD when enabled in very specific configurations, where an application is published as a sub folder of the Default Web site.</span></span> <span data-ttu-id="c1682-218">此保護本身僅會針對匿名驗證進行設定，並使整個對話方塊呈現灰色，表示子物件不會繼承任何作用中的設定。</span><span class="sxs-lookup"><span data-stu-id="c1682-218">This itself is configured for Anonymous authentication only, leaving the entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="c1682-219">但可能的話，我們還是會建議一律啟用此保護，因此在測試完畢之後，請記得將它還原為啟用狀態。</span><span class="sxs-lookup"><span data-stu-id="c1682-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget to restore this to enabled.</span></span>

<span data-ttu-id="c1682-220">這些額外的測試應該可以讓您開始使用已發佈的應用程式。</span><span class="sxs-lookup"><span data-stu-id="c1682-220">These additional checks should have put you on track to start using your published application.</span></span> <span data-ttu-id="c1682-221">您可以開始啟動其他已設定進行委派的連接器，但如果狀況沒有進展，建議您閱讀更多深入的技術逐步解說：[針對 Azure AD 應用程式 Proxy 進行疑難排解的完整指南 (英文)](https://aka.ms/proxytshootpaper)</span><span class="sxs-lookup"><span data-stu-id="c1682-221">You can go ahead and spin up additional connectors that are also configured to delegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="c1682-222">如果您仍無法處理問題，支援人員會很樂意接手並提供協助。</span><span class="sxs-lookup"><span data-stu-id="c1682-222">If you’re still unable to progress your issue, support would be more than happy to assist and continue from here.</span></span> <span data-ttu-id="c1682-223">請直接在入口網站內建立支援票證，我們的工程師將會連絡您。</span><span class="sxs-lookup"><span data-stu-id="c1682-223">Create a support ticket directly within the portal and our engineers will reach out to you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="c1682-224">其他案例</span><span class="sxs-lookup"><span data-stu-id="c1682-224">Other scenarios</span></span>

-   <span data-ttu-id="c1682-225">Azure 應用程式 Proxy 會在將要求傳送至應用程式之前要求 Kerberos 票證。</span><span class="sxs-lookup"><span data-stu-id="c1682-225">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="c1682-226">某些協力廠商應用程式 (例如 Tableau Server) 不會使用此驗證方法，而會預期更加傳統的交涉方式。</span><span class="sxs-lookup"><span data-stu-id="c1682-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects the more conventional negotiations to take place,.</span></span> <span data-ttu-id="c1682-227">第一個要求是匿名的，可讓應用程式透過 401 回應它所支援的驗證類型。</span><span class="sxs-lookup"><span data-stu-id="c1682-227">The first request is anonymous, allowing the application to respond with the authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="c1682-228">雙躍點驗證：常用於應用程式已分層並具有後端與前端，且兩者皆需要驗證的案例 (例如 SQL Reporting Services)。</span><span class="sxs-lookup"><span data-stu-id="c1682-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="c1682-229">後續步驟</span><span class="sxs-lookup"><span data-stu-id="c1682-229">Next steps</span></span>
[<span data-ttu-id="c1682-230">在受管理的網域上設定 Kerberos 限制委派 (KCD)</span><span class="sxs-lookup"><span data-stu-id="c1682-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
