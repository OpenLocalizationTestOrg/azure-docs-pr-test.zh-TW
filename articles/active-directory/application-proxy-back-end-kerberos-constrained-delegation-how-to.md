---
title: "aaaHow tooconfigure 應用程式 Proxy 應用程式 toouse Kerberos 限制委派 |Microsoft 文件"
description: "如何針對 Azure AD Application Proxy 應用程式的 tooconfigure Kerberos 限制委派。"
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 93dac264ff1d3b99dead1d9c759c37c59373cbd4
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="how-tooconfigure-an-application-proxy-application-toouse-kerberos-constrained-delegation"></a><span data-ttu-id="6f4cc-103">如何 tooconfigure 應用程式 Proxy 應用程式 toouse Kerberos 限制委派</span><span class="sxs-lookup"><span data-stu-id="6f4cc-103">How tooconfigure an Application Proxy application toouse Kerberos Constrained Delegation</span></span>

<span data-ttu-id="6f4cc-104">hello 達成 SSO toopublished 應用程式可以稍微不同應用程式 tooapplication 和 Azure 應用程式 Proxy 提供現成 hello 右邊 hello 選項的其中一個可用的方法是 Kerberos 限制委派 (KCD)。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-104">hello methods available for achieving SSO toopublished applications can somewhat vary from application tooapplication and one of hello options that Azure Application Proxy offers right out of hello box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="6f4cc-105">這是連接器主機是限制的設定的 tooperform kerberos 驗證 toobackend 應用程式，代表使用者的位置。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-105">This is where a connector host is configured tooperform constrained kerberos authentication toobackend applications, on behalf of users.</span></span>

<span data-ttu-id="6f4cc-106">hello 啟用 KCD 的實際程序較為簡單，而且通常需要有基本認識的 hello 以內，各種元件和可加速 SSO 執行的驗證流程。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-106">hello actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of hello various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="6f4cc-107">尋找良好來源的資訊 toohelp 疑難排解的案例 where KCD SSO 未如預期般函式，可以為疏鬆。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-107">Finding good sources of information toohelp troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="6f4cc-108">因此，這篇文章會嘗試 tooprovide 的參考，這樣應該有助於疑難排解和自我補救 hello 最常見的問題，我們會看到單一點。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-108">As such, this article attempts tooprovide a single point of reference that should help troubleshoot and self-remediate some of hello most common issues that we see.</span></span> <span data-ttu-id="6f4cc-109">在 hello 相同時間提供其他指導方針診斷 hello 越複雜，雖然實作。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-109">At hello same time offer additional guidance for diagnosing hello more complex and troubled of implementation.</span></span>

<span data-ttu-id="6f4cc-110">請注意，這篇文章會使 hello 下列假設：</span><span class="sxs-lookup"><span data-stu-id="6f4cc-110">note that this article makes hello following assumptions:</span></span>

-   <span data-ttu-id="6f4cc-111">為每個已部署 azure 應用程式 Proxy 我們[文件](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable)與一般存取 toonon KCD 應用程式是否正常運作。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access toonon KCD applications is working as expected.</span></span>

-   <span data-ttu-id="6f4cc-112">hello 已發行的目標應用程式為基礎的 kerberos IIS 和 Microsoft 的實作。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-112">hello published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="6f4cc-113">hello 伺服器和應用程式的主機位於單一 Active Directory 網域中。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-113">hello server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="6f4cc-114">如需有關跨網域和樹系案例的詳細資訊，請參閱 [KCD 白皮書 (英文)](http://aka.ms/KCDPaper)。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="6f4cc-115">hello 主旨發行應用程式在 Azure 中使用預先驗證已啟用，租用戶和使用者應 tooauthenticate tooAzure 透過表單型驗證。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-115">hello subject application is published in an Azure tenant with pre-authentication enabled, and users are expected tooauthenticate tooAzure via forms based authentication.</span></span> <span data-ttu-id="6f4cc-116">豐富型用戶端驗證案例未涵蓋的本文中，但加入 hello 未來某些時候。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-116">Rich client authentication scenarios are not covered by this article, but be added at some point in hello future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="6f4cc-117">必要條件</span><span class="sxs-lookup"><span data-stu-id="6f4cc-117">Prerequisites</span></span>

<span data-ttu-id="6f4cc-118">Azure 應用程式 Proxy 可以部署到幾乎任何類型的基礎結構，或環境和 hello 毫無疑問架構，從組織 tooorganization。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and hello architectures no doubt vary from organization tooorganization.</span></span> <span data-ttu-id="6f4cc-119">KCD hello 最常見原因之一相關的問題不是 hello 環境本身，但相當簡單的錯誤組態或一般監督。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-119">One of hello most common causes of KCD related issues are not hello environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="6f4cc-120">基於這個理由，我們建議是一律 toostart 藉由確定您已符合所有 hello 先決條件配置在我們的主要[與 hello 應用程式 Proxy 發行項使用 KCD SSO](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)之前開始疑難排解。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-120">For this reason, our advice is always toostart by making sure you have met all hello pre-requisites laid out in our main [Using KCD SSO with hello Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="6f4cc-121">在設定 KCD 2012R2，因為這會採用舊版的 Windows，但同時會記住的數個其他考量，在本質上不同的方法 tooconfiguring KCD 的特別 hello 區段：</span><span class="sxs-lookup"><span data-stu-id="6f4cc-121">Particularly hello section on configuring KCD on 2012R2, as this employs a fundamentally different approach tooconfiguring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="6f4cc-122">不是網域成員伺服器 tooopen 含有特定網域控制站的安全通道對話罕見狀況。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-122">It is not uncommon for a domain member server tooopen a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="6f4cc-123">然後將 tooanother 對話方塊在任何時候，這樣連接器主機通常不應該限制的 toobeing 無法 toocommunicate 只在特定的本機站台的 dc。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-123">Then move tooanother dialog at any given time, so connector hosts should generally not be restricted toobeing able toocommunicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="6f4cc-124">類似上述點 toohello，跨網域案例依賴直接可能位於 hello 本機網路周邊外部連接器主機 tooDCs 的轉介。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-124">Similar toohello above point, cross domain scenarios rely on referrals that direct a connector host tooDCs that may reside outside of hello local network perimeter.</span></span> <span data-ttu-id="6f4cc-125">在此案例中是同樣重要 toomake 確定您也允許將流量起 tooDCs 代表其他個別的網域，或是委派失敗。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-125">In this scenario it is equally important toomake sure you are also allowing traffic onwards tooDCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="6f4cc-126">您應該盡可能避免在連接器主機和 DC 之間放置任何作用中的 IPS/IDS 裝置，因為這些裝置有時候會侵入及干擾核心 RPC 流量</span><span class="sxs-lookup"><span data-stu-id="6f4cc-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="6f4cc-127">一樣，我們都希望 tooresolve 問題快速並有效地，它可能需要的時間，因此可能您應該再次嘗試並測試委派 hello 最簡單的案例中。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-127">As much as we’d like tooresolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in hello simplest of scenarios.</span></span> <span data-ttu-id="6f4cc-128">hello 您引入的多個變數，hello 多則可能需要與 toocontend。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-128">hello more variables you introduce, hello more you may have toocontend with.</span></span> <span data-ttu-id="6f4cc-129">例如，限制測試 tooa 單一連接器，可以節省寶貴的時間，而 hello 問題解決之後，就可以加入其他連接器。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-129">For example, limiting your testing tooa single connector can save valuable time, and additional connectors can be added after hello issues has been resolved.</span></span>

<span data-ttu-id="6f4cc-130">某些環境因素，可能也造成 tooan 問題，所以再次如果可能再試一次，並盡可能縮短 hello 架構 tooa 最低限度的測試。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-130">Some environmental factors may also be contributing tooan issue, so again if possible try and minimize hello architecture tooa bare minimum for testing.</span></span> <span data-ttu-id="6f4cc-131">例如，內部防火牆的設定不正確的 Acl 並不常見，因此如果可能的話從連接器，可直接通過 toohello Dc 和後端應用程式的所有流量。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through toohello DCs and backend application.</span></span> 

<span data-ttu-id="6f4cc-132">實際上 hello 絕對最佳地方 tooposition 連接器是接近 tootheir 目標都可以。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-132">Actually hello absolute best place tooposition connectors is as close tootheir targets as can be.</span></span> <span data-ttu-id="6f4cc-133">在測試同時設置內嵌的防火牆，只會增加不必要的複雜性，而且可能會延長您的調查時間。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="6f4cc-134">所以，KCD 問題到底是由什麼構成？</span><span class="sxs-lookup"><span data-stu-id="6f4cc-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="6f4cc-135">也那里數個傳統的指示 KCD SSO 失敗，且 hello 第一個問題徵兆通常是資訊清單本身中的 hello 瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-135">Well, there several classic indications of KCD SSO failing and hello first signs of an issue usually manifest themselves in hello browser.</span></span>

   ![不正確的 KCD 組態錯誤](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![授權失敗，因為 toomissing 權限](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="6f4cc-138">所有都帶有 hello 相同徵狀失敗 tooperform SSO，因此拒絕哪些 hello 使用者存取 toohello 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-138">all which bear hello same symptom of failing tooperform SSO, and consequently denying hello user access toohello application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="6f4cc-139">疑難排解</span><span class="sxs-lookup"><span data-stu-id="6f4cc-139">Troubleshooting</span></span>

<span data-ttu-id="6f4cc-140">然後解決方式取決於 hello 問題及觀察到的徵兆。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-140">How you then troubleshoot depend on hello issue and observed symptoms.</span></span> <span data-ttu-id="6f4cc-141">將任何之前進一步會建議 hello 下列連結，因為它們可能會不尚未已有的實用資訊：</span><span class="sxs-lookup"><span data-stu-id="6f4cc-141">Before going any further we would suggest hello following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="6f4cc-142">針對應用程式 Proxy 問題和錯誤訊息進行疑難排解</span><span class="sxs-lookup"><span data-stu-id="6f4cc-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="6f4cc-143">Kerberos 錯誤與徵狀</span><span class="sxs-lookup"><span data-stu-id="6f4cc-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="6f4cc-144">在內部部署和雲端身分識別不相同時使用 SSO</span><span class="sxs-lookup"><span data-stu-id="6f4cc-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="6f4cc-145">如果您已有此到目前為止，然後 hello 主要問題確實存在。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-145">If you’ve got this far, then hello main issue definitely exists.</span></span> <span data-ttu-id="6f4cc-146">您需要 toodig 更深入，因此啟動分隔 hello 流入進行疑難排解的三個階段。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-146">You need toodig deeper, so start by separating hello flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="6f4cc-147">**用戶端預先驗證**-驗證透過瀏覽器 tooAzure hello 外部使用者。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-147">**Client pre-authentication** - hello external user authenticating tooAzure via a browser.</span></span>

<span data-ttu-id="6f4cc-148">要能 toopre-驗證 KCD SSO toofunction tooAzure 務必。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-148">Being able toopre-authenticate tooAzure is imperative for KCD SSO toofunction.</span></span> <span data-ttu-id="6f4cc-149">如果有發生任何問題，便應該先測試並解決這項問題。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="6f4cc-150">請注意，hello 預先驗證階段的任何關聯 tooKCD 或 hello 發行應用程式。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-150">Note that hello pre-authentication stage has no relation tooKCD or hello published application.</span></span> <span data-ttu-id="6f4cc-151">它應該是相當簡單 toocorrect 任何不一致的例行性檢查 hello 主體帳戶存在於 Azure，而不是已停用/遭到封鎖。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-151">It should be fairly easy toocorrect any discrepancies by sanity checking hello subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="6f4cc-152">hello hello 瀏覽器中的錯誤回應是描述性通常足以 toounderstand hello 原因。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-152">hello error response in hello browser is usually descriptive enough toounderstand hello cause.</span></span> <span data-ttu-id="6f4cc-153">如果您不確定，您也可以查看我們其他疑難排解文件 tooverify。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-153">You can also check our other Troubleshoot docs tooverify if you aren’t sure.</span></span>

<span data-ttu-id="6f4cc-154">**委派服務**-hello 代表使用者取得 kerberos 服務票證 KDC （Kerberos 配送中心），從 Azure Proxy 連接器。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-154">**Delegation service** - hello Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="6f4cc-155">hello hello 用戶端與 hello Azure 前端之間的外部通訊上至少應有並無任何影響 KCD 恕不另行通知，而不是確保正常運作。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-155">hello external communications between hello client and hello Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="6f4cc-156">這是使 hello Azure Proxy 服務能夠提供有效的使用者識別碼，會使用的 tooobtain kerberos 票證。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-156">This is so hello Azure Proxy service can be provided with a valid user ID that be used tooobtain a kerberos ticket.</span></span> <span data-ttu-id="6f4cc-157">如果不這麼做，就無法使用 KCD 並且會失敗。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="6f4cc-158">如先前所述，hello 瀏覽器的錯誤訊息通常會提供一些很好的線索上作業失敗的原因。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-158">As mentioned previously, hello browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="6f4cc-159">請確定 toonote 下 hello 活動識別碼和時間戳記 hello 回應，因為這可讓您 toocorrelate hello 行為 tooactual 事件 hello Azure Proxy 事件記錄檔中。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-159">Make sure toonote down hello activity ID and timestamp in hello response as this allow you toocorrelate hello behavior tooactual events in hello Azure Proxy event log.</span></span>

   ![不正確的 KCD 組態錯誤](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="6f4cc-161">和 hello 看到的 hello 事件記錄檔會被視為 13019 或 12027 事件對應項目。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-161">And hello corresponding entries seen hello event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="6f4cc-162">您可以找到 hello 連接器中的事件記錄檔**Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt;**連接器**&gt;**Admin**。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-162">You can find hello connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![應用程式 Proxy 事件記錄檔中的事件 13019](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![應用程式 Proxy 事件記錄檔中的事件 12027](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="6f4cc-165">在您的內部 DNS 使用 A 記錄 hello 應用程式的位址，以及不 CName</span><span class="sxs-lookup"><span data-stu-id="6f4cc-165">Use an A record in your internal DNS for hello application’s address, and not a CName</span></span>

-   <span data-ttu-id="6f4cc-166">重新確認 hello 連接器裝載授與 hello 目標帳戶的 SPN，及所指定的權限 toodelegate toohello**使用任何驗證通訊協定**已選取。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-166">Re-confirm that hello connector host has been granted hello rights toodelegate toohello designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="6f4cc-167">這部分涵蓋於我們主要的 [SSO 組態文章](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span><span class="sxs-lookup"><span data-stu-id="6f4cc-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="6f4cc-168">請確認有 hello SPN 是否存在，在 AD 中的單一執行個體發出**setspn-x**從任何網域的成員主機的 cmd 命令提示字元</span><span class="sxs-lookup"><span data-stu-id="6f4cc-168">Verify that there is only a single instance of hello SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="6f4cc-169">檢查 toosee 如果網域原則強制執行 toolimit hello[發出的 kerberos 權杖的大小上限](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/)，如這個防止 hello 連接器從取得權杖，如果找到 toobe 過多</span><span class="sxs-lookup"><span data-stu-id="6f4cc-169">Check toosee if a domain policy is being enforced toolimit hello [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent hello connector from obtaining a token if found toobe excessive</span></span>

<span data-ttu-id="6f4cc-170">網路追蹤擷取 hello hello 連接器主機與 KDC 的網域之間的交換將 hello 下一個最佳的步驟中取得更低層級詳細資料在 hello 問題。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-170">A network trace capturing hello exchanges between hello connector host and a domain KDC would then be hello next best step in obtaining more low level detail on hello issues.</span></span> <span data-ttu-id="6f4cc-171">您可以在[深入探討疑難排解文件 (英文)](https://aka.ms/proxytshootpaper) 中找到此資訊。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="6f4cc-172">如果票證看來正常，您應該會看到指出該驗證失敗，因為傳回 401 toohello 應用程式的 hello 記錄檔中的事件。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-172">If ticketing looks good, you should see an event in hello logs stating that authentication failed due toohello application returning a 401.</span></span> <span data-ttu-id="6f4cc-173">這通常表示拒絕您的票證該 hello 目標應用程式，因此進行 hello 遵循下一個階段。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-173">This typically indicates that hello target application rejecting your ticket, so proceed with hello following next stage.</span></span>

<span data-ttu-id="6f4cc-174">**目標應用程式**-hello hello 連接器所提供的 kerberos 票證的 hello 取用者</span><span class="sxs-lookup"><span data-stu-id="6f4cc-174">**Target application** - hello consumer of hello kerberos ticket provided by hello connector</span></span>

<span data-ttu-id="6f4cc-175">在此階段 hello 連接器會預期的 toohave kerberos 服務票證 toohello 後端，以傳送 hello 第一個應用程式要求中的標頭。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-175">At this stage hello connector is expected toohave sent a kerberos service ticket toohello backend, as a header within hello first application request.</span></span>

-   <span data-ttu-id="6f4cc-176">使用 hello 應用程式驗證 hello 應用程式是可從 hello hello 連接器主機上的瀏覽器直接存取內部定義在 hello 入口網站的 URL。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-176">Using hello application’s internal URL defined in hello portal, validate that hello application is accessible directly from hello browser on hello connector host.</span></span> <span data-ttu-id="6f4cc-177">然後您就可以成功登入。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-177">Then you can login successfully.</span></span> <span data-ttu-id="6f4cc-178">Hello 連接器疑難排解頁面上，就可以找到有關執行此操作的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-178">Details on doing this can be found on hello connector Troubleshoot page.</span></span>

-   <span data-ttu-id="6f4cc-179">仍在 hello 連接器主機上，確認該 hello 之間驗證 hello 瀏覽器和 hello 應用程式使用 kerberos，hello 下列其中一項動作：</span><span class="sxs-lookup"><span data-stu-id="6f4cc-179">Still on hello connector host, confirm that hello authentication between hello browser and hello application is using kerberos, by doing one of hello following:</span></span>

1.  <span data-ttu-id="6f4cc-180">執行開發人員工具 (**F12**) 在 Internet Explorer 中或使用[Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/)從 hello 連接器主機。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from hello connector host.</span></span> <span data-ttu-id="6f4cc-181">移 toohello 應用程式使用 hello 內部 URL，並檢查提供 WWW 授權標頭傳回 hello 回應 hello 應用程式中的 hello、 tooensure 交涉或 kerberos 存在於。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-181">Go toohello application using hello internal URL, and inspect hello offered WWW authorization headers returned in hello response from hello application, tooensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="6f4cc-182">後續 kerberos blob 傳回 hello 回應 hello 瀏覽器 toohello 從應用程式通常會以開頭**YII**，因此這是正在播放的 kerberos 有助於。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-182">A subsequent kerberos blob returned in hello response from hello browser toohello application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="6f4cc-183">NTLM 上 hello 另一方面一律以啟動**TlRMTVNTUAAB**，讀取 NTLMSSP 時從 Base64 解碼。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-183">NTLM on hello other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="6f4cc-184">如果您看到**TlRMTVNTUAAB**在 hello blob hello 開頭，這表示 Kerberos 是**不**可用。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-184">If you see **TlRMTVNTUAAB** at hello start of hello blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="6f4cc-185">如果您沒有看到它，則應該可以使用 Kerberos。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="6f4cc-186">請注意，如果使用 Fiddler，這個方法可能必須暫時停用在 IIS 中的 hello 應用程式組態上的擴充的保護。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on hello application’s config in IIS.</span></span>

     ![瀏覽器網路檢查視窗](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="6f4cc-188">*圖：*由於這個開頭不是 TIRMTVNTUAAB，所以 Kerberos 在此範例中可以使用。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="6f4cc-189">這是 Kerberos Blob 開頭不是 YII 的範例。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="6f4cc-190">暫時移除 hello 的提供者清單上 IIS 站台及存取應用程式直接從 IE 連接器主機上的 NTLM。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-190">Temporarily remove NTLM from hello providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="6f4cc-191">Ntlm 不會再在 hello 的提供者清單中，您應該只使用 Kerberos 無法 tooaccess hello 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-191">With NTLM no longer in hello providers list, you should be able tooaccess hello application using Kerberos only.</span></span> <span data-ttu-id="6f4cc-192">如果這個作業失敗，然後建議是 hello 應用程式的組態有問題，Kerberos 驗證無法正常運作。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-192">If this fails, then that suggests that there is a problem with hello application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="6f4cc-193">如果 Kerberos 無法使用，核取 hello 應用程式的驗證設定，確定 IIS toomake 中的交涉會列出最上層，NTLM 下方直接使用。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-193">If Kerberos is not available, then check hello application’s authentication settings in IIS toomake sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="6f4cc-194">(不是 Negotiate:kerberos 或 Negotiate:PKU2U)。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="6f4cc-195">只有在 Kerberos 能正常運作的情況下才繼續。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-195">Only continue if Kerberos is functional.</span></span>

   ![Windows 驗證提供者](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="6f4cc-197">Kerberos 和 NTLM 備妥，可讓現在會暫時停用 hello hello 入口網站中的應用程式的預先驗證。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for hello application in hello portal.</span></span> <span data-ttu-id="6f4cc-198">請參閱是否可以存取它 hello 從網際網路使用 hello 外部 URL。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-198">See if you can access it from hello internet using hello external URL.</span></span> <span data-ttu-id="6f4cc-199">您應該是提示的 tooauthenticate，並且應該能夠 toodo，因此 hello 與使用相同帳戶中使用的 hello 上一個步驟。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-199">You should be prompted tooauthenticate and should be able toodo so with hello same account used in hello previous step.</span></span> <span data-ttu-id="6f4cc-200">如果沒有的話，這表示根本問題 hello 後端應用程式及不 KCD。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-200">If not, this indicates a problem with hello backend application and not KCD at all.</span></span>

-   <span data-ttu-id="6f4cc-201">現在重新啟用 hello 入口網站中的預先驗證，並嘗試 tooconnect toohello 應用程式，透過它的外部 URL，透過 Azure 進行驗證。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-201">Now re-enable pre-authentication in hello portal and authenticate through Azure by attempting tooconnect toohello application via it’s external URL.</span></span> <span data-ttu-id="6f4cc-202">如果 SSO 失敗時，您應該看到 hello 瀏覽器中，加上事件 13022 hello 記錄檔中的 「 禁止 」 錯誤訊息：</span><span class="sxs-lookup"><span data-stu-id="6f4cc-202">If SSO has failed, then you should see a forbidden error message in hello browser, plus event 13022 in hello log:</span></span>

    <span data-ttu-id="6f4cc-203">*Microsoft AAD 應用程式 Proxy 連接器無法驗證 hello 使用者，因為 hello 後端伺服器會回應與 HTTP 401 錯誤 tooKerberos 驗證嘗試。*</span><span class="sxs-lookup"><span data-stu-id="6f4cc-203">*Microsoft AAD Application Proxy Connector cannot authenticate hello user because hello backend server responds tooKerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![HTTP 401 禁止錯誤](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="6f4cc-205">請檢查 hello IIS 應用程式 tooensure hello 設定應用程式集區已設定的 toouse hello 相同 hello SPN 的帳戶已針對在 AD 中，如下所示，在 IIS 中瀏覽</span><span class="sxs-lookup"><span data-stu-id="6f4cc-205">Check hello IIS application tooensure hello configured application pool is configured toouse hello same account that hello SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![IIS 應用程式組態視窗](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="6f4cc-207">一旦您知道 hello 身分識別時，發出下列確定明確設定此帳戶以 hello SPN 有問題的 cmd 提示 toomake hello。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-207">Once you know hello identity, issue hello following from a cmd prompt toomake sure this account is definitely configured with hello SPN in question.</span></span> <span data-ttu-id="6f4cc-208">例如，**setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="6f4cc-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![SetSPN 命令視窗](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="6f4cc-210">請檢查該 hello hello 入口網站中的 hello 應用程式設定中定義的 SPN 是 hello 相同設定針對 hello 應用程式的應用程式集區的使用中的 hello 目標 AD 帳戶的 SPN</span><span class="sxs-lookup"><span data-stu-id="6f4cc-210">Check that hello SPN defined against hello application’s settings in hello portal is hello same SPN that is configured against hello target AD account in use by hello application’s app pool</span></span>

   ![Azure 入口網站中的 SPN 組態](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="6f4cc-212">切換至 IIS 和選取 hello**組態編輯器**選項 hello 應用程式，並瀏覽過**system.webServer/security/authentication/windowsAuthentication** toomake 確定該**UseAppPoolCredentials**設定 tootrue</span><span class="sxs-lookup"><span data-stu-id="6f4cc-212">Go into IIS and select hello **Configuration Editor** option for hello application, and navigate too**system.webServer/security/authentication/windowsAuthentication** toomake sure that **UseAppPoolCredentials** is set tootrue</span></span>

   ![IIS 設定應用程式集區認證選項](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="6f4cc-214">同時會用於改善 hello 的 Kerberos 作業的效能，離開啟用核心模式也會導致 hello hello 票證要求服務 toobe 解密使用電腦帳戶。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-214">While being useful in improving hello performance of Kerberos operations, leaving Kernel mode enabled also causes hello ticket for hello requested service toobe decrypted using machine account.</span></span> <span data-ttu-id="6f4cc-215">這也稱為 hello 本機系統，因此需要這組 tootrue 中斷 KCD hello 應用程式裝載在伺服器陣列中的多部伺服器時。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-215">This is also called hello Local system, so having this set tootrue break KCD when hello application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="6f4cc-216">額外的檢查，您可能也想 toodisable hello**擴充**保護太。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-216">As an additional check, you may also want toodisable hello **Extended** protection too.</span></span> <span data-ttu-id="6f4cc-217">已有這已經在此證明 toobreak KCD 非常特定的組態中啟用時的情況下遇到應用程式發行為 hello 預設的網站的子資料夾的位置。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-217">There have been encountered scenarios where this has proved toobreak KCD when enabled in very specific configurations, where an application is published as a sub folder of hello Default Web site.</span></span> <span data-ttu-id="6f4cc-218">此本身設定為匿名驗證，離開 hello 整個對話灰色建議子物件就不會繼承目前使用的設定。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-218">This itself is configured for Anonymous authentication only, leaving hello entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="6f4cc-219">但其中一律建議需要啟用，這可能因此由所有是測試，但不要忘記此 tooenabled toorestore。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget toorestore this tooenabled.</span></span>

<span data-ttu-id="6f4cc-220">這些額外的檢查應該出您追蹤 toostart 使用已發行應用程式上。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-220">These additional checks should have put you on track toostart using your published application.</span></span> <span data-ttu-id="6f4cc-221">您可以繼續，還有其他連接器向上微調設定 toodelegate，但如果沒有其他進一步的事情就會接著會建議我們更深入技術的逐步解說的讀取[hello 疑難排解 Azure AD 應用程式的完整指南Proxy](https://aka.ms/proxytshootpaper)</span><span class="sxs-lookup"><span data-stu-id="6f4cc-221">You can go ahead and spin up additional connectors that are also configured toodelegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [hello complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="6f4cc-222">如果您仍然無法 tooprogress 您的問題，支援會超過高興 tooassist，且繼續從這裡。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-222">If you’re still unable tooprogress your issue, support would be more than happy tooassist and continue from here.</span></span> <span data-ttu-id="6f4cc-223">建立支援票證，直接在 hello 入口網站中的，我們的工程師會聯繫 tooyou。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-223">Create a support ticket directly within hello portal and our engineers will reach out tooyou.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="6f4cc-224">其他案例</span><span class="sxs-lookup"><span data-stu-id="6f4cc-224">Other scenarios</span></span>

-   <span data-ttu-id="6f4cc-225">Azure 應用程式 Proxy 將要求傳送其要求 tooan 應用程式之前，先 Kerberos 票證。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-225">Azure Application Proxy requests a Kerberos ticket before sending its request tooan application.</span></span> <span data-ttu-id="6f4cc-226">某些第 3 個合作對象應用程式，例如 Tableau Server 不喜歡的驗證，這個方法並而不是預期的 hello 傳統交涉 tootake 地點。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects hello more conventional negotiations tootake place,.</span></span> <span data-ttu-id="6f4cc-227">hello 第一個要求是匿名的允許 hello 應用程式 toorespond 與 hello 401 透過支援的驗證類型。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-227">hello first request is anonymous, allowing hello application toorespond with hello authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="6f4cc-228">雙躍點驗證：常用於應用程式已分層並具有後端與前端，且兩者皆需要驗證的案例 (例如 SQL Reporting Services)。</span><span class="sxs-lookup"><span data-stu-id="6f4cc-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="6f4cc-229">後續步驟</span><span class="sxs-lookup"><span data-stu-id="6f4cc-229">Next steps</span></span>
[<span data-ttu-id="6f4cc-230">在受管理的網域上設定 Kerberos 限制委派 (KCD)</span><span class="sxs-lookup"><span data-stu-id="6f4cc-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
