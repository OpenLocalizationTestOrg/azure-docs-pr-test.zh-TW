---
title: "Azure 流量管理員 - 流量路由方法 | Microsoft Docs"
description: "本文將協助您了解流量管理員所使用的不同流量路由方法"
services: traffic-manager
documentationcenter: 
author: KumudD
manager: timlt
editor: 
ms.assetid: db1efbf6-6762-4c7a-ac99-675d4eeb54d0
ms.service: traffic-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 07/13/2017
ms.author: kumud
ms.openlocfilehash: fe776e24a4f78b389c6096694055b38befa3c419
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/03/2017
---
# <a name="traffic-manager-routing-methods"></a><span data-ttu-id="8a66d-103">流量管理員路由方法</span><span class="sxs-lookup"><span data-stu-id="8a66d-103">Traffic Manager routing methods</span></span>

<span data-ttu-id="8a66d-104">Azure 流量管理員支援四種流量路由方法，以決定如何將網路流量路由傳送至不同的服務端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-104">Azure Traffic Manager supports four traffic-routing methods to determine how to route network traffic to the various service endpoints.</span></span> <span data-ttu-id="8a66d-105">流量管理員會將流量路由方法套用至它收到的每個 DNS 查詢。</span><span class="sxs-lookup"><span data-stu-id="8a66d-105">Traffic Manager applies the traffic-routing method to each DNS query it receives.</span></span> <span data-ttu-id="8a66d-106">流量路由方法決定 DNS 回應中傳回哪一個端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-106">The traffic-routing method determines which endpoint returned in the DNS response.</span></span>

<span data-ttu-id="8a66d-107">流量管理員中提供四種流量路由方法：</span><span class="sxs-lookup"><span data-stu-id="8a66d-107">There are four traffic routing methods available in Traffic Manager:</span></span>

* <span data-ttu-id="8a66d-108">**[優先順序](#priority)：**如果您想要針對所有流量使用某個主要服務端點，請選取 [優先順序]，並提供備用方案，以防萬一發生主要端點或備份端點無法使用的情況。</span><span class="sxs-lookup"><span data-stu-id="8a66d-108">**[Priority](#priority):** Select **Priority** when you want to use a primary service endpoint for all traffic, and provide backups in case the primary or the backup endpoints are unavailable.</span></span>
* <span data-ttu-id="8a66d-109">**[加權](#weighted)︰**如果您想要將流量分配給一組端點 (不論是平均分配還是根據您定義的權數)，請選取 [加權]。</span><span class="sxs-lookup"><span data-stu-id="8a66d-109">**[Weighted](#weighted):** Select **Weighted** when you want to distribute traffic across a set of endpoints, either evenly or according to weights, which you define.</span></span>
* <span data-ttu-id="8a66d-110">**[效能](#performance)：**如果您的端點位於不同的地理位置，而您希望使用者使用「最靠近」(亦即網路延遲最低) 的端點，請選取 [效能]。</span><span class="sxs-lookup"><span data-stu-id="8a66d-110">**[Performance](#performance):** Select **Performance** when you have endpoints in different geographic locations and you want end users to use the "closest" endpoint in terms of the lowest network latency.</span></span>
* <span data-ttu-id="8a66d-111">**[地理](#geographic)︰**選取 [地理]，以根據使用者的 DNS 查詢來自哪個地理位置，將使用者導向特定端點 (Azure、外部或巢狀)。</span><span class="sxs-lookup"><span data-stu-id="8a66d-111">**[Geographic](#geographic):** Select **Geographic** so that users are directed to specific endpoints (Azure, External, or Nested) based on which geographic location their DNS query originates from.</span></span> <span data-ttu-id="8a66d-112">在必須知道使用者的地理區域，並據以路由傳送使用者的情況下，這可讓流量管理員客戶應付自如。</span><span class="sxs-lookup"><span data-stu-id="8a66d-112">This empowers Traffic Manager customers to enable scenarios where knowing a user’s geographic region and routing them based on that is important.</span></span> <span data-ttu-id="8a66d-113">例如，遵守資料主權規定、內容和使用者經驗的當地語系化，以及測量來自不同區域的流量。</span><span class="sxs-lookup"><span data-stu-id="8a66d-113">Examples include complying with data sovereignty mandates, localization of content & user experience and measuring traffic from different regions.</span></span>

<span data-ttu-id="8a66d-114">所有流量管理員設定檔都支援監視端點健康狀態和自動容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="8a66d-114">All Traffic Manager profiles include monitoring of endpoint health and automatic endpoint failover.</span></span> <span data-ttu-id="8a66d-115">如需詳細資訊，請參閱 [流量管理員端點監視](traffic-manager-monitoring.md)。</span><span class="sxs-lookup"><span data-stu-id="8a66d-115">For more information, see [Traffic Manager Endpoint Monitoring](traffic-manager-monitoring.md).</span></span> <span data-ttu-id="8a66d-116">單一「流量管理員」設定檔只能使用一個流量路由方法。</span><span class="sxs-lookup"><span data-stu-id="8a66d-116">A single Traffic Manager profile can use only one traffic routing method.</span></span> <span data-ttu-id="8a66d-117">您可以隨時為您的設定檔選取不同的流量路由方法。</span><span class="sxs-lookup"><span data-stu-id="8a66d-117">You can select a different traffic routing method for your profile at any time.</span></span> <span data-ttu-id="8a66d-118">變更會在 1 分鐘內套用，不會造成任何停機時間。</span><span class="sxs-lookup"><span data-stu-id="8a66d-118">Changes are applied within one minute, and no downtime is incurred.</span></span> <span data-ttu-id="8a66d-119">透過使用巢狀「流量管理員」設定檔可以將流量路由方法加以結合。</span><span class="sxs-lookup"><span data-stu-id="8a66d-119">Traffic-routing methods can be combined by using nested Traffic Manager profiles.</span></span> <span data-ttu-id="8a66d-120">巢狀可讓您建立精密又有彈性的流量路由設定，以滿足更大又複雜的應用程式的需求。</span><span class="sxs-lookup"><span data-stu-id="8a66d-120">Nesting enables sophisticated and flexible traffic-routing configurations that meet the needs of larger, complex applications.</span></span> <span data-ttu-id="8a66d-121">如需詳細資訊，請參閱 [巢狀流量管理員設定檔](traffic-manager-nested-profiles.md)。</span><span class="sxs-lookup"><span data-stu-id="8a66d-121">For more information, see [nested Traffic Manager profiles](traffic-manager-nested-profiles.md).</span></span>

## <span data-ttu-id="8a66d-122"><a name = "priority"></a>優先順序流量路由方法</span><span class="sxs-lookup"><span data-stu-id="8a66d-122"><a name = "priority"></a>Priority traffic-routing method</span></span>

<span data-ttu-id="8a66d-123">組織通常會部署一或多個備份服務，以防萬一主要服務停止運作時，可確保服務的可靠性。</span><span class="sxs-lookup"><span data-stu-id="8a66d-123">Often an organization wants to provide reliability for its services by deploying one or more backup services in case their primary service goes down.</span></span> <span data-ttu-id="8a66d-124">「優先順序」流量路由方法可讓 Azure 客戶輕鬆實作此容錯移轉模式。</span><span class="sxs-lookup"><span data-stu-id="8a66d-124">The 'Priority' traffic-routing method allows Azure customers to easily implement this failover pattern.</span></span>

![Azure 流量管理員「優先順序」流量路由方法][1]

<span data-ttu-id="8a66d-126">流量管理員設定檔包含服務端點的優先順序清單。</span><span class="sxs-lookup"><span data-stu-id="8a66d-126">The Traffic Manager profile contains a prioritized list of service endpoints.</span></span> <span data-ttu-id="8a66d-127">根據預設，流量管理員會將所有流量傳送至主要 (最高優先順序) 端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-127">By default, Traffic Manager sends all traffic to the primary (highest-priority) endpoint.</span></span> <span data-ttu-id="8a66d-128">如果主要端點無法使用，流量管理員會將流量路由傳送至第二個端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-128">If the primary endpoint is not available, Traffic Manager routes the traffic to the second endpoint.</span></span> <span data-ttu-id="8a66d-129">如果主要和次要端點都無法供使用，系統就會將流量傳送到第三個端點，依此類推。</span><span class="sxs-lookup"><span data-stu-id="8a66d-129">If both the primary and secondary endpoints are not available, the traffic goes to the third, and so on.</span></span> <span data-ttu-id="8a66d-130">端點的可用性是取決於已設定的狀態 (已啟用或已停用) 和持續的端點監視。</span><span class="sxs-lookup"><span data-stu-id="8a66d-130">Availability of the endpoint is based on the configured status (enabled or disabled) and the ongoing endpoint monitoring.</span></span>

### <a name="configuring-endpoints"></a><span data-ttu-id="8a66d-131">設定端點</span><span class="sxs-lookup"><span data-stu-id="8a66d-131">Configuring endpoints</span></span>

<span data-ttu-id="8a66d-132">在 Azure Resource Manager 中，您可以使用「優先順序」屬性來明確設定每個端點的點端優先順序。</span><span class="sxs-lookup"><span data-stu-id="8a66d-132">With Azure Resource Manager, you configure the endpoint priority explicitly using the 'priority' property for each endpoint.</span></span> <span data-ttu-id="8a66d-133">這個屬性的值介於 1 到 1000 之間。</span><span class="sxs-lookup"><span data-stu-id="8a66d-133">This property is a value between 1 and 1000.</span></span> <span data-ttu-id="8a66d-134">值越低代表優先順序越高。</span><span class="sxs-lookup"><span data-stu-id="8a66d-134">Lower values represent a higher priority.</span></span> <span data-ttu-id="8a66d-135">端點無法共用優先順序值。</span><span class="sxs-lookup"><span data-stu-id="8a66d-135">Endpoints cannot share priority values.</span></span> <span data-ttu-id="8a66d-136">設定屬性是選擇性的。</span><span class="sxs-lookup"><span data-stu-id="8a66d-136">Setting the property is optional.</span></span> <span data-ttu-id="8a66d-137">如果省略，則會使用以端點順序為基礎的預設優先順序。</span><span class="sxs-lookup"><span data-stu-id="8a66d-137">When omitted, a default priority based on the endpoint order is used.</span></span>

##<span data-ttu-id="8a66d-138"><a name = "weighted"></a>加權流量路由方法</span><span class="sxs-lookup"><span data-stu-id="8a66d-138"><a name = "weighted"></a>Weighted traffic-routing method</span></span>
<span data-ttu-id="8a66d-139">「加權」流量路由方法可讓您平均分散流量，或使用預先定義的權數。</span><span class="sxs-lookup"><span data-stu-id="8a66d-139">The 'Weighted' traffic-routing method allows you to distribute traffic evenly or to use a pre-defined weighting.</span></span>

![Azure 流量管理員「加權」流量路由方法][2]

<span data-ttu-id="8a66d-141">在「加權」流量路由方法中，您需要在流量管理員設定檔設定中指派權數給每個端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-141">In the Weighted traffic-routing method, you assign a weight to each endpoint in the Traffic Manager profile configuration.</span></span> <span data-ttu-id="8a66d-142">權數是從 1 到 1000 的整數。</span><span class="sxs-lookup"><span data-stu-id="8a66d-142">The weight is an integer from 1 to 1000.</span></span> <span data-ttu-id="8a66d-143">這是選擇性參數。</span><span class="sxs-lookup"><span data-stu-id="8a66d-143">This parameter is optional.</span></span> <span data-ttu-id="8a66d-144">如果省略，流量管理員會使用預設權數 '1'。</span><span class="sxs-lookup"><span data-stu-id="8a66d-144">If omitted, Traffic Managers uses a default weight of '1'.</span></span>

<span data-ttu-id="8a66d-145">針對每個收到的 DNS 查詢，流量管理員會隨機選擇可用的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-145">For each DNS query received, Traffic Manager randomly chooses an available endpoint.</span></span> <span data-ttu-id="8a66d-146">選擇端點的機率是根據指派給所有可用端點的權數。</span><span class="sxs-lookup"><span data-stu-id="8a66d-146">The probability of choosing an endpoint is based on the weights assigned to all available endpoints.</span></span> <span data-ttu-id="8a66d-147">所有端點都使用相同的權數會形成平均的流量分配。</span><span class="sxs-lookup"><span data-stu-id="8a66d-147">Using the same weight across all endpoints results in an even traffic distribution.</span></span> <span data-ttu-id="8a66d-148">在特定端點上使用較高或較低的權數會導致 DNS 回應中較經常或較不常傳回這些端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-148">Using higher or lower weights on specific endpoints causes those endpoints to be returned more or less frequently in the DNS responses.</span></span>

<span data-ttu-id="8a66d-149">加權方法支援一些實用的案例︰</span><span class="sxs-lookup"><span data-stu-id="8a66d-149">The weighted method enables some useful scenarios:</span></span>

* <span data-ttu-id="8a66d-150">應用程式逐步升級：配置要路由傳送到新端點的流量百分比，並隨時間逐漸增加流量到 100%。</span><span class="sxs-lookup"><span data-stu-id="8a66d-150">Gradual application upgrade: Allocate a percentage of traffic to route to a new endpoint, and gradually increase the traffic over time to 100%.</span></span>
* <span data-ttu-id="8a66d-151">應用程式移轉至 Azure︰建立具有 Azure 和外部端點的設定檔。</span><span class="sxs-lookup"><span data-stu-id="8a66d-151">Application migration to Azure: Create a profile with both Azure and external endpoints.</span></span> <span data-ttu-id="8a66d-152">調整端點的權數來優先使用新的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-152">Adjust the weight of the endpoints to prefer the new endpoints.</span></span>
* <span data-ttu-id="8a66d-153">額外容量的雲端負載平衡：將內部部署快速展開到雲端的方式是將它放在流量管理員設定檔後面。</span><span class="sxs-lookup"><span data-stu-id="8a66d-153">Cloud-bursting for additional capacity: Quickly expand an on-premises deployment into the cloud by putting it behind a Traffic Manager profile.</span></span> <span data-ttu-id="8a66d-154">當您需要在雲端中增加額外容量時，您可以新增或啟用更多的端點並指定進入每個端點的流量比例。</span><span class="sxs-lookup"><span data-stu-id="8a66d-154">When you need extra capacity in the cloud, you can add or enable more endpoints and specify what portion of traffic goes to each endpoint.</span></span>

<span data-ttu-id="8a66d-155">資源管理員 Azure 入口網站支援設定加權流量路由。</span><span class="sxs-lookup"><span data-stu-id="8a66d-155">The Resource Manager Azure portal supports the configuration of weighted traffic routing.</span></span>  <span data-ttu-id="8a66d-156">您可以使用 Resource Manager 版本的 Azure PowerShell、CLI 和 REST API 來設定加權。</span><span class="sxs-lookup"><span data-stu-id="8a66d-156">You can configure weights using the Resource Manager versions of Azure PowerShell, CLI, and the REST APIs.</span></span>

<span data-ttu-id="8a66d-157">請務必了解用戶端和用戶端用來解析 DNS 名稱的遞迴 DNS 伺服器會快取 DNS 回應。</span><span class="sxs-lookup"><span data-stu-id="8a66d-157">It is important to understand that DNS responses are cached by clients and by the recursive DNS servers that the clients use to resolve DNS names.</span></span> <span data-ttu-id="8a66d-158">此快取可能會影響加權的流量分配。</span><span class="sxs-lookup"><span data-stu-id="8a66d-158">This caching can have an impact on weighted traffic distributions.</span></span> <span data-ttu-id="8a66d-159">有大量用戶端和遞迴 DNS 伺服器時，流量分配會正常運作。</span><span class="sxs-lookup"><span data-stu-id="8a66d-159">When the number of clients and recursive DNS servers is large, traffic distribution works as expected.</span></span> <span data-ttu-id="8a66d-160">不過，如果只有少量用戶端或遞迴 DNS 伺服器，則快取可能會大幅扭曲流量分配。</span><span class="sxs-lookup"><span data-stu-id="8a66d-160">However, when the number of clients or recursive DNS servers is small, caching can significantly skew the traffic distribution.</span></span>

<span data-ttu-id="8a66d-161">常見使用案例包括：</span><span class="sxs-lookup"><span data-stu-id="8a66d-161">Common use cases include:</span></span>

* <span data-ttu-id="8a66d-162">開發與測試環境</span><span class="sxs-lookup"><span data-stu-id="8a66d-162">Development and testing environments</span></span>
* <span data-ttu-id="8a66d-163">應用程式間通訊</span><span class="sxs-lookup"><span data-stu-id="8a66d-163">Application-to-application communications</span></span>
* <span data-ttu-id="8a66d-164">以較小的使用者群為對象的應用程式，有共同的遞迴 DNS 基礎結構 (例如，透過 Proxy 連接的公司員工)</span><span class="sxs-lookup"><span data-stu-id="8a66d-164">Applications aimed at a narrow user-base that share a common recursive DNS infrastructure (for example, employees of company connecting through a proxy)</span></span>

<span data-ttu-id="8a66d-165">這些 DNS 快取效果對所有 DNS 型流量路由系統來說很常見，不僅限於「Azure 流量管理員」。</span><span class="sxs-lookup"><span data-stu-id="8a66d-165">These DNS caching effects are common to all DNS-based traffic routing systems, not just Azure Traffic Manager.</span></span> <span data-ttu-id="8a66d-166">在某些情況下，明確清除 DNS 快取也許是一種因應措施。</span><span class="sxs-lookup"><span data-stu-id="8a66d-166">In some cases, explicitly clearing the DNS cache may provide a workaround.</span></span> <span data-ttu-id="8a66d-167">在其他情況下，使用替代的流量路由方法可能更為合適。</span><span class="sxs-lookup"><span data-stu-id="8a66d-167">In other cases, an alternative traffic-routing method may be more appropriate.</span></span>

## <span data-ttu-id="8a66d-168"><a name = "performance"></a>效能流量路由方法</span><span class="sxs-lookup"><span data-stu-id="8a66d-168"><a name = "performance"></a>Performance traffic-routing method</span></span>

<span data-ttu-id="8a66d-169">如果將端點部署在全球的兩個或更多個位置，然後將流量路由傳送至「最靠近」您的位置，即可改善許多應用程式的回應速度。</span><span class="sxs-lookup"><span data-stu-id="8a66d-169">Deploying endpoints in two or more locations across the globe can improve the responsiveness of many applications by routing traffic to the location that is 'closest' to you.</span></span> <span data-ttu-id="8a66d-170">「效能」流量路由方法提供這項功能。</span><span class="sxs-lookup"><span data-stu-id="8a66d-170">The 'Performance' traffic-routing method provides this capability.</span></span>

![Azure 流量管理員「效能」流量路由方法][3]

<span data-ttu-id="8a66d-172">「最靠近」的端點不一定是地理距離測量上最靠近的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-172">The 'closest' endpoint is not necessarily closest as measured by geographic distance.</span></span> <span data-ttu-id="8a66d-173">「效能」流量路由方法會測量網路延遲，以決定最靠近的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-173">Instead, the 'Performance' traffic-routing method determines the closest endpoint by measuring network latency.</span></span> <span data-ttu-id="8a66d-174">流量管理員會維護「網際網路延遲資料表」，以追蹤 IP 位址範圍與每個 Azure 資料中心之間的往返時間。</span><span class="sxs-lookup"><span data-stu-id="8a66d-174">Traffic Manager maintains an Internet Latency Table to track the round-trip time between IP address ranges and each Azure datacenter.</span></span>

<span data-ttu-id="8a66d-175">流量管理員會在「網際網路延遲資料表」中查閱傳入 DNS 要求的來源 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="8a66d-175">Traffic Manager looks up the source IP address of the incoming DNS request in the Internet Latency Table.</span></span> <span data-ttu-id="8a66d-176">流量管理員會在 Azure 資料中心內選擇該 IP 位址範圍內延遲最低的可用端點，然後在 DNS 回應中傳回該端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-176">Traffic Manager chooses an available endpoint in the Azure datacenter that has the lowest latency for that IP address range, then returns that endpoint in the DNS response.</span></span>

<span data-ttu-id="8a66d-177">如[流量管理員的運作方式](traffic-manager-overview.md#how-traffic-manager-works)中所述，流量管理員不會直接從用戶端接收 DNS 查詢。</span><span class="sxs-lookup"><span data-stu-id="8a66d-177">As explained in [How Traffic Manager Works](traffic-manager-overview.md#how-traffic-manager-works), Traffic Manager does not receive DNS queries directly from clients.</span></span> <span data-ttu-id="8a66d-178">相反地，DNS 查詢是來自用戶端已設定使用的遞迴 DNS 服務。</span><span class="sxs-lookup"><span data-stu-id="8a66d-178">Rather, DNS queries come from the recursive DNS service that the clients are configured to use.</span></span> <span data-ttu-id="8a66d-179">因此，用來判斷「最靠近」端點的 IP 位址不是用戶端的 IP 位址，而是遞迴 DNS 服務的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="8a66d-179">Therefore, the IP address used to determine the 'closest' endpoint is not the client's IP address, but it is the IP address of the recursive DNS service.</span></span> <span data-ttu-id="8a66d-180">實際上，此 IP 位址是用戶端的理想 Proxy。</span><span class="sxs-lookup"><span data-stu-id="8a66d-180">In practice, this IP address is a good proxy for the client.</span></span>


<span data-ttu-id="8a66d-181">流量管理員會定期更新「網際網路延遲資料表」，以反映全球網際網路的變動和新的 Azure 區域。</span><span class="sxs-lookup"><span data-stu-id="8a66d-181">Traffic Manager regularly updates the Internet Latency Table to account for changes in the global Internet and new Azure regions.</span></span> <span data-ttu-id="8a66d-182">不過，隨著網際網路上即時的負載變化，應用程式效能會改變。</span><span class="sxs-lookup"><span data-stu-id="8a66d-182">However, application performance varies based on real-time variations in load across the Internet.</span></span> <span data-ttu-id="8a66d-183">效能流量路由不會監視特定服務端點上的負載。</span><span class="sxs-lookup"><span data-stu-id="8a66d-183">Performance traffic-routing does not monitor load on a given service endpoint.</span></span> <span data-ttu-id="8a66d-184">不過，如果端點變得無法使用，流量管理員就不會將它加入 DNS 查詢回應中。</span><span class="sxs-lookup"><span data-stu-id="8a66d-184">However, if an endpoint becomes unavailable, Traffic Manager does not include it in DNS query responses.</span></span>


<span data-ttu-id="8a66d-185">注意事項：</span><span class="sxs-lookup"><span data-stu-id="8a66d-185">Points to note:</span></span>

* <span data-ttu-id="8a66d-186">如果您的設定檔中有多個端點在相同的 Azure 區域，則流量管理員會將流量平均分散至該區域中可用的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-186">If your profile contains multiple endpoints in the same Azure region, then Traffic Manager distributes traffic evenly across the available endpoints in that region.</span></span> <span data-ttu-id="8a66d-187">如果您在某個區域內偏好採用不同的流量分配，您可以使用[巢狀流量管理員設定檔](traffic-manager-nested-profiles.md)。</span><span class="sxs-lookup"><span data-stu-id="8a66d-187">If you prefer a different traffic distribution within a region, you can use [nested Traffic Manager profiles](traffic-manager-nested-profiles.md).</span></span>
* <span data-ttu-id="8a66d-188">如果最接近的 Azure 區域中所有啟用的端點都降級，流量管理員會將流量移到下一個最接近的 Azure 區域中的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-188">If all enabled endpoints in the closest Azure region are degraded, Traffic Manager moves traffic to the endpoints in the next closest Azure region.</span></span> <span data-ttu-id="8a66d-189">如果您想要定義慣用的容錯移轉順序，請使用[巢狀流量管理員設定檔](traffic-manager-nested-profiles.md)。</span><span class="sxs-lookup"><span data-stu-id="8a66d-189">If you want to define a preferred failover sequence, use [nested Traffic Manager profiles](traffic-manager-nested-profiles.md).</span></span>
* <span data-ttu-id="8a66d-190">對外部端點或巢狀端點使用「效能」流量路由方法時，您必須指定這些端點的位置。</span><span class="sxs-lookup"><span data-stu-id="8a66d-190">When using the Performance traffic routing method with external endpoints or nested endpoints, you need to specify the location of those endpoints.</span></span> <span data-ttu-id="8a66d-191">選擇最接近部署的 Azure 區域。</span><span class="sxs-lookup"><span data-stu-id="8a66d-191">Choose the Azure region closest to your deployment.</span></span> <span data-ttu-id="8a66d-192">這些區域是「網際網路延遲資料表」所支援的值。</span><span class="sxs-lookup"><span data-stu-id="8a66d-192">Those locations are the values supported by the Internet Latency Table.</span></span>
* <span data-ttu-id="8a66d-193">端點的選擇演算法具有決定性。</span><span class="sxs-lookup"><span data-stu-id="8a66d-193">The algorithm that chooses the endpoint is deterministic.</span></span> <span data-ttu-id="8a66d-194">來自同一個用戶端的重複 DNS 查詢會導向同一個端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-194">Repeated DNS queries from the same client are directed to the same endpoint.</span></span> <span data-ttu-id="8a66d-195">一般而言，用戶端在漫遊時會使用不同的遞迴 DNS 伺服器。</span><span class="sxs-lookup"><span data-stu-id="8a66d-195">Typically, clients use different recursive DNS servers when traveling.</span></span> <span data-ttu-id="8a66d-196">用戶端可能會路由傳送至不同的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-196">The client may be routed to a different endpoint.</span></span> <span data-ttu-id="8a66d-197">「網際網路延遲資料表」的更新也會影響路由。</span><span class="sxs-lookup"><span data-stu-id="8a66d-197">Routing can also be affected by updates to the Internet Latency Table.</span></span> <span data-ttu-id="8a66d-198">因此，效能流量路由方法不保證用戶端一定會路由傳送至相同的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-198">Therefore, the Performance traffic-routing method does not guarantee that a client is always routed to the same endpoint.</span></span>
* <span data-ttu-id="8a66d-199">當「網際網路延遲資料表」變更時，您可能會發現某些用戶端導向不同的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-199">When the Internet Latency Table changes, you may notice that some clients are directed to a different endpoint.</span></span> <span data-ttu-id="8a66d-200">只要取得最新的延遲資料，此路由變更會更精確。</span><span class="sxs-lookup"><span data-stu-id="8a66d-200">This routing change is more accurate based on current latency data.</span></span> <span data-ttu-id="8a66d-201">隨著網際網路的持續發展，這些更新對於維護「效能」流量路由的精確度也變得不可或缺。</span><span class="sxs-lookup"><span data-stu-id="8a66d-201">These updates are essential to maintain the accuracy of Performance traffic-routing as the Internet continually evolves.</span></span>

## <span data-ttu-id="8a66d-202"><a name = "geographic"></a>地理流量路由方法</span><span class="sxs-lookup"><span data-stu-id="8a66d-202"><a name = "geographic"></a>Geographic traffic-routing method</span></span>

<span data-ttu-id="8a66d-203">流量管理員設定檔可以設定成使用地理路由方法，以根據使用者的 DNS 查詢來自哪個地理位置，將使用者導向特定端點 (Azure、外部或巢狀)。</span><span class="sxs-lookup"><span data-stu-id="8a66d-203">Traffic Manager profiles can be configured to use the Geographic routing method so that users are directed to specific endpoints (Azure, External or Nested) based on which geographic location their DNS query originates from.</span></span> <span data-ttu-id="8a66d-204">在必須知道使用者的地理區域，並據以路由傳送使用者的情況下，這可讓流量管理員客戶應付自如。</span><span class="sxs-lookup"><span data-stu-id="8a66d-204">This empowers Traffic Manager customers to enable scenarios where knowing a user’s geographic region and routing them based on that is important.</span></span> <span data-ttu-id="8a66d-205">例如，遵守資料主權規定、內容和使用者經驗的當地語系化，以及測量來自不同區域的流量。</span><span class="sxs-lookup"><span data-stu-id="8a66d-205">Examples include complying with data sovereignty mandates, localization of content & user experience and measuring traffic from different regions.</span></span>
<span data-ttu-id="8a66d-206">設定地理路由的設定檔時，必須指派一組地理區域給該設定檔相關聯的每個端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-206">When a profile is configured for geographic routing, each endpoint associated with that profile needs to have a set of geographic regions assigned to it.</span></span> <span data-ttu-id="8a66d-207">地理區域可以達到下列細微層級</span><span class="sxs-lookup"><span data-stu-id="8a66d-207">A geographic region can be at following levels of granularity</span></span> 
- <span data-ttu-id="8a66d-208">世界 – 任何區域</span><span class="sxs-lookup"><span data-stu-id="8a66d-208">World– any region</span></span>
- <span data-ttu-id="8a66d-209">地區分組 – 例如非洲、中東、澳大利亞/太平洋等</span><span class="sxs-lookup"><span data-stu-id="8a66d-209">Regional Grouping – for example, Africa, Middle East, Australia/Pacific etc.</span></span> 
- <span data-ttu-id="8a66d-210">國家/地區 – 例如愛爾蘭、秘魯、香港特別行政區等</span><span class="sxs-lookup"><span data-stu-id="8a66d-210">Country/Region – for example, Ireland, Peru, Hong Kong SAR etc.</span></span> 
- <span data-ttu-id="8a66d-211">州/省 – 例如美國加州、澳大利亞昆士蘭、加拿大亞伯達省等 (請注意︰僅澳大利亞、加拿大、英國和美國的州/省才支援此細微層級)。</span><span class="sxs-lookup"><span data-stu-id="8a66d-211">State/Province – for example, USA-California, Australia-Queensland, Canada-Alberta etc. (note: this granularity level is supported only for states / provinces in Australia, Canada, UK, and USA).</span></span>

<span data-ttu-id="8a66d-212">將一個或一組區域指派給端點時，來自這些區域的任何要求只會路由傳送至該端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-212">When a region or a set of regions is assigned to an endpoint, any requests from those regions gets routed only to that endpoint.</span></span> <span data-ttu-id="8a66d-213">流量管理員會使用 DNS 查詢的來源 IP 位址，判斷使用者的查詢來自哪個區域 – 這通常是使用者執行查詢的本機 DNS 解析程式的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="8a66d-213">Traffic Manager uses the source IP address of the DNS query to determine the region from which a user is querying from – usually this is the IP address of the local DNS resolver doing the query on behalf of the user.</span></span>  

![Azure 流量管理員「地理」流量路由方法](./media/traffic-manager-routing-methods/geographic.png)

<span data-ttu-id="8a66d-215">流量管理員會讀取 DNS 查詢的來源 IP 位址，判斷查詢的來源地理區域。</span><span class="sxs-lookup"><span data-stu-id="8a66d-215">Traffic Manager reads the source IP address of the DNS query and decides which geographic region it is originating from.</span></span> <span data-ttu-id="8a66d-216">然後尋找是否有此地理區域對應的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-216">It then looks to see if there is an endpoint that has this geographic region mapped to it.</span></span> <span data-ttu-id="8a66d-217">查閱時會從最低細微層級開始 (州/省 - 若支援，否則是國家/地區層級)，一直到最高層級，也就是「世界」。</span><span class="sxs-lookup"><span data-stu-id="8a66d-217">This lookup starts at the lowest granularity level (State/Province where it is supported, else at the Country/Region level) and goes all the way up to the highest level, which is **World**.</span></span> <span data-ttu-id="8a66d-218">經過此周遊找到的第一個相符項目，就指定為要在查詢回應中傳回的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-218">The first match found using this traversal is designated as the endpoint to return in the query response.</span></span> <span data-ttu-id="8a66d-219">符合「巢狀」類型端點時，則會根據路由方法，傳回該子設定檔中的端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-219">When matching with a Nested type endpoint, an endpoint within that child profile is returned, based on its routing method.</span></span> <span data-ttu-id="8a66d-220">此行為有下列幾個特點︰</span><span class="sxs-lookup"><span data-stu-id="8a66d-220">The following points are applicable to this behavior:</span></span>

- <span data-ttu-id="8a66d-221">當路由類型是「地理路由」時，在流量管理員設定檔中，一個地理區域只能對應至一個端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-221">A geographic region can be mapped only to one endpoint in a Traffic Manager profile when the routing type is Geographic Routing.</span></span> <span data-ttu-id="8a66d-222">這可確保使用者路由是具決定性，讓客戶在地理界限必須明確的情況下應付自如。</span><span class="sxs-lookup"><span data-stu-id="8a66d-222">This ensures that routing of users is deterministic, and customers can enable scenarios that require unambiguous geographic boundaries.</span></span>
- <span data-ttu-id="8a66d-223">如果使用者的區域出現在兩個不同端點的地理對應中，流量管理員會選取細微度最低的端點，不會考慮將該區域的要求路由傳送至另一個端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-223">If a user’s region comes under two different endpoints’ geographic mapping, Traffic Manager selects the endpoint with the lowest granularity and does not consider routing requests from that region to the other endpoint.</span></span> <span data-ttu-id="8a66d-224">例如，假設「地理路由」類型設定檔有兩個端點 - 端點 1 和端點 2。</span><span class="sxs-lookup"><span data-stu-id="8a66d-224">For example, consider a Geographic Routing type profile with two endpoints - Endpoint1 and Endpoint2.</span></span> <span data-ttu-id="8a66d-225">端點 1 設定為接收來自愛爾蘭的流量，端點 2 設定接收來自歐洲的流量。</span><span class="sxs-lookup"><span data-stu-id="8a66d-225">Endpoint1 is configured to receive traffic from Ireland and Endpoint2 is configured to receive traffic from Europe.</span></span> <span data-ttu-id="8a66d-226">如果要求是來自愛爾蘭，則永遠會路由傳送至端點 1。</span><span class="sxs-lookup"><span data-stu-id="8a66d-226">If a request originates from Ireland, it is always routed to Endpoint1.</span></span>
- <span data-ttu-id="8a66d-227">因為一個區域只能對應至一個端點，不論端點是否狀況良好，流量管理員都會傳回此端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-227">Since a region can be mapped only to one endpoint, Traffic Manager returns it regardless of whether the endpoint is healthy or not.</span></span>

    >[!IMPORTANT]
    ><span data-ttu-id="8a66d-228">強烈建議客戶使用地理路由方法，並與「巢狀」類型端點相關聯，且子設定檔至少各包含兩個端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-228">It is strongly recommended that customers using the geographic routing method associate it with the Nested type endpoints that has child profiles containing at least two endpoints within each.</span></span>
- <span data-ttu-id="8a66d-229">如果找到符合的端點，但該端點處於**已停止**狀態，則流量管理員會傳回 NODATA 回應。</span><span class="sxs-lookup"><span data-stu-id="8a66d-229">If an endpoint match is found and that endpoint is in the **Stopped** state, Traffic Manager returns a NODATA response.</span></span> <span data-ttu-id="8a66d-230">在此情況下，不會再於地理區域階層中往上進一步查閱。</span><span class="sxs-lookup"><span data-stu-id="8a66d-230">In this case, no further lookups is made higher up in the geographic region hierarchy.</span></span> <span data-ttu-id="8a66d-231">對於巢狀端點類型，當子設定檔處於**已停止**或**已停用**狀態時，此行為也適用。</span><span class="sxs-lookup"><span data-stu-id="8a66d-231">This behavior is also applicable for nested endpoint types when the child profile is in the **Stopped** or **Disabled** state.</span></span>
- <span data-ttu-id="8a66d-232">如果端點顯示**已停用**狀態，則區域比對過程不會考慮此端點。</span><span class="sxs-lookup"><span data-stu-id="8a66d-232">If an endpoint displays a **Disabled** status, it won’t be included in the region matching process.</span></span> <span data-ttu-id="8a66d-233">對於巢狀端點類型，當端點處於**已停用**狀態時，此行為也適用。</span><span class="sxs-lookup"><span data-stu-id="8a66d-233">This behavior is also applicable for nested endpoint types when the endpoint is in the **Disabled** state.</span></span>
- <span data-ttu-id="8a66d-234">如果查詢的來源地理區域在該設定檔中沒有對應，流量管理員會傳回 NODATA 回應。</span><span class="sxs-lookup"><span data-stu-id="8a66d-234">If a query is coming from a geographic region that has no mapping in that profile, Traffic Manager returns a NODATA response.</span></span> <span data-ttu-id="8a66d-235">因此，強烈建議客戶使用地理路由搭配一個端點，最好是「巢狀」類型，且子設定檔內至少有兩個端點，並指派區域**世界**。</span><span class="sxs-lookup"><span data-stu-id="8a66d-235">Therefore, it is strongly recommended that customers use geographic routing with one endpoint, ideally of type Nested with at least two endpoints within the child profile, with the region **World** assigned to it.</span></span> <span data-ttu-id="8a66d-236">這也可確保會處理未對應到區域的任何 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="8a66d-236">This also ensures that any IP addresses that do not map to a region are handled.</span></span>

<span data-ttu-id="8a66d-237">如[流量管理員的運作方式](traffic-manager-how-traffic-manager-works.md)中所述，流量管理員不會直接從用戶端接收 DNS 查詢。</span><span class="sxs-lookup"><span data-stu-id="8a66d-237">As explained in [How Traffic Manager Works](traffic-manager-how-traffic-manager-works.md), Traffic Manager does not receive DNS queries directly from clients.</span></span> <span data-ttu-id="8a66d-238">相反地，DNS 查詢是來自用戶端已設定使用的遞迴 DNS 服務。</span><span class="sxs-lookup"><span data-stu-id="8a66d-238">Rather, DNS queries come from the recursive DNS service that the clients are configured to use.</span></span> <span data-ttu-id="8a66d-239">因此，用來判斷區域的 IP 位址不是用戶端的 IP 位址，而是遞迴 DNS 服務的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="8a66d-239">Therefore, the IP address used to determine the region is not the client's IP address, but it is the IP address of the recursive DNS service.</span></span> <span data-ttu-id="8a66d-240">實際上，此 IP 位址是用戶端的理想 Proxy。</span><span class="sxs-lookup"><span data-stu-id="8a66d-240">In practice, this IP address is a good proxy for the client.</span></span>


## <a name="next-steps"></a><span data-ttu-id="8a66d-241">後續步驟</span><span class="sxs-lookup"><span data-stu-id="8a66d-241">Next steps</span></span>

<span data-ttu-id="8a66d-242">了解如何使用 [Traffic Manager endpoint monitoring](traffic-manager-monitoring.md)</span><span class="sxs-lookup"><span data-stu-id="8a66d-242">Learn how to develop high-availability applications using [Traffic Manager endpoint monitoring](traffic-manager-monitoring.md)</span></span>

<span data-ttu-id="8a66d-243">了解如何 [建立流量管理員設定檔](traffic-manager-create-profile.md)</span><span class="sxs-lookup"><span data-stu-id="8a66d-243">Learn how to [create a Traffic Manager profile](traffic-manager-create-profile.md)</span></span>

<!--Image references-->
[1]: ./media/traffic-manager-routing-methods/priority.png
[2]: ./media/traffic-manager-routing-methods/weighted.png
[3]: ./media/traffic-manager-routing-methods/performance.png



