---
title: "與虛擬機器擴展集的自動調整規模 aaaTroubleshoot |Microsoft 文件"
description: "針對使用虛擬機器擴展集的自動調整進行疑難排解。 了解所遇到的典型問題及如何 tooresolve 它們。"
services: virtual-machine-scale-sets
documentationcenter: 
author: gbowerman
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: c7d87b72-ee24-4e52-9377-a42f337f76fa
ms.service: virtual-machine-scale-sets
ms.workload: na
ms.tgt_pltfrm: windows
ms.devlang: na
ms.topic: article
ms.date: 10/28/2016
ms.author: guybo
ms.openlocfilehash: 4c9a70992348d87fb43646421a90a027bf400a17
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="troubleshooting-autoscale-with-virtual-machine-scale-sets"></a><span data-ttu-id="9d3f6-104">針對使用虛擬機器擴展集的自動調整進行疑難排解</span><span class="sxs-lookup"><span data-stu-id="9d3f6-104">Troubleshooting autoscale with Virtual Machine Scale Sets</span></span>
<span data-ttu-id="9d3f6-105">**問題**– 您已建立的自動調整基礎結構，Azure 資源管理員中使用 VM 規模集 – 例如藉由部署的範本，就像這樣： https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss bottle 規模 – 您必須定義標尺規則，它非常適合，不同之處在於無論您將在 hello Vm 多少負載，就不會自動調整規模。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-105">**Problem** – you’ve created an autoscaling infrastructure in Azure Resource Manager using VM Scale Sets –  for example by deploying a template like this: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale  – you have your scale rules defined and it works great, except that no matter how much load you put on hello VMs, it won’t autoscale.</span></span>

## <a name="troubleshooting-steps"></a><span data-ttu-id="9d3f6-106">疑難排解步驟</span><span class="sxs-lookup"><span data-stu-id="9d3f6-106">Troubleshooting steps</span></span>
<span data-ttu-id="9d3f6-107">某些事項 tooconsider 包括：</span><span class="sxs-lookup"><span data-stu-id="9d3f6-107">Some things tooconsider include:</span></span>

* <span data-ttu-id="9d3f6-108">每個 VM 有多少個核心，以及會載入每個核心？上述的 hello 範例 Azure 快速入門範本已載入單一核心 do_work.php 指令碼。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-108">How many cores does each VM have, and are you loading each core? hello example Azure Quickstart template above has a do_work.php script, which loads a single core.</span></span> <span data-ttu-id="9d3f6-109">如果您使用單一核心的 VM 大小大於 VM Standard_A1 或 D1 然後您就必須 toorun 此負載多次。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-109">If you’re using a VM bigger than a single core VM size like Standard_A1 or D1 then you’d need toorun this load multiple times.</span></span> <span data-ttu-id="9d3f6-110">藉由檢閱 [Azure 中 Windows 虛擬機器的大小](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)</span><span class="sxs-lookup"><span data-stu-id="9d3f6-110">Check how many cores your VMs by reviewing [Sizes for Windows virtual machines in Azure](../virtual-machines/windows/sizes.md?toc=%2fazure%2fvirtual-machines%2fwindows%2ftoc.json)</span></span>
* <span data-ttu-id="9d3f6-111">在虛擬機器擴展集 hello 多少 Vm 做每一項工作？</span><span class="sxs-lookup"><span data-stu-id="9d3f6-111">How many VMs in hello VM Scale Set, are you doing work on each one?</span></span>
  
    <span data-ttu-id="9d3f6-112">擴充事件只會發生時 hello 平均 CPU 跨**所有**hello Vm 規模集中的超過 hello 臨界值，透過內部 hello 時間 hello 自動調整規模規則中定義。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-112">A scale out event will only take place when hello average CPU across **all** hello VMs in a scale set exceeds hello threshold value, over hello time internal defined in hello autoscale rules.</span></span>
* <span data-ttu-id="9d3f6-113">您是否遺漏任何調整事件？</span><span class="sxs-lookup"><span data-stu-id="9d3f6-113">Did you miss any scale events?</span></span>
  
    <span data-ttu-id="9d3f6-114">檢查 hello 稽核記錄檔以 hello Azure 入口網站的標尺事件。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-114">Check hello audit logs in hello Azure portal for scale events.</span></span> <span data-ttu-id="9d3f6-115">或許遺漏相應增加和相應減少。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-115">Maybe there was a scale up and a scale down which was missed.</span></span> <span data-ttu-id="9d3f6-116">您可以依「調整」進行篩選。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-116">You can filter by “Scale”..</span></span>
  
    ![稽核記錄檔][audit]
* <span data-ttu-id="9d3f6-118">您的相應縮小和相應放大的臨界值是否有足夠的差異？</span><span class="sxs-lookup"><span data-stu-id="9d3f6-118">Are your scale-in and scale-out thresholds sufficiently different?</span></span>
  
    <span data-ttu-id="9d3f6-119">假設您設定規則 tooscale 出平均 CPU 時超過 50%，超過 5 分鐘和 tooscale 中平均 CPU 時小於 50%。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-119">Suppose you set a rule tooscale out when average CPU is greater than 50% over 5 minutes, and tooscale in when average CPU is less than 50%.</span></span> <span data-ttu-id="9d3f6-120">這會導致 「 拍打 」 的問題時的 CPU 使用量是關閉 toothis 臨界值，與不斷增加，並減少 hello 的調整動作 hello 集的大小。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-120">This would cause a “flapping” problem when CPU usage is close toothis threshold, with scale actions constantly increasing and decreasing hello size of hello set.</span></span> <span data-ttu-id="9d3f6-121">因為這個緣故，hello 自動調整規模服務會嘗試 tooprevent"出現 flapping 的現象"，這可以呈現為非比例。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-121">Because of this, hello autoscale service tries tooprevent “flapping”, which can manifest as not scaling.</span></span> <span data-ttu-id="9d3f6-122">因此請確定您的向外延展和小數位數在閾值差異不足 tooallow 一些空間之間縮放比例。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-122">Therefore make sure your scale-out and scale-in thresholds are sufficiently different tooallow some space in between scaling.</span></span>
* <span data-ttu-id="9d3f6-123">您是否撰寫自己的 JSON 範本？</span><span class="sxs-lookup"><span data-stu-id="9d3f6-123">Did you write your own JSON template?</span></span>
  
    <span data-ttu-id="9d3f6-124">很容易 toomake 錯誤、 因此開頭的範本，例如其上方的其中一個來證明 toowork，hello 和小型的累加變更。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-124">It is easy toomake mistakes, so start with a template like hello one above which is proven toowork, and make small incremental changes.</span></span> 
* <span data-ttu-id="9d3f6-125">是否可以手動相應縮小或相應放大？</span><span class="sxs-lookup"><span data-stu-id="9d3f6-125">Can you manually scale in or out?</span></span>
  
    <span data-ttu-id="9d3f6-126">請手動嘗試重新部署的 hello 與不同的 「 容量 」 設定 toochange hello Vm 數目的虛擬機器擴展集資源。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-126">Try redeploying hello VM Scale Set resource with a different “capacity” setting toochange hello number of VMs manually.</span></span> <span data-ttu-id="9d3f6-127">這是在此範例範本 toodo: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-scale-existing – 您可能需要確定它擁有 hello 的 tooedit hello 範本 toomake 相同機器大小，因為小數位數設定為使用。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-127">An example template toodo this is here: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-scale-existing – you may need tooedit hello template toomake sure it has hello same machine size as your Scale Set is using.</span></span> <span data-ttu-id="9d3f6-128">如果您已成功可以手動變更 hello Vm 數目，您便知道 hello 問題是隔離的 tooautoscale。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-128">If you can successfully change hello number of VMs manually, then you know hello problem is isolated tooautoscale.</span></span>
* <span data-ttu-id="9d3f6-129">請檢查您 Microsoft.Compute/virtualMachineScaleSet Microsoft.Insights 中和資源 hello [Azure 資源總管](https://resources.azure.com/)</span><span class="sxs-lookup"><span data-stu-id="9d3f6-129">Check your Microsoft.Compute/virtualMachineScaleSet, and Microsoft.Insights resources in hello [Azure Resource Explorer](https://resources.azure.com/)</span></span>
  
    <span data-ttu-id="9d3f6-130">這是不可或缺的疑難排解工具，它會顯示 hello Azure 資源管理員資源的狀態。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-130">This is an indispensable troubleshooting tool which shows you hello state of your Azure Resource Manager resources.</span></span> <span data-ttu-id="9d3f6-131">按一下訂用帳戶，並查看 hello 您正在疑難排解的資源群組。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-131">Click on your subscription and look at hello Resource Group you are troubleshooting.</span></span> <span data-ttu-id="9d3f6-132">Hello 計算資源提供者下查看您建立虛擬機器擴展集 hello 和檢查執行個體檢視中，它會顯示 hello hello 部署的狀態。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-132">Under hello Compute resource provider look at hello VM Scale Set you created and check hello Instance View, which shows you hello state of a deployment.</span></span> <span data-ttu-id="9d3f6-133">另請檢查 Vm 的 hello VM 規模調整集合中的 hello 執行個體檢視。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-133">Also check hello instance view of VMs in hello VM Scale Set.</span></span> <span data-ttu-id="9d3f6-134">然後移至 hello Microsoft.Insights 資源提供者，並檢查 hello 自動調整規模規則能呈現最佳效果。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-134">Then go into hello Microsoft.Insights resource provider and check hello autoscale rules look good.</span></span>
* <span data-ttu-id="9d3f6-135">正在 hello 診斷延伸模組工作，並發出時的效能資料？</span><span class="sxs-lookup"><span data-stu-id="9d3f6-135">Is hello Diagnostic extension working and emitting performance data?</span></span>
  
    <span data-ttu-id="9d3f6-136">**更新：** Azure 自動調整規模已增強的 toouse 主機基礎不再需要安裝診斷延伸模組 toobe 度量管線。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-136">**Update:** Azure autoscale has been enhanced toouse a host based metrics pipeline which no longer requires a diagnostics extension toobe installed.</span></span> <span data-ttu-id="9d3f6-137">這表示 hello 下一步的幾個段落不再套用如果您建立使用 hello 新管線的自動調整應用程式。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-137">This means hello next few paragraphs no longer apply if you create an autoscaling application using hello new pipeline.</span></span> <span data-ttu-id="9d3f6-138">Azure 的範本已被轉換的 toouse hello 主應用程式管線的範例： https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-138">An example of Azure templates which have been converted toouse hello host pipeline is: https://github.com/Azure/azure-quickstart-templates/tree/master/201-vmss-bottle-autoscale.</span></span> 
  
    <span data-ttu-id="9d3f6-139">使用主機型度量自動調整規模適合 hello 下列原因：</span><span class="sxs-lookup"><span data-stu-id="9d3f6-139">Using host based metrics for autoscale is better for hello following reasons:</span></span>
  
  * <span data-ttu-id="9d3f6-140">較少的移動組件做為沒有診斷擴充功能需要安裝 toobe。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-140">Fewer moving parts as no diagnostics extensions need toobe installed.</span></span>
  * <span data-ttu-id="9d3f6-141">更簡單的範本。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-141">Simpler templates.</span></span> <span data-ttu-id="9d3f6-142">只要加入 insights 自動調整規模規則 tooan 現有規模調整集合範本。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-142">Just add insights autoscale rules tooan existing scale set template.</span></span>
  * <span data-ttu-id="9d3f6-143">新 VM 的報告更可靠且啟動更快速。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-143">More reliable reporting and faster launching of new VMs.</span></span>
    
    <span data-ttu-id="9d3f6-144">hello 您可能會想使用的診斷延伸模組的 tookeep 的原因是如果您需要在記憶體診斷報告/縮放比例。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-144">hello only reasons you might want tookeep using a diagnostic extension would be if you need memory diagnostics reporting/scaling.</span></span> <span data-ttu-id="9d3f6-145">主機型度量資訊不會報告記憶體。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-145">Host based metrics doesn't report memory.</span></span>
    
    <span data-ttu-id="9d3f6-146">這一點之後，才遵循 hello 本文其餘部分您仍在使用診斷擴充功能為您自動調整。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-146">With that in mind, only follow hello rest of this article if you are still using diagnostic extensions for your autoscaling.</span></span>
    
    <span data-ttu-id="9d3f6-147">自動調整 Azure 資源管理員中可以搭配使用 （但不會再對） 透過呼叫 hello 診斷延伸模組的 VM 延伸模組。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-147">Autoscale in Azure Resource Manager can work (but no longer has to) by means of a VM extension called hello Diagnostics Extension.</span></span> <span data-ttu-id="9d3f6-148">它會發出您在 hello 範本中定義的效能資料 tooa 儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-148">It emits performance data tooa storage account you define in hello template.</span></span> <span data-ttu-id="9d3f6-149">這項資料會接著彙總 hello Azure 監視服務。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-149">This data is then aggregated by hello Azure Monitor service.</span></span>
    
    <span data-ttu-id="9d3f6-150">如果 Vm hello hello Insights 服務無法讀取資料，它應該 toosend 您電子郵件-例如，如果 hello Vm 已關閉，因此請查看您的電子郵件 (建立 hello Azure 帳戶時，您會指定一個 hello)。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-150">If hello Insights service can’t read data from hello VMs, it is supposed toosend you an email – for example if hello VMs were down, so check your email (hello one you specified when creating hello Azure account).</span></span>
    
    <span data-ttu-id="9d3f6-151">您也可以前往並自行查看 hello 資料。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-151">You can also go and look at hello data yourself.</span></span> <span data-ttu-id="9d3f6-152">查看 hello 使用雲端總管的 Azure 儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-152">Look at hello Azure storage account using a cloud explorer.</span></span> <span data-ttu-id="9d3f6-153">如需範例使用 hello [Visual Studio Cloud Explorer](https://visualstudiogallery.msdn.microsoft.com/aaef6e67-4d99-40bc-aacf-662237db85a2)，登入，並挑選 hello Azure 訂用帳戶使用，並 hello 診斷儲存體帳戶名稱中 hello 部署中的診斷延伸模組定義參考範本...</span><span class="sxs-lookup"><span data-stu-id="9d3f6-153">For example using hello [Visual Studio Cloud Explorer](https://visualstudiogallery.msdn.microsoft.com/aaef6e67-4d99-40bc-aacf-662237db85a2), log in and pick hello Azure subscription you’re using, and hello Diagnostics storage account name referenced in hello Diagnostics extension definition in your deployment template..</span></span>
    
    ![雲端總管][explorer]
    
    <span data-ttu-id="9d3f6-155">這裡您會看到一堆儲存每個 VM 的 hello 資料資料表。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-155">Here you will see a bunch of tables where hello data from each VM is being stored.</span></span> <span data-ttu-id="9d3f6-156">讓 Linux 和 hello CPU 度量，做為範例，看看 hello 最新的資料列。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-156">Taking Linux and hello CPU metric as an example, look at hello most recent rows.</span></span> <span data-ttu-id="9d3f6-157">hello Visual Studio cloud explorer 支援的查詢語言，因此您可以執行類似的查詢 「 時間戳記 gt datetime' 2016年-02-02T21:20:00Z'"toomake 確定取得 hello 最新事件 （假設時間為 utc 格式）。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-157">hello Visual Studio cloud explorer supports a query language so you can run a query like “Timestamp gt datetime’2016-02-02T21:20:00Z’” toomake sure you get hello most recent events (assume time is in UTC).</span></span> <span data-ttu-id="9d3f6-158">您在中看到那里對應 toohello hello 資料調整規模設定的規則嗎？</span><span class="sxs-lookup"><span data-stu-id="9d3f6-158">Does hello data you see in there correspond toohello scale rules you set up?</span></span> <span data-ttu-id="9d3f6-159">Hello 下列範例中，在機器 20 hello CPU 會啟動隨 hello 前 5 分鐘增加 too100%...</span><span class="sxs-lookup"><span data-stu-id="9d3f6-159">In hello example below, hello CPU for machine 20 started increasing too100% over hello last 5 minutes..</span></span>
    
    ![儲存體資料表][tables]
    
    <span data-ttu-id="9d3f6-161">如果 hello 資料不存在，則表示 hello 問題是出在 hello hello Vm 中執行的診斷延伸模組。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-161">If hello data is not there, then it implies hello problem is with hello diagnostic extension running in hello VMs.</span></span> <span data-ttu-id="9d3f6-162">如果有 hello 資料，則表示沒有問題以標尺規則，或與 hello Insights 服務。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-162">If hello data is there, it implies there is either a problem with your scale rules, or with hello Insights service.</span></span> <span data-ttu-id="9d3f6-163">檢查 [Azure 狀態](https://azure.microsoft.com/status/)。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-163">Check [Azure Status](https://azure.microsoft.com/status/).</span></span>
    
    <span data-ttu-id="9d3f6-164">一旦您已經完成這些步驟，如果您仍無法自動調整您可以嘗試 hello 論壇[MSDN](https://social.msdn.microsoft.com/forums/azure/home?category=windowsazureplatform%2Cazuremarketplace%2Cwindowsazureplatformctp)，或[堆疊溢位](http://stackoverflow.com/questions/tagged/azure)，或記錄的支援通話。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-164">Once you’ve been through these steps, if you are still having autoscale problems you could try hello forums on [MSDN](https://social.msdn.microsoft.com/forums/azure/home?category=windowsazureplatform%2Cazuremarketplace%2Cwindowsazureplatformctp), or [Stack overflow](http://stackoverflow.com/questions/tagged/azure), or log a support call.</span></span> <span data-ttu-id="9d3f6-165">是已備妥的 tooshare hello 範本和 hello 效能資料的檢視。</span><span class="sxs-lookup"><span data-stu-id="9d3f6-165">Be prepared tooshare hello template and a view of hello performance data.</span></span>

[audit]: ./media/virtual-machine-scale-sets-troubleshoot/image3.png
[explorer]: ./media/virtual-machine-scale-sets-troubleshoot/image1.png
[tables]: ./media/virtual-machine-scale-sets-troubleshoot/image4.png
