---
title: "輪流應用程式升級 - Azure SQL Database | Microsoft Docs"
description: "了解如何使用 Azure SQL Database 異地複寫以支援雲端應用程式的線上升級。"
services: sql-database
documentationcenter: 
author: anosov1960
manager: jhubbard
editor: monicar
ms.assetid: 58f42859-1e37-463c-a3d8-a3ca2e867148
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 07/16/2016
ms.author: sashan
ms.openlocfilehash: 4b59c8aa3dea3e8fba692ab66420295a09210d3b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="managing-rolling-upgrades-of-cloud-applications-using-sql-database-active-geo-replication"></a><span data-ttu-id="03db0-103">使用 SQL Database 主動式異地複寫管理雲端應用程式的輪流升級</span><span class="sxs-lookup"><span data-stu-id="03db0-103">Managing rolling upgrades of cloud applications using SQL Database active geo-replication</span></span>
> [!NOTE]
> <span data-ttu-id="03db0-104">[作用中異地複寫](sql-database-geo-replication-overview.md)現在可供所有層中的所有資料庫使用。</span><span class="sxs-lookup"><span data-stu-id="03db0-104">[Active geo-replication](sql-database-geo-replication-overview.md) is now available for all databases in all tiers.</span></span>
> 

<span data-ttu-id="03db0-105">了解如何使用 SQL Database 中的[異地複寫](sql-database-geo-replication-overview.md)來啟用雲端應用程式的輪流升級。</span><span class="sxs-lookup"><span data-stu-id="03db0-105">Learn how to use [geo-replication](sql-database-geo-replication-overview.md) in SQL Database to enable rolling upgrades of your cloud application.</span></span> <span data-ttu-id="03db0-106">因為升級是干擾性作業，它應該是您商務持續性規劃與設計的一部分。</span><span class="sxs-lookup"><span data-stu-id="03db0-106">Because upgrade is a disruptive operation, it should be part of your business continuity planning and design.</span></span> <span data-ttu-id="03db0-107">在本文中，我們將探討兩種不同的升級程序協調方法，並討論每個選項的優點和取捨。</span><span class="sxs-lookup"><span data-stu-id="03db0-107">In this article we look at two different methods of orchestrating the upgrade process, and discuss the benefits and trade-offs of each option.</span></span> <span data-ttu-id="03db0-108">基於本文的目的，我們將使用簡單的應用程式，它是由連線到單一資料庫作為其資料層的網站所組成。</span><span class="sxs-lookup"><span data-stu-id="03db0-108">For the purposes of this article we will use a simple application that consists of a web site connected to a single database as its data tier.</span></span> <span data-ttu-id="03db0-109">我們的目標是將應用程式的版本 1 升級到版本 2，而不對使用者體驗造成顯著的影響。</span><span class="sxs-lookup"><span data-stu-id="03db0-109">Our goal is to upgrade version 1 of the application to version 2 without any significant impact on the end-user experience.</span></span> 

<span data-ttu-id="03db0-110">評估升級選項時，您應該考慮下列因素：</span><span class="sxs-lookup"><span data-stu-id="03db0-110">When evaluating the upgrade options you should consider the following factors:</span></span>

* <span data-ttu-id="03db0-111">升級期間對應用程式可用性的影響。</span><span class="sxs-lookup"><span data-stu-id="03db0-111">Impact on application availability during upgrades.</span></span> <span data-ttu-id="03db0-112">應用程式功能可能受到限制或降級多久時間。</span><span class="sxs-lookup"><span data-stu-id="03db0-112">How long the application function may be limited or degraded.</span></span>
* <span data-ttu-id="03db0-113">防止萬一升級失敗的復原功能。</span><span class="sxs-lookup"><span data-stu-id="03db0-113">Ability to roll back in case of an upgrade failure.</span></span>
* <span data-ttu-id="03db0-114">升級期間發生不相關的重大失敗時，應用程式的弱點。</span><span class="sxs-lookup"><span data-stu-id="03db0-114">Vulnerability of the application if an unrelated catastrophic failure occurs during the upgrade.</span></span>
* <span data-ttu-id="03db0-115">總金額成本。</span><span class="sxs-lookup"><span data-stu-id="03db0-115">Total dollar cost.</span></span>  <span data-ttu-id="03db0-116">這包括額外備援以及升級程序所使用之暫時性元件的累加成本。</span><span class="sxs-lookup"><span data-stu-id="03db0-116">This includes additional redundancy and incremental costs of the temporary components  used by the upgrade process.</span></span> 

## <a name="upgrading-applications-that-rely-on-database-backups-for-disaster-recovery"></a><span data-ttu-id="03db0-117">升級依賴資料庫備份以進行災害復原的應用程式</span><span class="sxs-lookup"><span data-stu-id="03db0-117">Upgrading applications that rely on database backups for disaster recovery</span></span>
<span data-ttu-id="03db0-118">如果您的應用程式依賴自動資料庫備份，並針對災害復原使用異地復原，則它通常是部署到單一 Azure 區域。</span><span class="sxs-lookup"><span data-stu-id="03db0-118">If your application relies on automatic database backups and uses geo-restore for disaster recovery, it is usually deployed to a single Azure region.</span></span> <span data-ttu-id="03db0-119">在此案例中，升級程序涉及建立升級中相關的所有應用程式元件的備份部署。</span><span class="sxs-lookup"><span data-stu-id="03db0-119">In this case the upgrade process involves creating a backup deployment of all application components involved in the upgrade.</span></span> <span data-ttu-id="03db0-120">若要對使用者的干擾降到最低，您要利用 Azure 流量管理員 (WATM) 與容錯移轉設定檔。</span><span class="sxs-lookup"><span data-stu-id="03db0-120">To minimize the end-user disruption you will leverage Azure Traffic Manager (WATM) with the failover profile.</span></span>  <span data-ttu-id="03db0-121">下圖說明升級程序之前的作業環境。</span><span class="sxs-lookup"><span data-stu-id="03db0-121">The following diagram illustrates the operational environment prior to the upgrade process.</span></span> <span data-ttu-id="03db0-122">端點 <i>contoso-1.azurewebsites.net</i> 代表需要升級之應用程式的生產位置。</span><span class="sxs-lookup"><span data-stu-id="03db0-122">The endpoint <i>contoso-1.azurewebsites.net</i> represents a production slot of the application that needs to be upgraded.</span></span> <span data-ttu-id="03db0-123">若要啟用復原升級的功能，您必須建立含有應用程式完整同步之複本的預備位置。</span><span class="sxs-lookup"><span data-stu-id="03db0-123">To enable the ability to roll back the upgrade, you need create a stage slot with a fully synchronized copy of the application.</span></span> <span data-ttu-id="03db0-124">準備升級應用程式需要執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="03db0-124">The following steps are required to prepare the application for the upgrade:</span></span>

1. <span data-ttu-id="03db0-125">為升級建立預備位置。</span><span class="sxs-lookup"><span data-stu-id="03db0-125">Create a stage slot for the upgrade.</span></span> <span data-ttu-id="03db0-126">若要這樣做，請建立次要資料庫 (1) 並在相同的 Azure 區域中部署相同的網站。</span><span class="sxs-lookup"><span data-stu-id="03db0-126">To do that create a secondary database (1) and deploy an identical web site in the same Azure region.</span></span> <span data-ttu-id="03db0-127">監視次要資料庫，查看植入程序是否完成。</span><span class="sxs-lookup"><span data-stu-id="03db0-127">Monitor the secondary to see if the seeding process is completed.</span></span>
2. <span data-ttu-id="03db0-128">在 WATM 中建立容錯移轉設定檔，<i>contoso-1.azurewebsites.net</i> 作為線上端點，<i>contoso-2.azurewebsites.net</i> 作為離線端點。</span><span class="sxs-lookup"><span data-stu-id="03db0-128">Create a failover profile in WATM with <i>contoso-1.azurewebsites.net</i> as online endpoint and <i>contoso-2.azurewebsites.net</i> as offline.</span></span> 

> [!NOTE]
> <span data-ttu-id="03db0-129">請注意，準備步驟不會影響生產位置中的應用程式，且它可以在完整存取模式下運作。</span><span class="sxs-lookup"><span data-stu-id="03db0-129">Note the preparation steps will not impact the application in the production slot and it can function in full access mode.</span></span>
>  

![SQL Database「異地複寫」組態。](media/sql-database-manage-application-rolling-upgrade/Option1-1.png)

<span data-ttu-id="03db0-132">一旦準備步驟完成後，應用程式就已準備好實際升級。</span><span class="sxs-lookup"><span data-stu-id="03db0-132">Once the preparation steps are completed the application is ready for the actual upgrade.</span></span> <span data-ttu-id="03db0-133">下圖說明升級程序相關的步驟。</span><span class="sxs-lookup"><span data-stu-id="03db0-133">The following diagram illustrates the steps involved in the upgrade process.</span></span> 

1. <span data-ttu-id="03db0-134">將生產位置中的主要資料庫設定為唯讀模式 (3)。</span><span class="sxs-lookup"><span data-stu-id="03db0-134">Set the primary database in the production slot to read-only mode (3).</span></span> <span data-ttu-id="03db0-135">這樣會保證應用程式的生產執行個體 (V1) 在升級期間會保持唯讀，藉此防止 V1 與 V2 資料庫執行個體間的資料分歧。</span><span class="sxs-lookup"><span data-stu-id="03db0-135">This will guarantee that the production instance of the application (V1) will remain read-only during the upgrade thus preventing the data divergence between the V1 and V2 database instances.</span></span>  
2. <span data-ttu-id="03db0-136">使用規劃的終止模式 (4) 中斷次要資料庫的連線。</span><span class="sxs-lookup"><span data-stu-id="03db0-136">Disconnect the secondary database using the planned termination mode (4).</span></span> <span data-ttu-id="03db0-137">它會建立完整同步的主要資料庫獨立複本。</span><span class="sxs-lookup"><span data-stu-id="03db0-137">It will create a fully synchronized independent copy of the primary database.</span></span> <span data-ttu-id="03db0-138">此資料庫將會升級。</span><span class="sxs-lookup"><span data-stu-id="03db0-138">This database will be upgraded.</span></span>
3. <span data-ttu-id="03db0-139">在預備位置 (5) 中將主要資料庫切換為讀寫模式，然後執行升級指令碼。</span><span class="sxs-lookup"><span data-stu-id="03db0-139">Turn the primary database to read-write mode and run the upgrade script in the stage slot  (5).</span></span>     

![SQL Database 異地複寫組態。](media/sql-database-manage-application-rolling-upgrade/Option1-2.png)

<span data-ttu-id="03db0-142">如果升級順利完成，您現在已準備好將使用者切換至應用程式的預備複本。</span><span class="sxs-lookup"><span data-stu-id="03db0-142">If the upgrade completed successfully you are now ready to switch the end users to the staged copy the application.</span></span> <span data-ttu-id="03db0-143">它現在將會成為應用程式的生產位置。</span><span class="sxs-lookup"><span data-stu-id="03db0-143">It will now become the production slot of the application.</span></span>  <span data-ttu-id="03db0-144">這涉及一些步驟，如下圖所示。</span><span class="sxs-lookup"><span data-stu-id="03db0-144">This involves a few more steps as illustrated on the following diagram.</span></span>

1. <span data-ttu-id="03db0-145">將 WATM 設定檔中的線上端點切換為 <i>contoso-2.azurewebsites.net</i>，它會指向 V2 版本的網站 (6)。</span><span class="sxs-lookup"><span data-stu-id="03db0-145">Switch the online endpoint in the WATM profile to <i>contoso-2.azurewebsites.net</i>, which points to the V2 version of the web site (6).</span></span> <span data-ttu-id="03db0-146">它現在已成為含有 V2 應用程式的生產位置，而且使用者流量會導向至它。</span><span class="sxs-lookup"><span data-stu-id="03db0-146">It now becomes the production slot with the V2 application and the end-user traffic is directed to it.</span></span>  
2. <span data-ttu-id="03db0-147">如果您不再需要 V1 應用程式元件，您可以安全地移除它們 (7)。</span><span class="sxs-lookup"><span data-stu-id="03db0-147">If you no longer need the V1 application components so you can safely remove them (7).</span></span>   

![SQL Database 異地複寫組態。](media/sql-database-manage-application-rolling-upgrade/Option1-3.png)

<span data-ttu-id="03db0-150">如果升級程序失敗 (例如升級指令碼中發生錯誤)，可能要將預備位置視為遭到危害。</span><span class="sxs-lookup"><span data-stu-id="03db0-150">If the upgrade process is unsuccessful, for example due to an error in the upgrade script, the stage slot should be considered compromised.</span></span> <span data-ttu-id="03db0-151">若要將應用程式復原到升級前狀態，您只需將生產位置中的應用程式還原至完整存取。</span><span class="sxs-lookup"><span data-stu-id="03db0-151">To roll back the application to the pre-upgrade state you simply revert the application in the production slot to full access.</span></span> <span data-ttu-id="03db0-152">下圖顯示相關的步驟。</span><span class="sxs-lookup"><span data-stu-id="03db0-152">The steps involved are shown on the next diagram.</span></span>    

1. <span data-ttu-id="03db0-153">將資料庫複本設定為讀寫模式 (8)。</span><span class="sxs-lookup"><span data-stu-id="03db0-153">Set the database copy to read-write mode (8).</span></span> <span data-ttu-id="03db0-154">這會還原生產位置中完整的 V1 功能。</span><span class="sxs-lookup"><span data-stu-id="03db0-154">This will restore the full V1 functionally in the production slot.</span></span>
2. <span data-ttu-id="03db0-155">執行根本原因分析，然後移除預備位置 (9) 中遭到危害的元件。</span><span class="sxs-lookup"><span data-stu-id="03db0-155">Perform the root cause analysis and remove the compromised components in the stage slot (9).</span></span> 

<span data-ttu-id="03db0-156">此時應用程式已經可以完全運作，並且可以重複升級步驟。</span><span class="sxs-lookup"><span data-stu-id="03db0-156">At this point the application is fully functional and the upgrade steps can be repeated.</span></span>

> [!NOTE]
> <span data-ttu-id="03db0-157">復原不需要變更 WATM 設定檔，因為它已經指向 <i>contoso-1.azurewebsites.net</i> 作為作用中端點。</span><span class="sxs-lookup"><span data-stu-id="03db0-157">The rollback does not require changes in WATM profile as it already points to <i>contoso-1.azurewebsites.net</i> as the active endpoint.</span></span>
> 
> 

![SQL Database 異地複寫組態。](media/sql-database-manage-application-rolling-upgrade/Option1-4.png)

<span data-ttu-id="03db0-160">這個選項的重要**優點**是您可以使用一組簡單步驟升級單一區域中的應用程式。</span><span class="sxs-lookup"><span data-stu-id="03db0-160">The key **advantage** of this option is that you can upgrade an application in a single region using a set of simple steps.</span></span> <span data-ttu-id="03db0-161">升級的金額成本相對較低。</span><span class="sxs-lookup"><span data-stu-id="03db0-161">The dollar cost of the upgrade is relatively low.</span></span> <span data-ttu-id="03db0-162">主要的 **取捨** 是如果在升級期間發生嚴重失敗，復原到升級前狀態會需要將不同區域的應用程式重新部署，並使用異地復原從備份還原資料庫。</span><span class="sxs-lookup"><span data-stu-id="03db0-162">The main **tradeoff** is that if a catastrophic failure occurs during the upgrade the recovery to the pre-upgrade state will involve re-deployment of the application in a different region and restoring the database from backup using geo-restore.</span></span> <span data-ttu-id="03db0-163">此程序將產生顯著的停機時間。</span><span class="sxs-lookup"><span data-stu-id="03db0-163">This process will result in significant downtime.</span></span>   

## <a name="upgrading-applications-that-rely-on-database-geo-replication-for-disaster-recovery"></a><span data-ttu-id="03db0-164">升級依賴資料庫異地複寫來進行災害復原的應用程式</span><span class="sxs-lookup"><span data-stu-id="03db0-164">Upgrading applications that rely on database geo-replication for disaster recovery</span></span>
<span data-ttu-id="03db0-165">如果您的應用程式利用異地複寫來提供商務持續性，則它至少會部署到兩個不同區域，其中作用中部署會在「主要」區域，而待命部署則會在「備份」區域。</span><span class="sxs-lookup"><span data-stu-id="03db0-165">If your application leverages geo-replication for business continuity, it is deployed  to at least two different regions with an active deployment in Primary region and a standby deployment in Backup region.</span></span> <span data-ttu-id="03db0-166">除了先前提到的因素之外，升級程序也必須保證：</span><span class="sxs-lookup"><span data-stu-id="03db0-166">In addition to the factors mentioned earlier, the upgrade process must guarantee that:</span></span>

* <span data-ttu-id="03db0-167">升級程序期間，應用程式隨時受到保護以防嚴重失敗。</span><span class="sxs-lookup"><span data-stu-id="03db0-167">The application remains protected from catastrophic failures at all times during the upgrade process</span></span>
* <span data-ttu-id="03db0-168">應用程式的異地備援元件會與作用中元件以平行方式升級</span><span class="sxs-lookup"><span data-stu-id="03db0-168">The geo-redundant components of the application are upgraded in parallel with the active components</span></span>

<span data-ttu-id="03db0-169">若要達成這些目標，您要利用 Azure 流量管理員 (WATM)，使用含有一個作用中端點以及三個備份端點的容錯移轉設定檔。</span><span class="sxs-lookup"><span data-stu-id="03db0-169">To achieve these goals you will leverage Azure Traffic Manager (WATM) using the failover profile with one active and three backup endpoints.</span></span>  <span data-ttu-id="03db0-170">下圖說明升級程序之前的作業環境。</span><span class="sxs-lookup"><span data-stu-id="03db0-170">The following diagram illustrates the operational environment prior to the upgrade process.</span></span> <span data-ttu-id="03db0-171">網站 <i>contoso-1.azurewebsites.net</i> 和 <i>contoso-dr.azurewebsites.net</i> 代表具有完整異地備援之應用程式的生產位置。</span><span class="sxs-lookup"><span data-stu-id="03db0-171">The web sites <i>contoso-1.azurewebsites.net</i> and <i>contoso-dr.azurewebsites.net</i> represent a production slot of the application with full geographic redundancy.</span></span> <span data-ttu-id="03db0-172">若要啟用復原升級的功能，您必須建立含有應用程式完整同步之複本的預備位置。</span><span class="sxs-lookup"><span data-stu-id="03db0-172">To enable the ability to roll back the upgrade, you need create a stage slot with a fully synchronized copy of the application.</span></span> <span data-ttu-id="03db0-173">因為您必須確保應用程式可以快速復原，以防在升級程序期間發生嚴重失敗，因此預備位置也需要異地備援。</span><span class="sxs-lookup"><span data-stu-id="03db0-173">Because you need to ensure that the application can quickly recover in case a catastrophic failure occurs during the upgrade process, the stage slot needs to be geo-redundant as well.</span></span> <span data-ttu-id="03db0-174">準備升級應用程式需要執行下列步驟：</span><span class="sxs-lookup"><span data-stu-id="03db0-174">The following steps are required to prepare the application for the upgrade:</span></span>

1. <span data-ttu-id="03db0-175">為升級建立預備位置。</span><span class="sxs-lookup"><span data-stu-id="03db0-175">Create a stage slot for the upgrade.</span></span> <span data-ttu-id="03db0-176">若要這樣做，請建立次要資料庫 (1) 並在相同的 Azure 區域中部署相同的網站複本。</span><span class="sxs-lookup"><span data-stu-id="03db0-176">To do that create a secondary database (1) and deploy an identical copy of the web site in the same Azure region.</span></span> <span data-ttu-id="03db0-177">監視次要資料庫，查看植入程序是否完成。</span><span class="sxs-lookup"><span data-stu-id="03db0-177">Monitor the secondary to see if the seeding process is completed.</span></span>
2. <span data-ttu-id="03db0-178">將次要資料庫異地複寫至備份區域 (這裡稱為「鏈結異地複寫」)，在預備位置建立異地備援次要資料庫。</span><span class="sxs-lookup"><span data-stu-id="03db0-178">Create a geo-redundant secondary database in the stage slot by geo-replicating the secondary database to the backup region (this is called "chained geo-replication").</span></span> <span data-ttu-id="03db0-179">監視備份次要資料庫，查看植入程序是否完成 (3)。</span><span class="sxs-lookup"><span data-stu-id="03db0-179">Monitor the backup secondary to see if the seeding process is completed (3).</span></span>
3. <span data-ttu-id="03db0-180">在備份區域中建立網站待命複本，然後將它連結至異地備援次要資料庫 (4)。</span><span class="sxs-lookup"><span data-stu-id="03db0-180">Create a standby copy of the web site in the backup region and link it to the geo-redundant secondary (4).</span></span>  
4. <span data-ttu-id="03db0-181">將額外的端點 <i>contoso-2.azurewebsites.net</i> 和 <i>contoso-3.azurewebsites.net</i> 新增到 WATM 中的容錯移轉設定檔作為離線端點 (5)。</span><span class="sxs-lookup"><span data-stu-id="03db0-181">Add the additional endpoints <i>contoso-2.azurewebsites.net</i> and <i>contoso-3.azurewebsites.net</i> to the failover profile in WATM as offline endpoints (5).</span></span> 

> [!NOTE]
> <span data-ttu-id="03db0-182">請注意，準備步驟不會影響生產位置中的應用程式，且它可以在完整存取模式下運作。</span><span class="sxs-lookup"><span data-stu-id="03db0-182">Note the preparation steps will not impact the application in the production slot and it can function in full access mode.</span></span>
> 
> 

![SQL Database 異地複寫組態。](media/sql-database-manage-application-rolling-upgrade/Option2-1.png)

<span data-ttu-id="03db0-185">一旦準備步驟完成後，預備位置就準備好升級。</span><span class="sxs-lookup"><span data-stu-id="03db0-185">Once the preparation steps are completed, the stage slot is ready for the upgrade.</span></span> <span data-ttu-id="03db0-186">下圖說明升級步驟。</span><span class="sxs-lookup"><span data-stu-id="03db0-186">The following diagram illustrates the upgrade steps.</span></span>

1. <span data-ttu-id="03db0-187">將生產位置中的主要資料庫設定為唯讀模式 (6)。</span><span class="sxs-lookup"><span data-stu-id="03db0-187">Set the primary database in the production slot to read-only mode (6).</span></span> <span data-ttu-id="03db0-188">這樣會保證應用程式的生產執行個體 (V1) 在升級期間會保持唯讀，藉此防止 V1 與 V2 資料庫執行個體間的資料分歧。</span><span class="sxs-lookup"><span data-stu-id="03db0-188">This will guarantee that the production instance of the application (V1) will remain read-only during the upgrade thus preventing the data divergence between the V1 and V2 database instances.</span></span>  
2. <span data-ttu-id="03db0-189">使用規劃的終止模式 (7) 中斷相同區域內次要資料庫的連線。</span><span class="sxs-lookup"><span data-stu-id="03db0-189">Disconnect the secondary database in the same region using the planned termination mode (7).</span></span> <span data-ttu-id="03db0-190">它會建立主要資料庫完整同步的獨立複本，它會在終止後自動成為主要資料庫。</span><span class="sxs-lookup"><span data-stu-id="03db0-190">It will create a fully synchronized independent copy of the primary database, which will automatically become a primary after the termination.</span></span> <span data-ttu-id="03db0-191">此資料庫將會升級。</span><span class="sxs-lookup"><span data-stu-id="03db0-191">This database will be upgraded.</span></span>
3. <span data-ttu-id="03db0-192">將預備位置中的主要資料庫切換為讀寫模式，然後執行升級指令碼 (8)。</span><span class="sxs-lookup"><span data-stu-id="03db0-192">Turn the primary database in the stage slot to read-write mode and run the upgrade script (8).</span></span>    

![SQL Database 異地複寫組態。](media/sql-database-manage-application-rolling-upgrade/Option2-2.png)

<span data-ttu-id="03db0-195">如果升級順利完成，您現在已準備好將使用者切換至應用程式的 V2 版本。</span><span class="sxs-lookup"><span data-stu-id="03db0-195">If the upgrade completed successfully you are now ready to switch the end users to the V2 version of the application.</span></span> <span data-ttu-id="03db0-196">下圖說明相關步驟。</span><span class="sxs-lookup"><span data-stu-id="03db0-196">The following diagram illustrates the steps involved.</span></span>

1. <span data-ttu-id="03db0-197">將 WATM 設定檔中的作用中端點切換為 <i>contoso-2.azurewebsites.net</i>，它現在會指向 V2 版本的網站 (9)。</span><span class="sxs-lookup"><span data-stu-id="03db0-197">Switch the active endpoint in the WATM profile to <i>contoso-2.azurewebsites.net</i>, which now points to the V2 version of the web site (9).</span></span> <span data-ttu-id="03db0-198">它現在已成為 V2 應用程式的生產位置，而且使用者流量會導向至它。</span><span class="sxs-lookup"><span data-stu-id="03db0-198">It now becomes a production slot with the V2 application and end-user traffic is directed to it.</span></span> 
2. <span data-ttu-id="03db0-199">如果您不再需要 V1 應用程式，您可以安全地移除它 (10 和 11)。</span><span class="sxs-lookup"><span data-stu-id="03db0-199">If you no longer need the V1 application so you can safely remove it (10 and 11).</span></span>  

![SQL Database 異地複寫組態。](media/sql-database-manage-application-rolling-upgrade/Option2-3.png)

<span data-ttu-id="03db0-202">如果升級程序失敗 (例如升級指令碼中發生錯誤)，可能要將預備位置視為遭到危害。</span><span class="sxs-lookup"><span data-stu-id="03db0-202">If the upgrade process is unsuccessful, for example due to an error in the upgrade script, the stage slot should be considered compromised.</span></span> <span data-ttu-id="03db0-203">若要將應用程式復原到升級前狀態，您只需以完整存取使用生產位置中的應用程式即可復原。</span><span class="sxs-lookup"><span data-stu-id="03db0-203">To roll back the application to the pre-upgrade state you simply revert to using the application in the production slot with full access.</span></span> <span data-ttu-id="03db0-204">下圖顯示相關的步驟。</span><span class="sxs-lookup"><span data-stu-id="03db0-204">The steps involved are shown on the next diagram.</span></span>    

1. <span data-ttu-id="03db0-205">將生產位置中的主要資料庫複本設定為讀寫模式 (12)。</span><span class="sxs-lookup"><span data-stu-id="03db0-205">Set the primary database copy in the production slot to read-write mode (12).</span></span> <span data-ttu-id="03db0-206">這會還原生產位置中完整的 V1 功能。</span><span class="sxs-lookup"><span data-stu-id="03db0-206">This will restore the full V1 functionally in the production slot.</span></span>
2. <span data-ttu-id="03db0-207">執行根本原因分析，然後移除預備位置 (13 和 14) 中遭到危害的元件。</span><span class="sxs-lookup"><span data-stu-id="03db0-207">Perform the root cause analysis and remove the compromised components in the stage slot (13 and 14).</span></span> 

<span data-ttu-id="03db0-208">此時應用程式已經可以完全運作，並且可以重複升級步驟。</span><span class="sxs-lookup"><span data-stu-id="03db0-208">At this point the application is fully functional and the upgrade steps can be repeated.</span></span>

> [!NOTE]
> <span data-ttu-id="03db0-209">復原不需要變更 WATM 設定檔，因為它已經指向 <i>contoso-1.azurewebsites.net</i> 作為作用中端點。</span><span class="sxs-lookup"><span data-stu-id="03db0-209">The rollback does not require changes in WATM profile as it already points to  <i>contoso-1.azurewebsites.net</i> as the active endpoint.</span></span>
> 
> 

![SQL Database 異地複寫組態。](media/sql-database-manage-application-rolling-upgrade/Option2-4.png)

<span data-ttu-id="03db0-212">這個選項的重要 **優點** 是您可以以平行方式升級應用程式及其異地備援複本，而不會在升級期間危及商務持續性。</span><span class="sxs-lookup"><span data-stu-id="03db0-212">The key **advantage** of this option is that you can upgrade both the application and its geo-redundant copy in parallel without compromising your business continuity during the upgrade.</span></span> <span data-ttu-id="03db0-213">主要的 **取捨** 是它需要每個應用程式元件的雙重備援，因此會產生較高的金額成本。</span><span class="sxs-lookup"><span data-stu-id="03db0-213">The main **tradeoff** is that it requires double redundancy of each application component and therefore incurs higher dollar cost.</span></span> <span data-ttu-id="03db0-214">它也涉及更複雜的工作流程。</span><span class="sxs-lookup"><span data-stu-id="03db0-214">It also involves a more complicated workflow.</span></span> 

## <a name="summary"></a><span data-ttu-id="03db0-215">摘要</span><span class="sxs-lookup"><span data-stu-id="03db0-215">Summary</span></span>
<span data-ttu-id="03db0-216">本文中所描述的兩種升級方法有不同的複雜度與金額成本，但它們都著重於將使用者受限為唯讀作業的時間降到最低。</span><span class="sxs-lookup"><span data-stu-id="03db0-216">The two upgrade methods described in the article differ in complexity and the dollar cost but they both focus on minimizing the time when the end user is limited to read-only operations.</span></span> <span data-ttu-id="03db0-217">該時間由升級指令碼的期間直接定義。</span><span class="sxs-lookup"><span data-stu-id="03db0-217">That time is directly defined by the duration of the upgrade script.</span></span> <span data-ttu-id="03db0-218">時間不會取決於資料庫大小、您選擇的服務層，以及網站設定和其他您無法輕鬆控制的因素。</span><span class="sxs-lookup"><span data-stu-id="03db0-218">It does not depend on the database size, the service tier you chose, the web site configuration and other factors that you cannot easily control.</span></span> <span data-ttu-id="03db0-219">這是因為所有的準備步驟與升級步驟分離，並且不需影響實際執行應用程式即可完成。</span><span class="sxs-lookup"><span data-stu-id="03db0-219">This is because all the preparation steps are decoupled from the upgrade steps and can be done without impacting the production application.</span></span> <span data-ttu-id="03db0-220">升級指令的效率是決定升級期間使用者的體驗的重要因素。</span><span class="sxs-lookup"><span data-stu-id="03db0-220">The efficiency of the upgrade script is the key factor that determines the end-user experience during upgrades.</span></span> <span data-ttu-id="03db0-221">因此您改進效率的最佳方式，是把工作焦點放在盡可能提高升級指令碼的效率。</span><span class="sxs-lookup"><span data-stu-id="03db0-221">So the best way you can improve it is by focusing your efforts on making the upgrade script as efficient as possible.</span></span>  

## <a name="next-steps"></a><span data-ttu-id="03db0-222">後續步驟</span><span class="sxs-lookup"><span data-stu-id="03db0-222">Next steps</span></span>
* <span data-ttu-id="03db0-223">如需商務持續性概觀和案例，請參閱 [商務持續性概觀](sql-database-business-continuity.md)。</span><span class="sxs-lookup"><span data-stu-id="03db0-223">For a business continuity overview and scenarios, see [Business continuity overview](sql-database-business-continuity.md).</span></span>
* <span data-ttu-id="03db0-224">若要了解 Azure SQL Database 自動備份，請參閱 [SQL Database 自動備份](sql-database-automated-backups.md)。</span><span class="sxs-lookup"><span data-stu-id="03db0-224">To learn about Azure SQL Database automated backups, see [SQL Database automated backups](sql-database-automated-backups.md).</span></span>
* <span data-ttu-id="03db0-225">若要了解如何使用自動備份進行復原，請參閱[從自動備份還原資料庫](sql-database-recovery-using-backups.md)。</span><span class="sxs-lookup"><span data-stu-id="03db0-225">To learn about using automated backups for recovery, see [restore a database from automated backups](sql-database-recovery-using-backups.md).</span></span>
* <span data-ttu-id="03db0-226">若要了解更快速的復原選項，請參閱[主動式異地複寫](sql-database-geo-replication-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="03db0-226">To learn about faster recovery options, see [active geo-replication](sql-database-geo-replication-overview.md).</span></span>


