---
title: "使用 Azure SQL Database 在多租用戶應用程式中佈建新的租用戶 | Microsoft Docs"
description: "了解如何在 Wingtip SaaS 應用程式中佈建及編目新租用戶"
keywords: SQL Database Azure
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/11/2017
ms.author: sstein
ms.openlocfilehash: 8fa4c4f95386a92c8c818eef1a5b4de5a086fe07
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/18/2017
---
# <a name="provision-new-tenants-and-register-them-in-the-catalog"></a><span data-ttu-id="ef59e-104">佈建新的租用戶並在目錄中註冊它們</span><span class="sxs-lookup"><span data-stu-id="ef59e-104">Provision new tenants and register them in the catalog</span></span>

<span data-ttu-id="ef59e-105">在本教學課程中，您會了解佈建和目錄 SaaS 模式，以及這些模式在 Wingtip SaaS 應用程式中的實作方式。</span><span class="sxs-lookup"><span data-stu-id="ef59e-105">In this tutorial, you learn about the provision and catalog SaaS patterns, and how they are implemented in the Wingtip SaaS application.</span></span> <span data-ttu-id="ef59e-106">您會建立並初始化新的租用戶資料庫，並在應用程式的租用戶目錄中加以註冊。</span><span class="sxs-lookup"><span data-stu-id="ef59e-106">You create and initialize new tenant databases, and register them in the application’s tenant catalog.</span></span> <span data-ttu-id="ef59e-107">「目錄」是維護許多 SaaS 應用程式租用戶及其資料間之對應的資料庫。</span><span class="sxs-lookup"><span data-stu-id="ef59e-107">The catalog is a database that maintains the mapping between the SaaS application's many tenants and their data.</span></span> <span data-ttu-id="ef59e-108">目錄扮演將應用程式要求導向正確資料庫的重要角色。</span><span class="sxs-lookup"><span data-stu-id="ef59e-108">The catalog plays an important role directing application requests to the correct database.</span></span>  

<span data-ttu-id="ef59e-109">在本教學課程中，您將了解如何：</span><span class="sxs-lookup"><span data-stu-id="ef59e-109">In this tutorial, you learn how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="ef59e-110">佈建單一的新租用戶，包括逐步執行其實作方式</span><span class="sxs-lookup"><span data-stu-id="ef59e-110">Provision a single new tenant, including stepping through how this is implemented</span></span>
> * <span data-ttu-id="ef59e-111">佈建一批額外的租用戶</span><span class="sxs-lookup"><span data-stu-id="ef59e-111">Provision a batch of additional tenants</span></span>


<span data-ttu-id="ef59e-112">若要完成本教學課程，請確定已完成下列必要條件：</span><span class="sxs-lookup"><span data-stu-id="ef59e-112">To complete this tutorial, make sure the following prerequisites are completed:</span></span>

* <span data-ttu-id="ef59e-113">已部署 Wingtip SaaS 應用程式。</span><span class="sxs-lookup"><span data-stu-id="ef59e-113">The Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="ef59e-114">若要在五分鐘內完成部署，請參閱[部署及探索 Wingtip SaaS 應用程式](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="ef59e-114">To deploy in less than five minutes, see [Deploy and explore the Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="ef59e-115">已安裝 Azure PowerShell。</span><span class="sxs-lookup"><span data-stu-id="ef59e-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="ef59e-116">如需詳細資料，請參閱[開始使用 Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span><span class="sxs-lookup"><span data-stu-id="ef59e-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>

## <a name="introduction-to-the-saas-catalog-pattern"></a><span data-ttu-id="ef59e-117">SaaS 編目模式簡介</span><span class="sxs-lookup"><span data-stu-id="ef59e-117">Introduction to the SaaS Catalog pattern</span></span>

<span data-ttu-id="ef59e-118">在許多以資料庫為基礎的多租用戶 SaaS 應用程式中，知道每個租用戶的資訊儲存位置是很重要的。</span><span class="sxs-lookup"><span data-stu-id="ef59e-118">In a database-backed multi-tenant SaaS application, it's important to know where information for each tenant is stored.</span></span> <span data-ttu-id="ef59e-119">在 SaaS 目錄模式中，會使用目錄資料庫來保存每個租用戶及其資料儲存位置之間的對應。</span><span class="sxs-lookup"><span data-stu-id="ef59e-119">In the SaaS catalog pattern, a catalog database is used to hold the mapping between each tenant and where their data is stored.</span></span> <span data-ttu-id="ef59e-120">Wingtip SaaS 應用程式會每個資料庫架構都使用單一租用戶，但不論使用多租用戶或單一租用戶資料庫，都是套用在目錄中儲存租用戶與資料庫對應的基本模式。</span><span class="sxs-lookup"><span data-stu-id="ef59e-120">The Wingtip SaaS app uses a single-tenant per database architecture, but the basic pattern of storing tenant-to-database mapping in a catalog applies whether a multi-tenant or single-tenant database is used.</span></span>

<span data-ttu-id="ef59e-121">每個租用戶都會獲指派金鑰，可在目錄中識別租用戶，且已對應至適當資料庫的位置。</span><span class="sxs-lookup"><span data-stu-id="ef59e-121">Each tenant is assigned a key that identifies them in the catalog and which is mapped to the location of the appropriate database.</span></span> <span data-ttu-id="ef59e-122">在 Wingtip SaaS 應用程式中，金鑰是由租用戶名稱的雜湊組成。</span><span class="sxs-lookup"><span data-stu-id="ef59e-122">In the Wingtip SaaS app, the key is formed from a hash of the tenant’s name.</span></span> <span data-ttu-id="ef59e-123">這樣可讓應用程式 URL 的租用戶名稱部分用於建構金鑰。</span><span class="sxs-lookup"><span data-stu-id="ef59e-123">This allows the tenant name portion of the application URL to be used to construct the key.</span></span> <span data-ttu-id="ef59e-124">您可以使用其他租用戶金鑰的配置。</span><span class="sxs-lookup"><span data-stu-id="ef59e-124">Other tenant key schemes could be used.</span></span>  

<span data-ttu-id="ef59e-125">目錄可讓資料庫的名稱或位置在對應用程式影響最低的情況下進行變更。</span><span class="sxs-lookup"><span data-stu-id="ef59e-125">The catalog allows the name or location of the database to be changed with minimal impact on the application.</span></span>  <span data-ttu-id="ef59e-126">在多租用戶資料庫模型中，這也適用於在資料庫之間「移動」租用戶。</span><span class="sxs-lookup"><span data-stu-id="ef59e-126">In a multi-tenant database model, this also accommodates ‘moving’ a tenant between databases.</span></span>  <span data-ttu-id="ef59e-127">目錄也可用來指出租用戶或資料庫是否離線進行維護或其他動作。</span><span class="sxs-lookup"><span data-stu-id="ef59e-127">The catalog can also be used to indicate whether a tenant or database is offline for maintenance or other actions.</span></span> <span data-ttu-id="ef59e-128">這會在[還原單一租用戶教學課程](sql-database-saas-tutorial-restore-single-tenant.md)中加以探索。</span><span class="sxs-lookup"><span data-stu-id="ef59e-128">This is explored in the [restore single tenant tutorial](sql-database-saas-tutorial-restore-single-tenant.md).</span></span>

<span data-ttu-id="ef59e-129">此外，目錄實際上是 SaaS 應用程式的管理資料庫，可以儲存其他租用戶或資料庫中繼資料，例如資料庫層或版本、結構描述版本、服務方案或提供給租用戶的 SLA，以及可進行應用程式管理、客戶支援或 DevOps 程序的其他資訊。</span><span class="sxs-lookup"><span data-stu-id="ef59e-129">In addition, the catalog, which is in effect a management database for a SaaS application, can store additional tenant or database metadata, such as the tier or edition of a database, schema version, service plan, or SLAs offered to tenants, and other info that enables application management, customer support, or devops processes.</span></span>  

<span data-ttu-id="ef59e-130">SaaS 應用程式以外，目錄可以啟用資料庫工具。</span><span class="sxs-lookup"><span data-stu-id="ef59e-130">Beyond the SaaS application, the catalog can enable database tools.</span></span>  <span data-ttu-id="ef59e-131">在 Wingtip SaaS 範例中，目錄是用來啟用跨租用戶的查詢，可在[臨機操作分析教學課程](sql-database-saas-tutorial-adhoc-analytics.md)中加以探索。</span><span class="sxs-lookup"><span data-stu-id="ef59e-131">In the Wingtip SaaS sample, the catalog is used to enable cross-tenant query, explored in the [ad hoc analytics tutorial](sql-database-saas-tutorial-adhoc-analytics.md).</span></span> <span data-ttu-id="ef59e-132">跨資料庫作業管理可在[結構描述管理](sql-database-saas-tutorial-schema-management.md)和[租用戶分析](sql-database-saas-tutorial-tenant-analytics.md)教學課程中加以探索。</span><span class="sxs-lookup"><span data-stu-id="ef59e-132">Cross-database job management is explored in the [schema management](sql-database-saas-tutorial-schema-management.md) and [tenant analytics](sql-database-saas-tutorial-tenant-analytics.md) tutorials.</span></span> 

<span data-ttu-id="ef59e-133">在 Wingtip SaaS 應用程式中，會使用[彈性資料庫用戶端程式庫 (EDCL)](sql-database-elastic-database-client-library.md) 的「分區管理」功能來實作目錄。</span><span class="sxs-lookup"><span data-stu-id="ef59e-133">In the Wingtip SaaS app, the catalog is implemented using the Shard Management features of the [Elastic Database Client Library (EDCL)](sql-database-elastic-database-client-library.md).</span></span> <span data-ttu-id="ef59e-134">EDCL 可讓應用程式建立、管理及使用資料庫為基礎的分區對應。</span><span class="sxs-lookup"><span data-stu-id="ef59e-134">The EDCL enables an application to create, manage, and use a database-backed shard map.</span></span> <span data-ttu-id="ef59e-135">分區對應包含分區 (資料庫) 清單，以及金鑰 (租用戶) 與資料庫之間的對應。</span><span class="sxs-lookup"><span data-stu-id="ef59e-135">A shard map contains a list of shards (databases) and the mapping between keys (tenants) and databases.</span></span>  <span data-ttu-id="ef59e-136">在租用戶佈建期間，可從應用程式或 PowerShell 指令碼使用 EDCL 函式來建立分區對應中的項目，以及從應用程式有效率地連線到正確的資料庫。</span><span class="sxs-lookup"><span data-stu-id="ef59e-136">EDCL functions can be used from applications or PowerShell scripts during tenant provisioning to create the entries in the shard map, and from applications to efficiently connect to the correct database.</span></span> <span data-ttu-id="ef59e-137">EDCL 會快取連線資訊，以將對目錄資料庫的流量降到最低，並加快應用程式的速度。</span><span class="sxs-lookup"><span data-stu-id="ef59e-137">EDCL caches connection information to minimize the traffic to the catalog database and speed up the application.</span></span>  

> [!IMPORTANT]
> <span data-ttu-id="ef59e-138">對應資料可在類別目錄資料庫中取得，但請勿編輯它！</span><span class="sxs-lookup"><span data-stu-id="ef59e-138">The mapping data is accessible in the catalog database, but *don't edit it*!</span></span> <span data-ttu-id="ef59e-139">務必只使用彈性資料庫用戶端程式庫 API 編輯對應資料。</span><span class="sxs-lookup"><span data-stu-id="ef59e-139">Edit mapping data using Elastic Database Client Library APIs only.</span></span> <span data-ttu-id="ef59e-140">不支援直接操作對應資料，這樣做可能有造成類別目錄損毀的風險。</span><span class="sxs-lookup"><span data-stu-id="ef59e-140">Directly manipulating the mapping data risks corrupting the catalog and is not supported.</span></span>


## <a name="introduction-to-the-saas-provisioning-pattern"></a><span data-ttu-id="ef59e-141">SaaS 佈建模式簡介</span><span class="sxs-lookup"><span data-stu-id="ef59e-141">Introduction to the SaaS Provisioning pattern</span></span>

<span data-ttu-id="ef59e-142">在使用單一租用戶資料庫模型的 SaaS 應用程式中將新的租用戶上線時，必須佈建新的租用戶資料庫。</span><span class="sxs-lookup"><span data-stu-id="ef59e-142">When onboarding a new tenant in a SaaS application that uses a single-tenant database model a new tenant database must be provisioned.</span></span>  <span data-ttu-id="ef59e-143">它必須建立在適當的位置和服務層、使用適當的結構描述和參考資料進行初始化，然後在目錄中的適當租用戶金鑰下進行註冊。</span><span class="sxs-lookup"><span data-stu-id="ef59e-143">It must be created in the appropriate location and service tier, initialized with appropriate schema and reference data, and then registered in the catalog under the appropriate tenant key.</span></span>  

<span data-ttu-id="ef59e-144">可將不同的方法用於資料庫佈建，其中包括執行 SQL 指令碼、部署 bacpac，或複製「最佳」範本資料庫。</span><span class="sxs-lookup"><span data-stu-id="ef59e-144">Different approaches can be used to database provisioning, which could include executing SQL scripts, deploying a bacpac, or copying a 'golden' template database.</span></span>  

<span data-ttu-id="ef59e-145">必須在整體結構描述管理策略中了解您所使用的佈建方法，當中必須確保是使用最新的結構描述來佈建新的資料庫。</span><span class="sxs-lookup"><span data-stu-id="ef59e-145">The provisioning approach you use must be comprehended in your overall schema management strategy, which must ensure that new databases are provisioned with the latest schema.</span></span>  <span data-ttu-id="ef59e-146">這會在[結構描述管理教學課程](sql-database-saas-tutorial-schema-management.md)中加以探索。</span><span class="sxs-lookup"><span data-stu-id="ef59e-146">This is explored in the [schema management tutorial](sql-database-saas-tutorial-schema-management.md).</span></span>  

<span data-ttu-id="ef59e-147">Wingtip SaaS 應用程式會佈建新的租用戶，方法是複製目錄伺服器上所部署、名為 basetenantdb 的最佳資料庫。</span><span class="sxs-lookup"><span data-stu-id="ef59e-147">The Wingtip SaaS app provisions new tenants by copying a golden database named basetenantdb, deployed on the catalog server.</span></span>  <span data-ttu-id="ef59e-148">可將佈建整合到應用程式作為註冊體驗的一部分，及/或使用指令碼整合到支援的離線。</span><span class="sxs-lookup"><span data-stu-id="ef59e-148">Provisioning could be integrated into the application as part of a sign-up experience, and/or supported offline using scripts.</span></span> <span data-ttu-id="ef59e-149">本教學課程將會使用 PowerShell 來探索佈建。</span><span class="sxs-lookup"><span data-stu-id="ef59e-149">This tutorial will explore provisioning using PowerShell.</span></span> <span data-ttu-id="ef59e-150">佈建指令碼會複製 basetenantdb，以在彈性集區中建立新的租用戶資料庫，然後使用租用戶專屬的資訊進行初始化，並在目錄分區對應中進行註冊。</span><span class="sxs-lookup"><span data-stu-id="ef59e-150">The provisioning scripts copy the basetenantdb to create a new tenant database in an elastic pool, then initialize it with tenant-specific info and register it in the catalog shard map.</span></span>  <span data-ttu-id="ef59e-151">在範例應用程式中，會以租用戶名稱作為基礎來指定資料庫的名稱，但這並非模式的重要部分 – 使用目錄可讓任何名稱指派給資料庫。</span><span class="sxs-lookup"><span data-stu-id="ef59e-151">In the sample app, databases are given names based on the tenant name, but this is not a critical part of the pattern – the use of the catalog allows any name to be assigned to the database.+</span></span> 


## <a name="get-the-wingtip-application-scripts"></a><span data-ttu-id="ef59e-152">取得 Wingtip 應用程式指令碼</span><span class="sxs-lookup"><span data-stu-id="ef59e-152">Get the Wingtip application scripts</span></span>

<span data-ttu-id="ef59e-153">在 [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) Github 存放庫可取得 Wingtip Tickets 指令碼和應用程式原始程式碼。</span><span class="sxs-lookup"><span data-stu-id="ef59e-153">The Wingtip SaaS scripts and application source code are available in the [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="ef59e-154">[用於下載 Wingtip SaaS 指令碼的步驟](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts)。</span><span class="sxs-lookup"><span data-stu-id="ef59e-154">[Steps to download the Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>


## <a name="provision-and-catalog-detailed-walkthrough"></a><span data-ttu-id="ef59e-155">佈建及編目的詳細逐步解說</span><span class="sxs-lookup"><span data-stu-id="ef59e-155">Provision and catalog detailed walkthrough</span></span>

<span data-ttu-id="ef59e-156">若要了解 Wingtip 應用程式如何實作新的租用戶佈建，請在佈建租用戶時，新增中斷點並逐步執行工作流程：</span><span class="sxs-lookup"><span data-stu-id="ef59e-156">To understand how the Wingtip application implements new tenant provisioning, add a breakpoint and step through the workflow while provisioning a tenant:</span></span>

1. <span data-ttu-id="ef59e-157">開啟 ...\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ 並設定下列參數：</span><span class="sxs-lookup"><span data-stu-id="ef59e-157">Open ...\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ and set the following parameters:</span></span>
   * <span data-ttu-id="ef59e-158">**$TenantName** = 新場地的名稱 (例如，*Bushwillow Blues*)。</span><span class="sxs-lookup"><span data-stu-id="ef59e-158">**$TenantName** = the name of the new venue (for example, *Bushwillow Blues*).</span></span>
   * <span data-ttu-id="ef59e-159">**$VenueType** = 其中一個預先定義的場地類型：blues、classicalmusic、dance、jazz、judo、motorracing、multipurpose、opera、rockmusic、soccer。</span><span class="sxs-lookup"><span data-stu-id="ef59e-159">**$VenueType** = one of the pre-defined venue types: *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.</span></span>
   * <span data-ttu-id="ef59e-160">**$DemoScenario** = **1**，設定為 **1** 以「佈建單一租用戶」。</span><span class="sxs-lookup"><span data-stu-id="ef59e-160">**$DemoScenario** = **1**, Set to **1** to *Provision a single tenant*.</span></span>

1. <span data-ttu-id="ef59e-161">將游標置於以第 48 行 (該行顯示︰*New-Tenant \`*) 上的任意位置來新增中斷點，然後按 **F9**。</span><span class="sxs-lookup"><span data-stu-id="ef59e-161">Add a breakpoint by putting your cursor anywhere on line 48, the line that says: *New-Tenant \`*, and press **F9**.</span></span>

   ![中斷點](media/sql-database-saas-tutorial-provision-and-catalog/breakpoint.png)

1. <span data-ttu-id="ef59e-163">若要執行指令碼，請按 **F5**。</span><span class="sxs-lookup"><span data-stu-id="ef59e-163">To run the script press **F5**.</span></span>

1. <span data-ttu-id="ef59e-164">在指令碼於中斷點停止執行之後，請按 **F11** 進入程式碼。</span><span class="sxs-lookup"><span data-stu-id="ef59e-164">After the script execution stops at the breakpoint, press **F11** to step into the code.</span></span>

   ![中斷點](media/sql-database-saas-tutorial-provision-and-catalog/debug.png)



<span data-ttu-id="ef59e-166">使用 [偵錯] 功能表選項追蹤指令碼的執行 - **F10** 和 **F11** 可以跳過或進入呼叫的函式。</span><span class="sxs-lookup"><span data-stu-id="ef59e-166">Trace the script's execution using the **Debug** menu options - **F10** and **F11** to step over or into the called functions.</span></span> <span data-ttu-id="ef59e-167">如需對 PowerShell 指令碼進行偵錯的詳細資訊，請參閱[使用 PowerShell 指令碼及對其進行偵錯的祕訣](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise) \(英文\)。</span><span class="sxs-lookup"><span data-stu-id="ef59e-167">For more information about debugging PowerShell scripts, see [Tips on working with and debugging PowerShell scripts](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).</span></span>


<span data-ttu-id="ef59e-168">以下並非要明確遵循的步驟，而是您在進行指令碼偵錯時逐步執行之工作流程的說明：</span><span class="sxs-lookup"><span data-stu-id="ef59e-168">The following are not steps to explicitly follow, but an explanation of the workflow you step through while debugging the script:</span></span>

1. <span data-ttu-id="ef59e-169">將包含用於登入之函式的 **SubscriptionManagement.psm1** 模組匯入到 Azure，並選取您正在使用的 Azure 訂用帳戶。</span><span class="sxs-lookup"><span data-stu-id="ef59e-169">**Import the SubscriptionManagement.psm1** module that contains functions for signing in to Azure and selecting the Azure subscription you are working with.</span></span>
1. <span data-ttu-id="ef59e-170">匯入對[分區管理](sql-database-elastic-scale-shard-map-management.md)函式提供類別目錄和租用戶層級抽象概念的 **CatalogAndDatabaseManagement.psm1** 模組。</span><span class="sxs-lookup"><span data-stu-id="ef59e-170">**Import the CatalogAndDatabaseManagement.psm1** module that provides a catalog and tenant-level abstraction over the [Shard Management](sql-database-elastic-scale-shard-map-management.md) functions.</span></span> <span data-ttu-id="ef59e-171">此模組很重要且值得探討，其中包含大部分的編目模式。</span><span class="sxs-lookup"><span data-stu-id="ef59e-171">This is an important module that encapsulates much of the catalog pattern and is worth exploring.</span></span>
1. <span data-ttu-id="ef59e-172">**取得設定詳細資料**。</span><span class="sxs-lookup"><span data-stu-id="ef59e-172">**Get configuration details**.</span></span> <span data-ttu-id="ef59e-173">逐步執行 Get-Configuration (使用 F11) 並查看指定應用程式設定的方式。</span><span class="sxs-lookup"><span data-stu-id="ef59e-173">Step into Get-Configuration (with F11) and see how the app config is specified.</span></span> <span data-ttu-id="ef59e-174">資源名稱和其他應用程式特定值是在這裡定義的，但在您熟悉指令碼之前，請勿變更這裡的任何值。</span><span class="sxs-lookup"><span data-stu-id="ef59e-174">Resource names and other app-specific values are defined here, but do not change any of these values until you are familiar with the scripts.</span></span>
1. <span data-ttu-id="ef59e-175">**取得類別目錄物件**。</span><span class="sxs-lookup"><span data-stu-id="ef59e-175">**Get the catalog object**.</span></span> <span data-ttu-id="ef59e-176">逐步執行 Get-Catalog，其會撰寫並傳回較高層級指令碼中使用的目錄物件。</span><span class="sxs-lookup"><span data-stu-id="ef59e-176">Step into Get-Catalog which composes and returns a catalog object that is used in the higher-level script.</span></span>  <span data-ttu-id="ef59e-177">此函式會使用從 **AzureShardManagement.psm1** 匯入的分區管理函式。</span><span class="sxs-lookup"><span data-stu-id="ef59e-177">This function uses Shard Management functions that are imported from **AzureShardManagement.psm1**.</span></span> <span data-ttu-id="ef59e-178">目錄物件是由下列項目組成：</span><span class="sxs-lookup"><span data-stu-id="ef59e-178">The catalog object is composed of the following:</span></span>
   * <span data-ttu-id="ef59e-179">$catalogServerFullyQualifiedName 是使用標準主幹加上您的 [使用者] 名稱來建構：_catalog-\<使用者\>.database.windows.net_。</span><span class="sxs-lookup"><span data-stu-id="ef59e-179">$catalogServerFullyQualifiedName is constructed using the standard stem plus your User name: _catalog-\<user\>.database.windows.net_.</span></span>
   * <span data-ttu-id="ef59e-180">$catalogDatabaseName 是從下列設定擷取：*tenantcatalog*。</span><span class="sxs-lookup"><span data-stu-id="ef59e-180">$catalogDatabaseName is retrieved from the config: *tenantcatalog*.</span></span>
   * <span data-ttu-id="ef59e-181">$shardMapManager 物件是從類別目錄資料庫初始化。</span><span class="sxs-lookup"><span data-stu-id="ef59e-181">$shardMapManager object is initialized from the catalog database.</span></span>
   * <span data-ttu-id="ef59e-182">$shardMap 物件是從類別目錄資料庫中的 *tenantcatalog* 分區對應初始化。</span><span class="sxs-lookup"><span data-stu-id="ef59e-182">$shardMap object is initialized from the *tenantcatalog* shard map in the catalog database.</span></span>
   <span data-ttu-id="ef59e-183">系統會組成並傳回類別目錄物件，並用於較高層級的指令碼中。</span><span class="sxs-lookup"><span data-stu-id="ef59e-183">A catalog object is composed and returned, and used in the higher-level script.</span></span>
1. <span data-ttu-id="ef59e-184">**計算新的租用戶索引鍵**。</span><span class="sxs-lookup"><span data-stu-id="ef59e-184">**Calculate the new tenant key**.</span></span> <span data-ttu-id="ef59e-185">會使用雜湊函式從租用戶名稱建立租用戶索引鍵。</span><span class="sxs-lookup"><span data-stu-id="ef59e-185">A hash function is used to create the tenant key from the tenant name.</span></span>
1. <span data-ttu-id="ef59e-186">**檢查租用戶索引鍵是否已存在**。</span><span class="sxs-lookup"><span data-stu-id="ef59e-186">**Check if the tenant key already exists**.</span></span> <span data-ttu-id="ef59e-187">會檢查類別目錄以確定索引鍵可供使用。</span><span class="sxs-lookup"><span data-stu-id="ef59e-187">The catalog is checked to ensure the key is available.</span></span>
1. <span data-ttu-id="ef59e-188">**租用戶資料庫是使用 New-TenantDatabase 來佈建。**</span><span class="sxs-lookup"><span data-stu-id="ef59e-188">**The tenant database is provisioned with New-TenantDatabase.**</span></span> <span data-ttu-id="ef59e-189">使用 **F11** 來逐步執行並查看使用 [Azure Resource Manager 範本](../azure-resource-manager/resource-manager-template-walkthrough.md)佈建資料庫的方式。</span><span class="sxs-lookup"><span data-stu-id="ef59e-189">Use **F11** to step in and see how the database is provisioned using an [Azure Resource Manager template](../azure-resource-manager/resource-manager-template-walkthrough.md).</span></span>

<span data-ttu-id="ef59e-190">資料庫名稱是使用租用戶名稱來建構，使分區和租用戶之間的從屬關係一目瞭然</span><span class="sxs-lookup"><span data-stu-id="ef59e-190">The database name is constructed from the tenant name to make it clear which shard belongs to which tenant.</span></span> <span data-ttu-id="ef59e-191">(輕鬆就能使用其他資料庫命名策略)。Resource Manager 範本會用來建立租用戶資料庫，方法是在類別目錄伺服器上複製「範本」資料庫 (baseTenantDB)。</span><span class="sxs-lookup"><span data-stu-id="ef59e-191">(Other strategies for database naming could easily be used.)+ A Resource Manager template is used to create a tenant database by copying a golden database (baseTenantDB) on the catalog server.</span></span> <span data-ttu-id="ef59e-192">另一個方法是先建立空資料庫，然後透過匯入 bacpac 將它初始化，或從已知位置執行初始化指令碼。</span><span class="sxs-lookup"><span data-stu-id="ef59e-192">An alternative approach could be to create an empty database and then initialize it by importing a bacpac, or to execute an initialization script from a well-known location.</span></span>  

<span data-ttu-id="ef59e-193">Resource Manager 範本位於 …\Learning Modules\Common\ 資料夾：tenantdatabasecopytemplate.json</span><span class="sxs-lookup"><span data-stu-id="ef59e-193">The Resource Manager template is in the …\Learning Modules\Common\ folder: *tenantdatabasecopytemplate.json*</span></span>

<span data-ttu-id="ef59e-194">建立租用戶資料庫之後，會進一步**使用場地 (租用戶) 名稱和場地類型將它初始化**。</span><span class="sxs-lookup"><span data-stu-id="ef59e-194">After the tenant database is created, it is then further **initialized with the venue (tenant) name and the venue type**.</span></span> <span data-ttu-id="ef59e-195">也可以在此進行其他初始化。</span><span class="sxs-lookup"><span data-stu-id="ef59e-195">Other initialization could also be done here.</span></span>

<span data-ttu-id="ef59e-196">租用戶資料庫會以 Add-TenantDatabaseToCatalog 使用租用戶金鑰**在類別目錄中註冊**。</span><span class="sxs-lookup"><span data-stu-id="ef59e-196">The **tenant database is registered in the catalog** with *Add-TenantDatabaseToCatalog* using the tenant key.</span></span> <span data-ttu-id="ef59e-197">使用 **F11** 來逐步執行以查看詳細資料：</span><span class="sxs-lookup"><span data-stu-id="ef59e-197">Use **F11** to step into the details:</span></span>

* <span data-ttu-id="ef59e-198">類別目錄資料庫已新增到分區對應 (已知資料庫的清單)。</span><span class="sxs-lookup"><span data-stu-id="ef59e-198">The catalog database is added to the shard map (the list of known databases).</span></span>
* <span data-ttu-id="ef59e-199">已建立將索引鍵值連結到分區的對應。</span><span class="sxs-lookup"><span data-stu-id="ef59e-199">The mapping that links the key value to the shard is created.</span></span>
* <span data-ttu-id="ef59e-200">已將租用戶相關的其他中繼資料 (場地的名稱) 新增至目錄中的租用戶資料表。</span><span class="sxs-lookup"><span data-stu-id="ef59e-200">Additional meta data (the venue's name) about the tenant is added to the Tenants table in the catalog.</span></span>  <span data-ttu-id="ef59e-201">租用戶資料表並非 ShardManagement 結構描述的一部分，且不是由 EDCL 安裝。</span><span class="sxs-lookup"><span data-stu-id="ef59e-201">The Tenants table is not part of the ShardManagement schema and is not installed by the EDCL.</span></span>  <span data-ttu-id="ef59e-202">這份表格說明如何擴充目錄資料庫，以支援其他應用程式特定的資料。</span><span class="sxs-lookup"><span data-stu-id="ef59e-202">This table illustrates how the Catalog database can be extended to support additional application-specific data.</span></span>   


<span data-ttu-id="ef59e-203">佈建完成之後，執行會返回到原始的 *Demo-ProvisionAndCatalog* 指令碼，這會在瀏覽器中開啟新租用戶的 [Events (活動)] 頁面：</span><span class="sxs-lookup"><span data-stu-id="ef59e-203">After provisioning completes, execution returns to the original *Demo-ProvisionAndCatalog* script, which opens the **Events** page for the new tenant in the browser:</span></span>

   ![活動](media/sql-database-saas-tutorial-provision-and-catalog/new-tenant.png)


## <a name="provision-a-batch-of-tenants"></a><span data-ttu-id="ef59e-205">佈建一批租用戶</span><span class="sxs-lookup"><span data-stu-id="ef59e-205">Provision a batch of tenants</span></span>

<span data-ttu-id="ef59e-206">此練習會佈建一批 17 個租用戶。</span><span class="sxs-lookup"><span data-stu-id="ef59e-206">This exercise provisions a batch of 17 tenants.</span></span> <span data-ttu-id="ef59e-207">建議您在開始其他 Wingtip SaaS 教學課程之前佈建這一批租用戶，才會有多個資料庫可以使用。</span><span class="sxs-lookup"><span data-stu-id="ef59e-207">It’s recommended you provision this batch of tenants before starting other Wingtip SaaS tutorials, so there's more than just a few databases to work with.</span></span>

1. <span data-ttu-id="ef59e-208">在 [PowerShell ISE] 中開啟 ...\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1*，並將 *$DemoScenario* 參數變更為 3：</span><span class="sxs-lookup"><span data-stu-id="ef59e-208">Open ...\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* in the *PowerShell ISE* and change the *$DemoScenario* parameter to 3:</span></span>
   * <span data-ttu-id="ef59e-209">**$DemoScenario** = **3**，變更為 **3** 以「佈建一批租用戶」。</span><span class="sxs-lookup"><span data-stu-id="ef59e-209">**$DemoScenario** = **3**, change to **3** to *Provision a batch of tenants*.</span></span>
1. <span data-ttu-id="ef59e-210">按 **F5** 並執行指令碼。</span><span class="sxs-lookup"><span data-stu-id="ef59e-210">Press **F5** and run the script.</span></span>

<span data-ttu-id="ef59e-211">此指令碼會部署一批額外的租用戶。</span><span class="sxs-lookup"><span data-stu-id="ef59e-211">The script deploys a batch of additional tenants.</span></span> <span data-ttu-id="ef59e-212">它會使用控制批次處理的 [Azure Resource Manager 範本](../azure-resource-manager/resource-manager-template-walkthrough.md)，並且將每個資料庫的佈建委派到連結的範本。</span><span class="sxs-lookup"><span data-stu-id="ef59e-212">It uses an [Azure Resource Manager template](../azure-resource-manager/resource-manager-template-walkthrough.md) that controls the batch and then delegates provisioning of each database to a linked template.</span></span> <span data-ttu-id="ef59e-213">以此方式使用範本可讓 Azure Resource Manager 代理指令碼的佈建程序。</span><span class="sxs-lookup"><span data-stu-id="ef59e-213">Using templates in this way allows Azure Resource Manager to broker the provisioning process for your script.</span></span> <span data-ttu-id="ef59e-214">範本以平行方式佈建資料庫，它可以視需要處理重試，進而最佳化整體程序。</span><span class="sxs-lookup"><span data-stu-id="ef59e-214">Templates provision databases in parallel where it can, and handles retries if needed, optimizing the overall process.</span></span> <span data-ttu-id="ef59e-215">指令碼為等冪，如果它失敗，或因為任何原因而停止，請再次執行。</span><span class="sxs-lookup"><span data-stu-id="ef59e-215">The script is idempotent so if it fails or stops for any reason, run it again.</span></span>

### <a name="verify-the-batch-of-tenants-successfully-deployed"></a><span data-ttu-id="ef59e-216">確認已成功部署一批租用戶</span><span class="sxs-lookup"><span data-stu-id="ef59e-216">Verify the batch of tenants successfully deployed</span></span>

* <span data-ttu-id="ef59e-217">在 [Azure 入口網站](https://portal.azure.com)中瀏覽到您的伺服器清單以開啟 *tenants1* 伺服器，按一下 [SQL 資料庫]，並驗證清單中有一批額外的 17 個資料庫：</span><span class="sxs-lookup"><span data-stu-id="ef59e-217">Open the *tenants1* server by browsing to your list of servers in the [Azure portal](https://portal.azure.com), click **SQL databases**, and verify the batch of 17 additional databases are now in the list:</span></span>

   ![資料庫清單](media/sql-database-saas-tutorial-provision-and-catalog/database-list.png)



## <a name="other-provisioning-patterns"></a><span data-ttu-id="ef59e-219">其他佈建模式</span><span class="sxs-lookup"><span data-stu-id="ef59e-219">Other provisioning patterns</span></span>

<span data-ttu-id="ef59e-220">未包含在此教學課程中的其他佈建模式包括：</span><span class="sxs-lookup"><span data-stu-id="ef59e-220">Other provisioning patterns not included in this tutorial include:</span></span>

<span data-ttu-id="ef59e-221">**預先佈建資料庫。**</span><span class="sxs-lookup"><span data-stu-id="ef59e-221">**Pre-provisioning databases.**</span></span> <span data-ttu-id="ef59e-222">預先佈建模式會利用彈性集區中的資料庫，並不會增加額外成本。</span><span class="sxs-lookup"><span data-stu-id="ef59e-222">The pre-provisioning pattern exploits the fact that databases in an elastic pool do not add extra cost.</span></span> <span data-ttu-id="ef59e-223">針對彈性集區計費，而不是資料庫，而且閒置資料庫不會耗用任何資源。</span><span class="sxs-lookup"><span data-stu-id="ef59e-223">Billing is for the elastic pool, not the databases, and idle databases consume no resources.</span></span> <span data-ttu-id="ef59e-224">藉由在集區中預先佈建資料庫，並在需要時才配置它們，可以大幅降低租用戶上線時間。</span><span class="sxs-lookup"><span data-stu-id="ef59e-224">By pre-provisioning databases in a pool and allocating them when needed, tenant onboarding time can be reduced significantly.</span></span> <span data-ttu-id="ef59e-225">可以視需要調整預先佈建的資料庫數目，以針對預期的佈建率保留適當的緩衝。</span><span class="sxs-lookup"><span data-stu-id="ef59e-225">The number of databases pre-provisioned could be adjusted as needed to keep a buffer suitable for the anticipated provisioning rate.</span></span>

<span data-ttu-id="ef59e-226">**自動佈建。**</span><span class="sxs-lookup"><span data-stu-id="ef59e-226">**Auto-provisioning.**</span></span> <span data-ttu-id="ef59e-227">在自動佈建模式中，會使用專用的佈建服務，視需要自動佈建伺服器、集區與資料庫 - 包括在彈性集區中預先佈建資料庫 (若有需要)。</span><span class="sxs-lookup"><span data-stu-id="ef59e-227">In the auto-provisioning pattern, a dedicated provisioning service is used to provision servers, pools, and databases automatically as needed – including pre-provisioning databases in elastic pools if desired.</span></span> <span data-ttu-id="ef59e-228">如果資料庫已被解除委任並刪除，可以視需要以佈建服務填入彈性集區中的間隔。</span><span class="sxs-lookup"><span data-stu-id="ef59e-228">And if databases are de-commissioned and deleted, gaps in elastic pools can be filled by the provisioning service as desired.</span></span> <span data-ttu-id="ef59e-229">此類服務可以是簡單或複雜的 (例如，跨多個地理位置處理佈建)，且如果已針對災害復原使用異地複寫，就可自動設定該策略。</span><span class="sxs-lookup"><span data-stu-id="ef59e-229">Such a service could be simple or complex – for example, handling provisioning across multiple geographies, and could set up geo-replication automatically if that strategy is being used for disaster recovery.</span></span> <span data-ttu-id="ef59e-230">若使用自動佈建模式，用戶端應用程式或指令碼會將佈建要求送出到將由佈建服務處理的佇列，然後會輪詢該服務以判斷是否完成。</span><span class="sxs-lookup"><span data-stu-id="ef59e-230">With the auto-provisioning pattern, a client application or script would submit a provisioning request to a queue to be processed by the provisioning service, and would then poll the service to determine completion.</span></span> <span data-ttu-id="ef59e-231">若使用預先佈建，則會使用在背景執行的服務 (負責管理替代資料庫的佈建) 來快速處理要求。</span><span class="sxs-lookup"><span data-stu-id="ef59e-231">If pre-provisioning is used, requests would be handled quickly with the service managing provisioning of a replacement database running in the background.</span></span>



## <a name="next-steps"></a><span data-ttu-id="ef59e-232">後續步驟</span><span class="sxs-lookup"><span data-stu-id="ef59e-232">Next steps</span></span>

<span data-ttu-id="ef59e-233">在本教學課程中，您已了解如何：</span><span class="sxs-lookup"><span data-stu-id="ef59e-233">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="ef59e-234">佈建單一新租用戶</span><span class="sxs-lookup"><span data-stu-id="ef59e-234">Provision a single new tenant</span></span>
> * <span data-ttu-id="ef59e-235">佈建一批額外的租用戶</span><span class="sxs-lookup"><span data-stu-id="ef59e-235">Provision a batch of additional tenants</span></span>
> * <span data-ttu-id="ef59e-236">了解佈建租用戶和將它們註冊到目錄的細節</span><span class="sxs-lookup"><span data-stu-id="ef59e-236">Step into the details of provisioning tenants, and registering them into the catalog</span></span>

<span data-ttu-id="ef59e-237">試用[效能監視教學課程](sql-database-saas-tutorial-performance-monitoring.md)。</span><span class="sxs-lookup"><span data-stu-id="ef59e-237">Try the [Performance monitoring tutorial](sql-database-saas-tutorial-performance-monitoring.md).</span></span>

## <a name="additional-resources"></a><span data-ttu-id="ef59e-238">其他資源</span><span class="sxs-lookup"><span data-stu-id="ef59e-238">Additional Resources</span></span>

* <span data-ttu-id="ef59e-239">其他[以 Wingtip SaaS 應用程式為基礎的教學課程](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="ef59e-239">Additional [tutorials that build upon the Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="ef59e-240">彈性資料庫用戶端程式庫</span><span class="sxs-lookup"><span data-stu-id="ef59e-240">Elastic database client library</span></span>](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-database-client-library)
* [<span data-ttu-id="ef59e-241">如何在 Windows PowerShell ISE 中針對指令碼進行偵錯</span><span class="sxs-lookup"><span data-stu-id="ef59e-241">How to Debug Scripts in Windows PowerShell ISE</span></span>](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)
