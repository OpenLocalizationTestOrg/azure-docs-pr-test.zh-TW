---
title: "在多租用戶應用程式中使用 Azure SQL Database aaaProvision 新的租用戶 |Microsoft 文件"
description: "了解如何 tooprovision 和新的類別目錄中的租用戶 hello Wingtip SaaS 應用程式"
keywords: SQL Database Azure
services: sql-database
documentationcenter: 
author: stevestein
manager: craigg
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/11/2017
ms.author: sstein
ms.openlocfilehash: eb26f523305650c2124e36707d187dfcdad06fcc
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="provision-new-tenants-and-register-them-in-hello-catalog"></a><span data-ttu-id="997af-104">新的租用戶佈建並 hello 目錄中註冊這些元件</span><span class="sxs-lookup"><span data-stu-id="997af-104">Provision new tenants and register them in hello catalog</span></span>

<span data-ttu-id="997af-105">在本教學課程中，您會了解 hello 佈建和類別目錄 SaaS 模式，以及在 hello Wingtip SaaS 應用程式中的實作方式。</span><span class="sxs-lookup"><span data-stu-id="997af-105">In this tutorial, you learn about hello provision and catalog SaaS patterns, and how they are implemented in hello Wingtip SaaS application.</span></span> <span data-ttu-id="997af-106">您會建立並初始化新的租用戶資料庫和 hello 應用程式的租用戶目錄中註冊。</span><span class="sxs-lookup"><span data-stu-id="997af-106">You create and initialize new tenant databases, and register them in hello application’s tenant catalog.</span></span> <span data-ttu-id="997af-107">hello 目錄是資料庫中，維護 hello hello SaaS 應用程式的多個租用戶和其資料之間的對應。</span><span class="sxs-lookup"><span data-stu-id="997af-107">hello catalog is a database that maintains hello mapping between hello SaaS application's many tenants and their data.</span></span> <span data-ttu-id="997af-108">hello 目錄扮演重要角色導向應用程式要求 toohello 正確的資料庫。</span><span class="sxs-lookup"><span data-stu-id="997af-108">hello catalog plays an important role directing application requests toohello correct database.</span></span>  

<span data-ttu-id="997af-109">在本教學課程中，您將了解如何：</span><span class="sxs-lookup"><span data-stu-id="997af-109">In this tutorial, you learn how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="997af-110">佈建單一的新租用戶，包括逐步執行其實作方式</span><span class="sxs-lookup"><span data-stu-id="997af-110">Provision a single new tenant, including stepping through how this is implemented</span></span>
> * <span data-ttu-id="997af-111">佈建一批額外的租用戶</span><span class="sxs-lookup"><span data-stu-id="997af-111">Provision a batch of additional tenants</span></span>


<span data-ttu-id="997af-112">toocomplete 完成本教學課程，請確定 hello 下列必要條件：</span><span class="sxs-lookup"><span data-stu-id="997af-112">toocomplete this tutorial, make sure hello following prerequisites are completed:</span></span>

* <span data-ttu-id="997af-113">hello Wingtip SaaS 應用程式部署。</span><span class="sxs-lookup"><span data-stu-id="997af-113">hello Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="997af-114">toodeploy 在五分鐘內，請參閱[部署及瀏覽 hello Wingtip SaaS 應用程式](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="997af-114">toodeploy in less than five minutes, see [Deploy and explore hello Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="997af-115">已安裝 Azure PowerShell。</span><span class="sxs-lookup"><span data-stu-id="997af-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="997af-116">如需詳細資料，請參閱[開始使用 Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span><span class="sxs-lookup"><span data-stu-id="997af-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>

## <a name="introduction-toohello-saas-catalog-pattern"></a><span data-ttu-id="997af-117">簡介 toohello SaaS 目錄模式</span><span class="sxs-lookup"><span data-stu-id="997af-117">Introduction toohello SaaS Catalog pattern</span></span>

<span data-ttu-id="997af-118">在資料庫備份多租用戶 SaaS 應用程式中，很重要的 tooknow 儲存每個租用戶的資訊。</span><span class="sxs-lookup"><span data-stu-id="997af-118">In a database-backed multi-tenant SaaS application, it's important tooknow where information for each tenant is stored.</span></span> <span data-ttu-id="997af-119">在 hello SaaS 目錄模式中，類別目錄資料庫是使用的 toohold hello 對應每個租用戶之間，以及其資料的儲存位置。</span><span class="sxs-lookup"><span data-stu-id="997af-119">In hello SaaS catalog pattern, a catalog database is used toohold hello mapping between each tenant and where their data is stored.</span></span> <span data-ttu-id="997af-120">hello Wingtip SaaS 應用程式使用單一租用戶，每個資料庫架構，但儲存到資料庫租用戶對應的目錄中的 hello 基本模式適用於是否會使用多租用戶或單一租用戶的資料庫。</span><span class="sxs-lookup"><span data-stu-id="997af-120">hello Wingtip SaaS app uses a single-tenant per database architecture, but hello basic pattern of storing tenant-to-database mapping in a catalog applies whether a multi-tenant or single-tenant database is used.</span></span>

<span data-ttu-id="997af-121">每個租用戶指派可識別它們 hello 目錄中的索引鍵，這是對應 toohello hello 適當資料庫位置。</span><span class="sxs-lookup"><span data-stu-id="997af-121">Each tenant is assigned a key that identifies them in hello catalog and which is mapped toohello location of hello appropriate database.</span></span> <span data-ttu-id="997af-122">Hello Wingtip SaaS 應用程式，在 hello 金鑰被正確從 hello 租用戶名稱的雜湊。</span><span class="sxs-lookup"><span data-stu-id="997af-122">In hello Wingtip SaaS app, hello key is formed from a hash of hello tenant’s name.</span></span> <span data-ttu-id="997af-123">這可讓 hello 應用程式 URL toobe hello 租用戶名稱部分使用 tooconstruct hello 索引鍵。</span><span class="sxs-lookup"><span data-stu-id="997af-123">This allows hello tenant name portion of hello application URL toobe used tooconstruct hello key.</span></span> <span data-ttu-id="997af-124">您可以使用其他租用戶金鑰的配置。</span><span class="sxs-lookup"><span data-stu-id="997af-124">Other tenant key schemes could be used.</span></span>  

<span data-ttu-id="997af-125">hello 類別目錄可讓 hello 名稱或位置 hello 資料庫 toobe 變更 hello 應用程式上的影響降到最低。</span><span class="sxs-lookup"><span data-stu-id="997af-125">hello catalog allows hello name or location of hello database toobe changed with minimal impact on hello application.</span></span>  <span data-ttu-id="997af-126">在多租用戶資料庫模型中，這也適用於在資料庫之間「移動」租用戶。</span><span class="sxs-lookup"><span data-stu-id="997af-126">In a multi-tenant database model, this also accommodates ‘moving’ a tenant between databases.</span></span>  <span data-ttu-id="997af-127">hello 目錄也可以使用的 tooindicate 是否租用戶，或資料庫已離線進行維護或其他動作。</span><span class="sxs-lookup"><span data-stu-id="997af-127">hello catalog can also be used tooindicate whether a tenant or database is offline for maintenance or other actions.</span></span> <span data-ttu-id="997af-128">這會探索在 hello[還原單一租用戶教學課程](sql-database-saas-tutorial-restore-single-tenant.md)。</span><span class="sxs-lookup"><span data-stu-id="997af-128">This is explored in hello [restore single tenant tutorial](sql-database-saas-tutorial-restore-single-tenant.md).</span></span>

<span data-ttu-id="997af-129">此外，hello 目錄，也就是作用中 SaaS 應用程式管理資料庫，可以儲存其他租用戶或資料庫的中繼資料，例如 hello 層或版本的資料庫、 結構描述版本中，服務方案或 Sla 提供 tootenants 和其他資訊，可讓應用程式管理、 客戶支援或 devops 程序。</span><span class="sxs-lookup"><span data-stu-id="997af-129">In addition, hello catalog, which is in effect a management database for a SaaS application, can store additional tenant or database metadata, such as hello tier or edition of a database, schema version, service plan, or SLAs offered tootenants, and other info that enables application management, customer support, or devops processes.</span></span>  

<span data-ttu-id="997af-130">Hello SaaS 應用程式，超出 hello 目錄可以啟用資料庫工具。</span><span class="sxs-lookup"><span data-stu-id="997af-130">Beyond hello SaaS application, hello catalog can enable database tools.</span></span>  <span data-ttu-id="997af-131">在 hello Wingtip SaaS 範例中，hello 目錄是使用的 tooenable 跨租用戶查詢中，瀏覽在 hello[臨機操作分析教學課程](sql-database-saas-tutorial-adhoc-analytics.md)。</span><span class="sxs-lookup"><span data-stu-id="997af-131">In hello Wingtip SaaS sample, hello catalog is used tooenable cross-tenant query, explored in hello [ad hoc analytics tutorial](sql-database-saas-tutorial-adhoc-analytics.md).</span></span> <span data-ttu-id="997af-132">跨資料庫作業管理會探索在 hello[結構描述管理](sql-database-saas-tutorial-schema-management.md)和[租用戶分析](sql-database-saas-tutorial-tenant-analytics.md)教學課程。</span><span class="sxs-lookup"><span data-stu-id="997af-132">Cross-database job management is explored in hello [schema management](sql-database-saas-tutorial-schema-management.md) and [tenant analytics](sql-database-saas-tutorial-tenant-analytics.md) tutorials.</span></span> 

<span data-ttu-id="997af-133">Hello Wingtip SaaS 應用程式，在 hello 類別目錄會實作使用 hello 分區管理功能的 hello[彈性資料庫用戶端程式庫 (EDCL)](sql-database-elastic-database-client-library.md)。</span><span class="sxs-lookup"><span data-stu-id="997af-133">In hello Wingtip SaaS app, hello catalog is implemented using hello Shard Management features of hello [Elastic Database Client Library (EDCL)](sql-database-elastic-database-client-library.md).</span></span> <span data-ttu-id="997af-134">hello EDCL 可讓應用程式 toocreate、 管理及使用的資料庫為基礎的分區對應。</span><span class="sxs-lookup"><span data-stu-id="997af-134">hello EDCL enables an application toocreate, manage, and use a database-backed shard map.</span></span> <span data-ttu-id="997af-135">分區對應包含一份分區 （資料庫） 的索引鍵 （租用戶） 與資料庫之間的 hello 對應。</span><span class="sxs-lookup"><span data-stu-id="997af-135">A shard map contains a list of shards (databases) and hello mapping between keys (tenants) and databases.</span></span>  <span data-ttu-id="997af-136">EDCL 函式可從應用程式或 PowerShell 指令碼期間 toocreate hello 項目在 hello 分區對應中，佈建的租用戶，並從應用程式 tooefficiently 連接 toohello 正確的資料庫。</span><span class="sxs-lookup"><span data-stu-id="997af-136">EDCL functions can be used from applications or PowerShell scripts during tenant provisioning toocreate hello entries in hello shard map, and from applications tooefficiently connect toohello correct database.</span></span> <span data-ttu-id="997af-137">EDCL 快取連接資訊 toominimize hello 流量 toohello 類別目錄資料庫，並加快 hello 應用程式。</span><span class="sxs-lookup"><span data-stu-id="997af-137">EDCL caches connection information toominimize hello traffic toohello catalog database and speed up hello application.</span></span>  

> [!IMPORTANT]
> <span data-ttu-id="997af-138">hello 對應資料可供存取在 hello 類別目錄資料庫中，但*不要編輯*！</span><span class="sxs-lookup"><span data-stu-id="997af-138">hello mapping data is accessible in hello catalog database, but *don't edit it*!</span></span> <span data-ttu-id="997af-139">務必只使用彈性資料庫用戶端程式庫 API 編輯對應資料。</span><span class="sxs-lookup"><span data-stu-id="997af-139">Edit mapping data using Elastic Database Client Library APIs only.</span></span> <span data-ttu-id="997af-140">直接操控 hello 對應資料損毀 hello 風險目錄並不支援。</span><span class="sxs-lookup"><span data-stu-id="997af-140">Directly manipulating hello mapping data risks corrupting hello catalog and is not supported.</span></span>


## <a name="introduction-toohello-saas-provisioning-pattern"></a><span data-ttu-id="997af-141">簡介 toohello SaaS 佈建模式</span><span class="sxs-lookup"><span data-stu-id="997af-141">Introduction toohello SaaS Provisioning pattern</span></span>

<span data-ttu-id="997af-142">在使用單一租用戶資料庫模型的 SaaS 應用程式中將新的租用戶上線時，必須佈建新的租用戶資料庫。</span><span class="sxs-lookup"><span data-stu-id="997af-142">When onboarding a new tenant in a SaaS application that uses a single-tenant database model a new tenant database must be provisioned.</span></span>  <span data-ttu-id="997af-143">它必須建立在 hello 適當的位置以及服務層，以適當的結構描述和參考資料，初始化，然後在 hello 適當的租用戶金鑰 hello 目錄中登錄。</span><span class="sxs-lookup"><span data-stu-id="997af-143">It must be created in hello appropriate location and service tier, initialized with appropriate schema and reference data, and then registered in hello catalog under hello appropriate tenant key.</span></span>  

<span data-ttu-id="997af-144">不同的方法可以是使用的 toodatabase 佈建時，可能包括執行 SQL 指令碼、 將 bacpac 部署或複製 '黃金' 的範本資料庫。</span><span class="sxs-lookup"><span data-stu-id="997af-144">Different approaches can be used toodatabase provisioning, which could include executing SQL scripts, deploying a bacpac, or copying a 'golden' template database.</span></span>  

<span data-ttu-id="997af-145">hello 佈建的方法，就必須瞭解整體結構描述管理策略中，必須確保新的資料庫會佈建與 hello 最新的結構描述。</span><span class="sxs-lookup"><span data-stu-id="997af-145">hello provisioning approach you use must be comprehended in your overall schema management strategy, which must ensure that new databases are provisioned with hello latest schema.</span></span>  <span data-ttu-id="997af-146">這會探索在 hello[結構描述管理教學課程](sql-database-saas-tutorial-schema-management.md)。</span><span class="sxs-lookup"><span data-stu-id="997af-146">This is explored in hello [schema management tutorial](sql-database-saas-tutorial-schema-management.md).</span></span>  

<span data-ttu-id="997af-147">hello Wingtip SaaS 應用程式佈建新租用戶藉由複製標準資料庫名為 basetenantdb，hello 類別目錄伺服器上部署。</span><span class="sxs-lookup"><span data-stu-id="997af-147">hello Wingtip SaaS app provisions new tenants by copying a golden database named basetenantdb, deployed on hello catalog server.</span></span>  <span data-ttu-id="997af-148">佈建無法進行整合至 hello 應用程式的註冊體驗，及/或支援離線使用指令碼。</span><span class="sxs-lookup"><span data-stu-id="997af-148">Provisioning could be integrated into hello application as part of a sign-up experience, and/or supported offline using scripts.</span></span> <span data-ttu-id="997af-149">本教學課程將會使用 PowerShell 來探索佈建。</span><span class="sxs-lookup"><span data-stu-id="997af-149">This tutorial will explore provisioning using PowerShell.</span></span> <span data-ttu-id="997af-150">hello 佈建指令碼複製 hello basetenantdb toocreate 新的租用戶資料庫在彈性集區，然後初始化使用租用戶專屬的資訊並在 hello 目錄分區對應中註冊它。</span><span class="sxs-lookup"><span data-stu-id="997af-150">hello provisioning scripts copy hello basetenantdb toocreate a new tenant database in an elastic pool, then initialize it with tenant-specific info and register it in hello catalog shard map.</span></span>  <span data-ttu-id="997af-151">Hello 範例應用程式，資料庫會根據指定名稱 hello 租用戶名稱，但這不是很重要的一部分 hello 模式 – hello 使用 hello 類別目錄可讓任何名稱 toobe 指派 toohello 資料庫。 +</span><span class="sxs-lookup"><span data-stu-id="997af-151">In hello sample app, databases are given names based on hello tenant name, but this is not a critical part of hello pattern – hello use of hello catalog allows any name toobe assigned toohello database.+</span></span> 


## <a name="get-hello-wingtip-application-scripts"></a><span data-ttu-id="997af-152">取得 hello Wingtip 應用程式指令碼</span><span class="sxs-lookup"><span data-stu-id="997af-152">Get hello Wingtip application scripts</span></span>

<span data-ttu-id="997af-153">hello Wingtip SaaS 指令碼和應用程式的原始程式碼中可用 hello [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github 儲存機制。</span><span class="sxs-lookup"><span data-stu-id="997af-153">hello Wingtip SaaS scripts and application source code are available in hello [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="997af-154">[步驟 toodownload hello Wingtip SaaS 指令碼](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts)。</span><span class="sxs-lookup"><span data-stu-id="997af-154">[Steps toodownload hello Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>


## <a name="provision-and-catalog-detailed-walkthrough"></a><span data-ttu-id="997af-155">佈建及編目的詳細逐步解說</span><span class="sxs-lookup"><span data-stu-id="997af-155">Provision and catalog detailed walkthrough</span></span>

<span data-ttu-id="997af-156">toounderstand 如何 hello 的 Wingtip 應用程式會實作新的租用戶佈建、 加入中斷點和逐步執行 hello 工作流程中，佈建租用戶時：</span><span class="sxs-lookup"><span data-stu-id="997af-156">toounderstand how hello Wingtip application implements new tenant provisioning, add a breakpoint and step through hello workflow while provisioning a tenant:</span></span>

1. <span data-ttu-id="997af-157">開啟...\\學習模組\\ProvisionAndCatalog\\_示範 ProvisionAndCatalog.ps1_和集 hello 下列參數：</span><span class="sxs-lookup"><span data-stu-id="997af-157">Open ...\\Learning Modules\\ProvisionAndCatalog\\_Demo-ProvisionAndCatalog.ps1_ and set hello following parameters:</span></span>
   * <span data-ttu-id="997af-158">**$TenantName** = hello hello 新地點名稱 (例如， *Bushwillow 則藍色*)。</span><span class="sxs-lookup"><span data-stu-id="997af-158">**$TenantName** = hello name of hello new venue (for example, *Bushwillow Blues*).</span></span>
   * <span data-ttu-id="997af-159">**$VenueType** = hello 預先定義的法院類型之一：*則藍色*，classicalmusic，舞、 jazz、 judo、 用途，motorracing opera、 rockmusic、 足球。</span><span class="sxs-lookup"><span data-stu-id="997af-159">**$VenueType** = one of hello pre-defined venue types: *blues*, classicalmusic, dance, jazz, judo, motorracing, multipurpose, opera, rockmusic, soccer.</span></span>
   * <span data-ttu-id="997af-160">**$DemoScenario** = **1**，太將**1**太*佈建單一租用戶*。</span><span class="sxs-lookup"><span data-stu-id="997af-160">**$DemoScenario** = **1**, Set too**1** too*Provision a single tenant*.</span></span>

1. <span data-ttu-id="997af-161">將游標置於 48，hello 一行，指出上的任何位置加入中斷點：*新增租用戶 '*，然後按**F9**。</span><span class="sxs-lookup"><span data-stu-id="997af-161">Add a breakpoint by putting your cursor anywhere on line 48, hello line that says: *New-Tenant \`*, and press **F9**.</span></span>

   ![中斷點](media/sql-database-saas-tutorial-provision-and-catalog/breakpoint.png)

1. <span data-ttu-id="997af-163">toorun hello 指令碼按**F5**。</span><span class="sxs-lookup"><span data-stu-id="997af-163">toorun hello script press **F5**.</span></span>

1. <span data-ttu-id="997af-164">Hello 中斷點停止 hello 指令碼執行之後，請按**F11** toostep hello 程式碼。</span><span class="sxs-lookup"><span data-stu-id="997af-164">After hello script execution stops at hello breakpoint, press **F11** toostep into hello code.</span></span>

   ![中斷點](media/sql-database-saas-tutorial-provision-and-catalog/debug.png)



<span data-ttu-id="997af-166">追蹤使用 hello hello 指令碼執行**偵錯**功能表選項- **F10**和**F11** toostep 透過或 hello 呼叫函式。</span><span class="sxs-lookup"><span data-stu-id="997af-166">Trace hello script's execution using hello **Debug** menu options - **F10** and **F11** toostep over or into hello called functions.</span></span> <span data-ttu-id="997af-167">如需對 PowerShell 指令碼進行偵錯的詳細資訊，請參閱[使用 PowerShell 指令碼及對其進行偵錯的祕訣](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise) \(英文\)。</span><span class="sxs-lookup"><span data-stu-id="997af-167">For more information about debugging PowerShell scripts, see [Tips on working with and debugging PowerShell scripts](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise).</span></span>


<span data-ttu-id="997af-168">hello 下列不會遵循 tooexplicitly，步驟而 hello hello 指令碼偵錯時逐步執行的工作流程的說明：</span><span class="sxs-lookup"><span data-stu-id="997af-168">hello following are not steps tooexplicitly follow, but an explanation of hello workflow you step through while debugging hello script:</span></span>

1. <span data-ttu-id="997af-169">**匯入 hello SubscriptionManagement.psm1**包含登入 tooAzure 並選取您正在使用的 Azure 訂用帳戶的 hello 函式的模組。</span><span class="sxs-lookup"><span data-stu-id="997af-169">**Import hello SubscriptionManagement.psm1** module that contains functions for signing in tooAzure and selecting hello Azure subscription you are working with.</span></span>
1. <span data-ttu-id="997af-170">**匯入 hello CatalogAndDatabaseManagement.psm1**模組，以提供目錄和租用戶層級抽象 hello[分區管理](sql-database-elastic-scale-shard-map-management.md)函式。</span><span class="sxs-lookup"><span data-stu-id="997af-170">**Import hello CatalogAndDatabaseManagement.psm1** module that provides a catalog and tenant-level abstraction over hello [Shard Management](sql-database-elastic-scale-shard-map-management.md) functions.</span></span> <span data-ttu-id="997af-171">這是重要的模組，用以封裝大部分 hello 目錄模式和值得瀏覽。</span><span class="sxs-lookup"><span data-stu-id="997af-171">This is an important module that encapsulates much of hello catalog pattern and is worth exploring.</span></span>
1. <span data-ttu-id="997af-172">**取得設定詳細資料**。</span><span class="sxs-lookup"><span data-stu-id="997af-172">**Get configuration details**.</span></span> <span data-ttu-id="997af-173">逐步執行 Get-組態 （F11)，請參閱 < 如何指定 hello 應用程式組態。</span><span class="sxs-lookup"><span data-stu-id="997af-173">Step into Get-Configuration (with F11) and see how hello app config is specified.</span></span> <span data-ttu-id="997af-174">資源名稱和其他應用程式專屬值所定義，但不要變更這些值直到您已經熟悉 hello 指令碼。</span><span class="sxs-lookup"><span data-stu-id="997af-174">Resource names and other app-specific values are defined here, but do not change any of these values until you are familiar with hello scripts.</span></span>
1. <span data-ttu-id="997af-175">**取得 hello 目錄物件**。</span><span class="sxs-lookup"><span data-stu-id="997af-175">**Get hello catalog object**.</span></span> <span data-ttu-id="997af-176">逐步執行 Get 目錄撰寫，並傳回 hello 較高層級的指令碼中使用的目錄物件。</span><span class="sxs-lookup"><span data-stu-id="997af-176">Step into Get-Catalog which composes and returns a catalog object that is used in hello higher-level script.</span></span>  <span data-ttu-id="997af-177">此函式會使用從 **AzureShardManagement.psm1** 匯入的分區管理函式。</span><span class="sxs-lookup"><span data-stu-id="997af-177">This function uses Shard Management functions that are imported from **AzureShardManagement.psm1**.</span></span> <span data-ttu-id="997af-178">hello 目錄物件由 hello 下列：</span><span class="sxs-lookup"><span data-stu-id="997af-178">hello catalog object is composed of hello following:</span></span>
   * <span data-ttu-id="997af-179">使用 hello 標準 stem 加上您的使用者名稱來建構 $catalogServerFullyQualifiedName:_目錄-\<使用者\>。.database.windows.net_。</span><span class="sxs-lookup"><span data-stu-id="997af-179">$catalogServerFullyQualifiedName is constructed using hello standard stem plus your User name: _catalog-\<user\>.database.windows.net_.</span></span>
   * <span data-ttu-id="997af-180">$catalogDatabaseName 擷取自 hello 組態： *tenantcatalog*。</span><span class="sxs-lookup"><span data-stu-id="997af-180">$catalogDatabaseName is retrieved from hello config: *tenantcatalog*.</span></span>
   * <span data-ttu-id="997af-181">$shardMapManager 物件會從 hello 類別目錄資料庫初始化。</span><span class="sxs-lookup"><span data-stu-id="997af-181">$shardMapManager object is initialized from hello catalog database.</span></span>
   * <span data-ttu-id="997af-182">$shardMap 物件會從 hello 進行初始化*tenantcatalog* hello 類別目錄資料庫中的分區對應。</span><span class="sxs-lookup"><span data-stu-id="997af-182">$shardMap object is initialized from hello *tenantcatalog* shard map in hello catalog database.</span></span>
   <span data-ttu-id="997af-183">目錄物件是由和傳回，而且 hello 較高層級的指令碼中使用。</span><span class="sxs-lookup"><span data-stu-id="997af-183">A catalog object is composed and returned, and used in hello higher-level script.</span></span>
1. <span data-ttu-id="997af-184">**計算新租用戶金鑰 hello**。</span><span class="sxs-lookup"><span data-stu-id="997af-184">**Calculate hello new tenant key**.</span></span> <span data-ttu-id="997af-185">雜湊函式是使用的 toocreate hello 租用戶金鑰的 hello 租用戶名稱。</span><span class="sxs-lookup"><span data-stu-id="997af-185">A hash function is used toocreate hello tenant key from hello tenant name.</span></span>
1. <span data-ttu-id="997af-186">**請檢查 hello 租用戶金鑰是否已存在**。</span><span class="sxs-lookup"><span data-stu-id="997af-186">**Check if hello tenant key already exists**.</span></span> <span data-ttu-id="997af-187">hello 類別目錄會檢查 tooensure hello 的金鑰。</span><span class="sxs-lookup"><span data-stu-id="997af-187">hello catalog is checked tooensure hello key is available.</span></span>
1. <span data-ttu-id="997af-188">**hello 租用戶資料庫是透過新增 TenantDatabase 佈建。**</span><span class="sxs-lookup"><span data-stu-id="997af-188">**hello tenant database is provisioned with New-TenantDatabase.**</span></span> <span data-ttu-id="997af-189">使用**F11** toostep 中的，並查看 hello 資料庫如何使用佈建[Azure Resource Manager 範本](../azure-resource-manager/resource-manager-template-walkthrough.md)。</span><span class="sxs-lookup"><span data-stu-id="997af-189">Use **F11** toostep in and see how hello database is provisioned using an [Azure Resource Manager template](../azure-resource-manager/resource-manager-template-walkthrough.md).</span></span>

<span data-ttu-id="997af-190">hello 資料庫名稱是從 hello 租用戶名稱 toomake 它清除哪一個分區所屬 toowhich 租用戶所建構。</span><span class="sxs-lookup"><span data-stu-id="997af-190">hello database name is constructed from hello tenant name toomake it clear which shard belongs toowhich tenant.</span></span> <span data-ttu-id="997af-191">（其他資料庫命名的策略可以輕鬆地加以使用。）+ Resource Manager 範本是使用的 toocreate 租用戶資料庫複製 hello 類別目錄伺服器上的標準資料庫 (baseTenantDB)。</span><span class="sxs-lookup"><span data-stu-id="997af-191">(Other strategies for database naming could easily be used.)+ A Resource Manager template is used toocreate a tenant database by copying a golden database (baseTenantDB) on hello catalog server.</span></span> <span data-ttu-id="997af-192">另一個方法無法被 toocreate 空白資料庫，然後予以初始化藉由匯入 bacpac 或 tooexecute 初始化指令碼，從已知的位置。</span><span class="sxs-lookup"><span data-stu-id="997af-192">An alternative approach could be toocreate an empty database and then initialize it by importing a bacpac, or tooexecute an initialization script from a well-known location.</span></span>  

<span data-ttu-id="997af-193">hello Resource Manager 範本是 hello...\Learning Modules\Common\ 資料夾中： *tenantdatabasecopytemplate.json*</span><span class="sxs-lookup"><span data-stu-id="997af-193">hello Resource Manager template is in hello …\Learning Modules\Common\ folder: *tenantdatabasecopytemplate.json*</span></span>

<span data-ttu-id="997af-194">建立 hello 租用戶資料庫之後，就再進一步**hello 法院 （租用戶） 名稱與 hello 法院類型初始化**。</span><span class="sxs-lookup"><span data-stu-id="997af-194">After hello tenant database is created, it is then further **initialized with hello venue (tenant) name and hello venue type**.</span></span> <span data-ttu-id="997af-195">也可以在此進行其他初始化。</span><span class="sxs-lookup"><span data-stu-id="997af-195">Other initialization could also be done here.</span></span>

<span data-ttu-id="997af-196">hello **hello 目錄中註冊租用戶資料庫**與*新增 TenantDatabaseToCatalog*使用 hello 租用戶金鑰。</span><span class="sxs-lookup"><span data-stu-id="997af-196">hello **tenant database is registered in hello catalog** with *Add-TenantDatabaseToCatalog* using hello tenant key.</span></span> <span data-ttu-id="997af-197">使用**F11** toostep 到 hello 詳細資料：</span><span class="sxs-lookup"><span data-stu-id="997af-197">Use **F11** toostep into hello details:</span></span>

* <span data-ttu-id="997af-198">hello 類別目錄資料庫會加入 toohello 分區對應 （已知的資料庫中的 hello 清單）。</span><span class="sxs-lookup"><span data-stu-id="997af-198">hello catalog database is added toohello shard map (hello list of known databases).</span></span>
* <span data-ttu-id="997af-199">會建立對應的連結 hello 索引鍵值 toohello 分區的 hello。</span><span class="sxs-lookup"><span data-stu-id="997af-199">hello mapping that links hello key value toohello shard is created.</span></span>
* <span data-ttu-id="997af-200">Hello 租用戶的相關額外的中繼資料 （hello 地點名稱） 會加入 toohello 租用戶資料表 hello 目錄中。</span><span class="sxs-lookup"><span data-stu-id="997af-200">Additional meta data (hello venue's name) about hello tenant is added toohello Tenants table in hello catalog.</span></span>  <span data-ttu-id="997af-201">hello 租用戶資料表不 hello ShardManagement 結構描述的一部分，而且不會安裝 hello EDCL。</span><span class="sxs-lookup"><span data-stu-id="997af-201">hello Tenants table is not part of hello ShardManagement schema and is not installed by hello EDCL.</span></span>  <span data-ttu-id="997af-202">這份表格說明如何 hello 類別目錄資料庫可以擴充 toosupport 其他應用程式特定資料。</span><span class="sxs-lookup"><span data-stu-id="997af-202">This table illustrates how hello Catalog database can be extended toosupport additional application-specific data.</span></span>   


<span data-ttu-id="997af-203">佈建完成後，執行會傳回 toohello 原始*示範 ProvisionAndCatalog*指令碼，這會開啟 hello**事件**hello hello 瀏覽器中的新租用戶的頁面：</span><span class="sxs-lookup"><span data-stu-id="997af-203">After provisioning completes, execution returns toohello original *Demo-ProvisionAndCatalog* script, which opens hello **Events** page for hello new tenant in hello browser:</span></span>

   ![活動](media/sql-database-saas-tutorial-provision-and-catalog/new-tenant.png)


## <a name="provision-a-batch-of-tenants"></a><span data-ttu-id="997af-205">佈建一批租用戶</span><span class="sxs-lookup"><span data-stu-id="997af-205">Provision a batch of tenants</span></span>

<span data-ttu-id="997af-206">此練習會佈建一批 17 個租用戶。</span><span class="sxs-lookup"><span data-stu-id="997af-206">This exercise provisions a batch of 17 tenants.</span></span> <span data-ttu-id="997af-207">建議您啟動其他 Wingtip SaaS 教學課程中，所以具有多個在短短幾資料庫 toowork 之前佈建的租用戶此批次。</span><span class="sxs-lookup"><span data-stu-id="997af-207">It’s recommended you provision this batch of tenants before starting other Wingtip SaaS tutorials, so there's more than just a few databases toowork with.</span></span>

1. <span data-ttu-id="997af-208">開啟...\\學習模組\\ProvisionAndCatalog\\*示範 ProvisionAndCatalog.ps1*在 hello *PowerShell ISE*並變更 hello *$DemoScenario*參數 too3:</span><span class="sxs-lookup"><span data-stu-id="997af-208">Open ...\\Learning Modules\\ProvisionAndCatalog\\*Demo-ProvisionAndCatalog.ps1* in hello *PowerShell ISE* and change hello *$DemoScenario* parameter too3:</span></span>
   * <span data-ttu-id="997af-209">**$DemoScenario** = **3**，也變更**3**太*佈建租用戶的批次*。</span><span class="sxs-lookup"><span data-stu-id="997af-209">**$DemoScenario** = **3**, change too**3** too*Provision a batch of tenants*.</span></span>
1. <span data-ttu-id="997af-210">按**F5**執行 hello 指令碼。</span><span class="sxs-lookup"><span data-stu-id="997af-210">Press **F5** and run hello script.</span></span>

<span data-ttu-id="997af-211">hello 指令碼會將部署其他租用戶批的次。</span><span class="sxs-lookup"><span data-stu-id="997af-211">hello script deploys a batch of additional tenants.</span></span> <span data-ttu-id="997af-212">它會使用[Azure Resource Manager 範本](../azure-resource-manager/resource-manager-template-walkthrough.md)，控制 hello 批次，並委派給每個資料庫 tooa 連結範本的佈建。</span><span class="sxs-lookup"><span data-stu-id="997af-212">It uses an [Azure Resource Manager template](../azure-resource-manager/resource-manager-template-walkthrough.md) that controls hello batch and then delegates provisioning of each database tooa linked template.</span></span> <span data-ttu-id="997af-213">使用範本以這種方式可讓 Azure Resource Manager toobroker hello 佈建指令碼的程序。</span><span class="sxs-lookup"><span data-stu-id="997af-213">Using templates in this way allows Azure Resource Manager toobroker hello provisioning process for your script.</span></span> <span data-ttu-id="997af-214">範本佈建資料庫，以平行方式，它可以和處理重試次數，如有需要最佳化 hello 整體處理序。</span><span class="sxs-lookup"><span data-stu-id="997af-214">Templates provision databases in parallel where it can, and handles retries if needed, optimizing hello overall process.</span></span> <span data-ttu-id="997af-215">hello 指令碼等冪，如果失敗，或因為任何原因而停止執行一次。</span><span class="sxs-lookup"><span data-stu-id="997af-215">hello script is idempotent so if it fails or stops for any reason, run it again.</span></span>

### <a name="verify-hello-batch-of-tenants-successfully-deployed"></a><span data-ttu-id="997af-216">確認成功部署的租用戶的 hello 批次</span><span class="sxs-lookup"><span data-stu-id="997af-216">Verify hello batch of tenants successfully deployed</span></span>

* <span data-ttu-id="997af-217">開啟 hello *tenants1*伺服器瀏覽伺服器 hello tooyour 清單[Azure 入口網站](https://portal.azure.com)，按一下  **SQL 資料庫**，並確認 hello 批次的 17 的額外資料庫現在是在 hello 清單：</span><span class="sxs-lookup"><span data-stu-id="997af-217">Open hello *tenants1* server by browsing tooyour list of servers in hello [Azure portal](https://portal.azure.com), click **SQL databases**, and verify hello batch of 17 additional databases are now in hello list:</span></span>

   ![資料庫清單](media/sql-database-saas-tutorial-provision-and-catalog/database-list.png)



## <a name="other-provisioning-patterns"></a><span data-ttu-id="997af-219">其他佈建模式</span><span class="sxs-lookup"><span data-stu-id="997af-219">Other provisioning patterns</span></span>

<span data-ttu-id="997af-220">未包含在此教學課程中的其他佈建模式包括：</span><span class="sxs-lookup"><span data-stu-id="997af-220">Other provisioning patterns not included in this tutorial include:</span></span>

<span data-ttu-id="997af-221">**預先佈建資料庫。**</span><span class="sxs-lookup"><span data-stu-id="997af-221">**Pre-provisioning databases.**</span></span> <span data-ttu-id="997af-222">預先佈建模式 hello 利用 hello 事實無法增加彈性集區中的資料庫需要額外成本。</span><span class="sxs-lookup"><span data-stu-id="997af-222">hello pre-provisioning pattern exploits hello fact that databases in an elastic pool do not add extra cost.</span></span> <span data-ttu-id="997af-223">計費是 hello 彈性集區，不 hello 資料庫和閒置資料庫取用任何資源。</span><span class="sxs-lookup"><span data-stu-id="997af-223">Billing is for hello elastic pool, not hello databases, and idle databases consume no resources.</span></span> <span data-ttu-id="997af-224">藉由在集區中預先佈建資料庫，並在需要時才配置它們，可以大幅降低租用戶上線時間。</span><span class="sxs-lookup"><span data-stu-id="997af-224">By pre-provisioning databases in a pool and allocating them when needed, tenant onboarding time can be reduced significantly.</span></span> <span data-ttu-id="997af-225">時需要的 tookeep 適合 hello 緩衝區預期佈建速率，就無法調整 hello 預先佈建的資料庫數目。</span><span class="sxs-lookup"><span data-stu-id="997af-225">hello number of databases pre-provisioned could be adjusted as needed tookeep a buffer suitable for hello anticipated provisioning rate.</span></span>

<span data-ttu-id="997af-226">**自動佈建。**</span><span class="sxs-lookup"><span data-stu-id="997af-226">**Auto-provisioning.**</span></span> <span data-ttu-id="997af-227">在 hello 自動佈建模式中，專用的佈建服務會使用的 tooprovision 伺服器、 集區和資料庫自動視需要 – 包括彈性集區中預先佈建的資料庫，如有需要。</span><span class="sxs-lookup"><span data-stu-id="997af-227">In hello auto-provisioning pattern, a dedicated provisioning service is used tooprovision servers, pools, and databases automatically as needed – including pre-provisioning databases in elastic pools if desired.</span></span> <span data-ttu-id="997af-228">和資料庫會解除委託和刪除，如果 hello 佈建所需的服務可以填入彈性集區中的間距。</span><span class="sxs-lookup"><span data-stu-id="997af-228">And if databases are de-commissioned and deleted, gaps in elastic pools can be filled by hello provisioning service as desired.</span></span> <span data-ttu-id="997af-229">此類服務可以是簡單或複雜的 (例如，跨多個地理位置處理佈建)，且如果已針對災害復原使用異地複寫，就可自動設定該策略。</span><span class="sxs-lookup"><span data-stu-id="997af-229">Such a service could be simple or complex – for example, handling provisioning across multiple geographies, and could set up geo-replication automatically if that strategy is being used for disaster recovery.</span></span> <span data-ttu-id="997af-230">Hello 自動佈建模式時，用戶端應用程式或指令碼會送出 hello 佈建服務，由處理佈建要求 tooa 佇列 toobe 與然後會輪詢 hello 服務 toodetermine 完成。</span><span class="sxs-lookup"><span data-stu-id="997af-230">With hello auto-provisioning pattern, a client application or script would submit a provisioning request tooa queue toobe processed by hello provisioning service, and would then poll hello service toodetermine completion.</span></span> <span data-ttu-id="997af-231">如果使用預先佈建時，會處理要求快速 hello 服務管理佈建的 hello 背景中執行的替代資料庫。</span><span class="sxs-lookup"><span data-stu-id="997af-231">If pre-provisioning is used, requests would be handled quickly with hello service managing provisioning of a replacement database running in hello background.</span></span>



## <a name="next-steps"></a><span data-ttu-id="997af-232">後續步驟</span><span class="sxs-lookup"><span data-stu-id="997af-232">Next steps</span></span>

<span data-ttu-id="997af-233">在本教學課程中，您已了解如何：</span><span class="sxs-lookup"><span data-stu-id="997af-233">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="997af-234">佈建單一新租用戶</span><span class="sxs-lookup"><span data-stu-id="997af-234">Provision a single new tenant</span></span>
> * <span data-ttu-id="997af-235">佈建一批額外的租用戶</span><span class="sxs-lookup"><span data-stu-id="997af-235">Provision a batch of additional tenants</span></span>
> * <span data-ttu-id="997af-236">逐步執行 hello 的佈建租用戶，以及登錄這些入 hello 類別目錄的詳細資料</span><span class="sxs-lookup"><span data-stu-id="997af-236">Step into hello details of provisioning tenants, and registering them into hello catalog</span></span>

<span data-ttu-id="997af-237">再試一次 hello[效能監視的教學課程](sql-database-saas-tutorial-performance-monitoring.md)。</span><span class="sxs-lookup"><span data-stu-id="997af-237">Try hello [Performance monitoring tutorial](sql-database-saas-tutorial-performance-monitoring.md).</span></span>

## <a name="additional-resources"></a><span data-ttu-id="997af-238">其他資源</span><span class="sxs-lookup"><span data-stu-id="997af-238">Additional Resources</span></span>

* <span data-ttu-id="997af-239">其他[hello Wingtip SaaS 應用程式為基礎的教學課程](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="997af-239">Additional [tutorials that build upon hello Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="997af-240">彈性資料庫用戶端程式庫</span><span class="sxs-lookup"><span data-stu-id="997af-240">Elastic database client library</span></span>](https://docs.microsoft.com/azure/sql-database/sql-database-elastic-database-client-library)
* [<span data-ttu-id="997af-241">TooDebug 如何在 Windows PowerShell ISE 指令碼</span><span class="sxs-lookup"><span data-stu-id="997af-241">How tooDebug Scripts in Windows PowerShell ISE</span></span>](https://msdn.microsoft.com/powershell/scripting/core-powershell/ise/how-to-debug-scripts-in-windows-powershell-ise)
