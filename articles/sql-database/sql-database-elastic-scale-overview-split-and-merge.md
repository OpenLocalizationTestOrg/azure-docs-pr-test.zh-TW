---
title: "在向外延展的雲端資料庫之間移動資料 | Microsoft Docs"
description: "說明如何使用彈性資料庫 API 透過自我託管服務操作分區和移動資料。"
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 204fd902-0397-4185-985a-dea3ed7c7d9f
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/24/2016
ms.author: ddove
ms.openlocfilehash: b41b6d6be686168359a97eb7468351a105b748db
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="moving-data-between-scaled-out-cloud-databases"></a><span data-ttu-id="ac629-103">在向外延展的雲端資料庫之間移動資料</span><span class="sxs-lookup"><span data-stu-id="ac629-103">Moving data between scaled-out cloud databases</span></span>
<span data-ttu-id="ac629-104">如果您是軟體服務開發人員，您的應用程式突然出現巨量需求，您需要因應這種成長。</span><span class="sxs-lookup"><span data-stu-id="ac629-104">If you are a Software as a Service developer, and suddenly your app undergoes tremendous demand, you need to accommodate the growth.</span></span> <span data-ttu-id="ac629-105">所以，您加入了更多的資料庫 (分區)。</span><span class="sxs-lookup"><span data-stu-id="ac629-105">So you add more databases (shards).</span></span> <span data-ttu-id="ac629-106">您該如何將資料重新發佈到新的資料庫，卻不打斷資料的完整性？</span><span class="sxs-lookup"><span data-stu-id="ac629-106">How do you redistribute the data to the new databases without disrupting the data integrity?</span></span> <span data-ttu-id="ac629-107">使用 **分割合併工具** 將資料從受條件約束的資料庫移到新的資料庫。</span><span class="sxs-lookup"><span data-stu-id="ac629-107">Use the **split-merge tool** to move data from constrained databases to the new databases.</span></span>  

<span data-ttu-id="ac629-108">分割合併工具執行的方式如同 Azure Web 服務。</span><span class="sxs-lookup"><span data-stu-id="ac629-108">The split-merge tool runs as an Azure web service.</span></span> <span data-ttu-id="ac629-109">系統管理員或開發人員使用工具在不同的資料庫 (分區) 之間移動 Shardlet (分區的資料)。</span><span class="sxs-lookup"><span data-stu-id="ac629-109">An administrator or developer uses the tool to move shardlets (data from a shard) between different databases (shards).</span></span> <span data-ttu-id="ac629-110">此工具會使用分區對應管理來維護服務中繼資料資料庫，並確保一致的對應。</span><span class="sxs-lookup"><span data-stu-id="ac629-110">The tool uses shard map management to maintain the service metadata database, and ensure consistent mappings.</span></span>

![概觀][1]

## <a name="download"></a><span data-ttu-id="ac629-112">下載</span><span class="sxs-lookup"><span data-stu-id="ac629-112">Download</span></span>
[<span data-ttu-id="ac629-113">Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge</span><span class="sxs-lookup"><span data-stu-id="ac629-113">Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge</span></span>](http://www.nuget.org/packages/Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge/)

## <a name="documentation"></a><span data-ttu-id="ac629-114">文件</span><span class="sxs-lookup"><span data-stu-id="ac629-114">Documentation</span></span>
1. [<span data-ttu-id="ac629-115">彈性資料庫分割合併工具教學課程</span><span class="sxs-lookup"><span data-stu-id="ac629-115">Elastic database Split-Merge tool tutorial</span></span>](sql-database-elastic-scale-configure-deploy-split-and-merge.md)
2. [<span data-ttu-id="ac629-116">Split-Merge 安全性設定</span><span class="sxs-lookup"><span data-stu-id="ac629-116">Split-Merge security configuration</span></span>](sql-database-elastic-scale-split-merge-security-configuration.md)
3. [<span data-ttu-id="ac629-117">分割合併安全性考量</span><span class="sxs-lookup"><span data-stu-id="ac629-117">Split-merge security considerations</span></span>](sql-database-elastic-scale-split-merge-security-configuration.md)
4. [<span data-ttu-id="ac629-118">分區對應管理</span><span class="sxs-lookup"><span data-stu-id="ac629-118">Shard map management</span></span>](sql-database-elastic-scale-shard-map-management.md)
5. [<span data-ttu-id="ac629-119">轉換現有的資料庫以使用彈性資料庫工具</span><span class="sxs-lookup"><span data-stu-id="ac629-119">Migrate existing databases to scale-out</span></span>](sql-database-elastic-convert-to-use-elastic-tools.md)
6. [<span data-ttu-id="ac629-120">彈性資料庫功能概觀</span><span class="sxs-lookup"><span data-stu-id="ac629-120">Elastic database tools</span></span>](sql-database-elastic-scale-introduction.md)
7. [<span data-ttu-id="ac629-121">彈性資料庫工具字彙</span><span class="sxs-lookup"><span data-stu-id="ac629-121">Elastic Database tools glossary</span></span>](sql-database-elastic-scale-glossary.md)

## <a name="why-use-the-split-merge-tool"></a><span data-ttu-id="ac629-122">為何使用分割合併工具？</span><span class="sxs-lookup"><span data-stu-id="ac629-122">Why use the split-merge tool?</span></span>
<span data-ttu-id="ac629-123">**彈性**</span><span class="sxs-lookup"><span data-stu-id="ac629-123">**Flexibility**</span></span>

<span data-ttu-id="ac629-124">應用程式需要靈活地伸展，才能超越單一 Azure SQL DB 資料庫的限制。</span><span class="sxs-lookup"><span data-stu-id="ac629-124">Applications need to stretch flexibly beyond the limits of a single Azure SQL DB database.</span></span> <span data-ttu-id="ac629-125">使用工具依需要將資料移至新的資料庫，同時保有完整性。</span><span class="sxs-lookup"><span data-stu-id="ac629-125">Use the tool to move data as needed to new databases while retaining integrity.</span></span>

<span data-ttu-id="ac629-126">**分割以成長**</span><span class="sxs-lookup"><span data-stu-id="ac629-126">**Split to grow**</span></span> 

<span data-ttu-id="ac629-127">您需要增加整體容量，處理爆炸性的成長。</span><span class="sxs-lookup"><span data-stu-id="ac629-127">You need to increase overall capacity to handle explosive growth.</span></span> <span data-ttu-id="ac629-128">若要達到這個目標，請將資料分區，並分散到越來越多的資料庫上，來提供更多的容量，直到滿足容量需求為止。</span><span class="sxs-lookup"><span data-stu-id="ac629-128">To do so, create additional capacity by sharding the data and by distributing it across incrementally more databases until capacity needs are fulfilled.</span></span> <span data-ttu-id="ac629-129">這是主要的「分割」功能範例。</span><span class="sxs-lookup"><span data-stu-id="ac629-129">This is a prime example of the ‘split’ feature.</span></span> 

<span data-ttu-id="ac629-130">**合併以縮減**</span><span class="sxs-lookup"><span data-stu-id="ac629-130">**Merge to shrink**</span></span>

<span data-ttu-id="ac629-131">容量因為業務的季節特性需要縮減。</span><span class="sxs-lookup"><span data-stu-id="ac629-131">Capacity needs shrink due to the seasonal nature of a business.</span></span> <span data-ttu-id="ac629-132">當業務減緩時，此工具可讓您相應減少至較少的縮放單位。</span><span class="sxs-lookup"><span data-stu-id="ac629-132">The tool lets you scale down to fewer scale units when business slows.</span></span> <span data-ttu-id="ac629-133">Elastic Scale 分割合併服務的「合併」功能可滿足此需求。</span><span class="sxs-lookup"><span data-stu-id="ac629-133">The ‘merge’ feature in the Elastic Scale split-merge Service covers this requirement.</span></span> 

<span data-ttu-id="ac629-134">**移動 Shardlet 來管理作用區**</span><span class="sxs-lookup"><span data-stu-id="ac629-134">**Manage hotspots by moving shardlets**</span></span>

<span data-ttu-id="ac629-135">在每個資料庫有多個租用戶的情況下，分區的 Shardlet 配置可能造成某些分區出現容量瓶頸。</span><span class="sxs-lookup"><span data-stu-id="ac629-135">With multiple tenants per database, the allocation of shardlets to shards can lead to capacity bottlenecks on some shards.</span></span> <span data-ttu-id="ac629-136">這需要重新配置 Shardlet，或將忙碌的 Shardlet 移到新的或較少使用的分區。</span><span class="sxs-lookup"><span data-stu-id="ac629-136">This requires re-allocating shardlets or moving busy shardlets to new or less utilized shards.</span></span> 

## <a name="concepts--key-features"></a><span data-ttu-id="ac629-137">概念和重要功能</span><span class="sxs-lookup"><span data-stu-id="ac629-137">Concepts & key features</span></span>
<span data-ttu-id="ac629-138">**客戶主控式服務**</span><span class="sxs-lookup"><span data-stu-id="ac629-138">**Customer-hosted services**</span></span>

<span data-ttu-id="ac629-139">分割合併提供為客戶主控式服務。</span><span class="sxs-lookup"><span data-stu-id="ac629-139">The split-merge is delivered as a customer-hosted service.</span></span> <span data-ttu-id="ac629-140">您必須將服務部署並裝載於 Microsoft Azure 訂用帳戶中。</span><span class="sxs-lookup"><span data-stu-id="ac629-140">You must deploy and host the service in your Microsoft Azure subscription.</span></span> <span data-ttu-id="ac629-141">您從 NuGet 下載的封裝包含設定範本，可加入您特定部署的資訊而使之完備。</span><span class="sxs-lookup"><span data-stu-id="ac629-141">The package you download from NuGet contains a configuration template to complete with the information for your specific deployment.</span></span> <span data-ttu-id="ac629-142">如需詳細資訊，請參閱 [分割合併教學課程](sql-database-elastic-scale-configure-deploy-split-and-merge.md) 。</span><span class="sxs-lookup"><span data-stu-id="ac629-142">See the [split-merge tutorial](sql-database-elastic-scale-configure-deploy-split-and-merge.md) for details.</span></span> <span data-ttu-id="ac629-143">因為服務是在您的 Azure 訂用帳戶中執行，您可以控制和設定服務的大部分安全性層面。</span><span class="sxs-lookup"><span data-stu-id="ac629-143">Since the service runs in your Azure subscription, you can control and configure most security aspects of the service.</span></span> <span data-ttu-id="ac629-144">預設範本包含設定 SSL、以憑證為基礎的用戶端驗證、加密儲存的認證、DoS 防護及 IP 限制等選項。</span><span class="sxs-lookup"><span data-stu-id="ac629-144">The default template includes the options to configure SSL, certificate-based client authentication, encryption for stored credentials, DoS guarding and IP restrictions.</span></span> <span data-ttu-id="ac629-145">您可以在下列文件中找到安全性層面的詳細資訊： [分割合併安全性組態](sql-database-elastic-scale-split-merge-security-configuration.md)。</span><span class="sxs-lookup"><span data-stu-id="ac629-145">You can find more information on the security aspects in the following document [split-merge security configuration](sql-database-elastic-scale-split-merge-security-configuration.md).</span></span>

<span data-ttu-id="ac629-146">預設部署服務以一個背景工作角色和一個 Web 角色執行。</span><span class="sxs-lookup"><span data-stu-id="ac629-146">The default deployed service runs with one worker and one web role.</span></span> <span data-ttu-id="ac629-147">各角色在 Azure 雲端服務中使用 A1 VM 大小。</span><span class="sxs-lookup"><span data-stu-id="ac629-147">Each uses the A1 VM size in Azure Cloud Services.</span></span> <span data-ttu-id="ac629-148">雖然您無法在部署封裝時修改這些設定，但可以在部署成功後在執行中的雲端服務中變更它們 (透過 Azure 入口網站)。</span><span class="sxs-lookup"><span data-stu-id="ac629-148">While you cannot modify these settings when deploying the package, you could change them after a successful deployment in the running cloud service, (through the Azure portal).</span></span> <span data-ttu-id="ac629-149">請注意，基於技術原因，不可以將背景工作角色設定多個執行個體。</span><span class="sxs-lookup"><span data-stu-id="ac629-149">Note that the worker role must not be configured for more than a single instance for technical reasons.</span></span> 

<span data-ttu-id="ac629-150">**分區對應整合**</span><span class="sxs-lookup"><span data-stu-id="ac629-150">**Shard map integration**</span></span>

<span data-ttu-id="ac629-151">分割合併服務會與應用程式的分區對應互動。</span><span class="sxs-lookup"><span data-stu-id="ac629-151">The split-merge service interacts with the shard map of the application.</span></span> <span data-ttu-id="ac629-152">當使用分割合併服務來分割或合併範圍，或在分區之間移動 Shardlet 時，服務會自動將分區對應保持在最新狀態。</span><span class="sxs-lookup"><span data-stu-id="ac629-152">When using the split-merge service to split or merge ranges or to move shardlets between shards, the service automatically keeps the shard map up to date.</span></span> <span data-ttu-id="ac629-153">為了這樣做，服務會連接到應用程式的分區對應管理員資料庫，並於分割/合併/移動要求進行時維護範圍和對應。</span><span class="sxs-lookup"><span data-stu-id="ac629-153">To do so, the service connects to the shard map manager database of the application and maintains ranges and mappings as split/merge/move requests progress.</span></span> <span data-ttu-id="ac629-154">這可確保當分割合併作業持續進行時，分區對應一律呈現最新的檢視。</span><span class="sxs-lookup"><span data-stu-id="ac629-154">This ensures that the shard map always presents an up-to-date view when split-merge operations are going on.</span></span> <span data-ttu-id="ac629-155">分割、合併和 Shardlet 移動作業的實作方式是將一批 Shardlet 從來源分區移至目標分區。</span><span class="sxs-lookup"><span data-stu-id="ac629-155">Split, merge and shardlet movement operations are implemented by moving a batch of shardlets from the source shard to the target shard.</span></span> <span data-ttu-id="ac629-156">在 Shardlet 移動作業期間，屬於目前批次中的 Shardlet 在分區對應中會標示為離線，也無法供使用 **OpenConnectionForKey** API 的資料相依路由連線使用。</span><span class="sxs-lookup"><span data-stu-id="ac629-156">During the shardlet movement operation the shardlets subject to the current batch are marked as offline in the shard map and are unavailable for data-dependent routing connections using the **OpenConnectionForKey** API.</span></span> 

<span data-ttu-id="ac629-157">**一致的 Shardlet 連線**</span><span class="sxs-lookup"><span data-stu-id="ac629-157">**Consistent shardlet connections**</span></span>

<span data-ttu-id="ac629-158">當新一批 Shardlet 的資料移動開始時，分區對應提供指向分區 (儲存 Shardlet) 的任何資料相依路由連接會終止，而當資料移動正在進行時，也會封鎖後續從分區對應 API 至這些 Shardlet 的連接，以避免不一致。</span><span class="sxs-lookup"><span data-stu-id="ac629-158">When data movement starts for a new batch of shardlets, any shard-map provided data-dependent routing connections to the shard storing the shardlet are killed and subsequent connections from the shard map APIs to the these shardlets are blocked while the data movement is in progress in order to avoid inconsistencies.</span></span> <span data-ttu-id="ac629-159">對同一個分區的其他 Shardlet 的連接也會終止，但重試就會立即成功。</span><span class="sxs-lookup"><span data-stu-id="ac629-159">Connections to other shardlets on the same shard will also get killed, but will succeed again immediately on retry.</span></span> <span data-ttu-id="ac629-160">移動批次後，目標分區的 Shardlet 會再次標示為線上，並從來源分區移除來源資料。</span><span class="sxs-lookup"><span data-stu-id="ac629-160">Once the batch is moved, the shardlets are marked online again for the target shard and the source data is removed from the source shard.</span></span> <span data-ttu-id="ac629-161">服務會對每個批次執行這些步驟，直到所有 Shardlet 都已經移動為止。</span><span class="sxs-lookup"><span data-stu-id="ac629-161">The service goes through these steps for every batch until all shardlets have been moved.</span></span> <span data-ttu-id="ac629-162">在整個分割/合併/移動作業的過程中，這將會產生數個連接終止作業。</span><span class="sxs-lookup"><span data-stu-id="ac629-162">This will lead to several connection kill operations during the course of the complete split/merge/move operation.</span></span>  

<span data-ttu-id="ac629-163">**管理 Shardlet 可用性**</span><span class="sxs-lookup"><span data-stu-id="ac629-163">**Managing shardlet availability**</span></span>

<span data-ttu-id="ac629-164">如上所述，只限制終止目前 Shardlet 批次的連接，可將無法使用的範圍限制在一次一批 Shardlet。</span><span class="sxs-lookup"><span data-stu-id="ac629-164">Limiting the connection killing to the current batch of shardlets as discussed above restricts the scope of unavailability to one batch of shardlets at a time.</span></span> <span data-ttu-id="ac629-165">這比分割或合併作業過程中整個分區對其所有 Shardlet 仍保持離線的作法更好。</span><span class="sxs-lookup"><span data-stu-id="ac629-165">This is preferred over an approach where the complete shard would remain offline for all its shardlets during the course of a split or merge operation.</span></span> <span data-ttu-id="ac629-166">批次大小 (定義為一次要移動的相異 Shardlet 數目) 是組態參數。</span><span class="sxs-lookup"><span data-stu-id="ac629-166">The size of a batch, defined as the number of distinct shardlets to move at a time, is a configuration parameter.</span></span> <span data-ttu-id="ac629-167">每個分割和合併作業中都可定義它，視應用程式的可用性和效能需求而定。</span><span class="sxs-lookup"><span data-stu-id="ac629-167">It can be defined for each split and merge operation depending on the application’s availability and performance needs.</span></span> <span data-ttu-id="ac629-168">請注意，分區對應中鎖定的範圍可能大於指定的批次大小。</span><span class="sxs-lookup"><span data-stu-id="ac629-168">Note that the range that is being locked in the shard map may be larger than the batch size specified.</span></span> <span data-ttu-id="ac629-169">這是因為服務挑選範圍大小時，都希望資料中的分區化索引鍵值的實際數大約符合批次大小。</span><span class="sxs-lookup"><span data-stu-id="ac629-169">This is because the service picks the range size such that the actual number of sharding key values in the data approximately matches the batch size.</span></span> <span data-ttu-id="ac629-170">對於稀疏填入的分區化索引鍵，尤其要記住這一點。</span><span class="sxs-lookup"><span data-stu-id="ac629-170">This is important to remember in particular for sparsely populated sharding keys.</span></span> 

<span data-ttu-id="ac629-171">**中繼資料儲存體**</span><span class="sxs-lookup"><span data-stu-id="ac629-171">**Metadata storage**</span></span>

<span data-ttu-id="ac629-172">分割合併服務使用資料庫來維護其狀態，並在要求處理期間保留記錄檔。</span><span class="sxs-lookup"><span data-stu-id="ac629-172">The split-merge service uses a database to maintain its status and to keep logs during request processing.</span></span> <span data-ttu-id="ac629-173">使用者在其訂用帳戶中建立此資料庫，並在服務部署的組態檔中提供連接字串。</span><span class="sxs-lookup"><span data-stu-id="ac629-173">The user creates this database in their subscription and provides the connection string for it in the configuration file for the service deployment.</span></span> <span data-ttu-id="ac629-174">使用者組織的系統管理員也可以連接到此資料庫來檢閱要求進度，並調查關於潛在失敗的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="ac629-174">Administrators from the user’s organization can also connect to this database to review request progress and to investigate detailed information regarding potential failures.</span></span>

<span data-ttu-id="ac629-175">**分區化感知**</span><span class="sxs-lookup"><span data-stu-id="ac629-175">**Sharding-awareness**</span></span>

<span data-ttu-id="ac629-176">分割合併服務會區別 (1) 分區化資料表、(2) 參考資料表和 (3) 一般資料表。</span><span class="sxs-lookup"><span data-stu-id="ac629-176">The split-merge service differentiates between (1) sharded tables, (2) reference tables, and (3) normal tables.</span></span> <span data-ttu-id="ac629-177">分割/合併移動作業的語意視使用的資料表類型而定，定義如下：</span><span class="sxs-lookup"><span data-stu-id="ac629-177">The semantics of a split/merge/move operation depend on the type of the table used and are defined as follows:</span></span> 

* <span data-ttu-id="ac629-178">**分區化資料表**：分割、合併和移動作業會將 Shardlet 從來源移至目標分區。</span><span class="sxs-lookup"><span data-stu-id="ac629-178">**Sharded tables**: Split, merge, and move operations move shardlets from source to target shard.</span></span> <span data-ttu-id="ac629-179">成功完成整體要求之後，這些 Shardlet 就不存在於來源。</span><span class="sxs-lookup"><span data-stu-id="ac629-179">After successful completion of the overall request, those shardlets are no longer present on the source.</span></span> <span data-ttu-id="ac629-180">請注意，目標資料表必須存在於目標分區，而且在處理作業之前不能包含目標範圍中的資料。</span><span class="sxs-lookup"><span data-stu-id="ac629-180">Note that the target tables need to exist on the target shard and must not contain data in the target range prior to processing of the operation.</span></span> 
* <span data-ttu-id="ac629-181">**參考資料表**：對於參考資料表，分割、合併和移動作業會將資料從來源複製到目標分區。</span><span class="sxs-lookup"><span data-stu-id="ac629-181">**Reference tables**: For reference tables, the split, merge and move operations copy the data from the source to the target shard.</span></span> <span data-ttu-id="ac629-182">但是請注意，若目標上給定資料表中已存在任何資料列，則此資料表的目標分區不會發生任何變更。</span><span class="sxs-lookup"><span data-stu-id="ac629-182">Note, however, that no changes occur on the target shard for a given table if any row is already present in this table on the target.</span></span> <span data-ttu-id="ac629-183">資料表必須是空的，才會處理任何參考資料表複製作業。</span><span class="sxs-lookup"><span data-stu-id="ac629-183">The table has to be empty for any reference table copy operation to get processed.</span></span>
* <span data-ttu-id="ac629-184">**其他資料表**：分割和合併作業的來源或目標上可以存在其他資料表。</span><span class="sxs-lookup"><span data-stu-id="ac629-184">**Other Tables**: Other tables can be present on either the source or the target of a split and merge operation.</span></span> <span data-ttu-id="ac629-185">在任何資料移動或複製作業中，分割合併服務會忽略這些資料表。</span><span class="sxs-lookup"><span data-stu-id="ac629-185">The split-merge service disregards these tables for any data movement or copy operations.</span></span> <span data-ttu-id="ac629-186">但是請注意，在有條件約束時，它們會干擾這些作業。</span><span class="sxs-lookup"><span data-stu-id="ac629-186">Note, however, that they can interfere with these operations in case of constraints.</span></span>

<span data-ttu-id="ac629-187">分區對應的 **SchemaInfo** API 提供參考資料表與分區化資料表的比較資訊。</span><span class="sxs-lookup"><span data-stu-id="ac629-187">The information on reference vs. sharded tables is provided by the **SchemaInfo** APIs on the shard map.</span></span> <span data-ttu-id="ac629-188">下列範例說明如何在給定的分區對應管理員物件 smm 上使用這些 API：</span><span class="sxs-lookup"><span data-stu-id="ac629-188">The following example illustrates the use of these APIs on a given shard map manager object smm:</span></span> 

    // Create the schema annotations 
    SchemaInfo schemaInfo = new SchemaInfo(); 

    // Reference tables 
    schemaInfo.Add(new ReferenceTableInfo("dbo", "region")); 
    schemaInfo.Add(new ReferenceTableInfo("dbo", "nation")); 

    // Sharded tables 
    schemaInfo.Add(new ShardedTableInfo("dbo", "customer", "C_CUSTKEY")); 
    schemaInfo.Add(new ShardedTableInfo("dbo", "orders", "O_CUSTKEY")); 

    // Publish 
    smm.GetSchemaInfoCollection().Add(Configuration.ShardMapName, schemaInfo); 

<span data-ttu-id="ac629-189">資料表 '‘region’ 及 ‘nation’ 定義為參考資料表，將透過分割/合併/移動作業來複製。</span><span class="sxs-lookup"><span data-stu-id="ac629-189">The tables ‘region’ and ‘nation’ are defined as reference tables and will be copied with split/merge/move operations.</span></span> <span data-ttu-id="ac629-190">‘customer’ 和 ‘orders’ 接著定義為分區化資料表。</span><span class="sxs-lookup"><span data-stu-id="ac629-190">‘customer’ and ‘orders’ in turn are defined as sharded tables.</span></span> <span data-ttu-id="ac629-191">C_CUSTKEY 和 O_CUSTKEY 作為分區化索引鍵。</span><span class="sxs-lookup"><span data-stu-id="ac629-191">C_CUSTKEY and O_CUSTKEY serve as the sharding key.</span></span> 

<span data-ttu-id="ac629-192">**參考完整性**</span><span class="sxs-lookup"><span data-stu-id="ac629-192">**Referential Integrity**</span></span>

<span data-ttu-id="ac629-193">分割合併服務會分析資料表之間的相依性，並使用外部主索引鍵關聯性來接移作業，以移動參考資料表和 Shardlet。</span><span class="sxs-lookup"><span data-stu-id="ac629-193">The split-merge service analyzes dependencies between tables and uses foreign key-primary key relationships to stage the operations for moving reference tables and shardlets.</span></span> <span data-ttu-id="ac629-194">一般而言會先根據相依性順序複製參考資料表，然後在每個批次中再根據相依性順序複製 Shardlet。</span><span class="sxs-lookup"><span data-stu-id="ac629-194">In general, reference tables are copied first in dependency order, then shardlets are copied in order of their dependencies within each batch.</span></span> <span data-ttu-id="ac629-195">這是必要的，當新資料到達時，才能符合目標分區的 FK PK 條件約束。</span><span class="sxs-lookup"><span data-stu-id="ac629-195">This is necessary so that FK-PK constraints on the target shard are honored as the new data arrives.</span></span> 

<span data-ttu-id="ac629-196">**分區對應一致性與最終完成**</span><span class="sxs-lookup"><span data-stu-id="ac629-196">**Shard Map Consistency and Eventual Completion**</span></span>

<span data-ttu-id="ac629-197">失敗時，分割合併服務會在任何中斷之後繼續作業，以完成任何進行中的要求。</span><span class="sxs-lookup"><span data-stu-id="ac629-197">In the presence of failures, the split-merge service resumes operations after any outage and aims to complete any in progress requests.</span></span> <span data-ttu-id="ac629-198">不過，可能有無法復原的情況，例如，當目標分區遺失或損壞到無法修復的程度。</span><span class="sxs-lookup"><span data-stu-id="ac629-198">However, there may be unrecoverable situations, e.g., when the target shard is lost or compromised beyond repair.</span></span> <span data-ttu-id="ac629-199">在這些情況下，原本要移動的一些 Shardlet 可能繼續留在來源分區。</span><span class="sxs-lookup"><span data-stu-id="ac629-199">Under those circumstances, some shardlets that were supposed to be moved may continue to reside on the source shard.</span></span> <span data-ttu-id="ac629-200">服務可以確保只有當必要的資料成功複製到目標之後，才會更新 Shardlet 對應。</span><span class="sxs-lookup"><span data-stu-id="ac629-200">The service ensures that shardlet mappings are only updated after the necessary data has been successfully copied to the target.</span></span> <span data-ttu-id="ac629-201">只有當所有資料都已複製到目標，並已成功更新對應的對應之後，才會在來源刪除 Shardlet。</span><span class="sxs-lookup"><span data-stu-id="ac629-201">Shardlets are only deleted on the source once all their data has been copied to the target and the corresponding mappings have been updated successfully.</span></span> <span data-ttu-id="ac629-202">當範圍在目標分區上已上線時，刪除作業會在幕後執行。</span><span class="sxs-lookup"><span data-stu-id="ac629-202">The deletion operation happens in the background while the range is already online on the target shard.</span></span> <span data-ttu-id="ac629-203">分割合併服務永遠確保儲存在分區對應中的對應的正確性。</span><span class="sxs-lookup"><span data-stu-id="ac629-203">The split-merge service always ensures correctness of the mappings stored in the shard map.</span></span>

## <a name="the-split-merge-user-interface"></a><span data-ttu-id="ac629-204">分割合併使用者介面</span><span class="sxs-lookup"><span data-stu-id="ac629-204">The split-merge user interface</span></span>
<span data-ttu-id="ac629-205">分割合併 Service Pack 包含背景工作角色和 Web 角色。</span><span class="sxs-lookup"><span data-stu-id="ac629-205">The split-merge service package includes a worker role and a web role.</span></span> <span data-ttu-id="ac629-206">Web 角色用互動方式提交分割合併要求。</span><span class="sxs-lookup"><span data-stu-id="ac629-206">The web role is used to submit split-merge requests in an interactive way.</span></span> <span data-ttu-id="ac629-207">使用者介面的主要元件如下：</span><span class="sxs-lookup"><span data-stu-id="ac629-207">The main components of the user interface are as follows:</span></span>

* <span data-ttu-id="ac629-208">作業類型：作業類型是選項按鈕，控制服務針對此要求所執行的作業類型。</span><span class="sxs-lookup"><span data-stu-id="ac629-208">Operation Type: The operation type is a radio button that controls the kind of operation performed by the service for this request.</span></span> <span data-ttu-id="ac629-209">您可以選擇分割、合併和移動案例。</span><span class="sxs-lookup"><span data-stu-id="ac629-209">You can choose between the split, merge and move scenarios.</span></span> <span data-ttu-id="ac629-210">您也可以取消先前提交的作業。</span><span class="sxs-lookup"><span data-stu-id="ac629-210">You can also cancel a previously submitted operation.</span></span> <span data-ttu-id="ac629-211">您可以在範圍分區對應中使用分割、合併和移動等要求。</span><span class="sxs-lookup"><span data-stu-id="ac629-211">You can use split, merge and move requests for range shard maps.</span></span> <span data-ttu-id="ac629-212">清單分區對應僅支援移動作業。</span><span class="sxs-lookup"><span data-stu-id="ac629-212">List shard maps only support move operations.</span></span>
* <span data-ttu-id="ac629-213">分區對應：下一節的要求參數討論分區對應和主控分區對應之資料庫的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="ac629-213">Shard Map: The next section of request parameters cover information about the shard map and the database hosting your shard map.</span></span> <span data-ttu-id="ac629-214">特別的是，您需要提供 Azure SQL Database 伺服器名稱和裝載 shardmap 的資料庫名稱、用以連接到分區對應資料庫的認證，以及分區對應名稱的名稱。</span><span class="sxs-lookup"><span data-stu-id="ac629-214">In particular, you need to provide the name of the Azure SQL Database server and database hosting the shardmap, credentials to connect to the shard map database, and finally the name of the shard map.</span></span> <span data-ttu-id="ac629-215">目前，此作業只接受一組認證。</span><span class="sxs-lookup"><span data-stu-id="ac629-215">Currently, the operation only accepts a single set of credentials.</span></span> <span data-ttu-id="ac629-216">這些認證必須有足夠權限來變更分區對應及分區上的使用者資料。</span><span class="sxs-lookup"><span data-stu-id="ac629-216">These credentials need to have sufficient permissions to perform changes to the shard map as well as to the user data on the shards.</span></span>
* <span data-ttu-id="ac629-217">來源範圍 (分割和合併)：分割及合併作業會採用其低和高索引鍵處理該範圍。</span><span class="sxs-lookup"><span data-stu-id="ac629-217">Source Range (split and merge): A split and merge operation processes a range using its low and high key.</span></span> <span data-ttu-id="ac629-218">若要指定無限制高索引鍵值的作業，請勾選 [高索引鍵為最大值] 核取方塊，並將高索引鍵欄位留空。</span><span class="sxs-lookup"><span data-stu-id="ac629-218">To specify an operation with an unbounded high key value, check the “High key is max” check box and leave the high key field empty.</span></span> <span data-ttu-id="ac629-219">指定的範圍索引鍵值不需要精確地符合分區對應中的對應及其界限。</span><span class="sxs-lookup"><span data-stu-id="ac629-219">The range key values that you specify do not need to precisely match a mapping and its boundaries in your shard map.</span></span> <span data-ttu-id="ac629-220">如果您未指定任何範圍界限，此服務將會自動為您推斷最接近的範圍。</span><span class="sxs-lookup"><span data-stu-id="ac629-220">If you do not specify any range boundaries at all the service will infer the closest range for you automatically.</span></span> <span data-ttu-id="ac629-221">您可以使用 GetMappings.ps1 PowerShell 指令碼來擷取給定分區對應中目前的對應。</span><span class="sxs-lookup"><span data-stu-id="ac629-221">You can use the GetMappings.ps1 PowerShell script to retrieve the current mappings in a given shard map.</span></span>
* <span data-ttu-id="ac629-222">分割來源行為 (分割)：在分割作業中，定義來源範圍中要分割的點。</span><span class="sxs-lookup"><span data-stu-id="ac629-222">Split Source Behavior (split): For split operations, define the point to split the source range.</span></span> <span data-ttu-id="ac629-223">您可以提供想要從何處分割的分區化索引鍵。</span><span class="sxs-lookup"><span data-stu-id="ac629-223">You do this by providing the sharding key where you want the split to occur.</span></span> <span data-ttu-id="ac629-224">請使用選項按鈕指定要移動範圍的下半部 (不含分割索引鍵)，還是要移動上半部 (包括分割索引鍵)。</span><span class="sxs-lookup"><span data-stu-id="ac629-224">Use the radio button specify whether you want the lower part of the range (excluding the split key) to move, or whether you want the upper part to move (including the split key).</span></span>
* <span data-ttu-id="ac629-225">來源 Shardlet (移動)：移動作業不同於分割或合併作業，它們不需要範圍來描述來源。</span><span class="sxs-lookup"><span data-stu-id="ac629-225">Source Shardlet (move): Move operations are different from split or merge operations as they do not require a range to describe the source.</span></span> <span data-ttu-id="ac629-226">使用您打算移動的分區化索引鍵值，即可識別移動的來源。</span><span class="sxs-lookup"><span data-stu-id="ac629-226">A source for move is simply identified by the sharding key value that you plan to move.</span></span>
* <span data-ttu-id="ac629-227">目標分區 (分割)：提供分割作業的來源相關資訊之後，您需要提供目標的 Azure SQL Db 伺服器和資料庫名稱，以定義您想要將資料複製到何處。</span><span class="sxs-lookup"><span data-stu-id="ac629-227">Target Shard (split): Once you have provided the information on the source of your split operation, you need to define where you want the data to be copied to by providing the Azure SQL Db server and database name for the target.</span></span>
* <span data-ttu-id="ac629-228">目標範圍 (合併)：合併作業會將 Shardlet 移至現有的分區。</span><span class="sxs-lookup"><span data-stu-id="ac629-228">Target Range (merge): Merge operations move shardlets to an existing shard.</span></span> <span data-ttu-id="ac629-229">您可以提供想要合併的現有範圍的範圍界限，以識別現有的分區。</span><span class="sxs-lookup"><span data-stu-id="ac629-229">You identify the existing shard by providing the range boundaries of the existing range that you want to merge with.</span></span>
* <span data-ttu-id="ac629-230">批次大小：批次大小控制資料移動期間會一次離線的 Shardlet 數目。</span><span class="sxs-lookup"><span data-stu-id="ac629-230">Batch Size: The batch size controls the number of shardlets that will go offline at a time during the data movement.</span></span> <span data-ttu-id="ac629-231">這是整數值，當您無法忍受長時間沒有 Shardlet 可用時，您可以使用較小的值。</span><span class="sxs-lookup"><span data-stu-id="ac629-231">This is an integer value where you can use smaller values when you are sensitive to long periods of downtime for shardlets.</span></span> <span data-ttu-id="ac629-232">較大的值會延長給定 Shardlet 離線的時間，但可改善效能。</span><span class="sxs-lookup"><span data-stu-id="ac629-232">Larger values will increase the time that a given shardlet is offline but may improve performance.</span></span>
* <span data-ttu-id="ac629-233">作業識別碼 (取消)：如果您不再需要某個進行中的作業，您可以在此欄位中提供其作業識別碼來取消作業。</span><span class="sxs-lookup"><span data-stu-id="ac629-233">Operation Id (Cancel): If you have an ongoing operation that is no longer needed, you can cancel the operation by providing its operation ID in this field.</span></span> <span data-ttu-id="ac629-234">您可以從要求狀態資料表 (請參閱 8.1 節)，或從您提交要求的網頁瀏覽器中的輸出，擷取作業識別碼。</span><span class="sxs-lookup"><span data-stu-id="ac629-234">You can retrieve the operation ID from the request status table (see Section 8.1) or from the output in the web browser where you submitted the request.</span></span>

## <a name="requirements-and-limitations"></a><span data-ttu-id="ac629-235">需求和限制</span><span class="sxs-lookup"><span data-stu-id="ac629-235">Requirements and Limitations</span></span>
<span data-ttu-id="ac629-236">目前的分割合併服務實作有下列需求和限制：</span><span class="sxs-lookup"><span data-stu-id="ac629-236">The current implementation of the split-merge service is subject to the following requirements and limitations:</span></span> 

* <span data-ttu-id="ac629-237">分區必須存在且在分區對應中註冊，才能對這些分區執行分割合併作業。</span><span class="sxs-lookup"><span data-stu-id="ac629-237">The shards need to exist and be registered in the shard map before a split-merge operation on these shards can be performed.</span></span> 
* <span data-ttu-id="ac629-238">服務不會在其作業中自動建立資料表或其他任何資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="ac629-238">The service does not create tables or any other database objects automatically as part of its operations.</span></span> <span data-ttu-id="ac629-239">這表示執行任何分割/合併/移動作業之前，所有分區化資料表和參考資料表的結構描述必須存在於目標分區。</span><span class="sxs-lookup"><span data-stu-id="ac629-239">This means that the schema for all sharded tables and reference tables need to exist on the target shard prior to any split/merge/move operation.</span></span> <span data-ttu-id="ac629-240">尤其，在由分割/合併/移動作業加入新 Shardlet 的範圍中，分區化資料表必須是空的。</span><span class="sxs-lookup"><span data-stu-id="ac629-240">Sharded tables in particular are required to be empty in the range where new shardlets are to be added by a split/merge/move operation.</span></span> <span data-ttu-id="ac629-241">否則，作業無法通過目標分區上的初始一致性檢查。</span><span class="sxs-lookup"><span data-stu-id="ac629-241">Otherwise, the operation will fail the initial consistency check on the target shard.</span></span> <span data-ttu-id="ac629-242">另請注意，只有當參考資料表是空的時，才會複製參考資料，而對於參考資料表上的其他並行寫入作業，也無法保證一致性。</span><span class="sxs-lookup"><span data-stu-id="ac629-242">Also note that reference data is only copied if the reference table is empty and that there are no consistency guarantees with regard to other concurrent write operations on the reference tables.</span></span> <span data-ttu-id="ac629-243">我們建議 – 在執行分割/合併作業時，沒有其他寫入作業在變更參考資料表。</span><span class="sxs-lookup"><span data-stu-id="ac629-243">We recommend this: when running split/merge operations, no other write operations make changes to the reference tables.</span></span>
* <span data-ttu-id="ac629-244">服務依賴唯一索引或索引鍵 (包含分區化索引鍵) 所建立的資料列識別，以改善大型 Shardlet 的效能和可靠性。</span><span class="sxs-lookup"><span data-stu-id="ac629-244">The service relies on row identity established by a unique index or key that includes the sharding key to improve performance and reliability for large shardlets.</span></span> <span data-ttu-id="ac629-245">這可讓服務移動比分區化索引鍵值更精細的資料。</span><span class="sxs-lookup"><span data-stu-id="ac629-245">This allows the service to move data at an even finer granularity than just the sharding key value.</span></span> <span data-ttu-id="ac629-246">這有助於減少作業期間所需的記錄檔空間和鎖定數目上限。</span><span class="sxs-lookup"><span data-stu-id="ac629-246">This helps to reduce the maximum amount of log space and locks that are required during the operation.</span></span> <span data-ttu-id="ac629-247">如果您想要透過分割/合併/移動要求來使用特定的資料表，請考慮在此資料表上建立唯一索引或主索引鍵 (包含分區化索引鍵)。</span><span class="sxs-lookup"><span data-stu-id="ac629-247">Consider creating a unique index or a primary key including the sharding key on a given table if you want to use that table with split/merge/move requests.</span></span> <span data-ttu-id="ac629-248">基於效能考量，分區化索引鍵應該為索引鍵或索引中的開頭資料行。</span><span class="sxs-lookup"><span data-stu-id="ac629-248">For performance reasons, the sharding key should be the leading column in the key or the index.</span></span>
* <span data-ttu-id="ac629-249">要求處理期間，某些 Shardlet 資料可能會同時出現在來源和目標分區。</span><span class="sxs-lookup"><span data-stu-id="ac629-249">During the course of request processing, some shardlet data may be present both on the source and the target shard.</span></span> <span data-ttu-id="ac629-250">為了防止 Shardlet 移動期間失敗，這是必要的。</span><span class="sxs-lookup"><span data-stu-id="ac629-250">This is necessary to protect against failures during the shardlet movement.</span></span> <span data-ttu-id="ac629-251">分割合併與分區對應的整合，可確保在分區對應上透過資料相依路由 API 使用 **OpenConnectionForKey** 方法來連線時，不會出現任何不一致的過渡狀態。</span><span class="sxs-lookup"><span data-stu-id="ac629-251">The integration of split-merge with the shard map ensures that connections through the data dependent routing APIs using the **OpenConnectionForKey** method on the shard map do not see any inconsistent intermediate states.</span></span> <span data-ttu-id="ac629-252">不過，當連線到來源或目標分區不是使用 **OpenConnectionForKey** 方法時，則在分割/合併/移動要求進行時，可能會出現不一致的過渡狀態。</span><span class="sxs-lookup"><span data-stu-id="ac629-252">However, when connecting to the source or the target shards without using the **OpenConnectionForKey** method, inconsistent intermediate states might be visible when split/merge/move requests are going on.</span></span> <span data-ttu-id="ac629-253">這些連接可能會顯示不完整或重複的結果，視連接之下的時間或分區而定。</span><span class="sxs-lookup"><span data-stu-id="ac629-253">These connections may show partial or duplicate results depending on the timing or the shard underlying the connection.</span></span> <span data-ttu-id="ac629-254">這項限制目前包括 Elastic Scale 多分區查詢所建立的連接。</span><span class="sxs-lookup"><span data-stu-id="ac629-254">This limitation currently includes the connections made by Elastic Scale Multi-Shard-Queries.</span></span>
* <span data-ttu-id="ac629-255">不同角色之間不可共用分割合併服務的中繼資料資料庫。</span><span class="sxs-lookup"><span data-stu-id="ac629-255">The metadata database for the split-merge service must not be shared between different roles.</span></span> <span data-ttu-id="ac629-256">例如，在預備環境中執行分割合併服務的角色，必須指向與生產角色不同的中繼資料資料庫。</span><span class="sxs-lookup"><span data-stu-id="ac629-256">For example, a role of the split-merge service running in staging needs to point to a different metadata database than the production role.</span></span>

## <a name="billing"></a><span data-ttu-id="ac629-257">計費</span><span class="sxs-lookup"><span data-stu-id="ac629-257">Billing</span></span>
<span data-ttu-id="ac629-258">分割合併服務是以 Microsoft Azure 訂用帳戶中的雲端服務執行。</span><span class="sxs-lookup"><span data-stu-id="ac629-258">The split-merge service runs as a cloud service in your Microsoft Azure subscription.</span></span> <span data-ttu-id="ac629-259">因此會對您的服務執行個體收取雲端服務的費用。</span><span class="sxs-lookup"><span data-stu-id="ac629-259">Therefore charges for cloud services apply to your instance of the service.</span></span> <span data-ttu-id="ac629-260">除非您經常執行分割/合併/移動作業，否則建議您刪除分割合併雲端服務。</span><span class="sxs-lookup"><span data-stu-id="ac629-260">Unless you frequently perform split/merge/move operations, we recommend you delete your split-merge cloud service.</span></span> <span data-ttu-id="ac629-261">這可以節省執行中或已部署的雲端服務執行個體的成本。</span><span class="sxs-lookup"><span data-stu-id="ac629-261">That saves costs for running or deployed cloud service instances.</span></span> <span data-ttu-id="ac629-262">每當您需要執行分割或合併作業時，您可以重新部署和啟動可立即運作的組態。</span><span class="sxs-lookup"><span data-stu-id="ac629-262">You can re-deploy and start your readily runnable configuration whenever you need to perform split or merge operations.</span></span> 

## <a name="monitoring"></a><span data-ttu-id="ac629-263">監視</span><span class="sxs-lookup"><span data-stu-id="ac629-263">Monitoring</span></span>
### <a name="status-tables"></a><span data-ttu-id="ac629-264">狀態資料表</span><span class="sxs-lookup"><span data-stu-id="ac629-264">Status tables</span></span>
<span data-ttu-id="ac629-265">分割合併服務在中繼資料儲存資料庫中提供 **RequestStatus** 資料表，以監視已完成和進行中的要求。</span><span class="sxs-lookup"><span data-stu-id="ac629-265">The split-merge Service provides the **RequestStatus** table in the metadata store database for monitoring of completed and ongoing requests.</span></span> <span data-ttu-id="ac629-266">已提交至這個分割合併服務執行個體的每一個分割合併要求，在此資料表中都會列出一個資料列。</span><span class="sxs-lookup"><span data-stu-id="ac629-266">The table lists a row for each split-merge request that has been submitted to this instance of the split-merge service.</span></span> <span data-ttu-id="ac629-267">它針對每個要求提供以下的資訊：</span><span class="sxs-lookup"><span data-stu-id="ac629-267">It gives the following information for each request:</span></span>

* <span data-ttu-id="ac629-268">**Timestamp**：要求開始的時間和日期。</span><span class="sxs-lookup"><span data-stu-id="ac629-268">**Timestamp**: The time and date when the request was started.</span></span>
* <span data-ttu-id="ac629-269">**OperationId**：唯一識別要求的 GUID。</span><span class="sxs-lookup"><span data-stu-id="ac629-269">**OperationId**: A GUID that uniquely identifies the request.</span></span> <span data-ttu-id="ac629-270">這項要求也可用來取消仍在進行中的作業。</span><span class="sxs-lookup"><span data-stu-id="ac629-270">This request can also be used to cancel the operation while it is still ongoing.</span></span>
* <span data-ttu-id="ac629-271">**Status**：要求的目前狀態。</span><span class="sxs-lookup"><span data-stu-id="ac629-271">**Status**: The current state of the request.</span></span> <span data-ttu-id="ac629-272">對於持續進行的要求，它也列出要求目前所處的階段。</span><span class="sxs-lookup"><span data-stu-id="ac629-272">For ongoing requests, it also lists the current phase in which the request is.</span></span>
* <span data-ttu-id="ac629-273">**CancelRequest**：旗標，指出是否已取消要求。</span><span class="sxs-lookup"><span data-stu-id="ac629-273">**CancelRequest**: A flag that indicates whether the request has been cancelled.</span></span>
* <span data-ttu-id="ac629-274">**Progress**：作業完成的估計百分比。</span><span class="sxs-lookup"><span data-stu-id="ac629-274">**Progress**: A percentage estimate of completion for the operation.</span></span> <span data-ttu-id="ac629-275">值為 50 表示作業已完成大約 50%。</span><span class="sxs-lookup"><span data-stu-id="ac629-275">A value of 50 indicates that the operation is approximately 50% complete.</span></span>
* <span data-ttu-id="ac629-276">**Details**：XML 值，提供更詳細的進度報表。</span><span class="sxs-lookup"><span data-stu-id="ac629-276">**Details**: An XML value that provides a more detailed progress report.</span></span> <span data-ttu-id="ac629-277">隨著資料列從來源複製到目標，進度報表會定期更新。</span><span class="sxs-lookup"><span data-stu-id="ac629-277">The progress report is periodically updated as sets of rows are copied from source to target.</span></span> <span data-ttu-id="ac629-278">如果發生錯誤或例外狀況，此資料行也包含失敗的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="ac629-278">In case of failures or exceptions, this column also includes more detailed information about the failure.</span></span>

### <a name="azure-diagnostics"></a><span data-ttu-id="ac629-279">Azure 診斷</span><span class="sxs-lookup"><span data-stu-id="ac629-279">Azure Diagnostics</span></span>
<span data-ttu-id="ac629-280">分割合併服務會根據 Azure SDK 2.5 使用 Azure 診斷來監控與診斷。</span><span class="sxs-lookup"><span data-stu-id="ac629-280">The split-merge service uses Azure Diagnostics based on Azure SDK 2.5 for monitoring and diagnostics.</span></span> <span data-ttu-id="ac629-281">您可以如這裡所述控制診斷組態： [在 Azure 雲端服務和虛擬機器中啟用診斷](../cloud-services/cloud-services-dotnet-diagnostics.md)。</span><span class="sxs-lookup"><span data-stu-id="ac629-281">You control the diagnostics configuration as explained here: [Enabling Diagnostics in Azure Cloud Services and Virtual Machines](../cloud-services/cloud-services-dotnet-diagnostics.md).</span></span> <span data-ttu-id="ac629-282">下載封裝包含兩個診斷組態 - 一個用於 Web 角色，另一個用於背景工作角色。</span><span class="sxs-lookup"><span data-stu-id="ac629-282">The download package includes two diagnostics configurations - one for the web role and one for the worker role.</span></span> <span data-ttu-id="ac629-283">這些服務診斷組態遵循 [Microsoft Azure 雲端服務基本概念](https://code.msdn.microsoft.com/windowsazure/Cloud-Service-Fundamentals-4ca72649)中的指引。</span><span class="sxs-lookup"><span data-stu-id="ac629-283">These diagnostics configurations for the service follow the guidance from [Cloud Service Fundamentals in Microsoft Azure](https://code.msdn.microsoft.com/windowsazure/Cloud-Service-Fundamentals-4ca72649).</span></span> <span data-ttu-id="ac629-284">其中包含定義來記錄效能計數器、IIS 記錄檔、Windows 事件記錄檔，以及分割合併應用程式事件記錄檔。</span><span class="sxs-lookup"><span data-stu-id="ac629-284">It includes the definitions to log Performance Counters, IIS logs, Windows Event Logs, and split-merge application event logs.</span></span> 

## <a name="deploy-diagnostics"></a><span data-ttu-id="ac629-285">部署診斷</span><span class="sxs-lookup"><span data-stu-id="ac629-285">Deploy Diagnostics</span></span>
<span data-ttu-id="ac629-286">針對 NuGet 封裝所提供的 Web 和背景工作角色，若要使用診斷組態啟用監視和診斷，請使用 Azure PowerShell 執行下列命令：</span><span class="sxs-lookup"><span data-stu-id="ac629-286">To enable monitoring and diagnostics using the diagnostic configuration for the web and worker roles provided by the NuGet package, run the following commands using Azure PowerShell:</span></span> 

    $storage_name = "<YourAzureStorageAccount>" 

    $key = "<YourAzureStorageAccountKey" 

    $storageContext = New-AzureStorageContext -StorageAccountName $storage_name -StorageAccountKey $key  


    $config_path = "<YourFilePath>\SplitMergeWebContent.diagnostics.xml" 

    $service_name = "<YourCloudServiceName>" 

    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name -Slot Production -Role "SplitMergeWeb" 


    $config_path = "<YourFilePath>\SplitMergeWorkerContent.diagnostics.xml" 

    $service_name = "<YourCloudServiceName>" 

    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name -Slot Production -Role "SplitMergeWorker" 

<span data-ttu-id="ac629-287">您可以在這裡找到有關如何設定和部署診斷設定的詳細資訊： [在 Azure 雲端服務和虛擬機器中啟用診斷](../cloud-services/cloud-services-dotnet-diagnostics.md)。</span><span class="sxs-lookup"><span data-stu-id="ac629-287">You can find more information on how to configure and deploy diagnostics settings here: [Enabling Diagnostics in Azure Cloud Services and Virtual Machines](../cloud-services/cloud-services-dotnet-diagnostics.md).</span></span> 

## <a name="retrieve-diagnostics"></a><span data-ttu-id="ac629-288">擷取診斷</span><span class="sxs-lookup"><span data-stu-id="ac629-288">Retrieve diagnostics</span></span>
<span data-ttu-id="ac629-289">從 Visual Studio 伺服器總管，您可以在伺服器總管樹狀目錄的 Azure 部分中輕鬆存取診斷。</span><span class="sxs-lookup"><span data-stu-id="ac629-289">You can easily access your diagnostics from the Visual Studio Server Explorer in the Azure part of the Server Explorer tree.</span></span> <span data-ttu-id="ac629-290">開啟 Visual Studio 執行個體，在功能表列按一下 [檢視] 和 [伺服器總管]。</span><span class="sxs-lookup"><span data-stu-id="ac629-290">Open a Visual Studio instance, and in the menu bar click View, and Server Explorer.</span></span> <span data-ttu-id="ac629-291">按一下 [Azure] 圖示，連接至您的 Azure 訂用帳戶。</span><span class="sxs-lookup"><span data-stu-id="ac629-291">Click the Azure icon to connect to your Azure subscription.</span></span> <span data-ttu-id="ac629-292">然後瀏覽至 [Azure] -> [儲存體] -> <your storage account> -> [資料表] -> [WADLogsTable]。</span><span class="sxs-lookup"><span data-stu-id="ac629-292">Then navigate to Azure -> Storage -> <your storage account> -> Tables -> WADLogsTable.</span></span> <span data-ttu-id="ac629-293">如需詳細資訊，請參閱 [使用伺服器總管瀏覽儲存體資源](http://msdn.microsoft.com/library/azure/ff683677.aspx)。</span><span class="sxs-lookup"><span data-stu-id="ac629-293">For more information, see [Browsing Storage Resources with Server Explorer](http://msdn.microsoft.com/library/azure/ff683677.aspx).</span></span> 

![WADLogsTable][2]

<span data-ttu-id="ac629-295">在上圖中反白顯示的 WADLogsTable 包含分割合併服務應用程式記錄檔中的詳細事件。</span><span class="sxs-lookup"><span data-stu-id="ac629-295">The WADLogsTable highlighted in the figure above contains the detailed events from the split-merge service’s application log.</span></span> <span data-ttu-id="ac629-296">請注意，下載的封裝的預設組態是特別針對生產部署而設計。</span><span class="sxs-lookup"><span data-stu-id="ac629-296">Note that the default configuration of the downloaded package is geared towards a production deployment.</span></span> <span data-ttu-id="ac629-297">因此，從服務執行個體提取記錄檔和計數器的間隔時間很大 (5 分鐘)。</span><span class="sxs-lookup"><span data-stu-id="ac629-297">Therefore the interval at which logs and counters are pulled from the service instances is large (5 minutes).</span></span> <span data-ttu-id="ac629-298">在測試和開發時，請依需要調整 Web 或背景工作角色的診斷設定，以縮短間隔。</span><span class="sxs-lookup"><span data-stu-id="ac629-298">For test and development, lower the interval by adjusting the diagnostics settings of the web or the worker role to your needs.</span></span> <span data-ttu-id="ac629-299">請以滑鼠右鍵按一下 Visual Studio 伺服器總管 (請參閱上圖) 中的角色，然後調整 [診斷組態] 設定對話方塊中的 [傳輸期間]：</span><span class="sxs-lookup"><span data-stu-id="ac629-299">Right-click on the role in the Visual Studio Server Explorer (see above) and then adjust the Transfer Period in the dialog for the Diagnostics configuration settings:</span></span> 

![組態][3]

## <a name="performance"></a><span data-ttu-id="ac629-301">效能</span><span class="sxs-lookup"><span data-stu-id="ac629-301">Performance</span></span>
<span data-ttu-id="ac629-302">一般而言，Azure SQL Database 中越高階、越有效能的服務層，預期會有較佳的效能。</span><span class="sxs-lookup"><span data-stu-id="ac629-302">In general, better performance is to be expected from the higher, more performant service tiers in Azure SQL Database.</span></span> <span data-ttu-id="ac629-303">越高的服務層使用越高的 IO、CPU 和記憶體配置，有利於分割合併服務使用的大量複製和刪除作業。</span><span class="sxs-lookup"><span data-stu-id="ac629-303">Higher IO, CPU and memory allocations for the higher service tiers benefit the bulk copy and delete operations that the split-merge service uses.</span></span> <span data-ttu-id="ac629-304">基於這個理由，請只針對這些資料庫，在一段已定義的有限期間內增加服務層。</span><span class="sxs-lookup"><span data-stu-id="ac629-304">For that reason, increase the service tier just for those databases for a defined, limited period of time.</span></span>

<span data-ttu-id="ac629-305">服務在其正常作業中也會執行驗證查詢。</span><span class="sxs-lookup"><span data-stu-id="ac629-305">The service also performs validation queries as part of its normal operations.</span></span> <span data-ttu-id="ac629-306">這些驗證查詢會檢查目標範圍中是否存在非預期的資料，並確保任何分割/合併/移動作業是從一致的狀態開始。</span><span class="sxs-lookup"><span data-stu-id="ac629-306">These validation queries check for unexpected presence of data in the target range and ensure that any split/merge/move operation starts from a consistent state.</span></span> <span data-ttu-id="ac629-307">這些查詢全部都會檢查作業領域所定義的分區化索引鍵範圍，以及要求定義中所提供的批次大小。</span><span class="sxs-lookup"><span data-stu-id="ac629-307">These queries all work over sharding key ranges defined by the scope of the operation and the batch size provided as part of the request definition.</span></span> <span data-ttu-id="ac629-308">當索引存在且以分區化索引鍵做為開頭資料行時，這些查詢的表現最好。</span><span class="sxs-lookup"><span data-stu-id="ac629-308">These queries perform best when an index is present that has the sharding key as the leading column.</span></span> 

<span data-ttu-id="ac629-309">此外，以分區化索引鍵做為開頭資料行的唯一性屬性，可讓服務使用最佳化方法來限制記錄檔空間和記憶體方面的資源消耗。</span><span class="sxs-lookup"><span data-stu-id="ac629-309">In addition, a uniqueness property with the sharding key as the leading column will allow the service to use an optimized approach that limits resource consumption in terms of log space and memory.</span></span> <span data-ttu-id="ac629-310">移動大型資料時 (通常超過 1 GB) 需要這個唯一性屬性。</span><span class="sxs-lookup"><span data-stu-id="ac629-310">This uniqueness property is required to move large data sizes (typically above 1GB).</span></span> 

## <a name="how-to-upgrade"></a><span data-ttu-id="ac629-311">如何升級</span><span class="sxs-lookup"><span data-stu-id="ac629-311">How to upgrade</span></span>
1. <span data-ttu-id="ac629-312">請遵循 [部署分割-合併服務](sql-database-elastic-scale-configure-deploy-split-and-merge.md)中的步驟執行。</span><span class="sxs-lookup"><span data-stu-id="ac629-312">Follow the steps in [Deploy a split-merge service](sql-database-elastic-scale-configure-deploy-split-and-merge.md).</span></span>
2. <span data-ttu-id="ac629-313">變更分割合併部署的雲端服務組態檔，以反映新的組態參數。</span><span class="sxs-lookup"><span data-stu-id="ac629-313">Change your cloud service configuration file for your split-merge deployment to reflect the new configuration parameters.</span></span> <span data-ttu-id="ac629-314">新的必要參數是用於加密的憑證相關資訊。</span><span class="sxs-lookup"><span data-stu-id="ac629-314">A new required parameter is the information about the certificate used for encryption.</span></span> <span data-ttu-id="ac629-315">若要這樣做，一個簡單方法是將下載的新組態範本檔案與現有組態進行比較。</span><span class="sxs-lookup"><span data-stu-id="ac629-315">An easy way to do this is to compare the new configuration template file from the download against your existing configuration.</span></span> <span data-ttu-id="ac629-316">請確定您新增 Web 和背景工作角色的 "DataEncryptionPrimaryCertificateThumbprint" 和 "DataEncryptionPrimary" 設定。</span><span class="sxs-lookup"><span data-stu-id="ac629-316">Make sure you add the settings for “DataEncryptionPrimaryCertificateThumbprint” and “DataEncryptionPrimary” for both the web and the worker role.</span></span>
3. <span data-ttu-id="ac629-317">將更新部署至 Azure 之前，請確定目前執行的所有分割合併作業都已完成。</span><span class="sxs-lookup"><span data-stu-id="ac629-317">Before deploying the update to Azure, ensure that all currently running split-merge operations have finished.</span></span> <span data-ttu-id="ac629-318">作法很簡單，您可以針對進行中的要求，查詢分割合併中繼資料資料庫中的 RequestStatus 和 PendingWorkflows 資料表。</span><span class="sxs-lookup"><span data-stu-id="ac629-318">You can easily do this by querying the RequestStatus and PendingWorkflows tables in the split-merge metadata database for ongoing requests.</span></span>
4. <span data-ttu-id="ac629-319">使用新的封裝和更新的服務組態檔，在您的 Azure 訂用帳戶中更新分割合併的現有雲端服務部署。</span><span class="sxs-lookup"><span data-stu-id="ac629-319">Update your existing cloud service deployment for split-merge in your Azure subscription with the new package and your updated service configuration file.</span></span>

<span data-ttu-id="ac629-320">您無需佈建新的中繼資料資料庫，即可升級分割合併。</span><span class="sxs-lookup"><span data-stu-id="ac629-320">You do not need to provision a new metadata database for split-merge to upgrade.</span></span> <span data-ttu-id="ac629-321">新的版本會自動將現有的中繼資料資料庫升級到新的版本。</span><span class="sxs-lookup"><span data-stu-id="ac629-321">The new version will automatically upgrade your existing metadata database to the new version.</span></span> 

## <a name="best-practices--troubleshooting"></a><span data-ttu-id="ac629-322">最佳作法和疑難排解</span><span class="sxs-lookup"><span data-stu-id="ac629-322">Best practices & troubleshooting</span></span>
* <span data-ttu-id="ac629-323">定義測試租用戶，並在數個分區上對測試租用戶練習您最重要的分割/合併/移動作業。</span><span class="sxs-lookup"><span data-stu-id="ac629-323">Define a test tenant and exercise your most important split/merge/move operations with the test tenant across several shards.</span></span> <span data-ttu-id="ac629-324">確定分區對應中定義的所有中繼資料都正確，且作業未違反條件約束或外部索引鍵。</span><span class="sxs-lookup"><span data-stu-id="ac629-324">Ensure that all metadata is defined correctly in your shard map and that the operations do not violate constraints or foreign keys.</span></span>
* <span data-ttu-id="ac629-325">將測試租用戶資料大小保持大於您最大租用戶的最大資料大小，以確保不會發生資料大小的相關問題。</span><span class="sxs-lookup"><span data-stu-id="ac629-325">Keep the test tenant data size above the maximum data size of your largest tenant to ensure you are not encountering data size related issues.</span></span> <span data-ttu-id="ac629-326">這有助於您評估移動單一租用戶所花費的時間上限。</span><span class="sxs-lookup"><span data-stu-id="ac629-326">This helps you assess an upper bound on the time it takes to move a single tenant around.</span></span> 
* <span data-ttu-id="ac629-327">請確定您的結構描述允許刪除動作。</span><span class="sxs-lookup"><span data-stu-id="ac629-327">Make sure that your schema allows deletions.</span></span> <span data-ttu-id="ac629-328">一旦資料成功複製到目標，分割合併服務必須能夠從來源分區移除資料。</span><span class="sxs-lookup"><span data-stu-id="ac629-328">The split-merge service requires the ability to remove data from the source shard once the data has been successfully copied to the target.</span></span> <span data-ttu-id="ac629-329">例如， **刪除觸發程序** 可能防止服務刪除來源上的資料，也可能造成作業失敗。</span><span class="sxs-lookup"><span data-stu-id="ac629-329">For example, **delete triggers** can prevent the service from deleting the data on the source and may cause operations to fail.</span></span>
* <span data-ttu-id="ac629-330">分區化索引鍵應該為主索引鍵或唯一索引定義中的開頭資料行。</span><span class="sxs-lookup"><span data-stu-id="ac629-330">The sharding key should be the leading column in your primary key or unique index definition.</span></span> <span data-ttu-id="ac629-331">如此可確保分割或合併驗證查詢，以及永遠在分區化索引鍵範圍上執行的實際資料移動和刪除作業，獲得最佳效能。</span><span class="sxs-lookup"><span data-stu-id="ac629-331">That ensures the best performance for the split or merge validation queries, and for the actual data movement and deletion operations which always operate on sharding key ranges.</span></span>
* <span data-ttu-id="ac629-332">將分割合併服務共置在您的資料庫所在的區域和資料中心。</span><span class="sxs-lookup"><span data-stu-id="ac629-332">Collocate your split-merge service in the region and data center where your databases reside.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Anchors-->
<!--Image references-->
[1]:./media/sql-database-elastic-scale-overview-split-and-merge/split-merge-overview.png
[2]:./media/sql-database-elastic-scale-overview-split-and-merge/diagnostics.png
[3]:./media/sql-database-elastic-scale-overview-split-and-merge/diagnostics-config.png

