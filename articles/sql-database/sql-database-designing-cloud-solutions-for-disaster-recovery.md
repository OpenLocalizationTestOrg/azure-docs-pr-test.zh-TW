---
title: "使用 Azure SQL Database 設計高可用性服務 | Microsoft Docs"
description: "了解使用 Azure SQL Database 對高可用性服務的應用程式設計。"
keywords: "cloud disaster recovery,disaster recovery solutions,app data backup,geo-replication,business continuity planning,雲端災害復原,災害復原方案,應用程式資料備份,異地複寫,商務持續性計劃"
services: sql-database
documentationcenter: 
author: anosov1960
manager: jhubbard
editor: monicar
ms.assetid: e8a346ac-dd08-41e7-9685-46cebca04582
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: data-management
ms.date: 04/21/2017
ms.author: sashan
ms.openlocfilehash: 40fe0ae04eb94322356ed19773512e3bc383639c
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/11/2017
---
# <a name="designing-highly-available-services-using-azure-sql-database"></a><span data-ttu-id="3408c-104">使用 Azure SQL Database 設計高可用性服務</span><span class="sxs-lookup"><span data-stu-id="3408c-104">Designing highly available services using Azure SQL Database</span></span>

<span data-ttu-id="3408c-105">在 Azure SQL Database 上建置和部署高可用性服務時，您可以使用[容錯移轉群組和主動式異地複寫](sql-database-geo-replication-overview.md)來為區域性故障和嚴重的服務中斷提供恢復能力，並啟用快速復原至次要資料庫的功能。</span><span class="sxs-lookup"><span data-stu-id="3408c-105">When building and deploying highly available services on Azure SQL Database, you use [failover groups and active geo-replication](sql-database-geo-replication-overview.md) to provide resilience to regional failures and catastrophic outages and enable fast recovery to the secondary databases.</span></span> <span data-ttu-id="3408c-106">本文著重於常見的應用程式模式，以及根據應用程式部署需求、您的目標服務等級協定、流量延遲和成本探討每個選項的優缺點。</span><span class="sxs-lookup"><span data-stu-id="3408c-106">This article focuses on common application patterns and discusses the benefits and trade-offs of each option depending on the application deployment requirements, the service level agreement you are targeting, traffic latency, and costs.</span></span> <span data-ttu-id="3408c-107">如需主動式異地複寫與彈性集區的相關資訊，請參閱[彈性集區災害復原策略](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)。</span><span class="sxs-lookup"><span data-stu-id="3408c-107">For information about active geo-replication with Elastic Pools, see [Elastic Pool disaster recovery strategies](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).</span></span>

## <a name="design-pattern-1-active-passive-deployment-for-cloud-disaster-recovery-with-a-co-located-database"></a><span data-ttu-id="3408c-108">設計模式 1：雲端災害復原的主動-被動部署，使用共置資料庫</span><span class="sxs-lookup"><span data-stu-id="3408c-108">Design pattern 1: Active-passive deployment for cloud disaster recovery with a co-located database</span></span>
<span data-ttu-id="3408c-109">這個選項最適合具有下列特性的應用程式：</span><span class="sxs-lookup"><span data-stu-id="3408c-109">This option is best suited for applications with the following characteristics:</span></span>

* <span data-ttu-id="3408c-110">單一 Azure 區域中的作用中執行個體</span><span class="sxs-lookup"><span data-stu-id="3408c-110">Active instance in a single Azure region</span></span>
* <span data-ttu-id="3408c-111">強烈依賴資料的讀寫 (RW) 存取</span><span class="sxs-lookup"><span data-stu-id="3408c-111">Strong dependency on read-write (RW) access to data</span></span>
* <span data-ttu-id="3408c-112">考量到延遲和流量成本，無法接受 Web 應用程式和資料庫之間的跨區域連線能力</span><span class="sxs-lookup"><span data-stu-id="3408c-112">Cross-region connectivity between the web application and the database is not acceptable due to latency and traffic cost</span></span>    

<span data-ttu-id="3408c-113">在此情況下，當所有應用程式元件都受影響，而需要當成一個單位進行容錯移轉時，應用程式部署拓撲最適合用來處理區域性災害。</span><span class="sxs-lookup"><span data-stu-id="3408c-113">In this case, the application deployment topology is optimized for handling regional disasters when all application components are impacted and need to failover as a unit.</span></span> <span data-ttu-id="3408c-114">在地理備援方面，會將應用程式邏輯和資料庫複寫到另一個區域，但在正常情況下不會使用它們來處理應用程式工作負載。</span><span class="sxs-lookup"><span data-stu-id="3408c-114">For geographic redundancy, the application logic and the database are replicated to another region but they are not used for the application workload under the normal conditions.</span></span> <span data-ttu-id="3408c-115">次要地區中的應用程式應該設定為使用次要資料庫的 SQL 連接字串。</span><span class="sxs-lookup"><span data-stu-id="3408c-115">The application in the secondary region should be configured to use a SQL connection string to the secondary database.</span></span> <span data-ttu-id="3408c-116">流量管理員設為使用 [容錯移轉路由方法](../traffic-manager/traffic-manager-configure-failover-routing-method.md)。</span><span class="sxs-lookup"><span data-stu-id="3408c-116">Traffic manager is set up to use [failover routing method](../traffic-manager/traffic-manager-configure-failover-routing-method.md).</span></span>  

> [!NOTE]
> <span data-ttu-id="3408c-117">這整篇文章使用 [Azure 流量管理員](../traffic-manager/traffic-manager-overview.md)僅供說明用途。</span><span class="sxs-lookup"><span data-stu-id="3408c-117">[Azure traffic manager](../traffic-manager/traffic-manager-overview.md) is used throughout this article for illustration purposes only.</span></span> <span data-ttu-id="3408c-118">您可以使用任何支援容錯移轉路由方法的負載平衡方案。</span><span class="sxs-lookup"><span data-stu-id="3408c-118">You can use any load-balancing solution that supports failover routing method.</span></span>    
>

<span data-ttu-id="3408c-119">下圖顯示此組態在運作中斷之前的情形。</span><span class="sxs-lookup"><span data-stu-id="3408c-119">The following diagram shows this configuration before an outage.</span></span>

![SQL Database 異地複寫組態。](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-1.png)

<span data-ttu-id="3408c-122">在主要區域中斷之後，SQL Database 服務會偵測到主要資料庫無法存取，並根據自動容錯移轉原則的參數觸發容錯移轉至次要資料庫。</span><span class="sxs-lookup"><span data-stu-id="3408c-122">After an outage in the primary region, the SQL Database service detects that the primary database is not accessible and trigger a failover to the secondary database based on the parameters of the automatic failover policy.</span></span> <span data-ttu-id="3408c-123">根據您的應用程式 SLA，您可以決定在中斷偵測和容錯移轉本身之間設定寬限期。</span><span class="sxs-lookup"><span data-stu-id="3408c-123">Depending on your application SLA, you can decide to configure a grace period between the detection of the outage and the failover itself.</span></span> <span data-ttu-id="3408c-124">設定寬限期可減少在重大中斷且區域可用性無法快速還原的情況下減少資料遺失的風險。</span><span class="sxs-lookup"><span data-stu-id="3408c-124">Configuring a grace period reduces the risk of data loss to the cases where the outage is catastrophic and availability in the region cannot be quickly restored.</span></span> <span data-ttu-id="3408c-125">如果流量管理員在容錯移轉群組觸發資料庫的容錯移轉之前就啟動端點容錯移轉，Web 應用程式會無法重新連線到資料庫。</span><span class="sxs-lookup"><span data-stu-id="3408c-125">If the endpoint failover is initiated by the traffic manager before the failover group triggers the failover of the database, the web application is not able to reconnect to the database.</span></span> <span data-ttu-id="3408c-126">資料庫容錯移轉一旦完成，應用程式的重新連線嘗試就會自動成功。</span><span class="sxs-lookup"><span data-stu-id="3408c-126">The application’s attempt to reconnect automatically succeeds as soon as the database failover completes.</span></span> 

> [!NOTE]
> <span data-ttu-id="3408c-127">若要完全協調應用程式和資料庫的容錯移轉，您應該設計您自己的監視方法，並以手動方式容錯移轉 Web 應用程式端點和資料庫。</span><span class="sxs-lookup"><span data-stu-id="3408c-127">To achieve fully coordinated failover of the application and the databases, you should devise your own monitoring method and use manual failover of the web application endpoints and the databases.</span></span>
>

<span data-ttu-id="3408c-128">應用程式端點和資料庫兩者的容錯移轉完成後，應用程式會重新開始處理區域 B 的使用者要求，然後會與資料庫維持在相同位置，因為主要資料庫目前位於區域 B。下圖說明這種情況。</span><span class="sxs-lookup"><span data-stu-id="3408c-128">After the failover of both the application’s endpoints and the database completes, the application will re-start processing the user requests in the region B and will remain co-located with the database because the primary database is now in region B. This scenario is illustrated in the following diagram.</span></span> <span data-ttu-id="3408c-129">在所有圖表中，實線表示作用中連線，虛線表示暫止的連線，停止標誌表示動作觸發。</span><span class="sxs-lookup"><span data-stu-id="3408c-129">In all diagrams, solid lines indicate active connections, dotted lines indicate suspended connections, and stop signs indicate action triggers.</span></span>

![異地複寫：容錯移轉至次要資料庫。](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-2.png)

<span data-ttu-id="3408c-132">如果次要地區發生運作中斷，主要與次要資料庫之間的複寫連結會暫停，但是不會觸發容錯移轉，因為主要資料庫未受到影響。</span><span class="sxs-lookup"><span data-stu-id="3408c-132">If an outage happens in the secondary region, the replication link between the primary and the secondary database is suspended but the failover is not triggered because the primary database is not impacted.</span></span> <span data-ttu-id="3408c-133">在此案例中，應用程式的可用性不會改變，但應用程式會在曝露的情況下運作，因此，萬一這兩個區域連續失敗，將帶來較高的風險。</span><span class="sxs-lookup"><span data-stu-id="3408c-133">The application's availability is not changed in this case, but the application operates exposed and therefore at higher risk in case both regions fail in succession.</span></span>

> [!NOTE]
> <span data-ttu-id="3408c-134">災害復原的應用程式部署設定，建議限制在兩個區域。</span><span class="sxs-lookup"><span data-stu-id="3408c-134">For disaster recovery we recommend the configuration with application deployment limited to two regions.</span></span> <span data-ttu-id="3408c-135">這是因為大部分的 Azure 地理位置只有兩個區域。</span><span class="sxs-lookup"><span data-stu-id="3408c-135">This is because most of the Azure geographies have only two regions.</span></span> <span data-ttu-id="3408c-136">這些設定不會保護應用程式免於遭受兩個區域同時發生的重大失敗。</span><span class="sxs-lookup"><span data-stu-id="3408c-136">This configuration will not protect your application from a simultaneous catastrophic failure of both regions.</span></span>  <span data-ttu-id="3408c-137">在這種罕見的失敗情況下，您可以使用[異地復原作業](sql-database-disaster-recovery.md#recover-using-geo-restore)，在第三個區域復原資料庫。</span><span class="sxs-lookup"><span data-stu-id="3408c-137">In an unlikely event of such a failure, you can recover your databases in a third region using [geo-restore operation](sql-database-disaster-recovery.md#recover-using-geo-restore).</span></span>
>

<span data-ttu-id="3408c-138">一旦運作中斷情況趨緩，次要資料庫將會自動與主要資料庫重新同步處理。</span><span class="sxs-lookup"><span data-stu-id="3408c-138">Once the outage is mitigated, the secondary database will automatically re-synchronize with the primary.</span></span> <span data-ttu-id="3408c-139">在同步處理期間，視需要同步處理的資料量而定，主要資料庫的效能可能會稍微受到影響。</span><span class="sxs-lookup"><span data-stu-id="3408c-139">During synchronization, performance of the primary could be slightly impacted depending on the amount of data that needs to be synchronized.</span></span> <span data-ttu-id="3408c-140">下圖說明次要地區發生運作中斷的情形。</span><span class="sxs-lookup"><span data-stu-id="3408c-140">The following diagram illustrates an outage in the secondary region.</span></span>

![次要資料庫會與主要資料庫進行同步處理。](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern1-3.png)

<span data-ttu-id="3408c-143">此設計模式的主要 **優點** 包括：</span><span class="sxs-lookup"><span data-stu-id="3408c-143">The key **advantages** of this design pattern are:</span></span>

* <span data-ttu-id="3408c-144">這兩個區域會部署相同的 Web 應用程式，不需要任何特定地區組態和任何其他邏輯來回應容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="3408c-144">The same web application is deployed to both regions without any region-specific configuration and no additional logic to react to the failover.</span></span> 
* <span data-ttu-id="3408c-145">應用程式的效能不會受到容錯移轉所影響，因為 Web 應用程式和資料庫永遠共置。</span><span class="sxs-lookup"><span data-stu-id="3408c-145">The application's performance is not impacted by failover as the web application and the database are always co-located.</span></span>

<span data-ttu-id="3408c-146">主要 **缺點** 是次要地區中的備援應用程式執行個體只用於災害復原。</span><span class="sxs-lookup"><span data-stu-id="3408c-146">The main **tradeoff** is that the redundant application instance in the secondary region is only used for disaster recovery.</span></span>

## <a name="design-pattern-2-active-active-deployment-for-application-load-balancing"></a><span data-ttu-id="3408c-147">設計模式 2：應用程式負載平衡的主動-主動部署</span><span class="sxs-lookup"><span data-stu-id="3408c-147">Design pattern 2: Active-active deployment for application load balancing</span></span>
<span data-ttu-id="3408c-148">此雲端災害復原選項最適合具有下列特性的應用程式：</span><span class="sxs-lookup"><span data-stu-id="3408c-148">This cloud disaster recovery option is best suited for applications with the following characteristics:</span></span>

* <span data-ttu-id="3408c-149">資料庫的讀取與寫入比率很高</span><span class="sxs-lookup"><span data-stu-id="3408c-149">High ratio of database reads to writes</span></span>
* <span data-ttu-id="3408c-150">使用者體驗到的資料庫讀取延遲比寫入延遲更為重要</span><span class="sxs-lookup"><span data-stu-id="3408c-150">Database read latency is more critical for the end-user experience than the write latency</span></span> 
* <span data-ttu-id="3408c-151">使用不同的連接字串可以隔開唯讀邏輯和讀寫邏輯</span><span class="sxs-lookup"><span data-stu-id="3408c-151">Read-only logic can be separated from read-write logic by using a different connection string</span></span>
* <span data-ttu-id="3408c-152">唯讀邏輯不依賴資料與最新更新完全同步</span><span class="sxs-lookup"><span data-stu-id="3408c-152">Read-only logic does not depend on data being fully synchronized with the latest updates</span></span>  

<span data-ttu-id="3408c-153">如果您的應用程式具有這些特性，只要將使用者連線的負載分散於不同區域中的多個應用程式執行個體，即可大幅改善整體的使用者體驗。</span><span class="sxs-lookup"><span data-stu-id="3408c-153">If your applications have these characteristics, load balancing the end-user connections across multiple application instances in different regions can substantially improve the overall end-user experience.</span></span> <span data-ttu-id="3408c-154">其中兩個區域應該選取做為 DR 配對，容錯移轉群組則應該包含這些區域中的資料庫。</span><span class="sxs-lookup"><span data-stu-id="3408c-154">Two of the regions should be selected as the DR pair and the failover group should include the databases in these regions.</span></span> <span data-ttu-id="3408c-155">為了實作負載平衡，每個區域都應該有應用程式的作用中執行個體，而且讀寫 (RW) 邏輯要連接到容錯移轉群組的讀寫接聽程式端點。</span><span class="sxs-lookup"><span data-stu-id="3408c-155">To implement load-balancing, each region should have an active instance of the application with the read-write (RW) logic connected to the read-write listener endpoint of the failover group.</span></span> <span data-ttu-id="3408c-156">如果主要資料庫因為運作中斷受到影響，這可以保證容錯移轉將會自動起始。</span><span class="sxs-lookup"><span data-stu-id="3408c-156">It will guarantee that the failover will be automatically initiated if the primary database is impacted by an outage.</span></span> <span data-ttu-id="3408c-157">Web 應用程式中的唯讀邏輯 (RO) 應該直接連接到該區域中的資料庫。</span><span class="sxs-lookup"><span data-stu-id="3408c-157">The read-only logic (RO) in the web application should connect directly to the database in that region.</span></span> <span data-ttu-id="3408c-158">流量管理員應該設定為使用[效能路由](../traffic-manager/traffic-manager-configure-performance-routing-method.md)，而且每個應用程式執行個體都啟用[端點監視](../traffic-manager/traffic-manager-monitoring.md)。</span><span class="sxs-lookup"><span data-stu-id="3408c-158">Traffic manager should be set up to use [performance routing](../traffic-manager/traffic-manager-configure-performance-routing-method.md) with [end-point monitoring](../traffic-manager/traffic-manager-monitoring.md) enabled for each application instance.</span></span>

<span data-ttu-id="3408c-159">如同模式 #1，您應該考慮部署類似的監視應用程式。</span><span class="sxs-lookup"><span data-stu-id="3408c-159">As in pattern #1, you should consider deploying a similar monitoring application.</span></span> <span data-ttu-id="3408c-160">但有別於模式 #1，監視應用程式將不負責觸發端點容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="3408c-160">But unlike pattern #1, the monitoring application will not be responsible for triggering the end-point failover.</span></span>

> [!NOTE]
> <span data-ttu-id="3408c-161">雖然此模式使用一個以上的次要資料庫，但只有區域 B 的次要資料庫才會用於容錯移轉，也應該屬於容錯移轉群組。</span><span class="sxs-lookup"><span data-stu-id="3408c-161">While this pattern uses more than one secondary database, only the secondary in Region B  would be used for failover and should be part of the failover group.</span></span>
>

<span data-ttu-id="3408c-162">流量管理員應該設定為效能路由，將使用者連接導向最靠近使用者地理位置的應用程式執行個體。</span><span class="sxs-lookup"><span data-stu-id="3408c-162">Traffic manager should be configured for performance routing to direct the user connections to the application instance closest to the user's geographic location.</span></span> <span data-ttu-id="3408c-163">下圖說明此組態在運作中斷之前的情形。</span><span class="sxs-lookup"><span data-stu-id="3408c-163">The following diagram illustrates this configuration before an outage.</span></span>

![無中斷：將效能轉送至最接近的應用程式。](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-1.png)

<span data-ttu-id="3408c-166">如果區域 A 偵測到資料庫中斷，容錯移轉群組會自動開始將區域 A 的主要資料庫容錯移轉到區域 B 的次要資料庫。它也會將讀寫接聽程式端點自動更新到區域 B，讓 Web 應用程式中的讀寫連接不會受到影響。</span><span class="sxs-lookup"><span data-stu-id="3408c-166">If a database outage is detected in the region A, the failover group will automatically initiate failover of the primary database in region A to the secondary in region B. It will also automatically update the read-write listener endpoint to region B so read-write connections in the web application will not be impacted.</span></span> <span data-ttu-id="3408c-167">流量管理員會從路由表中排除離線端點，但會繼續將使用者流量路由傳送至剩餘的線上執行個體。</span><span class="sxs-lookup"><span data-stu-id="3408c-167">The traffic manager will exclude the offline end-point from the routing table but will continue routing the end-user traffic to the remaining online instances.</span></span> <span data-ttu-id="3408c-168">唯讀 SQL 連接字串不會受到影響，因為它們永遠指向相同區域中的資料庫。</span><span class="sxs-lookup"><span data-stu-id="3408c-168">The read-only SQL connection strings will not be impacted as they always point to the database in the same region.</span></span> 

<span data-ttu-id="3408c-169">下圖說明容錯移轉之後的新組態。</span><span class="sxs-lookup"><span data-stu-id="3408c-169">The following diagram illustrates the new configuration after the failover.</span></span>

![容錯移轉之後的組態。](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-2.png)

<span data-ttu-id="3408c-172">如果其中一個次要地區發生運作中斷，流量管理員將會自動從路由表中移除該區域中的離線端點。</span><span class="sxs-lookup"><span data-stu-id="3408c-172">In case of an outage in one of the secondary regions, the traffic manager will automatically remove the offline end-point in that region from the routing table.</span></span> <span data-ttu-id="3408c-173">對於該區域中次要資料庫的複寫通道將會暫止。</span><span class="sxs-lookup"><span data-stu-id="3408c-173">The replication channel to the secondary database in that region will be suspended.</span></span> <span data-ttu-id="3408c-174">因為在此案例中，剩餘的區域會收到更多使用者流量，所以中斷期間將會影響應用程式的效能。</span><span class="sxs-lookup"><span data-stu-id="3408c-174">Because the remaining regions get additional user traffic in this scenario, the application's performance will be impacted during the outage.</span></span> <span data-ttu-id="3408c-175">一旦運作中斷情況趨緩，受影響區域中的次要資料庫將會立即與主要資料庫進行同步處理。</span><span class="sxs-lookup"><span data-stu-id="3408c-175">Once the outage is mitigated, the secondary database in the impacted region will be immediately synchronized with the primary.</span></span> <span data-ttu-id="3408c-176">在同步處理期間，主要資料庫的效能可能稍微受到影響，視需要同步處理的資料量而定。</span><span class="sxs-lookup"><span data-stu-id="3408c-176">During the synchronization performance of the primary could be slightly impacted depending on the amount of data that needs to be synchronized.</span></span> <span data-ttu-id="3408c-177">下圖說明區域 B 發生運作中斷的情形。</span><span class="sxs-lookup"><span data-stu-id="3408c-177">The following diagram illustrates an outage in region B.</span></span>

![次要地區中斷。](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern2-3.png)

<span data-ttu-id="3408c-180">這個設計模式的主要 **優點** 是您可以跨多個次要地區調整應用程式工作負載，以達到最佳的使用者效能。</span><span class="sxs-lookup"><span data-stu-id="3408c-180">The key **advantage** of this design pattern is that you can scale the application workload across multiple secondaries to achieve the optimal end-user performance.</span></span> <span data-ttu-id="3408c-181">此選項的 **缺點** 包括：</span><span class="sxs-lookup"><span data-stu-id="3408c-181">The **tradeoffs** of this option are:</span></span>

* <span data-ttu-id="3408c-182">應用程式執行個體和資料庫之間的讀寫連接有不同的延遲和成本</span><span class="sxs-lookup"><span data-stu-id="3408c-182">Read-write connections between the application instances and database have varying latency and cost</span></span>
* <span data-ttu-id="3408c-183">運作中斷期間會影響應用程式效能</span><span class="sxs-lookup"><span data-stu-id="3408c-183">Application performance is impacted during the outage</span></span>

> [!NOTE]
> <span data-ttu-id="3408c-184">有一個類似的方法可用來卸載特殊工作負載，例如報告工作、商業智慧工具或備份。</span><span class="sxs-lookup"><span data-stu-id="3408c-184">A similar approach can be used to offload specialized workloads such as reporting jobs, business intelligence tools, or backups.</span></span> <span data-ttu-id="3408c-185">這些工作負載通常會耗用大量的資料庫資源，因此建議您為它們指定其中一個次要資料庫，而且效能層級要符合預期的工作負載。</span><span class="sxs-lookup"><span data-stu-id="3408c-185">Typically, these workloads consume significant database resources therefore it is recommended that you designate one of the secondary databases for them with the performance level matched to the anticipated workload.</span></span>
>

## <a name="design-pattern-3-active-passive-deployment-for-data-preservation"></a><span data-ttu-id="3408c-186">設計模式 3：資料保留的主動-被動部署</span><span class="sxs-lookup"><span data-stu-id="3408c-186">Design pattern 3: Active-passive deployment for data preservation</span></span>
<span data-ttu-id="3408c-187">這個選項最適合具有下列特性的應用程式：</span><span class="sxs-lookup"><span data-stu-id="3408c-187">This option is best suited for applications with the following characteristics:</span></span>

* <span data-ttu-id="3408c-188">任何資料遺失都會帶來極高的商業風險。</span><span class="sxs-lookup"><span data-stu-id="3408c-188">Any data loss is high business risk.</span></span> <span data-ttu-id="3408c-189">資料庫容錯移轉只能當作中斷情況嚴重時的最後手段。</span><span class="sxs-lookup"><span data-stu-id="3408c-189">The database failover can only be used as a last resort if the outage is catastrophic.</span></span>
* <span data-ttu-id="3408c-190">應用程式支援唯讀和讀寫模式的作業，而且可以「唯讀模式」運作一段時間。</span><span class="sxs-lookup"><span data-stu-id="3408c-190">The application supports read-only and read-write modes of operations and can operate in "read-only mode" for a period of time.</span></span>

<span data-ttu-id="3408c-191">在此模式中，應用程式會在讀寫連接開始收到逾時錯誤時切換到唯讀模式。</span><span class="sxs-lookup"><span data-stu-id="3408c-191">In this pattern, the application switches to read-only mode when the read-write connections start getting time-out errors.</span></span> <span data-ttu-id="3408c-192">Web 應用程式要部署到這兩個區域，並且包含讀寫接聽程式端點的連接，和唯讀接聽程式端點的不同連接。</span><span class="sxs-lookup"><span data-stu-id="3408c-192">The Web Application is deployed to both regions and include a connection to the read-write listener endpoint and different connection to the read-only listener endpoint.</span></span> <span data-ttu-id="3408c-193">流量管理員應該設定為使用[容錯移轉路由](../traffic-manager/traffic-manager-configure-failover-routing-method.md)，而且每個區域中的應用程式端點都啟用[端點監視](../traffic-manager/traffic-manager-monitoring.md)。</span><span class="sxs-lookup"><span data-stu-id="3408c-193">The Traffic manager should be set up to use [failover routing](../traffic-manager/traffic-manager-configure-failover-routing-method.md) with [end-point monitoring](../traffic-manager/traffic-manager-monitoring.md) enabled for the application endpoint in each region.</span></span>

<span data-ttu-id="3408c-194">下圖說明此組態在運作中斷之前的情形。</span><span class="sxs-lookup"><span data-stu-id="3408c-194">The following diagram illustrates this configuration before an outage.</span></span>

![容錯移轉之前的主動/被動部署。](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-1.png)

<span data-ttu-id="3408c-197">當流量管理員偵測到區域 A 的連線失敗時，會自動將使用者流量切換到區域 B 中的應用程式執行個體。使用此模式時，請務必將資料遺失的寬限期設為夠高的值，例如 24 小時。</span><span class="sxs-lookup"><span data-stu-id="3408c-197">When the traffic manager detects a connectivity failure to region A, it automatically switches user traffic to the application instance in region B. With this pattern, it is important that you set the grace period with data loss to a sufficiently high value, e.g. 24 hours.</span></span> <span data-ttu-id="3408c-198">如果在該時間內中斷情況已趨緩，這可以確保避免遺失資料。</span><span class="sxs-lookup"><span data-stu-id="3408c-198">It will ensure that data loss is prevented if the outage is mitigated within that time.</span></span> <span data-ttu-id="3408c-199">當區域 B 的 Web 應用程式啟動時，讀寫作業將會開始失敗。</span><span class="sxs-lookup"><span data-stu-id="3408c-199">When the Web application in the region B is activated the read-write operations will start failing.</span></span> <span data-ttu-id="3408c-200">此時應該會切換到唯讀模式。</span><span class="sxs-lookup"><span data-stu-id="3408c-200">At that point, it should switch to the read-only mode.</span></span> <span data-ttu-id="3408c-201">在此模式中，要求將會自動路由到次要資料庫。</span><span class="sxs-lookup"><span data-stu-id="3408c-201">In this mode the requests will be automatically routed to the secondary database.</span></span> <span data-ttu-id="3408c-202">發生中斷情況不會在寬限期內趨緩的災難性失敗時，容錯移轉群組將會觸發容錯移轉。</span><span class="sxs-lookup"><span data-stu-id="3408c-202">In the case of a catastrophic failure the outage will not be mitigated within the grace period and the failover group will trigger the failover.</span></span> <span data-ttu-id="3408c-203">之後就可以使用讀寫接聽程式，呼叫就不會再失敗。</span><span class="sxs-lookup"><span data-stu-id="3408c-203">After that the read-write listener will become available and the calls to it will stop failing.</span></span> <span data-ttu-id="3408c-204">下圖說明這種情形。</span><span class="sxs-lookup"><span data-stu-id="3408c-204">This is illustrated by the following diagram.</span></span>

![中斷：處於唯讀模式的應用程式。](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-2.png)

<span data-ttu-id="3408c-207">如果主要區域的運作中斷情況在寬限期內趨緩，流量管理員就會偵測到主要區域中的連線恢復，然後將使用者流量切換回到區域 A 中的應用程式執行個體。該應用程式執行個體會繼續使用區域 A 的主要資料庫以讀寫模式運作。</span><span class="sxs-lookup"><span data-stu-id="3408c-207">If the outage in the primary region is mitigated within the grace period, traffic manager detects the restoration of connectivity in the primary region and switches user traffic back to the application instance in region A. That application instance resumes and operates in read-write mode using the primary database in region A.</span></span>

<span data-ttu-id="3408c-208">如果是區域 B 發生中斷情況，流量管理員會偵測到區域 B 中的應用程式端點失敗，容錯移轉群組就會將唯讀接聽程式切換到區域 A。此中斷情況不會影響使用者體驗，但是主要資料庫會在中斷期間曝露出來。</span><span class="sxs-lookup"><span data-stu-id="3408c-208">In case of an outage in the region B, the traffic manager detects the failure of the application end-point in region B and the failover group switches the read-only listener to region A. This outage does not impact the end-user experience but the primary database will be exposed during the outage.</span></span> <span data-ttu-id="3408c-209">下圖說明這種情形。</span><span class="sxs-lookup"><span data-stu-id="3408c-209">This is illustrated by the following diagram.</span></span>

![中斷：次要資料庫。](./media/sql-database-designing-cloud-solutions-for-disaster-recovery/pattern3-3.png)

<span data-ttu-id="3408c-212">一旦中斷情況趨緩，次要資料庫會立即與主要資料庫同步處理，唯讀接聽程式會切換回區域 B 中的次要資料庫。在同步處理期間，主要資料庫的效能可能會根據需要進行同步處理的資料量而稍微受到影響。</span><span class="sxs-lookup"><span data-stu-id="3408c-212">Once the outage is mitigated, the secondary database is immediately synchronized with the primary and the read-only listener is switched back to the secondary database in region B. During synchronization performance of the primary could be slightly impacted depending on the amount of data that needs to be synchronized.</span></span>

<span data-ttu-id="3408c-213">此設計模式有幾個 **優點**：</span><span class="sxs-lookup"><span data-stu-id="3408c-213">This design pattern has several **advantages**:</span></span>

* <span data-ttu-id="3408c-214">在暫時性運作中斷期間避免資料遺失。</span><span class="sxs-lookup"><span data-stu-id="3408c-214">It avoids data loss during the temporary outages.</span></span>
* <span data-ttu-id="3408c-215">停機時間僅取決於流量管理員多快偵測到連線失敗，而這是可設定的。</span><span class="sxs-lookup"><span data-stu-id="3408c-215">Downtime depends only on how quickly traffic manager detects the connectivity failure, which is configurable.</span></span>

<span data-ttu-id="3408c-216">**取捨**是︰</span><span class="sxs-lookup"><span data-stu-id="3408c-216">The **tradeoff** is:</span></span>

* <span data-ttu-id="3408c-217">應用程式必須能夠在唯讀模式下運作。</span><span class="sxs-lookup"><span data-stu-id="3408c-217">Application must be able to operate in read-only mode.</span></span>

> [!NOTE]
> <span data-ttu-id="3408c-218">如果區域中發生永久性服務中斷，您就必須手動啟動資料庫容錯移轉並承受資料遺失。</span><span class="sxs-lookup"><span data-stu-id="3408c-218">In case of a permanent service outage in the region, you manually activate database failover and accept the data loss.</span></span> <span data-ttu-id="3408c-219">應用程式將在次要地區中運作，而且具有資料庫的讀寫存取。</span><span class="sxs-lookup"><span data-stu-id="3408c-219">The application will be functional in the secondary region with read-write access to the database.</span></span>
>

## <a name="business-continuity-planning-choose-an-application-design-for-cloud-disaster-recovery"></a><span data-ttu-id="3408c-220">商務持續性計劃：針對雲端災害復原選擇應用程式設計</span><span class="sxs-lookup"><span data-stu-id="3408c-220">Business continuity planning: Choose an application design for cloud disaster recovery</span></span>
<span data-ttu-id="3408c-221">特定的雲端災害復原策略可以合併或擴充這些設計模式，以完全滿足應用程式的需求。</span><span class="sxs-lookup"><span data-stu-id="3408c-221">Your specific cloud disaster recovery strategy can combine or extend these design patterns to best meet the needs of your application.</span></span>  <span data-ttu-id="3408c-222">如先前所述，您選擇的策略取決於您想要提供給客戶的 SLA 和應用程式部署拓樸。</span><span class="sxs-lookup"><span data-stu-id="3408c-222">As mentioned earlier, the strategy you choose is based on the SLA you want to offer to your customers and the application deployment topology.</span></span> <span data-ttu-id="3408c-223">為了協助指導您做決定，下表根據預估資料遺失或復原點目標 (RPO) 和預估復原時間 (ERT) 來比較各種選擇。</span><span class="sxs-lookup"><span data-stu-id="3408c-223">To help guide your decision, the following table compares the choices based on the estimated data loss or recovery point objective (RPO) and estimated recovery time (ERT).</span></span>

| <span data-ttu-id="3408c-224">模式</span><span class="sxs-lookup"><span data-stu-id="3408c-224">Pattern</span></span> | <span data-ttu-id="3408c-225">RPO</span><span class="sxs-lookup"><span data-stu-id="3408c-225">RPO</span></span> | <span data-ttu-id="3408c-226">ERT</span><span class="sxs-lookup"><span data-stu-id="3408c-226">ERT</span></span> |
|:--- |:--- |:--- |
| <span data-ttu-id="3408c-227">災害復原的主動-被動部署，使用共置資料庫存取</span><span class="sxs-lookup"><span data-stu-id="3408c-227">Active-passive deployment for disaster recovery with co-located database access</span></span> |<span data-ttu-id="3408c-228">讀寫存取 < 5 秒</span><span class="sxs-lookup"><span data-stu-id="3408c-228">Read-write access < 5 sec</span></span> |<span data-ttu-id="3408c-229">失敗偵測時間 + DNS TTL</span><span class="sxs-lookup"><span data-stu-id="3408c-229">Failure detection time + DNS TTL</span></span> |
| <span data-ttu-id="3408c-230">應用程式負載平衡的主動-主動部署</span><span class="sxs-lookup"><span data-stu-id="3408c-230">Active-active deployment for application load balancing</span></span> |<span data-ttu-id="3408c-231">讀寫存取 < 5 秒</span><span class="sxs-lookup"><span data-stu-id="3408c-231">Read-write access < 5 sec</span></span> |<span data-ttu-id="3408c-232">失敗偵測時間 + DNS TTL</span><span class="sxs-lookup"><span data-stu-id="3408c-232">Failure detection time + DNS TTL</span></span> |
| <span data-ttu-id="3408c-233">資料保留的主動-被動部署</span><span class="sxs-lookup"><span data-stu-id="3408c-233">Active-passive deployment for data preservation</span></span> |<span data-ttu-id="3408c-234">唯讀存取 < 5 秒</span><span class="sxs-lookup"><span data-stu-id="3408c-234">Read-only access < 5 sec</span></span> | <span data-ttu-id="3408c-235">唯讀存取 = 0</span><span class="sxs-lookup"><span data-stu-id="3408c-235">Read-only access = 0</span></span> |
||<span data-ttu-id="3408c-236">讀寫存取 = 0</span><span class="sxs-lookup"><span data-stu-id="3408c-236">Read-write access = zero</span></span> | <span data-ttu-id="3408c-237">讀寫存取 = 失敗偵測時間 + 遺失資料的寬限期</span><span class="sxs-lookup"><span data-stu-id="3408c-237">Read-write access = Failure detection time + grace period with data loss</span></span> |
|||

## <a name="next-steps"></a><span data-ttu-id="3408c-238">後續步驟</span><span class="sxs-lookup"><span data-stu-id="3408c-238">Next steps</span></span>
* <span data-ttu-id="3408c-239">若要了解 Azure SQL Database 自動備份，請參閱 [SQL Database 自動備份](sql-database-automated-backups.md)</span><span class="sxs-lookup"><span data-stu-id="3408c-239">To learn about Azure SQL Database automated backups, see [SQL Database automated backups](sql-database-automated-backups.md)</span></span>
* <span data-ttu-id="3408c-240">如需商務持續性概觀和案例，請參閱 [商務持續性概觀](sql-database-business-continuity.md)</span><span class="sxs-lookup"><span data-stu-id="3408c-240">For a business continuity overview and scenarios, see [Business continuity overview](sql-database-business-continuity.md)</span></span>
* <span data-ttu-id="3408c-241">若要了解如何使用自動備份進行復原，請參閱 [從服務起始的備份還原資料庫](sql-database-recovery-using-backups.md)</span><span class="sxs-lookup"><span data-stu-id="3408c-241">To learn about using automated backups for recovery, see [restore a database from the service-initiated backups](sql-database-recovery-using-backups.md)</span></span>
* <span data-ttu-id="3408c-242">若要了解更快速的復原選項，請參閱[主動式異地複寫](sql-database-geo-replication-overview.md)</span><span class="sxs-lookup"><span data-stu-id="3408c-242">To learn about faster recovery options, see [active geo-replication](sql-database-geo-replication-overview.md)</span></span>  
* <span data-ttu-id="3408c-243">若要了解如何使用自動備份進行封存，請參閱 [資料庫複製](sql-database-copy.md)</span><span class="sxs-lookup"><span data-stu-id="3408c-243">To learn about using automated backups for archiving, see [database copy](sql-database-copy.md)</span></span>
* <span data-ttu-id="3408c-244">如需主動式異地複寫與彈性集區的相關資訊，請參閱[彈性集區災害復原策略](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md)。</span><span class="sxs-lookup"><span data-stu-id="3408c-244">For information about active geo-replication with Elastic Pools, see [Elastic Pool disaster recovery strategies](sql-database-disaster-recovery-strategies-for-applications-with-elastic-pool.md).</span></span>
