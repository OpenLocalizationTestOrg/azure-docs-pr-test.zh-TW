---
title: "虛擬網路的 aaaHow toouse Azure API 管理"
description: "了解如何 toosetup 連接 tooa 虛擬網路在 Azure API 管理及存取 web 服務透過它。"
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.openlocfilehash: 426b3974e4fed7daffdb0c3f02381edbc326dc28
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="how-toouse-azure-api-management-with-virtual-networks"></a><span data-ttu-id="80ae1-103">如何搭配虛擬網路的 toouse Azure API 管理</span><span class="sxs-lookup"><span data-stu-id="80ae1-103">How toouse Azure API Management with virtual networks</span></span>
<span data-ttu-id="80ae1-104">Azure 虛擬網路 (Vnet) 可讓您 tooplace 任何非網際網路 routeable 網路而您控制在您的 Azure 資源存取權。</span><span class="sxs-lookup"><span data-stu-id="80ae1-104">Azure Virtual Networks (VNETs) allow you tooplace any of your Azure resources in a non-internet routeable network that you control access to.</span></span> <span data-ttu-id="80ae1-105">這些網路接著可以使用各種不同的 VPN 技術 tooyour 連線在內部部署網路。</span><span class="sxs-lookup"><span data-stu-id="80ae1-105">These networks can then be connected tooyour on-premises networks using various VPN technologies.</span></span> <span data-ttu-id="80ae1-106">有關 Azure 虛擬網路的詳細資訊與 hello 資訊開始的 toolearn: [Azure 虛擬網路概觀](../virtual-network/virtual-networks-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="80ae1-106">toolearn more about Azure Virtual Networks start with hello information here: [Azure Virtual Network Overview](../virtual-network/virtual-networks-overview.md).</span></span>

<span data-ttu-id="80ae1-107">您可以 hello 虛擬網路 (VNET)，內部部署 azure API 管理，讓它能夠存取 hello 網路中的後端服務。</span><span class="sxs-lookup"><span data-stu-id="80ae1-107">Azure API Management can be deployed inside hello virtual network (VNET), so it can access backend services within hello network.</span></span> <span data-ttu-id="80ae1-108">hello 開發人員入口網站和 API 閘道，可以設定的 toobe 從 hello 網際網路或只在 hello 虛擬網路內存取。</span><span class="sxs-lookup"><span data-stu-id="80ae1-108">hello developer portal and API gateway, can be configured toobe accessible either from hello Internet or only within hello virtual network.</span></span>

> [!NOTE]
> <span data-ttu-id="80ae1-109">Azure API 管理支援傳統和 Azure Resource Manager Vnet。</span><span class="sxs-lookup"><span data-stu-id="80ae1-109">Azure API Management supports both classic and Azure Resource Manager VNets.</span></span>
>
>

## <span data-ttu-id="80ae1-110"><a name="enable-vpn"> </a>啟用 VNET 連線</span><span class="sxs-lookup"><span data-stu-id="80ae1-110"><a name="enable-vpn"> </a>Enable VNET connection</span></span>
> [!NOTE]
> <span data-ttu-id="80ae1-111">VNET 連線位於 hello **Premium**和**開發人員**層。</span><span class="sxs-lookup"><span data-stu-id="80ae1-111">VNET connectivity is available in hello **Premium** and **Developer** tiers.</span></span> <span data-ttu-id="80ae1-112">hello 層之間 tooswitch hello Azure 入口網站中開啟您的 API 管理服務，然後再開啟 hello**小數位數和定價** 索引標籤。在 hello**定價層**區段中，選取 hello Premium 或開發人員階層，然後按一下 儲存。</span><span class="sxs-lookup"><span data-stu-id="80ae1-112">tooswitch between hello tiers, open your API Management service in hello Azure portal and then open hello **Scale and pricing** tab. Under hello **Pricing tier** section, select hello Premium or Developer tier and click Save.</span></span>
>

<span data-ttu-id="80ae1-113">tooenable VNET 連線能力，在 hello Azure 入口網站中開啟您的 API 管理服務，並開啟 hello**虛擬網路**頁面。</span><span class="sxs-lookup"><span data-stu-id="80ae1-113">tooenable VNET connectivity, open your API Management service in hello Azure portal and open hello **Virtual network** page.</span></span>

![API 管理的虛擬網路功能表][api-management-using-vnet-menu]

<span data-ttu-id="80ae1-115">選取所需的 hello 存取類型：</span><span class="sxs-lookup"><span data-stu-id="80ae1-115">Select hello desired access type:</span></span>

* <span data-ttu-id="80ae1-116">**外部**: hello API 管理閘道和開發人員入口網站進行存取 hello 外部負載平衡器透過公用網際網路。</span><span class="sxs-lookup"><span data-stu-id="80ae1-116">**External**: hello API Management gateway and developer portal are accessible from hello public internet via an external load balancer.</span></span> <span data-ttu-id="80ae1-117">hello 閘道可以存取 hello 虛擬網路內的資源。</span><span class="sxs-lookup"><span data-stu-id="80ae1-117">hello gateway can access resources within hello virtual network.</span></span>

![公用對等互連][api-management-vnet-public]

* <span data-ttu-id="80ae1-119">**內部**: hello API 管理閘道和開發人員入口網站會透過內部負載平衡器的 hello 虛擬網路只能從存取。</span><span class="sxs-lookup"><span data-stu-id="80ae1-119">**Internal**: hello API Management gateway and developer portal are accessible only from within hello virtual network via an internal load balancer.</span></span> <span data-ttu-id="80ae1-120">hello 閘道可以存取 hello 虛擬網路內的資源。</span><span class="sxs-lookup"><span data-stu-id="80ae1-120">hello gateway can access resources within hello virtual network.</span></span>

![私人對等互連][api-management-vnet-private]

<span data-ttu-id="80ae1-122">您現在會看見佈建 API 管理服務所在的所有區域的清單。</span><span class="sxs-lookup"><span data-stu-id="80ae1-122">You will now see a list of all regions where your API Management service is provisioned.</span></span> <span data-ttu-id="80ae1-123">為每個區域選取 VNET 和子網路。</span><span class="sxs-lookup"><span data-stu-id="80ae1-123">Select a VNET and subnet for every region.</span></span> <span data-ttu-id="80ae1-124">hello 清單會填入傳統和資源管理員會安裝在您要設定的 hello 地區您 Azure 訂用帳戶中可用的虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="80ae1-124">hello list is populated with both classic and Resource Manager virtual networks available in your Azure subscriptions that are setup in hello region you are configuring.</span></span>

> [!NOTE]
> <span data-ttu-id="80ae1-125">**服務端點**hello 上面圖表中包含閘道/Proxy、 發行者入口網站、 開發人員入口網站、 GIT、 和 hello 直接管理端點。</span><span class="sxs-lookup"><span data-stu-id="80ae1-125">**Service Endpoint** in hello above diagram includes Gateway/Proxy, Publisher Portal, Developer Portal, GIT, and hello Direct Management Endpoint.</span></span>
> <span data-ttu-id="80ae1-126">**管理端點**hello 上面圖表中是透過 Azure 入口網站和 Powershell hello 服務 toomanage 組態上所裝載的 hello 端點。</span><span class="sxs-lookup"><span data-stu-id="80ae1-126">**Management Endpoint** in hello above diagram is hello endpoint hosted on hello service toomanage configuration via Azure portal and Powershell.</span></span>
> <span data-ttu-id="80ae1-127">另請注意，，，即使 hello 圖表顯示其各種端點的 API 管理服務的 IP 位址**只**回應其設定的主機名稱。</span><span class="sxs-lookup"><span data-stu-id="80ae1-127">Also, note, that, even though, hello diagram shows IP Addresses for its various endpoints, API Management service **only** responds on its configured Hostnames.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="80ae1-128">在部署 Azure API 管理執行個體 tooa 資源管理員的 VNET，hello 服務必須是不包含 Azure API 管理執行個體以外的任何其他資源的專用子網路。</span><span class="sxs-lookup"><span data-stu-id="80ae1-128">When deploying an Azure API Management instance tooa Resource Manager VNET, hello service must be in a dedicated subnet that contains no other resources except for Azure API Management instances.</span></span> <span data-ttu-id="80ae1-129">如果嘗試 toodeploy Azure API 管理執行個體 tooa 資源管理員 VNET 子網路，其中包含其他資源，hello 部署將會失敗。</span><span class="sxs-lookup"><span data-stu-id="80ae1-129">If an attempt is made toodeploy an Azure API Management instance tooa Resource Manager VNET subnet that contains other resources, hello deployment will fail.</span></span>
>
>

![選取 VPN][api-management-setup-vpn-select]

<span data-ttu-id="80ae1-131">按一下**儲存**頂端 hello 囉 」 畫面。</span><span class="sxs-lookup"><span data-stu-id="80ae1-131">Click **Save** at hello top of hello screen.</span></span>

> [!NOTE]
> <span data-ttu-id="80ae1-132">hello hello API 管理執行個體的 VIP 位址將會變更每個 VNET 已啟用或停用的時間。</span><span class="sxs-lookup"><span data-stu-id="80ae1-132">hello VIP address of hello API Management instance will change each time VNET is enabled or disabled.</span></span>  
> <span data-ttu-id="80ae1-133">API 管理從移動時，也會變更 hello VIP 位址**外部**太**內部**或反之亦然</span><span class="sxs-lookup"><span data-stu-id="80ae1-133">hello VIP address will also change when API Management is moved from **External** too**Internal** or vice-versa</span></span>
>


> [!IMPORTANT]
> <span data-ttu-id="80ae1-134">如果您移除 VNET 中的 API 管理，或變更其中一個部署中的 hello，hello 先前使用過的 VNET，可以保持鎖定 too4 時數。</span><span class="sxs-lookup"><span data-stu-id="80ae1-134">If you remove API Management from a VNET or change hello one it is deployed in, hello previously used VNET can remain locked for up too4 hours.</span></span> <span data-ttu-id="80ae1-135">在這段期間將不會是可能 toodelete hello VNET 或部署新的資源 tooit。</span><span class="sxs-lookup"><span data-stu-id="80ae1-135">During this period it will not be possible toodelete hello VNET or deploy a new resource tooit.</span></span>

## <span data-ttu-id="80ae1-136"><a name="enable-vnet-powershell"> </a>使用 PowerShell cmdlet 來啟用 VNET 連線</span><span class="sxs-lookup"><span data-stu-id="80ae1-136"><a name="enable-vnet-powershell"> </a>Enable VNET connection using PowerShell cmdlets</span></span>
<span data-ttu-id="80ae1-137">您也可以啟用使用 hello PowerShell cmdlet 的 VNET 連線</span><span class="sxs-lookup"><span data-stu-id="80ae1-137">You can also enable VNET connectivity using hello PowerShell cmdlets</span></span>

* <span data-ttu-id="80ae1-138">**建立 API 管理服務內 VNET**： 使用 hello cmdlet[新增 AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) toocreate VNET 內的 Azure API 管理服務。</span><span class="sxs-lookup"><span data-stu-id="80ae1-138">**Create an API Management service inside a VNET**: Use hello cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) toocreate an Azure API Management service inside a VNET.</span></span>

* <span data-ttu-id="80ae1-139">**部署在 VNET 內現有的 API 管理服務**： 使用 hello cmdlet[更新 AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) toomove 虛擬網路內現有的 Azure API 管理服務。</span><span class="sxs-lookup"><span data-stu-id="80ae1-139">**Deploy an existing API Management service inside a VNET**: Use hello cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) toomove an existing Azure API Management service inside a Virtual Network.</span></span>

## <span data-ttu-id="80ae1-140"><a name="connect-vnet"></a>Tooa web 服務裝載於虛擬網路連接</span><span class="sxs-lookup"><span data-stu-id="80ae1-140"><a name="connect-vnet"> </a>Connect tooa web service hosted within a virtual Network</span></span>
<span data-ttu-id="80ae1-141">API 管理服務連線的 toohello VNET 後，存取在其中的後端服務並無不同存取公用服務。</span><span class="sxs-lookup"><span data-stu-id="80ae1-141">After your API Management service is connected toohello VNET, accessing backend services within it is no different than accessing public services.</span></span> <span data-ttu-id="80ae1-142">只要輸入 hello 本機 IP 位址或 hello 主機名稱 （如果 DNS 伺服器設定為 hello VNET） 您的 web 服務中 hello **Web 服務 URL**欄位建立新的應用程式開發介面時，或編輯現有的 fgpp。</span><span class="sxs-lookup"><span data-stu-id="80ae1-142">Just type in hello local IP address or hello host name (if a DNS server is configured for hello VNET) of your web service into hello **Web service URL** field when creating a new API or editing an existing one.</span></span>

![透過 VPN 加入 API][api-management-setup-vpn-add-api]

## <span data-ttu-id="80ae1-144"><a name="network-configuration-issues"> </a>常見的網路組態問題</span><span class="sxs-lookup"><span data-stu-id="80ae1-144"><a name="network-configuration-issues"> </a>Common Network Configuration Issues</span></span>
<span data-ttu-id="80ae1-145">以下是將 API 管理服務部署到虛擬網路時可能發生的常見錯誤設定問題清單。</span><span class="sxs-lookup"><span data-stu-id="80ae1-145">Following is a list of common misconfiguration issues that can occur while deploying API Management service into a Virtual Network.</span></span>

* <span data-ttu-id="80ae1-146">**自訂的 DNS 伺服器安裝**: hello 的 API 管理服務取決於數個 Azure 服務。</span><span class="sxs-lookup"><span data-stu-id="80ae1-146">**Custom DNS server setup**: hello API Management service depends on several Azure services.</span></span> <span data-ttu-id="80ae1-147">API 管理裝載在自訂的 DNS 伺服器的 VNET，當需要這些 Azure 服務 tooresolve hello 主機名稱。</span><span class="sxs-lookup"><span data-stu-id="80ae1-147">When API Management is hosted in a VNET with a custom DNS server, it needs tooresolve hello hostnames of those Azure services.</span></span> <span data-ttu-id="80ae1-148">請遵循 [這份](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) 有關自訂 DNS 設定的指引。</span><span class="sxs-lookup"><span data-stu-id="80ae1-148">Please follow [this](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guidance on custom DNS setup.</span></span> <span data-ttu-id="80ae1-149">請參閱表的 hello 連接埠及其他參考的網路需求。</span><span class="sxs-lookup"><span data-stu-id="80ae1-149">See hello ports table below and other network requirements for reference.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="80ae1-150">我們建議您，如果您使用自訂 DNS 伺服器 hello VNET，您將設定的**之前**部署到其中的 API 管理服務。</span><span class="sxs-lookup"><span data-stu-id="80ae1-150">It is recommended that, if you are using a Custom DNS Server(s) for hello VNET, you set that up **before** deploying an API Management service into it.</span></span> <span data-ttu-id="80ae1-151">否則您需要太 hello API 管理服務每次變更 hello DNS 伺服器 (s) 執行更新 hello[套用網路組態設定作業](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span><span class="sxs-lookup"><span data-stu-id="80ae1-151">Otherwise you need too update hello API Management service each time you change hello DNS Servers(s) by running hello [Apply Network Configuration Operation](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span></span>

* <span data-ttu-id="80ae1-152">**API 管理所需的連接埠**： 輸入與輸出流量至 API 管理以部署的 hello 子網路可以使用控制[網路安全性群組][Network Security Group]。</span><span class="sxs-lookup"><span data-stu-id="80ae1-152">**Ports required for API Management**: Inbound and Outbound traffic into hello Subnet in which API Management is deployed can be controlled using [Network Security Group][Network Security Group].</span></span> <span data-ttu-id="80ae1-153">如果這些連接埠中有任何一個無法使用，「API 管理」可能就無法正常運作而可能變成無法存取。</span><span class="sxs-lookup"><span data-stu-id="80ae1-153">If any of these ports are unavailable, API Management may not operate properly and may become inaccessible.</span></span> <span data-ttu-id="80ae1-154">搭配 VNET 使用 API 管理時，封鎖這其中一或多個連接埠是另一個常見的錯誤組態問題。</span><span class="sxs-lookup"><span data-stu-id="80ae1-154">Having one or more of these ports blocked is another common misconfiguration issue when using API Management with a VNET.</span></span>

<span data-ttu-id="80ae1-155">API 管理服務執行個體裝載在 VNET 中，會使用 hello hello 下表中的連接埠。</span><span class="sxs-lookup"><span data-stu-id="80ae1-155">When an API Management service instance is hosted in a VNET, hello ports in hello following table are used.</span></span>

| <span data-ttu-id="80ae1-156">來源 / 目的地連接埠</span><span class="sxs-lookup"><span data-stu-id="80ae1-156">Source / Destination Port(s)</span></span> | <span data-ttu-id="80ae1-157">方向</span><span class="sxs-lookup"><span data-stu-id="80ae1-157">Direction</span></span> | <span data-ttu-id="80ae1-158">傳輸通訊協定</span><span class="sxs-lookup"><span data-stu-id="80ae1-158">Transport protocol</span></span> | <span data-ttu-id="80ae1-159">目的</span><span class="sxs-lookup"><span data-stu-id="80ae1-159">Purpose</span></span> | <span data-ttu-id="80ae1-160">來源 / 目的地</span><span class="sxs-lookup"><span data-stu-id="80ae1-160">Source / Destination</span></span> | <span data-ttu-id="80ae1-161">存取類型</span><span class="sxs-lookup"><span data-stu-id="80ae1-161">Access type</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="80ae1-162">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="80ae1-162">* / 80, 443</span></span> |<span data-ttu-id="80ae1-163">輸入</span><span class="sxs-lookup"><span data-stu-id="80ae1-163">Inbound</span></span> |<span data-ttu-id="80ae1-164">TCP</span><span class="sxs-lookup"><span data-stu-id="80ae1-164">TCP</span></span> |<span data-ttu-id="80ae1-165">用戶端通訊 tooAPI 管理</span><span class="sxs-lookup"><span data-stu-id="80ae1-165">Client communication tooAPI Management</span></span> |<span data-ttu-id="80ae1-166">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="80ae1-166">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="80ae1-167">外部</span><span class="sxs-lookup"><span data-stu-id="80ae1-167">External</span></span> |
| <span data-ttu-id="80ae1-168">* / 3443</span><span class="sxs-lookup"><span data-stu-id="80ae1-168">* / 3443</span></span> |<span data-ttu-id="80ae1-169">輸入</span><span class="sxs-lookup"><span data-stu-id="80ae1-169">Inbound</span></span> |<span data-ttu-id="80ae1-170">TCP</span><span class="sxs-lookup"><span data-stu-id="80ae1-170">TCP</span></span> |<span data-ttu-id="80ae1-171">Azure 入口網站和 PowerShell 的管理端點</span><span class="sxs-lookup"><span data-stu-id="80ae1-171">Management endpoint for Azure portal and Powershell</span></span> |<span data-ttu-id="80ae1-172">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="80ae1-172">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="80ae1-173">外部和內部</span><span class="sxs-lookup"><span data-stu-id="80ae1-173">External & Internal</span></span> |
| <span data-ttu-id="80ae1-174">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="80ae1-174">* / 80, 443</span></span> |<span data-ttu-id="80ae1-175">輸出</span><span class="sxs-lookup"><span data-stu-id="80ae1-175">Outbound</span></span> |<span data-ttu-id="80ae1-176">TCP</span><span class="sxs-lookup"><span data-stu-id="80ae1-176">TCP</span></span> |<span data-ttu-id="80ae1-177">與「Azure 儲存體」和「Azure 服務匯流排」的相依性</span><span class="sxs-lookup"><span data-stu-id="80ae1-177">Dependency on Azure Storage and Azure Service Bus</span></span> |<span data-ttu-id="80ae1-178">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="80ae1-178">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="80ae1-179">外部和內部</span><span class="sxs-lookup"><span data-stu-id="80ae1-179">External & Internal</span></span> |
| <span data-ttu-id="80ae1-180">* / 1433</span><span class="sxs-lookup"><span data-stu-id="80ae1-180">* / 1433</span></span> |<span data-ttu-id="80ae1-181">輸出</span><span class="sxs-lookup"><span data-stu-id="80ae1-181">Outbound</span></span> |<span data-ttu-id="80ae1-182">TCP</span><span class="sxs-lookup"><span data-stu-id="80ae1-182">TCP</span></span> |<span data-ttu-id="80ae1-183">與 Azure SQL 的相依性</span><span class="sxs-lookup"><span data-stu-id="80ae1-183">Dependency on Azure SQL</span></span> |<span data-ttu-id="80ae1-184">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="80ae1-184">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="80ae1-185">外部和內部</span><span class="sxs-lookup"><span data-stu-id="80ae1-185">External & Internal</span></span> |
| <span data-ttu-id="80ae1-186">* / 11000 - 11999</span><span class="sxs-lookup"><span data-stu-id="80ae1-186">* / 11000 - 11999</span></span> |<span data-ttu-id="80ae1-187">輸出</span><span class="sxs-lookup"><span data-stu-id="80ae1-187">Outbound</span></span> |<span data-ttu-id="80ae1-188">TCP</span><span class="sxs-lookup"><span data-stu-id="80ae1-188">TCP</span></span> |<span data-ttu-id="80ae1-189">與 Azure SQL V12 的相依性</span><span class="sxs-lookup"><span data-stu-id="80ae1-189">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="80ae1-190">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="80ae1-190">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="80ae1-191">外部和內部</span><span class="sxs-lookup"><span data-stu-id="80ae1-191">External & Internal</span></span> |
| <span data-ttu-id="80ae1-192">* / 14000 - 14999</span><span class="sxs-lookup"><span data-stu-id="80ae1-192">* / 14000 - 14999</span></span> |<span data-ttu-id="80ae1-193">輸出</span><span class="sxs-lookup"><span data-stu-id="80ae1-193">Outbound</span></span> |<span data-ttu-id="80ae1-194">TCP</span><span class="sxs-lookup"><span data-stu-id="80ae1-194">TCP</span></span> |<span data-ttu-id="80ae1-195">與 Azure SQL V12 的相依性</span><span class="sxs-lookup"><span data-stu-id="80ae1-195">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="80ae1-196">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="80ae1-196">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="80ae1-197">外部和內部</span><span class="sxs-lookup"><span data-stu-id="80ae1-197">External & Internal</span></span> |
| <span data-ttu-id="80ae1-198">* / 5671</span><span class="sxs-lookup"><span data-stu-id="80ae1-198">* / 5671</span></span> |<span data-ttu-id="80ae1-199">輸出</span><span class="sxs-lookup"><span data-stu-id="80ae1-199">Outbound</span></span> |<span data-ttu-id="80ae1-200">AMQP</span><span class="sxs-lookup"><span data-stu-id="80ae1-200">AMQP</span></span> |<span data-ttu-id="80ae1-201">記錄 tooEvent 中樞原則和監視的代理程式的相依性</span><span class="sxs-lookup"><span data-stu-id="80ae1-201">Dependency for Log tooEvent Hub policy and monitoring agent</span></span> |<span data-ttu-id="80ae1-202">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="80ae1-202">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="80ae1-203">外部和內部</span><span class="sxs-lookup"><span data-stu-id="80ae1-203">External & Internal</span></span> |
| <span data-ttu-id="80ae1-204">6381 - 6383 / 6381 - 6383</span><span class="sxs-lookup"><span data-stu-id="80ae1-204">6381 - 6383 / 6381 - 6383</span></span> |<span data-ttu-id="80ae1-205">輸入和輸出</span><span class="sxs-lookup"><span data-stu-id="80ae1-205">Inbound & Outbound</span></span> |<span data-ttu-id="80ae1-206">UDP</span><span class="sxs-lookup"><span data-stu-id="80ae1-206">UDP</span></span> |<span data-ttu-id="80ae1-207">與「Redis 快取」的相依性</span><span class="sxs-lookup"><span data-stu-id="80ae1-207">Dependency on Redis Cache</span></span> |<span data-ttu-id="80ae1-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="80ae1-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="80ae1-209">外部和內部</span><span class="sxs-lookup"><span data-stu-id="80ae1-209">External & Internal</span></span> |-
| <span data-ttu-id="80ae1-210">* / 445</span><span class="sxs-lookup"><span data-stu-id="80ae1-210">* / 445</span></span> |<span data-ttu-id="80ae1-211">輸出</span><span class="sxs-lookup"><span data-stu-id="80ae1-211">Outbound</span></span> |<span data-ttu-id="80ae1-212">TCP</span><span class="sxs-lookup"><span data-stu-id="80ae1-212">TCP</span></span> |<span data-ttu-id="80ae1-213">與「適用於 GIT 的 Azure 檔案共用」的相依性</span><span class="sxs-lookup"><span data-stu-id="80ae1-213">Dependency on Azure File Share for GIT</span></span> |<span data-ttu-id="80ae1-214">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="80ae1-214">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="80ae1-215">外部和內部</span><span class="sxs-lookup"><span data-stu-id="80ae1-215">External & Internal</span></span> |
| <span data-ttu-id="80ae1-216">* / *</span><span class="sxs-lookup"><span data-stu-id="80ae1-216">* / *</span></span> | <span data-ttu-id="80ae1-217">輸入</span><span class="sxs-lookup"><span data-stu-id="80ae1-217">Inbound</span></span> |<span data-ttu-id="80ae1-218">TCP</span><span class="sxs-lookup"><span data-stu-id="80ae1-218">TCP</span></span> |<span data-ttu-id="80ae1-219">Azure 基礎結構負載平衡器</span><span class="sxs-lookup"><span data-stu-id="80ae1-219">Azure Infrastructure Load Balancer</span></span> | <span data-ttu-id="80ae1-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="80ae1-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="80ae1-221">外部和內部</span><span class="sxs-lookup"><span data-stu-id="80ae1-221">External & Internal</span></span> |

* <span data-ttu-id="80ae1-222">**SSL 功能**： 鏈結建立和驗證 hello API 管理服務需要輸出網路連線 tooocsp.msocsp.com、 mscrl.microsoft.com 以及 crl.microsoft.com tooenable SSL 憑證。如果您上傳 tooAPI 管理任何憑證包含 hello 完整鏈結 toohello CA 根，則不需要，此相依性。</span><span class="sxs-lookup"><span data-stu-id="80ae1-222">**SSL functionality**: tooenable SSL certificate chain building and validation hello API Management service needs Outbound network connectivity tooocsp.msocsp.com, mscrl.microsoft.com and crl.microsoft.com. This dependency is not required, if any certificate you upload tooAPI Management contain hello full chain toohello CA root.</span></span>

* <span data-ttu-id="80ae1-223">**DNS 存取**：需要有連接埠 53 的輸出存取，才能與 DNS 伺服器通訊。</span><span class="sxs-lookup"><span data-stu-id="80ae1-223">**DNS Access**: Outbound access on port 53 is required for communication with DNS servers.</span></span> <span data-ttu-id="80ae1-224">如果自訂的 DNS 伺服器上有 hello 另一端的 VPN 閘道，hello DNS 伺服器必須是裝載 API 管理的 hello 子網路觸達。</span><span class="sxs-lookup"><span data-stu-id="80ae1-224">If a custom DNS server exists on hello other end of a VPN gateway, hello DNS server must be reachable from hello subnet hosting API Management.</span></span>

* <span data-ttu-id="80ae1-225">**度量和健全狀況監視**： 輸出網路連線 tooAzure 監視端點，但在 hello 下列網域解析： global.metrics.nsatc.net、 shoebox2.metrics.nsatc.net、 prod3.metrics.nsatc.net。</span><span class="sxs-lookup"><span data-stu-id="80ae1-225">**Metrics and Health Monitoring**: Outbound network connectivity tooAzure Monitoring endpoints, which resolve under hello following domains: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span></span>

* <span data-ttu-id="80ae1-226">**快速路由安裝**： 常見的客戶設定是 toodefine 強制傳出網際網路流量 tooinstead 資料流程在內部自己預設路由 (0.0.0.0/0)。</span><span class="sxs-lookup"><span data-stu-id="80ae1-226">**Express Route Setup**: A common customer configuration is toodefine their own default route (0.0.0.0/0) which forces outbound Internet traffic tooinstead flow on-premises.</span></span> <span data-ttu-id="80ae1-227">此流量必定中斷連線，使用 Azure API 管理，因為 hello 傳出流量會被封鎖在內部，或 NAT 的 tooan 無法辨識無法再使用不同的 Azure 端點的位址集。</span><span class="sxs-lookup"><span data-stu-id="80ae1-227">This traffic flow invariably breaks connectivity with Azure API Management because hello outbound traffic is either blocked on-premises, or NAT'd tooan unrecognizable set of addresses that no longer work with various Azure endpoints.</span></span> <span data-ttu-id="80ae1-228">hello 解決方案是 toodefine 一個 （或更多） 使用者定義的路由 ([UDRs][UDRs]) 包含 hello Azure API 管理的 hello 子網路上。</span><span class="sxs-lookup"><span data-stu-id="80ae1-228">hello solution is toodefine one (or more) user-defined routes ([UDRs][UDRs]) on hello subnet that contains hello Azure API Management.</span></span> <span data-ttu-id="80ae1-229">UDR 定義特定子網路的路由，則會採用而不是 hello 預設路由。</span><span class="sxs-lookup"><span data-stu-id="80ae1-229">A UDR defines subnet-specific routes that will be honored instead of hello default route.</span></span>
  <span data-ttu-id="80ae1-230">可能的話，我們建議下列組態 toouse hello:</span><span class="sxs-lookup"><span data-stu-id="80ae1-230">If possible, it is recommended toouse hello following configuration:</span></span>
 * <span data-ttu-id="80ae1-231">hello ExpressRoute 組態通告 0.0.0.0/0，並依預設強制通道連接所有輸出流量的內部。</span><span class="sxs-lookup"><span data-stu-id="80ae1-231">hello ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span></span>
 * <span data-ttu-id="80ae1-232">包含 hello Azure API 管理的 hello UDR 套用 toohello 子網路都會定義 0.0.0.0/0 與網際網路的下一個躍點類型。</span><span class="sxs-lookup"><span data-stu-id="80ae1-232">hello UDR applied toohello subnet containing hello Azure API Management defines 0.0.0.0/0 with a next hop type of Internet.</span></span>
 <span data-ttu-id="80ae1-233">hello 聯合的影響這些步驟是，hello 子網路層級 UDR 優先於 hello ExpressRoute 強制通道，以確保從 hello Azure API 管理的對外網際網路存取。</span><span class="sxs-lookup"><span data-stu-id="80ae1-233">hello combined effect of these steps is that hello subnet level UDR takes precedence over hello ExpressRoute forced tunneling, thus ensuring outbound Internet access from hello Azure API Management.</span></span>

>[!WARNING]  
><span data-ttu-id="80ae1-234">Azure API 管理不支援使用 ExpressRoute 組態，**不正確地跨通告 hello 公用互連路徑 toohello 私用對等互連路徑路由**。</span><span class="sxs-lookup"><span data-stu-id="80ae1-234">Azure API Management is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from hello public peering path toohello private peering path**.</span></span> <span data-ttu-id="80ae1-235">已設定公用對等互連的 ExpressRoute 組態，會收到來自 Microsoft 的一大組 Microsoft Azure IP 位址範圍的路由通告。</span><span class="sxs-lookup"><span data-stu-id="80ae1-235">ExpressRoute configurations that have public peering configured, will receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="80ae1-236">如果這些位址範圍不正確地跨通告 hello 私用對等互連路徑上，hello 最終結果是從 hello Azure API 管理執行個體的子網路的所有輸出網路封包會不正確地使用強制通道 tooa 客戶的內部部署網路基礎結構。</span><span class="sxs-lookup"><span data-stu-id="80ae1-236">If these address ranges are incorrectly cross-advertised on hello private peering path, hello end result is that all outbound network packets from hello Azure API Management instance's subnet are incorrectly force-tunneled tooa customer's on-premises network infrastructure.</span></span> <span data-ttu-id="80ae1-237">這個網路流量會中斷 Azure API 管理。</span><span class="sxs-lookup"><span data-stu-id="80ae1-237">This network flow breaks Azure API Management.</span></span> <span data-ttu-id="80ae1-238">hello 方案 toothis 問題是 toostop 跨廣告 hello 公用互連路徑 toohello 私用對等互連路徑路由。</span><span class="sxs-lookup"><span data-stu-id="80ae1-238">hello solution toothis problem is toostop cross-advertising routes from hello public peering path toohello private peering path.</span></span>


## <span data-ttu-id="80ae1-239"><a name="troubleshooting"></a>疑難排解</span><span class="sxs-lookup"><span data-stu-id="80ae1-239"><a name="troubleshooting"> </a>Troubleshooting</span></span>
<span data-ttu-id="80ae1-240">變更 tooyour 網路時，請參閱太[NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus)，toovalidate 如果 hello API 管理服務未中斷的 hello 存取 tooany 重要的資源，其定義取決於它。</span><span class="sxs-lookup"><span data-stu-id="80ae1-240">When making changes tooyour network, refer too[NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), toovalidate if hello API Management service has not lost access tooany of hello critical resources which it depends upon.</span></span> <span data-ttu-id="80ae1-241">應該每隔 15 分鐘更新 hello 連線狀態。</span><span class="sxs-lookup"><span data-stu-id="80ae1-241">hello connectivity status should be updated every 15 minutes.</span></span>

## <span data-ttu-id="80ae1-242"><a name="limitations"> </a>限制</span><span class="sxs-lookup"><span data-stu-id="80ae1-242"><a name="limitations"> </a>Limitations</span></span>
* <span data-ttu-id="80ae1-243">包含「API 管理」執行個體的子網路無法包含任何其他 Azure 資源類型。</span><span class="sxs-lookup"><span data-stu-id="80ae1-243">A subnet containing API Management instances cannot contain any other Azure resource types.</span></span>
* <span data-ttu-id="80ae1-244">hello 子網路和 hello API 管理服務必須在 hello 相同訂用帳戶。</span><span class="sxs-lookup"><span data-stu-id="80ae1-244">hello subnet and hello API Management service must be in hello same subscription.</span></span>
* <span data-ttu-id="80ae1-245">包含「API 管理」執行個體的子網路無法跨訂用帳戶移動。</span><span class="sxs-lookup"><span data-stu-id="80ae1-245">A subnet containing API Management instances cannot be moved across subscriptions.</span></span>
* <span data-ttu-id="80ae1-246">當使用內部虛擬網路，就可以從內部 IP 位址僅 hello 範圍中所述[RFC 1918](https://tools.ietf.org/html/rfc1918)，無法提供的公用 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="80ae1-246">When using an internal virtual network, only an internal IP address will be available from hello range stated in [RFC 1918](https://tools.ietf.org/html/rfc1918), a public IP address cannot be provided.</span></span>
* <span data-ttu-id="80ae1-247">多區域 API 管理部署中，與內部虛擬網路設定，使用者必須負責管理他們自己的負載平衡它們擁有 hello DNS。</span><span class="sxs-lookup"><span data-stu-id="80ae1-247">For multi-region API Management deployments, with Internal virtual networks configured, users are responsible for managing their own load balancing as they own hello DNS.</span></span>


## <span data-ttu-id="80ae1-248"><a name="related-content"> </a>相關內容</span><span class="sxs-lookup"><span data-stu-id="80ae1-248"><a name="related-content"> </a>Related content</span></span>
* [<span data-ttu-id="80ae1-249">連接虛擬網路 toobackend 使用 Vpn 閘道</span><span class="sxs-lookup"><span data-stu-id="80ae1-249">Connecting a Virtual Network toobackend using Vpn Gateway</span></span>](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [<span data-ttu-id="80ae1-250">從不同的部署模型連接虛擬網路</span><span class="sxs-lookup"><span data-stu-id="80ae1-250">Connecting a Virtual Network from different deployment models</span></span>](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [<span data-ttu-id="80ae1-251">Toouse hello API Inspector tootrace 如何呼叫在 Azure API 管理</span><span class="sxs-lookup"><span data-stu-id="80ae1-251">How toouse hello API Inspector tootrace calls in Azure API Management</span></span>](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect tooa web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md
