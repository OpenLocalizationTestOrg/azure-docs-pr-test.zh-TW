---
title: "aaaJSON 輸出資料流分析 |Microsoft 文件"
description: "了解「串流分析」如何將 Azure Cosmos DB 設定為 JSON 輸出的目標，以針對非結構化 JSON 資料進行資料封存和低延遲查詢。"
keywords: "JSON 輸出"
documentationcenter: 
services: stream-analytics,documentdb
author: samacha
manager: jhubbard
editor: cgronlun
ms.assetid: 5d2a61a6-0dbf-4f1b-80af-60a80eb25dd1
ms.service: stream-analytics
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: data-services
ms.date: 03/28/2017
ms.author: samacha
ms.openlocfilehash: fa717818c839ecd7a60fcee33d22011990fd5878
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="target-azure-cosmos-db-for-json-output-from-stream-analytics"></a><span data-ttu-id="a6747-104">將 Azure Cosmos DB 設定為串流分析的 JSON 輸出目標</span><span class="sxs-lookup"><span data-stu-id="a6747-104">Target Azure Cosmos DB for JSON output from Stream Analytics</span></span>
<span data-ttu-id="a6747-105">「串流分析」可以將 [Azure Cosmos DB](https://azure.microsoft.com/services/documentdb/) 設定為 JSON 輸出的目標，讓您能夠針對非結構化的 JSON 資料進行資料封存和低延遲查詢。</span><span class="sxs-lookup"><span data-stu-id="a6747-105">Stream Analytics can target [Azure Cosmos DB](https://azure.microsoft.com/services/documentdb/) for JSON output, enabling data archiving and low-latency queries on unstructured JSON data.</span></span> <span data-ttu-id="a6747-106">本文件涵蓋實作這種組態的一些最佳作法。</span><span class="sxs-lookup"><span data-stu-id="a6747-106">This document covers some best practices for implementing this configuration.</span></span>

<span data-ttu-id="a6747-107">對於熟悉 Cosmos DB，看看[Azure Cosmos DB 的學習路徑](https://azure.microsoft.com/documentation/learning-paths/documentdb/)tooget 啟動。</span><span class="sxs-lookup"><span data-stu-id="a6747-107">For those who are unfamiliar with Cosmos DB, take a look at [Azure Cosmos DB’s learning path](https://azure.microsoft.com/documentation/learning-paths/documentdb/) tooget started.</span></span> 

<span data-ttu-id="a6747-108">注意：目前不支援 Mongo DB API 架構的 Cosmos DB 集合。</span><span class="sxs-lookup"><span data-stu-id="a6747-108">Note: Mongo DB API based Cosmos DB collections is currently not supported.</span></span> 

## <a name="basics-of-cosmos-db-as-an-output-target"></a><span data-ttu-id="a6747-109">將 Cosmos DB 設定為輸出目標的基本概念</span><span class="sxs-lookup"><span data-stu-id="a6747-109">Basics of Cosmos DB as an output target</span></span>
<span data-ttu-id="a6747-110">hello Azure Cosmos DB 輸出資料流分析可讓您處理結果，作為 JSON 輸出 Cosmos DB 清查到的資料流寫入。</span><span class="sxs-lookup"><span data-stu-id="a6747-110">hello Azure Cosmos DB output in Stream Analytics enables writing your stream processing results as JSON output into your Cosmos DB collection(s).</span></span> <span data-ttu-id="a6747-111">資料流分析不會建立集合在資料庫中，而需要 toocreate 預先它們。</span><span class="sxs-lookup"><span data-stu-id="a6747-111">Stream Analytics does not create collections in your database, instead requiring you toocreate them upfront.</span></span> <span data-ttu-id="a6747-112">這是使 hello 計費成本 Cosmos DB 集合被透明 tooyou，和一致性，直接使用集合的容量，讓您可以微調 hello 效能，hello [Cosmos DB Api](https://msdn.microsoft.com/library/azure/dn781481.aspx)。</span><span class="sxs-lookup"><span data-stu-id="a6747-112">This is so that hello billing costs of Cosmos DB collections are transparent tooyou, and so that you can tune hello performance, consistency and capacity of your collections directly using hello [Cosmos DB APIs](https://msdn.microsoft.com/library/azure/dn781481.aspx).</span></span> <span data-ttu-id="a6747-113">我們建議使用每個資料流工作 toologically 單獨一個 Cosmos DB 資料庫的資料流工作集合。</span><span class="sxs-lookup"><span data-stu-id="a6747-113">We recommend using one Cosmos DB Database per streaming job toologically separate your collections for a streaming job.</span></span>

<span data-ttu-id="a6747-114">部分 hello Cosmos DB 集合選項如下所述。</span><span class="sxs-lookup"><span data-stu-id="a6747-114">Some of hello Cosmos DB collection options are detailed below.</span></span>

## <a name="tune-consistency-availability-and-latency"></a><span data-ttu-id="a6747-115">微調一致性、 可用性及延遲</span><span class="sxs-lookup"><span data-stu-id="a6747-115">Tune consistency, availability, and latency</span></span>
<span data-ttu-id="a6747-116">toomatch 應用程式的需求，Cosmos DB 可讓您 toofine 微調 hello 資料庫、 集合和請之間的利弊得失一致性、 可用性和延遲。</span><span class="sxs-lookup"><span data-stu-id="a6747-116">toomatch your application requirements, Cosmos DB allows you toofine tune hello database and collections and make trade-offs between consistency, availability and latency.</span></span> <span data-ttu-id="a6747-117">您可以視案例針對讀取與寫入延遲所需的讀取一致性層級，來選擇資料庫帳戶上的一致性層級。</span><span class="sxs-lookup"><span data-stu-id="a6747-117">Depending on what levels of read consistency your scenario needs against read and write latency, you can choose a consistency level on your database account.</span></span> <span data-ttu-id="a6747-118">也根據預設，Cosmos DB 可讓每個 CRUD 作業 tooyour 集合上的索引同步。</span><span class="sxs-lookup"><span data-stu-id="a6747-118">Also by default, Cosmos DB enables synchronous indexing on each CRUD operation tooyour collection.</span></span> <span data-ttu-id="a6747-119">這是另一個有用的選項 toocontrol hello 寫入/讀取 Cosmos DB 中的效能。</span><span class="sxs-lookup"><span data-stu-id="a6747-119">This is another useful option toocontrol hello write/read performance in Cosmos DB.</span></span> <span data-ttu-id="a6747-120">如需本主題的詳細資訊，請檢閱 hello[變更資料庫，然後查詢一致性層級](../documentdb/documentdb-consistency-levels.md)發行項。</span><span class="sxs-lookup"><span data-stu-id="a6747-120">For further information on this topic, review hello [change your database and query consistency levels](../documentdb/documentdb-consistency-levels.md) article.</span></span>

## <a name="upserts-from-stream-analytics"></a><span data-ttu-id="a6747-121">來自串流分析的 Upsert</span><span class="sxs-lookup"><span data-stu-id="a6747-121">Upserts from Stream Analytics</span></span>
<span data-ttu-id="a6747-122">以 Cosmos DB 的資料流分析整合可讓您 tooinsert 或更新記錄 Cosmos DB 集合根據指定的文件識別碼資料行中。</span><span class="sxs-lookup"><span data-stu-id="a6747-122">Stream Analytics integration with Cosmos DB allows you tooinsert or update records in your Cosmos DB collection based on a given Document ID column.</span></span> <span data-ttu-id="a6747-123">這也是參考的 tooas *Upsert*。</span><span class="sxs-lookup"><span data-stu-id="a6747-123">This is also referred tooas an *Upsert*.</span></span>

<span data-ttu-id="a6747-124">資料流分析會利用開放式 Upsert 做法，更新會只因為 tooa 文件識別碼衝突的插入失敗時。</span><span class="sxs-lookup"><span data-stu-id="a6747-124">Stream Analytics utilizes an optimistic Upsert approach, where updates are only done when insert fails due tooa Document ID conflict.</span></span> <span data-ttu-id="a6747-125">此更新是由執行資料流分析為修補程式時，所以它可以讓部分更新 toohello 文件，也就是加上新的屬性或取代現有的屬性會以累加方式執行。</span><span class="sxs-lookup"><span data-stu-id="a6747-125">This update is performed by Stream Analytics as a PATCH, so it enables partial updates toohello document, i.e. addition of new properties or replacing an existing property is performed incrementally.</span></span> <span data-ttu-id="a6747-126">請注意，在 hello JSON 文件中的陣列內容值中的變更會導致 hello 整個陣列取得覆寫，也就是 hello 陣列不會進行合併。</span><span class="sxs-lookup"><span data-stu-id="a6747-126">Note that changes in hello values of array properties in your JSON document result in hello entire array getting overwritten, i.e. hello array is not merged.</span></span>

## <a name="data-partitioning-in-cosmos-db"></a><span data-ttu-id="a6747-127">Cosmos DB 中的資料分割</span><span class="sxs-lookup"><span data-stu-id="a6747-127">Data partitioning in Cosmos DB</span></span>
<span data-ttu-id="a6747-128">Cosmos DB[分割集合](../cosmos-db/partition-data.md)是建議的方法來將資料分割的 hello。</span><span class="sxs-lookup"><span data-stu-id="a6747-128">Cosmos DB [partitioned collections](../cosmos-db/partition-data.md) are hello recommended approach for partitioning your data.</span></span> 

<span data-ttu-id="a6747-129">對於單一 Cosmos DB 集合，串流分析仍可讓您 toopartition hello 查詢模式和應用程式的效能需求依據您的資料。</span><span class="sxs-lookup"><span data-stu-id="a6747-129">For single Cosmos DB collections, Stream Analytics still allows you toopartition your data based on both hello query patterns and performance needs of your application.</span></span> <span data-ttu-id="a6747-130">每個集合可能包含總 too10GB 的資料 （最大值），且目前沒有任何方式 tooscale 總 （或溢位） 集合。</span><span class="sxs-lookup"><span data-stu-id="a6747-130">Each collection may contain up too10GB of data (maximum) and currently there is no way tooscale up (or overflow) a collection.</span></span> <span data-ttu-id="a6747-131">向外延展，串流分析可讓您指定的前置詞 toowrite toomultiple 集合 （請參閱下方的使用方式詳細資料）。</span><span class="sxs-lookup"><span data-stu-id="a6747-131">For scaling out, Stream Analytics allows you toowrite toomultiple collections with a given prefix (see usage details below).</span></span> <span data-ttu-id="a6747-132">串流分析會一致 hello[雜湊資料分割的解析程式](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.partitioning.hashpartitionresolver.aspx)hello 使用者為基礎的策略提供 PartitionKey 資料行 toopartition 其輸出記錄。</span><span class="sxs-lookup"><span data-stu-id="a6747-132">Stream Analytics uses hello consistent [Hash Partition Resolver](https://msdn.microsoft.com/library/azure/microsoft.azure.documents.partitioning.hashpartitionresolver.aspx) strategy based on hello user provided PartitionKey column toopartition its output records.</span></span> <span data-ttu-id="a6747-133">hello 以 hello hello 串流工作的開始時間在指定前置詞的集合數目做 hello 輸出資料分割計數，toowhich hello 工作寫入 tooin 平行 (Cosmos DB 集合 = 輸出資料分割)。</span><span class="sxs-lookup"><span data-stu-id="a6747-133">hello number of collections with hello given prefix at hello streaming job’s start time is used as hello output partition count, toowhich hello job writes tooin parallel (Cosmos DB Collections = Output Partitions).</span></span> <span data-ttu-id="a6747-134">對於延遲索引只進行插入的單一集合，預期會有約每秒 0.4 MB 的寫入輸送量。</span><span class="sxs-lookup"><span data-stu-id="a6747-134">For a single collection with lazy indexing doing only inserts, about 0.4 MB/s write throughput can be expected.</span></span> <span data-ttu-id="a6747-135">使用多個集合，可以讓您 tooachieve 較高的輸送量和更高的容量。</span><span class="sxs-lookup"><span data-stu-id="a6747-135">Using multiple collections can allow you tooachieve higher throughput and increased capacity.</span></span>

<span data-ttu-id="a6747-136">如果您在未來的 hello 想 tooincrease hello 資料分割計數，您可能需要 toostop 您的工作，重新分割 hello 資料從現有的集合成新的集合，然後再重新啟動 hello 資料流分析工作。</span><span class="sxs-lookup"><span data-stu-id="a6747-136">If you intend tooincrease hello partition count in hello future, you may need toostop your job, repartition hello data from your existing collections into new collections and then restart hello Stream Analytics job.</span></span> <span data-ttu-id="a6747-137">有關使用 PartitionResolver 與重新分割的詳細資料，以及範例程式碼，都會包含在後續的文章中。</span><span class="sxs-lookup"><span data-stu-id="a6747-137">More details on using PartitionResolver and re-partitioning along with sample code, will be included in a follow-up post.</span></span> <span data-ttu-id="a6747-138">hello 文章[資料分割和 Cosmos DB 中的縮放比例](../documentdb/documentdb-partition-data.md)也提供此詳細資料。</span><span class="sxs-lookup"><span data-stu-id="a6747-138">hello article [Partitioning and scaling in Cosmos DB](../documentdb/documentdb-partition-data.md) also provides details on this.</span></span>

## <a name="cosmos-db-settings-for-json-output"></a><span data-ttu-id="a6747-139">適用於 JSON 輸出的 Cosmos DB 設定</span><span class="sxs-lookup"><span data-stu-id="a6747-139">Cosmos DB settings for JSON output</span></span>
<span data-ttu-id="a6747-140">如果在「串流分析」中建立 Cosmos DB 作為輸出，將會產生如以下所示的資訊提示。</span><span class="sxs-lookup"><span data-stu-id="a6747-140">Creating Cosmos DB as an output in Stream Analytics generates a prompt for information as seen below.</span></span> <span data-ttu-id="a6747-141">本節中的 hello 屬性定義的說明。</span><span class="sxs-lookup"><span data-stu-id="a6747-141">This section provides an explanation of hello properties definition.</span></span>

<span data-ttu-id="a6747-142">資料分割的集合</span><span class="sxs-lookup"><span data-stu-id="a6747-142">Partitioned Collection</span></span> | <span data-ttu-id="a6747-143">多個「單一資料分割」集合</span><span class="sxs-lookup"><span data-stu-id="a6747-143">Multiple “Single Partition” collections</span></span>
---|---
![documentdb 串流分析輸出畫面](media/stream-analytics-documentdb-output/stream-analytics-documentdb-output-1.png) |  ![documentdb 串流分析輸出畫面](media/stream-analytics-documentdb-output/stream-analytics-documentdb-output-2.png)


  
> [!NOTE]
> <span data-ttu-id="a6747-146">hello**多個 「 單一分割 」 集合**案例需要資料分割索引鍵，而且是支援的設定。</span><span class="sxs-lookup"><span data-stu-id="a6747-146">hello **Multiple “Single Partition” collections** scenario requires a partition key and is a supported configuration.</span></span> 

* <span data-ttu-id="a6747-147">**輸出別名**– ASA 查詢中此輸出別名 toorefer</span><span class="sxs-lookup"><span data-stu-id="a6747-147">**Output Alias** – An alias toorefer this output in your ASA query</span></span>  
* <span data-ttu-id="a6747-148">**帳戶名稱**– hello 名稱或端點的 hello Cosmos DB 帳戶的 URI。</span><span class="sxs-lookup"><span data-stu-id="a6747-148">**Account Name** – hello name or endpoint URI of hello Cosmos DB account.</span></span>  
* <span data-ttu-id="a6747-149">**帳戶金鑰**– hello hello Cosmos DB 帳戶的共用的存取金鑰。</span><span class="sxs-lookup"><span data-stu-id="a6747-149">**Account Key** – hello shared access key for hello Cosmos DB account.</span></span>  
* <span data-ttu-id="a6747-150">**資料庫**– hello Cosmos DB 資料庫名稱。</span><span class="sxs-lookup"><span data-stu-id="a6747-150">**Database** – hello Cosmos DB database name.</span></span>  
* <span data-ttu-id="a6747-151">**集合名稱模式**– hello 集合名稱或其 hello 集合 toobe 使用模式。</span><span class="sxs-lookup"><span data-stu-id="a6747-151">**Collection Name Pattern** – hello collection name or their pattern for hello collections toobe used.</span></span> <span data-ttu-id="a6747-152">可使用 hello {partition} 語彙基元，資料分割會從 0 開始建構 hello 集合名稱格式。</span><span class="sxs-lookup"><span data-stu-id="a6747-152">hello collection name format can be constructed using hello optional {partition} token, where partitions start from 0.</span></span> <span data-ttu-id="a6747-153">以下是有效的範例輸入：</span><span class="sxs-lookup"><span data-stu-id="a6747-153">Following are sample valid inputs:</span></span>  
  <span data-ttu-id="a6747-154">1\) MyCollection – 必須要有一個名為 “MyCollection” 的集合存在。</span><span class="sxs-lookup"><span data-stu-id="a6747-154">1\) MyCollection – One collection named “MyCollection” must exist.</span></span>  
  <span data-ttu-id="a6747-155">2\) MyCollection{partition} – 這些集合必須存在 – "MyCollection0”、“MyCollection1”、“MyCollection2” 等，依此類推。</span><span class="sxs-lookup"><span data-stu-id="a6747-155">2\) MyCollection{partition} – Such collections must exist– "MyCollection0”, “MyCollection1”, “MyCollection2” and so on.</span></span>  
* <span data-ttu-id="a6747-156">**資料分割索引鍵** - 選擇性。</span><span class="sxs-lookup"><span data-stu-id="a6747-156">**Partition Key** – Optional.</span></span> <span data-ttu-id="a6747-157">只有當您在集合名稱模式中使用 {parition} 語彙基元時，才需要此索引鍵。</span><span class="sxs-lookup"><span data-stu-id="a6747-157">This is only needed if you are using a {parition} token in your collection name pattern.</span></span> <span data-ttu-id="a6747-158">hello 輸出使用事件 toospecify hello 機碼中跨集合分割輸出的 hello 欄位名稱。</span><span class="sxs-lookup"><span data-stu-id="a6747-158">hello name of hello field in output events used toospecify hello key for partitioning output across collections.</span></span> <span data-ttu-id="a6747-159">若為單一集合輸出，則可使用任何任意的輸出欄，例如 PartitionId。</span><span class="sxs-lookup"><span data-stu-id="a6747-159">For single collection output, any arbitrary output column can be used e.g. PartitionId.</span></span>  
* <span data-ttu-id="a6747-160">**文件識別碼** ：可省略。</span><span class="sxs-lookup"><span data-stu-id="a6747-160">**Document ID** – Optional.</span></span> <span data-ttu-id="a6747-161">使用 toospecify hello 主索引鍵的 insert 或 update 作業所根據的輸出事件中的 hello 欄位 hello 名稱。</span><span class="sxs-lookup"><span data-stu-id="a6747-161">hello name of hello field in output events used toospecify hello primary key on which insert or update operations are based.</span></span>  
