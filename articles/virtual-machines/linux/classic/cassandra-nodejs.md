---
title: "使用 Azure 上的 Linux 來執行 Cassandra | Microsoft Docs"
description: "如何從 Node.js 應用程式在 Azure 虛擬機器的 Linux 上執行 Cassandra 叢集"
services: virtual-machines-linux
documentationcenter: nodejs
author: tomarcher
manager: routlaw
editor: 
tags: azure-service-management
ms.assetid: 30de1f29-e97d-492f-ae34-41ec83488de0
ms.service: virtual-machines-linux
ms.workload: infrastructure-services
ms.tgt_pltfrm: vm-linux
ms.devlang: na
ms.topic: article
ms.date: 08/17/2017
ms.author: tarcher
ms.openlocfilehash: 1ff3d77ced6c9d90029b251490c05e52d9b43515
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/29/2017
---
# <a name="running-cassandra-with-linux-on-azure-and-accessing-it-from-nodejs"></a><span data-ttu-id="c0830-103">在 Azure 上執行 Cassandra 搭配 Linux 並透過 Node.js 進行存取</span><span class="sxs-lookup"><span data-stu-id="c0830-103">Running Cassandra with Linux on Azure and Accessing it from Node.js</span></span>
> [!IMPORTANT] 
> <span data-ttu-id="c0830-104">Azure 建立和處理資源的部署模型有二種： [資源管理員和傳統](../../../resource-manager-deployment-model.md)。</span><span class="sxs-lookup"><span data-stu-id="c0830-104">Azure has two different deployment models for creating and working with resources: [Resource Manager and Classic](../../../resource-manager-deployment-model.md).</span></span> <span data-ttu-id="c0830-105">本文涵蓋之內容包括使用傳統部署模型。</span><span class="sxs-lookup"><span data-stu-id="c0830-105">This article covers using the Classic deployment model.</span></span> <span data-ttu-id="c0830-106">Microsoft 建議讓大部分的新部署使用資源管理員模式。</span><span class="sxs-lookup"><span data-stu-id="c0830-106">Microsoft recommends that most new deployments use the Resource Manager model.</span></span> <span data-ttu-id="c0830-107">請參閱 [Datastax Enterprise](https://azure.microsoft.com/documentation/templates/datastax) 的 Resource Manager 範本和 [CentOS 上的 Spark 叢集和 Cassandra](https://azure.microsoft.com/documentation/templates/spark-and-cassandra-on-centos/)。</span><span class="sxs-lookup"><span data-stu-id="c0830-107">See Resource Manager templates for [Datastax Enterprise](https://azure.microsoft.com/documentation/templates/datastax) and [Spark cluster and Cassandra on CentOS](https://azure.microsoft.com/documentation/templates/spark-and-cassandra-on-centos/).</span></span>

## <a name="overview"></a><span data-ttu-id="c0830-108">概觀</span><span class="sxs-lookup"><span data-stu-id="c0830-108">Overview</span></span>
<span data-ttu-id="c0830-109">Microsoft Azure 是一個開放雲端平台，可執行 Microsoft 和非 Microsoft 軟體，包括作業系統、應用程式伺服器、傳訊中介軟體，以及來自商業和開放原始碼模型的 SQL 和 NoSQL 資料庫。</span><span class="sxs-lookup"><span data-stu-id="c0830-109">Microsoft Azure is an open cloud platform that runs both Microsoft as well as non-Microsoft software which  includes operating systems, application servers, messaging middleware as well as SQL and NoSQL databases from both commercial and open source models.</span></span> <span data-ttu-id="c0830-110">如果要在包括 Azure 在內的公用雲端上建立具有恢復功能的服務，應用程式伺服器和儲存層都必須要有仔細的規劃和審慎的架構。</span><span class="sxs-lookup"><span data-stu-id="c0830-110">Building resilient services on public clouds including Azure requires careful planning and deliberate architecture for both applications servers as well storage layers.</span></span> <span data-ttu-id="c0830-111">Cassandra 的分散式儲存架構天生就有助於建置可針對叢集失敗容錯的高可用性系統。</span><span class="sxs-lookup"><span data-stu-id="c0830-111">Cassandra’s distributed storage architecture naturally helps in building highly available systems that are fault tolerant for cluster failures.</span></span> <span data-ttu-id="c0830-112">Cassandra 是一種雲端等級的 NoSQL 資料庫，由 Apache Software Foundation 維護 (網址 cassandra.apache.org)；Cassandra 以 Java 撰寫，因此可以在 Windows 與 Linux 平台上執行。</span><span class="sxs-lookup"><span data-stu-id="c0830-112">Cassandra is a cloud scale NoSQL database maintained by Apache Software Foundation at cassandra.apache.org; Cassandra is written in Java and hence runs on both on Windows as well as Linux platforms.</span></span>

<span data-ttu-id="c0830-113">本文的重點將說明如何利用 Microsoft Azure 虛擬機器和虛擬網路，在 Ubuntu 上部署 Cassandra 做為單一和多重資料中心叢集。</span><span class="sxs-lookup"><span data-stu-id="c0830-113">The focus of this article is to show Cassandra deployment on Ubuntu as a single and multi-data center cluster leveraging Microsoft Azure Virtual Machines and Virtual Networks.</span></span> <span data-ttu-id="c0830-114">用於實際執行環境最佳化工作負載的叢集部署超出本文的範圍，因為它需要多磁碟節點設定、適當的環狀拓撲設計及資料模型來支援所需的複寫、資料一致性、輸送量和高可用性需求。</span><span class="sxs-lookup"><span data-stu-id="c0830-114">The cluster deployment for production optimized workloads is out of scope of this article as it requires multi-disk node configuration, appropriate ring topology design and data modeling to support the needed replication, data consistency, throughput and high availability requirements.</span></span>

<span data-ttu-id="c0830-115">本文採用基本的方式說明建置 Cassandra 叢集所牽涉的工作，比起 Docker、Chef 或 Puppet，前者可讓基礎結構部署輕鬆許多。</span><span class="sxs-lookup"><span data-stu-id="c0830-115">This article takes a fundamental approach to show what is involved in building the Cassandra cluster compared Docker, Chef or Puppet which can make the infrastructure deployment a lot easier.</span></span>  

## <a name="the-deployment-models"></a><span data-ttu-id="c0830-116">部署模型</span><span class="sxs-lookup"><span data-stu-id="c0830-116">The Deployment Models</span></span>
<span data-ttu-id="c0830-117">Microsoft Azure 網路功能可供部署獨立的私人叢集，透過限制其存取權以達到精細的網路安全性。</span><span class="sxs-lookup"><span data-stu-id="c0830-117">Microsoft Azure networking allows the deployment of isolated private clusters, the access of which can be restricted to attain fine grained network security.</span></span>  <span data-ttu-id="c0830-118">由於本文是關於基本層級的 Cassandra 部署，因此我們將不會著重在一致性層級和輸送量的最佳儲存體設計。</span><span class="sxs-lookup"><span data-stu-id="c0830-118">Since this article is about showing the Cassandra deployment at a fundamental level, we will not focus on the consistency level and the optimal storage design for throughput.</span></span> <span data-ttu-id="c0830-119">以下是我們假設叢集的網路功能需求清單：</span><span class="sxs-lookup"><span data-stu-id="c0830-119">Here is the list of networking requirements for our hypothetical cluster:</span></span>

* <span data-ttu-id="c0830-120">外部系統無法從 Azure 內部或外部存取 Cassandra 資料庫</span><span class="sxs-lookup"><span data-stu-id="c0830-120">External systems can’t access Cassandra database from within or outside Azure</span></span>
* <span data-ttu-id="c0830-121">Cassandra 叢集必須位於 thrift 流量的負載平衡器後方</span><span class="sxs-lookup"><span data-stu-id="c0830-121">Cassandra cluster has to be behind a load balancer for thrift traffic</span></span>
* <span data-ttu-id="c0830-122">在每個資料中心部署 Cassandra 節點為兩個群組以提高叢集可用性</span><span class="sxs-lookup"><span data-stu-id="c0830-122">Deploy Cassandra nodes in two groups in each data center for an enhanced cluster availability</span></span>
* <span data-ttu-id="c0830-123">鎖定叢集，只有應用程式伺服器陣列可直接存取資料庫</span><span class="sxs-lookup"><span data-stu-id="c0830-123">Lock down the cluster so that only application server farm has access to the database directly</span></span>
* <span data-ttu-id="c0830-124">除了 SSH 以外，沒有其他公用網路端點</span><span class="sxs-lookup"><span data-stu-id="c0830-124">No public networking endpoints other than SSH</span></span>
* <span data-ttu-id="c0830-125">每個 Cassandra 節點需要固定的內部 IP 位址</span><span class="sxs-lookup"><span data-stu-id="c0830-125">Each Cassandra node needs a fixed internal IP address</span></span>

<span data-ttu-id="c0830-126">Cassandra 可以部署到單一 Azure 區域或多個區域，視工作負載的分散特性而定。</span><span class="sxs-lookup"><span data-stu-id="c0830-126">Cassandra can be deployed to a single Azure region or to multiple regions based on the distributed nature of the workload.</span></span> <span data-ttu-id="c0830-127">多重區域部署模型透過相同的 Cassandra 基礎結構，可用來服務接近特定地理位置的使用者。</span><span class="sxs-lookup"><span data-stu-id="c0830-127">Multi-region deployment model can be leveraged to serve end users closer to a particular geography through the same Cassandra infrastructure.</span></span> <span data-ttu-id="c0830-128">Cassandra 的內建節點複寫負責同步處理來自多個資料中心的多重主機寫入，並且對應用程式提供一致的資料檢視。</span><span class="sxs-lookup"><span data-stu-id="c0830-128">Cassandra’s built-in node replication takes care of the synchronization of multi-master writes originating from multiple data centers and presents a consistent view of the data to applications.</span></span> <span data-ttu-id="c0830-129">多重區域部署也可以協助降低更多 Azure 服務中斷的風險。</span><span class="sxs-lookup"><span data-stu-id="c0830-129">Multi-region deployment can also help with the risk mitigation of the broader Azure service outages.</span></span> <span data-ttu-id="c0830-130">Cassandra 的可微調一致性和複寫拓撲有助於滿足應用程式不同的 RPO 需求。</span><span class="sxs-lookup"><span data-stu-id="c0830-130">Cassandra’s tunable consistency and replication topology will help in meeting diverse RPO needs of applications.</span></span>

### <a name="single-region-deployment"></a><span data-ttu-id="c0830-131">單一區域部署</span><span class="sxs-lookup"><span data-stu-id="c0830-131">Single Region Deployment</span></span>
<span data-ttu-id="c0830-132">我們將從單一區域部署開始，並學習建立多重區域模型。</span><span class="sxs-lookup"><span data-stu-id="c0830-132">We will start with a single region deployment and harvest the learnings in creating a multi-region model.</span></span> <span data-ttu-id="c0830-133">我們將使用 Azure 虛擬網路功能建立獨立的子網路，以滿足先前所描述的網路安全性需求。</span><span class="sxs-lookup"><span data-stu-id="c0830-133">Azure virtual networking will be used to create isolated subnets so that the network security requirements mentioned above can be met.</span></span>  <span data-ttu-id="c0830-134">建立單一區域部署的程序使用 Ubuntu 14.04 LTS 和 Cassandra 2.08；不過，程序要改採用其他 Linux 版本也非常容易。</span><span class="sxs-lookup"><span data-stu-id="c0830-134">The process described in creating the single region deployment uses Ubuntu 14.04 LTS and Cassandra 2.08; however, the process can easily be adopted to the other Linux variants.</span></span> <span data-ttu-id="c0830-135">下列是單一區域部署的一些系統特性。</span><span class="sxs-lookup"><span data-stu-id="c0830-135">The following are some of the systemic characteristics of the single region deployment.</span></span>  

<span data-ttu-id="c0830-136">**高可用性：** Cassandra 節點 (如圖 1 所示) 已部署至兩個可用性設定組，因此，節點會散佈於多個容錯網域之間，以獲取高可用性。</span><span class="sxs-lookup"><span data-stu-id="c0830-136">**High Availability:** The Cassandra nodes shown in the Figure 1 are deployed to two availability sets so that the nodes are spread between multiple fault domains for high availability.</span></span> <span data-ttu-id="c0830-137">利用每個可用性設定組進行標註的 VM 會對應至 2 個容錯網域。</span><span class="sxs-lookup"><span data-stu-id="c0830-137">VMs annotated with each availability set is mapped to 2 fault domains.</span></span>  <span data-ttu-id="c0830-138">Microsoft Azure 會使用容錯網域的概念來管理意外關機時間 (例如，硬體或軟體失敗)，同時使用升級網域的概念 (例如，主機或客體 OS 修補/升級、應用程式升級) 來管理排程的停機時間。</span><span class="sxs-lookup"><span data-stu-id="c0830-138">Microsoft Azure uses the concept of fault domain to manage unplanned down time (e.g. hardware or software failures) while the concept of upgrade domain (e.g. host or guest OS patching/upgrades, application upgrades) is used for managing scheduled down time.</span></span> <span data-ttu-id="c0830-139">如需用來取得高可用性之容錯和升級網域的角色，請參閱 [Azure 應用程式的災害復原與高可用性](http://msdn.microsoft.com/library/dn251004.aspx) 。</span><span class="sxs-lookup"><span data-stu-id="c0830-139">Please see [Disaster Recovery and High Availability for Azure Applications](http://msdn.microsoft.com/library/dn251004.aspx) for the role of fault and upgrade domains in attaining high availability.</span></span>

![單一區域部署](./media/cassandra-nodejs/cassandra-linux1.png)

<span data-ttu-id="c0830-141">圖 1：單一區域部署</span><span class="sxs-lookup"><span data-stu-id="c0830-141">Figure 1: Single region deployment</span></span>

<span data-ttu-id="c0830-142">請注意，在撰寫本文時，Azure 不允許將一組 VM 明確對應到特定容錯網域。因此，即使使用如圖 1 所示的部署模型，統計上來說有可能所有的虛擬機器都對應到兩個容錯網域而不是四個。</span><span class="sxs-lookup"><span data-stu-id="c0830-142">Note that at the time of this writing, Azure doesn’t allow the explicit mapping of a group of VMs to a specific fault domain; consequently, even with the deployment model shown in Figure 1, it is statistically probable that all the virtual machines may be mapped to two fault domains instead of four.</span></span>

<span data-ttu-id="c0830-143">**負載平衡 Thrift 流量：** Web 伺服器內部的 Thrift 用戶端程式庫會透過內部負載平衡器連線到叢集。</span><span class="sxs-lookup"><span data-stu-id="c0830-143">**Load Balancing Thrift Traffic:** Thrift client libraries inside the web server connect to the cluster through an internal load balancer.</span></span> <span data-ttu-id="c0830-144">這需要將內部負載平衡器新增到「資料」子網路的程序 (請參閱圖 1)，這個子網路位於裝載 Cassandra 叢集的雲端服務內容中。</span><span class="sxs-lookup"><span data-stu-id="c0830-144">This requires the process of adding the internal load balancer to the “data” subnet (refer Figure 1) in the context of the cloud service hosting the Cassandra cluster.</span></span> <span data-ttu-id="c0830-145">一旦定義內部負載平衡器之後，每個節點所需要的負載平衡端點，必須使用具有先前定義之負載平衡器名稱的負載平衡集註解來新增。</span><span class="sxs-lookup"><span data-stu-id="c0830-145">Once the internal load balancer is defined, each node requires the load balanced endpoint to be added with the annotations of a load balanced set with previously defined load balancer name.</span></span> <span data-ttu-id="c0830-146">如需詳細資訊，請參閱 [Azure內部負載平衡 ](../../../load-balancer/load-balancer-internal-overview.md)。</span><span class="sxs-lookup"><span data-stu-id="c0830-146">See [Azure Internal Load Balancing ](../../../load-balancer/load-balancer-internal-overview.md)for more details.</span></span>

<span data-ttu-id="c0830-147">**叢集種子：** 務必選取可用性最高的節點做為種子，因為新的節點會與種子節點進行通訊以探索叢集的拓撲。</span><span class="sxs-lookup"><span data-stu-id="c0830-147">**Cluster Seeds:** It is important to select the most highly available nodes for seeds as the new nodes will communicate with seed nodes to discover the topology of the cluster.</span></span> <span data-ttu-id="c0830-148">將每個可用性設定組中的一個節點指定為種子節點，可避免單一失敗點。</span><span class="sxs-lookup"><span data-stu-id="c0830-148">One node from each availability set is designated as seed nodes to avoid single point of failure.</span></span>

<span data-ttu-id="c0830-149">**複寫因數和一致性層級：** Cassandra 內建的高可用性和資料耐久性的特點在於複寫因數 (RF - 儲存在叢集上的每個資料列複本數) 和一致性層級 (將結果傳回呼叫端之前要讀取/寫入的複本數)。</span><span class="sxs-lookup"><span data-stu-id="c0830-149">**Replication Factor and Consistency Level:** Cassandra’s build-in high-availability and data durability is characterized by the Replication Factor (RF - number of copies of each row stored on the cluster) and Consistency Level (number of replicas to be read/written before returning the result to the caller).</span></span> <span data-ttu-id="c0830-150">複寫因數是在 KEYSPACE (類似關聯式資料庫) 建立期間所指定，而一致性層級是在發出 CRUD 查詢的同時所指定。</span><span class="sxs-lookup"><span data-stu-id="c0830-150">Replication factor is specified during the KEYSPACE (similar to a relational database) creation whereas the consistency level is specified while issuing the CRUD query.</span></span> <span data-ttu-id="c0830-151">如需一致性詳細資料和仲裁計算的公式，請參閱 Cassandra 文件中的 [一致性設定](http://www.datastax.com/documentation/cassandra/2.0/cassandra/dml/dml_config_consistency_c.html) 。</span><span class="sxs-lookup"><span data-stu-id="c0830-151">See Cassandra documentation at [Configuring for Consistency](http://www.datastax.com/documentation/cassandra/2.0/cassandra/dml/dml_config_consistency_c.html) for consistency details and the formula for quorum computation.</span></span>

<span data-ttu-id="c0830-152">Cassandra 支援兩種類型的資料完整性模型 – 一致性和最終一致性。「複寫因素」和「一致性層級」將一起判斷資料會在寫入作業完成時就達成一致，或者最終才達成一致。</span><span class="sxs-lookup"><span data-stu-id="c0830-152">Cassandra supports two types of data integrity models – Consistency and Eventual Consistency; the Replication Factor and Consistency Level will together determine if the data will be consistent as soon as a write operation is complete or it will be eventually consistent.</span></span> <span data-ttu-id="c0830-153">例如，指定「一致性層級」為 QUORUM，將永遠確保在任何一致性層級時的資料一致性，低於達到 QUORUM (例如 ONE) 所需寫入的複本數目，會造成資料在最終才達成一致。</span><span class="sxs-lookup"><span data-stu-id="c0830-153">For example, specifying QUORUM as the Consistency Level will always ensures data Consistency while any consistency level, below the number of replicas to be written as needed to attain QUORUM (e.g. ONE) results in data being eventually consistent.</span></span>

<span data-ttu-id="c0830-154">以上顯示的 8 節點叢集，使用 3 的複寫因素和 QUORUM (為了一致性而讀取或寫入 2 個節點) 讀取/寫入的一致性層級，在應用程式開始注意失敗之前，每個複寫群組最多只能有 1 個節點可避免理論性遺失。</span><span class="sxs-lookup"><span data-stu-id="c0830-154">The 8-node cluster shown above, with a replication factor of 3 and QUORUM (2 nodes are read or written for consistency) read/write consistency level, can survive the theoretical loss of at the most 1 node per replication group before the application start noticing the failure.</span></span> <span data-ttu-id="c0830-155">這假設所有關鍵值空間都已經順利平衡讀取/寫入要求。</span><span class="sxs-lookup"><span data-stu-id="c0830-155">This assumes that all the key spaces have well balanced read/write requests.</span></span>  <span data-ttu-id="c0830-156">我們將針對已部署的叢集使用下列參數：</span><span class="sxs-lookup"><span data-stu-id="c0830-156">The following are the parameters we will use for the deployed cluster:</span></span>

<span data-ttu-id="c0830-157">單一區域 Cassandra 叢集設定：</span><span class="sxs-lookup"><span data-stu-id="c0830-157">Single region Cassandra cluster configuration:</span></span>

| <span data-ttu-id="c0830-158">叢集參數</span><span class="sxs-lookup"><span data-stu-id="c0830-158">Cluster Parameter</span></span> | <span data-ttu-id="c0830-159">值</span><span class="sxs-lookup"><span data-stu-id="c0830-159">Value</span></span> | <span data-ttu-id="c0830-160">備註</span><span class="sxs-lookup"><span data-stu-id="c0830-160">Remarks</span></span> |
| --- | --- | --- |
| <span data-ttu-id="c0830-161">節點數目 (N)</span><span class="sxs-lookup"><span data-stu-id="c0830-161">Number of Nodes (N)</span></span> |<span data-ttu-id="c0830-162">8</span><span class="sxs-lookup"><span data-stu-id="c0830-162">8</span></span> |<span data-ttu-id="c0830-163">叢集中的節點總數</span><span class="sxs-lookup"><span data-stu-id="c0830-163">Total number of nodes in the cluster</span></span> |
| <span data-ttu-id="c0830-164">複寫因素 (RF)</span><span class="sxs-lookup"><span data-stu-id="c0830-164">Replication Factor (RF)</span></span> |<span data-ttu-id="c0830-165">3</span><span class="sxs-lookup"><span data-stu-id="c0830-165">3</span></span> |<span data-ttu-id="c0830-166">指定資料列的複本數目</span><span class="sxs-lookup"><span data-stu-id="c0830-166">Number of replicas of a given row</span></span> |
| <span data-ttu-id="c0830-167">一致性層級 (寫入)</span><span class="sxs-lookup"><span data-stu-id="c0830-167">Consistency Level (Write)</span></span> |<span data-ttu-id="c0830-168">QUORUM[(RF/2) +1) = 2] 公式結果無條件捨去</span><span class="sxs-lookup"><span data-stu-id="c0830-168">QUORUM[(RF/2) +1) = 2] The result of the formula is rounded down</span></span> |<span data-ttu-id="c0830-169">在回應傳送至呼叫者之前，最多寫入 2 個複本；第 3 個複本會以最終一致的方式寫入。</span><span class="sxs-lookup"><span data-stu-id="c0830-169">Writes at the most 2 replicas before the response is sent to the caller; 3rd replica is written in an eventually consistent manner.</span></span> |
| <span data-ttu-id="c0830-170">一致性層級 (讀取)</span><span class="sxs-lookup"><span data-stu-id="c0830-170">Consistency Level (Read)</span></span> |<span data-ttu-id="c0830-171">QUORUM [(RF/2) +1= 2] 公式結果無條件捨去</span><span class="sxs-lookup"><span data-stu-id="c0830-171">QUORUM [(RF/2) +1= 2] The result of the formula is rounded down</span></span> |<span data-ttu-id="c0830-172">在傳送回應給呼叫者之前讀取 2 個複本。</span><span class="sxs-lookup"><span data-stu-id="c0830-172">Reads 2 replicas before sending response to the caller.</span></span> |
| <span data-ttu-id="c0830-173">複寫策略</span><span class="sxs-lookup"><span data-stu-id="c0830-173">Replication Strategy</span></span> |<span data-ttu-id="c0830-174">如需 NetworkTopologyStrategy 的詳細資訊，請參閱 Cassandra 文件中的 [資料複寫](http://www.datastax.com/documentation/cassandra/2.0/cassandra/architecture/architectureDataDistributeReplication_c.html) (英文)</span><span class="sxs-lookup"><span data-stu-id="c0830-174">NetworkTopologyStrategy see [Data Replication](http://www.datastax.com/documentation/cassandra/2.0/cassandra/architecture/architectureDataDistributeReplication_c.html) in Cassandra documentation for more information</span></span> |<span data-ttu-id="c0830-175">了解部署拓撲並將複本放在節點上，最後所有複本就不會都位於相同的機架上</span><span class="sxs-lookup"><span data-stu-id="c0830-175">Understands the deployment topology and places replicas on nodes so that all the replicas don’t end up on the same rack</span></span> |
| <span data-ttu-id="c0830-176">Snitch</span><span class="sxs-lookup"><span data-stu-id="c0830-176">Snitch</span></span> |<span data-ttu-id="c0830-177">如需 GossipingPropertyFileSnitch 的詳細資訊，請參閱 Cassandra 文件中的 [Snitches](http://www.datastax.com/documentation/cassandra/2.0/cassandra/architecture/architectureSnitchesAbout_c.html) (英文)</span><span class="sxs-lookup"><span data-stu-id="c0830-177">GossipingPropertyFileSnitch see [Snitches](http://www.datastax.com/documentation/cassandra/2.0/cassandra/architecture/architectureSnitchesAbout_c.html) in Cassandra documentation for more information</span></span> |<span data-ttu-id="c0830-178">NetworkTopologyStrategy 使用 Snitch 的概念來了解拓撲。</span><span class="sxs-lookup"><span data-stu-id="c0830-178">NetworkTopologyStrategy uses a concept of snitch to understand the topology.</span></span> <span data-ttu-id="c0830-179">GossipingPropertyFileSnitch 在將各個節點對應到資料中心與機架時提供較好的控制。</span><span class="sxs-lookup"><span data-stu-id="c0830-179">GossipingPropertyFileSnitch gives better control in mapping each node to data center and rack.</span></span> <span data-ttu-id="c0830-180">叢集再使用 Gossip 來散佈這項資訊。</span><span class="sxs-lookup"><span data-stu-id="c0830-180">The cluster then uses gossip to propagate this information.</span></span> <span data-ttu-id="c0830-181">相對於 PropertyFileSnitch，這在動態 IP 設定中簡單許多</span><span class="sxs-lookup"><span data-stu-id="c0830-181">This is much simpler in dynamic IP setting relative to PropertyFileSnitch</span></span> |

<span data-ttu-id="c0830-182">**Cassandra 叢集的 Azure 考量：** Microsoft Azure 虛擬機器功能會使用 Azure Blob 儲存體來取得磁碟持續性；Azure 儲存體會基於高持久性因素來為每個磁碟儲存 3 個複本。</span><span class="sxs-lookup"><span data-stu-id="c0830-182">**Azure Considerations for Cassandra Cluster:** Microsoft Azure Virtual Machines capability uses Azure Blob storage for disk persistence; Azure Storage saves 3 replicas of each disk for high durability.</span></span> <span data-ttu-id="c0830-183">這表示已插入 Cassandra 資料表的每個資料列都已經儲存於 3 個複本中，因此，即使複寫因數 (RF) 為 1，也已經兼顧到資料一致性。</span><span class="sxs-lookup"><span data-stu-id="c0830-183">That means each row of data inserted into a Cassandra table is already stored in 3 replicas and hence data consistency is already taken care of even if the Replication Factor (RF) is 1.</span></span> <span data-ttu-id="c0830-184">複寫因數是 1 的主要問題在於，即使單一 Cassandra 節點失敗，應用程式還是會經歷停機時間。</span><span class="sxs-lookup"><span data-stu-id="c0830-184">The main problem with Replication Factor being 1 is that the application will experience downtime even if a single Cassandra node fails.</span></span> <span data-ttu-id="c0830-185">不過，如果節點因為 Azure 網狀架構控制器所辨識出的問題 (例如，硬體、系統軟體失敗) 而關閉，它將會使用相同的儲存體磁碟機，在其位置中佈建新的節點。</span><span class="sxs-lookup"><span data-stu-id="c0830-185">However, if a node is down for the problems (e.g. hardware, system software failures) recognized by Azure Fabric Controller, it will provision a new node in its place using the same storage drives.</span></span> <span data-ttu-id="c0830-186">佈建新節點來取代舊節點，可能需要幾分鐘的時間。</span><span class="sxs-lookup"><span data-stu-id="c0830-186">Provisioning a new node to replace the old one may take a few minutes.</span></span>  <span data-ttu-id="c0830-187">類似於如客體 OS 變更、Cassandra 升級及應用程式變更等預定維護活動，Azure 網狀架構控制器會在叢集中執行節點的輪流升級。</span><span class="sxs-lookup"><span data-stu-id="c0830-187">Similarly for planned maintenance activities like guest OS changes, Cassandra upgrades and application changes Azure Fabric Controller performs rolling upgrades of the nodes in the cluster.</span></span>  <span data-ttu-id="c0830-188">輪流升級也可能會一次關閉數個節點，因此，叢集可能會遇到數個磁碟分割短暫停機的狀況。</span><span class="sxs-lookup"><span data-stu-id="c0830-188">Rolling upgrades also may take down a few nodes at a time and hence the cluster may experience brief downtime for a few partitions.</span></span> <span data-ttu-id="c0830-189">不過，資料將不會因為內建的 Azure 儲存體備援而遺失。</span><span class="sxs-lookup"><span data-stu-id="c0830-189">However, the data will not be lost due to the built-in Azure Storage redundancy.</span></span>  

<span data-ttu-id="c0830-190">對於部署到 Azure 但不需要高可用性的系統 (例如，大約 99.9，相當於每年 8.76 個小時，請參閱 [高可用性](http://en.wikipedia.org/wiki/High_availability) 以了解詳細資訊)，您可以採用 RF=1 和一致性層級=ONE 來執行。</span><span class="sxs-lookup"><span data-stu-id="c0830-190">For systems deployed to Azure that doesn’t require high availability (e.g. around 99.9 which is equivalent to 8.76 hrs/year; see [High Availability](http://en.wikipedia.org/wiki/High_availability) for details) you may be able to run with RF=1 and Consistency Level=ONE.</span></span>  <span data-ttu-id="c0830-191">對於具有高可用性需求的應用程式，RF=3 和一致性層級=QUORUM 將可容忍其中一個節點其中一個複本的停機時間。</span><span class="sxs-lookup"><span data-stu-id="c0830-191">For applications with high availability requirements, RF=3 and Consistency Level=QUORUM will tolerate the down time of one of the nodes one of the replicas.</span></span> <span data-ttu-id="c0830-192">不能在傳統部署 (例如內部部署) 中使用 RF=1，因為像是磁碟損壞所產生的問題可能會導致資料遺失。</span><span class="sxs-lookup"><span data-stu-id="c0830-192">RF=1 in traditional deployments (e.g. on-premises) can’t be used due to the possible data loss resulting from problems like disk failures.</span></span>   

## <a name="multi-region-deployment"></a><span data-ttu-id="c0830-193">多重區域部署</span><span class="sxs-lookup"><span data-stu-id="c0830-193">Multi-region Deployment</span></span>
<span data-ttu-id="c0830-194">Cassandra 的資料中心感知複寫和上述的一致性模型有助於立即進行多重區域部署，而不需使用任何外部工具。</span><span class="sxs-lookup"><span data-stu-id="c0830-194">Cassandra’s data-center-aware replication and consistency model described above helps with the multi-region deployment out of the box without the need for any external tooling.</span></span> <span data-ttu-id="c0830-195">這與傳統的關聯式資料庫相當不同，後者在設定資料庫鏡像以進行多重主機寫入時相當複雜。</span><span class="sxs-lookup"><span data-stu-id="c0830-195">This is quite different from the traditional relational databases where the setup for database mirroring for multi-master writes can be quite complex.</span></span> <span data-ttu-id="c0830-196">Cassandra 的多重區域設定有助於包括下列的使用案例：</span><span class="sxs-lookup"><span data-stu-id="c0830-196">Cassandra in a multi-region set up can help with the usage scenarios including the following:</span></span>

<span data-ttu-id="c0830-197">**以近接性為基礎的部署：** 清除租用戶使用者與區域對應的多租用戶應用程式，可以因為多地區叢集的低延遲而受益。</span><span class="sxs-lookup"><span data-stu-id="c0830-197">**Proximity based deployment:** Multi-tenant applications, with clear mapping of tenant users -to-region, can be benefited by the multi-region cluster’s low latencies.</span></span> <span data-ttu-id="c0830-198">例如，適用於教育機構的學習管理系統可以在美國東部和美國西部區域部署分散式叢集，分別做為適用於交易與分析的校園。</span><span class="sxs-lookup"><span data-stu-id="c0830-198">For example a learning management systems for educational institutions can deploy a distributed cluster in East US and West US regions to serve the respective campuses for transactional as well as analytics.</span></span> <span data-ttu-id="c0830-199">資料可以在讀取和寫入期間維持本機一致性，而且最終可在這兩個區域間維持一致性。</span><span class="sxs-lookup"><span data-stu-id="c0830-199">The data can be locally consistent at the time reads and writes and can be eventually consistent across both the regions.</span></span> <span data-ttu-id="c0830-200">其他的範例還有媒體發佈、電子商務，以及可為地理位置集中之使用者提供服務的一切 (這是此部署模型的絕佳使用案例)。</span><span class="sxs-lookup"><span data-stu-id="c0830-200">There are other examples like media distribution, e-commerce and anything and everything that serves geo concentrated user base is a good use case for this deployment model.</span></span>

<span data-ttu-id="c0830-201">**高可用性：**備援是取得軟體和硬體高可用性的關鍵因數；如需詳細資訊，請參閱＜在 Microsoft Azure 上建置可靠的雲端系統＞。</span><span class="sxs-lookup"><span data-stu-id="c0830-201">**High Availability:** Redundancy is a key factor in attaining high availability of software and hardware; see Building Reliable Cloud Systems on Microsoft Azure for details.</span></span> <span data-ttu-id="c0830-202">在 Microsoft Azure 上，實現真正備援的唯一可靠方式就是部署多區域叢集。</span><span class="sxs-lookup"><span data-stu-id="c0830-202">On Microsoft Azure, the only reliable way of achieving true redundancy is by deploying a multi-region cluster.</span></span> <span data-ttu-id="c0830-203">應用程式可部署於主動/主動或主動/被動模式中，如果其中一個區域已關閉，Azure 流量管理員就能將流量重新導向至作用中的區域。</span><span class="sxs-lookup"><span data-stu-id="c0830-203">Applications can be deployed in an active-active or active-passive mode and if one of the regions is down, Azure Traffic Manager can redirect traffic to the active region.</span></span>  <span data-ttu-id="c0830-204">使用單一區域部署時，如果可用性是 99.9，則兩個區域的部署可以達到 99.9999 的可用性，計算公式如下：(1-(1-0.999) * (1-0.999))*100)。如需詳細資訊，請參閱上述文件。</span><span class="sxs-lookup"><span data-stu-id="c0830-204">With the single region deployment, if the availability is 99.9, a two-region deployment can attain an availability of 99.9999 computed by the formula: (1-(1-0.999) * (1-0.999))*100); see the above paper for details.</span></span>

<span data-ttu-id="c0830-205">**災害復原：**如果設計正確，多區域的 Cassandra 叢集就能承受重大的資料中心中斷。</span><span class="sxs-lookup"><span data-stu-id="c0830-205">**Disaster Recovery:** Multi-region Cassandra cluster, if properly designed, can withstand catastrophic data center outages.</span></span> <span data-ttu-id="c0830-206">如果某個區域已關閉，部署到其他區域的應用程式就能開始為使用者提供服務。</span><span class="sxs-lookup"><span data-stu-id="c0830-206">If one region is down, the application deployed to other regions can start serving the end users.</span></span> <span data-ttu-id="c0830-207">和所有其他的商務持續實作一樣，應用程式必須能對非同步管線中的資料所產生的部分資料遺失進行容錯。</span><span class="sxs-lookup"><span data-stu-id="c0830-207">Like any other business continuity implementations, the application has to be tolerant for some data loss resulting from the data in the asynchronous pipeline.</span></span> <span data-ttu-id="c0830-208">不過，相較於傳統資料庫復原程序所花費的時間，Cassandra 能夠更快速地進行復原。</span><span class="sxs-lookup"><span data-stu-id="c0830-208">However, Cassandra makes the recovery much swifter than the time taken by traditional database recovery processes.</span></span> <span data-ttu-id="c0830-209">圖 2 顯示每個區域中有八個節點的典型多區域部署模型。</span><span class="sxs-lookup"><span data-stu-id="c0830-209">Figure 2 shows the typical multi-region deployment model with eight nodes in each region.</span></span> <span data-ttu-id="c0830-210">這兩個區域是彼此具備相同對稱性的鏡映影像。真實世界的設計取決於工作負載類型 (例如，交易或分析)、RPO、RTO、資料一致性，以及可用性需求。</span><span class="sxs-lookup"><span data-stu-id="c0830-210">Both regions are mirror images of each other for the same of symmetry; real world designs depend on the workload type (e.g. transactional or analytical), RPO, RTO, data consistency and availability requirements.</span></span>

![多區域部署](./media/cassandra-nodejs/cassandra-linux2.png)

<span data-ttu-id="c0830-212">圖 2：多區域 Cassandra 部署</span><span class="sxs-lookup"><span data-stu-id="c0830-212">Figure 2: Multi-region Cassandra deployment</span></span>

### <a name="network-integration"></a><span data-ttu-id="c0830-213">網路整合</span><span class="sxs-lookup"><span data-stu-id="c0830-213">Network Integration</span></span>
<span data-ttu-id="c0830-214">部署至私人網路、位於兩個區域的虛擬機器設定組使用 VPN 通道彼此通訊。</span><span class="sxs-lookup"><span data-stu-id="c0830-214">Sets of virtual machines deployed to private networks located on two regions communicates with each other using a VPN tunnel.</span></span> <span data-ttu-id="c0830-215">VPN 通道連線在網路部署程序期間佈建的兩個軟體閘道。</span><span class="sxs-lookup"><span data-stu-id="c0830-215">The VPN tunnel connects two software gateways provisioned during the network deployment process.</span></span> <span data-ttu-id="c0830-216">這兩個區域有類似的網路架構，分別稱為 "Web" 和「資料」子網路。Azure 網路功能允許建立多個子網路，以及根據網路安全性的需要套用 ACL。</span><span class="sxs-lookup"><span data-stu-id="c0830-216">Both regions have similar network architecture in terms of “web” and “data” subnets; Azure networking allows the creation of as many subnets as needed and apply ACLs as needed by network security.</span></span> <span data-ttu-id="c0830-217">設計資料中心之間的叢集拓撲時，需要考量網路流量的通訊延遲與經濟影響。</span><span class="sxs-lookup"><span data-stu-id="c0830-217">While designing the cluster topology inter data center communication latency and the economic impact of the network traffic need to be considered.</span></span>

### <a name="data-consistency-for-multi-data-center-deployment"></a><span data-ttu-id="c0830-218">多重資料中心部署的資料一致性</span><span class="sxs-lookup"><span data-stu-id="c0830-218">Data Consistency for Multi-Data Center Deployment</span></span>
<span data-ttu-id="c0830-219">分散式部署需要留意叢集拓撲對輸送量和高可用性的影響。</span><span class="sxs-lookup"><span data-stu-id="c0830-219">Distributed deployments need to be aware of the cluster topology impact on throughput and high availability.</span></span> <span data-ttu-id="c0830-220">選取 RF 和一致性層級時，也必須以不需根據所有資料中心可用性進行仲裁的這種方式。</span><span class="sxs-lookup"><span data-stu-id="c0830-220">The RF and Consistency Level need to be selected in such way that the quorum doesn’t depend on the availability of all the data centers.</span></span>
<span data-ttu-id="c0830-221">對於需要高度一致性的系統，LOCAL_QUORUM 的一致性層級 (針對讀取和寫入) 可確保來自本機節點的本機讀取和寫入達到要求，同時資料會以非同步方式複寫到遠端資料中心。</span><span class="sxs-lookup"><span data-stu-id="c0830-221">For a system that needs high consistency, a LOCAL_QUORUM for consistency level (for reads and writes) will make sure that the local reads and writes are satisfied from the local nodes while data is replicated asynchronously to the remote data centers.</span></span>  <span data-ttu-id="c0830-222">表 2 摘要多重區域叢集 (稍後詳細說明) 的設定詳細資料。</span><span class="sxs-lookup"><span data-stu-id="c0830-222">Table 2 summarizes the configuration details for the multi-region cluster outlined later in the write up.</span></span>

<span data-ttu-id="c0830-223">**兩個區域的 Cassandra 叢集組態**</span><span class="sxs-lookup"><span data-stu-id="c0830-223">**Two-region Cassandra cluster configuration**</span></span>

| <span data-ttu-id="c0830-224">叢集參數</span><span class="sxs-lookup"><span data-stu-id="c0830-224">Cluster Parameter</span></span> | <span data-ttu-id="c0830-225">值</span><span class="sxs-lookup"><span data-stu-id="c0830-225">Value</span></span> | <span data-ttu-id="c0830-226">備註</span><span class="sxs-lookup"><span data-stu-id="c0830-226">Remarks</span></span> |
| --- | --- | --- |
| <span data-ttu-id="c0830-227">節點數目 (N)</span><span class="sxs-lookup"><span data-stu-id="c0830-227">Number of Nodes (N)</span></span> |<span data-ttu-id="c0830-228">8 + 8</span><span class="sxs-lookup"><span data-stu-id="c0830-228">8 + 8</span></span> |<span data-ttu-id="c0830-229">叢集中的節點總數</span><span class="sxs-lookup"><span data-stu-id="c0830-229">Total number of nodes in the cluster</span></span> |
| <span data-ttu-id="c0830-230">複寫因素 (RF)</span><span class="sxs-lookup"><span data-stu-id="c0830-230">Replication Factor (RF)</span></span> |<span data-ttu-id="c0830-231">3</span><span class="sxs-lookup"><span data-stu-id="c0830-231">3</span></span> |<span data-ttu-id="c0830-232">指定資料列的複本數目</span><span class="sxs-lookup"><span data-stu-id="c0830-232">Number of replicas of a given row</span></span> |
| <span data-ttu-id="c0830-233">一致性層級 (寫入)</span><span class="sxs-lookup"><span data-stu-id="c0830-233">Consistency Level (Write)</span></span> |<span data-ttu-id="c0830-234">LOCAL_QUORUM [(sum(RF)/2) +1) = 4] 公式結果無條件捨去</span><span class="sxs-lookup"><span data-stu-id="c0830-234">LOCAL_QUORUM [(sum(RF)/2) +1) = 4] The result of the formula is rounded down</span></span> |<span data-ttu-id="c0830-235">2 個節點會以同步方式寫入第一個資料中心；仲裁所需的其他 2 個節點會以非同步方式寫入第二個資料中心。</span><span class="sxs-lookup"><span data-stu-id="c0830-235">2 nodes will be written to the first data center synchronously; the additional 2 nodes needed for quorum will be written asynchronously to the 2nd data center.</span></span> |
| <span data-ttu-id="c0830-236">一致性層級 (讀取)</span><span class="sxs-lookup"><span data-stu-id="c0830-236">Consistency Level (Read)</span></span> |<span data-ttu-id="c0830-237">LOCAL_QUORUM ((RF/2) +1) = 2 公式結果無條件捨去</span><span class="sxs-lookup"><span data-stu-id="c0830-237">LOCAL_QUORUM ((RF/2) +1) = 2 The result of the formula is rounded down</span></span> |<span data-ttu-id="c0830-238">只會達到來自一個區域的讀取要求；在回應傳送回用戶端之前，會讀取 2 個節點。</span><span class="sxs-lookup"><span data-stu-id="c0830-238">Read requests are satisfied from only one region; 2 nodes are read before the response is sent back to the client.</span></span> |
| <span data-ttu-id="c0830-239">複寫策略</span><span class="sxs-lookup"><span data-stu-id="c0830-239">Replication Strategy</span></span> |<span data-ttu-id="c0830-240">如需 NetworkTopologyStrategy 的詳細資訊，請參閱 Cassandra 文件中的 [資料複寫](http://www.datastax.com/documentation/cassandra/2.0/cassandra/architecture/architectureDataDistributeReplication_c.html) (英文)</span><span class="sxs-lookup"><span data-stu-id="c0830-240">NetworkTopologyStrategy see [Data Replication](http://www.datastax.com/documentation/cassandra/2.0/cassandra/architecture/architectureDataDistributeReplication_c.html) in Cassandra documentation for more information</span></span> |<span data-ttu-id="c0830-241">了解部署拓撲並將複本放在節點上，最後所有複本就不會都位於相同的機架上</span><span class="sxs-lookup"><span data-stu-id="c0830-241">Understands the deployment topology and places replicas on nodes so that all the replicas don’t end up on the same rack</span></span> |
| <span data-ttu-id="c0830-242">Snitch</span><span class="sxs-lookup"><span data-stu-id="c0830-242">Snitch</span></span> |<span data-ttu-id="c0830-243">如需 GossipingPropertyFileSnitch 的詳細資訊，請參閱 Cassandra 文件中的 [Snitches](http://www.datastax.com/documentation/cassandra/2.0/cassandra/architecture/architectureSnitchesAbout_c.html) (英文)</span><span class="sxs-lookup"><span data-stu-id="c0830-243">GossipingPropertyFileSnitch see [Snitches](http://www.datastax.com/documentation/cassandra/2.0/cassandra/architecture/architectureSnitchesAbout_c.html) in Cassandra documentation for more information</span></span> |<span data-ttu-id="c0830-244">NetworkTopologyStrategy 使用 Snitch 的概念來了解拓撲。</span><span class="sxs-lookup"><span data-stu-id="c0830-244">NetworkTopologyStrategy uses a concept of snitch to understand the topology.</span></span> <span data-ttu-id="c0830-245">GossipingPropertyFileSnitch 在將各個節點對應到資料中心與機架時提供較好的控制。</span><span class="sxs-lookup"><span data-stu-id="c0830-245">GossipingPropertyFileSnitch gives better control in mapping each node to data center and rack.</span></span> <span data-ttu-id="c0830-246">叢集再使用 Gossip 來散佈這項資訊。</span><span class="sxs-lookup"><span data-stu-id="c0830-246">The cluster then uses gossip to propagate this information.</span></span> <span data-ttu-id="c0830-247">相對於 PropertyFileSnitch，這在動態 IP 設定中簡單許多</span><span class="sxs-lookup"><span data-stu-id="c0830-247">This is much simpler in dynamic IP setting relative to PropertyFileSnitch</span></span> |

## <a name="the-software-configuration"></a><span data-ttu-id="c0830-248">軟體設定</span><span class="sxs-lookup"><span data-stu-id="c0830-248">THE SOFTWARE CONFIGURATION</span></span>
<span data-ttu-id="c0830-249">部署期間將使用下列軟體版本：</span><span class="sxs-lookup"><span data-stu-id="c0830-249">The following software versions are used during the deployment:</span></span>

<table>
<tr><th><span data-ttu-id="c0830-250">軟體</span><span class="sxs-lookup"><span data-stu-id="c0830-250">Software</span></span></th><th><span data-ttu-id="c0830-251">來源</span><span class="sxs-lookup"><span data-stu-id="c0830-251">Source</span></span></th><th><span data-ttu-id="c0830-252">版本</span><span class="sxs-lookup"><span data-stu-id="c0830-252">Version</span></span></th></tr>
<tr><td><span data-ttu-id="c0830-253">JRE</span><span class="sxs-lookup"><span data-stu-id="c0830-253">JRE</span></span>    </td><td><span data-ttu-id="c0830-254">[JRE 8](http://www.oracle.com/technetwork/java/javase/downloads/server-jre8-downloads-2133154.html) </span><span class="sxs-lookup"><span data-stu-id="c0830-254">[JRE 8](http://www.oracle.com/technetwork/java/javase/downloads/server-jre8-downloads-2133154.html) </span></span></td><td><span data-ttu-id="c0830-255">8U5</span><span class="sxs-lookup"><span data-stu-id="c0830-255">8U5</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-256">JNA</span><span class="sxs-lookup"><span data-stu-id="c0830-256">JNA</span></span>    </td><td><span data-ttu-id="c0830-257">[JNA](https://github.com/twall/jna) </span><span class="sxs-lookup"><span data-stu-id="c0830-257">[JNA](https://github.com/twall/jna) </span></span></td><td> <span data-ttu-id="c0830-258">3.2.7</span><span class="sxs-lookup"><span data-stu-id="c0830-258">3.2.7</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-259">Cassandra</span><span class="sxs-lookup"><span data-stu-id="c0830-259">Cassandra</span></span></td><td>[<span data-ttu-id="c0830-260">Apache Cassandra 2.0.8</span><span class="sxs-lookup"><span data-stu-id="c0830-260">Apache Cassandra 2.0.8</span></span>](http://www.apache.org/dist/cassandra/2.0.8/apache-cassandra-2.0.8-bin.tar.gz)</td><td> <span data-ttu-id="c0830-261">2.0.8</span><span class="sxs-lookup"><span data-stu-id="c0830-261">2.0.8</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-262">Ubuntu</span><span class="sxs-lookup"><span data-stu-id="c0830-262">Ubuntu</span></span>    </td><td><span data-ttu-id="c0830-263">[Microsoft Azure](https://azure.microsoft.com/) </span><span class="sxs-lookup"><span data-stu-id="c0830-263">[Microsoft Azure](https://azure.microsoft.com/) </span></span></td><td><span data-ttu-id="c0830-264">14.04 LTS</span><span class="sxs-lookup"><span data-stu-id="c0830-264">14.04 LTS</span></span></td></tr>
</table>

<span data-ttu-id="c0830-265">由於下載 JRE 時需要手動接受 Oracle 授權，為了簡化部署，請將所有必要的軟體下載到桌面，稍後上傳到我們要建立來做為叢集部署初期使用的 Ubuntu 範本映像。</span><span class="sxs-lookup"><span data-stu-id="c0830-265">Since downloading of JRE requires manual acceptance of Oracle license, to simplify the deployment, download all the required software to the desktop for later uploading into the Ubuntu template image we will be creating as a precursor to the cluster deployment.</span></span>

<span data-ttu-id="c0830-266">將上述軟體下載到本機電腦上已知的下載目錄 (例如，Windows 上的 %TEMP%/downloads，或者大多數 Linux 散發套件或 Mac 上的 ~/Downloads)。</span><span class="sxs-lookup"><span data-stu-id="c0830-266">Download the above software into a well-known download directory (e.g. %TEMP%/downloads on Windows or ~/Downloads on most Linux distributions or Mac) on the local computer.</span></span>

### <a name="create-ubuntu-vm"></a><span data-ttu-id="c0830-267">建立 UBUNTU VM</span><span class="sxs-lookup"><span data-stu-id="c0830-267">CREATE UBUNTU VM</span></span>
<span data-ttu-id="c0830-268">在此步驟的程序中，我們將建立包含必要軟體的 Ubuntu 映像，讓映像可以重複用於佈建多個 Cassandra 節點。</span><span class="sxs-lookup"><span data-stu-id="c0830-268">In this step of the process we will create Ubuntu image with the pre-requisite software so that the image can be reused for provisioning several Cassandra nodes.</span></span>  

#### <a name="step-1-generate-ssh-key-pair"></a><span data-ttu-id="c0830-269">步驟 1：產生 SSH 金鑰組</span><span class="sxs-lookup"><span data-stu-id="c0830-269">STEP 1: Generate SSH key pair</span></span>
<span data-ttu-id="c0830-270">在佈建階段，Azure 需要 PEM 或 DER 編碼的 X509 公用金鑰。</span><span class="sxs-lookup"><span data-stu-id="c0830-270">Azure needs an X509 public key that is either PEM or DER encoded at the provisioning time.</span></span> <span data-ttu-id="c0830-271">請參考如何在 Azure 上使用 SSH 搭配 Linux (英文) 上的指示來產生公用/私密金鑰組。</span><span class="sxs-lookup"><span data-stu-id="c0830-271">Generate a public/private key pair using the instructions located at How to Use SSH with Linux on Azure.</span></span> <span data-ttu-id="c0830-272">如果您計劃在 Windows 或 Linux 上使用 putty.exe 做為 SSH 用戶端，您必須使用 puttygen.exe，將 PEM 編碼的 RSA 私密金鑰轉換為 PPK 格式。如需此操作的指示，請參閱上述網頁。</span><span class="sxs-lookup"><span data-stu-id="c0830-272">If you plan to use putty.exe as an SSH client either on Windows or Linux, you have to convert the PEM encoded RSA private key to PPK format using puttygen.exe; the instructions for this can be found in the above web page.</span></span>

#### <a name="step-2-create-ubuntu-template-vm"></a><span data-ttu-id="c0830-273">步驟 2：建立 Ubuntu 範本 VM</span><span class="sxs-lookup"><span data-stu-id="c0830-273">STEP 2: Create Ubuntu template VM</span></span>
<span data-ttu-id="c0830-274">若要建立範本 VM，請登入 Azure 傳統入口網站，並使用下列順序：依序按一下 [新增]、[計算]、[虛擬機器]、[從資源庫]、[UBUNTU]、[Ubuntu Server 14.04 LTS]，然後按一下向右箭號。</span><span class="sxs-lookup"><span data-stu-id="c0830-274">To create the template VM, log into the Azure classic portal and use the following sequence: Click NEW, COMPUTE, VIRTUAL MACHINE, FROM GALLERY, UBUNTU, Ubuntu Server 14.04 LTS, and then click the right arrow.</span></span> <span data-ttu-id="c0830-275">如需說明如何建立 Linux VM 的教學課程，請參閱建立執行 Linux 的虛擬機器 (英文)。</span><span class="sxs-lookup"><span data-stu-id="c0830-275">For a tutorial that describes how to create a Linux VM, see Create a Virtual Machine Running Linux.</span></span>

<span data-ttu-id="c0830-276">在 [虛擬機器設定] 的第 1 個畫面上輸入下列資訊：</span><span class="sxs-lookup"><span data-stu-id="c0830-276">Enter the following information on the “Virtual machine configuration” screen #1:</span></span>

<table>
<tr><th><span data-ttu-id="c0830-277">欄位名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-277">FIELD NAME</span></span>              </td><td>       <span data-ttu-id="c0830-278">欄位值</span><span class="sxs-lookup"><span data-stu-id="c0830-278">FIELD VALUE</span></span>               </td><td>         <span data-ttu-id="c0830-279">備註</span><span class="sxs-lookup"><span data-stu-id="c0830-279">REMARKS</span></span>                </td><tr>
<tr><td><span data-ttu-id="c0830-280">版本發行日期</span><span class="sxs-lookup"><span data-stu-id="c0830-280">VERSION RELEASE DATE</span></span>    </td><td> <span data-ttu-id="c0830-281">從下拉式清單選取日期</span><span class="sxs-lookup"><span data-stu-id="c0830-281">Select a date from the drop down</span></span></td><td></td><tr>
<tr><td><span data-ttu-id="c0830-282">[虛擬機器名稱]</span><span class="sxs-lookup"><span data-stu-id="c0830-282">VIRTUAL MACHINE NAME</span></span>    </td><td> <span data-ttu-id="c0830-283">cass-template</span><span class="sxs-lookup"><span data-stu-id="c0830-283">cass-template</span></span>                   </td><td> <span data-ttu-id="c0830-284">這是 VM 的主機名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-284">This is the hostname of the VM</span></span> </td><tr>
<tr><td><span data-ttu-id="c0830-285">層次</span><span class="sxs-lookup"><span data-stu-id="c0830-285">TIER</span></span>                     </td><td> <span data-ttu-id="c0830-286">標準</span><span class="sxs-lookup"><span data-stu-id="c0830-286">STANDARD</span></span>                           </td><td> <span data-ttu-id="c0830-287">保留預設值</span><span class="sxs-lookup"><span data-stu-id="c0830-287">Leave the default</span></span>              </td><tr>
<tr><td><span data-ttu-id="c0830-288">大小</span><span class="sxs-lookup"><span data-stu-id="c0830-288">SIZE</span></span>                     </td><td> <span data-ttu-id="c0830-289">A1</span><span class="sxs-lookup"><span data-stu-id="c0830-289">A1</span></span>                              </td><td><span data-ttu-id="c0830-290">根據 IO 需求選取 VM。針對此目的保留預設值</span><span class="sxs-lookup"><span data-stu-id="c0830-290">Select the VM based on the IO needs; for this purpose leave the default</span></span> </td><tr>
<tr><td> <span data-ttu-id="c0830-291">[新使用者名稱] 中</span><span class="sxs-lookup"><span data-stu-id="c0830-291">NEW USER NAME</span></span>             </td><td> <span data-ttu-id="c0830-292">localadmin</span><span class="sxs-lookup"><span data-stu-id="c0830-292">localadmin</span></span>                       </td><td> <span data-ttu-id="c0830-293">"admin" 在 Ubuntu 12.xx 以及更新版本中是保留的使用者名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-293">"admin" is a reserved user name in Ubuntu 12.xx and after</span></span></td><tr>
<tr><td> <span data-ttu-id="c0830-294">驗證</span><span class="sxs-lookup"><span data-stu-id="c0830-294">AUTHENTICATION</span></span>         </td><td> <span data-ttu-id="c0830-295">按一下核取方塊</span><span class="sxs-lookup"><span data-stu-id="c0830-295">Click check box</span></span>                 </td><td><span data-ttu-id="c0830-296">如果您想要以 SSH 金鑰確保安全，請核取此方塊</span><span class="sxs-lookup"><span data-stu-id="c0830-296">Check if you want to secure with an SSH key</span></span> </td><tr>
<tr><td> <span data-ttu-id="c0830-297">憑證</span><span class="sxs-lookup"><span data-stu-id="c0830-297">CERTIFICATE</span></span>             </td><td> <span data-ttu-id="c0830-298">公用金鑰憑證的檔案名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-298">file name of the public key certificate</span></span> </td><td> <span data-ttu-id="c0830-299">使用先前產生的公開金鑰</span><span class="sxs-lookup"><span data-stu-id="c0830-299">Use the public key generated previously</span></span></td><tr>
<tr><td> <span data-ttu-id="c0830-300">新密碼</span><span class="sxs-lookup"><span data-stu-id="c0830-300">New Password</span></span>    </td><td> <span data-ttu-id="c0830-301">強式密碼</span><span class="sxs-lookup"><span data-stu-id="c0830-301">strong password</span></span> </td><td> </td><tr>
<tr><td> <span data-ttu-id="c0830-302">確認密碼</span><span class="sxs-lookup"><span data-stu-id="c0830-302">Confirm Password</span></span>    </td><td> <span data-ttu-id="c0830-303">強式密碼</span><span class="sxs-lookup"><span data-stu-id="c0830-303">strong password</span></span> </td><td></td><tr>
</table>

<span data-ttu-id="c0830-304">在 [虛擬機器設定] 的第 2 個畫面上輸入下列資訊：</span><span class="sxs-lookup"><span data-stu-id="c0830-304">Enter the following information on the “Virtual machine configuration” screen #2:</span></span>

<table>
<tr><th><span data-ttu-id="c0830-305">欄位名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-305">FIELD NAME</span></span>             </th><th> <span data-ttu-id="c0830-306">欄位值</span><span class="sxs-lookup"><span data-stu-id="c0830-306">FIELD VALUE</span></span>                       </th><th> <span data-ttu-id="c0830-307">備註</span><span class="sxs-lookup"><span data-stu-id="c0830-307">REMARKS</span></span>                                 </th></tr>
<tr><td> <span data-ttu-id="c0830-308">雲端服務</span><span class="sxs-lookup"><span data-stu-id="c0830-308">CLOUD SERVICE</span></span>    </td><td> <span data-ttu-id="c0830-309">建立新的雲端服務</span><span class="sxs-lookup"><span data-stu-id="c0830-309">Create a new cloud service</span></span>    </td><td><span data-ttu-id="c0830-310">雲端服務是一個運算如虛擬機器等資源的容器</span><span class="sxs-lookup"><span data-stu-id="c0830-310">Cloud service is a container compute resources like virtual machines</span></span></td></tr>
<tr><td> <span data-ttu-id="c0830-311">雲端服務 DNS 名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-311">CLOUD SERVICE DNS NAME</span></span>    </td><td><span data-ttu-id="c0830-312">ubuntu-template.cloudapp.net</span><span class="sxs-lookup"><span data-stu-id="c0830-312">ubuntu-template.cloudapp.net</span></span>    </td><td><span data-ttu-id="c0830-313">提供一個機器中立的負載平衡器名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-313">Give a machine agnostic load balancer name</span></span></td></tr>
<tr><td> <span data-ttu-id="c0830-314">[區域/同質群組/虛擬網路]</span><span class="sxs-lookup"><span data-stu-id="c0830-314">REGION/AFFINITY GROUP/VIRTUAL NETWORK</span></span> </td><td>    <span data-ttu-id="c0830-315">美國西部</span><span class="sxs-lookup"><span data-stu-id="c0830-315">West US</span></span>    </td><td> <span data-ttu-id="c0830-316">選取您 Web 應用程式存取 Cassandra 叢集時的來源地區</span><span class="sxs-lookup"><span data-stu-id="c0830-316">Select a region from which your web applications access the Cassandra cluster</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-317">儲存體帳戶</span><span class="sxs-lookup"><span data-stu-id="c0830-317">STORAGE ACCOUNT</span></span> </td><td>    <span data-ttu-id="c0830-318">使用預設值</span><span class="sxs-lookup"><span data-stu-id="c0830-318">Use default</span></span>    </td><td><span data-ttu-id="c0830-319">使用預設的儲存體帳戶或在特定區域中預先建立的儲存體帳戶</span><span class="sxs-lookup"><span data-stu-id="c0830-319">Use the default storage account  or a pre-created storage account in a particular region</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-320">可用性集合</span><span class="sxs-lookup"><span data-stu-id="c0830-320">AVAILABILITY SET</span></span> </td><td>    <span data-ttu-id="c0830-321">None</span><span class="sxs-lookup"><span data-stu-id="c0830-321">None</span></span> </td><td>    <span data-ttu-id="c0830-322">保留為空白</span><span class="sxs-lookup"><span data-stu-id="c0830-322">Leave it blank</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-323">端點</span><span class="sxs-lookup"><span data-stu-id="c0830-323">ENDPOINTS</span></span>    </td><td><span data-ttu-id="c0830-324">使用預設值</span><span class="sxs-lookup"><span data-stu-id="c0830-324">Use default</span></span> </td><td>    <span data-ttu-id="c0830-325">使用預設的 SSH 設定</span><span class="sxs-lookup"><span data-stu-id="c0830-325">Use the default SSH configuration</span></span> </td></tr>
</table>

<span data-ttu-id="c0830-326">按一下向右箭號，保留第 3 個畫面上的預設值，然後按一下 [確認] 按鈕以完成 VM 佈建程序。</span><span class="sxs-lookup"><span data-stu-id="c0830-326">Click right arrow, leave the defaults on the screen #3 and click the “check” button to complete the VM provisioning process.</span></span> <span data-ttu-id="c0830-327">請稍候幾分鐘，名稱為 “ubuntu-template” 的 VM 應該會變成「執行中」狀態。</span><span class="sxs-lookup"><span data-stu-id="c0830-327">After a few minutes, the VM with the name “ubuntu-template” should be in a “running” status.</span></span>

### <a name="install-the-necessary-software"></a><span data-ttu-id="c0830-328">安裝必要軟體</span><span class="sxs-lookup"><span data-stu-id="c0830-328">INSTALL THE NECESSARY SOFTWARE</span></span>
#### <a name="step-1-upload-tarballs"></a><span data-ttu-id="c0830-329">步驟 1：上傳 tarball</span><span class="sxs-lookup"><span data-stu-id="c0830-329">STEP 1: Upload tarballs</span></span>
<span data-ttu-id="c0830-330">使用 scp 或 pscp，並使用下列命令格式將先前下載的軟體複製到 ~/downloads 目錄中：</span><span class="sxs-lookup"><span data-stu-id="c0830-330">Using scp or pscp, copy the previously downloaded software to ~/downloads directory using the following command format:</span></span>

##### <a name="pscp-server-jre-8u5-linux-x64targz-localadminhk-cas-templatecloudappnethomelocaladmindownloadsserver-jre-8u5-linux-x64targz"></a><span data-ttu-id="c0830-331">pscp server-jre-8u5-linux-x64.tar.gz localadmin@hk-cas-template.cloudapp.net:/home/localadmin/downloads/server-jre-8u5-linux-x64.tar.gz</span><span class="sxs-lookup"><span data-stu-id="c0830-331">pscp server-jre-8u5-linux-x64.tar.gz localadmin@hk-cas-template.cloudapp.net:/home/localadmin/downloads/server-jre-8u5-linux-x64.tar.gz</span></span>
<span data-ttu-id="c0830-332">針對 JRE 和 Cassandra 重複上述命令。</span><span class="sxs-lookup"><span data-stu-id="c0830-332">Repeat the above command for JRE as well as for the Cassandra bits.</span></span>

#### <a name="step-2-prepare-the-directory-structure-and-extract-the-archives"></a><span data-ttu-id="c0830-333">步驟 2：準備目錄結構並解壓縮封存</span><span class="sxs-lookup"><span data-stu-id="c0830-333">STEP 2: Prepare the directory structure and extract the archives</span></span>
<span data-ttu-id="c0830-334">登入 VM、建立目錄結構，然後以進階使用者的身分使用下列 bash 指令碼解壓縮軟體：</span><span class="sxs-lookup"><span data-stu-id="c0830-334">Log into the VM and create the directory structure and extract software as a super user using the bash script below:</span></span>

    #!/bin/bash
    CASS_INSTALL_DIR="/opt/cassandra"
    JRE_INSTALL_DIR="/opt/java"
    CASS_DATA_DIR="/var/lib/cassandra"
    CASS_LOG_DIR="/var/log/cassandra"
    DOWNLOADS_DIR="~/downloads"
    JRE_TARBALL="server-jre-8u5-linux-x64.tar.gz"
    CASS_TARBALL="apache-cassandra-2.0.8-bin.tar.gz"
    SVC_USER="localadmin"

    RESET_ERROR=1
    MKDIR_ERROR=2

    reset_installation ()
    {
       rm -rf $CASS_INSTALL_DIR 2> /dev/null
       rm -rf $JRE_INSTALL_DIR 2> /dev/null
       rm -rf $CASS_DATA_DIR 2> /dev/null
       rm -rf $CASS_LOG_DIR 2> /dev/null
    }
    make_dir ()
    {
       if [ -z "$1" ]
       then
          echo "make_dir: invalid directory name"
          exit $MKDIR_ERROR
       fi

       if [ -d "$1" ]
       then
          echo "make_dir: directory already exists"
          exit $MKDIR_ERROR
       fi

       mkdir $1 2>/dev/null
       if [ $? != 0 ]
       then
          echo "directory creation failed"
          exit $MKDIR_ERROR
       fi
    }

    unzip()
    {
       if [ $# == 2 ]
       then
          tar xzf $1 -C $2
       else
          echo "archive error"
       fi

    }

    if [ -n "$1" ]
    then
       SVC_USER=$1
    fi

    reset_installation
    make_dir $CASS_INSTALL_DIR
    make_dir $JRE_INSTALL_DIR
    make_dir $CASS_DATA_DIR
    make_dir $CASS_LOG_DIR

    #unzip JRE and Cassandra
    unzip $HOME/downloads/$JRE_TARBALL $JRE_INSTALL_DIR
    unzip $HOME/downloads/$CASS_TARBALL $CASS_INSTALL_DIR

    #Change the ownership to the service credentials

    chown -R $SVC_USER:$GROUP $CASS_DATA_DIR
    chown -R $SVC_USER:$GROUP $CASS_LOG_DIR
    echo "edit /etc/profile to add JRE to the PATH"
    echo "installation is complete"


<span data-ttu-id="c0830-335">如果您將此指令碼貼到 vim 視窗，請務必使用下列命令移除歸位字元 (‘\r”)：</span><span class="sxs-lookup"><span data-stu-id="c0830-335">If you paste this script into vim window, make sure to remove the carriage return (‘\r”) using the following command:</span></span>

    tr -d '\r' <infile.sh >outfile.sh

#### <a name="step-3-edit-etcprofile"></a><span data-ttu-id="c0830-336">步驟 3：編輯 etc/profile</span><span class="sxs-lookup"><span data-stu-id="c0830-336">Step 3: Edit etc/profile</span></span>
<span data-ttu-id="c0830-337">在結尾附加下列內容：</span><span class="sxs-lookup"><span data-stu-id="c0830-337">Append the following at the end:</span></span>

    JAVA_HOME=/opt/java/jdk1.8.0_05
    CASS_HOME= /opt/cassandra/apache-cassandra-2.0.8
    PATH=$PATH:$HOME/bin:$JAVA_HOME/bin:$CASS_HOME/bin
    export JAVA_HOME
    export CASS_HOME
    export PATH

#### <a name="step-4-install-jna-for-production-systems"></a><span data-ttu-id="c0830-338">步驟 4：安裝適用於實際執行系統的 JNA</span><span class="sxs-lookup"><span data-stu-id="c0830-338">Step 4: Install JNA for production systems</span></span>
<span data-ttu-id="c0830-339">使用下列命令序列：下列命令會將 jna-3.2.7.jar 和 jna-platform-3.2.7.jar 安裝到 /usr/share.java 目錄：sudo apt-get install libjna-java</span><span class="sxs-lookup"><span data-stu-id="c0830-339">Use the following command sequence: The following command will install jna-3.2.7.jar and jna-platform-3.2.7.jar to /usr/share.java directory sudo apt-get install libjna-java</span></span>

<span data-ttu-id="c0830-340">在 $CASS_HOME/lib 目錄中建立符號連結，以便 Cassandra 啟動指令碼可以找到這些 jar：</span><span class="sxs-lookup"><span data-stu-id="c0830-340">Create symbolic links in $CASS_HOME/lib directory so that Cassandra startup script can find these jars:</span></span>

    ln -s /usr/share/java/jna-3.2.7.jar $CASS_HOME/lib/jna.jar

    ln -s /usr/share/java/jna-platform-3.2.7.jar $CASS_HOME/lib/jna-platform.jar

#### <a name="step-5-configure-cassandrayaml"></a><span data-ttu-id="c0830-341">步驟 5：設定 cassandra.yaml</span><span class="sxs-lookup"><span data-stu-id="c0830-341">Step 5: Configure cassandra.yaml</span></span>
<span data-ttu-id="c0830-342">編輯每個 VM 的 cassandra.yaml 以反映所有虛擬機器所需的組態，[我們將在實際佈建期間調校此檔案]：</span><span class="sxs-lookup"><span data-stu-id="c0830-342">Edit cassandra.yaml on each VM to reflect configuration needed by all the virtual machines [we will tweak this during the actual provisioning]:</span></span>

<table>
<tr><th><span data-ttu-id="c0830-343">欄位名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-343">Field Name</span></span>   </th><th> <span data-ttu-id="c0830-344">值</span><span class="sxs-lookup"><span data-stu-id="c0830-344">Value</span></span>  </th><th>    <span data-ttu-id="c0830-345">備註</span><span class="sxs-lookup"><span data-stu-id="c0830-345">Remarks</span></span> </th></tr>
<tr><td><span data-ttu-id="c0830-346">cluster_name</span><span class="sxs-lookup"><span data-stu-id="c0830-346">cluster_name</span></span> </td><td>    <span data-ttu-id="c0830-347">“CustomerService”</span><span class="sxs-lookup"><span data-stu-id="c0830-347">“CustomerService”</span></span>    </td><td> <span data-ttu-id="c0830-348">使用能反映您部署的名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-348">Use the name that reflects your deployment</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-349">listen_address</span><span class="sxs-lookup"><span data-stu-id="c0830-349">listen_address</span></span>    </td><td><span data-ttu-id="c0830-350">[保留為空白]</span><span class="sxs-lookup"><span data-stu-id="c0830-350">[leave it blank]</span></span>    </td><td> <span data-ttu-id="c0830-351">刪除 “localhost”</span><span class="sxs-lookup"><span data-stu-id="c0830-351">Delete “localhost”</span></span> </td></tr>
<tr><td><span data-ttu-id="c0830-352">rpc_addres</span><span class="sxs-lookup"><span data-stu-id="c0830-352">rpc_addres</span></span>   </td><td><span data-ttu-id="c0830-353">[保留為空白]</span><span class="sxs-lookup"><span data-stu-id="c0830-353">[leave it blank]</span></span>    </td><td> <span data-ttu-id="c0830-354">刪除 “localhost”</span><span class="sxs-lookup"><span data-stu-id="c0830-354">Delete “localhost”</span></span> </td></tr>
<tr><td><span data-ttu-id="c0830-355">種子</span><span class="sxs-lookup"><span data-stu-id="c0830-355">seeds</span></span>    </td><td><span data-ttu-id="c0830-356">"10.1.2.4、10.1.2.6、10.1.2.8"</span><span class="sxs-lookup"><span data-stu-id="c0830-356">"10.1.2.4, 10.1.2.6, 10.1.2.8"</span></span>    </td><td><span data-ttu-id="c0830-357">指定為種子的所有 IP 位址清單。</span><span class="sxs-lookup"><span data-stu-id="c0830-357">List of  all the IP addresses which are designated as seeds.</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-358">endpoint_snitch</span><span class="sxs-lookup"><span data-stu-id="c0830-358">endpoint_snitch</span></span> </td><td> <span data-ttu-id="c0830-359">org.apache.cassandra.locator.GossipingPropertyFileSnitch</span><span class="sxs-lookup"><span data-stu-id="c0830-359">org.apache.cassandra.locator.GossipingPropertyFileSnitch</span></span> </td><td> <span data-ttu-id="c0830-360">由 NetworkTopologyStrateg 使用來表示資料中心和 VM 的機架</span><span class="sxs-lookup"><span data-stu-id="c0830-360">This is used by the NetworkTopologyStrateg for inferring the data center and the rack of the VM</span></span></td></tr>
</table>

#### <a name="step-6-capture-the-vm-image"></a><span data-ttu-id="c0830-361">步驟 6：擷取 VM 映像</span><span class="sxs-lookup"><span data-stu-id="c0830-361">Step 6: Capture the VM image</span></span>
<span data-ttu-id="c0830-362">使用先前建立的主機名稱 (hk-ca-template.cloudapp.net) 和 SSH 私密金鑰登入虛擬機器。</span><span class="sxs-lookup"><span data-stu-id="c0830-362">Log into the virtual machine using the hostname (hk-cas-template.cloudapp.net) and the SSH private key previously created.</span></span> <span data-ttu-id="c0830-363">請參閱「如何在 Azure 上使用 SSH 搭配 Linux」了解如何使用命令 ssh 或 putty.exe 登入的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="c0830-363">See How to Use SSH with Linux on Azure for details on how to log in using the command ssh or putty.exe.</span></span>

<span data-ttu-id="c0830-364">執行下列動作擷取映像：</span><span class="sxs-lookup"><span data-stu-id="c0830-364">Execute the following sequence of actions to capture the image:</span></span>

##### <a name="1-deprovision"></a><span data-ttu-id="c0830-365">1.取消佈建</span><span class="sxs-lookup"><span data-stu-id="c0830-365">1. Deprovision</span></span>
<span data-ttu-id="c0830-366">使用命令 “sudo waagent –deprovision+user” 移除虛擬機器執行個體的特定資訊。</span><span class="sxs-lookup"><span data-stu-id="c0830-366">Use the command “sudo waagent –deprovision+user” to remove Virtual Machine instance specific information.</span></span> <span data-ttu-id="c0830-367">請參閱 [如何擷取 Linux 虛擬機器作為範本使用](capture-image.md) ，以了解映像擷取程序的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="c0830-367">See for [How to Capture a Linux Virtual Machine](capture-image.md) to Use as a Template more details on the image capture process.</span></span>

##### <a name="2-shutdown-the-vm"></a><span data-ttu-id="c0830-368">2：將 VM 關機</span><span class="sxs-lookup"><span data-stu-id="c0830-368">2: Shutdown the VM</span></span>
<span data-ttu-id="c0830-369">確定已反白顯示虛擬機器，然後按一下底部命令列中的 [關機] 連結。</span><span class="sxs-lookup"><span data-stu-id="c0830-369">Make sure that the virtual machine is highlighted and click the SHUTDOWN link from the bottom command bar.</span></span>

##### <a name="3-capture-the-image"></a><span data-ttu-id="c0830-370">3：擷取映像</span><span class="sxs-lookup"><span data-stu-id="c0830-370">3: Capture the image</span></span>
<span data-ttu-id="c0830-371">確定已反白顯示虛擬機器，然後按一下底部命令列中的 [擷取] 連結。</span><span class="sxs-lookup"><span data-stu-id="c0830-371">Make sure that the virtual machine is highlighted and click the CAPTURE link from the bottom command bar.</span></span> <span data-ttu-id="c0830-372">在下一個畫面中，指定 [映像名稱] \(例如 hk-cas-2-08-ub-14-04-2014071)、適當的 [映像描述]，然後按一下「確認」記號以完成擷取程序。</span><span class="sxs-lookup"><span data-stu-id="c0830-372">In the next screen, give an IMAGE NAME (e.g. hk-cas-2-08-ub-14-04-2014071), appropriate IMAGE DESCRIPTION, and click the “check” mark to finish the CAPTURE process.</span></span>

<span data-ttu-id="c0830-373">這需要幾秒鐘的時間，然後您應該就可以在映像庫的 [我的映像] 區段中找到映像。</span><span class="sxs-lookup"><span data-stu-id="c0830-373">This will take a few seconds and the image should be available in MY IMAGES section of the image gallery.</span></span> <span data-ttu-id="c0830-374">成功擷取映像之後，來源 VM 就會自動刪除。</span><span class="sxs-lookup"><span data-stu-id="c0830-374">The source VM will be automatically deleted after the image is successfully captured.</span></span> 

## <a name="single-region-deployment-process"></a><span data-ttu-id="c0830-375">單一區域部署程序</span><span class="sxs-lookup"><span data-stu-id="c0830-375">Single Region Deployment Process</span></span>
<span data-ttu-id="c0830-376">**步驟 1：建立虛擬網路** 登入 Azure 入口網站，並使用下表中顯示的屬性，建立虛擬網路 (傳統)。</span><span class="sxs-lookup"><span data-stu-id="c0830-376">**Step 1: Create the Virtual Network** Log into the Azure portal and create a virtual network (classic) with the attributes shown in the following table.</span></span> <span data-ttu-id="c0830-377">如需程序的詳細步驟，請參閱[建立使用 Azure 入口網站的虛擬網路 (傳統)](../../../virtual-network/virtual-networks-create-vnet-classic-pportal.md)。</span><span class="sxs-lookup"><span data-stu-id="c0830-377">See [Create a virtual network (classic) using the Azure portal](../../../virtual-network/virtual-networks-create-vnet-classic-pportal.md) for detailed steps of the process.</span></span>      

<table>
<tr><th><span data-ttu-id="c0830-378">VM 屬性名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-378">VM Attribute Name</span></span></th><th><span data-ttu-id="c0830-379">值</span><span class="sxs-lookup"><span data-stu-id="c0830-379">Value</span></span></th><th><span data-ttu-id="c0830-380">備註</span><span class="sxs-lookup"><span data-stu-id="c0830-380">Remarks</span></span></th></tr>
<tr><td><span data-ttu-id="c0830-381">Name</span><span class="sxs-lookup"><span data-stu-id="c0830-381">Name</span></span></td><td><span data-ttu-id="c0830-382">vnet-cass-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-382">vnet-cass-west-us</span></span></td><td></td></tr>
<tr><td><span data-ttu-id="c0830-383">區域</span><span class="sxs-lookup"><span data-stu-id="c0830-383">Region</span></span></td><td><span data-ttu-id="c0830-384">美國西部</span><span class="sxs-lookup"><span data-stu-id="c0830-384">West US</span></span></td><td></td></tr>
<tr><td><span data-ttu-id="c0830-385">DNS 伺服器</span><span class="sxs-lookup"><span data-stu-id="c0830-385">DNS Servers</span></span></td><td><span data-ttu-id="c0830-386">None</span><span class="sxs-lookup"><span data-stu-id="c0830-386">None</span></span></td><td><span data-ttu-id="c0830-387">請忽略此項，因為我們不使用 DNS 伺服器</span><span class="sxs-lookup"><span data-stu-id="c0830-387">Ignore this as we are not using a DNS Server</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-388">位址空間</span><span class="sxs-lookup"><span data-stu-id="c0830-388">Address Space</span></span></td><td><span data-ttu-id="c0830-389">10.1.0.0/16</span><span class="sxs-lookup"><span data-stu-id="c0830-389">10.1.0.0/16</span></span></td><td></td></tr>    
<tr><td><span data-ttu-id="c0830-390">起始 IP</span><span class="sxs-lookup"><span data-stu-id="c0830-390">Starting IP</span></span></td><td><span data-ttu-id="c0830-391">10.1.0.0</span><span class="sxs-lookup"><span data-stu-id="c0830-391">10.1.0.0</span></span></td><td></td></tr>    
<tr><td><span data-ttu-id="c0830-392">CIDR</span><span class="sxs-lookup"><span data-stu-id="c0830-392">CIDR</span></span> </td><td><span data-ttu-id="c0830-393">/16 (65531)</span><span class="sxs-lookup"><span data-stu-id="c0830-393">/16 (65531)</span></span></td><td></td></tr>
</table>

<span data-ttu-id="c0830-394">新增下列子網路：</span><span class="sxs-lookup"><span data-stu-id="c0830-394">Add the following subnets:</span></span>

<table>
<tr><th><span data-ttu-id="c0830-395">Name</span><span class="sxs-lookup"><span data-stu-id="c0830-395">Name</span></span></th><th><span data-ttu-id="c0830-396">起始 IP</span><span class="sxs-lookup"><span data-stu-id="c0830-396">Starting IP</span></span></th><th><span data-ttu-id="c0830-397">CIDR</span><span class="sxs-lookup"><span data-stu-id="c0830-397">CIDR</span></span></th><th><span data-ttu-id="c0830-398">備註</span><span class="sxs-lookup"><span data-stu-id="c0830-398">Remarks</span></span></th></tr>
<tr><td><span data-ttu-id="c0830-399">Web</span><span class="sxs-lookup"><span data-stu-id="c0830-399">web</span></span></td><td><span data-ttu-id="c0830-400">10.1.1.0</span><span class="sxs-lookup"><span data-stu-id="c0830-400">10.1.1.0</span></span></td><td><span data-ttu-id="c0830-401">/24 (251)</span><span class="sxs-lookup"><span data-stu-id="c0830-401">/24 (251)</span></span></td><td><span data-ttu-id="c0830-402">Web 伺服陣列的子網路</span><span class="sxs-lookup"><span data-stu-id="c0830-402">Subnet for the web farm</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-403">data</span><span class="sxs-lookup"><span data-stu-id="c0830-403">data</span></span></td><td><span data-ttu-id="c0830-404">10.1.2.0</span><span class="sxs-lookup"><span data-stu-id="c0830-404">10.1.2.0</span></span></td><td><span data-ttu-id="c0830-405">/24 (251)</span><span class="sxs-lookup"><span data-stu-id="c0830-405">/24 (251)</span></span></td><td><span data-ttu-id="c0830-406">資料庫節點的子網路</span><span class="sxs-lookup"><span data-stu-id="c0830-406">Subnet for the database nodes</span></span></td></tr>
</table>

<span data-ttu-id="c0830-407">透過網路安全性群組可保護「資料」與 Web 子網路，但這已超出本文的討論範圍。</span><span class="sxs-lookup"><span data-stu-id="c0830-407">Data and Web subnets can be protected through network security groups the coverage of which is out of scope for this article.</span></span>  

<span data-ttu-id="c0830-408">**步驟 2：佈建虛擬網路** 使用先前建立的映像，我們將在雲端伺服器 “hk-c-svc-west” 中建立下列虛擬機器，並將它們繫結到個別的子網路，如下所示：</span><span class="sxs-lookup"><span data-stu-id="c0830-408">**Step 2: Provision Virtual Machines** Using the image created previously, we will create the following virtual machines in the cloud server “hk-c-svc-west” and bind them to the respective subnets as shown below:</span></span>

<table>
<tr><th><span data-ttu-id="c0830-409">機器名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-409">Machine Name</span></span>    </th><th><span data-ttu-id="c0830-410">子網路</span><span class="sxs-lookup"><span data-stu-id="c0830-410">Subnet</span></span>    </th><th><span data-ttu-id="c0830-411">IP 位址</span><span class="sxs-lookup"><span data-stu-id="c0830-411">IP Address</span></span>    </th><th><span data-ttu-id="c0830-412">可用性集合</span><span class="sxs-lookup"><span data-stu-id="c0830-412">Availability set</span></span></th><th><span data-ttu-id="c0830-413">DC/機架</span><span class="sxs-lookup"><span data-stu-id="c0830-413">DC/Rack</span></span></th><th><span data-ttu-id="c0830-414">是否為種子？</span><span class="sxs-lookup"><span data-stu-id="c0830-414">Seed?</span></span></th></tr>
<tr><td><span data-ttu-id="c0830-415">hk-c1-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-415">hk-c1-west-us</span></span>    </td><td><span data-ttu-id="c0830-416">data</span><span class="sxs-lookup"><span data-stu-id="c0830-416">data</span></span>    </td><td><span data-ttu-id="c0830-417">10.1.2.4</span><span class="sxs-lookup"><span data-stu-id="c0830-417">10.1.2.4</span></span>    </td><td><span data-ttu-id="c0830-418">hk-c-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-418">hk-c-aset-1</span></span>    </td><td><span data-ttu-id="c0830-419">dc=WESTUS 機架=rack1</span><span class="sxs-lookup"><span data-stu-id="c0830-419">dc =WESTUS rack =rack1</span></span> </td><td><span data-ttu-id="c0830-420">是</span><span class="sxs-lookup"><span data-stu-id="c0830-420">Yes</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-421">hk-c2-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-421">hk-c2-west-us</span></span>    </td><td><span data-ttu-id="c0830-422">data</span><span class="sxs-lookup"><span data-stu-id="c0830-422">data</span></span>    </td><td><span data-ttu-id="c0830-423">10.1.2.5</span><span class="sxs-lookup"><span data-stu-id="c0830-423">10.1.2.5</span></span>    </td><td><span data-ttu-id="c0830-424">hk-c-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-424">hk-c-aset-1</span></span>    </td><td><span data-ttu-id="c0830-425">dc=WESTUS 機架=rack1</span><span class="sxs-lookup"><span data-stu-id="c0830-425">dc =WESTUS rack =rack1</span></span>    </td><td><span data-ttu-id="c0830-426">否</span><span class="sxs-lookup"><span data-stu-id="c0830-426">No</span></span> </td></tr>
<tr><td><span data-ttu-id="c0830-427">hk-c3-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-427">hk-c3-west-us</span></span>    </td><td><span data-ttu-id="c0830-428">data</span><span class="sxs-lookup"><span data-stu-id="c0830-428">data</span></span>    </td><td><span data-ttu-id="c0830-429">10.1.2.6</span><span class="sxs-lookup"><span data-stu-id="c0830-429">10.1.2.6</span></span>    </td><td><span data-ttu-id="c0830-430">hk-c-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-430">hk-c-aset-1</span></span>    </td><td><span data-ttu-id="c0830-431">dc=WESTUS 機架=rack2</span><span class="sxs-lookup"><span data-stu-id="c0830-431">dc =WESTUS rack =rack2</span></span>    </td><td><span data-ttu-id="c0830-432">是</span><span class="sxs-lookup"><span data-stu-id="c0830-432">Yes</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-433">hk-c4-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-433">hk-c4-west-us</span></span>    </td><td><span data-ttu-id="c0830-434">data</span><span class="sxs-lookup"><span data-stu-id="c0830-434">data</span></span>    </td><td><span data-ttu-id="c0830-435">10.1.2.7</span><span class="sxs-lookup"><span data-stu-id="c0830-435">10.1.2.7</span></span>    </td><td><span data-ttu-id="c0830-436">hk-c-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-436">hk-c-aset-1</span></span>    </td><td><span data-ttu-id="c0830-437">dc=WESTUS 機架=rack2</span><span class="sxs-lookup"><span data-stu-id="c0830-437">dc =WESTUS rack =rack2</span></span>    </td><td><span data-ttu-id="c0830-438">否</span><span class="sxs-lookup"><span data-stu-id="c0830-438">No</span></span> </td></tr>
<tr><td><span data-ttu-id="c0830-439">hk-c5-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-439">hk-c5-west-us</span></span>    </td><td><span data-ttu-id="c0830-440">data</span><span class="sxs-lookup"><span data-stu-id="c0830-440">data</span></span>    </td><td><span data-ttu-id="c0830-441">10.1.2.8</span><span class="sxs-lookup"><span data-stu-id="c0830-441">10.1.2.8</span></span>    </td><td><span data-ttu-id="c0830-442">hk-c-aset-2</span><span class="sxs-lookup"><span data-stu-id="c0830-442">hk-c-aset-2</span></span>    </td><td><span data-ttu-id="c0830-443">dc=WESTUS 機架=rack3</span><span class="sxs-lookup"><span data-stu-id="c0830-443">dc =WESTUS rack =rack3</span></span>    </td><td><span data-ttu-id="c0830-444">是</span><span class="sxs-lookup"><span data-stu-id="c0830-444">Yes</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-445">hk-c6-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-445">hk-c6-west-us</span></span>    </td><td><span data-ttu-id="c0830-446">data</span><span class="sxs-lookup"><span data-stu-id="c0830-446">data</span></span>    </td><td><span data-ttu-id="c0830-447">10.1.2.9</span><span class="sxs-lookup"><span data-stu-id="c0830-447">10.1.2.9</span></span>    </td><td><span data-ttu-id="c0830-448">hk-c-aset-2</span><span class="sxs-lookup"><span data-stu-id="c0830-448">hk-c-aset-2</span></span>    </td><td><span data-ttu-id="c0830-449">dc=WESTUS 機架=rack3</span><span class="sxs-lookup"><span data-stu-id="c0830-449">dc =WESTUS rack =rack3</span></span>    </td><td><span data-ttu-id="c0830-450">否</span><span class="sxs-lookup"><span data-stu-id="c0830-450">No</span></span> </td></tr>
<tr><td><span data-ttu-id="c0830-451">hk-c7-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-451">hk-c7-west-us</span></span>    </td><td><span data-ttu-id="c0830-452">data</span><span class="sxs-lookup"><span data-stu-id="c0830-452">data</span></span>    </td><td><span data-ttu-id="c0830-453">10.1.2.10</span><span class="sxs-lookup"><span data-stu-id="c0830-453">10.1.2.10</span></span>    </td><td><span data-ttu-id="c0830-454">hk-c-aset-2</span><span class="sxs-lookup"><span data-stu-id="c0830-454">hk-c-aset-2</span></span>    </td><td><span data-ttu-id="c0830-455">dc=WESTUS 機架=rack4</span><span class="sxs-lookup"><span data-stu-id="c0830-455">dc =WESTUS rack =rack4</span></span>    </td><td><span data-ttu-id="c0830-456">是</span><span class="sxs-lookup"><span data-stu-id="c0830-456">Yes</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-457">hk-c8-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-457">hk-c8-west-us</span></span>    </td><td><span data-ttu-id="c0830-458">data</span><span class="sxs-lookup"><span data-stu-id="c0830-458">data</span></span>    </td><td><span data-ttu-id="c0830-459">10.1.2.11</span><span class="sxs-lookup"><span data-stu-id="c0830-459">10.1.2.11</span></span>    </td><td><span data-ttu-id="c0830-460">hk-c-aset-2</span><span class="sxs-lookup"><span data-stu-id="c0830-460">hk-c-aset-2</span></span>    </td><td><span data-ttu-id="c0830-461">dc=WESTUS 機架=rack4</span><span class="sxs-lookup"><span data-stu-id="c0830-461">dc =WESTUS rack =rack4</span></span>    </td><td><span data-ttu-id="c0830-462">否</span><span class="sxs-lookup"><span data-stu-id="c0830-462">No</span></span> </td></tr>
<tr><td><span data-ttu-id="c0830-463">hk-w1-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-463">hk-w1-west-us</span></span>    </td><td><span data-ttu-id="c0830-464">Web</span><span class="sxs-lookup"><span data-stu-id="c0830-464">web</span></span>    </td><td><span data-ttu-id="c0830-465">10.1.1.4</span><span class="sxs-lookup"><span data-stu-id="c0830-465">10.1.1.4</span></span>    </td><td><span data-ttu-id="c0830-466">hk-w-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-466">hk-w-aset-1</span></span>    </td><td>                       </td><td><span data-ttu-id="c0830-467">N/A</span><span class="sxs-lookup"><span data-stu-id="c0830-467">N/A</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-468">hk-w2-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-468">hk-w2-west-us</span></span>    </td><td><span data-ttu-id="c0830-469">Web</span><span class="sxs-lookup"><span data-stu-id="c0830-469">web</span></span>    </td><td><span data-ttu-id="c0830-470">10.1.1.5</span><span class="sxs-lookup"><span data-stu-id="c0830-470">10.1.1.5</span></span>    </td><td><span data-ttu-id="c0830-471">hk-w-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-471">hk-w-aset-1</span></span>    </td><td>                       </td><td><span data-ttu-id="c0830-472">N/A</span><span class="sxs-lookup"><span data-stu-id="c0830-472">N/A</span></span></td></tr>
</table>

<span data-ttu-id="c0830-473">建立上述 VM 清單需要下列程序：</span><span class="sxs-lookup"><span data-stu-id="c0830-473">Creation of the above list of VMs requires the following process:</span></span>

1. <span data-ttu-id="c0830-474">在特定區域中建立空的雲端服務</span><span class="sxs-lookup"><span data-stu-id="c0830-474">Create an empty cloud service in a particular region</span></span>
2. <span data-ttu-id="c0830-475">從先前擷取的映像建立 VM，並將它附加到先前建立的虛擬網路，然後對所有 VM 重複此步驟</span><span class="sxs-lookup"><span data-stu-id="c0830-475">Create a VM from the previously captured image and attach it to the virtual network created previously; repeat this for all the VMs</span></span>
3. <span data-ttu-id="c0830-476">將內部負載平衡器加入雲端服務，並將它附加到「資料」子網路</span><span class="sxs-lookup"><span data-stu-id="c0830-476">Add an internal load balancer to the cloud service and attach it to the “data” subnet</span></span>
4. <span data-ttu-id="c0830-477">對先前建立的每個 VM，透過連線到先前建立之內部負載平衡器的負載平衡集，新增 thrift 流量的負載平衡端點</span><span class="sxs-lookup"><span data-stu-id="c0830-477">For each VM created previously, add a load balanced endpoint for thrift traffic through a load balanced set connected to the previously created internal load balancer</span></span>

<span data-ttu-id="c0830-478">您可以使用 Azure 傳統入口網站執行上述程序；使用 Windows 電腦 (如果您沒有 Windows 電腦的存取權，則使用 Azure 上的 VM)，使用下列 PowerShell 指令碼自動佈建所有 8 個 VM。</span><span class="sxs-lookup"><span data-stu-id="c0830-478">The above process can be executed using Azure classic portal; use a Windows machine (use a VM on Azure if you don't have access to a Windows machine), use the following PowerShell script to provision all 8 VMs automatically.</span></span>

<span data-ttu-id="c0830-479">**清單 1：佈建虛擬機器的 PowerShell 指令碼**</span><span class="sxs-lookup"><span data-stu-id="c0830-479">**List 1: PowerShell script for provisioning virtual machines**</span></span>

        #Tested with Azure Powershell - November 2014
        #This powershell script deployes a number of VMs from an existing image inside an Azure region
        #Import your Azure subscription into the current Powershell session before proceeding
        #The process: 1. create Azure Storage account, 2. create virtual network, 3.create the VM template, 2. crate a list of VMs from the template

        #fundamental variables - change these to reflect your subscription
        $country="us"; $region="west"; $vnetName = "your_vnet_name";$storageAccount="your_storage_account"
        $numVMs=8;$prefix = "hk-cass";$ilbIP="your_ilb_ip"
        $subscriptionName = "Azure_subscription_name";
        $vmSize="ExtraSmall"; $imageName="your_linux_image_name"
        $ilbName="ThriftInternalLB"; $thriftEndPoint="ThriftEndPoint"

        #generated variables
        $serviceName = "$prefix-svc-$region-$country"; $azureRegion = "$region $country"

        $vmNames = @()
        for ($i=0; $i -lt $numVMs; $i++)
        {
           $vmNames+=("$prefix-vm"+($i+1) + "-$region-$country" );
        }

        #select an Azure subscription already imported into Powershell session
        Select-AzureSubscription -SubscriptionName $subscriptionName -Current
        Set-AzureSubscription -SubscriptionName $subscriptionName -CurrentStorageAccountName $storageAccount

        #create an empty cloud service
        New-AzureService -ServiceName $serviceName -Label "hkcass$region" -Location $azureRegion
        Write-Host "Created $serviceName"

        $VMList= @()   # stores the list of azure vm configuration objects
        #create the list of VMs
        foreach($vmName in $vmNames)
        {
           $VMList += New-AzureVMConfig -Name $vmName -InstanceSize ExtraSmall -ImageName $imageName |
           Add-AzureProvisioningConfig -Linux -LinuxUser "localadmin" -Password "Local123" |
           Set-AzureSubnet "data"
        }

        New-AzureVM -ServiceName $serviceName -VNetName $vnetName -VMs $VMList

        #Create internal load balancer
        Add-AzureInternalLoadBalancer -ServiceName $serviceName -InternalLoadBalancerName $ilbName -SubnetName "data" -StaticVNetIPAddress "$ilbIP"
        Write-Host "Created $ilbName"
        #Add add the thrift endpoint to the internal load balancer for all the VMs
        foreach($vmName in $vmNames)
        {
            Get-AzureVM -ServiceName $serviceName -Name $vmName |
                Add-AzureEndpoint -Name $thriftEndPoint -LBSetName "ThriftLBSet" -Protocol tcp -LocalPort 9160 -PublicPort 9160 -ProbePort 9160 -ProbeProtocol tcp -ProbeIntervalInSeconds 10 -InternalLoadBalancerName $ilbName |
                Update-AzureVM

            Write-Host "created $vmName"     
        }

<span data-ttu-id="c0830-480">**步驟 3：在每個 VM 上設定 Cassandra**</span><span class="sxs-lookup"><span data-stu-id="c0830-480">**Step 3: Configure Cassandra on each VM**</span></span>

<span data-ttu-id="c0830-481">登入 VM 並執行下列項目：</span><span class="sxs-lookup"><span data-stu-id="c0830-481">Log into the VM and perform the following:</span></span>

* <span data-ttu-id="c0830-482">編輯 $CASS_HOME/conf/cassandra-rackdc.properties 指定資料中心和機架內容：</span><span class="sxs-lookup"><span data-stu-id="c0830-482">Edit $CASS_HOME/conf/cassandra-rackdc.properties to specify the data center and rack properties:</span></span>
  
       dc =EASTUS, rack =rack1
* <span data-ttu-id="c0830-483">編輯 cassandra.yaml 設定種子節點，如下所示：</span><span class="sxs-lookup"><span data-stu-id="c0830-483">Edit cassandra.yaml to configure seed nodes as below:</span></span>
  
       Seeds: "10.1.2.4,10.1.2.6,10.1.2.8,10.1.2.10"

<span data-ttu-id="c0830-484">**步驟 4：啟動 VM，然後測試叢集**</span><span class="sxs-lookup"><span data-stu-id="c0830-484">**Step 4: Start the VMs and test the cluster**</span></span>

<span data-ttu-id="c0830-485">登入其中一個節點 (例如 hk-c1-west-us)，然後執行下列命令查看叢集的狀態：</span><span class="sxs-lookup"><span data-stu-id="c0830-485">Log into one of the nodes (e.g. hk-c1-west-us) and run the following command to see the status of the cluster:</span></span>

       nodetool –h 10.1.2.4 –p 7199 status

<span data-ttu-id="c0830-486">您應該會看到類似下面 8 節點叢集的畫面：</span><span class="sxs-lookup"><span data-stu-id="c0830-486">You should see the display similar to the one below for an 8-node cluster:</span></span>

<table>
<tr><th><span data-ttu-id="c0830-487">狀態</span><span class="sxs-lookup"><span data-stu-id="c0830-487">Status</span></span></th><th><span data-ttu-id="c0830-488">位址</span><span class="sxs-lookup"><span data-stu-id="c0830-488">Address</span></span>    </th><th><span data-ttu-id="c0830-489">載入</span><span class="sxs-lookup"><span data-stu-id="c0830-489">Load</span></span>    </th><th><span data-ttu-id="c0830-490">權杖</span><span class="sxs-lookup"><span data-stu-id="c0830-490">Tokens</span></span>    </th><th><span data-ttu-id="c0830-491">擁有</span><span class="sxs-lookup"><span data-stu-id="c0830-491">Owns</span></span> </th><th><span data-ttu-id="c0830-492">主機識別碼</span><span class="sxs-lookup"><span data-stu-id="c0830-492">Host ID</span></span>    </th><th><span data-ttu-id="c0830-493">機架</span><span class="sxs-lookup"><span data-stu-id="c0830-493">Rack</span></span></th></tr>
<tr><th><span data-ttu-id="c0830-494">UN</span><span class="sxs-lookup"><span data-stu-id="c0830-494">UN</span></span>    </td><td><span data-ttu-id="c0830-495">10.1.2.4</span><span class="sxs-lookup"><span data-stu-id="c0830-495">10.1.2.4</span></span>     </td><td><span data-ttu-id="c0830-496">87.81 KB</span><span class="sxs-lookup"><span data-stu-id="c0830-496">87.81 KB</span></span>    </td><td><span data-ttu-id="c0830-497">256</span><span class="sxs-lookup"><span data-stu-id="c0830-497">256</span></span>    </td><td><span data-ttu-id="c0830-498">38.0%</span><span class="sxs-lookup"><span data-stu-id="c0830-498">38.0%</span></span>    </td><td><span data-ttu-id="c0830-499">Guid (已移除)</span><span class="sxs-lookup"><span data-stu-id="c0830-499">Guid (removed)</span></span></td><td><span data-ttu-id="c0830-500">rack1</span><span class="sxs-lookup"><span data-stu-id="c0830-500">rack1</span></span></td></tr>
<tr><th><span data-ttu-id="c0830-501">UN</span><span class="sxs-lookup"><span data-stu-id="c0830-501">UN</span></span>    </td><td><span data-ttu-id="c0830-502">10.1.2.5</span><span class="sxs-lookup"><span data-stu-id="c0830-502">10.1.2.5</span></span>     </td><td><span data-ttu-id="c0830-503">41.08 KB</span><span class="sxs-lookup"><span data-stu-id="c0830-503">41.08 KB</span></span>    </td><td><span data-ttu-id="c0830-504">256</span><span class="sxs-lookup"><span data-stu-id="c0830-504">256</span></span>    </td><td><span data-ttu-id="c0830-505">68.9%</span><span class="sxs-lookup"><span data-stu-id="c0830-505">68.9%</span></span>    </td><td><span data-ttu-id="c0830-506">Guid (已移除)</span><span class="sxs-lookup"><span data-stu-id="c0830-506">Guid (removed)</span></span></td><td><span data-ttu-id="c0830-507">rack1</span><span class="sxs-lookup"><span data-stu-id="c0830-507">rack1</span></span></td></tr>
<tr><th><span data-ttu-id="c0830-508">UN</span><span class="sxs-lookup"><span data-stu-id="c0830-508">UN</span></span>    </td><td><span data-ttu-id="c0830-509">10.1.2.6</span><span class="sxs-lookup"><span data-stu-id="c0830-509">10.1.2.6</span></span>     </td><td><span data-ttu-id="c0830-510">55.29 KB</span><span class="sxs-lookup"><span data-stu-id="c0830-510">55.29 KB</span></span>    </td><td><span data-ttu-id="c0830-511">256</span><span class="sxs-lookup"><span data-stu-id="c0830-511">256</span></span>    </td><td><span data-ttu-id="c0830-512">68.8%</span><span class="sxs-lookup"><span data-stu-id="c0830-512">68.8%</span></span>    </td><td><span data-ttu-id="c0830-513">Guid (已移除)</span><span class="sxs-lookup"><span data-stu-id="c0830-513">Guid (removed)</span></span></td><td><span data-ttu-id="c0830-514">rack2</span><span class="sxs-lookup"><span data-stu-id="c0830-514">rack2</span></span></td></tr>
<tr><th><span data-ttu-id="c0830-515">UN</span><span class="sxs-lookup"><span data-stu-id="c0830-515">UN</span></span>    </td><td><span data-ttu-id="c0830-516">10.1.2.7</span><span class="sxs-lookup"><span data-stu-id="c0830-516">10.1.2.7</span></span>     </td><td><span data-ttu-id="c0830-517">55.29 KB</span><span class="sxs-lookup"><span data-stu-id="c0830-517">55.29 KB</span></span>    </td><td><span data-ttu-id="c0830-518">256</span><span class="sxs-lookup"><span data-stu-id="c0830-518">256</span></span>    </td><td><span data-ttu-id="c0830-519">68.8%</span><span class="sxs-lookup"><span data-stu-id="c0830-519">68.8%</span></span>    </td><td><span data-ttu-id="c0830-520">Guid (已移除)</span><span class="sxs-lookup"><span data-stu-id="c0830-520">Guid (removed)</span></span></td><td><span data-ttu-id="c0830-521">rack2</span><span class="sxs-lookup"><span data-stu-id="c0830-521">rack2</span></span></td></tr>
<tr><th><span data-ttu-id="c0830-522">UN</span><span class="sxs-lookup"><span data-stu-id="c0830-522">UN</span></span>    </td><td><span data-ttu-id="c0830-523">10.1.2.8</span><span class="sxs-lookup"><span data-stu-id="c0830-523">10.1.2.8</span></span>     </td><td><span data-ttu-id="c0830-524">55.29 KB</span><span class="sxs-lookup"><span data-stu-id="c0830-524">55.29 KB</span></span>    </td><td><span data-ttu-id="c0830-525">256</span><span class="sxs-lookup"><span data-stu-id="c0830-525">256</span></span>    </td><td><span data-ttu-id="c0830-526">68.8%</span><span class="sxs-lookup"><span data-stu-id="c0830-526">68.8%</span></span>    </td><td><span data-ttu-id="c0830-527">Guid (已移除)</span><span class="sxs-lookup"><span data-stu-id="c0830-527">Guid (removed)</span></span></td><td><span data-ttu-id="c0830-528">rack3</span><span class="sxs-lookup"><span data-stu-id="c0830-528">rack3</span></span></td></tr>
<tr><th><span data-ttu-id="c0830-529">UN</span><span class="sxs-lookup"><span data-stu-id="c0830-529">UN</span></span>    </td><td><span data-ttu-id="c0830-530">10.1.2.9</span><span class="sxs-lookup"><span data-stu-id="c0830-530">10.1.2.9</span></span>     </td><td><span data-ttu-id="c0830-531">55.29 KB</span><span class="sxs-lookup"><span data-stu-id="c0830-531">55.29 KB</span></span>    </td><td><span data-ttu-id="c0830-532">256</span><span class="sxs-lookup"><span data-stu-id="c0830-532">256</span></span>    </td><td><span data-ttu-id="c0830-533">68.8%</span><span class="sxs-lookup"><span data-stu-id="c0830-533">68.8%</span></span>    </td><td><span data-ttu-id="c0830-534">Guid (已移除)</span><span class="sxs-lookup"><span data-stu-id="c0830-534">Guid (removed)</span></span></td><td><span data-ttu-id="c0830-535">rack3</span><span class="sxs-lookup"><span data-stu-id="c0830-535">rack3</span></span></td></tr>
<tr><th><span data-ttu-id="c0830-536">UN</span><span class="sxs-lookup"><span data-stu-id="c0830-536">UN</span></span>    </td><td><span data-ttu-id="c0830-537">10.1.2.10</span><span class="sxs-lookup"><span data-stu-id="c0830-537">10.1.2.10</span></span>     </td><td><span data-ttu-id="c0830-538">55.29 KB</span><span class="sxs-lookup"><span data-stu-id="c0830-538">55.29 KB</span></span>    </td><td><span data-ttu-id="c0830-539">256</span><span class="sxs-lookup"><span data-stu-id="c0830-539">256</span></span>    </td><td><span data-ttu-id="c0830-540">68.8%</span><span class="sxs-lookup"><span data-stu-id="c0830-540">68.8%</span></span>    </td><td><span data-ttu-id="c0830-541">Guid (已移除)</span><span class="sxs-lookup"><span data-stu-id="c0830-541">Guid (removed)</span></span></td><td><span data-ttu-id="c0830-542">rack4</span><span class="sxs-lookup"><span data-stu-id="c0830-542">rack4</span></span></td></tr>
<tr><th><span data-ttu-id="c0830-543">UN</span><span class="sxs-lookup"><span data-stu-id="c0830-543">UN</span></span>    </td><td><span data-ttu-id="c0830-544">10.1.2.11</span><span class="sxs-lookup"><span data-stu-id="c0830-544">10.1.2.11</span></span>     </td><td><span data-ttu-id="c0830-545">55.29 KB</span><span class="sxs-lookup"><span data-stu-id="c0830-545">55.29 KB</span></span>    </td><td><span data-ttu-id="c0830-546">256</span><span class="sxs-lookup"><span data-stu-id="c0830-546">256</span></span>    </td><td><span data-ttu-id="c0830-547">68.8%</span><span class="sxs-lookup"><span data-stu-id="c0830-547">68.8%</span></span>    </td><td><span data-ttu-id="c0830-548">Guid (已移除)</span><span class="sxs-lookup"><span data-stu-id="c0830-548">Guid (removed)</span></span></td><td><span data-ttu-id="c0830-549">rack4</span><span class="sxs-lookup"><span data-stu-id="c0830-549">rack4</span></span></td></tr>
</table>

## <a name="test-the-single-region-cluster"></a><span data-ttu-id="c0830-550">測試單一區域叢集</span><span class="sxs-lookup"><span data-stu-id="c0830-550">Test the Single Region Cluster</span></span>
<span data-ttu-id="c0830-551">使用下列步驟測試叢集：</span><span class="sxs-lookup"><span data-stu-id="c0830-551">Use the following steps to test the cluster:</span></span>

1. <span data-ttu-id="c0830-552">使用 Powershell 命令 Get-AzureInternalLoadbalancer Cmdlet 取得內部負載平衡器的 IP 位址 (例如 10.1.2.101)。</span><span class="sxs-lookup"><span data-stu-id="c0830-552">Using the Powershell command Get-AzureInternalLoadbalancer commandlet, obtain the IP address of the internal load balancer (e.g.  10.1.2.101).</span></span> <span data-ttu-id="c0830-553">命令的語法如下所示：Get-AzureLoadbalancer –ServiceName "hk-c-svc-west-us” [顯示內部負載平衡器以及其 IP 位址的詳細資訊]</span><span class="sxs-lookup"><span data-stu-id="c0830-553">The syntax of the command is shown below: Get-AzureLoadbalancer –ServiceName "hk-c-svc-west-us” [displays the details of the internal load balancer along with its IP address]</span></span>
2. <span data-ttu-id="c0830-554">使用 Putty 或 ssh 登入 Web 伺服陣列 VM (例如 hk-w1-west-us)</span><span class="sxs-lookup"><span data-stu-id="c0830-554">Log into the web farm VM (e.g. hk-w1-west-us) using Putty or ssh</span></span>
3. <span data-ttu-id="c0830-555">執行 $CASS_HOME/bin/cqlsh 10.1.2.101 9160</span><span class="sxs-lookup"><span data-stu-id="c0830-555">Execute $CASS_HOME/bin/cqlsh 10.1.2.101 9160</span></span>
4. <span data-ttu-id="c0830-556">使用下列 CQL 命令來確認叢集是否正常運作：</span><span class="sxs-lookup"><span data-stu-id="c0830-556">Use the following CQL commands to verify if the cluster is working:</span></span>
   
     <span data-ttu-id="c0830-557">CREATE KEYSPACE customers_ks WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 3 };   USE customers_ks;   CREATE TABLE Customers(customer_id int PRIMARY KEY, firstname text, lastname text);   INSERT INTO Customers(customer_id, firstname, lastname) VALUES(1, 'John', 'Doe');   INSERT INTO Customers(customer_id, firstname, lastname) VALUES (2, 'Jane', 'Doe');</span><span class="sxs-lookup"><span data-stu-id="c0830-557">CREATE KEYSPACE customers_ks WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 3 };   USE customers_ks;   CREATE TABLE Customers(customer_id int PRIMARY KEY, firstname text, lastname text);   INSERT INTO Customers(customer_id, firstname, lastname) VALUES(1, 'John', 'Doe');   INSERT INTO Customers(customer_id, firstname, lastname) VALUES (2, 'Jane', 'Doe');</span></span>
   
     <span data-ttu-id="c0830-558">SELECT * FROM Customers;</span><span class="sxs-lookup"><span data-stu-id="c0830-558">SELECT * FROM Customers;</span></span>

<span data-ttu-id="c0830-559">您應該會看到如下顯示：</span><span class="sxs-lookup"><span data-stu-id="c0830-559">You should see a display like the one below:</span></span>

<table>
  <tr><th> <span data-ttu-id="c0830-560">customer_id</span><span class="sxs-lookup"><span data-stu-id="c0830-560">customer_id</span></span> </th><th> <span data-ttu-id="c0830-561">firstname</span><span class="sxs-lookup"><span data-stu-id="c0830-561">firstname</span></span> </th><th> <span data-ttu-id="c0830-562">lastname</span><span class="sxs-lookup"><span data-stu-id="c0830-562">lastname</span></span> </th></tr>
  <tr><td> <span data-ttu-id="c0830-563">1</span><span class="sxs-lookup"><span data-stu-id="c0830-563">1</span></span> </td><td> <span data-ttu-id="c0830-564">John</span><span class="sxs-lookup"><span data-stu-id="c0830-564">John</span></span> </td><td> <span data-ttu-id="c0830-565">Doe</span><span class="sxs-lookup"><span data-stu-id="c0830-565">Doe</span></span> </td></tr>
  <tr><td> <span data-ttu-id="c0830-566">2</span><span class="sxs-lookup"><span data-stu-id="c0830-566">2</span></span> </td><td> <span data-ttu-id="c0830-567">Jane</span><span class="sxs-lookup"><span data-stu-id="c0830-567">Jane</span></span> </td><td> <span data-ttu-id="c0830-568">Doe</span><span class="sxs-lookup"><span data-stu-id="c0830-568">Doe</span></span> </td></tr>
</table>

<span data-ttu-id="c0830-569">請注意，在步驟 4 中建立的關鍵值空間 (keyspace) 使用 replication_factor 為 3 的 SimpleStrategy。</span><span class="sxs-lookup"><span data-stu-id="c0830-569">Please note that the keyspace created in step 4 uses SimpleStrategy with a  replication_factor of 3.</span></span> <span data-ttu-id="c0830-570">如果是單一資料中心部署，建議使用 SimpleStrategy，如果是多重資料中心部署，則建議使用 NetworkTopologyStrategy。</span><span class="sxs-lookup"><span data-stu-id="c0830-570">SimpleStrategy is recommended for single data center deployments whereas NetworkTopologyStrategy for multi-data center deployments.</span></span> <span data-ttu-id="c0830-571">replication_factor 為 3 將針對節點失敗提供容錯。</span><span class="sxs-lookup"><span data-stu-id="c0830-571">A replication_factor of 3 will give tolerance for node failures.</span></span>

## <span data-ttu-id="c0830-572"><a id="tworegion"> </a>多區域部署程序</span><span class="sxs-lookup"><span data-stu-id="c0830-572"><a id="tworegion"> </a>Multi-Region Deployment Process</span></span>
<span data-ttu-id="c0830-573">我們將運用已經完成的單一區域部署，然後重複相同程序安裝第二個區域。</span><span class="sxs-lookup"><span data-stu-id="c0830-573">Will leverage the single region deployment completed and repeat the same process for installing the second region.</span></span> <span data-ttu-id="c0830-574">單一和多重區域部署之間的主要差異在於區域間通訊的 VPN 通道設定。我們將從網路安裝開始、佈建 VM 以及設定 Cassandra。</span><span class="sxs-lookup"><span data-stu-id="c0830-574">The key difference between the single and multiple region deployment is the VPN tunnel setup for inter-region communication; we will start with the network installation, provision the VMs and configure Cassandra.</span></span>

### <a name="step-1-create-the-virtual-network-at-the-2nd-region"></a><span data-ttu-id="c0830-575">步驟 1：在第 2 個區域建立虛擬網路</span><span class="sxs-lookup"><span data-stu-id="c0830-575">Step 1: Create the Virtual Network at the 2nd Region</span></span>
<span data-ttu-id="c0830-576">登入 Azure 傳統入口網站，並使用表格中所示的屬性來建立虛擬網路。</span><span class="sxs-lookup"><span data-stu-id="c0830-576">Log into the Azure classic portal and create a Virtual Network with the attributes show in the table.</span></span> <span data-ttu-id="c0830-577">如需此程序的詳細步驟，請參閱 [在 Azure 傳統入口網站中設定純雲端虛擬網路](../../../virtual-network/virtual-networks-create-vnet-classic-pportal.md) 。</span><span class="sxs-lookup"><span data-stu-id="c0830-577">See [Configure a Cloud-Only Virtual Network in the Azure classic portal](../../../virtual-network/virtual-networks-create-vnet-classic-pportal.md) for detailed steps of the process.</span></span>      

<table>
<tr><th><span data-ttu-id="c0830-578">屬性名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-578">Attribute Name</span></span>    </th><th><span data-ttu-id="c0830-579">值</span><span class="sxs-lookup"><span data-stu-id="c0830-579">Value</span></span>    </th><th><span data-ttu-id="c0830-580">備註</span><span class="sxs-lookup"><span data-stu-id="c0830-580">Remarks</span></span></th></tr>
<tr><td><span data-ttu-id="c0830-581">名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-581">Name</span></span>    </td><td><span data-ttu-id="c0830-582">vnet-cass-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-582">vnet-cass-east-us</span></span></td><td></td></tr>
<tr><td><span data-ttu-id="c0830-583">區域</span><span class="sxs-lookup"><span data-stu-id="c0830-583">Region</span></span>    </td><td><span data-ttu-id="c0830-584">美國東部</span><span class="sxs-lookup"><span data-stu-id="c0830-584">East US</span></span></td><td></td></tr>
<tr><td><span data-ttu-id="c0830-585">DNS 伺服器</span><span class="sxs-lookup"><span data-stu-id="c0830-585">DNS Servers</span></span>        </td><td></td><td><span data-ttu-id="c0830-586">請忽略此項，因為我們不使用 DNS 伺服器</span><span class="sxs-lookup"><span data-stu-id="c0830-586">Ignore this as we are not using a DNS Server</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-587">設定點對站 VPN</span><span class="sxs-lookup"><span data-stu-id="c0830-587">Configure a point-to-site VPN</span></span></td><td></td><td>        <span data-ttu-id="c0830-588">略過此項</span><span class="sxs-lookup"><span data-stu-id="c0830-588">Ignore this</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-589">設定站台對站台 VPN</span><span class="sxs-lookup"><span data-stu-id="c0830-589">Configure a site-to-site VPN</span></span></td><td></td><td>        <span data-ttu-id="c0830-590">略過此項</span><span class="sxs-lookup"><span data-stu-id="c0830-590">Ignore this</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-591">位址空間</span><span class="sxs-lookup"><span data-stu-id="c0830-591">Address Space</span></span>    </td><td><span data-ttu-id="c0830-592">10.2.0.0/16</span><span class="sxs-lookup"><span data-stu-id="c0830-592">10.2.0.0/16</span></span></td><td></td></tr>
<tr><td><span data-ttu-id="c0830-593">起始 IP</span><span class="sxs-lookup"><span data-stu-id="c0830-593">Starting IP</span></span>    </td><td><span data-ttu-id="c0830-594">10.2.0.0</span><span class="sxs-lookup"><span data-stu-id="c0830-594">10.2.0.0</span></span>    </td><td></td></tr>
<tr><td><span data-ttu-id="c0830-595">CIDR</span><span class="sxs-lookup"><span data-stu-id="c0830-595">CIDR</span></span>    </td><td><span data-ttu-id="c0830-596">/16 (65531)</span><span class="sxs-lookup"><span data-stu-id="c0830-596">/16 (65531)</span></span></td><td></td></tr>
</table>

<span data-ttu-id="c0830-597">新增下列子網路：</span><span class="sxs-lookup"><span data-stu-id="c0830-597">Add the following subnets:</span></span>

<table>
<tr><th><span data-ttu-id="c0830-598">Name</span><span class="sxs-lookup"><span data-stu-id="c0830-598">Name</span></span>    </th><th><span data-ttu-id="c0830-599">起始 IP</span><span class="sxs-lookup"><span data-stu-id="c0830-599">Starting IP</span></span>    </th><th><span data-ttu-id="c0830-600">CIDR</span><span class="sxs-lookup"><span data-stu-id="c0830-600">CIDR</span></span>    </th><th><span data-ttu-id="c0830-601">備註</span><span class="sxs-lookup"><span data-stu-id="c0830-601">Remarks</span></span></th></tr>
<tr><td><span data-ttu-id="c0830-602">Web</span><span class="sxs-lookup"><span data-stu-id="c0830-602">web</span></span>    </td><td><span data-ttu-id="c0830-603">10.2.1.0</span><span class="sxs-lookup"><span data-stu-id="c0830-603">10.2.1.0</span></span>    </td><td><span data-ttu-id="c0830-604">/24 (251)</span><span class="sxs-lookup"><span data-stu-id="c0830-604">/24 (251)</span></span>    </td><td><span data-ttu-id="c0830-605">Web 伺服陣列的子網路</span><span class="sxs-lookup"><span data-stu-id="c0830-605">Subnet for the web farm</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-606">data</span><span class="sxs-lookup"><span data-stu-id="c0830-606">data</span></span>    </td><td><span data-ttu-id="c0830-607">10.2.2.0</span><span class="sxs-lookup"><span data-stu-id="c0830-607">10.2.2.0</span></span>    </td><td><span data-ttu-id="c0830-608">/24 (251)</span><span class="sxs-lookup"><span data-stu-id="c0830-608">/24 (251)</span></span>    </td><td><span data-ttu-id="c0830-609">資料庫節點的子網路</span><span class="sxs-lookup"><span data-stu-id="c0830-609">Subnet for the database nodes</span></span></td></tr>
</table>


### <a name="step-2-create-local-networks"></a><span data-ttu-id="c0830-610">步驟 2：建立區域網路</span><span class="sxs-lookup"><span data-stu-id="c0830-610">Step 2: Create Local Networks</span></span>
<span data-ttu-id="c0830-611">Azure 虛擬網路功能中的「區域網路」是一個 Proxy 位址空間，對應至包括私人雲端或其他 Azure 區域的遠端站台。</span><span class="sxs-lookup"><span data-stu-id="c0830-611">A Local Network in Azure virtual networking is a proxy address space that maps to a remote site including a private cloud or another Azure region.</span></span> <span data-ttu-id="c0830-612">此 Proxy 位址空間繫結至一個遠端閘道，將網路路由到正確的網路功能目的地。</span><span class="sxs-lookup"><span data-stu-id="c0830-612">This proxy address space is bound to a remote gateway for routing network to the right networking destinations.</span></span> <span data-ttu-id="c0830-613">請參閱 [設定 VNet 對 VNet 連線](../../../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md) ，以取得建立 VNET 對 VNET 連線的指示。</span><span class="sxs-lookup"><span data-stu-id="c0830-613">See [Configure a VNet to VNet Connection](../../../vpn-gateway/virtual-networks-configure-vnet-to-vnet-connection.md) for the instructions on establishing VNET-to-VNET connection.</span></span>

<span data-ttu-id="c0830-614">根據下列詳細資料建立兩個區域網路：</span><span class="sxs-lookup"><span data-stu-id="c0830-614">Create two local networks per the following details:</span></span>

| <span data-ttu-id="c0830-615">網路名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-615">Network Name</span></span> | <span data-ttu-id="c0830-616">VPN 閘道位址</span><span class="sxs-lookup"><span data-stu-id="c0830-616">VPN Gateway Address</span></span> | <span data-ttu-id="c0830-617">位址空間</span><span class="sxs-lookup"><span data-stu-id="c0830-617">Address Space</span></span> | <span data-ttu-id="c0830-618">備註</span><span class="sxs-lookup"><span data-stu-id="c0830-618">Remarks</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="c0830-619">hk-lnet-map-to-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-619">hk-lnet-map-to-east-us</span></span> |<span data-ttu-id="c0830-620">23.1.1.1</span><span class="sxs-lookup"><span data-stu-id="c0830-620">23.1.1.1</span></span> |<span data-ttu-id="c0830-621">10.2.0.0/16</span><span class="sxs-lookup"><span data-stu-id="c0830-621">10.2.0.0/16</span></span> |<span data-ttu-id="c0830-622">建立區域網路時，提供預留位置閘道位址。</span><span class="sxs-lookup"><span data-stu-id="c0830-622">While creating the Local Network give a placeholder gateway address.</span></span> <span data-ttu-id="c0830-623">建立閘道之後，就會填入真實的閘道位址。</span><span class="sxs-lookup"><span data-stu-id="c0830-623">The real gateway address is filled once the gateway is created.</span></span> <span data-ttu-id="c0830-624">請確定位址空間完全符合相對的遠端 VNET。在此案例中是在美國東部地區建立的 VNET。</span><span class="sxs-lookup"><span data-stu-id="c0830-624">Make sure the address space exactly matches the respective remote VNET; in this case the VNET created in the East US region.</span></span> |
| <span data-ttu-id="c0830-625">hk-lnet-map-to-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-625">hk-lnet-map-to-west-us</span></span> |<span data-ttu-id="c0830-626">23.2.2.2</span><span class="sxs-lookup"><span data-stu-id="c0830-626">23.2.2.2</span></span> |<span data-ttu-id="c0830-627">10.1.0.0/16</span><span class="sxs-lookup"><span data-stu-id="c0830-627">10.1.0.0/16</span></span> |<span data-ttu-id="c0830-628">建立區域網路時，提供預留位置閘道位址。</span><span class="sxs-lookup"><span data-stu-id="c0830-628">While creating the Local Network give a placeholder gateway address.</span></span> <span data-ttu-id="c0830-629">建立閘道之後，就會填入真實的閘道位址。</span><span class="sxs-lookup"><span data-stu-id="c0830-629">The real gateway address is filled once the gateway is created.</span></span> <span data-ttu-id="c0830-630">請確定位址空間完全符合相對的遠端 VNET。在此案例中是在美國西部地區建立的 VNET。</span><span class="sxs-lookup"><span data-stu-id="c0830-630">Make sure the address space exactly matches the respective remote VNET; in this case the VNET created in the West US region.</span></span> |

### <a name="step-3-map-local-network-to-the-respective-vnets"></a><span data-ttu-id="c0830-631">步驟 3：將「區域」網路對應至個別 VNET</span><span class="sxs-lookup"><span data-stu-id="c0830-631">Step 3: Map “Local” network to the respective VNETs</span></span>
<span data-ttu-id="c0830-632">從 Azure 傳統入口網站中，選取每個 VNet、按一下 [設定]，勾選 [連線到區域網路]，並根據下列詳細資料選取區域網路：</span><span class="sxs-lookup"><span data-stu-id="c0830-632">From the Azure classic portal, select each vnet, click “Configure”, check “Connect to the local network”, and select the Local Networks per the following details:</span></span>

| <span data-ttu-id="c0830-633">虛擬網路</span><span class="sxs-lookup"><span data-stu-id="c0830-633">Virtual Network</span></span> | <span data-ttu-id="c0830-634">區域網路</span><span class="sxs-lookup"><span data-stu-id="c0830-634">Local Network</span></span> |
| --- | --- |
| <span data-ttu-id="c0830-635">hk-vnet-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-635">hk-vnet-west-us</span></span> |<span data-ttu-id="c0830-636">hk-lnet-map-to-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-636">hk-lnet-map-to-east-us</span></span> |
| <span data-ttu-id="c0830-637">hk-vnet-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-637">hk-vnet-east-us</span></span> |<span data-ttu-id="c0830-638">hk-lnet-map-to-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-638">hk-lnet-map-to-west-us</span></span> |

### <a name="step-4-create-gateways-on-vnet1-and-vnet2"></a><span data-ttu-id="c0830-639">步驟 4：在 VNET1 和 VNET2 上建立閘道</span><span class="sxs-lookup"><span data-stu-id="c0830-639">Step 4: Create Gateways on VNET1 and VNET2</span></span>
<span data-ttu-id="c0830-640">從兩個虛擬網路的儀表板，按一下 [建立閘道] 可觸發 VPN 閘道的佈建程序。</span><span class="sxs-lookup"><span data-stu-id="c0830-640">From the dashboard of both the virtual networks, click CREATE GATEWAY which will trigger the VPN gateway provisioning process.</span></span> <span data-ttu-id="c0830-641">請稍候幾分鐘，每個虛擬網路的儀表板應該會顯示實際的閘道位址。</span><span class="sxs-lookup"><span data-stu-id="c0830-641">After a few minutes the dashboard of each virtual network should display the actual gateway address.</span></span>

### <a name="step-5-update-local-networks-with-the-respective-gateway-addresses"></a><span data-ttu-id="c0830-642">步驟 5：更新「區域」網路的個別「閘道」位址</span><span class="sxs-lookup"><span data-stu-id="c0830-642">Step 5: Update “Local” networks with the respective “Gateway” addresses</span></span>
<span data-ttu-id="c0830-643">編輯兩個區域網路，使用剛才佈建的閘道實際 IP 位址取代預留位置閘道 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="c0830-643">Edit both the local networks to replace the placeholder gateway IP address with the real IP address of the just provisioned gateways.</span></span> <span data-ttu-id="c0830-644">使用下列對應：</span><span class="sxs-lookup"><span data-stu-id="c0830-644">Use the following mapping:</span></span>

<table>
<tr><th><span data-ttu-id="c0830-645">區域網路</span><span class="sxs-lookup"><span data-stu-id="c0830-645">Local Network</span></span>    </th><th><span data-ttu-id="c0830-646">虛擬網路閘道</span><span class="sxs-lookup"><span data-stu-id="c0830-646">Virtual Network Gateway</span></span></th></tr>
<tr><td><span data-ttu-id="c0830-647">hk-lnet-map-to-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-647">hk-lnet-map-to-east-us</span></span> </td><td><span data-ttu-id="c0830-648">hk-vnet-west-us 的閘道</span><span class="sxs-lookup"><span data-stu-id="c0830-648">Gateway of hk-vnet-west-us</span></span></td></tr>
<tr><td><span data-ttu-id="c0830-649">hk-lnet-map-to-west-us</span><span class="sxs-lookup"><span data-stu-id="c0830-649">hk-lnet-map-to-west-us</span></span> </td><td><span data-ttu-id="c0830-650">hk-vnet-east-us 的閘道</span><span class="sxs-lookup"><span data-stu-id="c0830-650">Gateway of hk-vnet-east-us</span></span></td></tr>
</table>

### <a name="step-6-update-the-shared-key"></a><span data-ttu-id="c0830-651">步驟 6：更新共用金鑰</span><span class="sxs-lookup"><span data-stu-id="c0830-651">Step 6: Update the shared key</span></span>
<span data-ttu-id="c0830-652">使用下列 Powershell 指令碼來更新每個 VPN 閘道的 IPSec 金鑰 [針對這兩個閘道使用目的金鑰]：Set-AzureVNetGatewayKey -VNetName hk-vnet-east-us -LocalNetworkSiteName hk-lnet-map-to-west-us -SharedKey D9E76BKK Set-AzureVNetGatewayKey -VNetName hk-vnet-west-us -LocalNetworkSiteName hk-lnet-map-to-east-us -SharedKey D9E76BKK</span><span class="sxs-lookup"><span data-stu-id="c0830-652">Use the following Powershell script to update the IPSec key of each VPN gateway [use the sake key for both the gateways]: Set-AzureVNetGatewayKey -VNetName hk-vnet-east-us -LocalNetworkSiteName hk-lnet-map-to-west-us -SharedKey D9E76BKK Set-AzureVNetGatewayKey -VNetName hk-vnet-west-us -LocalNetworkSiteName hk-lnet-map-to-east-us -SharedKey D9E76BKK</span></span>

### <a name="step-7-establish-the-vnet-to-vnet-connection"></a><span data-ttu-id="c0830-653">步驟 7：建立 VNET 對 VNET 連線</span><span class="sxs-lookup"><span data-stu-id="c0830-653">Step 7: Establish the VNET-to-VNET connection</span></span>
<span data-ttu-id="c0830-654">從 Azure 傳統入口網站中，使用兩個虛擬網路的 [儀表板] 功能表建立閘道對閘道的連接。</span><span class="sxs-lookup"><span data-stu-id="c0830-654">From the Azure classic portal, use the “DASHBOARD” menu of both the virtual networks to establish gateway-to-gateway connection.</span></span> <span data-ttu-id="c0830-655">使用底部工具列的 [連線] 功能表項目。</span><span class="sxs-lookup"><span data-stu-id="c0830-655">Use the “CONNECT” menu items in the bottom toolbar.</span></span> <span data-ttu-id="c0830-656">請稍候幾分鐘，儀表板應該會以圖形方式顯示連線詳細資料。</span><span class="sxs-lookup"><span data-stu-id="c0830-656">After a few minutes the dashboard should display the connection details graphically.</span></span>

### <a name="step-8-create-the-virtual-machines-in-region-2"></a><span data-ttu-id="c0830-657">步驟 8：在第 2 個區域中建立虛擬機器</span><span class="sxs-lookup"><span data-stu-id="c0830-657">Step 8: Create the virtual machines in region #2</span></span>
<span data-ttu-id="c0830-658">依照在第 1 個區域中部署所述的下列相同步驟，建立 Ubuntu 映像，或者將映像 VHD 檔案複製到位於第 2 個區域的 Azure 儲存體帳戶，然後建立映像。</span><span class="sxs-lookup"><span data-stu-id="c0830-658">Create the Ubuntu image as described in region #1 deployment by following the same steps or copy the image VHD file to the Azure storage account located in region #2 and create the image.</span></span> <span data-ttu-id="c0830-659">使用此映像，並在新的雲端服務 hk-c-svc-east-us 建立下列虛擬機器清單：</span><span class="sxs-lookup"><span data-stu-id="c0830-659">Use this image and create the following list of virtual machines into a new cloud service hk-c-svc-east-us:</span></span>

| <span data-ttu-id="c0830-660">機器名稱</span><span class="sxs-lookup"><span data-stu-id="c0830-660">Machine Name</span></span> | <span data-ttu-id="c0830-661">子網路</span><span class="sxs-lookup"><span data-stu-id="c0830-661">Subnet</span></span> | <span data-ttu-id="c0830-662">IP 位址</span><span class="sxs-lookup"><span data-stu-id="c0830-662">IP Address</span></span> | <span data-ttu-id="c0830-663">可用性集合</span><span class="sxs-lookup"><span data-stu-id="c0830-663">Availability set</span></span> | <span data-ttu-id="c0830-664">DC/機架</span><span class="sxs-lookup"><span data-stu-id="c0830-664">DC/Rack</span></span> | <span data-ttu-id="c0830-665">是否為種子？</span><span class="sxs-lookup"><span data-stu-id="c0830-665">Seed?</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="c0830-666">hk-c1-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-666">hk-c1-east-us</span></span> |<span data-ttu-id="c0830-667">data</span><span class="sxs-lookup"><span data-stu-id="c0830-667">data</span></span> |<span data-ttu-id="c0830-668">10.2.2.4</span><span class="sxs-lookup"><span data-stu-id="c0830-668">10.2.2.4</span></span> |<span data-ttu-id="c0830-669">hk-c-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-669">hk-c-aset-1</span></span> |<span data-ttu-id="c0830-670">dc=EASTUS 機架=rack1</span><span class="sxs-lookup"><span data-stu-id="c0830-670">dc =EASTUS rack =rack1</span></span> |<span data-ttu-id="c0830-671">是</span><span class="sxs-lookup"><span data-stu-id="c0830-671">Yes</span></span> |
| <span data-ttu-id="c0830-672">hk-c2-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-672">hk-c2-east-us</span></span> |<span data-ttu-id="c0830-673">data</span><span class="sxs-lookup"><span data-stu-id="c0830-673">data</span></span> |<span data-ttu-id="c0830-674">10.2.2.5</span><span class="sxs-lookup"><span data-stu-id="c0830-674">10.2.2.5</span></span> |<span data-ttu-id="c0830-675">hk-c-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-675">hk-c-aset-1</span></span> |<span data-ttu-id="c0830-676">dc=EASTUS 機架=rack1</span><span class="sxs-lookup"><span data-stu-id="c0830-676">dc =EASTUS rack =rack1</span></span> |<span data-ttu-id="c0830-677">否</span><span class="sxs-lookup"><span data-stu-id="c0830-677">No</span></span> |
| <span data-ttu-id="c0830-678">hk-c3-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-678">hk-c3-east-us</span></span> |<span data-ttu-id="c0830-679">data</span><span class="sxs-lookup"><span data-stu-id="c0830-679">data</span></span> |<span data-ttu-id="c0830-680">10.2.2.6</span><span class="sxs-lookup"><span data-stu-id="c0830-680">10.2.2.6</span></span> |<span data-ttu-id="c0830-681">hk-c-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-681">hk-c-aset-1</span></span> |<span data-ttu-id="c0830-682">dc=EASTUS 機架=rack2</span><span class="sxs-lookup"><span data-stu-id="c0830-682">dc =EASTUS rack =rack2</span></span> |<span data-ttu-id="c0830-683">是</span><span class="sxs-lookup"><span data-stu-id="c0830-683">Yes</span></span> |
| <span data-ttu-id="c0830-684">hk-c5-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-684">hk-c5-east-us</span></span> |<span data-ttu-id="c0830-685">data</span><span class="sxs-lookup"><span data-stu-id="c0830-685">data</span></span> |<span data-ttu-id="c0830-686">10.2.2.8</span><span class="sxs-lookup"><span data-stu-id="c0830-686">10.2.2.8</span></span> |<span data-ttu-id="c0830-687">hk-c-aset-2</span><span class="sxs-lookup"><span data-stu-id="c0830-687">hk-c-aset-2</span></span> |<span data-ttu-id="c0830-688">dc=EASTUS 機架=rack3</span><span class="sxs-lookup"><span data-stu-id="c0830-688">dc =EASTUS rack =rack3</span></span> |<span data-ttu-id="c0830-689">是</span><span class="sxs-lookup"><span data-stu-id="c0830-689">Yes</span></span> |
| <span data-ttu-id="c0830-690">hk-c6-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-690">hk-c6-east-us</span></span> |<span data-ttu-id="c0830-691">data</span><span class="sxs-lookup"><span data-stu-id="c0830-691">data</span></span> |<span data-ttu-id="c0830-692">10.2.2.9</span><span class="sxs-lookup"><span data-stu-id="c0830-692">10.2.2.9</span></span> |<span data-ttu-id="c0830-693">hk-c-aset-2</span><span class="sxs-lookup"><span data-stu-id="c0830-693">hk-c-aset-2</span></span> |<span data-ttu-id="c0830-694">dc=EASTUS 機架=rack3</span><span class="sxs-lookup"><span data-stu-id="c0830-694">dc =EASTUS rack =rack3</span></span> |<span data-ttu-id="c0830-695">否</span><span class="sxs-lookup"><span data-stu-id="c0830-695">No</span></span> |
| <span data-ttu-id="c0830-696">hk-c7-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-696">hk-c7-east-us</span></span> |<span data-ttu-id="c0830-697">data</span><span class="sxs-lookup"><span data-stu-id="c0830-697">data</span></span> |<span data-ttu-id="c0830-698">10.2.2.10</span><span class="sxs-lookup"><span data-stu-id="c0830-698">10.2.2.10</span></span> |<span data-ttu-id="c0830-699">hk-c-aset-2</span><span class="sxs-lookup"><span data-stu-id="c0830-699">hk-c-aset-2</span></span> |<span data-ttu-id="c0830-700">dc=EASTUS 機架=rack4</span><span class="sxs-lookup"><span data-stu-id="c0830-700">dc =EASTUS rack =rack4</span></span> |<span data-ttu-id="c0830-701">是</span><span class="sxs-lookup"><span data-stu-id="c0830-701">Yes</span></span> |
| <span data-ttu-id="c0830-702">hk-c8-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-702">hk-c8-east-us</span></span> |<span data-ttu-id="c0830-703">data</span><span class="sxs-lookup"><span data-stu-id="c0830-703">data</span></span> |<span data-ttu-id="c0830-704">10.2.2.11</span><span class="sxs-lookup"><span data-stu-id="c0830-704">10.2.2.11</span></span> |<span data-ttu-id="c0830-705">hk-c-aset-2</span><span class="sxs-lookup"><span data-stu-id="c0830-705">hk-c-aset-2</span></span> |<span data-ttu-id="c0830-706">dc=EASTUS 機架=rack4</span><span class="sxs-lookup"><span data-stu-id="c0830-706">dc =EASTUS rack =rack4</span></span> |<span data-ttu-id="c0830-707">否</span><span class="sxs-lookup"><span data-stu-id="c0830-707">No</span></span> |
| <span data-ttu-id="c0830-708">hk-w1-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-708">hk-w1-east-us</span></span> |<span data-ttu-id="c0830-709">Web</span><span class="sxs-lookup"><span data-stu-id="c0830-709">web</span></span> |<span data-ttu-id="c0830-710">10.2.1.4</span><span class="sxs-lookup"><span data-stu-id="c0830-710">10.2.1.4</span></span> |<span data-ttu-id="c0830-711">hk-w-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-711">hk-w-aset-1</span></span> |<span data-ttu-id="c0830-712">N/A</span><span class="sxs-lookup"><span data-stu-id="c0830-712">N/A</span></span> |<span data-ttu-id="c0830-713">N/A</span><span class="sxs-lookup"><span data-stu-id="c0830-713">N/A</span></span> |
| <span data-ttu-id="c0830-714">hk-w2-east-us</span><span class="sxs-lookup"><span data-stu-id="c0830-714">hk-w2-east-us</span></span> |<span data-ttu-id="c0830-715">Web</span><span class="sxs-lookup"><span data-stu-id="c0830-715">web</span></span> |<span data-ttu-id="c0830-716">10.2.1.5</span><span class="sxs-lookup"><span data-stu-id="c0830-716">10.2.1.5</span></span> |<span data-ttu-id="c0830-717">hk-w-aset-1</span><span class="sxs-lookup"><span data-stu-id="c0830-717">hk-w-aset-1</span></span> |<span data-ttu-id="c0830-718">N/A</span><span class="sxs-lookup"><span data-stu-id="c0830-718">N/A</span></span> |<span data-ttu-id="c0830-719">N/A</span><span class="sxs-lookup"><span data-stu-id="c0830-719">N/A</span></span> |

<span data-ttu-id="c0830-720">依照與第 1 個區域相同的指示，但是使用 10.2.xxx.xxx 位址空間。</span><span class="sxs-lookup"><span data-stu-id="c0830-720">Follow the same instructions as region #1 but use 10.2.xxx.xxx address space.</span></span>

### <a name="step-9-configure-cassandra-on-each-vm"></a><span data-ttu-id="c0830-721">步驟 9：在每個 VM 上設定 Cassandra</span><span class="sxs-lookup"><span data-stu-id="c0830-721">Step 9: Configure Cassandra on each VM</span></span>
<span data-ttu-id="c0830-722">登入 VM 並執行下列項目：</span><span class="sxs-lookup"><span data-stu-id="c0830-722">Log into the VM and perform the following:</span></span>

1. <span data-ttu-id="c0830-723">編輯 $CASS_HOME/conf/cassandra-rackdc.properties，以下列格式指定資料中心和機架內容：dc =EASTUS rack =rack1</span><span class="sxs-lookup"><span data-stu-id="c0830-723">Edit $CASS_HOME/conf/cassandra-rackdc.properties to specify the data center and rack properties in the format:  dc =EASTUS  rack =rack1</span></span>
2. <span data-ttu-id="c0830-724">編輯 cassandra.yaml 設定種子節點：種子："10.1.2.4,10.1.2.6,10.1.2.8,10.1.2.10,10.2.2.4,10.2.2.6,10.2.2.8,10.2.2.10"</span><span class="sxs-lookup"><span data-stu-id="c0830-724">Edit cassandra.yaml to configure seed nodes:  Seeds: "10.1.2.4,10.1.2.6,10.1.2.8,10.1.2.10,10.2.2.4,10.2.2.6,10.2.2.8,10.2.2.10"</span></span>

### <a name="step-10-start-cassandra"></a><span data-ttu-id="c0830-725">步驟 10：啟動 Cassandra</span><span class="sxs-lookup"><span data-stu-id="c0830-725">Step 10: Start Cassandra</span></span>
<span data-ttu-id="c0830-726">登入每個 VM，執行下列命令在背景啟動 Cassandra：$CASS_HOME/bin/cassandra</span><span class="sxs-lookup"><span data-stu-id="c0830-726">Log into each VM and start Cassandra in the background by running the following command: $CASS_HOME/bin/cassandra</span></span>

## <a name="test-the-multi-region-cluster"></a><span data-ttu-id="c0830-727">測試多重區域叢集</span><span class="sxs-lookup"><span data-stu-id="c0830-727">Test the Multi-Region Cluster</span></span>
<span data-ttu-id="c0830-728">現在 Cassandra 已部署 16 個節點，每個 Azure 區域中有 8 個節點。</span><span class="sxs-lookup"><span data-stu-id="c0830-728">By now Cassandra has been deployed to 16 nodes with 8 nodes in each Azure region.</span></span> <span data-ttu-id="c0830-729">這些節點如果有共通的叢集名稱和種子節點設定，就是位於相同的叢集中。</span><span class="sxs-lookup"><span data-stu-id="c0830-729">These nodes are in the same cluster by virtue of the common cluster name and the seed node configuration.</span></span> <span data-ttu-id="c0830-730">使用下列程序測試叢集：</span><span class="sxs-lookup"><span data-stu-id="c0830-730">Use the following process to test the cluster:</span></span>

### <a name="step-1-get-the-internal-load-balancer-ip-for-both-the-regions-using-powershell"></a><span data-ttu-id="c0830-731">步驟 1：使用 PowerShell 取得這兩個區域的內部負載平衡器 IP</span><span class="sxs-lookup"><span data-stu-id="c0830-731">Step 1: Get the internal load balancer IP for both the regions using PowerShell</span></span>
* <span data-ttu-id="c0830-732">Get-AzureInternalLoadbalancer -ServiceName "hk-c-svc-west-us"</span><span class="sxs-lookup"><span data-stu-id="c0830-732">Get-AzureInternalLoadbalancer -ServiceName "hk-c-svc-west-us"</span></span>
* <span data-ttu-id="c0830-733">Get-AzureInternalLoadbalancer -ServiceName "hk-c-svc-east-us"</span><span class="sxs-lookup"><span data-stu-id="c0830-733">Get-AzureInternalLoadbalancer -ServiceName "hk-c-svc-east-us"</span></span>  
  
    <span data-ttu-id="c0830-734">請注意顯示的 IP 位址 (例如西部 - 10.1.2.101，東部 - 10.2.2.101)。</span><span class="sxs-lookup"><span data-stu-id="c0830-734">Note the IP addresses (e.g. west - 10.1.2.101, east - 10.2.2.101) displayed.</span></span>

### <a name="step-2-execute-the-following-in-the-west-region-after-logging-into-hk-w1-west-us"></a><span data-ttu-id="c0830-735">步驟 2：登入 hk-w1-west-us 後，在西部區域執行下列命令</span><span class="sxs-lookup"><span data-stu-id="c0830-735">Step 2: Execute the following in the west region after logging into hk-w1-west-us</span></span>
1. <span data-ttu-id="c0830-736">執行 $CASS_HOME/bin/cqlsh 10.1.2.101 9160</span><span class="sxs-lookup"><span data-stu-id="c0830-736">Execute $CASS_HOME/bin/cqlsh 10.1.2.101 9160</span></span>
2. <span data-ttu-id="c0830-737">執行下列 CQL 命令：</span><span class="sxs-lookup"><span data-stu-id="c0830-737">Execute the following CQL commands:</span></span>
   
     <span data-ttu-id="c0830-738">CREATE KEYSPACE customers_ks   WITH REPLICATION = { 'class' : 'NetworkToplogyStrategy', 'WESTUS' : 3, 'EASTUS' : 3};   USE customers_ks;   CREATE TABLE Customers(customer_id int PRIMARY KEY, firstname text, lastname text);   INSERT INTO Customers(customer_id, firstname, lastname) VALUES(1, 'John', 'Doe');   INSERT INTO Customers(customer_id, firstname, lastname) VALUES (2, 'Jane', 'Doe');   SELECT * FROM Customers;</span><span class="sxs-lookup"><span data-stu-id="c0830-738">CREATE KEYSPACE customers_ks   WITH REPLICATION = { 'class' : 'NetworkToplogyStrategy', 'WESTUS' : 3, 'EASTUS' : 3};   USE customers_ks;   CREATE TABLE Customers(customer_id int PRIMARY KEY, firstname text, lastname text);   INSERT INTO Customers(customer_id, firstname, lastname) VALUES(1, 'John', 'Doe');   INSERT INTO Customers(customer_id, firstname, lastname) VALUES (2, 'Jane', 'Doe');   SELECT * FROM Customers;</span></span>

<span data-ttu-id="c0830-739">您應該會看到如下顯示：</span><span class="sxs-lookup"><span data-stu-id="c0830-739">You should see a display like the one below:</span></span>

| <span data-ttu-id="c0830-740">customer_id</span><span class="sxs-lookup"><span data-stu-id="c0830-740">customer_id</span></span> | <span data-ttu-id="c0830-741">firstname</span><span class="sxs-lookup"><span data-stu-id="c0830-741">firstname</span></span> | <span data-ttu-id="c0830-742">lastname</span><span class="sxs-lookup"><span data-stu-id="c0830-742">Lastname</span></span> |
| --- | --- | --- |
| <span data-ttu-id="c0830-743">1</span><span class="sxs-lookup"><span data-stu-id="c0830-743">1</span></span> |<span data-ttu-id="c0830-744">John</span><span class="sxs-lookup"><span data-stu-id="c0830-744">John</span></span> |<span data-ttu-id="c0830-745">Doe</span><span class="sxs-lookup"><span data-stu-id="c0830-745">Doe</span></span> |
| <span data-ttu-id="c0830-746">2</span><span class="sxs-lookup"><span data-stu-id="c0830-746">2</span></span> |<span data-ttu-id="c0830-747">Jane</span><span class="sxs-lookup"><span data-stu-id="c0830-747">Jane</span></span> |<span data-ttu-id="c0830-748">Doe</span><span class="sxs-lookup"><span data-stu-id="c0830-748">Doe</span></span> |

### <a name="step-3-execute-the-following-in-the-east-region-after-logging-into-hk-w1-east-us"></a><span data-ttu-id="c0830-749">步驟 3：登入 hk-w1-east-us 後，在東部區域執行下列命令</span><span class="sxs-lookup"><span data-stu-id="c0830-749">Step 3: Execute the following in the east region after logging into hk-w1-east-us:</span></span>
1. <span data-ttu-id="c0830-750">執行 $CASS_HOME/bin/cqlsh 10.2.2.101 9160</span><span class="sxs-lookup"><span data-stu-id="c0830-750">Execute $CASS_HOME/bin/cqlsh 10.2.2.101 9160</span></span>
2. <span data-ttu-id="c0830-751">執行下列 CQL 命令：</span><span class="sxs-lookup"><span data-stu-id="c0830-751">Execute the following CQL commands:</span></span>
   
     <span data-ttu-id="c0830-752">USE customers_ks;   CREATE TABLE Customers(customer_id int PRIMARY KEY, firstname text, lastname text);   INSERT INTO Customers(customer_id, firstname, lastname) VALUES(1, 'John', 'Doe');   INSERT INTO Customers(customer_id, firstname, lastname) VALUES (2, 'Jane', 'Doe');   SELECT * FROM Customers;</span><span class="sxs-lookup"><span data-stu-id="c0830-752">USE customers_ks;   CREATE TABLE Customers(customer_id int PRIMARY KEY, firstname text, lastname text);   INSERT INTO Customers(customer_id, firstname, lastname) VALUES(1, 'John', 'Doe');   INSERT INTO Customers(customer_id, firstname, lastname) VALUES (2, 'Jane', 'Doe');   SELECT * FROM Customers;</span></span>

<span data-ttu-id="c0830-753">您應該會看到針對西部區域執行時相同的顯示畫面：</span><span class="sxs-lookup"><span data-stu-id="c0830-753">You should see the same display as seen for the West region:</span></span>

| <span data-ttu-id="c0830-754">customer_id</span><span class="sxs-lookup"><span data-stu-id="c0830-754">customer_id</span></span> | <span data-ttu-id="c0830-755">firstname</span><span class="sxs-lookup"><span data-stu-id="c0830-755">firstname</span></span> | <span data-ttu-id="c0830-756">lastname</span><span class="sxs-lookup"><span data-stu-id="c0830-756">Lastname</span></span> |
| --- | --- | --- |
| <span data-ttu-id="c0830-757">1</span><span class="sxs-lookup"><span data-stu-id="c0830-757">1</span></span> |<span data-ttu-id="c0830-758">John</span><span class="sxs-lookup"><span data-stu-id="c0830-758">John</span></span> |<span data-ttu-id="c0830-759">Doe</span><span class="sxs-lookup"><span data-stu-id="c0830-759">Doe</span></span> |
| <span data-ttu-id="c0830-760">2</span><span class="sxs-lookup"><span data-stu-id="c0830-760">2</span></span> |<span data-ttu-id="c0830-761">Jane</span><span class="sxs-lookup"><span data-stu-id="c0830-761">Jane</span></span> |<span data-ttu-id="c0830-762">Doe</span><span class="sxs-lookup"><span data-stu-id="c0830-762">Doe</span></span> |

<span data-ttu-id="c0830-763">執行一些插入動作，並且查看複寫到叢集 west-us 部分的那些插入項目。</span><span class="sxs-lookup"><span data-stu-id="c0830-763">Execute a few more inserts and see that those get replicated to west-us part of the cluster.</span></span>

## <a name="test-cassandra-cluster-from-nodejs"></a><span data-ttu-id="c0830-764">透過 Node.js 測試 Cassandra 叢集</span><span class="sxs-lookup"><span data-stu-id="c0830-764">Test Cassandra Cluster from Node.js</span></span>
<span data-ttu-id="c0830-765">使用先前在 "Web" 層中建立的其中一個 Linux VM，我們將執行簡單的 Node.js 指令碼來讀取先前插入的資料</span><span class="sxs-lookup"><span data-stu-id="c0830-765">Using one of the Linux VMs crated in the "web" tier previously, we will execute a simple Node.js script to read the previously inserted data</span></span>

<span data-ttu-id="c0830-766">**步驟 1：安裝 Node.js 和 Cassandra 用戶端**</span><span class="sxs-lookup"><span data-stu-id="c0830-766">**Step 1: Install Node.js and Cassandra Client**</span></span>

1. <span data-ttu-id="c0830-767">安裝 Node.js 和 npm</span><span class="sxs-lookup"><span data-stu-id="c0830-767">Install Node.js and npm</span></span>
2. <span data-ttu-id="c0830-768">使用 npm 安裝節點套件"cassandra-client"</span><span class="sxs-lookup"><span data-stu-id="c0830-768">Install node package "cassandra-client" using npm</span></span>
3. <span data-ttu-id="c0830-769">在殼層提示字元中執行下列指令碼，顯示擷取資料的 json 字串：</span><span class="sxs-lookup"><span data-stu-id="c0830-769">Execute the following script at the shell prompt which displays the json string of the retrieved data:</span></span>
   
        var pooledCon = require('cassandra-client').PooledConnection;
        var ksName = "custsupport_ks";
        var cfName = "customers_cf";
        var hostList = ['internal_loadbalancer_ip:9160'];
        var ksConOptions = { hosts: hostList,
                             keyspace: ksName, use_bigints: false };
   
        function createKeyspace(callback){
           var cql = 'CREATE KEYSPACE ' + ksName + ' WITH strategy_class=SimpleStrategy AND strategy_options:replication_factor=1';
           var sysConOptions = { hosts: hostList,  
                                 keyspace: 'system', use_bigints: false };
           var con = new pooledCon(sysConOptions);
           con.execute(cql,[],function(err) {
           if (err) {
             console.log("Failed to create Keyspace: " + ksName);
             console.log(err);
           }
           else {
             console.log("Created Keyspace: " + ksName);
             callback(ksConOptions, populateCustomerData);
           }
           });
           con.shutdown();
        }
   
        function createColumnFamily(ksConOptions, callback){
          var params = ['customers_cf','custid','varint','custname',
                        'text','custaddress','text'];
          var cql = 'CREATE COLUMNFAMILY ? (? ? PRIMARY KEY,? ?, ? ?)';
        var con =  new pooledCon(ksConOptions);
          con.execute(cql,params,function(err) {
              if (err) {
                 console.log("Failed to create column family: " + params[0]);
                 console.log(err);
              }
              else {
                 console.log("Created column family: " + params[0]);
                 callback();
              }
          });
          con.shutdown();
        }
   
        //populate Data
        function populateCustomerData() {
           var params = ['John','Infinity Dr, TX', 1];
           updateCustomer(ksConOptions,params);
   
           params = ['Tom','Fermat Ln, WA', 2];
           updateCustomer(ksConOptions,params);
        }
   
        //update will also insert the record if none exists
        function updateCustomer(ksConOptions,params)
        {
          var cql = 'UPDATE customers_cf SET custname=?,custaddress=? where custid=?';
          var con = new pooledCon(ksConOptions);
          con.execute(cql,params,function(err) {
              if (err) console.log(err);
              else console.log("Inserted customer : " + params[0]);
          });
          con.shutdown();
        }
   
        //read the two rows inserted above
        function readCustomer(ksConOptions)
        {
          var cql = 'SELECT * FROM customers_cf WHERE custid IN (1,2)';
          var con = new pooledCon(ksConOptions);
          con.execute(cql,[],function(err,rows) {
              if (err)
                 console.log(err);
              else
                 for (var i=0; i<rows.length; i++)
                    console.log(JSON.stringify(rows[i]));
            });
           con.shutdown();
        }
   
        //exectue the code
        createKeyspace(createColumnFamily);
        readCustomer(ksConOptions)

## <a name="conclusion"></a><span data-ttu-id="c0830-770">結論</span><span class="sxs-lookup"><span data-stu-id="c0830-770">Conclusion</span></span>
<span data-ttu-id="c0830-771">Microsoft Azure 是一個富彈性的平台，可以執行 Microsoft 與開放原始碼軟體，如本練習中所示。</span><span class="sxs-lookup"><span data-stu-id="c0830-771">Microsoft Azure is a flexible platform that allows the running of both Microsoft as well as open source software as demonstrated by this exercise.</span></span> <span data-ttu-id="c0830-772">透過將叢集節點分散在多個容錯網域，可以將高度可用的 Cassandra 叢集部署在單一資料中心。</span><span class="sxs-lookup"><span data-stu-id="c0830-772">Highly available Cassandra clusters can be deployed on a single data center through the spreading of the cluster nodes across multiple fault domains.</span></span> <span data-ttu-id="c0830-773">您也可以跨越多個地理位置遙遠的 Azure 區域部署 Cassandra 叢集做為災害防禦系統。</span><span class="sxs-lookup"><span data-stu-id="c0830-773">Cassandra clusters can also be deployed across multiple geographically distant Azure regions for disaster proof systems.</span></span> <span data-ttu-id="c0830-774">Azure 搭配 Cassandra 可建構現今的網際網路等級服務所需，且具有高擴充性、高可用性以及可進行災害復原的雲端服務。</span><span class="sxs-lookup"><span data-stu-id="c0830-774">Azure and Cassandra together enables the construction of highly scalable, highly available and disaster recoverable cloud services needed by today's internet scale services.</span></span>  

## <a name="references"></a><span data-ttu-id="c0830-775">參考</span><span class="sxs-lookup"><span data-stu-id="c0830-775">References</span></span>
* [<span data-ttu-id="c0830-776">http://cassandra.apache.org</span><span class="sxs-lookup"><span data-stu-id="c0830-776">http://cassandra.apache.org</span></span>](http://cassandra.apache.org)
* [<span data-ttu-id="c0830-777">http://www.datastax.com</span><span class="sxs-lookup"><span data-stu-id="c0830-777">http://www.datastax.com</span></span>](http://www.datastax.com)
* [<span data-ttu-id="c0830-778">http://www.nodejs.org</span><span class="sxs-lookup"><span data-stu-id="c0830-778">http://www.nodejs.org</span></span>](http://www.nodejs.org)

