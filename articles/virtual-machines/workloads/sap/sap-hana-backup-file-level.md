---
title: "檔案層級的 SAP HANA Azure 備份 | Microsoft Docs"
description: "備份 Azure 虛擬機器上的 SAP HANA 有兩種主要做法，本文涵蓋檔案層級的 SAP HANA Azure 備份"
services: virtual-machines-linux
documentationcenter: 
author: hermanndms
manager: timlt
editor: 
ms.service: virtual-machines-linux
ms.devlang: NA
ms.topic: article
ums.tgt_pltfrm: vm-linux
ms.workload: infrastructure-services
ms.date: 3/13/2017
ms.author: rclaus
ms.openlocfilehash: 5db0ceb1648b5afa278e1cbe1c42fce8033bfdc1
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/29/2017
---
# <a name="sap-hana-azure-backup-on-file-level"></a><span data-ttu-id="dc839-103">檔案層級的 SAP HANA Azure 備份</span><span class="sxs-lookup"><span data-stu-id="dc839-103">SAP HANA Azure Backup on file level</span></span>

## <a name="introduction"></a><span data-ttu-id="dc839-104">簡介</span><span class="sxs-lookup"><span data-stu-id="dc839-104">Introduction</span></span>

<span data-ttu-id="dc839-105">這是與 SAP HANA 備份相關的三篇系列文章的其中一篇。</span><span class="sxs-lookup"><span data-stu-id="dc839-105">This is part of a three-part series of related articles on SAP HANA backup.</span></span> <span data-ttu-id="dc839-106">[Azure 虛擬機器上 SAP HANA 的備份指南](./sap-hana-backup-guide.md)提供開始使用的概觀和資訊，[以儲存體快照集為基礎的 SAP HANA 備份](./sap-hana-backup-storage-snapshots.md)涵蓋以儲存體快照集為基礎的備份選項。</span><span class="sxs-lookup"><span data-stu-id="dc839-106">[Backup guide for SAP HANA on Azure Virtual Machines](./sap-hana-backup-guide.md) provides an overview and information on getting started, and [SAP HANA backup based on storage snapshots](./sap-hana-backup-storage-snapshots.md) covers the storage snapshot-based backup option.</span></span>

<span data-ttu-id="dc839-107">查看 Azure VM 的大小，可看出一個 GS5 可連結 64 個資料磁碟。</span><span class="sxs-lookup"><span data-stu-id="dc839-107">Looking at the Azure VM sizes, one can see that a GS5 allows 64 attached data disks.</span></span> <span data-ttu-id="dc839-108">在大型的 SAP HANA 系統中，大量磁碟可能已被資料和記錄檔佔據，可能還加上用於最佳磁碟 IO 輸送量的軟體 RAID。</span><span class="sxs-lookup"><span data-stu-id="dc839-108">For large SAP HANA systems, a significant number of disks might already be taken for data and log files, possibly in combination with software RAID for optimal disk IO throughput.</span></span> <span data-ttu-id="dc839-109">所以問題是，一段時間後已填滿連結資料磁碟的 SAP HANA 備份檔案要放在哪裡？</span><span class="sxs-lookup"><span data-stu-id="dc839-109">The question then is where to store SAP HANA backup files, which could fill up the attached data disks over time?</span></span> <span data-ttu-id="dc839-110">請參閱 [Azure 中的 Linux 虛擬機器大小](../../linux/sizes.md)中的 Azure VM 大小資料表。</span><span class="sxs-lookup"><span data-stu-id="dc839-110">See [Sizes for Linux virtual machines in Azure](../../linux/sizes.md) for the Azure VM size tables.</span></span>

<span data-ttu-id="dc839-111">目前 SAP HANA 備份還沒有與 Azure 備份服務整合。</span><span class="sxs-lookup"><span data-stu-id="dc839-111">There is no SAP HANA backup integration available with Azure Backup service at this time.</span></span> <span data-ttu-id="dc839-112">在檔案層級管理備份/還原的標準方式，是透過 SAP HANA Studio 或 SAP HANA SQL 陳述式使用以檔案為基礎的備份。</span><span class="sxs-lookup"><span data-stu-id="dc839-112">The standard way to manage backup/restore at the file level is with a file-based backup via SAP HANA Studio or via SAP HANA SQL statements.</span></span> <span data-ttu-id="dc839-113">詳細資訊請參閱 [SAP HANA SQL 和系統檢視參考](https://help.sap.com/hana/SAP_HANA_SQL_and_System_Views_Reference_en.pdf)。</span><span class="sxs-lookup"><span data-stu-id="dc839-113">See [SAP HANA SQL and System Views Reference](https://help.sap.com/hana/SAP_HANA_SQL_and_System_Views_Reference_en.pdf) for more information.</span></span>

![本圖顯示 SAP HANA Studio 中的備份的功能表對話方塊](media/sap-hana-backup-file-level/image022.png)

<span data-ttu-id="dc839-115">本圖顯示 SAP HANA Studio 中的備份的功能表對話方塊。</span><span class="sxs-lookup"><span data-stu-id="dc839-115">This figure shows the dialog of the backup menu item in SAP HANA Studio.</span></span> <span data-ttu-id="dc839-116">當選擇 [檔案]&quot;&quot; 類型，必須指定檔案系統中的路徑讓 SAP HANA 寫入備份檔案。</span><span class="sxs-lookup"><span data-stu-id="dc839-116">When choosing type &quot;file,&quot; one has to specify a path in the file system where SAP HANA writes the backup files.</span></span> <span data-ttu-id="dc839-117">還原的運作方式亦同。</span><span class="sxs-lookup"><span data-stu-id="dc839-117">Restore works the same way.</span></span>

<span data-ttu-id="dc839-118">雖然這項選擇聽起來簡單又直接，但仍有一些事要考量。</span><span class="sxs-lookup"><span data-stu-id="dc839-118">While this choice sounds simple and straight forward, there are some considerations.</span></span> <span data-ttu-id="dc839-119">之前有提到，Azure 虛擬機器可連結的資料磁碟數目有限制。</span><span class="sxs-lookup"><span data-stu-id="dc839-119">As mentioned before, an Azure VM has a limitation of number of data disks that can be attached.</span></span> <span data-ttu-id="dc839-120">可能無法在 VM 的檔案系統上儲存 SAP HANA 備份檔案，取決於資料庫的大小和磁碟輸送量需求，其中可能牽涉到使用串接跨多個資料磁碟的軟體 RAID。</span><span class="sxs-lookup"><span data-stu-id="dc839-120">There might not be capacity to store SAP HANA backup files on the file systems of the VM, depending on the size of the database and disk throughput requirements, which might involve software RAID using striping across multiple data disks.</span></span> <span data-ttu-id="dc839-121">在本文稍後提供多種選項，可用於在處理數 TB 資料時，移動這些備份檔案以及管理檔案大小限制和效能。</span><span class="sxs-lookup"><span data-stu-id="dc839-121">Various options for moving these backup files, and managing file size restrictions and performance when handling terabytes of data, are provided later in this article.</span></span>

<span data-ttu-id="dc839-122">另一個可以不計總容量提供更多自由的選項是 Azure Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="dc839-122">Another option, which offers more freedom regarding total capacity, is Azure blob storage.</span></span> <span data-ttu-id="dc839-123">雖然單一 blob 也有 1 TB 的限制，單一 blob 容器的總容量目前為 500 TB。</span><span class="sxs-lookup"><span data-stu-id="dc839-123">While a single blob is also restricted to 1 TB, the total capacity of a single blob container is currently 500 TB.</span></span> <span data-ttu-id="dc839-124">此外，它讓客戶可以選擇較具成本效益的「非經常性」&quot;&quot;blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="dc839-124">Additionally, it gives customers the choice to select so-called &quot;cool&quot; blob storage, which has a cost benefit.</span></span> <span data-ttu-id="dc839-125">如需非經常性 blob 儲存體的詳細資訊，請參閱 [Azure Blob 儲存體︰經常性存取與非經常性存取儲存層](../../../storage/blobs/storage-blob-storage-tiers.md)。</span><span class="sxs-lookup"><span data-stu-id="dc839-125">See [Azure Blob Storage: Hot and cool storage tiers](../../../storage/blobs/storage-blob-storage-tiers.md) for details about cool blob storage.</span></span>

<span data-ttu-id="dc839-126">如果想要更安全，使用異地複寫儲存體帳戶來存放 SAP HANA 備份。</span><span class="sxs-lookup"><span data-stu-id="dc839-126">For additional safety, use a geo-replicated storage account to store the SAP HANA backups.</span></span> <span data-ttu-id="dc839-127">如需儲存體帳戶複寫相關的詳細資料，請參閱 [Azure 儲存體複寫](../../../storage/common/storage-redundancy.md)。</span><span class="sxs-lookup"><span data-stu-id="dc839-127">See [Azure Storage replication](../../../storage/common/storage-redundancy.md) for details about storage account replication.</span></span>

<span data-ttu-id="dc839-128">一個人將 SAP HANA 備份專用的 VHD 放在異地複寫的專用備份儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="dc839-128">One could place dedicated VHDs for SAP HANA backups in a dedicated backup storage account that is geo-replicated.</span></span> <span data-ttu-id="dc839-129">而另一個人可以將存放 SAP HANA 備份的 VHD 複製到異地複寫的儲存體帳戶中，或複製到不同區域中的儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="dc839-129">Or else one could copy the VHDs that keep the SAP HANA backups to a geo-replicated storage account, or to a storage account that is in a different region.</span></span>

## <a name="azure-backup-agent"></a><span data-ttu-id="dc839-130">Azure 備份代理程式</span><span class="sxs-lookup"><span data-stu-id="dc839-130">Azure backup agent</span></span>

<span data-ttu-id="dc839-131">Azure 備份提供的選項不僅可備份完整的 VM，但可透過備份代理程式 (必須在客體 OS 上安裝) 備份檔案和目錄。</span><span class="sxs-lookup"><span data-stu-id="dc839-131">Azure backup offers the option to not only back up complete VMs, but also files and directories via the backup agent, which has to be installed on the guest OS.</span></span> <span data-ttu-id="dc839-132">但自 2016 年 12 月起，僅在 Windows 上支援此代理程式 (請參閱[使用 Resource Manager 部署模型將 Windows Server 或用戶端備份至 Azure](../../../backup/backup-configure-vault.md))。</span><span class="sxs-lookup"><span data-stu-id="dc839-132">But as of December 2016, this agent is only supported on Windows (see [Back up a Windows Server or client to Azure using the Resource Manager deployment model](../../../backup/backup-configure-vault.md)).</span></span>

<span data-ttu-id="dc839-133">解決方法是先將 SAP HANA 備份檔案複製到 Azure 上的 Windows VM (例如，透過 SAMBA 共用)，然後從該處使用 Azure 備份代理程式。</span><span class="sxs-lookup"><span data-stu-id="dc839-133">A workaround is to first copy SAP HANA backup files to a Windows VM on Azure (for example, via SAMBA share) and then use the Azure backup agent from there.</span></span> <span data-ttu-id="dc839-134">雖然技術上可行，但可能會增加複雜度，並因為在 Linux 和 Windows VM 之間的複製而使備份或還原程序變慢許多。</span><span class="sxs-lookup"><span data-stu-id="dc839-134">While it is technically possible, it would add complexity and slow down the backup or restore process quite a bit due to the copy between the Linux and the Windows VM.</span></span> <span data-ttu-id="dc839-135">不建議採取此做法。</span><span class="sxs-lookup"><span data-stu-id="dc839-135">It is not recommended to follow this approach.</span></span>

## <a name="azure-blobxfer-utility-details"></a><span data-ttu-id="dc839-136">Azure blobxfer 公用程式詳細資料</span><span class="sxs-lookup"><span data-stu-id="dc839-136">Azure blobxfer utility details</span></span>

<span data-ttu-id="dc839-137">為了在 Azure 儲存體上儲存目錄和檔案，可以使用 CLI 或 PowerShell，或開發使用其中一種 [Azure SDK](https://azure.microsoft.com/downloads/) 的工具。</span><span class="sxs-lookup"><span data-stu-id="dc839-137">To store directories and files on Azure storage, one could use CLI or PowerShell, or develop a tool using one of the [Azure SDKs](https://azure.microsoft.com/downloads/).</span></span> <span data-ttu-id="dc839-138">另外也有現成的公用程式 AzCopy，可將資料複製到 Azure 儲存體，但是它只適用於 Windows (請參閱[使用 AzCopy 命令列公用程式傳輸資料](../../../storage/common/storage-use-azcopy.md))。</span><span class="sxs-lookup"><span data-stu-id="dc839-138">There is also a ready-to-use utility, AzCopy, for copying data to Azure storage, but it is Windows only (see [Transfer data with the AzCopy Command-Line Utility](../../../storage/common/storage-use-azcopy.md)).</span></span>

<span data-ttu-id="dc839-139">因此，使用 blobxfer 來複製 SAP HANA 備份檔案。</span><span class="sxs-lookup"><span data-stu-id="dc839-139">Therefore blobxfer was used for copying SAP HANA backup files.</span></span> <span data-ttu-id="dc839-140">blobxfer 是開放原始碼，可從 [GitHub](https://github.com/Azure/blobxfer) 取得，許多客戶在生產環境中使用它。</span><span class="sxs-lookup"><span data-stu-id="dc839-140">It is open source, used by many customers in production environments, and available on [GitHub](https://github.com/Azure/blobxfer).</span></span> <span data-ttu-id="dc839-141">此工具不允許將資料直接複製到 Azure blob 儲存體或 Azure 檔案共用。</span><span class="sxs-lookup"><span data-stu-id="dc839-141">This tool allows one to copy data directly to either Azure blob storage or Azure file share.</span></span> <span data-ttu-id="dc839-142">它也提供各種實用的功能，例如 md5 雜湊、複製含多個檔案的目錄時可使用自動平行處理原則。</span><span class="sxs-lookup"><span data-stu-id="dc839-142">It also offers a range of useful features, like md5 hash or automatic parallelism when copying a directory with multiple files.</span></span>

## <a name="sap-hana-backup-performance"></a><span data-ttu-id="dc839-143">SAP HANA 備份的效能</span><span class="sxs-lookup"><span data-stu-id="dc839-143">SAP HANA backup performance</span></span>

![這個螢幕擷取畫面是 SAP HANA Studio 中的 SAP HANA 備份主控台](media/sap-hana-backup-file-level/image023.png)

<span data-ttu-id="dc839-145">這個螢幕擷取畫面是 SAP HANA Studio 中的 SAP HANA 備份主控台。</span><span class="sxs-lookup"><span data-stu-id="dc839-145">This screenshot is of the SAP HANA backup console in SAP HANA Studio.</span></span> <span data-ttu-id="dc839-146">在連結到 HANA VM (使用 XFS 檔案系統) 的單一 Azure 標準儲存體磁碟上，備份 230 GB 的資料約需時 42 分鐘。</span><span class="sxs-lookup"><span data-stu-id="dc839-146">It took about 42 minutes to do the backup of the 230 GB on a single Azure standard storage disk attached to the HANA VM using XFS file system.</span></span>

![這個螢幕擷取畫面是 SAP HANA 測試 VM 上的 YaST](media/sap-hana-backup-file-level/image024.png)

<span data-ttu-id="dc839-148">這個螢幕擷取畫面是 SAP HANA 測試 VM 上的 YaST。</span><span class="sxs-lookup"><span data-stu-id="dc839-148">This screenshot is of YaST on the SAP HANA test VM.</span></span> <span data-ttu-id="dc839-149">如同先前所述，可以看到 SAP HANA 備份的單一 1 TB 磁碟。</span><span class="sxs-lookup"><span data-stu-id="dc839-149">One can see the 1-TB single disk for SAP HANA backup as mentioned before.</span></span> <span data-ttu-id="dc839-150">備份 230 GB 花費約 42 分鐘。</span><span class="sxs-lookup"><span data-stu-id="dc839-150">It took about 42 minutes to backup 230 GB.</span></span> <span data-ttu-id="dc839-151">此外，還連結了五個 200 GB 的磁碟並建立了軟體 RAID md0，而且在這五個 Azure 資料磁碟上串接。</span><span class="sxs-lookup"><span data-stu-id="dc839-151">In addition, five 200-GB disks were attached and software RAID md0 created, with striping on top of these five Azure data disks.</span></span>

![對軟體 RAID 重複相同的備份，並串接五個連結的 Azure 標準儲存體資料磁碟](media/sap-hana-backup-file-level/image025.png)

<span data-ttu-id="dc839-153">對軟體 RAID 重複相同的備份，並串接五個連結的 Azure 標準儲存體資料磁碟，將備份時間從 42 分鐘降到 10 分鐘。</span><span class="sxs-lookup"><span data-stu-id="dc839-153">Repeating the same backup on software RAID with striping across five attached Azure standard storage data disks brought the backup time from 42 minutes down to 10 minutes.</span></span> <span data-ttu-id="dc839-154">磁碟已連結，且沒有快取至 VM。</span><span class="sxs-lookup"><span data-stu-id="dc839-154">The disks were attached without caching to the VM.</span></span> <span data-ttu-id="dc839-155">由此可見，磁碟寫入輸送量對備份時間有多重要。</span><span class="sxs-lookup"><span data-stu-id="dc839-155">So it is obvious how important disk write throughput is for the backup time.</span></span> <span data-ttu-id="dc839-156">您可以改換到 Azure 進階儲存體，進一步加速處理程序，以獲得最佳效能。</span><span class="sxs-lookup"><span data-stu-id="dc839-156">One could then switch to Azure premium storage to further accelerate the process for optimal performance.</span></span> <span data-ttu-id="dc839-157">一般而言，生產系統應該使用 Azure 進階儲存體。</span><span class="sxs-lookup"><span data-stu-id="dc839-157">In general, Azure premium storage should be used for production systems.</span></span>

## <a name="copy-sap-hana-backup-files-to-azure-blob-storage"></a><span data-ttu-id="dc839-158">將 SAP HANA 備份檔案複製到 Azure Blob 儲存體</span><span class="sxs-lookup"><span data-stu-id="dc839-158">Copy SAP HANA backup files to Azure blob storage</span></span>

<span data-ttu-id="dc839-159">自 2016 年 12 月起，快速儲存 SAP HANA 備份檔案的最佳選擇是 Azure Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="dc839-159">As of December 2016, the best option to quickly store SAP HANA backup files is Azure blob storage.</span></span> <span data-ttu-id="dc839-160">單一 blob 容器的上限為 500 TB，對於大多數在 Azure 上執行 GS5 VM 的 SAP HANA 系統來説已經夠用，可保留充足的 SAP HANA 備份。</span><span class="sxs-lookup"><span data-stu-id="dc839-160">One single blob container has a limit of 500 TB, enough for most SAP HANA systems, running in a GS5 VM on Azure, to keep sufficient SAP HANA backups.</span></span> <span data-ttu-id="dc839-161">客戶可在「經常性存取」&quot;&quot;和「非經常性存取」&quot;&quot;儲存體之間選擇 (請參閱 [Azure Blob 儲存體︰經常性存取與非經常性存取儲存層](../../../storage/blobs/storage-blob-storage-tiers.md)。</span><span class="sxs-lookup"><span data-stu-id="dc839-161">Customers have the choice between &quot;hot&quot; and &quot;cold&quot; blob storage (see [Azure Blob Storage: Hot and cool storage tiers](../../../storage/blobs/storage-blob-storage-tiers.md)).</span></span>

<span data-ttu-id="dc839-162">使用 blobxfer 工具，將 SAP HANA 備份檔案直接複製到 Azure Blob 儲存體很容易。</span><span class="sxs-lookup"><span data-stu-id="dc839-162">With the blobxfer tool, it is easy to copy the SAP HANA backup files directly to Azure blob storage.</span></span>

![在這裡可以看到完整的 SAP HANA 檔案備份的檔案](media/sap-hana-backup-file-level/image026.png)

<span data-ttu-id="dc839-164">在這裡可以看到完整的 SAP HANA 檔案備份的檔案。</span><span class="sxs-lookup"><span data-stu-id="dc839-164">Here one can see the files of a full SAP HANA file backup.</span></span> <span data-ttu-id="dc839-165">有四個檔案，最大的一個約 230 GB。</span><span class="sxs-lookup"><span data-stu-id="dc839-165">There are four files and the biggest one has roughly 230 GB.</span></span>

![將 230 GB 複製至 Azure 的標準儲存體帳戶 blob 容器花了大約 3000 秒](media/sap-hana-backup-file-level/image027.png)

<span data-ttu-id="dc839-167">在初始測試中沒有使用 md5 雜湊，將 230 GB 複製至 Azure 的標準儲存體帳戶 blob 容器花了大約 3000 秒。</span><span class="sxs-lookup"><span data-stu-id="dc839-167">Not using md5 hash in the initial test, it took roughly 3000 seconds to copy the 230 GB to an Azure standard storage account blob container.</span></span>

![在這個螢幕擷取畫面中，可以看到它在 Azure 入口網站中的樣子](media/sap-hana-backup-file-level/image028.png)

<span data-ttu-id="dc839-169">在這個螢幕擷取畫面中，可以看到它在 Azure 入口網站中的樣子。</span><span class="sxs-lookup"><span data-stu-id="dc839-169">In this screenshot, one can see how it looks on the Azure portal.</span></span> <span data-ttu-id="dc839-170">建立了一個名為 &quot;sap-hana-backups&quot; 的 blob 容器，其中包含四個 blob，代表 SAP HANA 備份檔案。</span><span class="sxs-lookup"><span data-stu-id="dc839-170">A blob container named &quot;sap-hana-backups&quot; was created and includes the four blobs, which represent the SAP HANA backup files.</span></span> <span data-ttu-id="dc839-171">其中一個的大小約為 230 GB。</span><span class="sxs-lookup"><span data-stu-id="dc839-171">One of them has a size of roughly 230 GB.</span></span>

<span data-ttu-id="dc839-172">HANA Studio 備份主控台可讓您限制 HANA 備份檔案的檔案大小上限。</span><span class="sxs-lookup"><span data-stu-id="dc839-172">The HANA Studio backup console allows one to restrict the max file size of HANA backup files.</span></span> <span data-ttu-id="dc839-173">在範例環境中，有多個較小的備份檔案，而不是一個大型的 230 GB 檔案，可增進效能。</span><span class="sxs-lookup"><span data-stu-id="dc839-173">In the sample environment, it improved performance by making it possible to have multiple smaller backup files, instead of one large 230-GB file.</span></span>

![設定 HANA 端的備份檔案大小限制不會改善備份時間](media/sap-hana-backup-file-level/image029.png)

<span data-ttu-id="dc839-175">設定 HANA 端的備份檔案大小限制不會改善備份時間，因為檔案會循序寫入，如此圖中所示。</span><span class="sxs-lookup"><span data-stu-id="dc839-175">Setting the backup file size limit on the HANA side doesn&#39;t improve the backup time, because the files are written sequentially as shown in this figure.</span></span> <span data-ttu-id="dc839-176">檔案大小上限設定為 60 GB，因此備份會建立四個大型資料檔案，而不是 230 GB 的單一檔案。</span><span class="sxs-lookup"><span data-stu-id="dc839-176">The file size limit was set to 60 GB, so the backup created four large data files instead of the 230-GB single file.</span></span>

![為了測試 blobxfer 工具的平行處理原則，而將 HANA 備份的檔案大小上限設為 15 GB](media/sap-hana-backup-file-level/image030.png)

<span data-ttu-id="dc839-178">為了測試 blobxfer 工具的平行處理原則，而將 HANA 備份的檔案大小上限設為 15 GB，得到 19 個備份檔案。</span><span class="sxs-lookup"><span data-stu-id="dc839-178">To test parallelism of the blobxfer tool, the max file size for HANA backups was then set to 15 GB, which resulted in 19 backup files.</span></span> <span data-ttu-id="dc839-179">如此設定，將 blobxfer 複製 230 GB 至 Azure Blob 儲存體的時間，從 3000 秒降至 875 秒 。</span><span class="sxs-lookup"><span data-stu-id="dc839-179">This configuration brought the time for blobxfer to copy the 230 GB to Azure blob storage from 3000 seconds down to 875 seconds.</span></span>

<span data-ttu-id="dc839-180">得到這個結果，是因為寫入 Azure blob 有每秒 60 MB 的限制。</span><span class="sxs-lookup"><span data-stu-id="dc839-180">This result is due to the limit of 60 MB/sec for writing an Azure blob.</span></span> <span data-ttu-id="dc839-181">透過多個 blob 實行平行處理原則可以解決瓶頸，但缺點是︰將 blobxfer 工具複製所有 HANA 備份檔案到 Azure Blob 儲存體的效能增加時，會加重 HANA VM 和網路的負載。</span><span class="sxs-lookup"><span data-stu-id="dc839-181">Parallelism via multiple blobs solves the bottleneck, but there is a downside: increasing performance of the blobxfer tool to copy all these HANA backup files to Azure blob storage puts load on both the HANA VM and the network.</span></span> <span data-ttu-id="dc839-182">HANA 系統的作業會受影響。</span><span class="sxs-lookup"><span data-stu-id="dc839-182">Operation of HANA system becomes impacted.</span></span>

## <a name="blob-copy-of-dedicated-azure-data-disks-in-backup-software-raid"></a><span data-ttu-id="dc839-183">在備份軟體 RAID 中進行 Azure 專用資料磁碟的 Blob 複製</span><span class="sxs-lookup"><span data-stu-id="dc839-183">Blob copy of dedicated Azure data disks in backup software RAID</span></span>

<span data-ttu-id="dc839-184">不同於手動 VM 資料磁碟備份，這個做法不會備份 VM 上的所有資料磁碟儲存整個 SAP 安裝，包括 HANA 資料、HANA 記錄檔和組態檔。</span><span class="sxs-lookup"><span data-stu-id="dc839-184">Unlike the manual VM data disk backup, in this approach one does not back up all the data disks on a VM to save the whole SAP installation, including HANA data, HANA log files, and config files.</span></span> <span data-ttu-id="dc839-185">相反地，其概念是將專用的軟體 RAID 搭配串接多個 Azure 資料 VHD，來儲存完整的 SAP HANA 檔案備份。</span><span class="sxs-lookup"><span data-stu-id="dc839-185">Instead, the idea is to have dedicated software RAID with striping across multiple Azure data VHDs for storing a full SAP HANA file backup.</span></span> <span data-ttu-id="dc839-186">可以只複製這些包含 SAP HANA 備份的磁碟。</span><span class="sxs-lookup"><span data-stu-id="dc839-186">One copies only these disks, which have the SAP HANA backup.</span></span> <span data-ttu-id="dc839-187">它們可以輕鬆地保存在專用的 HANA 備份儲存體帳戶中，或連結到專用的「備份管理 VM」&quot;&quot;供進一步處理。</span><span class="sxs-lookup"><span data-stu-id="dc839-187">They could easily be kept in a dedicated HANA backup storage account, or attached to a dedicated &quot;backup management VM&quot; for further processing.</span></span>

![使用 **start-azurestorageblobcopy** PowerShell 命令複製所有相關的 VHD](media/sap-hana-backup-file-level/image031.png)

<span data-ttu-id="dc839-189">備份至本機軟體 RAID 完成之後，使用 **start-azurestorageblobcopy** PowerShell 命令複製所有相關的 VHD (請參閱 [Start-AzureStorageBlobCopy](/powershell/module/azure.storage/start-azurestorageblobcopy))。</span><span class="sxs-lookup"><span data-stu-id="dc839-189">After the backup to the local software RAID was completed, all VHDs involved were copied using the **start-azurestorageblobcopy** PowerShell command (see [Start-AzureStorageBlobCopy](/powershell/module/azure.storage/start-azurestorageblobcopy)).</span></span> <span data-ttu-id="dc839-190">由於它只會影響保留備份檔案的專用檔案系統，無需考慮 SAP HANA 資料或磁碟上的記錄檔一致性。</span><span class="sxs-lookup"><span data-stu-id="dc839-190">As it only affects the dedicated file system for keeping the backup files, there are no concerns about SAP HANA data or log file consistency on the disk.</span></span> <span data-ttu-id="dc839-191">這個命令的好處是，它可以在 VM 為線上狀態時運作。</span><span class="sxs-lookup"><span data-stu-id="dc839-191">A benefit of this command is that it works while the VM stays online.</span></span> <span data-ttu-id="dc839-192">若要確保沒有處理序寫入備份串接集，請務必在 blob 複本之前先它取消掛接，之後再將它掛接回來。</span><span class="sxs-lookup"><span data-stu-id="dc839-192">To be certain that no process writes to the backup stripe set, be sure to unmount it before the blob copy, and mount it again afterwards.</span></span> <span data-ttu-id="dc839-193">或者，可以使用適當的方式「凍結」&quot;&quot;檔案系統。</span><span class="sxs-lookup"><span data-stu-id="dc839-193">Or one could use an appropriate way to &quot;freeze&quot; the file system.</span></span> <span data-ttu-id="dc839-194">例如，在 XFS 檔案系統使用 xfs\_freeze。</span><span class="sxs-lookup"><span data-stu-id="dc839-194">For example, via xfs\_freeze for the XFS file system.</span></span>

![這個螢幕擷取畫面顯示 Azure 入口網站上 vhd 容器中的 blob 清單](media/sap-hana-backup-file-level/image032.png)

<span data-ttu-id="dc839-196">這個螢幕擷取畫面顯示 Azure 入口網站上 &quot;vhd&quot; 容器中的 blob 清單。</span><span class="sxs-lookup"><span data-stu-id="dc839-196">This screenshot shows the list of blobs in the &quot;vhds&quot; container on the Azure portal.</span></span> <span data-ttu-id="dc839-197">螢幕擷取畫面顯示五個 VHD，它們連結至 SAP HANA 伺服器 VM 作為軟體 RAID，以保留 SAP HANA 備份檔案。</span><span class="sxs-lookup"><span data-stu-id="dc839-197">The screenshot shows the five VHDs, which were attached to the SAP HANA server VM to serve as the software RAID to keep SAP HANA backup files.</span></span> <span data-ttu-id="dc839-198">畫面中也顯示 5 個複本，這些是經由 blob 複製命令得到的。</span><span class="sxs-lookup"><span data-stu-id="dc839-198">It also shows the five copies, which were taken via the blob copy command.</span></span>

![基於測試目的，SAP HANA 備份軟體 RAID 磁碟的複本已連結至應用程式伺服器 VM](media/sap-hana-backup-file-level/image033.png)

<span data-ttu-id="dc839-200">基於測試目的，SAP HANA 備份軟體 RAID 磁碟的複本已連結至應用程式伺服器 VM。</span><span class="sxs-lookup"><span data-stu-id="dc839-200">For testing purposes, the copies of the SAP HANA backup software RAID disks were attached to the app server VM.</span></span>

![已關閉應用程式伺服器 VM 以連結磁碟複本](media/sap-hana-backup-file-level/image034.png)

<span data-ttu-id="dc839-202">已關閉應用程式伺服器 VM 以連結磁碟複本。</span><span class="sxs-lookup"><span data-stu-id="dc839-202">The app server VM was shut down to attach the disk copies.</span></span> <span data-ttu-id="dc839-203">啟動 VM 之後，可正確找到磁碟和 RAID (透過 UUID 掛接)。</span><span class="sxs-lookup"><span data-stu-id="dc839-203">After starting the VM, the disks and the RAID were discovered correctly (mounted via UUID).</span></span> <span data-ttu-id="dc839-204">只有遺失透過 YaST partitioner 建立的掛接點。</span><span class="sxs-lookup"><span data-stu-id="dc839-204">Only the mount point was missing, which was created via the YaST partitioner.</span></span> <span data-ttu-id="dc839-205">之後，便可在 OS 層級看到 SAP HANA 備份檔案的複本。</span><span class="sxs-lookup"><span data-stu-id="dc839-205">Afterwards the SAP HANA backup file copies became visible on OS level.</span></span>

## <a name="copy-sap-hana-backup-files-to-nfs-share"></a><span data-ttu-id="dc839-206">將 SAP HANA 備份檔案複製到 NFS 共用</span><span class="sxs-lookup"><span data-stu-id="dc839-206">Copy SAP HANA backup files to NFS share</span></span>

<span data-ttu-id="dc839-207">從效能或磁碟空間的觀點來看，若要減少對 SAP HANA 系統的潛在影響，可以考慮將 SAP HANA 備份檔案儲存在 NFS 共用上。</span><span class="sxs-lookup"><span data-stu-id="dc839-207">To lessen the potential impact on the SAP HANA system from a performance or disk space perspective, one might consider storing the SAP HANA backup files on an NFS share.</span></span> <span data-ttu-id="dc839-208">這技術上可行，但表示要使用第二個 Azure VM 作為 NFS 共用的主機。</span><span class="sxs-lookup"><span data-stu-id="dc839-208">Technically it works, but it means using a second Azure VM as the host of the NFS share.</span></span> <span data-ttu-id="dc839-209">因為 VM 網路頻寬的緣故，它不應該是小型的 VM 大小。</span><span class="sxs-lookup"><span data-stu-id="dc839-209">It should not be a small VM size, due to the VM network bandwidth.</span></span> <span data-ttu-id="dc839-210">合理的做法是關閉此「備份 VM」&quot;&quot;，只讓它在進行 SAP HANA 備份時執行。</span><span class="sxs-lookup"><span data-stu-id="dc839-210">It would make sense then to shut down this &quot;backup VM&quot; and only bring it up for executing the SAP HANA backup.</span></span> <span data-ttu-id="dc839-211">寫入 NFS 共用會加重網路的負載，影響 SAP HANA 系統，但只是事後管理「備份 VM」&quot;&quot;上的備份檔案，完全不會影響 SAP HANA 系統。</span><span class="sxs-lookup"><span data-stu-id="dc839-211">Writing on an NFS share puts load on the network and impacts the SAP HANA system, but merely managing the backup files afterwards on the &quot;backup VM&quot; would not influence the SAP HANA system at all.</span></span>

![另一個 Azure VM上的 NFS 共用掛接至 SAP HANA 伺服器 VM](media/sap-hana-backup-file-level/image035.png)

<span data-ttu-id="dc839-213">為了確認 NFS 使用案例，將另一個 Azure VM上的 NFS 共用掛接至 SAP HANA 伺服器 VM。</span><span class="sxs-lookup"><span data-stu-id="dc839-213">To verify the NFS use case, an NFS share from another Azure VM was mounted to the SAP HANA server VM.</span></span> <span data-ttu-id="dc839-214">沒有套用任何特別的 NFS 微調。</span><span class="sxs-lookup"><span data-stu-id="dc839-214">There was no special NFS tuning applied.</span></span>

![直接備份花了 1 小時 46 分鐘](media/sap-hana-backup-file-level/image036.png)

<span data-ttu-id="dc839-216">NFS 共用是快速串接集，就像 SAP HANA 伺服器上的一樣。</span><span class="sxs-lookup"><span data-stu-id="dc839-216">The NFS share was a fast stripe set, like the one on the SAP HANA server.</span></span> <span data-ttu-id="dc839-217">不過，當寫入本機串接集時，在 NFS 共用上進行直接備份花了 1 小時 46 分鐘來，而不是 10 分鐘。</span><span class="sxs-lookup"><span data-stu-id="dc839-217">Nevertheless, it took 1 hour and 46 minutes to do the backup directly on the NFS share instead of 10 minutes, when writing to a local stripe set.</span></span>

![替代方法 1 小時 43 分鐘沒快多少](media/sap-hana-backup-file-level/image037.png)

<span data-ttu-id="dc839-219">對本機等量磁碟區執行備份，並複製到 OS 層級之 NFS 共用的替代方法 (簡單的 **cp -avr** 命令) 沒快多少，</span><span class="sxs-lookup"><span data-stu-id="dc839-219">The alternative of doing a backup to a local stripe set and copying to the NFS share on OS level (a simple **cp -avr** command) wasn't much quicker.</span></span> <span data-ttu-id="dc839-220">花了 1 小時 43 分鐘。</span><span class="sxs-lookup"><span data-stu-id="dc839-220">It took 1 hour and 43 minutes.</span></span>

<span data-ttu-id="dc839-221">它的確可行，但效能不如 230 GB 備份測試好。</span><span class="sxs-lookup"><span data-stu-id="dc839-221">So it works, but performance wasn't good for the 230-GB backup test.</span></span> <span data-ttu-id="dc839-222">若遇到數 TB 的資料，可能會更糟。</span><span class="sxs-lookup"><span data-stu-id="dc839-222">It would look even worse for multi terabytes.</span></span>

## <a name="copy-sap-hana-backup-files-to-azure-file-service"></a><span data-ttu-id="dc839-223">將 SAP HANA 備份檔案複製到 Azure 檔案服務</span><span class="sxs-lookup"><span data-stu-id="dc839-223">Copy SAP HANA backup files to Azure file service</span></span>

<span data-ttu-id="dc839-224">可以將 Azure 檔案共用掛接在 Azure Linux VM 內部。</span><span class="sxs-lookup"><span data-stu-id="dc839-224">It is possible to mount an Azure file share inside an Azure Linux VM.</span></span> <span data-ttu-id="dc839-225">[如何搭配使用 Azure 檔案儲存體與 Linux](../../../storage/files/storage-how-to-use-files-linux.md) 一文提供作法的詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="dc839-225">The article [How to use Azure File storage with Linux](../../../storage/files/storage-how-to-use-files-linux.md) provides details on how to do it.</span></span> <span data-ttu-id="dc839-226">請記住，目前 Azure 檔案共用有 5 TB 配額的限制，以及每個檔案 1 TB 的檔案大小限制。</span><span class="sxs-lookup"><span data-stu-id="dc839-226">Keep in mind that there is currently a 5-TB quota limit of one Azure file share, and a file size limit of 1 TB per file.</span></span> <span data-ttu-id="dc839-227">如需儲存體限制的詳細資訊，請參閱 [Azure 儲存體延展性和效能目標](../../../storage/common/storage-scalability-targets.md) (英文)。</span><span class="sxs-lookup"><span data-stu-id="dc839-227">See [Azure Storage Scalability and Performance Targets](../../../storage/common/storage-scalability-targets.md) for information on storage limits.</span></span>

<span data-ttu-id="dc839-228">不過測試顯示，SAP HANA 備份目前不能直接搭配使用這種 CIFS 掛接。</span><span class="sxs-lookup"><span data-stu-id="dc839-228">Tests have shown, however, that SAP HANA backup doesn&#39;t currently work directly with this kind of CIFS mount.</span></span> <span data-ttu-id="dc839-229">在 [SAP Note 1820529](https://launchpad.support.sap.com/#/notes/1820529) (英文) 中也提到不建議使用 CIFS。</span><span class="sxs-lookup"><span data-stu-id="dc839-229">It is also stated in [SAP Note 1820529](https://launchpad.support.sap.com/#/notes/1820529) that CIFS is not recommended.</span></span>

![本圖為 SAP HANA Studio 的備份對話方塊中顯示的錯誤](media/sap-hana-backup-file-level/image038.png)

<span data-ttu-id="dc839-231">本圖顯示嘗試直接備份到掛接 CIFS 的 Azure 檔案共用時，SAP HANA Studio 的備份對話方塊中顯示的錯誤。</span><span class="sxs-lookup"><span data-stu-id="dc839-231">This figure shows an error in the backup dialog in SAP HANA Studio, when trying to back up directly to a CIFS-mounted Azure file share.</span></span> <span data-ttu-id="dc839-232">因此必須執行標準 SAP HANA 備份先備份到 VM 檔案系統，然後將備份檔案從該處複製到 Azure 檔案服務。</span><span class="sxs-lookup"><span data-stu-id="dc839-232">So one has to do a standard SAP HANA backup into a VM file system first, and then copy the backup files from there to Azure file service.</span></span>

![本圖顯示複製 19 個 SAP HANA 備份檔案需要約 929 秒](media/sap-hana-backup-file-level/image039.png)

<span data-ttu-id="dc839-234">本圖顯示將 19 個 SAP HANA 備份檔案 (總計大小約 230 GB) 複製到 Azure 檔案共用需要約 929 秒。</span><span class="sxs-lookup"><span data-stu-id="dc839-234">This figure shows that it took about 929 seconds to copy 19 SAP HANA backup files with a total size of roughly 230 GB to the Azure file share.</span></span>

![在 SAP HANA VM 上的來源目錄結構已複製到 Azure 檔案共用](media/sap-hana-backup-file-level/image040.png)

<span data-ttu-id="dc839-236">在這個螢幕擷取畫面中可以看到，SAP HANA VM 上的來源目錄結構已複製到 Azure 檔案共用︰一個目錄 (hana\_backup\_fsl\_15gb) 和 19 個個別的備份檔案。</span><span class="sxs-lookup"><span data-stu-id="dc839-236">In this screenshot, one can see that the source directory structure on the SAP HANA VM was copied to the Azure file share: one directory (hana\_backup\_fsl\_15gb) and 19 individual backup files.</span></span>

<span data-ttu-id="dc839-237">在未來，當 SAP HANA 檔案備份直接支援時，將 SAP HANA 備份檔案儲存在 Azure 檔案可能是個有趣的選項。</span><span class="sxs-lookup"><span data-stu-id="dc839-237">Storing SAP HANA backup files on Azure files could be an interesting option in the future when SAP HANA file backups support it directly.</span></span> <span data-ttu-id="dc839-238">或者，當有可能透過 NFS 掛接 Azure 檔案，且配額上限大幅高於 5 TB 時。</span><span class="sxs-lookup"><span data-stu-id="dc839-238">Or when it becomes possible to mount Azure files via NFS and the maximum quota limit is considerably higher than 5 TB.</span></span>

## <a name="next-steps"></a><span data-ttu-id="dc839-239">後續步驟</span><span class="sxs-lookup"><span data-stu-id="dc839-239">Next steps</span></span>
* <span data-ttu-id="dc839-240">[Azure 虛擬機器上 SAP HANA 的備份指南](sap-hana-backup-guide.md)提供快速入門的概觀和詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="dc839-240">[Backup guide for SAP HANA on Azure Virtual Machines](sap-hana-backup-guide.md) gives an overview and information on getting started.</span></span>
* <span data-ttu-id="dc839-241">[以儲存體快照集為基礎的 SAP HANA 備份](sap-hana-backup-storage-snapshots.md)描述以儲存體快照集為基礎的備份選項。</span><span class="sxs-lookup"><span data-stu-id="dc839-241">[SAP HANA backup based on storage snapshots](sap-hana-backup-storage-snapshots.md) describes the storage snapshot-based backup option.</span></span>
* <span data-ttu-id="dc839-242">若要了解如何建立高可用性並為 Azure 上的 SAP HANA 規劃災害復原，請參閱 [Azure 上的 SAP HANA (大型執行個體) 高可用性和災害復原](hana-overview-high-availability-disaster-recovery.md)。</span><span class="sxs-lookup"><span data-stu-id="dc839-242">To learn how to establish high availability and plan for disaster recovery of SAP HANA on Azure (large instances), see [SAP HANA (large instances) high availability and disaster recovery on Azure](hana-overview-high-availability-disaster-recovery.md).</span></span>
