---
title: "aaaAzure Cosmos DB 防火牆支援與 IP 存取控制 |Microsoft 文件"
description: "了解防火牆 toouse IP 存取控制原則如何支援 Azure Cosmos DB 資料庫帳戶。"
keywords: "IP 存取控制，防火牆支援"
services: cosmos-db
author: shahankur11
manager: jhubbard
editor: 
tags: azure-resource-manager
documentationcenter: 
ms.assetid: c1b9ede0-ed93-411a-ac9a-62c113a8e887
ms.service: cosmos-db
ms.workload: data-services
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/22/2017
ms.author: ankshah
ms.openlocfilehash: b5cdbdb28e9d7ee0fd0ea54aad277167b699929f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/06/2017
---
# <a name="azure-cosmos-db-firewall-support"></a><span data-ttu-id="935dc-104">Azure Cosmos DB 防火牆支援</span><span class="sxs-lookup"><span data-stu-id="935dc-104">Azure Cosmos DB firewall support</span></span>
<span data-ttu-id="935dc-105">toosecure 資料儲存在 Azure Cosmos DB 資料庫帳戶，Azure Cosmos 資料庫提供支援為基礎的密碼[授權模型](https://msdn.microsoft.com/library/azure/dn783368.aspx)，利用強式雜湊式訊息驗證碼 (HMAC)。</span><span class="sxs-lookup"><span data-stu-id="935dc-105">toosecure data stored in an Azure Cosmos DB database account, Azure Cosmos DB has provided support for a secret based [authorization model](https://msdn.microsoft.com/library/azure/dn783368.aspx) that utilizes a strong Hash-based message authentication code (HMAC).</span></span> <span data-ttu-id="935dc-106">現在，此外 toohello 密碼型授權模型，Azure Cosmos DB 支援原則導向的連入的防火牆支援 IP 為基礎的存取控制項。</span><span class="sxs-lookup"><span data-stu-id="935dc-106">Now, in addition toohello secret based authorization model, Azure Cosmos DB supports policy driven IP-based access controls for inbound firewall support.</span></span> <span data-ttu-id="935dc-107">此模型是非常類似傳統的資料庫系統的 toohello 防火牆規則，並提供額外一層的安全性 toohello Azure Cosmos DB 資料庫帳戶。</span><span class="sxs-lookup"><span data-stu-id="935dc-107">This model is very similar toohello firewall rules of a traditional database system and provides an additional level of security toohello Azure Cosmos DB database account.</span></span> <span data-ttu-id="935dc-108">使用這個模型，您可以現在設定 Azure Cosmos DB 資料庫帳戶 toobe 只能從機器的核准設定組和/或雲端服務。</span><span class="sxs-lookup"><span data-stu-id="935dc-108">With this model, you can now configure an Azure Cosmos DB database account toobe accessible only from an approved set of machines and/or cloud services.</span></span> <span data-ttu-id="935dc-109">從這些已核准的機器和服務集合的存取 tooAzure Cosmos DB 資源仍然需要 hello 呼叫端 toopresent 有效的授權權杖。</span><span class="sxs-lookup"><span data-stu-id="935dc-109">Access tooAzure Cosmos DB resources from these approved sets of machines and services still require hello caller toopresent a valid authorization token.</span></span>

## <a name="ip-access-control-overview"></a><span data-ttu-id="935dc-110">IP 存取控制概觀</span><span class="sxs-lookup"><span data-stu-id="935dc-110">IP access control overview</span></span>
<span data-ttu-id="935dc-111">根據預設，Azure Cosmos DB 資料庫帳戶是可從公用網際網路存取，只要 hello 要求伴隨著有效的授權權杖。</span><span class="sxs-lookup"><span data-stu-id="935dc-111">By default, an Azure Cosmos DB database account is accessible from public internet as long as hello request is accompanied by a valid authorization token.</span></span> <span data-ttu-id="935dc-112">tooconfigure IP 以原則為基礎的存取控制，hello 使用者必須提供 hello 組 IP 位址或 CIDR 形式 toobe 包含做為 hello 允許指定的資料庫帳戶的用戶端 Ip 清單中的 IP 位址範圍。</span><span class="sxs-lookup"><span data-stu-id="935dc-112">tooconfigure IP policy-based access control, hello user must provide hello set of IP addresses or IP address ranges in CIDR form toobe included as hello allowed list of client IPs for a given database account.</span></span> <span data-ttu-id="935dc-113">一旦套用此設定時，源自於此的允許清單外機器的所有要求將會都封鎖 hello 伺服器。</span><span class="sxs-lookup"><span data-stu-id="935dc-113">Once this configuration is applied, all requests originating from machines outside this allowed list will be blocked by hello server.</span></span>  <span data-ttu-id="935dc-114">hello 下列圖表中所述的處理 hello IP 為基礎的存取控制流程的 hello 連接。</span><span class="sxs-lookup"><span data-stu-id="935dc-114">hello connection processing flow for hello IP-based access control is described in hello following diagram.</span></span>

![顯示 hello 連線程序以 IP 為基礎的存取控制的圖表](./media/firewall-support/firewall-support-flow.png)

## <a name="connections-from-cloud-services"></a><span data-ttu-id="935dc-116">從雲端服務的連接</span><span class="sxs-lookup"><span data-stu-id="935dc-116">Connections from cloud services</span></span>
<span data-ttu-id="935dc-117">在 Azure 中，雲端服務是使用 Azure Cosmos DB 裝載中介層服務邏輯的極常見方式。</span><span class="sxs-lookup"><span data-stu-id="935dc-117">In Azure, cloud services are a very common way for hosting middle tier service logic using Azure Cosmos DB.</span></span> <span data-ttu-id="935dc-118">tooenable 存取 tooan Azure Cosmos DB 資料庫帳戶從雲端服務，hello 雲端服務的 hello 公用 IP 位址必須是允許清單與您的 Azure Cosmos DB 資料庫帳戶所關聯的 IP 位址加入的 toohello[設定hello IP 存取控制原則](#configure-ip-policy)。</span><span class="sxs-lookup"><span data-stu-id="935dc-118">tooenable access tooan Azure Cosmos DB database account from a cloud service, hello public IP address of hello cloud service must be added toohello allowed list of IP addresses associated with your Azure Cosmos DB database account by [configuring hello IP access control policy](#configure-ip-policy).</span></span>  <span data-ttu-id="935dc-119">這可確保雲端服務的所有角色執行個體都有存取 tooyour Azure Cosmos DB 資料庫帳戶。</span><span class="sxs-lookup"><span data-stu-id="935dc-119">This ensures that all role instances of cloud services have access tooyour Azure Cosmos DB database account.</span></span> <span data-ttu-id="935dc-120">Hello 下列螢幕擷取畫面所示，您可以擷取 hello Azure 入口網站中的雲端服務的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="935dc-120">You can retrieve IP addresses for your cloud services in hello Azure portal, as shown in hello following screenshot.</span></span>

![螢幕擷取畫面顯示 hello Azure 入口網站中的雲端服務的 hello 公用 IP 位址](./media/firewall-support/public-ip-addresses.png)

<span data-ttu-id="935dc-122">當您藉由加入其他角色執行個體擴展您的雲端服務時，這些新的執行個體就會自動擁有存取 toohello Azure Cosmos DB 資料庫帳戶因為它們屬於 hello 的相同雲端服務。</span><span class="sxs-lookup"><span data-stu-id="935dc-122">When you scale out your cloud service by adding additional role instance(s), those new instances will automatically have access toohello Azure Cosmos DB database account since they are part of hello same cloud service.</span></span>

## <a name="connections-from-virtual-machines"></a><span data-ttu-id="935dc-123">從虛擬機器的連接</span><span class="sxs-lookup"><span data-stu-id="935dc-123">Connections from virtual machines</span></span>
<span data-ttu-id="935dc-124">[虛擬機器](https://azure.microsoft.com/services/virtual-machines/)或[虛擬機器擴展集](../virtual-machine-scale-sets/virtual-machine-scale-sets-overview.md)也可以使用的 toohost 使用 Azure Cosmos DB 的中介層服務。</span><span class="sxs-lookup"><span data-stu-id="935dc-124">[Virtual machines](https://azure.microsoft.com/services/virtual-machines/) or [virtual machine scale sets](../virtual-machine-scale-sets/virtual-machine-scale-sets-overview.md) can also be used toohost middle tier services using Azure Cosmos DB.</span></span>  <span data-ttu-id="935dc-125">tooconfigure hello Azure Cosmos DB 資料庫帳戶 tooallow 存取的虛擬機器、 虛擬機器和/或虛擬機器規模集的公用 IP 位址必須設定為其中一個允許的 IP 位址，依您 Azure Cosmos DB 資料庫帳戶的 hello[設定 hello IP 存取控制原則](#configure-ip-policy)。</span><span class="sxs-lookup"><span data-stu-id="935dc-125">tooconfigure hello Azure Cosmos DB database account tooallow access from virtual machines, public IP addresses of virtual machine and/or virtual machine scale set must be configured as one of hello allowed IP addresses for your Azure Cosmos DB database account by [configuring hello IP access control policy](#configure-ip-policy).</span></span> <span data-ttu-id="935dc-126">Hello 下列螢幕擷取畫面所示，您可以擷取 hello Azure 入口網站中的虛擬機器的 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="935dc-126">You can retrieve IP addresses for virtual machines in hello Azure portal, as shown in hello following screenshot.</span></span>

![螢幕擷取畫面顯示 hello Azure 入口網站中的虛擬機器的公用 IP 位址](./media/firewall-support/public-ip-addresses-dns.png)

<span data-ttu-id="935dc-128">當您新增其他虛擬機器執行個體 toohello 群組時，它們會自動提供存取 tooyour Azure Cosmos DB 資料庫帳戶。</span><span class="sxs-lookup"><span data-stu-id="935dc-128">When you add additional virtual machine instances toohello group, they are automatically provided access tooyour Azure Cosmos DB database account.</span></span>

## <a name="connections-from-hello-internet"></a><span data-ttu-id="935dc-129">從連線 hello 網際網路</span><span class="sxs-lookup"><span data-stu-id="935dc-129">Connections from hello internet</span></span>
<span data-ttu-id="935dc-130">當您存取 Azure Cosmos DB 資料庫的電腦帳戶 hello 網際網路時，hello 用戶端 IP 位址或 IP 位址範圍的 hello 機器必須加入的 toohello 允許 hello Azure Cosmos DB 資料庫帳戶的 IP 位址的清單。</span><span class="sxs-lookup"><span data-stu-id="935dc-130">When you access an Azure Cosmos DB database account from a computer on hello internet, hello client IP address or IP address range of hello machine must be added toohello allowed list of IP address for hello Azure Cosmos DB database account.</span></span> 

## <span data-ttu-id="935dc-131"><a id="configure-ip-policy"></a>設定 hello IP 存取控制原則</span><span class="sxs-lookup"><span data-stu-id="935dc-131"><a id="configure-ip-policy"></a> Configuring hello IP access control policy</span></span>
<span data-ttu-id="935dc-132">hello IP 存取控制原則可以設定在 hello Azure 入口網站，或以程式設計方式透過[Azure CLI](cli-samples.md)， [Azure Powershell](powershell-samples.md)，或使用 hello [REST API](/rest/api/documentdb/)藉由更新 hello `ipRangeFilter`屬性。</span><span class="sxs-lookup"><span data-stu-id="935dc-132">hello IP access control policy can be set in hello Azure portal, or programmatically through [Azure CLI](cli-samples.md), [Azure Powershell](powershell-samples.md), or hello [REST API](/rest/api/documentdb/) by updating hello `ipRangeFilter` property.</span></span> <span data-ttu-id="935dc-133">IP 位址/範圍必須以逗號分隔，而且不得包含任何空格。</span><span class="sxs-lookup"><span data-stu-id="935dc-133">IP addresses/ranges must be comma separated and must not contain any spaces.</span></span> <span data-ttu-id="935dc-134">範例："13.91.6.132,13.91.6.1/24"。</span><span class="sxs-lookup"><span data-stu-id="935dc-134">Example: "13.91.6.132,13.91.6.1/24".</span></span> <span data-ttu-id="935dc-135">在更新資料庫帳戶時透過這些方法，是確定 toopopulate 所有 hello 屬性 tooprevent 重設 toodefault 設定。</span><span class="sxs-lookup"><span data-stu-id="935dc-135">When updating your database account through these methods, be sure toopopulate all of hello properties tooprevent resetting toodefault settings.</span></span>

> [!NOTE]
> <span data-ttu-id="935dc-136">藉由啟用您的 Azure Cosmos DB 資料庫帳戶 IP 存取控制原則，所有存取 tooyour 外 hello 設定機器 Azure Cosmos DB 資料庫帳戶都允許的 IP 位址範圍清單遭到封鎖。</span><span class="sxs-lookup"><span data-stu-id="935dc-136">By enabling an IP access control policy for your Azure Cosmos DB database account, all access tooyour Azure Cosmos DB database account from machines outside hello configured allowed list of IP address ranges are blocked.</span></span> <span data-ttu-id="935dc-137">由於此模型中，瀏覽 hello 資料平面作業從 hello 入口網站也會封鎖的 tooensure hello 完整性的存取控制。</span><span class="sxs-lookup"><span data-stu-id="935dc-137">By virtue of this model, browsing hello data plane operation from hello portal will also be blocked tooensure hello integrity of access control.</span></span>

<span data-ttu-id="935dc-138">toosimplify 開發 hello Azure 入口網站可協助您識別及新增的允許清單中，您用戶端機器 toohello hello IP，以便執行您的電腦的應用程式可以存取 hello Azure Cosmos DB 帳戶。</span><span class="sxs-lookup"><span data-stu-id="935dc-138">toosimplify development, hello Azure portal helps you identify and add hello IP of your client machine toohello allowed list, so that apps running your machine can access hello Azure Cosmos DB account.</span></span> <span data-ttu-id="935dc-139">請注意看見 hello 入口網站偵測到 hello 用戶端 IP 位址。</span><span class="sxs-lookup"><span data-stu-id="935dc-139">Note that hello client IP address here is detected as seen by hello portal.</span></span> <span data-ttu-id="935dc-140">它可能是您的電腦，hello 用戶端 IP 位址，但也可能是您的網路閘道 hello IP 位址。</span><span class="sxs-lookup"><span data-stu-id="935dc-140">It may be hello client IP address of your machine, but it could also be hello IP address of your network gateway.</span></span> <span data-ttu-id="935dc-141">不要忘記 tooremove 進行 tooproduction 前面。</span><span class="sxs-lookup"><span data-stu-id="935dc-141">Do not forget tooremove it before going tooproduction.</span></span>

<span data-ttu-id="935dc-142">tooset hello IP 存取控制原則 hello Azure 入口網站中的瀏覽 toohello Azure Cosmos DB 帳戶 刀鋒視窗中，按一下**防火牆**hello 瀏覽功能表中，然後按一下**ON**</span><span class="sxs-lookup"><span data-stu-id="935dc-142">tooset hello IP access control policy in hello Azure portal, navigate toohello Azure Cosmos DB account blade, click **Firewall** in hello navigation menu, then click **ON**</span></span> 

![顯示如何 tooopen hello hello Azure 入口網站中的防火牆刀鋒視窗的螢幕擷取畫面](./media/firewall-support/azure-portal-firewall.png)

<span data-ttu-id="935dc-144">在 hello 新窗格中，指定是否 hello Azure 入口網站可以存取 hello 帳戶和其他位址和範圍視需要加入，然後按一下**儲存**。</span><span class="sxs-lookup"><span data-stu-id="935dc-144">In hello new pane, specify whether hello Azure portal can access hello account, and add other addresses and ranges as appropriate, then click **Save**.</span></span>  

> [!NOTE]
> <span data-ttu-id="935dc-145">當您啟用 IP 存取控制原則時，您會需要 hello Azure 入口網站 toomaintain 存取 tooadd hello IP 位址。</span><span class="sxs-lookup"><span data-stu-id="935dc-145">When you enable an IP access control policy, you need tooadd hello IP address for hello Azure portal toomaintain access.</span></span> <span data-ttu-id="935dc-146">hello 入口網站的 IP 位址為：</span><span class="sxs-lookup"><span data-stu-id="935dc-146">hello portal IP addresses are:</span></span>
> |<span data-ttu-id="935dc-147">區域</span><span class="sxs-lookup"><span data-stu-id="935dc-147">Region</span></span>|<span data-ttu-id="935dc-148">IP 位址</span><span class="sxs-lookup"><span data-stu-id="935dc-148">IP address</span></span>|
> |------|----------|
> |<span data-ttu-id="935dc-149">所有區域 (下面指定的區域除外)</span><span class="sxs-lookup"><span data-stu-id="935dc-149">All regions except those specified below</span></span>| <span data-ttu-id="935dc-150">104.42.195.92</span><span class="sxs-lookup"><span data-stu-id="935dc-150">104.42.195.92</span></span>|
> |<span data-ttu-id="935dc-151">德國</span><span class="sxs-lookup"><span data-stu-id="935dc-151">Germany</span></span>|<span data-ttu-id="935dc-152">51.4.229.218</span><span class="sxs-lookup"><span data-stu-id="935dc-152">51.4.229.218</span></span>|
> |<span data-ttu-id="935dc-153">中國</span><span class="sxs-lookup"><span data-stu-id="935dc-153">China</span></span>|<span data-ttu-id="935dc-154">139.217.8.252</span><span class="sxs-lookup"><span data-stu-id="935dc-154">139.217.8.252</span></span>|
> |<span data-ttu-id="935dc-155">美國政府亞利桑那州</span><span class="sxs-lookup"><span data-stu-id="935dc-155">US Gov Arizona</span></span>|<span data-ttu-id="935dc-156">52.244.48.71</span><span class="sxs-lookup"><span data-stu-id="935dc-156">52.244.48.71</span></span>|
>

![螢幕擷取畫面顯示如何 tooconfigure hello Azure 入口網站中的防火牆設定](./media/firewall-support/azure-portal-firewall-configure.png)

## <a name="troubleshooting-hello-ip-access-control-policy"></a><span data-ttu-id="935dc-158">疑難排解 hello IP 存取控制原則</span><span class="sxs-lookup"><span data-stu-id="935dc-158">Troubleshooting hello IP access control policy</span></span>
### <a name="portal-operations"></a><span data-ttu-id="935dc-159">入口網站作業</span><span class="sxs-lookup"><span data-stu-id="935dc-159">Portal operations</span></span>
<span data-ttu-id="935dc-160">藉由啟用您的 Azure Cosmos DB 資料庫帳戶 IP 存取控制原則，所有存取 tooyour 外 hello 設定機器 Azure Cosmos DB 資料庫帳戶都允許的 IP 位址範圍清單遭到封鎖。</span><span class="sxs-lookup"><span data-stu-id="935dc-160">By enabling an IP access control policy for your Azure Cosmos DB database account, all access tooyour Azure Cosmos DB database account from machines outside hello configured allowed list of IP address ranges are blocked.</span></span> <span data-ttu-id="935dc-161">因此如果您想 tooenable 入口網站的資料平面作業，例如瀏覽集合和查詢文件時，您需要 tooexplicitly 允許使用 hello Azure 入口網站存取**防火牆**hello 入口網站中的刀鋒視窗。</span><span class="sxs-lookup"><span data-stu-id="935dc-161">Therefore if you want tooenable portal data plane operations like browsing collections and query documents, you need tooexplicitly allow Azure portal access using hello **Firewall** blade in hello portal.</span></span> 

![螢幕擷取畫面顯示如何 tooenable 存取 toohello Azure 入口網站](./media/firewall-support/azure-portal-access-firewall.png)

### <a name="sdk--rest-api"></a><span data-ttu-id="935dc-163">SDK & Rest API</span><span class="sxs-lookup"><span data-stu-id="935dc-163">SDK & Rest API</span></span>
<span data-ttu-id="935dc-164">安全性考量，不能在允許清單的 hello 機器透過 SDK 或 REST API 存取將傳回泛型 404 找不到具有回應沒有其他詳細資料。</span><span class="sxs-lookup"><span data-stu-id="935dc-164">For security reasons, access via SDK or REST API from machines not on hello allowed list will return a generic 404 Not Found response with no additional details.</span></span> <span data-ttu-id="935dc-165">請確認 hello IP 允許清單中您的 Azure Cosmos DB 資料庫帳戶 tooensure hello 正確的原則組態設定會套用的 tooyour Azure Cosmos DB 資料庫帳戶。</span><span class="sxs-lookup"><span data-stu-id="935dc-165">Please verify hello IP allowed list configured for your Azure Cosmos DB database account tooensure hello correct policy configuration is applied tooyour Azure Cosmos DB database account.</span></span>

## <a name="next-steps"></a><span data-ttu-id="935dc-166">後續步驟</span><span class="sxs-lookup"><span data-stu-id="935dc-166">Next steps</span></span>
<span data-ttu-id="935dc-167">如需網路相關效能秘訣的相關資訊，請參閱[效能秘訣](performance-tips.md)。</span><span class="sxs-lookup"><span data-stu-id="935dc-167">For information about network related performance tips, see [Performance tips](performance-tips.md).</span></span>

