## <a name="prepare-for-akv-integration"></a><span data-ttu-id="452b3-101">準備進行 AKV 整合</span><span class="sxs-lookup"><span data-stu-id="452b3-101">Prepare for AKV Integration</span></span>
<span data-ttu-id="452b3-102">若要使用 Azure 金鑰保存庫整合以設定 SQL Server VM，有幾項必要條件：</span><span class="sxs-lookup"><span data-stu-id="452b3-102">To use Azure Key Vault Integration to configure your SQL Server VM, there are several prerequisites:</span></span> 

1. [<span data-ttu-id="452b3-103">安裝 Azure PowerShell</span><span class="sxs-lookup"><span data-stu-id="452b3-103">Install Azure Powershell</span></span>](#install-azure-powershell)
2. [<span data-ttu-id="452b3-104">建立 Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="452b3-104">Create an Azure Active Directory</span></span>](#create-an-azure-active-directory)
3. [<span data-ttu-id="452b3-105">建立金鑰保存庫</span><span class="sxs-lookup"><span data-stu-id="452b3-105">Create a key vault</span></span>](#create-a-key-vault)

<span data-ttu-id="452b3-106">下列各節說明這些必要條件和您必須收集以在稍後執行 PowerShell Cmdlet 的資訊。</span><span class="sxs-lookup"><span data-stu-id="452b3-106">The following sections describe these prerequisites and the information you need to collect to later run the PowerShell cmdlets.</span></span>

### <a name="install-azure-powershell"></a><span data-ttu-id="452b3-107">安裝 Azure PowerShell</span><span class="sxs-lookup"><span data-stu-id="452b3-107">Install Azure PowerShell</span></span>
<span data-ttu-id="452b3-108">確定您已安裝最新版本的 Azure PowerShell SDK。</span><span class="sxs-lookup"><span data-stu-id="452b3-108">Make sure you have installed the latest Azure PowerShell SDK.</span></span> <span data-ttu-id="452b3-109">如需詳細資訊，請參閱 [如何安裝和設定 Azure PowerShell](/powershell/azureps-cmdlets-docs)。</span><span class="sxs-lookup"><span data-stu-id="452b3-109">For more information, see [How to install and configure Azure PowerShell](/powershell/azureps-cmdlets-docs).</span></span>

### <a name="create-an-azure-active-directory"></a><span data-ttu-id="452b3-110">建立 Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="452b3-110">Create an Azure Active Directory</span></span>
<span data-ttu-id="452b3-111">首先，您必須在您的訂用帳戶中具有 [Azure Active Directory](https://azure.microsoft.com/trial/get-started-active-directory/) (AAD)。</span><span class="sxs-lookup"><span data-stu-id="452b3-111">First, you need to have an [Azure Active Directory](https://azure.microsoft.com/trial/get-started-active-directory/) (AAD) in your subscription.</span></span> <span data-ttu-id="452b3-112">在許多優點中，這可讓您將金鑰保存庫的權限授與特定使用者和應用程式。</span><span class="sxs-lookup"><span data-stu-id="452b3-112">Among many benefits, this allows you to grant permission to your key vault for certain users and applications.</span></span>

<span data-ttu-id="452b3-113">接下來，向 AAD 註冊應用程式。</span><span class="sxs-lookup"><span data-stu-id="452b3-113">Next, register an application with AAD.</span></span> <span data-ttu-id="452b3-114">如此會給予您服務主體帳戶，具有您的 VM 需要的金鑰保存庫的存取權。</span><span class="sxs-lookup"><span data-stu-id="452b3-114">This will give you a Service Principal account that has access to your key vault which your VM will need.</span></span> <span data-ttu-id="452b3-115">在 Azure 金鑰保存庫文章中，您可以在[向 Azure Active Directory 註冊應用程式](../articles/key-vault/key-vault-get-started.md#register)一節中找到這些步驟，或者您可以在[此部落格文章](http://blogs.technet.com/b/kv/archive/2015/01/09/azure-key-vault-step-by-step.aspx)的**取得應用程式的身分識別一節**查看具有螢幕擷取畫面的步驟。</span><span class="sxs-lookup"><span data-stu-id="452b3-115">In the Azure Key Vault article, you can find these steps in the [Register an application with Azure Active Directory](../articles/key-vault/key-vault-get-started.md#register) section, or you can see the steps with screen shots in the **Get an identity for the application section** of [this blog post](http://blogs.technet.com/b/kv/archive/2015/01/09/azure-key-vault-step-by-step.aspx).</span></span> <span data-ttu-id="452b3-116">在完成這些步驟之前，請注意您需要收集此註冊期間的下列資訊，稍後當您在 SQL VM 上啟用 Azure 金鑰保存庫整合時需要該資訊。</span><span class="sxs-lookup"><span data-stu-id="452b3-116">Before completing these steps, note that you need to collect the following information during this registration that is needed later when you enable Azure Key Vault Integration on your SQL VM.</span></span>

* <span data-ttu-id="452b3-117">新增應用程式之後，在 [設定] 索引標籤上尋找**用戶端識別碼**。</span><span class="sxs-lookup"><span data-stu-id="452b3-117">After the application is added, find the **CLIENT ID**  on the **CONFIGURE** tab.</span></span> 
    <span data-ttu-id="452b3-118">![Azure Active Directory 用戶端識別碼](./media/virtual-machines-sql-server-akv-prepare/aad-client-id.png)</span><span class="sxs-lookup"><span data-stu-id="452b3-118">![Azure Active Directory Client ID](./media/virtual-machines-sql-server-akv-prepare/aad-client-id.png)</span></span>
  
    <span data-ttu-id="452b3-119">用戶端識別碼稍後會指派給 PowerShell 指令碼中的 **$spName** (服務主體名稱) 參數，以啟用 Azure 金鑰保存庫整合。</span><span class="sxs-lookup"><span data-stu-id="452b3-119">The client ID is assigned later to the **$spName** (Service Principal name) parameter in the PowerShell script to enable Azure Key Vault Integration.</span></span> 
* <span data-ttu-id="452b3-120">另外，當您建立您的金鑰時在這些步驟中，複製您的金鑰的密碼，如下列螢幕擷取畫面所示。</span><span class="sxs-lookup"><span data-stu-id="452b3-120">Also, during these steps when you create your key, copy the secret for your key as is shown in the following screenshot.</span></span> <span data-ttu-id="452b3-121">這個金鑰密碼稍後會指派給 PowerShell 指令碼中的 **$spSecret** (服務主體密碼) 參數。</span><span class="sxs-lookup"><span data-stu-id="452b3-121">This key secret is assigned later to the **$spSecret** (Service Principal secret) parameter in the PowerShell script.</span></span>  
    <span data-ttu-id="452b3-122">![Azure Active Directory 密碼](./media/virtual-machines-sql-server-akv-prepare/aad-sp-secret.png)</span><span class="sxs-lookup"><span data-stu-id="452b3-122">![Azure Active Directory Secret](./media/virtual-machines-sql-server-akv-prepare/aad-sp-secret.png)</span></span>
* <span data-ttu-id="452b3-123">您必須授權讓這個新的用戶端識別碼擁有下列存取權限：**加密**、**解密**、**包裝金鑰**、**解除包裝金鑰**、**簽章** 和 **驗證**。</span><span class="sxs-lookup"><span data-stu-id="452b3-123">You must authorize this new client ID to have the following access permissions: **encrypt**, **decrypt**, **wrapKey**, **unwrapKey**, **sign**, and **verify**.</span></span> <span data-ttu-id="452b3-124">做法是使用 [Set-AzureRmKeyVaultAccessPolicy](https://msdn.microsoft.com/library/azure/mt603625.aspx) Cmdlet。</span><span class="sxs-lookup"><span data-stu-id="452b3-124">This is done with the [Set-AzureRmKeyVaultAccessPolicy](https://msdn.microsoft.com/library/azure/mt603625.aspx) cmdlet.</span></span> <span data-ttu-id="452b3-125">如需詳細資訊，請參閱 [授權應用程式使用金鑰或密碼](../articles/key-vault/key-vault-get-started.md#authorize)。</span><span class="sxs-lookup"><span data-stu-id="452b3-125">For more information see [Authorize the application to use the key or secret](../articles/key-vault/key-vault-get-started.md#authorize).</span></span>

### <a name="create-a-key-vault"></a><span data-ttu-id="452b3-126">建立金鑰保存庫</span><span class="sxs-lookup"><span data-stu-id="452b3-126">Create a key vault</span></span>
<span data-ttu-id="452b3-127">若要使用 Azure 金鑰保存庫來儲存您在 VM 中用於加密的金鑰，您需要金鑰保存庫的存取權。</span><span class="sxs-lookup"><span data-stu-id="452b3-127">In order to use Azure Key Vault to store the keys you will use for encryption in your VM, you need access to a key vault.</span></span> <span data-ttu-id="452b3-128">如果您尚未設定您的金鑰保存庫，請依照 [開始使用 Azure 金鑰保存庫](../articles/key-vault/key-vault-get-started.md) 主題中的步驟建立一個。</span><span class="sxs-lookup"><span data-stu-id="452b3-128">If you have not already set up your key vault, create one by following the steps in the [Getting Started with Azure Key Vault](../articles/key-vault/key-vault-get-started.md) topic.</span></span> <span data-ttu-id="452b3-129">在完成這些步驟之前，請注意有一些資訊您需要在此安裝期間收集，稍後當您在 SQL VM 上啟用 Azure 金鑰保存庫整合時需要該資訊。</span><span class="sxs-lookup"><span data-stu-id="452b3-129">Before completing these steps, note that there is some information you need to collect during this set up that is needed later when you enable Azure Key Vault Integration on your SQL VM.</span></span>

<span data-ttu-id="452b3-130">當您進行「建立」金鑰保存庫步驟時，請注意傳回的 **vaultUri** 屬性，它是金鑰保存庫 URL。</span><span class="sxs-lookup"><span data-stu-id="452b3-130">When you get to the Create a key vault step, note the returned **vaultUri** property, which is the key vault URL.</span></span> <span data-ttu-id="452b3-131">在該步驟提供的範例中 (如下所示)，金鑰保存庫名稱是 ContosoKeyVault，因此金鑰保存庫 URL 會是 https://contosokeyvault.vault.azure.net/。</span><span class="sxs-lookup"><span data-stu-id="452b3-131">In the example provided in that step, shown below, the key vault name is ContosoKeyVault, therefore the key vault URL would be https://contosokeyvault.vault.azure.net/.</span></span>

    New-AzureRmKeyVault -VaultName 'ContosoKeyVault' -ResourceGroupName 'ContosoResourceGroup' -Location 'East Asia'

<span data-ttu-id="452b3-132">金鑰保存庫 URL 稍後會指派給 PowerShell 指令碼中的 **$akvURL** 參數，以啟用 Azure 金鑰保存庫整合。</span><span class="sxs-lookup"><span data-stu-id="452b3-132">The key vault URL is assigned later to the **$akvURL** parameter in the PowerShell script to enable Azure Key Vault Integration.</span></span>

